{
  "source_url": "https://github.com/bsamiee/Parametric_Arsenal/blob/54ec3f5a7fc2c671cb7bc4601772820e625a1904/rhino/plugins/ArchBuilder/libs/metadata.py",
  "repo": "bsamiee/Parametric_Arsenal",
  "repo_stars": 0,
  "repo_description": "Rhino 8 Plugins and Scripts - A comprehensive monorepo for architectural automation, parametric design, and creative workflows",
  "license": "MIT",
  "filepath": "rhino/plugins/ArchBuilder/libs/metadata.py",
  "instruction": "Title         : metadata.py\nAuthor        : Bardia Samiee\nProject       : Parametric Forge\nLicense       : MIT\nPath          : rhino/plugins/ArchBuilder/libs/metadata.py",
  "code": "\"\"\"\nTitle         : metadata.py\nAuthor        : Bardia Samiee\nProject       : Parametric Forge\nLicense       : MIT\nPath          : rhino/plugins/ArchBuilder/libs/metadata.py\n\nDescription\n----------------------------------------------------------------------------\nMetadata utilities for storing and retrieving ArchSpec information from\nRhino geometry objects.\n\"\"\"\n\nfrom __future__ import annotations\n\nimport json\nfrom typing import Any\n\nimport Rhino.DocObjects as rd\nimport Rhino.Geometry as rg\nimport scriptcontext as sc\n\nfrom libs.specs import ArchFamily, ArchSpec\n\n\n# --- Arch Metadata Handler ------------------------------------------------\nclass ArchMetadata:\n    \"\"\"Handle metadata serialization for arch specifications.\"\"\"\n\n    KEY = \"arch_builder_spec\"\n    VERSION = \"1.0\"\n\n    # --- Plane Serialization ----------------------------------------------\n    @staticmethod\n    def _plane_to_payload(plane: rg.Plane) -> dict[str, Any]:\n        \"\"\"Serialise a Rhino plane into a JSON-friendly mapping.\"\"\"\n        return {\n            \"origin\": [plane.Origin.X, plane.Origin.Y, plane.Origin.Z],\n            \"xaxis\": [plane.XAxis.X, plane.XAxis.Y, plane.XAxis.Z],\n            \"yaxis\": [plane.YAxis.X, plane.YAxis.Y, plane.YAxis.Z],\n        }\n\n    @staticmethod\n    def _plane_from_payload(payload: dict[str, Any]) -> rg.Plane:\n        \"\"\"Rebuild a Rhino plane from a JSON payload.\"\"\"\n        origin = rg.Point3d(*payload[\"origin\"])\n        xaxis = rg.Vector3d(*payload[\"xaxis\"])\n        yaxis = rg.Vector3d(*payload[\"yaxis\"])\n        return rg.Plane(origin, xaxis, yaxis)\n\n    # --- JSON Serialization -----------------------------------------------\n    @classmethod\n    def to_json(cls, spec: ArchSpec) -> str:\n        \"\"\"Serialise an arch specification to JSON for storage.\"\"\"\n        payload = {\n            \"version\": cls.VERSION,\n            \"family\": spec.family.value,\n            \"span\": spec.span,\n            \"rise\": spec.rise,\n            \"plane\": cls._plane_to_payload(spec.plane),\n            \"metadata\": spec.metadata,\n        }\n        return json.dumps(payload)\n\n    @classmethod\n    def from_json(cls, raw: str) -> ArchSpec:\n        \"\"\"Deserialize JSON back into an arch specification.\"\"\"\n        payload = json.loads(raw)\n        if payload.get(\"version\") != cls.VERSION:\n            raise ValueError(\"Unsupported ArchBuilder metadata version.\")\n        plane = cls._plane_from_payload(payload[\"plane\"])\n        return ArchSpec(\n            family=ArchFamily.from_string(payload[\"family\"]),\n            span=payload[\"span\"],\n            rise=payload[\"rise\"],\n            plane=plane,\n            metadata=payload.get(\"metadata\", {}),\n        )\n\n    # --- Curve Metadata Operations ----------------------------------------\n    @classmethod\n    def attach_to_curve(cls, curve: rg.Curve, spec: ArchSpec) -> None:\n        \"\"\"Write specification JSON onto a curve's user dictionary.\"\"\"\n        curve.UserDictionary.Set(cls.KEY, cls.to_json(spec))\n\n    @classmethod\n    def try_get_spec(cls, curve: rg.Curve) -> ArchSpec | None:\n        \"\"\"Return the stored specification if the curve carries valid metadata.\"\"\"\n        success, raw = curve.UserDictionary.TryGetValue(cls.KEY)\n        if not success or not raw:\n            return None\n        try:\n            return cls.from_json(raw)\n        except (ValueError, KeyError, TypeError):\n            return None\n\n    # --- Document Search --------------------------------------------------\n    @classmethod\n    def find_arch_curves(cls) -> list[tuple[rd.CurveObject, ArchSpec]]:\n        \"\"\"Locate curves in the active document that contain ArchBuilder metadata.\"\"\"\n        results: list[tuple[rd.CurveObject, ArchSpec]] = []\n        for obj in sc.doc.Objects:\n            if not isinstance(obj, rd.CurveObject):\n                continue\n            geometry = obj.Geometry\n            if not isinstance(geometry, rg.Curve):\n                continue\n            spec = cls.try_get_spec(geometry)\n            if spec is not None:\n                results.append((obj, spec))\n        return results\n",
  "language": "python",
  "imports": [
    "Rhino",
    "Rhino.Geometry",
    "scriptcontext"
  ],
  "has_docstring": true
}