{
  "source_url": "https://github.com/leclusen/necs-sandbox/blob/8d8006ae3c845c9f3e38154803caac6b03d298a9/structure-batiment/structure_aligner/etl/extractor.py",
  "repo": "leclusen/necs-sandbox",
  "repo_stars": 0,
  "repo_description": null,
  "license": "unknown",
  "filepath": "structure-batiment/structure_aligner/etl/extractor.py",
  "instruction": "Extractor",
  "code": "from dataclasses import dataclass, field\nfrom pathlib import Path\nimport logging\nimport rhino3dm\n\nlogger = logging.getLogger(__name__)\n\n\n@dataclass\nclass RawVertex:\n    \"\"\"A single vertex extracted from the .3dm file.\"\"\"\n    element_name: str\n    x: float\n    y: float\n    z: float\n    vertex_index: int\n    category: str  # \"poteau\", \"poutre\", \"voile\", \"dalle\", \"appui\"\n    geometry_type: str  # \"brep\", \"line_curve\", \"polyline_curve\", \"nurbs_curve\", \"point\"\n\n\n@dataclass\nclass ExtractionResult:\n    \"\"\"All vertices extracted from a .3dm file.\"\"\"\n    vertices: list[RawVertex] = field(default_factory=list)\n    total_objects: int = 0\n    total_vertices: int = 0\n    skipped_objects: list[str] = field(default_factory=list)\n\n\ndef extract_vertices(path: Path) -> ExtractionResult:\n    \"\"\"\n    Extract all vertices from a .3dm Rhino file.\n\n    Handles 5 geometry types: Brep, LineCurve, PolylineCurve,\n    NurbsCurve, and Point.\n\n    Args:\n        path: Path to the .3dm file.\n\n    Returns:\n        ExtractionResult with all raw vertices and metadata.\n\n    Raises:\n        FileNotFoundError: If the .3dm file does not exist.\n        RuntimeError: If the .3dm file cannot be read.\n    \"\"\"\n    if not path.exists():\n        raise FileNotFoundError(f\"3DM file not found: {path}\")\n\n    model = rhino3dm.File3dm.Read(str(path))\n    if model is None:\n        raise RuntimeError(f\"Failed to read 3DM file: {path}\")\n\n    # Build layer lookup for category resolution\n    layer_by_id = {}\n    for layer in model.Layers:\n        layer_by_id[str(layer.Id)] = layer\n\n    result = ExtractionResult(total_objects=len(model.Objects))\n\n    for obj in model.Objects:\n        name = obj.Attributes.Name\n        if not name:\n            result.skipped_objects.append(f\"unnamed-object-layer-{obj.Attributes.LayerIndex}\")\n            continue\n\n        geom = obj.Geometry\n        layer = model.Layers[obj.Attributes.LayerIndex]\n        category = _resolve_category(layer, layer_by_id)\n\n        extracted = _extract_from_geometry(name, geom, category)\n        if extracted is None:\n            result.skipped_objects.append(name)\n            logger.debug(\"Skipped unsupported geometry type %s for %s\", type(geom).__name__, name)\n            continue\n\n        result.vertices.extend(extracted)\n\n    result.total_vertices = len(result.vertices)\n    return result\n\n\ndef _resolve_category(layer: rhino3dm.Layer, layer_by_id: dict) -> str:\n    \"\"\"Walk up the layer hierarchy to find the top-level category name.\"\"\"\n    current = layer\n    null_id = \"00000000-0000-0000-0000-000000000000\"\n\n    while str(current.ParentLayerId) != null_id:\n        parent_id = str(current.ParentLayerId)\n        if parent_id in layer_by_id:\n            current = layer_by_id[parent_id]\n        else:\n            break\n\n    # Map Rhino layer names to PRD element types\n    category_map = {\n        \"Poteau\": \"poteau\",\n        \"Poutre\": \"poutre\",\n        \"Voile\": \"voile\",\n        \"Dalle\": \"dalle\",\n        \"Appuis\": \"appui\",\n    }\n    return category_map.get(current.Name, \"unknown\")\n\n\ndef _extract_from_geometry(\n    name: str, geom: rhino3dm.GeometryBase, category: str\n) -> list[RawVertex] | None:\n    \"\"\"Extract vertices from a single geometry object.\"\"\"\n    vertices = []\n\n    if isinstance(geom, rhino3dm.Brep):\n        for vi in range(len(geom.Vertices)):\n            v = geom.Vertices[vi]\n            vertices.append(RawVertex(name, v.Location.X, v.Location.Y, v.Location.Z, vi, category, \"brep\"))\n\n    elif isinstance(geom, rhino3dm.LineCurve):\n        vertices.append(RawVertex(name, geom.PointAtStart.X, geom.PointAtStart.Y, geom.PointAtStart.Z, 0, category, \"line_curve\"))\n        vertices.append(RawVertex(name, geom.PointAtEnd.X, geom.PointAtEnd.Y, geom.PointAtEnd.Z, 1, category, \"line_curve\"))\n\n    elif isinstance(geom, rhino3dm.PolylineCurve):\n        for pi in range(geom.PointCount):\n            p = geom.Point(pi)\n            vertices.append(RawVertex(name, p.X, p.Y, p.Z, pi, category, \"polyline_curve\"))\n\n    elif isinstance(geom, rhino3dm.NurbsCurve):\n        for pi in range(len(geom.Points)):\n            p = geom.Points[pi]\n            vertices.append(RawVertex(name, p.X, p.Y, p.Z, pi, category, \"nurbs_curve\"))\n\n    elif isinstance(geom, rhino3dm.Point):\n        vertices.append(RawVertex(name, geom.Location.X, geom.Location.Y, geom.Location.Z, 0, category, \"point\"))\n\n    else:\n        return None\n\n    return vertices\n",
  "language": "python",
  "imports": [
    "rhino3dm"
  ],
  "has_docstring": false
}