{
  "source_url": "https://github.com/ibois-epfl/augmented-carpentry/blob/414eeb93984fad40a4e57daa60e1bb268cbd406c/py/pypi/ACPy/replayer/acim_loader.py",
  "repo": "ibois-epfl/augmented-carpentry",
  "repo_stars": 15,
  "repo_description": "Main repository hosting the main AR software developed for Augmented Carpentry rersearch at Ibois, Epfl.",
  "license": "GPL-3.0",
  "filepath": "py/pypi/ACPy/replayer/acim_loader.py",
  "instruction": "Acim loader",
  "code": "import Rhino\nimport ghpythonlib.components as ghcomp\n\nimport xml.etree.ElementTree as ET\n\nfrom .acim_data import ACIMData\n\nscale = 50\ntolerance = 0.01\n\ndef load(acim_path):\n    tree = ET.parse(acim_path)\n    root = tree.getroot()\n\n    timber = root.find(\"timber\")\n    bbox = _parse_bbox(timber.find(\"bbox\"))\n\n    cuts = {}\n    for cutNode in timber.findall(\"cut\"):\n        id, faces = _parse_cut(cutNode)\n        cuts[id] = faces\n    \n    holes = {}\n    for holeNode in timber.findall(\"hole\"):\n        id, cylinder = _parse_hole(holeNode)\n        holes[id] = cylinder\n\n    acim_data = ACIMData(bbox, cuts, holes)\n\n    return acim_data\n\n\ndef _parse_bbox(bboxNode):\n    corners = []\n    for cornerNode in bboxNode.findall(\"corner\"):\n        position = _parse_position(cornerNode.text)\n        id = int(cornerNode.attrib[\"id\"])\n\n        corners.append((id, position))\n\n    corners.sort(key=lambda x: x[0])\n    corners = list(map(lambda x: x[1], corners))\n\n    # bbox, _ = Rhino.Geometry.Mesh.CreateConvexHull3D(corners, tolerance, tolerance)\n\n    faces = []\n    faces_indices = [\n        [0, 3, 2, 1],\n        [4, 5, 6, 7],\n        [0, 1, 5, 4],\n        [3, 7, 6, 2],\n        [0, 4, 7, 3],\n        [1, 2, 6, 5]\n    ]\n    for indices in faces_indices:\n        face = ghcomp.x4PointSurface(corners[indices[0]], corners[indices[1]], corners[indices[2]], corners[indices[3]])\n        faces.append(face)\n    \n    bbox = Rhino.Geometry.Brep.MergeBreps(faces, tolerance)\n\n    return bbox\n\n\ndef _parse_cut(cutNode):\n    id = cutNode.attrib[\"id\"]\n    faces = []\n    for faceNode in cutNode.find(\"faces\").findall(\"face\"):\n        corner_id = int(faceNode.attrib[\"id\"])\n        corners = []\n        for corner in faceNode.find(\"corners\").findall(\"corner\"):\n            corners.append(_parse_position(corner.text))\n\n        boundary = Rhino.Geometry.Polyline(corners + [corners[0]])\n        face = ghcomp.FragmentPatch(boundary)\n        faces.append(face)\n\n    cutBrep = Rhino.Geometry.Brep.MergeBreps(faces, tolerance)\n\n    return (id, cutBrep)\n\n\ndef _parse_hole(holeNode):\n    id = holeNode.attrib[\"id\"]\n    radius = float(holeNode.find(\"radius\").text) * scale\n    start = _parse_position(holeNode.find(\"start\").find(\"coordinates\").text)\n    end = _parse_position(holeNode.find(\"end\").find(\"coordinates\").text)\n    \n    if start.Z > end.Z:\n        start, end = end, start\n\n    vec = end - start\n    \n    basePlane = Rhino.Geometry.Plane(start, vec)\n    circle = Rhino.Geometry.Circle(basePlane, radius)\n    cylinder = Rhino.Geometry.Cylinder(circle, vec.Length).ToBrep(True, True)\n    \n    return (id, cylinder)\n\n\ndef _parse_position(positionString):\n    x, y, z = tuple(map(float, positionString.split(\" \")))\n    x *= scale\n    y *= scale\n    z *= scale\n    return Rhino.Geometry.Point3d(x, y, z)\n    \n    \nif __name__ == \"__main__\":\n    from pprint import pprint\n    acim_data = load(\"/Users/petingo/p/augmented-carpentry/py/expirment/all_log/Z4Z2_2024-5-27-16-40-21/AC_info_model.acim\")\n    pprint(acim_data)\n\n    bbox = acim_data.bbox\n\n    all_cut_faces = []\n    for _, faces in acim_data.cuts.items():\n        all_cut_faces.append(faces)\n\n    all_holes = []\n    for _, cylinder in acim_data.holes.items():\n        all_holes.append(cylinder)",
  "language": "python",
  "imports": [
    "Rhino",
    "Rhino.Geometry",
    "ghpythonlib"
  ],
  "has_docstring": false
}