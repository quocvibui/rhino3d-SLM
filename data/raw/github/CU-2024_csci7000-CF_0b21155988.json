{
  "source_url": "https://github.com/CU-2024/csci7000-CF/blob/1b8aa19ce5fe8ea29de255d91fb037120fdf2edb/L3/L3-PythonBaseCode.py",
  "repo": "CU-2024/csci7000-CF",
  "repo_stars": 0,
  "repo_description": null,
  "license": "unknown",
  "filepath": "L3/L3-PythonBaseCode.py",
  "instruction": "This file contains parameters, helpers, and setup to \n    create a basic gcode generation algorithm from line segments.\n    \n    The main \n    \n    Inputs:\n        lines: the line segments to be...",
  "code": "\"\"\"\n    This file contains parameters, helpers, and setup to \n    create a basic gcode generation algorithm from line segments.\n    \n    The main \n    \n    Inputs:\n        lines: the line segments to be converted into gcode commands for extrusion \n        nozzle_diameter: the diameter of the 3D printer's nozzle\n        filament_diameter: the diameter of the 3d printing filament\n        layer_height: the height of each layer in the print\n        extrusion_width: the width of the extruded line from the printer\n        travel_feed_rate: the speed at which the extruder moves in X and Y\n        layer_change_feed_rate: the speed at which teh extruder moves when \n            changing layers in the Z direction\n        extrusion_feed_rate: the speed at which the extruder move when extruding\n\n    Output:\n        gcode_output: a string with gcode commands separate by new-lines\"\"\"\n\n__author__ = \"mrivera-cu\"\n\nimport rhinoscriptsyntax as rs\n\nimport math\n\n\n########## CONSTANTS BELOW ###############\n\n# GCODE COMMANDS\nCOMMAND_MOVE = \"G1\"\n\n# GCODE PARAM NAMES\nPARAM_X = \"X\"\nPARAM_Y = \"Y\"\nPARAM_Z = \"Z\"\nPARAM_E = \"E\"\nPARAM_F = \"F\"\n\n# Separates commands\nCOMMAND_DELIMITER = \"\\n\"\n\n# Precision for converting floats to strings\nE_VALUE_PRECISION = 5\nXYZ_VALUE_PRECISION = 3\n\n# Float equality precision\nFLOAT_EQUALITY_PRECISION = 5\n\n#### WARNING: DO NOT EDIT THE START GCODE! #####\nstart_gcode_lines = [\";START GCODE\",\n    \"M201 X1000 Y1000 Z200 E5000 ; sets maximum accelerations, mm/sec^2\",\n    \"M203 X200 Y200 Z12 E120 ; sets maximum feedrates, mm / sec\",\n    \"M204 S1250 T1250 ; sets acceleration (S) and retract acceleration (R), mm/sec^2\",\n    \"M205 X8.00 Y8.00 Z0.40 E4.50 ; sets the jerk limits, mm/sec\",\n    \"M205 S0 T0 ; sets the minimum extruding and travel feed rate, mm/sec\",\n    \";TYPE:Custom\",\n    \"M862.3 P \\\"MK3S\\\" ; printer model check\",\n    \"M862.1 P0.4 ; nozzle diameter check\",\n    \"M115 U3.13.3 ; tell printer latest fw version\",\n    \"G90 ; use absolute coordinates\",\n    \"M83 ; extruder relative mode\",\n    \"M104 S215 ; set extruder temp\",\n    \"M140 S60 ; set bed temp\",\n    \"M190 S60 ; wait for bed temp\",\n    \"M109 S215 ; wait for extruder temp\",\n    \"G28 W ; home all without mesh bed level\",\n    \"G80 X86.6877 Y64.7708 W85.2412 H59.1573 ; mesh bed levelling\",\n    \"G1 Z0.2 F720\",\n    \"G1 Y-3 F1000 ; go outside print area\",\n    \"G92 E0\",\n    \"G1 X60 E9 F1000 ; intro line\",\n    \"G1 X100 E12.5 F1000 ; intro line\",\n    \"G92 E0\",\n    \"M221 S95\",\n    \"; Don't change E values below. Excessive value can damage the printer.\",\n    \"M907 E538 ; set extruder motor current\",\n    \"G21 ; set units to millimeters\",\n    \"G90 ; use absolute coordinates\",\n    \"M83 ; use relative distances for extrusion\",\n    \"M900 K0.05 ; Filament gcode LA 1.5\",\n    \"M900 K30 ; Filament gcode LA 1.0\",\n    \"M107\"]\n    \n##### WARNING: DO NOT EDIT THE END GCODE! ######\nend_gcode_lines = [\"; END Gcode\", \n    \"M204 S1000\", \n    \"M107\", \n    \";TYPE:Custom\", \n    \"; Filament-specific end gcode\", \n    \"G1 Z180 F720 ; Move print head further up\", \n    \"G1 X0 Y200 F3600 ; park\", \n    \"G4 ; wait\",\n    \"M221 S100 ; reset flow\",\n    \"M900 K0 ; reset LA\",\n    \"M104 S0 ; turn off temperature\",\n    \"M140 S0 ; turn off heatbed\",\n    \"M107 ; turn off fan\",\n    \"M84 ; disable motors\",\n    \"M73 P100 R0 ; print progress done\",\n    \"M73 Q100 S0 ; print progress done\"]\n\n#########################################################################\n\n# Converts a float (f) to a string with some precision of decimal places\n# For example: \n# Input: f=0.1234, precision=3 \n# Output: \"0.123\"\ndef float_to_string(f, precision=XYZ_VALUE_PRECISION): \n    f = float(f)\n    str_format = \"{value:.\" + str(precision) +\"f}\"\n    return str_format.format(value=f)\n    \n# Helper to convert the E value to the proper precision\ndef e_value_to_string(e):\n    return float_to_string(e, E_VALUE_PRECISION)\n\n# Helper to convert the XYZ value to the proper precision\ndef xyz_value_to_string(e):\n    return float_to_string(e, XYZ_VALUE_PRECISION)\n\n#########################################################################\n\n# Helper function to compare floats in grasshopper/python due to float precision errors\ndef are_floats_equal(f1, f2, epsilon=10**(-FLOAT_EQUALITY_PRECISION)):\n    f1 *= 10**FLOAT_EQUALITY_PRECISION\n    f2 *= 10**FLOAT_EQUALITY_PRECISION\n    return math.fabs(f2 - f1) <= epsilon\n    \n# Helper function to compare if two points are equal (have the same coordinates)\n# by handling float precision comparisons\ndef is_same_pt(ptA, ptB):\n    return are_floats_equal(ptA[0], ptB[0]) and are_floats_equal(ptA[1], ptB[1]) and are_floats_equal(ptA[2], ptB[2])\n     \n     \n########################################################################\n# creates a string consisting of a G1 move command and \n# any associated parameters\ndef gcode_move(current_pos, next_pos, feed_rate=None, should_extrude=False):\n    # Start with \"G1\" as command\n    move_command_str = COMMAND_MOVE\n    \n    # Compare X positions\n    if (not are_floats_equal(current_pos[0],next_pos[0])):\n        # we have a different x position so add it as a parameter to the command\n        x_value = float_to_string(next_pos[0], precision=XYZ_VALUE_PRECISION)\n        # Add X<x_value> to move string, e.g., X100.00\n        move_command_str += \" \" + PARAM_X + x_value\n    \n    # Compare Y positions\n    if (not are_floats_equal(current_pos[1], next_pos[1])):\n        # we have a different y position so add the new position as a parameter\n        y_value = float_to_string(next_pos[1], precision=XYZ_VALUE_PRECISION)\n        # Add Y<y_value> to move string, e.g., Y100.00\n        move_command_str += \" \" + PARAM_Y + y_value\n    \n    # Compare Z position\n    if (not are_floats_equal(current_pos[2], next_pos[2])):\n        # we have a different z position so add the new position as a parameter\n        z_value = float_to_string(next_pos[2], precision=XYZ_VALUE_PRECISION)\n        # Add Z<z_value> to move string, e.g., Z100.00\n        move_command_str += \" \" + PARAM_Z + z_value\n    \n    # [TODO]: handle \"should_extrude\" == true by determining the proper amount to\n    # extrude using the capsule model, then append the E parameter and value\n    # to the move command.\n    # NOTE: YOUR FLOAT PRECISION MUST MATCH E_VALUE_PRECISION\n    \n    \n    \n    # See if we have a feedrate to use, and handle it differently than other \n    # parameters as it is an integer value\n    if (feed_rate is not None):\n        # feed rate is an int\n        feed_rate_value = round(feed_rate)\n        # Add F<feed_rate_value> to move string, e.g., F2000\n        move_command_str += \" \" + PARAM_F + str(feed_rate_value)   \n    \n    # Remove excess whitespace on ends\n    move_command_str = move_command_str.strip(\" \")\n    return move_command_str\n\n\n############################################\n############################################\n############################################\n    \n''' Here's the main method of the script that uses the helper methods above '''\n\ndef generate_gcode():\n\n    # [TODO]: Implement the algorithm to generate gcode for each layer by \n    # first to moveing to the layer height, then moving to each line segment.\n    # Once at a line segment, you should move and extrude along it, \n    # then move (travel) to the next line until there are no lines left\n    # For each of these movements, you should append the command to\n    # the list: `all_move_commands`\n    current_position = [0, 0, 0]        # start extruder at the origin\n    all_move_commands = []              # list to hold for all the move commands\n\n    for i in range(0, len(lines)):\n        # Get pts of the line segment\n        line = lines[i]\n        line_start_position = line[0]\n        line_end_position = line[1]\n        \n        # [TODO]: Handle moving to the next layer (Z Position)\n        # NOTE- ALL Z MOVEMENTS SHOULD:\n        # 1) BE INDEPENDENT MOVES(e.g., G1 Z# and not move with other positions like XYE) \n        # 2) USE THE `layer_change_feedrate`\n        # 3) BE IN INCREASING ORDER\n        \n\n        # Now if our current_position is not the start of our line segment\n        # we need to move (travel) to the line segment's starting point\n        if not is_same_pt(current_position, line_start_position):\n            # [Move to the the line_start_position\n            move_to_line_start_command = gcode_move(current_position, line_start_position, feed_rate=travel_feed_rate)\n            # A ppend command\n            all_move_commands.append(move_to_line_start_command)\n        \n        # [TODO]: Once our extruder is at the start of the line, create a \n        # command to move AND extrude along \n        # the line segment using `extrusion_feed_rate`\n        \n\n        # [TODO]: Append the move command across the line segment \n\n        \n        # [TODO]: Update the current position of our extruder to be at the end of the line\n        current_position = [0, 0, 0]\n        \n    # End of for-loop above -- now create the full set of commands\n\n\n    # [TODO]: Once you have all of the move commands stored as a list in\n    # `all_move_commands`, combine the `start_gcode`, `all_move_commands`, and `end_gcode`\n    # into one list called `gcode_lines`   \n    gcode_lines = [] \n\n    # --- DO NOT EDIT BELOW ----\n    # The takes the combined gcode_lines list and creates a string containing each line\n    # separated by a COMMAND_DELIMITER (the new-line character), and sets it \n    # to the `gcode_output`variable of this component\n    output = COMMAND_DELIMITER.join(gcode_lines)\n    \n    return output\n    \n''' RUN THE MAIN FUNCITON ABOVE - DO NOT EDIT '''\n# this sets the gcode commands to be the the `gcode_output` variable of this grasshopper component\ngcode_output = generate_gcode()",
  "language": "python",
  "imports": [
    "rhinoscriptsyntax"
  ],
  "has_docstring": true
}