{
  "source_url": "https://github.com/juanZaragozaChichell/PathOLogicalOptimist/blob/27c36daa6a324a16af147bb728919e42b925ad60/video_stuff/take_frames_rhino.py",
  "repo": "juanZaragozaChichell/PathOLogicalOptimist",
  "repo_stars": 0,
  "repo_description": null,
  "license": "unknown",
  "filepath": "video_stuff/take_frames_rhino.py",
  "instruction": "Take frames rhino",
  "code": "# -*- coding: utf-8 -*-\nimport rhinoscriptsyntax as rs\nimport scriptcontext as sc\nimport Rhino\nimport os\nimport re\n\ndef get_material_index_by_name(material_name):\n    \"\"\"\n    Search classic document materials (sc.doc.Materials) by name (case-insensitive).\n    Returns index or -1 if not found.\n    \"\"\"\n    if not material_name:\n        return -1\n\n    target = material_name.strip().lower()\n    mats = sc.doc.Materials\n    count = mats.Count\n    for i in range(count):\n        mat = mats[i]\n        if mat is None:\n            continue\n        name = (mat.Name or \"\").strip().lower()\n        if name == target:\n            return i\n    return -1\n\n\ndef get_render_material_by_name(material_name):\n    \"\"\"\n    Search Render Materials (Panels: Materials) by name (case-insensitive).\n    Returns the RenderMaterial object or None.\n    \"\"\"\n    if not material_name:\n        return None\n\n    target = material_name.strip().lower()\n    rms = sc.doc.RenderMaterials\n    count = rms.Count\n    for i in range(count):\n        rm = rms[i]\n        if rm is None:\n            continue\n        name = (rm.Name or \"\").strip().lower()\n        if name == target:\n            return rm\n    return None\n\n\ndef move_objects_to_layer(objs, layer_name):\n    \"\"\"\n    Ensure layer exists and move objects there.\n    \"\"\"\n    if not rs.IsLayer(layer_name):\n        rs.AddLayer(layer_name)\n    for obj_id in objs:\n        try:\n            rs.ObjectLayer(obj_id, layer_name)\n        except:\n            print(\"  [WARN] Could not move object {} to layer '{}'\".format(obj_id, layer_name))\n\n\ndef assign_material_to_objects(objs, material_name):\n    \"\"\"\n    Try, in order:\n      1) Classic material by name (sc.doc.Materials + rs.ObjectMaterialIndex)\n      2) Render material by name (sc.doc.RenderMaterials, assign via RhinoCommon)\n      3) Fallback: move objects to a layer with that name\n    \"\"\"\n    # 1) Classic material table\n    mat_index = get_material_index_by_name(material_name)\n    if mat_index >= 0:\n        print(\"  [INFO] Using classic material '{}' (index {})\".format(material_name, mat_index))\n        for obj_id in objs:\n            try:\n                rs.ObjectMaterialIndex(obj_id, mat_index)\n                rs.ObjectMaterialSource(obj_id, 1)  # 0 = layer, 1 = object\n            except:\n                print(\"  [WARN] Could not assign classic material to object: {}\".format(obj_id))\n        return\n\n    # 2) Render material table (Panels: Materials)\n    rm = get_render_material_by_name(material_name)\n    if rm is not None:\n        print(\"  [INFO] Using render material '{}'\".format(material_name))\n        for obj_id in objs:\n            rh_obj = sc.doc.Objects.Find(obj_id)\n            if not rh_obj:\n                continue\n            attr = rh_obj.Attributes\n            attr.RenderMaterial = rm\n            attr.MaterialSource = Rhino.DocObjects.ObjectMaterialSource.MaterialFromObject\n            sc.doc.Objects.ModifyAttributes(rh_obj, attr, True)\n        sc.doc.Views.Redraw()\n        return\n\n    # 3) Fallback to layer\n    print(\"  [INFO] Material '{}' not found; using layer fallback\".format(material_name))\n    move_objects_to_layer(objs, material_name)\n\n\ndef import_stl_with_material(frame_dir, filename, material_name):\n    \"\"\"\n    Import STL from frame_dir/filename and assign material_name via assign_material_to_objects.\n    Returns list of imported object ids.\n    \"\"\"\n    path = os.path.join(frame_dir, filename)\n\n    if not os.path.exists(path):\n        print(\"  [WARN] File not found: {}\".format(path))\n        return []\n\n    before = set(rs.AllObjects() or [])\n\n    cmd = '_-Import \"{}\" _Enter'.format(path)\n    rs.Command(cmd, False)\n\n    after = set(rs.AllObjects() or [])\n    new_objs = list(after - before)\n\n    if not new_objs:\n        print(\"  [WARN] No new objects detected for: {}\".format(filename))\n        return []\n\n    assign_material_to_objects(new_objs, material_name)\n    return new_objs\n\n\ndef main():\n    base_dir = \"./heatmaps\"\n    frames_dir = \"./frames\"\n    pattern = re.compile(r\"heatmap_iter_(\\d+)\\.ply$\", re.IGNORECASE)\n    if \"Perspective\" in rs.ViewNames():\n        rs.CurrentView(\"Perspective\")\n\n    try:\n        if not os.path.isdir(frames_dir):\n            os.makedirs(frames_dir)\n    except OSError as exc:\n        print(\"  [ERROR] Could not create frames directory {}: {}\".format(frames_dir, exc))\n        return\n\n    try:\n        heatmap_files = [\n            f for f in os.listdir(base_dir)\n            if pattern.match(f)\n        ]\n    except OSError as exc:\n        print(\"  [ERROR] Could not read directory {}: {}\".format(base_dir, exc))\n        return\n\n    def sort_key(fname):\n        m = pattern.match(fname)\n        return int(m.group(1)) if m else fname\n\n    for filename in sorted(heatmap_files, key=sort_key):\n        name_no_ext = os.path.splitext(filename)[0]\n        ply_path = os.path.join(base_dir, filename)\n        match = pattern.match(filename)\n        idx = int(match.group(1)) if match else name_no_ext\n\n        print(\"\\n=== Processing {} ===\".format(ply_path))\n\n        before = set(rs.AllObjects() or [])\n        cmd = '_-Import \"{}\" _Enter'.format(ply_path)\n        rs.Command(cmd, False)\n        after = set(rs.AllObjects() or [])\n        imported_this_frame = list(after - before)\n        if not imported_this_frame:\n            print(\"  [WARN] No new objects detected for: {}\".format(ply_path))\n            continue\n\n        # Deselect everything so capture shows the real shading\n        rs.UnselectAllObjects()\n\n        png_path = os.path.join(frames_dir, \"frame_{}.png\".format(idx))\n        print(\"  Capturing view to: {}\".format(png_path))\n\n        cmd_cap = '_-ViewCaptureToFile \"{}\" _Enter'.format(png_path)\n        rs.Command(cmd_cap, True)\n\n        if imported_this_frame:\n            existing_to_delete = [oid for oid in imported_this_frame if rs.IsObject(oid)]\n            if existing_to_delete:\n                rs.DeleteObjects(existing_to_delete)\n\n    print(\"\\nAll frames processed.\")\n\n\nif __name__ == \"__main__\":\n    main()\n",
  "language": "python",
  "imports": [
    "Rhino",
    "RhinoCommon",
    "rhinoscriptsyntax",
    "scriptcontext"
  ],
  "has_docstring": false
}