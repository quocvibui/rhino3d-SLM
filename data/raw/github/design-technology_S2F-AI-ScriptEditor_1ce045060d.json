{
  "source_url": "https://github.com/design-technology/S2F-AI-ScriptEditor/blob/b8b186096f89bf831661ef8308693b98d2bb5b39/6-Running_in_Rhino_Parameters/app.py",
  "repo": "design-technology/S2F-AI-ScriptEditor",
  "repo_stars": 5,
  "repo_description": null,
  "license": "unknown",
  "filepath": "6-Running_in_Rhino_Parameters/app.py",
  "instruction": null,
  "code": "import os, sys, threading, tempfile\nimport os.path as op\n\n# -------------------------------------------\n# make sure to change the cache path\n# -------------------------------------------\ncache_path = \"Z:\\\\Development Projects\\\\huggingface\"\nos.environ[\"TRANSFORMERS_CACHE\"] = cache_path\nos.environ[\"HF_HUB_CACHE\"] = cache_path\nos.environ[\"HUGGINGFACE_HUB_CACHE\"] = cache_path \nos.environ[\"HF_HOME\"] = cache_path\n\nimport rhinoscriptsyntax as rs\nimport Rhino\nimport scriptcontext as sc\nimport Eto.Forms as forms\nimport Eto.Drawing as drawing\nfrom System.Drawing import Bitmap, Imaging\nfrom PIL import Image, ImageOps\nimport shutil  # For file copying\n\n# -------------------------------------------\n# make sure to change the env environment path\n# -------------------------------------------\n\n# Configure environment\nCONDA_ENV = r'C:\\Users\\Hesham.Shawqy\\anaconda3\\envs\\generative_ai'\nsys.path.append(op.join(CONDA_ENV, r\"Lib\\site-packages\"))\nos.add_dll_directory(op.join(CONDA_ENV, r'Library\\bin'))\n\nfrom image_generation.image_generation import generate_from_rhino_view, initialize_models, is_loading_complete\n\n# Track temporary files\ntemp_files = []\n\n# viewport to bitmap to pil image\ndef capture_viewport():\n    view = sc.doc.Views.ActiveView\n    bitmap = view.CaptureToBitmap()\n    \n    with tempfile.NamedTemporaryFile(suffix='.png', delete=False) as temp_file:\n        temp_path = temp_file.name\n        temp_files.append(temp_path)\n    \n    bitmap.Save(temp_path, Imaging.ImageFormat.Png)\n    pil_image = Image.open(temp_path)\n    \n    return pil_image\n\n# pil to bitmap to eto\ndef pil_to_eto_image(pil_image):\n    with tempfile.NamedTemporaryFile(suffix='.png', delete=False) as temp_file:\n        temp_path = temp_file.name\n        temp_files.append(temp_path)\n    \n    pil_image.save(temp_path, format='PNG')\n    bitmap = Bitmap(temp_path)\n    \n    with tempfile.NamedTemporaryFile(suffix='.png', delete=False) as eto_temp_file:\n        eto_temp_path = eto_temp_file.name\n        temp_files.append(eto_temp_path)\n    \n    bitmap.Save(eto_temp_path, Imaging.ImageFormat.Png)\n    eto_bitmap = drawing.Bitmap(eto_temp_path)\n\n    return eto_bitmap\n\n# Clean up temporary files\ndef cleanup_temp_files():\n    global temp_files\n    for file_path in temp_files:\n        try:\n            if os.path.exists(file_path):\n                os.unlink(file_path)\n        except Exception as e:\n            print(f\"Error cleaning up temporary file {file_path}: {str(e)}\")\n    temp_files = []\n\n# creating the UI components\ndef create_ui_controls():\n    # Create image view\n    image_view = forms.ImageView()\n    image_view.BackgroundColor = drawing.Color.FromArgb(255, 255, 255)\n    \n    # Create buttons\n    ai_button = forms.Button()\n    ai_button.Text = \"Generate AI Image\"\n    ai_button.Enabled = is_loading_complete()\n    \n    save_button = forms.Button()\n    save_button.Text = \"Save Image\"\n    save_button.Enabled = False\n    \n    # Create status label\n    status_label = forms.Label()\n    if not is_loading_complete():\n        status_label.Text = \"Loading AI models...this might take a few minutes\"\n        status_label.TextColor = drawing.Color.FromArgb(200, 0, 0)\n    else:\n        status_label.Text = \"AI models loaded and ready\"\n        status_label.TextColor = drawing.Color.FromArgb(0, 128, 0)\n    \n    # Create prompt controls\n    prompt_text = forms.TextArea()\n    prompt_text.Text = \"a stunning architectural visualization of the design, photorealistic render, 4k, high resolution\"\n    prompt_text.Height = 60\n    \n    # Create negative prompt controls\n    negative_prompt_text = forms.TextArea()\n    negative_prompt_text.Text = \"ugly, low quality\"\n    negative_prompt_text.Height = 40\n    \n    # Create text inputs for parameters\n    steps_input = forms.TextBox()\n    steps_input.Text = \"8\"\n    \n    guidance_input = forms.TextBox()\n    guidance_input.Text = \"5.0\"\n    \n    control_strength_input = forms.TextBox()\n    control_strength_input.Text = \"0.5\"\n    \n    # Create seed control\n    seed_numeric = forms.NumericUpDown()\n    seed_numeric.MinValue = 0\n    seed_numeric.MaxValue = 2147483647\n    seed_numeric.Value = 0\n    seed_numeric.DecimalPlaces = 0\n    \n    return (image_view, ai_button, save_button, status_label, prompt_text, \n            negative_prompt_text, steps_input, guidance_input, \n            control_strength_input, seed_numeric)\n\n\ndef show_image_dialog():\n    initialize_models()\n    \n    # Create form\n    form = forms.Form()\n    form.Title = \"Rhino AI Image Generator\"\n    form.ClientSize = drawing.Size(600, 700)\n    form.Padding = drawing.Padding(10)\n    form.Topmost = True\n    \n    # Get UI controls\n    (image_view, ai_button, save_button, status_label, prompt_text,\n     negative_prompt_text, steps_input, guidance_input,\n     control_strength_input, seed_numeric) = create_ui_controls()\n    \n    # Create the main layout\n    layout = forms.DynamicLayout()\n    layout.Padding = drawing.Padding(10)\n    layout.Spacing = drawing.Size(5, 5)\n    \n    layout.Add(image_view, yscale=True)\n    \n    # Prompt section\n    prompt_label = forms.Label()\n    prompt_label.Text = \"Text Prompt\"\n    layout.Add(prompt_label)\n    layout.Add(prompt_text)\n    \n    # Negative prompt section\n    negative_prompt_label = forms.Label()\n    negative_prompt_label.Text = \"Negative Prompt\"\n    layout.Add(negative_prompt_label)\n    layout.Add(negative_prompt_text)\n    \n    # Parameter inputs section\n    params_layout = forms.TableLayout()\n    params_layout.Spacing = drawing.Size(5, 5)\n    \n    # Inference steps row\n    steps_label = forms.Label()\n    steps_label.Text = \"Inference Steps (4-12)\"\n    steps_cell = forms.TableCell()\n    steps_cell.Control = steps_label\n    steps_cell.ScaleWidth = True\n    \n    steps_input_cell = forms.TableCell()\n    steps_input_cell.Control = steps_input\n    steps_input_cell.ScaleWidth = False\n    \n    steps_row = forms.TableRow()\n    steps_row.Cells.Add(steps_cell)\n    steps_row.Cells.Add(steps_input_cell)\n    params_layout.Rows.Add(steps_row)\n    \n    # Guidance scale row\n    guidance_label = forms.Label()\n    guidance_label.Text = \"Guidance Scale (0.0-10.0)\"\n    guidance_cell = forms.TableCell()\n    guidance_cell.Control = guidance_label\n    guidance_cell.ScaleWidth = True\n    \n    guidance_input_cell = forms.TableCell()\n    guidance_input_cell.Control = guidance_input\n    guidance_input_cell.ScaleWidth = False\n    \n    guidance_row = forms.TableRow()\n    guidance_row.Cells.Add(guidance_cell)\n    guidance_row.Cells.Add(guidance_input_cell)\n    params_layout.Rows.Add(guidance_row)\n    \n    # Control strength row\n    control_label = forms.Label()\n    control_label.Text = \"Control Strength (0.0-1.0)\"\n    control_cell = forms.TableCell()\n    control_cell.Control = control_label\n    control_cell.ScaleWidth = True\n    \n    control_input_cell = forms.TableCell()\n    control_input_cell.Control = control_strength_input\n    control_input_cell.ScaleWidth = False\n    \n    control_row = forms.TableRow()\n    control_row.Cells.Add(control_cell)\n    control_row.Cells.Add(control_input_cell)\n    params_layout.Rows.Add(control_row)\n    \n    # Seed row\n    seed_label = forms.Label()\n    seed_label.Text = \"Seed (0 = random)\"\n    seed_cell = forms.TableCell()\n    seed_cell.Control = seed_label\n    seed_cell.ScaleWidth = True\n    \n    seed_input_cell = forms.TableCell()\n    seed_input_cell.Control = seed_numeric\n    seed_input_cell.ScaleWidth = False\n    \n    seed_row = forms.TableRow()\n    seed_row.Cells.Add(seed_cell)\n    seed_row.Cells.Add(seed_input_cell)\n    params_layout.Rows.Add(seed_row)\n    \n    layout.Add(params_layout)\n    layout.Add(status_label)\n    \n    # Create button layout\n    button_layout = forms.TableLayout()\n    button_layout.Spacing = drawing.Size(5, 0)\n    \n    empty_cell = forms.TableCell()\n    empty_cell.ScaleWidth = True\n    \n    ai_button_cell = forms.TableCell()\n    ai_button_cell.Control = ai_button\n    ai_button_cell.ScaleWidth = False\n    \n    save_button_cell = forms.TableCell()\n    save_button_cell.Control = save_button\n    save_button_cell.ScaleWidth = False\n    \n    button_row = forms.TableRow()\n    button_row.Cells.Add(empty_cell)\n    button_row.Cells.Add(ai_button_cell)\n    button_row.Cells.Add(save_button_cell)\n    \n    button_layout.Rows.Add(button_row)\n    layout.Add(button_layout)\n    \n    form.Content = layout\n    \n    # Store generated image and temp file path\n    generated_image = None\n    temp_image_path = None\n    \n    # Setup loading timer\n    check_loading_timer = forms.UITimer()\n    check_loading_timer.Interval = 1.0\n    \n    # Timer event handler\n    def update_loading_status(sender, e):\n        if is_loading_complete():\n            status_label.Text = \"AI models loaded and ready\"\n            status_label.TextColor = drawing.Color.FromArgb(0, 128, 0)\n            ai_button.Enabled = True\n            check_loading_timer.Stop()\n    \n    check_loading_timer.Elapsed += update_loading_status\n    check_loading_timer.Start()\n    \n    def on_ai_button_click(sender, e):\n        try:\n            if not is_loading_complete():\n                print(\"AI models are still loading. Please wait...\")\n                return\n            \n            # Validate inputs\n            try:\n                steps = int(steps_input.Text)\n                if not (4 <= steps <= 12):\n                    raise ValueError(\"Inference steps must be between 4 and 12\")\n                \n                guidance = float(guidance_input.Text)\n                if not (0.0 <= guidance <= 10.0):\n                    raise ValueError(\"Guidance scale must be between 0.0 and 10.0\")\n                \n                control = float(control_strength_input.Text)\n                if not (0.0 <= control <= 1.0):\n                    raise ValueError(\"Control strength must be between 0.0 and 1.0\")\n                \n                seed = int(seed_numeric.Value) if seed_numeric.Value > 0 else None\n            except ValueError as ve:\n                status_label.Text = f\"Error: {str(ve)}\"\n                return\n            \n            captured_image = capture_viewport()\n            prompt = prompt_text.Text\n            negative_prompt = negative_prompt_text.Text\n            \n            status_label.Text = \"Generating AI image...\"\n            ai_button.Enabled = False\n            save_button.Enabled = False\n            \n            def generate_in_background():\n                nonlocal generated_image, temp_image_path\n                try:\n                    ai_image = generate_from_rhino_view(\n                        captured_image, \n                        prompt=prompt,\n                        negative_prompt=negative_prompt,\n                        num_inference_steps=steps,\n                        guidance_scale=guidance,\n                        control_strength=control,\n                        seed=seed\n                    )\n                    \n                    generated_image = ai_image\n                    \n                    # Save to temporary file right away\n                    with tempfile.NamedTemporaryFile(suffix='.png', delete=False) as temp_file:\n                        temp_image_path = temp_file.name\n                        temp_files.append(temp_image_path)\n                    \n                    ai_image.save(temp_image_path, format='PNG')\n                    \n                    def update_ui():\n                        if image_view.Image is not None:\n                            image_view.Image = None\n                        \n                        image_view.Image = pil_to_eto_image(ai_image)\n                        \n                        ai_button.Enabled = True\n                        save_button.Enabled = True\n                        status_label.Text = \"AI models loaded and ready\"\n                        \n                        print(\"AI image generated and displayed\")\n                    \n                    forms.Application.Instance.Invoke(update_ui)\n                    \n                except Exception as ex:\n                    def show_error():\n                        print(f\"Error generating AI image: {str(ex)}\")\n                        status_label.Text = f\"Error: {str(ex)}\"\n                        ai_button.Enabled = True\n                    \n                    forms.Application.Instance.Invoke(show_error)\n            \n            threading.Thread(target=generate_in_background).start()\n            \n        except Exception as e:\n            print(f\"Error generating AI image: {str(e)}\")\n            status_label.Text = f\"Error: {str(e)}\"\n            ai_button.Enabled = True\n    \n    def on_save_button_click(sender, e):\n        nonlocal temp_image_path\n        if temp_image_path is None or not os.path.exists(temp_image_path):\n            status_label.Text = \"No image to save\"\n            return\n        \n        # Disable the save button during the operation\n        save_button.Enabled = False\n        status_label.Text = \"Preparing to save...\"\n        \n        # Use a fixed path in the user's documents folder instead of a dialog\n        try:\n            # Get user documents folder\n            documents_folder = os.path.expanduser(\"~/Documents\")\n            rhino_ai_folder = os.path.join(documents_folder, \"RhinoAI\")\n            \n            # Create the folder if it doesn't exist\n            if not os.path.exists(rhino_ai_folder):\n                os.makedirs(rhino_ai_folder)\n            \n            # Create a filename with timestamp\n            import datetime\n            timestamp = datetime.datetime.now().strftime(\"%Y%m%d_%H%M%S\")\n            file_name = f\"rhino_ai_{timestamp}.png\"\n            file_path = os.path.join(rhino_ai_folder, file_name)\n            \n            # Copy the file\n            shutil.copy2(temp_image_path, file_path)\n            \n            status_label.Text = f\"Image saved to {file_path}\"\n            print(f\"Image saved to {file_path}\")\n        except Exception as ex:\n            status_label.Text = f\"Error saving image: {str(ex)}\"\n            print(f\"Error saving image: {str(ex)}\")\n        finally:\n            save_button.Enabled = True\n    \n    def on_form_closing(sender, e):\n        if image_view.Image is not None:\n            image_view.Image = None\n        check_loading_timer.Stop()\n        cleanup_temp_files()\n    \n    # Connect events\n    ai_button.Click += on_ai_button_click\n    save_button.Click += on_save_button_click\n    form.Closing += on_form_closing\n    \n    form.Show()\n    \n    return form\n\nif __name__ == \"__main__\":\n    show_image_dialog()",
  "language": "python",
  "imports": [
    "Rhino",
    "rhinoscriptsyntax",
    "scriptcontext"
  ],
  "has_docstring": false
}