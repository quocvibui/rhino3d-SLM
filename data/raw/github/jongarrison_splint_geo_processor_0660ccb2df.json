{
  "source_url": "https://github.com/jongarrison/splint_geo_processor/blob/b4a410b94aa8ddd9dad7ee8d35d452964254ef41/generators/src/splintmeshes.py",
  "repo": "jongarrison/splint_geo_processor",
  "repo_stars": 0,
  "repo_description": null,
  "license": "unknown",
  "filepath": "generators/src/splintmeshes.py",
  "instruction": "Shared mesh export functionality for Rhino/Grasshopper\nThis module provides functions to export meshes to various formats (STL, OBJ, 3MF)",
  "code": "\"\"\"\nShared mesh export functionality for Rhino/Grasshopper\nThis module provides functions to export meshes to various formats (STL, OBJ, 3MF)\n\"\"\"\n\nimport scriptcontext as sc\nimport System\nimport Rhino\nimport random\nimport string\nimport os\nimport time\nfrom pathlib import Path\n\n\ndef add_layer(layer_name=None, layer_color=None):\n    \"\"\"Adds a new layer to the active Rhino document.\n    \n    Args:\n      layer_name (str): An optional layer name.\n      layer_color (System.Drawing.Color): An optional layer color.\n    Returns:\n      The index of the new layer.\n    \"\"\"\n    sc.doc = Rhino.RhinoDoc.ActiveDoc\n    if layer_name != None:\n        # Check whether the layer name is valid\n        if not Rhino.DocObjects.Layer.IsValidName(layer_name):\n            raise ValueError(\"{} is not a valid layer name.\".format(layer_name))\n        # Check whether a layer with the same name already exists\n        layer_index = sc.doc.Layers.Find(layer_name, True)\n        if layer_index >= 0:\n            raise ValueError(\"A layer with the name {} already exists.\".format(layer_name))\n    else:\n        layer_name = sc.doc.Layers.GetUnusedLayerName(False)\n    \n    # Check whether the layer color is valid\n    if layer_color != None:\n        if not isinstance(layer_color, System.Drawing.Color):\n            raise ValueError(\"{} is not a valid layer color.\".format(layer_color))\n    else:\n        layer_color = System.Drawing.Color.Black # default layer color\n    \n    # Add a new layer to the active document\n    layer_index = sc.doc.Layers.Add(layer_name, layer_color)\n    if layer_index < 0:\n        raise ValueError(\"Unable to add layer {} to document.\".format(layer_name))\n    return layer_index\n\n\ndef delete_layer(layer):\n    \"\"\"Deletes an existing layer from the active Rhino document. \n    The layer to be removed cannot be the current layer and \n    it will be deleted even if it contains objects.\n    \n    Args:\n      layer (str\\id): A name or id of an existing layer.\n    Returns:\n      True or False, indicating success or failure.\n    \"\"\"\n    sc.doc = Rhino.RhinoDoc.ActiveDoc\n    layer_index = sc.doc.Layers.Find(layer, True)\n    if layer_index < 0:\n        raise ValueError(\"The layer {} does not exist.\".format(layer))\n    rc = sc.doc.Layers.Purge(layer_index, True)\n    sc.doc.Views.Redraw()\n    return rc\n\n\ndef bake_mesh(layer, mesh, mesh_name=None):\n    \"\"\"Bakes a mesh object to the active Rhino document.\n    \n    Args:\n      layer (str\\id): The name or id of an existing layer.\n      mesh (Rhino.Geometry.Mesh): A mesh object to bake.\n      mesh_name (str): An optional mesh object name.\n    Returns:\n      The GUID of the baked mesh.\n    \"\"\"\n    sc.doc = Rhino.RhinoDoc.ActiveDoc\n    # Check whether the mesh is a mesh object\n    if mesh.ObjectType != Rhino.DocObjects.ObjectType.Mesh:\n        raise ValueError(\"{} is not a mesh.\".format(mesh))\n    # Create the mesh object attributes\n    attr = Rhino.DocObjects.ObjectAttributes()\n    # Set the mesh object layer index attribute\n    layer_index = sc.doc.Layers.Find(layer, True)\n    if layer_index < 0:\n        if layer == \"Default\":\n            raise ValueError(\"The layer {} can't be baked to.\".format(layer))\n        else:\n            raise ValueError(\"The layer {} does not exist.\".format(layer))    \n    else:\n        attr.LayerIndex = layer_index\n    # Set the mesh object name attribute\n    if mesh_name != None:\n        attr.Name = mesh_name\n    # Bake the mesh to the active Rhino documemnt\n    mesh_id = sc.doc.Objects.AddMesh(mesh, attr)\n    return mesh_id\n\n\ndef get_obj_settings():\n    \"\"\"Returns the settings for the OBJ export command as a string.\"\"\"\n    # Formatting options\n    cfg = \"_Geometry=_Mesh \"\n    cfg += \"_EndOfLine=CRLF \"\n    cfg += \"_ExportRhinoObjectNames=_ExportObjectsAsOBJGroups \"\n    cfg += \"_ExportMeshTextureCoordinates=_Yes \"\n    cfg += \"_ExportMeshVertexNormals=_Yes \"\n    cfg += \"_ExportMeshVertexColors=_Yes \"\n    cfg += \"_CreateNGons=_No \"\n    cfg += \"_ExportMaterialDefinitions=_No \"\n    cfg += \"_YUp=_Yes \"\n    cfg += \"_WrapLongLines=_No \"\n    cfg += \"_VertexWelding=_Unmodified \"\n    cfg += \"_WritePrecision=4 \"\n    cfg += \"_Enter \"\n    # Detailed options\n    cfg += \"_DetailedOptions \"\n    cfg += \"_JaggedSeams=_No \"\n    cfg += \"_PackTextures=_No \"\n    cfg += \"_Refine=_No \"\n    cfg += \"_SimplePlane=_No \"\n    # Advanced options\n    cfg += \"_AdvancedOptions \"\n    cfg += \"_Angle=0 \"\n    cfg += \"_AspectRatio=0 \"\n    cfg += \"_Distance=0.0 \"\n    cfg += \"_Density=0.5 \"\n    cfg += \"_Grid=0 \"\n    cfg += \"_MaxEdgeLength=0 \"\n    cfg += \"_MinEdgeLength=0.0001 \"\n    cfg += \"_Enter _Enter\"\n    return cfg, \"obj\"\n\n\ndef get_stl_settings_default():\n    \"\"\"Returns default STL export settings.\"\"\"\n    #[ANGLE,ASPECT RATIO,MAX DIST TO SRF,GRID,DENSITY,MAX EDGE LEN,MIN EDGE LEN]\n    setting_list=[15,0,0.01,16,0,0,0.001]   \n    return get_stl_settings(*setting_list)\n\n\ndef get_stl_settings(ang,ar,dist,grid,den,maxL=0,minL=.0001):\n    \"\"\"Returns the settings for binary STL export command as a string.\"\"\"\n    e_str = \"_ExportFileAs=_Binary \"\n    e_str+= \"_ExportUnfinishedObjects=_Yes \"\n    e_str+= \"_UseSimpleDialog=_No \"\n    e_str+= \"_Enter _DetailedOptions \"\n    e_str+= \"_JaggedSeams=_No \"\n    e_str+= \"_PackTextures=_No \"\n    e_str+= \"_Refine=_Yes \"\n    e_str+= \"_SimplePlane=_Yes \"\n    e_str+= \"_Enter _Enter\"\n    return e_str, \"stl\"\n\n\ndef get_3mf_settings():\n    \"\"\"Returns the settings for 3MF export command as a string.\"\"\"\n    e_str = \"_ExportUnfinishedObjects=_Yes \"\n    e_str+= \"_UseSimpleDialog=_No \"\n    e_str+= \"_Enter\"\n    return e_str, \"3mf\"\n\n\ndef export_mesh_files(meshes, path, filename, logger=None, debug=False, format_type=\"stl\"):\n    \"\"\"Exports a collection of meshes to a file.\n    \n    Args:\n      meshes (list): A list of Rhino.Geometry.Mesh objects.\n      path (str): An absolute path pointing to a directory.\n      filename (str): A filename (without extension).\n      logger (callable): Optional logging function that takes a string message.\n      debug (bool): Optional True to print debug information.\n      format_type (str): Export format - \"stl\", \"obj\", or \"3mf\". Default is \"stl\".\n    Returns:\n      True or False, indicating success or failure.\n    \"\"\"\n    \n    def log(msg):\n        if logger:\n            logger(msg)\n        else:\n            print(msg)\n    \n    sc.doc = Rhino.RhinoDoc.ActiveDoc\n    sc.doc.Views.RedrawEnabled = True\n    if debug: \n        now = time.process_time()\n        elapsed = 0.0\n        \n    # Create a temporary layer\n    log(f\"export_mesh_files: Creating temp layer\")\n    layer = \"\".join(random.choice(string.ascii_uppercase) for _ in range(9))\n    layer_index = add_layer(layer)\n    if debug: \n        then, now = now, time.process_time()\n        elapsed += now - then\n        log(\"Creating temporary layer: {0:.4f} seconds\".format(now-then))\n        \n    # Bake the temporary mesh(es)\n    log(f\"export_mesh_files: Baking temp mesh(es)\")\n    mesh_ids = [bake_mesh(layer, mesh) for mesh in meshes]\n    if debug: \n        then, now = now, time.process_time()\n        elapsed += now - then\n        log(\"Creating temporary mesh(es): {0:.4f} seconds\".format(now-then))\n    \n    # Unselect all objects in the scene\n    sc.doc.Objects.UnselectAll()\n    # Select the baked mesh object(s)\n    for mid in mesh_ids:\n        sc.doc.Objects.Select(mid)\n    if debug: \n        then, now = now, time.process_time()\n        elapsed += now - then\n        log(\"Unselecting and selecting: {0:.4f} seconds\".format(now-then))\n    \n    # Export the selected mesh object(s) to mesh file\n    log(f\"export_mesh_files: Exporting to {format_type.upper()} format\")\n    \n    # Get export settings based on format\n    if format_type.lower() == \"obj\":\n        export_config, export_extension = get_obj_settings()\n        log(\"Using OBJ mesh settings\")\n    elif format_type.lower() == \"3mf\":\n        export_config, export_extension = get_3mf_settings()\n        log(\"Using 3MF mesh settings\")\n    else:  # Default to STL\n        export_config, export_extension = get_stl_settings_default()\n        log(\"Using STL mesh settings\")\n    \n    export_fname = \"{}.{}\".format(filename, export_extension)\n    export_fpath = Path(os.path.join(path, export_fname))\n    log(f\"export_mesh_files: Export Values: {export_fname=} {export_fpath=}\")\n    \n    if export_fpath.exists():\n        log(f\"export_mesh_files: REMOVING EXISTING MESH FILE: {export_fpath}\")\n        export_fpath.unlink()\n        time.sleep(1.0)\n        log(f\"export_mesh_files: testing... MeshStillExists:{export_fpath.exists()}\")\n\n    log(f\"export_mesh_files: Exporting to file\")\n\n    cmd = '_-Export _Pause \"{}\" {} _Enter'.format(export_fpath, export_config)\n    log(f\"export_mesh_files: RUNNING cmd: '{cmd}'\")\n    \n    rc = Rhino.RhinoApp.RunScript(cmd, True)\n\n    log(f\"export_mesh_files: Completion {rc=}\")\n    \n    if debug: \n        then, now = now, time.process_time()\n        elapsed += now - then\n        log(\"Exporting Mesh Result: {0:.4f} seconds result={1}\".format(now-then, rc))\n    \n    # Delete the temporary layer and meshes\n    log(f\"export_mesh_files: Cleaning up temp layer\")\n    delete_layer(layer)\n    \n    if debug: \n        then, now = now, time.process_time()\n        elapsed += now - then\n        log(\"Cleaning up: {0:.4f} seconds\\n\".format(now-then))\n        log(\"Total elapsed: {0:.4f} seconds\".format(elapsed))\n\n    sc.doc.Views.RedrawEnabled = True\n\n    log(f\"export_mesh_files: Returning result: {rc=}\")\n\n    return rc\n\n\ndef save_mesh(input_mesh, directory, root_filename, logger=None, format_type=\"stl\"):\n    \"\"\"High-level function to save a mesh to a file.\n    \n    Args:\n      input_mesh (Rhino.Geometry.Mesh): The mesh to export.\n      directory (str): Directory path where file will be saved.\n      root_filename (str): Base filename (without extension).\n      logger (callable): Optional logging function.\n      format_type (str): Export format - \"stl\", \"obj\", or \"3mf\". Default is \"stl\".\n    \n    Returns:\n      bool: True if successful, False otherwise.\n    \n    Raises:\n      ValueError: If inputs are invalid or export fails.\n    \"\"\"\n    \n    def log(msg):\n        if logger:\n            logger(msg)\n        else:\n            print(msg)\n    \n    log(f\"save_mesh: inputMesh type: {type(input_mesh)}\")\n    log(f\"save_mesh: {directory=}\")\n    log(f\"save_mesh: {root_filename=}\")\n    log(f\"save_mesh: {format_type=}\")\n    \n    if input_mesh is None or directory is None or root_filename is None:        \n        raise ValueError(\"Missing required inputs for saving file\")\n\n    # Validate the path (no dots in directory or filename for safety)\n    if \".\" in directory or \".\" in root_filename:\n        raise ValueError(f\"Path must not contain dot character: {directory}\")\n\n    result = export_mesh_files([input_mesh], directory, root_filename, logger=logger, debug=True, format_type=format_type)\n\n    if not result:\n        raise ValueError(f\"FAIL: mesh export failed. {result=}\")\n    else:\n        log(f'SUCCESS: Saved {format_type.upper()} to {root_filename} in {directory}')\n        return True\n",
  "language": "python",
  "imports": [
    "Rhino",
    "Rhino.Geometry",
    "scriptcontext"
  ],
  "has_docstring": true
}