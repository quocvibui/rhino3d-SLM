{
  "source_url": "https://github.com/KeithSloan/ImportExport_3DM/blob/c63ae55e24aeeef6c1ff31316977cae779b9a6ce/freecad/importExport3DM/improved_import3DM.py",
  "repo": "KeithSloan/ImportExport_3DM",
  "repo_stars": 3,
  "repo_description": null,
  "license": "NOASSERTION",
  "filepath": "freecad/importExport3DM/improved_import3DM.py",
  "instruction": "Improved import3dm",
  "code": "import FreeCAD, FreeCADGui\nimport Part, Draft, math, Mesh\nimport os\nimport rhino3dm as r3\nfrom freecad.importExport3DM.objects3DM import ViewProvider\n\n# -------------------------\n# Utility Functions\n# -------------------------\n\ndef toFCvec(r3pnt):\n    return FreeCAD.Vector(r3pnt.X, r3pnt.Y, r3pnt.Z)\n\ndef toFCangle(center, start):\n    return math.atan2(start.Y - center.Y, start.X - center.X) * 180 / math.pi\n\ndef getFCKnots(fknots):\n    k = list(fknots)\n    knots = sorted(set(k))\n    mults = [k.count(kn) for kn in knots]\n    mults[0] += 1\n    mults[-1] += 1\n    return knots, mults\n\n# -------------------------\n# Main 3DM Import Class\n# -------------------------\n\nclass File3dm:\n    def __init__(self, path):\n        self.f3dm = r3.File3dm.Read(path)\n\n    def parse_objects(self, doc=None):\n        if not doc:\n            doc = FreeCAD.newDocument(\"3dm_import\")\n        part = doc.addObject(\"App::Part\", \"Part\")\n        for rhino_obj in self.f3dm.Objects:\n            fc_obj = self.import_geometry(doc, rhino_obj.Geometry)\n            if fc_obj:\n                part.addObject(fc_obj)\n\n    # ---------------------\n    # Import Geometry Types\n    # ---------------------\n    def import_geometry(self, doc, geo):\n        if isinstance(geo, r3.Brep):\n            return self.import_brep(doc, geo)\n        elif isinstance(geo, (r3.NurbsCurve, r3.Curve)):\n            return self.import_curve(doc, geo)\n        elif isinstance(geo, r3.LineCurve):\n            return self.import_line(doc, geo)\n        elif isinstance(geo, r3.PolylineCurve):\n            return self.import_polyline(doc, geo)\n        elif isinstance(geo, r3.Mesh):\n            return self.create_mesh(doc, geo)\n        elif isinstance(geo, r3.NurbsSurface):\n            return self.create_surface(doc, geo)\n        else:\n            FreeCAD.Console.PrintMessage(f\"Geometry type {type(geo)} not yet handled\\n\")\n            return None\n\n    # ---------------------\n    # Brep Handling\n    # ---------------------\n    def import_brep(self, doc, geo):\n        shapes = []\n        # If single surface\n        if geo.IsSurface:\n            obj = doc.addObject(\"Part::Feature\", \"BrepSurface\")\n            obj.Shape = self.create_surface(geo.Surfaces[0]).toShape()\n            return obj\n        # Otherwise create compound from edges\n        for e in geo.Edges:\n            shapes.append(self.create_curve(e).toShape())\n        if shapes:\n            obj = doc.addObject(\"Part::Feature\", \"BrepEdges\")\n            obj.Shape = Part.Compound(shapes)\n            return obj\n\n    # ---------------------\n    # Curves\n    # ---------------------\n    def import_curve(self, doc, geo):\n        obj = doc.addObject(\"Part::FeaturePython\", \"NurbsCurve\")\n        obj.Shape = self.create_curve(geo).toShape()\n        ViewProvider(obj)\n        return obj\n\n    def import_line(self, doc, geo):\n        obj = doc.addObject(\"Part::Line\", \"LineCurve\")\n        obj.X1, obj.Y1, obj.Z1 = geo.PointAtStart.X, geo.PointAtStart.Y, geo.PointAtStart.Z\n        obj.X2, obj.Y2, obj.Z2 = geo.PointAtEnd.X, geo.PointAtEnd.Y, geo.PointAtEnd.Z\n        obj.recompute()\n        return obj\n\n    def import_polyline(self, doc, geo):\n        obj = doc.addObject(\"Part::Polygon\", \"PolyLineCurve\")\n        points = [toFCvec(geo.Point(i)) for i in range(geo.PointCount)]\n        obj.Nodes = points\n        obj.recompute()\n        return obj\n\n    # ---------------------\n    # NURBS / Surface\n    # ---------------------\n    def create_curve(self, edge):\n        nc = edge.ToNurbsCurve()\n        pts = [FreeCAD.Vector(p.X / p.W, p.Y / p.W, p.Z / p.W) for p in nc.Points]\n        weights = [p.W for p in nc.Points]\n        ku, mu = getFCKnots(nc.Knots)\n        bs = Part.BSplineCurve()\n        bs.buildFromPolesMultsKnots(pts, mu, ku, False, nc.Degree, weights)\n        return bs\n\n    def create_surface(self, surf):\n        nu = surf.ToNurbsSurface() if hasattr(surf, 'ToNurbsSurface') else surf\n        pts, weights = [], []\n        for u in range(nu.Points.CountU):\n            row, wrow = [], []\n            for v in range(nu.Points.CountV):\n                p = nu.Points[u, v]\n                row.append(FreeCAD.Vector(p.X / p.W, p.Y / p.W, p.Z / p.W))\n                wrow.append(p.W)\n            pts.append(row)\n            weights.append(wrow)\n        ku, mu = getFCKnots(nu.KnotsU)\n        kv, mv = getFCKnots(nu.KnotsV)\n        bs = Part.BSplineSurface()\n        bs.buildFromPolesMultsKnots(pts, mu, mv, ku, kv, False, False, nu.Degree(0), nu.Degree(1), weights)\n        return bs\n\n    # ---------------------\n    # Mesh\n    # ---------------------\n    def create_mesh(self, doc, r3mesh):\n        fcMesh = Mesh.Mesh()\n        for i in range(r3mesh.Faces.TriangleCount):\n            f = r3mesh.Faces[i]\n            verts = [(r3mesh.Vertices[idx].X, r3mesh.Vertices[idx].Y, r3mesh.Vertices[idx].Z) for idx in f[:3]]\n            fcMesh.addFacet(*[coord for vertex in verts for coord in vertex])\n        obj = doc.addObject(\"Mesh::Feature\", \"Mesh\")\n        obj.Mesh = fcMesh\n        return obj\n\n# -------------------------\n# Main Functions\n# -------------------------\n\ndef open(filename):\n    docname = os.path.splitext(os.path.basename(filename))[0]\n    doc = FreeCAD.newDocument(docname)\n    if filename.lower().endswith(\".3dm\"):\n        process3DM(doc, filename)\n    return doc\n\ndef insert(filename, docname):\n    try:\n        doc = FreeCAD.getDocument(docname)\n    except NameError:\n        doc = FreeCAD.newDocument(docname)\n    if filename.lower().endswith(\".3dm\"):\n        process3DM(doc, filename)\n\ndef process3DM(doc, filename):\n    FreeCAD.Console.PrintMessage(f\"Import 3DM file: {filename}\\n\")\n    fi = File3dm(filename)\n    fi.parse_objects(doc)\n    FreeCADGui.SendMsgToActiveView(\"ViewFit\")\n    FreeCAD.Console.PrintMessage(\"3DM File Imported\\n\")\n\n",
  "language": "python",
  "imports": [
    "rhino3dm"
  ],
  "has_docstring": false
}