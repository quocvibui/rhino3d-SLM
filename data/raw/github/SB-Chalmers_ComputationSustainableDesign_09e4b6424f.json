{
  "source_url": "https://github.com/SB-Chalmers/ComputationSustainableDesign/blob/7f61d112e0d60667bbef3e6fc4fc7236bcf6bbba/Grasshopper%20Scripts/PVGIS_API/PVGIS_hourly.py",
  "repo": "SB-Chalmers/ComputationSustainableDesign",
  "repo_stars": 2,
  "repo_description": null,
  "license": "NOASSERTION",
  "filepath": "Grasshopper Scripts/PVGIS_API/PVGIS_hourly.py",
  "instruction": "Pvgis hourly",
  "code": "import ghpythonlib.components as ghcomp\nimport Grasshopper.Kernel as gh\nimport urllib2\nimport urllib\nimport json\n\n# Function to check if a year is a leap year\ndef is_leap_year(year):\n    return (year % 4 == 0 and year % 100 != 0) or (year % 400 == 0)\n\ndef remove_leapday_hours(list_of_8784_numbers):\n    \"\"\"\n    Removes the hours corresponding to February 29th for leap years from the list of 8784 hourly data points.\n    \n    Args:\n    - list_of_8784_numbers: List of hourly data points (length 8784).\n    \n    Returns:\n    - List of hourly data points with leap day hours removed (length 8760).\n    \"\"\"\n    if len(list_of_8784_numbers) != 8784:\n        raise ValueError(\"The input list must have exactly 8784 elements.\")\n    \n    # Indices of hours corresponding to February 29th in a leap year (for a year starting from January 1st)\n    leap_day_indices = [1416 + i for i in range(24)]\n\n    # Remove the leap day hours\n    filtered_data = [data for i, data in enumerate(list_of_8784_numbers) if i not in leap_day_indices]\n    \n    # Handle subsequent years by shifting the indices accordingly\n    for year_start in range(8784, len(list_of_8784_numbers), 8784):\n        leap_day_indices = [year_start + 1416 + i for i in range(24)]\n        filtered_data.extend([data for i, data in enumerate(list_of_8784_numbers[year_start:year_start + 8784]) if i not in leap_day_indices])\n    \n    return filtered_data\n\ndef create_warning(msg):\n    \"\"\"\n    Adds a warning message to the Grasshopper component.\n    \"\"\"\n    ghenv.Component.AddRuntimeMessage(gh.GH_RuntimeMessageLevel.Warning, msg)\n\ndef create_output(output):\n    \"\"\"\n    Sets the output nickname and description.\n    \"\"\"\n    ghenv.Component.Params.Output[0].NickName = \"API Output\"\n    ghenv.Component.Params.Output[0].Description = \"API output data\"\n    return output\n\ndef initialize_inputs():\n    \"\"\"\n    Initialize component inputs if they do not exist.\n    \"\"\"\n    if not ghenv.Component.Params.Input[0].Name == \"lat\":\n        ghenv.Component.Params.Input[0].NickName = \"lat\"\n        ghenv.Component.Params.Input[0].Name = \"lat\"\n        ghenv.Component.Params.Input[0].Description = \"Latitude in decimal degrees, south is negative\"\n        ghenv.Component.Params.Input[0].Optional = False\n\n    if not ghenv.Component.Params.Input[1].Name == \"lon\":\n        ghenv.Component.Params.Input[1].NickName = \"lon\"\n        ghenv.Component.Params.Input[1].Name = \"lon\"\n        ghenv.Component.Params.Input[1].Description = \"Longitude in decimal degrees, west is negative\"\n        ghenv.Component.Params.Input[1].Optional = False\n\n    if not ghenv.Component.Params.Input[2].Name == \"usehorizon\":\n        ghenv.Component.Params.Input[2].NickName = \"usehorizon\"\n        ghenv.Component.Params.Input[2].Name = \"usehorizon\"\n        ghenv.Component.Params.Input[2].Description = \"Calculate taking into account shadows from high horizon\"\n        ghenv.Component.Params.Input[2].Optional = True\n\n    if not ghenv.Component.Params.Input[3].Name == \"userhorizon\":\n        ghenv.Component.Params.Input[3].NickName = \"userhorizon\"\n        ghenv.Component.Params.Input[3].Name = \"userhorizon\"\n        ghenv.Component.Params.Input[3].Description = \"Heights of the horizon at equidistant directions\"\n        ghenv.Component.Params.Input[3].Optional = True\n\n    if not ghenv.Component.Params.Input[4].Name == \"raddatabase\":\n        ghenv.Component.Params.Input[4].NickName = \"raddatabase\"\n        ghenv.Component.Params.Input[4].Name = \"raddatabase\"\n        ghenv.Component.Params.Input[4].Description = \"Name of the radiation database\"\n        ghenv.Component.Params.Input[4].Optional = True\n\n    if not ghenv.Component.Params.Input[5].Name == \"startyear\":\n        ghenv.Component.Params.Input[5].NickName = \"startyear\"\n        ghenv.Component.Params.Input[5].Name = \"startyear\"\n        ghenv.Component.Params.Input[5].Description = \"First year of hourly averages\"\n        ghenv.Component.Params.Input[5].Optional = True\n\n    if not ghenv.Component.Params.Input[6].Name == \"endyear\":\n        ghenv.Component.Params.Input[6].NickName = \"endyear\"\n        ghenv.Component.Params.Input[6].Name = \"endyear\"\n        ghenv.Component.Params.Input[6].Description = \"Final year of hourly averages\"\n        ghenv.Component.Params.Input[6].Optional = True\n\n    if not ghenv.Component.Params.Input[7].Name == \"pvcalculation\":\n        ghenv.Component.Params.Input[7].NickName = \"pvcalculation\"\n        ghenv.Component.Params.Input[7].Name = \"pvcalculation\"\n        ghenv.Component.Params.Input[7].Description = \"0 for only solar radiation, 1 for PV production estimation\"\n        ghenv.Component.Params.Input[7].Optional = True\n\n    if not ghenv.Component.Params.Input[8].Name == \"peakpower\":\n        ghenv.Component.Params.Input[8].NickName = \"peakpower\"\n        ghenv.Component.Params.Input[8].Name = \"peakpower\"\n        ghenv.Component.Params.Input[8].Description = \"Nominal power of the PV system in kW\"\n        ghenv.Component.Params.Input[8].Optional = True\n\n    if not ghenv.Component.Params.Input[9].Name == \"pvtechchoice\":\n        ghenv.Component.Params.Input[9].NickName = \"pvtechchoice\"\n        ghenv.Component.Params.Input[9].Name = \"pvtechchoice\"\n        ghenv.Component.Params.Input[9].Description = \"PV technology choice\"\n        ghenv.Component.Params.Input[9].Optional = True\n\n    if not ghenv.Component.Params.Input[10].Name == \"mountingplace\":\n        ghenv.Component.Params.Input[10].NickName = \"mountingplace\"\n        ghenv.Component.Params.Input[10].Name = \"mountingplace\"\n        ghenv.Component.Params.Input[10].Description = \"Type of PV module mounting\"\n        ghenv.Component.Params.Input[10].Optional = True\n\n    if not ghenv.Component.Params.Input[11].Name == \"loss\":\n        ghenv.Component.Params.Input[11].NickName = \"loss\"\n        ghenv.Component.Params.Input[11].Name = \"loss\"\n        ghenv.Component.Params.Input[11].Description = \"System losses in percent\"\n        ghenv.Component.Params.Input[11].Optional = True\n\n    if not ghenv.Component.Params.Input[12].Name == \"trackingtype\":\n        ghenv.Component.Params.Input[12].NickName = \"trackingtype\"\n        ghenv.Component.Params.Input[12].Name = \"trackingtype\"\n        ghenv.Component.Params.Input[12].Description = \"Type of suntracking used\"\n        ghenv.Component.Params.Input[12].Optional = True\n\n    if not ghenv.Component.Params.Input[13].Name == \"angle\":\n        ghenv.Component.Params.Input[13].NickName = \"angle\"\n        ghenv.Component.Params.Input[13].Name = \"angle\"\n        ghenv.Component.Params.Input[13].Description = \"Inclination angle from the horizontal plane\"\n        ghenv.Component.Params.Input[13].Optional = True\n\n    if not ghenv.Component.Params.Input[14].Name == \"aspect\":\n        ghenv.Component.Params.Input[14].NickName = \"aspect\"\n        ghenv.Component.Params.Input[14].Name = \"aspect\"\n        ghenv.Component.Params.Input[14].Description = \"Orientation angle\"\n        ghenv.Component.Params.Input[14].Optional = True\n\n    if not ghenv.Component.Params.Input[15].Name == \"optimalinclination\":\n        ghenv.Component.Params.Input[15].NickName = \"optimalinclination\"\n        ghenv.Component.Params.Input[15].Name = \"optimalinclination\"\n        ghenv.Component.Params.Input[15].Description = \"Calculate the optimum inclination angle\"\n        ghenv.Component.Params.Input[15].Optional = True\n\n    if not ghenv.Component.Params.Input[16].Name == \"optimalangles\":\n        ghenv.Component.Params.Input[16].NickName = \"optimalangles\"\n        ghenv.Component.Params.Input[16].Name = \"optimalangles\"\n        ghenv.Component.Params.Input[16].Description = \"Calculate both optimal inclination and orientation angles\"\n        ghenv.Component.Params.Input[16].Optional = True\n\n    if not ghenv.Component.Params.Input[17].Name == \"components\":\n        ghenv.Component.Params.Input[17].NickName = \"components\"\n        ghenv.Component.Params.Input[17].Name = \"components\"\n        ghenv.Component.Params.Input[17].Description = \"Output beam, diffuse, and reflected radiation components\"\n        ghenv.Component.Params.Input[17].Optional = True\n\n    if not ghenv.Component.Params.Input[18].Name == \"outputformat\":\n        ghenv.Component.Params.Input[18].NickName = \"outputformat\"\n        ghenv.Component.Params.Input[18].Name = \"outputformat\"\n        ghenv.Component.Params.Input[18].Description = \"Output format (csv, basic, json)\"\n        ghenv.Component.Params.Input[18].Optional = True\n\n    if not ghenv.Component.Params.Input[19].Name == \"browser\":\n        ghenv.Component.Params.Input[19].NickName = \"browser\"\n        ghenv.Component.Params.Input[19].Name = \"browser\"\n        ghenv.Component.Params.Input[19].Description = \"Use if accessing from a web browser\"\n        ghenv.Component.Params.Input[19].Optional = True\n\n# Initialize inputs\ninitialize_inputs()\n\n# Default values for the optional inputs\nlat_default = None\nlon_default = None\nusehorizon_default = 1\nuserhorizon_default = []\nraddatabase_default = \"PVGIS-SARAH\"  # Choose a valid default database\nstartyear_default = None\nendyear_default = None\npvcalculation_default = 1\npeakpower_default = 1\npvtechchoice_default = \"crystSi\"\nmountingplace_default = \"building\"\nloss_default = 14\ntrackingtype_default = 0\nangle_default = 0\naspect_default = 0\noptimalinclination_default = 0\noptimalangles_default = 0\ncomponents_default = 0\noutputformat_default = \"json\"\nbrowser_default = 0\n\n# Input validation and assignment\nlat = lat if lat is not None else lat_default\nlon = lon if lon is not None else lon_default\nusehorizon = usehorizon if usehorizon is not None else usehorizon_default\nuserhorizon = userhorizon if userhorizon is not None else userhorizon_default\nraddatabase = raddatabase if raddatabase is not None else raddatabase_default\nstartyear = startyear if startyear is not None else startyear_default\nendyear = endyear if endyear is not None else endyear_default\npvcalculation = pvcalculation if pvcalculation is not None else pvcalculation_default\npeakpower = peakpower if peakpower is not None else peakpower_default\npvtechchoice = pvtechchoice if pvtechchoice is not None else pvtechchoice_default\nmountingplace = mountingplace if mountingplace is not None else mountingplace_default\nloss = loss if loss is not None else loss_default\ntrackingtype = trackingtype if trackingtype is not None else trackingtype_default\nangle = angle if angle is not None else angle_default\naspect = aspect if aspect is not None else aspect_default\noptimalinclination = optimalinclination if optimalinclination is not None else optimalinclination_default\noptimalangles = optimalangles if optimalangles is not None else optimalangles_default\ncomponents = components if components is not None else components_default\noutputformat = outputformat if outputformat is not None else outputformat_default\nbrowser = browser if browser is not None else browser_default\n\n# Check for minimum obligatory inputs and add warning if missing\nmandatory_inputs = {\n    \"Latitude\": lat,\n    \"Longitude\": lon\n}\n\nif pvcalculation == 1:\n    mandatory_inputs.update({\n        \"Peak Power\": peakpower,\n        \"Loss\": loss,\n        \"Mounting Place\": mountingplace,\n        \"Angle\": angle,\n        \"Aspect\": aspect\n    })\n\nmissing_inputs = [name for name, value in mandatory_inputs.items() if value is None]\n\nif run:\n    # Check for minimum obligatory inputs and add warning if missing\n    mandatory_inputs = {\n        \"Latitude\": lat,\n        \"Longitude\": lon\n    }\n\n    if pvcalculation == 1:\n        mandatory_inputs.update({\n            \"Peak Power\": peakpower,\n            \"Loss\": loss,\n            \"Mounting Place\": mountingplace,\n            \"Angle\": angle,\n            \"Aspect\": aspect\n        })\n\n    missing_inputs = [name for name, value in mandatory_inputs.items() if value is None]\n\n    if missing_inputs:\n        create_warning(\"Missing mandatory inputs: {}\".format(\", \".join(missing_inputs)))\n        output = None\n    else:\n        # Construct the input dictionary\n        input_params = {\n            \"lat\": lat,\n            \"lon\": lon,\n            \"usehorizon\": usehorizon,\n            \"raddatabase\": raddatabase,\n            \"startyear\": startyear,\n            \"endyear\": endyear,\n            \"pvcalculation\": pvcalculation,\n            \"peakpower\": peakpower,\n            \"pvtechchoice\": pvtechchoice,\n            \"mountingplace\": mountingplace,\n            \"loss\": loss,\n            \"trackingtype\": trackingtype,\n            \"angle\": angle,\n            \"aspect\": aspect,\n            \"optimalinclination\": optimalinclination,\n            \"optimalangles\": optimalangles,\n            \"components\": components,\n            \"outputformat\": outputformat,\n            \"browser\": browser\n        }\n        \n        # Only add 'userhorizon' if it is not empty\n        if userhorizon:\n            input_params[\"userhorizon\"] = \",\".join(map(str, userhorizon))\n        \n        # Remove any keys with None values\n        input_params = {k: v for k, v in input_params.items() if v is not None}\n        \n        # Base URL for the API\n        base_url = \"https://re.jrc.ec.europa.eu/api/v5_2/seriescalc\"\n        \n        # Encode parameters into URL\n        url_params = urllib.urlencode(input_params)\n        full_url = \"{}?{}\".format(base_url, url_params)\n        \n        # Parsing and storing each section in different variables\n        try:\n            # Make the API call\n            response = urllib2.urlopen(full_url)\n            response_data = response.read()\n            \n            # Decode the response based on output format\n            if outputformat == \"json\":\n                response_json = json.loads(response_data)\n                output = response_json\n            else:\n                output = response_data\n            \n            # Parse and store each section in different variables\n            inputs_data = response_json.get(\"inputs\", {})\n            outputs_data = response_json.get(\"outputs\", {})\n            meta_data = response_json.get(\"meta\", {})\n            \n            # Store specific sections in separate variables\n            location = inputs_data.get(\"location\", {})\n            meteo_data = inputs_data.get(\"meteo_data\", {})\n            mounting_system = inputs_data.get(\"mounting_system\", {})\n            pv_module = inputs_data.get(\"pv_module\", {})\n            \n            hourly_data = outputs_data.get(\"hourly\", [])\n            \n            # Extract the specified hourly outputs\n            time_stamps = [hour[\"time\"] for hour in hourly_data]\n            P = [hour[\"P\"] for hour in hourly_data]\n            G_i = [hour[\"G(i)\"] for hour in hourly_data]\n            H_sun = [hour[\"H_sun\"] for hour in hourly_data]\n            T2m = [hour[\"T2m\"] for hour in hourly_data]\n            WS10m = [hour[\"WS10m\"] for hour in hourly_data]\n            Int = [hour[\"Int\"] for hour in hourly_data]\n            \n        except urllib2.URLError as e:\n            create_warning(\"API call failed: {}\".format(e.reason))\n            output = None\n        except ValueError:\n            create_warning(\"No JSON object could be decoded. Check if outputformat is set correctly.\")\n            output = response_data\n        except Exception as e:\n            create_warning(\"Unexpected error: {}\".format(str(e)))\n            output = None\n\n    # Print debug information\n    print(\"URL: {}\".format(full_url))\n\n\n\n    if is_leap_year(startyear):\n        time_stamps = remove_leapday_hours(time_stamps)\n        P = remove_leapday_hours(P)\n        G_i = remove_leapday_hours(G_i)\n        H_sun = remove_leapday_hours(H_sun)\n        T2m = remove_leapday_hours(T2m)\n        WS10m = remove_leapday_hours(WS10m)\n        Int = remove_leapday_hours(Int)",
  "language": "python",
  "imports": [
    "ghpythonlib"
  ],
  "has_docstring": false
}