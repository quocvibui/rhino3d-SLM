{
  "source_url": "https://github.com/Ennead-Architects-LLP/EA_Dist/blob/635520d89b8308b78eabf5b60bb80121d0fa3838/Apps/_revit/EnneaDuck.extension/EnneadTab.tab/Import%20Export.panel/Rhino.pulldown/room2diagram.pushbutton/rhino_process.py",
  "repo": "Ennead-Architects-LLP/EA_Dist",
  "repo_stars": 0,
  "repo_description": null,
  "license": "unknown",
  "filepath": "Apps/_revit/EnneaDuck.extension/EnneadTab.tab/Import Export.panel/Rhino.pulldown/room2diagram.pushbutton/rhino_process.py",
  "instruction": "Rhino-specific processing for room2diagram export.",
  "code": "#!/usr/bin/python\r\n# -*- coding: utf-8 -*-\r\n\r\n\"\"\"\r\nRhino-specific processing for room2diagram export.\r\n\"\"\"\r\n\r\nimport clr  # pyright: ignore\r\nimport os\r\n\r\ntry:\r\n    import System  # pyright: ignore\r\n    clr.AddReference('RhinoCommon')\r\n    import Rhino  # pyright: ignore\r\n    IMPORT_OK = True\r\nexcept:\r\n    IMPORT_OK = False\r\n\r\n# Try to import RhinoInside converters if available\r\ntry:\r\n    clr.AddReference('RhinoInside.Revit')\r\n    from RhinoInside.Revit.Convert.Geometry import GeometryDecoder as RIR_DECODER  # pyright: ignore\r\n    from RhinoInside.Revit.Convert.Geometry import GeometryEncoder as RIR_ENCODER  # pyright: ignore\r\n    RIR_IMPORT_OK = True\r\nexcept:\r\n    RIR_IMPORT_OK = False\r\n\r\nfrom EnneadTab import FOLDER, ENVIRONMENT\r\nfrom EnneadTab.REVIT import REVIT_RHINO, REVIT_UNIT\r\nfrom Autodesk.Revit import DB # pyright: ignore\r\nfrom base_processor import BaseProcessor\r\n\r\n\r\nclass RhinoProcess(BaseProcessor):\r\n    \"\"\"Handles Rhino-specific processing for diagram export.\"\"\"\r\n    \r\n    def __init__(self, revit_doc, fillet_radius, offset_distance):\r\n        \"\"\"Initialize Rhino processor.\r\n        \r\n        Args:\r\n            revit_doc: Active Revit document\r\n            fillet_radius: Corner fillet radius in feet\r\n            offset_distance: Inner offset distance in feet\r\n        \"\"\"\r\n        BaseProcessor.__init__(self, revit_doc, fillet_radius, offset_distance)\r\n        \r\n        self.rhino_doc = None\r\n        self.current_level_name = None\r\n        self.current_output_file = None\r\n    \r\n    def _setup_rhino_doc(self, level_name):\r\n        \"\"\"Setup Rhino document for export with level-specific file.\"\"\"\r\n        # Create level-specific output file name\r\n        safe_level_name = \"\".join(c for c in level_name if c.isalnum() or c in (' ', '-', '_')).rstrip()\r\n        safe_level_name = safe_level_name.replace(' ', '_')\r\n        self.current_level_name = safe_level_name\r\n        self.current_output_file = FOLDER.get_local_dump_folder_file(\"{}BubbleDiagram_{}.3dm\".format(ENVIRONMENT.PLUGIN_NAME, safe_level_name))\r\n        \r\n        # Setup Rhino document\r\n        self.rhino_doc = REVIT_RHINO.setup_rhino_doc(self.revit_doc)\r\n        self.rhino_doc.HatchPatterns.Add(Rhino.DocObjects.HatchPattern.Defaults.Solid)\r\n    \r\n    def _get_layer(self, layer_name, color=None):\r\n        \"\"\"Get or create a Rhino layer with specified name and color.\"\"\"\r\n        if not self.rhino_doc:\r\n            return None\r\n        layer = self.rhino_doc.Layers.FindName(layer_name)\r\n        if not layer:\r\n            layer = Rhino.DocObjects.Layer()\r\n            layer.Name = layer_name\r\n            if color:\r\n                layer.Color = color\r\n            self.rhino_doc.Layers.Add(layer)\r\n            layer = self.rhino_doc.Layers.FindName(layer_name)\r\n        return layer\r\n    \r\n    def _create_filleted_curve(self, curve, space_color_identifier):\r\n        \"\"\"Create filleted curve with offset if specified using shared processor.\"\"\"\r\n        if not self.rhino_doc:\r\n            return None\r\n        \r\n        # Use base class curve processing\r\n        processed_curves = self.process_curves([curve], \"rhino\")\r\n        \r\n        if processed_curves and len(processed_curves) > 0:\r\n            curve = processed_curves[0]\r\n        else:\r\n            # Fallback to original curve if processing fails\r\n            print(\"Curve processing failed - using original curve\")\r\n        \r\n        # Add outline to Rhino\r\n        if not self.rhino_doc:\r\n            return curve\r\n            \r\n        attr = Rhino.DocObjects.ObjectAttributes()\r\n        layer = self._get_layer(\"_Outline::\" + space_color_identifier)\r\n        if layer:\r\n            attr.LayerIndex = layer.Index\r\n            self.rhino_doc.Objects.AddCurve(curve, attr)\r\n        \r\n        return curve\r\n    \r\n    def _create_and_add_hatch(self, curve, space_color_identifier):\r\n        \"\"\"Create and add hatch for the curve.\"\"\"\r\n        if not self.rhino_doc:\r\n            return\r\n            \r\n        attr = Rhino.DocObjects.ObjectAttributes()\r\n        revit_color = self.color_dict[space_color_identifier]\r\n        layer_color = System.Drawing.Color.FromArgb(revit_color.Red, revit_color.Green, revit_color.Blue)\r\n        layer = self._get_layer(\"_Hatch::\" + space_color_identifier, layer_color)\r\n        if layer:\r\n            attr.LayerIndex = layer.Index\r\n\r\n        solid_pattern = Rhino.DocObjects.HatchPattern.Defaults.Solid\r\n        hatch_pattern_index = solid_pattern.Index\r\n        tolerance = self.rhino_doc.ModelAbsoluteTolerance\r\n        breps = Rhino.Geometry.Brep.CreatePlanarBreps([curve], tolerance)\r\n        if not breps:\r\n            print(\"No hatch created for some shape, maybe radius too small or there is a gap in your line.\")\r\n            return\r\n        for brep in breps:\r\n            face_index = brep.Faces.Count - 1\r\n            hatch = Rhino.Geometry.Hatch.CreateFromBrep(brep, \r\n                                                    face_index, \r\n                                                    hatch_pattern_index,\r\n                                                    Rhino.RhinoMath.ToRadians(0), \r\n                                                    1,\r\n                                                    Rhino.Geometry.Point3d.Origin)\r\n            self.rhino_doc.Objects.AddHatch(hatch, attr)\r\n    \r\n    def _write_rhino_file(self):\r\n        \"\"\"Write Rhino file to disk.\"\"\"\r\n        if not self.rhino_doc or not self.current_output_file:\r\n            return\r\n            \r\n        write_option = Rhino.FileIO.FileWriteOptions()\r\n        write_option.FileVersion = 7\r\n        self.rhino_doc.Write3dmFile(self.current_output_file, write_option)\r\n        self.rhino_doc.Dispose()\r\n        print(\"Successfully exported Revit Spaces to Rhino file: {}\".format(self.current_output_file))\r\n        if self.current_output_file:\r\n            os.startfile(self.current_output_file)\r\n    \r\n    def _process_space_for_rhino(self, space_data):\r\n        \"\"\"Process a single space for Rhino export.\"\"\"\r\n        if not self.rhino_doc:\r\n            return False\r\n            \r\n        space = space_data['space']\r\n        space_color_identifier = space_data['identifier']\r\n        space_area = space_data['area']\r\n        boundary_curves = space_data['curves']\r\n\r\n        # Add text label with area\r\n        label_layer = self._get_layer(\"_Label\", System.Drawing.Color.Black)\r\n        if label_layer:\r\n            label_attr = Rhino.DocObjects.ObjectAttributes()\r\n            label_attr.LayerIndex = label_layer.Index\r\n\r\n            text_content = \"{}\\n{} SF\".format(space_color_identifier, space_area)\r\n            text_geo = Rhino.Display.Text3d(text_content)\r\n            text_geo.HorizontalAlignment = Rhino.DocObjects.TextHorizontalAlignment.Center\r\n            # Create text plane safely - avoid casting issues\r\n            try:\r\n                if RIR_IMPORT_OK:\r\n                    # Use RhinoInside converter if available\r\n                    text_geo.TextPlane = RIR_DECODER.ToPlane(DB.Plane.CreateByNormalAndOrigin(DB.XYZ(0,0,1), space.Location.Point))\r\n                else:\r\n                    # Fallback: create Rhino plane directly\r\n                    space_point = space.Location.Point\r\n                    origin = Rhino.Geometry.Point3d(space_point.X, space_point.Y, space_point.Z)\r\n                    normal = Rhino.Geometry.Vector3d(0, 0, 1)\r\n                    text_geo.TextPlane = Rhino.Geometry.Plane(origin, normal)\r\n            except Exception as plane_error:\r\n                print(\"Warning: Failed to create text plane: {}. Using default plane.\".format(str(plane_error)))\r\n                # Use default plane as fallback\r\n                text_geo.TextPlane = Rhino.Geometry.Plane.WorldXY\r\n            self.rhino_doc.Objects.AddText(text_geo, label_attr)\r\n\r\n        # Process boundary curves (convert from Revit to Rhino format)\r\n        if boundary_curves:\r\n            # Convert Revit curves to Rhino curves first\r\n            rhino_curves = self._convert_to_rhino_curves(boundary_curves, \"revit\")\r\n            \r\n            if rhino_curves and len(rhino_curves) > 0:\r\n                # Join curves if multiple\r\n                if len(rhino_curves) > 1:\r\n                    try:\r\n                        joined_curves = Rhino.Geometry.Curve.JoinCurves(rhino_curves)\r\n                        if joined_curves and len(joined_curves) > 0:\r\n                            curve = joined_curves[0]\r\n                        else:\r\n                            curve = rhino_curves[0]  # Fallback to first curve if join fails\r\n                    except Exception as join_error:\r\n                        print(\"Warning: Failed to join curves: {}. Using first curve.\".format(str(join_error)))\r\n                        curve = rhino_curves[0]\r\n                else:\r\n                    curve = rhino_curves[0]\r\n                \r\n                filleted_crv = self._create_filleted_curve(curve, space_color_identifier)\r\n                if filleted_crv:\r\n                    self._create_and_add_hatch(filleted_crv, space_color_identifier)\r\n            else:\r\n                print(\"Warning: No valid Rhino curves converted from boundary curves\")\r\n        \r\n        return True\r\n    \r\n    def _process_spaces_for_rhino(self, results):\r\n        \"\"\"Process spaces for Rhino export.\"\"\"\r\n        try:\r\n            # Get level name and processed spaces\r\n            level_name = results.get('level_name', 'Unknown_Level')\r\n            processed_spaces = results.get('processed_spaces', [])\r\n            \r\n            print(\"Processing {} spaces for Rhino export (Level: {})\".format(len(processed_spaces), level_name))\r\n            \r\n            # Setup Rhino document\r\n            self._setup_rhino_doc(level_name)\r\n            \r\n            # Process each space\r\n            for space_data in processed_spaces:\r\n                self._process_space_for_rhino(space_data)\r\n            \r\n            # Write Rhino file\r\n            self._write_rhino_file()\r\n            return True\r\n            \r\n        except Exception as e:\r\n            print(\"Error in Rhino processing: {}\".format(str(e)))\r\n            return False\r\n\r\n\r\nif __name__ == \"__main__\":\r\n    pass\r\n\r\n",
  "language": "python",
  "imports": [
    "Rhino",
    "Rhino.Geometry",
    "RhinoCommon"
  ],
  "has_docstring": true
}