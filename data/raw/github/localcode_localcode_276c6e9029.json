{
  "source_url": "https://github.com/localcode/localcode/blob/3089aee227d257adc856021a4e1eb678d9527f50/amigos_geometry.py",
  "repo": "localcode/localcode",
  "repo_stars": 4,
  "repo_description": "Code repository for the local code project",
  "license": "unknown",
  "filepath": "amigos_geometry.py",
  "instruction": "Amigos geometry",
  "code": "import sys\nimport math\n\nimport System\n\nimport Rhino\nfrom Rhino.Geometry import *\nimport scriptcontext\nfrom scriptcontext import doc\n\nfrom rhinopythonscripts import FileUtils, LayerUtils, IntersectionTools, Smart, GeomTools, RangeTools\nfrom rhinopythonscripts import RunCPythonScript as cScript\nsqlScript = 'C:\\\\Users\\\\demonchaux\\\\Dropbox\\\\localcode\\\\runsql.py'\n\nfrom sqls import *\n\nfrom site_ids import ids\n\nroad_layers = [\n        'freeways',\n        'roads',\n        ]\n\nborder_layers = [\n        'site',\n        'othersites',\n        'parcel',\n        ]\n\ntransportation_layers = [\n        'bikeways',\n        'drp_trails',\n        'rapidbuslines',\n        'expressbuslines',\n        'raillines',\n        'expressbuslines',\n        'localcentralbus',\n        'metrobusstops',\n        ]\n\nbillboard_layers = [\n        'foundbillboards',\n        'geocodedbillboards',\n        ]\n\nwater_layers = [\n        'hydrography',\n        'waterways',\n        'waterbodies',\n]\n\ndef getSiteLayerDict(index, types, layers):\n    id = ids[index]\n    fmask = 'C:\\\\amigos\\\\dump\\\\%s-%s.3dm'\n    fpaths = [(fmask % (id, t)) for t in types]\n    return FileUtils.importLayerDict(fpaths, layers)\n\ndef functionByLayer(function, layer):\n    objs = doc.Objects.FindByLayer(layer)\n    outList = []\n    for obj in objs:\n        outList.append(function(obj))\n\ndef projectCurvesToBrep(curves, brep, vector=Vector3d(0.0,0.0,1.0)):\n    projCurves = []\n    for curve in curves:\n        projCurves.extend(curve.ProjectToBrep(curve, brep, vector, 0.001))\n    return projCurves\n\ndef projectPointsToBrep(points, brep, vector=Vector3d(0.0,0.0,1.0)):\n    return Intersect.Intersection.ProjectPointsToBreps([brep], points, vector, 0.001)\n\ndef layerDict(index, types, layers):\n    for layer in layers:\n        objs.append(doc.Objects.FindByLayer(layer))\n    return dict(zip(layers, objs))\n\ndef p(anything):\n    print anything\n\ndef makeDrains():\n    drainLayers = ['openchannels',\n              'gravitymains',\n              'lateraldrains',\n              ]\n    drainColors = [\n            System.Drawing.Color.MidnightBlue,\n            System.Drawing.Color.Blue,\n            System.Drawing.Color.CornflowerBlue,\n            System.Drawing.Color.SkyBlue,\n            ]\n\n    for i in range(len(drainLayers)):\n        lyr = drainLayers[i]\n        newName = lyr+'-projected'\n        lyrAtt = LayerUtils.layerAttributes(newName, drainColors[i]) # make the layer\n        # get results\n        resultPairs = IntersectionTools.smartCurveLayerProject(lyr, 'groundsurface', lyrAtt)\n        # bake results\n        for pair in resultPairs:\n            scriptcontext.doc.Objects.AddCurve(pair[0], pair[1])\n    # get the catchbasins\n    srf = doc.Objects.FindByLayer('groundsurface')[0].Geometry\n    rawPts = Smart.RhinoObjectsToSmartFeatures(doc.Objects.FindByLayer('catchbasins'))\n    pt3ds = [pt.geom.Location for pt in rawPts]\n    lowPts = Smart.replaceGeometries(rawPts, pt3ds)\n    smrtPts = IntersectionTools.smartPointProject(lowPts, srf)\n    newPts = [pt.geom for pt in smrtPts]\n    circles = GeomTools.pointsToCircles(newPts, 0.5)\n    smrtCircles = Smart.replaceGeometries(smrtPts, circles)\n    lyrAtt = LayerUtils.layerAttributes('catchbasins-projected', drainColors[3])\n    for circle in smrtCircles:\n        doc.Objects.AddCircle(circle.geom, circle.objAttributes(lyrAtt))\n\ndef makeTerrainSurfaces():\n    ptGrid = GeomTools.pointGrid(76, 76, 8, 8)\n    # get the mesh\n    try:\n        mesh = doc.Objects.FindByLayer('tin_pts')[0].Geometry\n        # make the points\n        interpPoints = IntersectionTools.interpolatePointsToTerrainMesh(ptGrid, mesh)\n        # make the surface\n        srf = Rhino.Geometry.NurbsSurface.CreateFromPoints(interpPoints, 76, 76, 3, 3)\n    except:\n        print 'No contents on \"tin_pts\" layer'\n        print 'flat ground created'\n        srf = Rhino.Geometry.NurbsSurface.CreateFromPoints(ptGrid, 76, 76, 3, 3)\n    # put it on the layer\n    srfAtt = LayerUtils.layerAttributes('groundsurface', System.Drawing.Color.LightGray)\n    doc.Objects.AddSurface(srf, srfAtt)\n    srfBrep = Brep.CreateFromSurface(srf)\n\n    contours = IntersectionTools.contourBrepInZ(srfBrep, 0.5)\n\n    bigAtt = LayerUtils.layerAttributes('bigcontours', System.Drawing.Color.Black)\n    smallAtt = LayerUtils.layerAttributes('smallcontours', System.Drawing.Color.DimGray)\n    for i in range(len(contours)):\n        if i % 10 == 0:\n            # make a big contour\n            for crv in contours[i]:\n                doc.Objects.AddCurve(crv, bigAtt)\n        else:\n            # make a small contour\n            for crv in contours[i]:\n                doc.Objects.AddCurve(crv, smallAtt)\n\ndef makeTerrainFile(site_id):\n    filePath = 'C:\\\\amigos\\\\dump\\\\%s-terrain.3dm' % site_id\n    outLayers = [\n            'groundsurface',\n            'bigcontours',\n            'smallcontours',\n            ]\n    FileUtils.exportLayers(outLayers, filePath)\n\ndef makeTerrains(idList):\n    fmask = 'C:\\\\amigos\\\\dump\\\\%s-site.3dm'\n    for id in idList:\n        FileUtils.deleteAll()\n        fpaths = [fmask % id]\n        FileUtils.importFiles(fpaths)\n        makeTerrainSurfaces()\n        makeTerrainFile(id)\n\ndef makeDrainFiles(idList):\n    fmask = 'C:\\\\amigos\\\\dump\\\\%s-%s.3dm'\n    outMask = 'C:\\\\amigos\\\\dump\\\\%s-drains.3dm'\n    types = ['site', 'terrain']\n    outLayers = ['openchannels-projected',\n              'gravitymains-projected',\n              'lateraldrains-projected',\n              'catchbasins-projected',\n              ]\n    for id in idList:\n        FileUtils.deleteAll()\n        fpaths = [(fmask % (id, t)) for t in types]\n        FileUtils.importFiles(fpaths)\n        makeDrains()\n        outPath = outMask % id\n        FileUtils.exportLayers(outLayers, outPath)\n\ndef addBillboards():\n    # must have projected things already\n    FileUtils.importFile('C:\\\\amigos\\\\templates\\\\billboardangled.3dm')\n    FileUtils.importFile('C:\\\\amigos\\\\templates\\\\billboardstraight.3dm')\n    lyrAtt = LayerUtils.layerAttributes('billboards')\n    bbs = LayerUtils.getLayerGeometry('geocodedbillboards-projected')\n    bbs.extend( LayerUtils.getLayerGeometry('foundbillboards-projected') )\n    bbpoints = [bb.Location for bb in bbs]\n    frwys = LayerUtils.getLayerGeometry('freeways-projected')\n    roads = LayerUtils.getLayerGeometry('roads-projected')\n    for pt in bbpoints:\n        vector = GeomTools.vectorToClosestCurve(pt, frwys, 100.0)\n        if vector: # freeway within 100m\n            bbModel = LayerUtils.getLayerGeometry('billboardangled')\n        else: # no freeways within 100meters\n            vector = GeomTools.vectorToClosestCurve(pt, roads)\n            bbModel = LayerUtils.getLayerGeometry('billboardstraight')\n        GeomTools.moveMany( bbModel, Vector3d(pt) )\n        angle = vector.VectorAngle( Vector3d.XAxis, vector, Plane.WorldXY )\n        GeomTools.rotateMany( bbModel, angle, Vector3d.ZAxis, pt )\n        GeomTools.bakeMany( bbModel, lyrAtt )\n    LayerUtils.deleteLayer('billboardstraight')\n    LayerUtils.deleteLayer('billboardangled')\n\ndef makeBillboardFiles(idList):\n    fmask = 'C:\\\\amigos\\\\dump\\\\%s-%s.3dm'\n    outMask = 'C:\\\\amigos\\\\dump\\\\%s-billboards.3dm'\n    types = ['billboardpoints',\n            'terrain',\n            'roads',\n            ]\n    outLayers = ['billboards']\n    for siteId in idList:\n        FileUtils.deleteAll()\n        fpaths = [(fmask % (siteId, t)) for t in types]\n        FileUtils.importFiles(fpaths)\n        addBillboards()\n        outPath = outMask % siteId\n        FileUtils.exportLayers(outLayers, outPath)\n\ndef makeProjectedFiles(idList, layerList, fileSuffix):\n    fmask = 'C:\\\\amigos\\\\dump\\\\%s-%s.3dm'\n    outMask = 'C:\\\\amigos\\\\dump\\\\%s-'+fileSuffix+'.3dm'\n    types = ['site', 'terrain']\n    outLayers = [s+'-projected' for s in layerList]\n    for siteId in idList:\n        FileUtils.deleteAll()\n        fpaths = [(fmask % (siteId, t)) for t in types]\n        FileUtils.importFiles(fpaths)\n        for i, layer in enumerate(layerList):\n            lyrAtt = LayerUtils.layerAttributes(outLayers[i]) # make the layer\n            # determine geometry type\n            sampleGeom = LayerUtils.getLayerGeometry(layer)\n            if len(sampleGeom) > 0:\n                if type(sampleGeom[0]) == Point:\n                    resultPairs = IntersectionTools.smartPointLayerProject(layer, 'groundsurface', lyrAtt)\n                    # bake results\n                    for pair in resultPairs:\n                        scriptcontext.doc.Objects.AddPoint(pair[0], pair[1])\n                else:\n                    resultPairs = IntersectionTools.smartCurveLayerProject(layer, 'groundsurface', lyrAtt)\n                    # bake results\n                    for pair in resultPairs:\n                        scriptcontext.doc.Objects.AddCurve(pair[0], pair[1])\n        outPath = outMask % siteId\n        FileUtils.exportLayers(outLayers, outPath)\n\ndef importSiteFiles(siteId, types):\n    fmask = 'C:\\\\amigos\\\\dump\\\\%s-%s.3dm'\n    fpaths = [(fmask % (siteId, t)) for t in types]\n    FileUtils.deleteAll()\n    FileUtils.importFiles(fpaths)\n\n\n\nif __name__ == '__main__':\n    doc.UndoRecordingEnabled = False\n    doc.Views.RedrawEnabled = False\n    ##makeTerrains(range(435,767))\n    ##makeDrainFiles(range(501,767))\n    #makeProjectedFiles(range(448, 767), road_layers, 'roads')\n    #makeProjectedFiles(range(438,767), billboard_layers, 'billboardpoints')\n    #makeProjectedFiles(range(494, 767), border_layers, 'borders')\n    #makeProjectedFiles(range(574, 767), transportation_layers, 'transportation')\n    #makeProjectedFiles(range(395, 767), water_layers, 'water')\n    makeBillboardFiles(range(370, 767))\n    doc.Views.RedrawEnabled = True\n    doc.UndoRecordingEnabled = True\n    #addBillboards()\n    #import random\n    ##siteId = random.choice(ids)\n    #siteId = ids[20]\n    #types = [\n            ##'site',\n            #'terrain',\n            #'billboards',\n            #'drains',\n            #'roads',\n            #'borders',\n            #'transportation',\n            #'water',\n            #]\n\n    #importSiteFiles(siteId, types)\n\n\n\n",
  "language": "python",
  "imports": [
    "Rhino",
    "Rhino.Geometry",
    "scriptcontext"
  ],
  "has_docstring": false
}