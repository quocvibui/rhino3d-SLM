{
  "source_url": "https://github.com/jackhymowitz/main/blob/7325131db23094f1a28bd184b6a68f864f41a729/01_GH_Components/py/BT_OpenXLWorkbook.py",
  "repo": "jackhymowitz/main",
  "repo_stars": 0,
  "repo_description": "IDF2PH is a free open source toolkit for working with E+ and PHPP Energy Models",
  "license": "GPL-3.0",
  "filepath": "01_GH_Components/py/BT_OpenXLWorkbook.py",
  "instruction": "Enables the COM interface connecting Rhino to Excel on the user's computer.\r\r\n> This should identify a running excel instance or start excel if it is not already running.\r\r\n> Copies a file if the...",
  "code": "#\r\r\n# IDF2PHPP: A Plugin for exporting an EnergyPlus IDF file to the Passive House Planning Package (PHPP). Created by blgdtyp, llc\r\r\n# \r\r\n# This component is part of IDF2PHPP.\r\r\n# \r\r\n# Copyright (c) 2020, bldgtyp, llc <info@bldgtyp.com> \r\r\n# IDF2PHPP is free software; you can redistribute it and/or modify \r\r\n# it under the terms of the GNU General Public License as published \r\r\n# by the Free Software Foundation; either version 3 of the License, \r\r\n# or (at your option) any later version. \r\r\n# \r\r\n# IDF2PHPP is distributed in the hope that it will be useful,\r\r\n# but WITHOUT ANY WARRANTY; without even the implied warranty of \r\r\n# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the \r\r\n# GNU General Public License for more details.\r\r\n# \r\r\n# For a copy of the GNU General Public License\r\r\n# see <http://www.gnu.org/licenses/>.\r\r\n# \r\r\n# @license GPL-3.0+ <http://spdx.org/licenses/GPL-3.0+>\r\r\n#\r\r\n\"\"\"\r\r\nEnables the COM interface connecting Rhino to Excel on the user's computer.\r\r\n> This should identify a running excel instance or start excel if it is not already running.\r\r\n> Copies a file if the target file name doesn't already exist. \r\r\n> Passes the full file name out, along with whether or not a copy was made.\r\r\n-\r\r\nComponent by Jack Hymowitz, July 31, 2020\r\r\n\r\r\n    Args:\r\r\n        _run: Set to true to enable the excel application, false saves the open sheet and stops the application\r\r\n        visibl_e: Set to true to show the Excel application on the screen. Default true.\r\r\n        useUserWorkbook_: Set to true to look for and use an open excel interface instead of starting a new one. For now, should not be used (set to false or disconnected)\r\r\n        oldFilename: The full file path to the source file\r\r\n        newDirectory: The location to put the new copied file, or a blank string (\"\") if newFilename should be a relative location or if newFilename is the entire filepath.\r\r\n        newFilename: The destination name to copy the file to (can be the full path if newDirectory is a blank string)\r\r\n    Returns:\r\r\n        excel: The Excel COM interface created, or None if not running\r\r\n\"\"\"\r\r\n\r\r\nghenv.Component.Name = \"BT_OpenXLWorkbook\"\r\r\nghenv.Component.NickName = \"Open XL Workbook\"\r\r\nghenv.Component.Message = 'JUL_31_2020'\r\r\nghenv.Component.IconDisplayMode = ghenv.Component.IconDisplayMode.application\r\r\nghenv.Component.Category = \"BT\"\r\r\nghenv.Component.SubCategory = \"02 | IDF2PHPP\"\r\r\n\r\r\nfrom ghpythonlib.componentbase import executingcomponent as component\r\r\nimport Grasshopper, GhPython\r\r\nimport System\r\r\nimport Rhino\r\r\nimport rhinoscriptsyntax as rs\r\r\n\r\r\nimport scriptcontext as sc\r\r\nimport clr\r\r\nimport os\r\r\nclr.AddReferenceByName('Microsoft.Office.Interop.Excel')#, Culture=neutral, PublicKeyToken=71e9bce111e9429c')\r\r\nfrom System.Runtime.InteropServices import Marshal\r\r\nfrom Microsoft.Office.Interop import Excel\r\r\n\r\r\nfrom shutil import copyfile\r\r\nimport Grasshopper.Kernel as ghK\r\r\nimport inspect\r\r\n\r\r\n\r\r\nclass ExcelInstance:\r\r\n    \"\"\"A holder for the methods we use to interact with the Excel COM interface\"\"\"\r\r\n    \r\r\n    #Run once on startup, defines the variables that we will use\r\r\n    def __init__(self):\r\r\n        self.ex=None\r\r\n        self.activeWorkbook=None\r\r\n        self.activeWorkbookName=\"\"\r\r\n        self.sheetsDict={}\r\r\n        self.userOpened=False\r\r\n    \r\r\n    #Starts a brand new excel instance\r\r\n    def startNewInstance(self):\r\r\n        \"\"\"Start a new Excel Application instance\"\"\"\r\r\n        self.ex = Excel.ApplicationClass()\r\r\n        self.ex.DisplayAlerts = False\r\r\n        self.ex.EnableEvents = False\r\r\n        self.userOpened=False\r\r\n    \r\r\n    #Not working right now 100%, but should find an already running excel window\r\r\n    def findExistingInstance(self):\r\r\n        \"\"\"Find an Excel instance that is already running\r\r\n        Returns True if an already running instance was found, False otherwise\"\"\"\r\r\n        #try:\r\r\n        self.userOpened=True\r\r\n        self.activeWorkbookName==\"NEW_USER_FILE\"\r\r\n        self.ex=Marshal.GetActiveObject(\"Excel.Application\")\r\r\n        print(self.ex)\r\r\n        if self.ex==None:\r\r\n            return None\r\r\n        print(self.ex.Workbooks)\r\r\n        print(dir(self.ex.Workbooks))\r\r\n        print(self.ex.Workbooks.Count)\r\r\n        if(self.ex.Workbooks.Count>0):\r\r\n            for workbook in self.ex.Workbooks:\r\r\n                self.activeWorkbook=workbook\r\r\n                break\r\r\n                #there is definitely a better way of doing this\r\r\n        else:\r\r\n            return None\r\r\n        print(self.activeWorkbook==None)\r\r\n        if self.activeWorkbook==None:\r\r\n            return None\r\r\n        self.userOpened=True\r\r\n        self.activeWorkbookName=\"NEW_USER_FILE\"\r\r\n        self.loadSheets()\r\r\n        return True\r\r\n        #except:\r\r\n        #    return False\r\r\n        #Define later...\r\r\n    \r\r\n    def openWorkbook(self,filename):\r\r\n        \"\"\"Open a workbook in the running excel interface, closing the open one\r\r\n        Args:\r\r\n            filename: The workbook to open\r\r\n        \"\"\"\r\r\n        if self.activeWorkbookName==filename:\r\r\n            return False\r\r\n        self.close(True)\r\r\n        self.activeWorkbookName=filename\r\r\n        self.activeWorkbook=self.ex.Workbooks.Open(filename)\r\r\n        self.loadSheets()\r\r\n        return True\r\r\n    \r\r\n    #Finds the sheets in the open workbook\r\r\n    def loadSheets(self):\r\r\n        self.sheetsDict={}\r\r\n        for sheet in self.activeWorkbook.Worksheets:\r\r\n            self.sheetsDict[sheet.Name]=sheet\r\r\n            sheet.Unprotect()\r\r\n        \r\r\n    def saveAndQuit(self,closeIfUser):\r\r\n        \"\"\"Close the running excel instance, and save first\r\r\n        Args:\r\r\n            closeIfUser (boolean): Set to true if this method is to run even if this was a user-opened file, \r\r\n                false to run only if was an instance created here.\"\"\"\r\r\n\r\r\n        self.save()\r\r\n        self.close(closeIfUser)\r\r\n        self.quit(closeIfUser)\r\r\n        \r\r\n    def save(self):\r\r\n        try:\r\r\n            self.ex.activeWorkbook.Save()\r\r\n            return True\r\r\n        except:\r\r\n            return False\r\r\n            \r\r\n    def close(self, closeIfUser):\r\r\n        \"\"\"Close the open excel workbook\r\r\n        Args:\r\r\n            closeIfUser (boolean): Set to true if this method is to run even if this was a user-opened file, \r\r\n                false to run only if was an instance created here.\"\"\"\r\r\n        if self.activeWorkbook!=None or (not closeIfUser and self.userOpened):\r\r\n            return\r\r\n        try:\r\r\n            self.ex.activeWorkbook.Close()\r\r\n        except:\r\r\n            pass\r\r\n    def quit(self, closeIfUser):\r\r\n        \"\"\"Stop the running excel instance\r\r\n        Args:\r\r\n            closeIfUser (boolean): Set to true if this method is to run even if this was a user-opened file, \r\r\n                false to run only if was an instance created here.\"\"\"\r\r\n        self.activeWorkbook=None\r\r\n        self.activeWorkbookName=\"\"\r\r\n        if self.ex!=None:\r\r\n            self.ex.Quit()\r\r\n            ex=None\r\r\n        \r\r\n    def __unicode__(self):\r\r\n        return u\"Excel Instance | Active Worksheet: {self.activeWorkbookName}\".format(self=self)\r\r\n    def __str__(self):\r\r\n        return unicode(self).encode(\"utf-8\")\r\r\n    def __repr__(self):\r\r\n        return \"{}( _nm={!r}, _ex={!r}, _activeWorkbook={!r}, _name={!r}\".format(\r\r\n               self.__class__.__name__,\r\r\n               self.ex,\r\r\n               self.activeWorkbook,\r\r\n               self.activeWorkbookName )\r\r\n\r\r\nclass MyComponent(component):\r\r\n    \r\r\n    def StartExcel(self,useUserWorkbook):\r\r\n        if not \"excel\" in sc.sticky: #Excel interface isn't already running, so start it\r\r\n            excel = ExcelInstance()\r\r\n            if useUserWorkbook:\r\r\n                excel.findExistingInstance()    #Try looking for a running instance\r\r\n            else:\r\r\n                excel.startNewInstance()            #If didn't find one, make one\r\r\n            sc.sticky[\"excel\"]=excel\r\r\n        else:\r\r\n            excel = sc.sticky[\"excel\"]\r\r\n        return excel\r\r\n        \r\r\n    def StopExcel(self):\r\r\n        if \"excel\" in sc.sticky:\r\r\n            print(\"Quitting\")\r\r\n            excel=sc.sticky[\"excel\"]\r\r\n            try:\r\r\n                excel.saveAndQuit(False)\r\r\n            except:\r\r\n                pass\r\r\n            del sc.sticky[\"excel\"]\r\r\n    \r\r\n    def doCopy(self, oldFilename,newDirectory,newFilename):\r\r\n        \r\r\n        if not os.path.exists(newDirectory):\r\r\n            os.mkdir(newDirectory)\r\r\n        dest=newDirectory+os.path.sep+newFilename+\".xlsx\"\r\r\n        if os.path.exists(dest):\r\r\n            msg1 = \"File already copied, not overwritten\"\r\r\n            ghenv.Component.AddRuntimeMessage(ghK.GH_RuntimeMessageLevel.Remark, msg1)\r\r\n            return dest\r\r\n        try:\r\r\n            src=os.path.abspath(oldFilename)\r\r\n        except:\r\r\n            msg1 = \"Source file not found\"\r\r\n            ghenv.Component.AddRuntimeMessage(ghK.GH_RuntimeMessageLevel.Warning, msg1)\r\r\n            return None\r\r\n        try:\r\r\n            copyfile(src,dest)\r\r\n        except:\r\r\n            msg1 = \"Unable to copy file\"\r\r\n            ghenv.Component.AddRuntimeMessage(ghK.GH_RuntimeMessageLevel.Warning, msg1)\r\r\n            return dest\r\r\n        return dest\r\r\n    \r\r\n    def OpenWorkbook(self,excel,useUserWorkbookDefault,oldFilename,newDirectory,newFilename):\r\r\n        if excel:\r\r\n            \"\"\"if useUserWorkbookDefault and excel.userOpened and excel.activeWorkbookName==\"NEW_USER_FILE\": #If a sheet is already open, set it up\r\r\n                if \"XLSdata\" in sc.sticky: \r\r\n                    del sc.sticky[\"XLSdata\"]\r\r\n                excel.loadSheets()\r\r\n                excel.activeWorkbookName=\"USER_FILE\"\r\r\n            elif useUserWorkbookDefault and excel.userOpened:   #If we already set it up, we are OK\r\r\n                pass\"\"\"\r\r\n            if newFilename:\r\r\n                filename=self.doCopy(oldFilename,newDirectory,newFilename)\r\r\n                if excel.openWorkbook(filename): #If we need to open a new sheet, set it up\r\r\n                    if \"XLSdata\" in sc.sticky: \r\r\n                        del sc.sticky[\"XLSdata\"]\r\r\n                    excel.loadSheets()\r\r\n            else:\r\r\n                return False\r\r\n        else:\r\r\n            return False\r\r\n        return True\r\r\n    def RunScript(self,run,visible,useUserWorkbook,oldFilename,newDirectory,newFilename):\r\r\n        if not run:\r\r\n            self.StopExcel()\r\r\n            ghenv.Component.AddRuntimeMessage(ghK.GH_RuntimeMessageLevel.Warning, \"Excel Not Started\")\r\r\n            return None\r\r\n        excel=self.StartExcel(useUserWorkbook)\r\r\n        if excel==None:\r\r\n            return None\r\r\n        if not useUserWorkbook:\r\r\n            if visible==None:\r\r\n                visible=True\r\r\n            excel.ex.Visible = visible\r\r\n            excel.ex.ScreenUpdating = visible\r\r\n        if not excel:\r\r\n            ghenv.Component.AddRuntimeMessage(ghK.GH_RuntimeMessageLevel.Error, \"Excel Unable to Start\")\r\r\n            return None\r\r\n        if not (useUserWorkbook or oldFilename and newFilename):\r\r\n            ghenv.Component.AddRuntimeMessage(ghK.GH_RuntimeMessageLevel.Warning, \"Not running, either run is false or filename not set.\")\r\r\n            return None\r\r\n        #if useUserWorkbookDefault:\r\r\n            \r\r\n        #outputName=self.doCopy(oldFilename,newDirectory,newFilename)\r\r\n        #if not outputName and not useUserWorkbookDefault:\r\r\n        #    return (None,\"Unable to copy file.\")\r\r\n        if self.OpenWorkbook(excel,useUserWorkbook,oldFilename,newDirectory,newFilename):\r\r\n            return excel\r\r\n        ghenv.Component.AddRuntimeMessage(ghK.GH_RuntimeMessageLevel.Error, \"Unable to open workbook\")\r\r\n        return None\r\n",
  "language": "python",
  "imports": [
    "Rhino",
    "ghpythonlib",
    "rhinoscriptsyntax",
    "scriptcontext"
  ],
  "has_docstring": true
}