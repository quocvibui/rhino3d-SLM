{
  "source_url": "https://github.com/dbt-ethz/open-plans-ghpy/blob/cadac60fe7934051b09011db0d621f0479100ab4/src/SearchByShape/code.py",
  "repo": "dbt-ethz/open-plans-ghpy",
  "repo_stars": 2,
  "repo_description": "Interact with Open Plans in Rhino Grasshopper",
  "license": "unknown",
  "filepath": "src/SearchByShape/code.py",
  "instruction": "Retrieve floor plans from the Open Plans database with a geometircal search.\n    Inputs:\n        SearchShape:    Closed Polyline that represents the desired shape of retrieved floor plans.\n          ...",
  "code": "\"\"\"\nRetrieve floor plans from the Open Plans database with a geometircal search.\n    Inputs:\n        SearchShape:    Closed Polyline that represents the desired shape of retrieved floor plans.\n                        {item, polyline}\n        SearchReload:   (optional: can be None) If True the geometrical search is initiated (again).\n                        {item, bool}\n        PlanIndex:      Browse the retrieved floor plans (total of 20). Use the plan index\n                        to activate one specific floor plan to inspect further.\n                        {item, int)\n        ImportPlan:     (optional: can be None) Boolean to activate import floor plan into Rhino. If True the floor plan\n                        Bitmap and Brep surface are visible in Rhino. \n                        {item, bool}\n\n    Output:\n        ImageURL:       URL of the raster image of the retrieved floor plan from Open Plans database\n                        {item, string}\n        Polygon:        Brep of the retrieved floor plan (section) from Open Plans database\n                        {item, Brep}\n        BuildingName:   Name of the building floor plan from Open Plans database\n                        {item, string}\n        BuildingMetrics:Metrics from the retrieved building floor plan from Open Plans database\n                        {list, string}\n    \n    Remarks:\n        Author: \n        License:\n        Version: \n\"\"\"\n\n# PYTHON LIBRARY IMPORTS\nimport urllib2\nimport json\nimport os\n\n# GHPYTHON SDK IMPORTS\nfrom ghpythonlib.componentbase import executingcomponent as component\nimport Grasshopper\nimport GhPython\nimport Rhino\nimport Rhino.Geometry as rg\nimport Rhino.Display as rd\nimport scriptcontext\n\n\n\nclass SearchByShape(component):\n    \n    def __init__(self):\n        \n        self.HERE = ghenv.LocalScope.ghdoc.Path\n        self.dir_path = os.path.dirname(self.HERE)\n        self.OpenPlansURL = (\"https://open-plans.herokuapp.com/searchbyshape\")\n        self.OpenPlansData = {}\n        Rhino.RhinoDoc.AdjustModelUnitSystem(\n                       Rhino.RhinoDoc.ActiveDoc, Rhino.UnitSystem.Centimeters, False)\n        self.ValidSearchShape = False\n        self.SearchShapeIsClosed = False\n        self.imageFilePath = self.dir_path + \"/\" + 'temp_floorplan.jpeg'\n\n    def format_polygon(self, x_coords, y_coords):\n        coords = [{'x': x, 'y': y} for x, y in zip(x_coords, y_coords)]\n        return {'polygon': coords}\n\n    def getOriginalMetrics(self, json):\n        metrics = json['original_metrics']\n        metrics = [key + \": \" + value for (key, value) in metrics.iteritems()]\n        print(metrics)\n\n    def is_shape_valid(self, shape):\n        if shape.IsValid is False:\n            print(\"invalid search shape\")\n            self.ValidSearchShape = False\n        else:\n            self.ValidSearchShape = True\n\n    def is_shape_closed(self, shape):\n\n        if shape.IsClosed:\n            print(\"valid search shape\")\n            self.SearchShapeIsClosed = True\n        else:\n            print('polygon is not closed')\n            self.SearchShapeIsClosed = False\n\n    def shape_coordinates(self, shape):\n        x_coords = [x for x in shape.X]\n        # flip y coordinate to start top left as 0, 0 (image coordinate system)\n        y_coords = [y*-1 for y in shape.Y]\n        polygon = self.format_polygon(x_coords, y_coords)\n        return json.dumps(polygon)\n\n    def retrieve_image_url(self, json, index):\n        \"\"\"\n        Get all url's to retrieve floorplan images from the server\n        Returns url of input index plan\n        \"\"\"\n        if 'image_paths' not in self.OpenPlansData:\n            self.OpenPlansData['image_paths'] = [p['image_path']\n                                            for p in json['similar_plan_list']]\n        return self.OpenPlansData['image_paths'][index]\n\n\n    def retrieve_polygon(self, json, index):\n        \"\"\"\n        Get all polygon coordinates from the json response and create a boundary surface\n        Returns the polygon of input index\n        \"\"\"\n        if 'polylines' not in self.OpenPlansData:\n            polygon_coords = [p['points'] for p in json['similar_plan_list']]\n            polygon_coords = [map(self.transform_to_rhino_coords, c)\n                            for c in polygon_coords]\n            polylines = []\n            for polygon in polygon_coords:\n                polyline = rg.Polyline()\n                for pt in polygon:\n                    polyline.Add(rg.Point3d(pt[0], pt[1], 0))\n                polylines.append(polyline)\n            self.OpenPlansData['polylines'] = polylines\n        polyline = self.OpenPlansData['polylines'][index]\n        polygon = rg.Brep()\n        polylineCrv = polyline.ToPolylineCurve()\n        polygon = polygon.CreatePlanarBreps(polylineCrv)[0]\n        polygon.Scale(0.1)\n        return polygon\n\n\n    def transform_to_rhino_coords(self, coordinate):\n        \"\"\" \n        Flip y coordinate to match Rhino system\n        Starting top left as 0, 0\n\n        Returns : [ x, y ] \n        \"\"\"\n        return list([coordinate[0], coordinate[1]*-1])\n\n\n    def retrieve_building_names(self, json, index):\n        \"\"\"\n        Get all building names from similar buildings\n        Returns building name of input index\n        \"\"\"\n        if 'names' not in self.OpenPlansData:\n            self.OpenPlansData['names'] = [p['name']\n                                    for p in json['similar_plan_list']]\n        return self.OpenPlansData['names'][index]\n\n\n    def getTransform(self, plane, scale):\n        \"\"\"\n        Transforms plane by moving it down to match top left coordinate with Rhino 0, 0 (x, y) position\n        \"\"\"\n        width, height, mms_pp = scale[0], scale[1], scale[2]\n\n        # move plane down along vector\n        plane.Translate(rg.Vector3d(0, -height/mms_pp, 0))\n\n\n    def getScale(self, json, index):\n        \"\"\"\n        Get scale metrics from all floorplan images\n        Returns scale metrics of input index\n        \"\"\"\n        if 'scale' not in self.OpenPlansData:\n            self.OpenPlansData['scale'] = [\n                (p['width_mm'], p['height_mm'], p['mms_per_pixel']) for p in json['similar_plan_list']]\n        return self.OpenPlansData['scale'][index]\n\n\n    def getMetrics(self, json, index):\n        \"\"\"\n        Print all metrics from the similar polygon\n        \"\"\"\n        if 'metrics' not in self.OpenPlansData:\n            self.OpenPlansData['metrics'] = [p['metrics']\n                                        for p in json['similar_plan_list']]\n\n        metrics = [key + \": \" + value for (key, value)\n                in self.OpenPlansData['metrics'][index].iteritems()]\n        return metrics\n\n\n    def import_plan2rhino(self, img_url, scale):\n        \"\"\"\n        This function loads the floorplan image from the server through the input url.\n        And sets the image as a background bitmap in Rhino\n        \"\"\"\n\n        # read url\n        response = urllib2.urlopen(img_url)\n        output = open(self.imageFilePath, \"wb\")\n        output.write(response.read())\n        output.close()\n\n        # Rhino Bitmap\n        bitmap = rd.DisplayBitmap.Load(img_url)\n\n        # get active view\n        view = scriptcontext.doc.Views.ActiveView\n        plane = view.ActiveViewport.ConstructionPlane()\n        # transform plane to flip image coordinate system\n        self.getTransform(plane, scale)\n        # load image into Rhino view\n        view.ActiveViewport.SetTraceImage(\n            self.imageFilePath, plane, bitmap.Size.Width, bitmap.Size.Height, True, False)\n        view.Redraw()\n\n\n    def RunScript(self, SearchShape, SearchReload, PlanIndex, ImportPlan=True):\n\n        self.is_shape_valid(SearchShape)\n        self.is_shape_closed(SearchShape)\n\n        req = urllib2.Request(self.OpenPlansURL, self.shape_coordinates(SearchShape), headers={'Content-Type': 'application/json'})\n        try:\n            response = urllib2.urlopen(req)\n        except urllib2.HTTPError, e:\n            print(e)\n\n        resp = response.read()\n\n        # from string to JSON\n        self.OpenPlansData['response'] = json.loads(resp)\n\n        # print input search shape metrics\n        self.getOriginalMetrics(self.OpenPlansData['response'])\n\n        ImageURL = self.retrieve_image_url(self.OpenPlansData['response'], PlanIndex)\n        BuildingName = self.retrieve_building_names(self.OpenPlansData['response'], PlanIndex)\n        BuildingMetrics = self.getMetrics(self.OpenPlansData['response'], PlanIndex)\n\n\n        if ImportPlan is False:\n            scriptcontext.doc.Views.ActiveView.ActiveViewport.ClearTraceImage()\n            try:\n                os.remove(self.imageFilePath)\n            except OSError, e:\n                print(e)\n        else:\n            scale = self.getScale(self.OpenPlansData['response'], PlanIndex)\n            self.import_plan2rhino(ImageURL, scale)\n            Polygon = self.retrieve_polygon(self.OpenPlansData['response'], PlanIndex)\n        \n        return ImageURL, Polygon, BuildingName, BuildingMetrics",
  "language": "python",
  "imports": [
    "Rhino",
    "Rhino.Geometry",
    "ghpythonlib",
    "scriptcontext"
  ],
  "has_docstring": true
}