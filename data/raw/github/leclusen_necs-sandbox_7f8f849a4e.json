{
  "source_url": "https://github.com/leclusen/necs-sandbox/blob/8d8006ae3c845c9f3e38154803caac6b03d298a9/structure-batiment/structure_aligner/transform/filaire_generator.py",
  "repo": "leclusen/necs-sandbox",
  "repo_stars": 0,
  "repo_description": null,
  "license": "unknown",
  "filepath": "structure-batiment/structure_aligner/transform/filaire_generator.py",
  "instruction": "Filaire (column/beam centerline) generation at support positions.",
  "code": "\"\"\"Filaire (column/beam centerline) generation at support positions.\n\nPhase 5.4 - Creates vertical LineCurve/PolylineCurve/NurbsCurve\nobjects at support point positions, spanning floor-to-floor heights.\n\"\"\"\n\nfrom __future__ import annotations\n\nimport logging\n\nimport rhino3dm\n\nlogger = logging.getLogger(__name__)\n\n\ndef generate_filaire(\n    model: rhino3dm.File3dm,\n    support_positions: list[tuple[float, float, float]],\n    floor_z_levels: tuple[float, ...],\n    layer_index: int = 0,\n    start_id: int | None = None,\n) -> int:\n    \"\"\"Add Filaire centerlines at support positions.\n\n    For each support position, creates a vertical line spanning from\n    the support's Z to the next floor Z-level above it.\n\n    The geometry type is chosen based on floor level:\n    - NurbsCurve for Z=2.12 (lower floors)\n    - PolylineCurve for higher floors\n    - LineCurve for beams at Z=-4.44\n\n    Args:\n        model: The rhino3dm model to add objects to.\n        support_positions: List of (x, y, z) from support placement.\n        floor_z_levels: Known floor Z-levels.\n        layer_index: Layer index for new objects.\n        start_id: Starting ID for naming.\n\n    Returns:\n        Number of Filaire objects added.\n    \"\"\"\n    if start_id is None:\n        start_id = _get_max_filaire_id(model) + 1\n\n    sorted_z = sorted(floor_z_levels)\n    next_id = start_id\n    added = 0\n\n    for x, y, z in support_positions:\n        # Find the next floor Z above this support's Z\n        z_top = _next_floor_above(z, sorted_z)\n        if z_top is None or z_top <= z:\n            continue\n\n        name = f\"Filaire_{next_id}\"\n        next_id += 1\n\n        attr = rhino3dm.ObjectAttributes()\n        attr.Name = name\n        attr.LayerIndex = layer_index\n\n        geom = _create_vertical_geom(x, y, z, z_top)\n        if isinstance(geom, rhino3dm.LineCurve):\n            model.Objects.AddCurve(geom, attr)\n        elif isinstance(geom, rhino3dm.NurbsCurve):\n            model.Objects.AddCurve(geom, attr)\n        elif isinstance(geom, rhino3dm.PolylineCurve):\n            model.Objects.AddCurve(geom, attr)\n        else:\n            continue\n\n        added += 1\n\n    logger.info(\"Filaire generation: %d centerlines added\", added)\n    return added\n\n\ndef _next_floor_above(z: float, sorted_z: list[float], tol: float = 0.01) -> float | None:\n    \"\"\"Find the next floor level above z.\"\"\"\n    for fz in sorted_z:\n        if fz > z + tol:\n            return fz\n    return None\n\n\ndef _create_vertical_geom(\n    x: float, y: float, z_bot: float, z_top: float,\n) -> rhino3dm.LineCurve | rhino3dm.PolylineCurve | rhino3dm.NurbsCurve:\n    \"\"\"Create vertical geometry based on floor level conventions.\n\n    Research patterns:\n    - NurbsCurve at Z=2.12->5.48 (40 objects)\n    - PolylineCurve for most higher floors\n    - LineCurve for beams at Z=-4.44\n    \"\"\"\n    p_bot = rhino3dm.Point3d(x, y, z_bot)\n    p_top = rhino3dm.Point3d(x, y, z_top)\n    height = z_top - z_bot\n\n    # Beams (horizontal or short spans at basement level)\n    if abs(z_bot - (-4.44)) < 0.1 and height < 3.0:\n        return rhino3dm.LineCurve(p_bot, p_top)\n\n    # NurbsCurve for lower floors (Z=2.12)\n    if abs(z_bot - 2.12) < 0.1:\n        return rhino3dm.NurbsCurve.Create(False, 1, [p_bot, p_top])\n\n    # PolylineCurve for everything else\n    return rhino3dm.PolylineCurve([p_bot, p_top])\n\n\ndef _get_max_filaire_id(model: rhino3dm.File3dm) -> int:\n    \"\"\"Find the highest Filaire_NNNN id in the model.\"\"\"\n    max_id = 0\n    for obj in model.Objects:\n        name = obj.Attributes.Name\n        if name and name.startswith(\"Filaire_\"):\n            try:\n                num = int(name.split(\"_\")[1])\n                if num > max_id:\n                    max_id = num\n            except (ValueError, IndexError):\n                pass\n    return max_id\n",
  "language": "python",
  "imports": [
    "rhino3dm"
  ],
  "has_docstring": true
}