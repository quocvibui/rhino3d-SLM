{
  "source_url": "https://github.com/SaraAboebeid/ecom-toolkit/blob/8e3a568c6be84283ecb5330ad1afe658739445f2/ECOMToolkit/entities/charge_point.py",
  "repo": "SaraAboebeid/ecom-toolkit",
  "repo_stars": 0,
  "repo_description": null,
  "license": "MIT",
  "filepath": "ECOMToolkit/entities/charge_point.py",
  "instruction": "Charge point",
  "code": "import Rhino.Geometry as rg\n\n# Valid owner constants\nAKADEMISKA_HUS = \"Akademiska Hus\"\nSTUDENTBOSTADER = \"StudentbostÃ¤der\"\nCHALMERSFASTIGHETER = \"Chalmersfastigheter\"\n\nclass ChargePoint:\n    \"\"\"An EV Charge Point object for Grasshopper use (ECOM4Future).\"\"\"\n\n    VALID_OWNERS = [AKADEMISKA_HUS, STUDENTBOSTADER, CHALMERSFASTIGHETER]\n\n    def __init__(self, name, point, capacity, charger_type, is_v2g, owner, ev_list=None):\n        self.name = str(name)\n        self.point = point if isinstance(point, rg.Point3d) else None\n        self.capacity = float(capacity)  # kW\n        self.charger_type = str(charger_type)\n        self.is_v2g = bool(is_v2g)\n        self.owner = self._validate_owner(owner)\n        self.ev_list = ev_list if isinstance(ev_list, list) else ([ev_list] if ev_list else [])\n\n        # Derived properties\n        self.total_connected_evs = len(self.ev_list)\n        self.v2g_enabled_evs = sum(1 for ev in self.ev_list if getattr(ev, \"v2g_enabled\", False))\n\n        # Calculate hourly demand from connected EV (only one allowed)\n        # This logic computes the charge point's hourly energy demand based on the EV's schedule and charging needs.\n        # - If an EV is connected and V2G is enabled, it can charge up to 120% of its daily energy requirement.\n        # - If V2G is not enabled, it can charge up to 100% of its daily energy requirement.\n        # - Charging is distributed over the hours when the EV is available (schedule == 1),\n        #   but never exceeds the charge point's or EV's max charging power per hour.\n        # - Charging stops for the day once the daily max is reached.\n        # - If no EV is connected, or daily requirement is zero, demand is zero for all hours.\n        from ECOMToolkit.analysis.data import HourlyData, DataCategory, DataUnit\n        import numpy as np\n        import pandas as pd\n        hoys_full = pd.Series(range(1, 8761))\n        hourly_demand_arr = np.zeros(8760)\n        if self.ev_list and len(self.ev_list) == 1:\n            ev = self.ev_list[0]\n            # Get EV schedule (HourlyData, 8760 binary values)\n            schedule = ev.schedule.df['value'].values.astype(int)\n            # Use the lower of charge point capacity and EV max charging power\n            max_power = min(self.capacity, getattr(ev, \"max_charging_power\", self.capacity))\n            # Daily energy requirement (kWh)\n            daily_req = getattr(ev, \"daily_energy_demand\", 0)\n            # Set daily max: 120% if V2G enabled, else 100%\n            if getattr(ev, \"v2g_enabled\", False):\n                daily_max = 1.2 * daily_req if daily_req else 0\n            else:\n                daily_max = daily_req if daily_req else 0\n            # Loop over each day of the year (365 days)\n            for day in range(365):\n                start = day * 24\n                end = start + 24\n                # Get schedule for the current day (24 hours)\n                sched_day = schedule[start:end]\n                # Count how many hours the EV is available for charging\n                hours_on = np.sum(sched_day)\n                if hours_on > 0 and daily_max > 0:\n                    # Distribute daily_max over scheduled hours, but not exceeding max_power per hour\n                    per_hour = min(max_power, daily_max / hours_on)\n                    charged = 0  # Track cumulative energy charged for the day\n                    for i in range(24):\n                        idx = start + i\n                        # If EV is available and daily max not yet reached\n                        if sched_day[i] and charged < daily_max:\n                            # Charge either per_hour or remaining needed to reach daily_max\n                            charge = min(per_hour, daily_max - charged)\n                            hourly_demand_arr[idx] = charge\n                            charged += charge\n                        else:\n                            # Not available or already reached daily max\n                            hourly_demand_arr[idx] = 0\n                else:\n                    # No available hours or no daily requirement: no charging for this day\n                    hourly_demand_arr[start:end] = 0\n        # Create HourlyData object for charge point demand (kWh per hour)\n        df_hourly = pd.DataFrame({'hoy': hoys_full, 'value': hourly_demand_arr})\n        self.hourlydemand = HourlyData(\n            df_hourly,\n            meta={'type': 'charge_point_demand'},\n            title=f'Charge Point Hourly Demand ({self.name})',\n            source='ChargePoint Entity',\n            units=DataUnit.KILOWATT_HOUR,\n            category=DataCategory.ENERGY\n        )\n\n    def _validate_owner(self, owner):\n        if owner not in self.VALID_OWNERS:\n            raise ValueError(f\"Invalid owner '{owner}'. Must be one of: {self.VALID_OWNERS}\")\n        return owner\n\n    def validate(self):\n        if not self.name:\n            return \"Error: Charge Point name is missing.\"\n        if not self.point:\n            return \"Error: Valid Rhino Point3d required.\"\n        if self.capacity <= 0:\n            return \"Error: Charger capacity must be greater than 0 kW.\"\n        return \"Charge Point '{}' is valid ({} kW, {} EVs connected, Owner: {}).\".format(\n            self.name, self.capacity, self.total_connected_evs, self.owner)\n\n    def __repr__(self):\n        return (\"Charge Point: {}\\n\"\n                \"Location: {}\\n\"\n                \"Capacity: {:.1f} kW | Type: {} | V2G: {}\\n\"\n                \"Owner: {}\\n\"\n                \"Connected EVs: {} ({} V2G-enabled)\"\n                .format(\n                    self.name,\n                    (self.point.X, self.point.Y, self.point.Z) if self.point else \"N/A\",\n                    self.capacity,\n                    self.charger_type,\n                    self.is_v2g,\n                    self.owner,\n                    self.total_connected_evs,\n                    self.v2g_enabled_evs\n                ))\n",
  "language": "python",
  "imports": [
    "Rhino",
    "Rhino.Geometry"
  ],
  "has_docstring": false
}