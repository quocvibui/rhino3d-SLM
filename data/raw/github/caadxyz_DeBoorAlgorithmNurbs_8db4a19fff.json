{
  "source_url": "https://github.com/caadxyz/DeBoorAlgorithmNurbs/blob/683f93a9c430eaecd45684521ebdc4561181de9b/src/DeBoorAlgorithmNurbs.py",
  "repo": "caadxyz/DeBoorAlgorithmNurbs",
  "repo_stars": 53,
  "repo_description": "De Boor's Algorithm for NURBS Curve",
  "license": "LGPL-3.0",
  "filepath": "src/DeBoorAlgorithmNurbs.py",
  "instruction": "coding=utf-8 DeBoorAlgorithmNurbs.py Copyright (c) 2020.4 mahaidong Supported by ikuku.cn & caad.xyz See License in the root of this repository for details.",
  "code": "#coding=utf-8\r\n################################################################################\r\n# DeBoorAlgorithmNurbs.py\r\n# Copyright (c) 2020.4 mahaidong\r\n# Supported by ikuku.cn & caad.xyz \r\n# See License in the root of this repository for details.\r\n################################################################################\r\nimport rhinoscriptsyntax as rs\r\nimport Rhino\r\nfrom System.Drawing import Color\r\nimport ghpythonlib.treehelpers as th\r\n\r\nimport os\r\nimport sys\r\nsys.path.append( os.path.dirname( ghenv.Component.OnPingDocument().FilePath ) )\r\nfrom textGoo import TextGoo\r\nfrom lineGoo import LineGoo\r\n\r\n# debug\r\nimport textGoo\r\nimport lineGoo\r\nreload(textGoo)\r\nreload(lineGoo)\r\n\r\nclass DeBoorAlgorithmNurbs(object):\r\n    def __init__( self,degree, pts,weights,knots,isPeriodic, isRational):\r\n        self.degree = degree\r\n        self.pts = pts\r\n        self.weights = weights\r\n        self.knots = knots\r\n        self.isPeriodic = isPeriodic\r\n        self.isRational = isRational\r\n\r\n    def findKnotIndexByU(self, u):\r\n        s = 0\r\n        index = 0 \r\n        if u<self.knots[0] or u>self.knots[-1]:\r\n            return\r\n        for i in range(len(self.knots)):\r\n            if self.knots[i]>u:\r\n                if s==0 :\r\n                    return s,i-1\r\n            elif self.knots[i] == u:\r\n                index = i\r\n                s += 1\r\n        if s>0:\r\n            return s,index\r\n\r\n    def getKnotValue(self,i):\r\n        if self.isPeriodic == True:\r\n            if i>=len(self.knots):\r\n                return self.knots[-1]+( self.knots[i+1-len(self.knots)]-self.knots[0] )\r\n            elif i<0:\r\n                return self.knots[0]-( self.knots[-1]-self.knots[len(self.knots)+i-1] )\r\n        return self.knots[i]\r\n\r\n    def calculateNurbsPoint(self,u, haveLines=0):\r\n        \"\"\"\r\n        parameters:\r\n            havelines: 0=nolines, 1=drawLines\r\n        \"\"\"\r\n        p = self.degree\r\n        s,k = self.findKnotIndexByU(u)\r\n        h = p-s\r\n        pt = {}\r\n        ptsGoo=[]\r\n\r\n        # initialize pt[i][0] for starting calculation\r\n        for i in range(k-p+1,k-s+2):\r\n            pt[i]={}\r\n            if i < len(self.pts):\r\n                j = i\r\n            else:\r\n                j = i-len(self.pts)\r\n\r\n            if self.isRational:\r\n                x = self.pts[j].X*self.weights[j]\r\n                y = self.pts[j].Y*self.weights[j]\r\n                z = self.pts[j].Z*self.weights[j]\r\n                w = weights[j]\r\n            else:\r\n                x = self.pts[j].X\r\n                y = self.pts[j].Y\r\n                z = self.pts[j].Z\r\n                w = 1\r\n            pt[i][0] = Rhino.Geometry.Point4d(x,y,z,w)\r\n            if haveLines==1:\r\n\r\n                plane = Rhino.Geometry.Plane(self.pts[j], Rhino.Geometry.Vector3d(0,0,1))\r\n                text3d = TextGoo( Rhino.Display.Text3d( \"P\"+str(i), plane, 3 ))\r\n                hslColor = Rhino.Display.ColorHSL(0,1,0.5)\r\n                text3d.SetColor(hslColor.ToArgbColor())\r\n                ptsGoo.append(text3d)\r\n\r\n        def calculatePoint4d( p0, factor0,p1,factor1 ):\r\n            return Rhino.Geometry.Point4d(\r\n                p0.X*factor0+p1.X*factor1,\r\n                p0.Y*factor0+p1.Y*factor1,\r\n                p0.Z*factor0+p1.Z*factor1,\r\n                p0.W*factor0+p1.W*factor1)\r\n\r\n        # starting calculation\r\n        a = {}\r\n        lines = []\r\n        for r in range (1,h+1):\r\n            lines.append([])\r\n            for i in range(k-p+r+1,k-s+2) :\r\n                a[i]={}\r\n                Vai_1  = self.getKnotValue( i-1 )\r\n                Vaip_r = self.getKnotValue( i+p-r )\r\n                a[i][r] = (u-Vai_1)/( Vaip_r-Vai_1)\r\n                pt[i][r] = calculatePoint4d( pt[i-1][r-1],(1-a[i][r]),pt[i][r-1],a[i][r] )\r\n                if haveLines == 1:\r\n                    line = Rhino.Geometry.Line(\r\n                        Rhino.Geometry.Point3d(pt[i-1][r-1]),\r\n                        Rhino.Geometry.Point3d(pt[i][r-1]) )\r\n                    lineGoo = LineGoo(line)\r\n                    hslColor = Rhino.Display.ColorHSL((r-1)/(h+1),1,0.5)\r\n                    lineGoo.SetColor(hslColor.ToArgbColor())\r\n                    lines[r-1].append(lineGoo)\r\n                    \r\n        return Rhino.Geometry.Point3d(pt[k-s+1][p-s]), ptsGoo, lines\r\n\r\n    # draw curves and lines\r\n    def drawNurbsCurvePts(self,nums,u):\r\n        pts = []\r\n        for f in rs.frange( self.knots[0],self.knots[-1],(self.knots[-1]-self.knots[0])/float(nums) ):\r\n            if f<u:\r\n                pt, _, _ = nurbs.calculateNurbsPoint(f)\r\n                pts.append(pt)\r\n        pointAtU, ptsGoo, deBoorlines = nurbs.calculateNurbsPoint(u,1)\r\n        return pts,pointAtU, ptsGoo, deBoorlines\r\n\r\n\r\n### main ###\r\nnurbs = DeBoorAlgorithmNurbs(degree, points, weights, knots, isPeriodic, isRational)\r\ncurvePoints, pointAtU, deBoorPts, colorlines= nurbs.drawNurbsCurvePts(80,u)\r\ndeBoorlines = th.list_to_tree( colorlines, source=[0,0])\r\n\r\n",
  "language": "python",
  "imports": [
    "Rhino",
    "Rhino.Geometry",
    "ghpythonlib",
    "rhinoscriptsyntax"
  ],
  "has_docstring": true
}