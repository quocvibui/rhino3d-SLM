{
  "source_url": "https://github.com/McMuff86/RhinoLeaderTool/blob/880966d9ae5c50786ba91882e3ffffcddcc64e1d/leader_usertext_dynamic.py",
  "repo": "McMuff86/RhinoLeaderTool",
  "repo_stars": 0,
  "repo_description": null,
  "license": "unknown",
  "filepath": "leader_usertext_dynamic.py",
  "instruction": "Leader usertext dynamic",
  "code": "#! python 3\n# -*- coding: utf-8 -*-\nimport rhinoscriptsyntax as rs\nimport Rhino\nimport Rhino.FileIO as FileIO\nimport Rhino.UI\nimport scriptcontext as sc\nimport os\nimport csv\nimport sys\nimport json\n\ndef read_csv_attributes(path):\n    attributes = {}\n    try:\n        with open(path, mode=\"r\", encoding=\"utf-8\") as file:\n            reader = csv.reader(file)\n            for row in reader:\n                if len(row) == 2:\n                    key, value = row\n                    attributes[key.strip()] = value.strip()\n    except Exception as e:\n        print(\"Fehler beim Lesen der CSV:\", e)\n    return attributes\n\ndef get_dimstyle_id(name):\n    dimstyle = sc.doc.DimStyles.FindName(name)\n    if dimstyle:\n        return dimstyle.Id\n    else:\n        print(f\"Bemaßungsstil '{name}' nicht gefunden.\")\n        return None\n\ndef get_base_path():\n    user_dir = os.path.expanduser(\"~\")\n    return os.path.join(user_dir, \"source\", \"repos\", \"work\", \"library\", \"RhinoLeaderTool\")\n\ndef get_selected_csv_folder(cfg, prompt_if_missing=True):\n    try:\n        section = \"RhinoLeaderToolGlobals\"\n        key = \"CsvFolder\"\n        selected = None\n        try:\n            selected = rs.GetDocumentData(section, key)\n        except Exception:\n            selected = None\n        if selected and os.path.isdir(selected):\n            return selected\n        if not prompt_if_missing:\n            return None\n        try:\n            start_dir = (cfg.get(\"base_path\") or get_base_path())\n        except Exception:\n            start_dir = get_base_path()\n        try:\n            folder = rs.BrowseForFolder(folder=start_dir, message=\"Select CSV folder for this document\")\n        except Exception:\n            folder = None\n        if folder and os.path.isdir(folder):\n            try:\n                rs.SetDocumentData(section, key, folder)\n            except Exception:\n                pass\n            return folder\n    except Exception:\n        pass\n    return None\n\ndef find_csv_in_tree(base_dir, csv_name, prompt_user=False, typ=None):\n    try:\n        if not base_dir or not os.path.isdir(base_dir) or not csv_name:\n            return None\n        # previously selected mapping\n        try:\n            section = \"RhinoLeaderToolCsvMap\"\n            map_key = f\"{typ}:{csv_name}\" if typ else csv_name\n            mapped = rs.GetDocumentData(section, map_key)\n            if mapped and os.path.isfile(mapped):\n                return mapped\n        except Exception:\n            pass\n        direct = os.path.join(base_dir, csv_name)\n        if os.path.isfile(direct):\n            return direct\n        matches = []\n        target = os.path.basename(csv_name)\n        for root, _dirs, files in os.walk(base_dir):\n            for fn in files:\n                if fn.lower() == target.lower():\n                    matches.append(os.path.join(root, fn))\n        if not matches:\n            return direct\n        if len(matches) == 1:\n            chosen = matches[0]\n        else:\n            rels = [(m, os.path.relpath(m, base_dir)) for m in matches]\n            rels.sort(key=lambda x: (len(x[1]), x[1].lower()))\n            chosen = rels[0][0]\n            if prompt_user:\n                try:\n                    options = [os.path.relpath(m, base_dir) for m in matches]\n                    default_opt = os.path.relpath(chosen, base_dir)\n                    sel = rs.ListBox(options, message=f\"Multiple CSV matches for {csv_name}. Choose one:\", title=\"Select CSV\", default=default_opt)\n                    if sel and sel in options:\n                        chosen = os.path.join(base_dir, sel)\n                except Exception:\n                    pass\n        try:\n            section = \"RhinoLeaderToolCsvMap\"\n            map_key = f\"{typ}:{csv_name}\" if typ else csv_name\n            rs.SetDocumentData(section, map_key, chosen)\n        except Exception:\n            pass\n        return chosen\n    except Exception:\n        return None\n\ndef load_config():\n    try:\n        script_dir = os.path.dirname(__file__)\n    except Exception:\n        script_dir = os.getcwd()\n    local_cfg = os.path.join(script_dir, \"config.json\")\n    base_path = get_base_path()\n    config_path = os.path.join(base_path, \"config.json\")\n    default_cfg = {\n        \"template_path\": \"LeaderAnnotationTemplate.3dm\",\n        \"types\": {\n            \"rahmentuere\": {\"dimstyle\": \"Standard 1:10 Rahmenbeschriftung\", \"csv\": \"rahmentuere.csv\"},\n            \"zargentuere\": {\"dimstyle\": \"Standard 1:10 Zargenbeschriftung\", \"csv\": \"zargentuere.csv\"},\n            \"schiebetuere\": {\"dimstyle\": \"Standard 1:10 Schiebetürbeschriftung\", \"csv\": \"schiebetuere.csv\"},\n            \"rahmentuere_w\": {\"dimstyle\": \"Standard 1:10 Rahmenbeschriftung WHG Eingang\", \"csv\": \"rahmentuerew.csv\"},\n            \"spez\": {\"dimstyle\": \"Standard 1:10 Spez.Rahmenbeschriftung\", \"csv\": \"spez.csv\"}\n        },\n        \"aliases\": {}\n    }\n    try:\n        cfg_to_use = local_cfg if os.path.isfile(local_cfg) else (config_path if os.path.isfile(config_path) else None)\n        if cfg_to_use:\n            with open(cfg_to_use, \"r\", encoding=\"utf-8\") as f:\n                file_cfg = json.load(f)\n            for k, v in file_cfg.items():\n                default_cfg[k] = v\n    except Exception as e:\n        print(\"Konnte config.json nicht laden (verwende Defaults):\", e)\n    return default_cfg\n\ndef apply_usertext_overrides(cfg, data):\n    try:\n        overrides = (cfg.get(\"defaults\", {}) or {}).get(\"usertext_overrides\", {}) or {}\n        na_value = (cfg.get(\"export\", {}) or {}).get(\"na_value\", \"NA\")\n        for k, v in overrides.items():\n            current = data.get(k)\n            if current is None or str(current).strip() == \"\" or str(current).strip().upper() == str(na_value).upper():\n                data[k] = v\n    except Exception:\n        pass\n\ndef get_na_value(cfg):\n    try:\n        return (cfg.get(\"export\", {}) or {}).get(\"na_value\", \"NA\")\n    except Exception:\n        return \"NA\"\n\ndef load_saved_globals(cfg):\n    saved = {}\n    try:\n        section = \"RhinoLeaderToolGlobals\"\n        prompt_keys = (cfg.get(\"defaults\", {}) or {}).get(\"prompt_keys\", [])\n        for k in prompt_keys:\n            try:\n                v = rs.GetDocumentData(section, k)\n                if v is not None:\n                    saved[k] = v\n            except Exception:\n                pass\n    except Exception:\n        pass\n    return saved\n\ndef save_globals(cfg, data):\n    try:\n        section = \"RhinoLeaderToolGlobals\"\n        for k, v in (data or {}).items():\n            try:\n                rs.SetDocumentData(section, k, str(v) if v is not None else \"\")\n            except Exception:\n                pass\n    except Exception:\n        pass\n\ndef prefill_data_with_saved_globals(cfg, data):\n    try:\n        saved = load_saved_globals(cfg)\n        for k, v in saved.items():\n            data[k] = v\n    except Exception:\n        pass\n\ndef merge_globals_into_data(cfg, data, globals_dict):\n    try:\n        na = get_na_value(cfg)\n        for k, v in (globals_dict or {}).items():\n            cur = data.get(k)\n            if cur is None or str(cur).strip() == \"\" or str(cur).strip().upper() == str(na).upper():\n                data[k] = v\n    except Exception:\n        pass\n\ndef maybe_prompt_for_globals(cfg, data):\n    try:\n        defaults_cfg = cfg.get(\"defaults\", {}) or {}\n        always_prompt = bool(defaults_cfg.get(\"always_prompt\", False))\n        prompt_on_first = bool(defaults_cfg.get(\"prompt_on_first_leader\", False))\n        if not (always_prompt or prompt_on_first):\n            return\n        # Prüfen, ob bereits ein Leader vorhanden ist\n        any_leader = False\n        for obj in sc.doc.Objects:\n            try:\n                if isinstance(obj.Geometry, Rhino.Geometry.Leader):\n                    any_leader = True\n                    break\n            except Exception:\n                continue\n        if (any_leader and not always_prompt) and prompt_on_first:\n            return\n        # Keys per Eto-Dialog abfragen, mit Fallback auf GetString\n        prompt_keys = defaults_cfg.get(\"prompt_keys\") or []\n        na_value = get_na_value(cfg)\n        prefill_data_with_saved_globals(cfg, data)\n        try:\n            import Eto.Forms as forms\n            import Eto.Drawing as drawing\n\n            dialog = forms.Dialog()\n            dialog.Title = \"Globale Werte setzen\"\n\n            layout = forms.DynamicLayout()\n            layout.Spacing = drawing.Size(6, 6)\n            layout.Padding = drawing.Padding(10)\n\n            textboxes = {}\n            for key in prompt_keys:\n                lbl = forms.Label()\n                lbl.Text = key\n                tb = forms.TextBox()\n                tb.Text = str(data.get(key, na_value))\n                textboxes[key] = tb\n                layout.AddRow(lbl, tb)\n\n            ok_btn = forms.Button()\n            ok_btn.Text = \"OK\"\n            cancel_btn = forms.Button()\n            cancel_btn.Text = \"Abbrechen\"\n            layout.AddSeparateRow(None, ok_btn, cancel_btn)\n\n            def on_ok(sender, e):\n                dialog.Tag = True\n                dialog.Close()\n\n            def on_cancel(sender, e):\n                dialog.Tag = False\n                dialog.Close()\n\n            ok_btn.Click += on_ok\n            cancel_btn.Click += on_cancel\n\n            dialog.Content = layout\n            dialog.Tag = False\n            try:\n                Rhino.UI.EtoExtensions.ShowSemiModal(dialog, sc.doc, Rhino.UI.RhinoEtoApp.MainWindow)\n            except Exception as semimodal_ex:\n                print(\"Hinweis: EtoExtensions.ShowSemiModal fehlgeschlagen:\", semimodal_ex)\n                dialog.ShowModal(Rhino.UI.RhinoEtoApp.MainWindow)\n\n            if dialog.Tag:\n                for key, tb in textboxes.items():\n                    val = (tb.Text or \"\").strip()\n                    if val != \"\":\n                        data[key] = val\n            save_globals(cfg, {k: data.get(k, na_value) for k in prompt_keys})\n            return\n        except Exception as eto_ex:\n            print(\"Eto-Dialog nicht verfügbar, verwende GetString-Fallback. Grund:\", eto_ex)\n            for k in prompt_keys:\n                existing = data.get(k, na_value)\n                try:\n                    val = rs.GetString(f\"Set value for {k} (Enter=keep)\", str(existing))\n                    if val is not None and val != \"\":\n                        data[k] = val\n                except Exception as gs_ex:\n                    print(\"GetString fehlgeschlagen für\", k, \"Grund:\", gs_ex)\n            save_globals(cfg, {k: data.get(k, na_value) for k in prompt_keys})\n    except Exception:\n        pass\n\ndef maybe_prompt_for_type_specific(cfg, typ, data):\n    try:\n        defaults_cfg = cfg.get(\"defaults\", {}) or {}\n        keys = list(defaults_cfg.get(\"type_specific_keys\") or [])\n        if not keys:\n            return\n        na_value = get_na_value(cfg)\n        section = f\"RhinoLeaderToolType:{typ}\"\n        missing = []\n        for k in keys:\n            cur = data.get(k, na_value)\n            if cur is None or str(cur).strip() == \"\" or str(cur).strip().upper() == str(na_value).upper():\n                saved = rs.GetDocumentData(section, k)\n                if saved is not None and saved.strip() != \"\":\n                    data[k] = saved\n                else:\n                    missing.append(k)\n        if not missing:\n            return\n        try:\n            import Eto.Forms as forms\n            import Eto.Drawing as drawing\n            dialog = forms.Dialog(); dialog.Title = f\"{typ}: Werte setzen\"\n            layout = forms.DynamicLayout(); layout.Spacing = drawing.Size(6, 6); layout.Padding = drawing.Padding(10)\n            textboxes = {}\n            for key in missing:\n                lbl = forms.Label(); lbl.Text = key\n                tb = forms.TextBox(); tb.Text = str(data.get(key, na_value))\n                textboxes[key] = tb; layout.AddRow(lbl, tb)\n            ok_btn = forms.Button(); ok_btn.Text = \"OK\"\n            cancel_btn = forms.Button(); cancel_btn.Text = \"Abbrechen\"\n            layout.AddSeparateRow(None, ok_btn, cancel_btn)\n            def on_ok(sender, e): dialog.Tag = True; dialog.Close()\n            def on_cancel(sender, e): dialog.Tag = False; dialog.Close()\n            ok_btn.Click += on_ok; cancel_btn.Click += on_cancel\n            dialog.Content = layout; dialog.Tag = False\n            try:\n                Rhino.UI.EtoExtensions.ShowSemiModal(dialog, sc.doc, Rhino.UI.RhinoEtoApp.MainWindow)\n            except Exception as semimodal_ex:\n                print(\"Hinweis: SemiModal fehlgeschlagen:\", semimodal_ex)\n                dialog.ShowModal(Rhino.UI.RhinoEtoApp.MainWindow)\n            if dialog.Tag:\n                for key, tb in textboxes.items():\n                    val = (tb.Text or \"\").strip()\n                    if val != \"\":\n                        data[key] = val\n                        rs.SetDocumentData(section, key, val)\n            return\n        except Exception as eto_ex:\n            print(\"Eto-Dialog nicht verfügbar (type-specific), Fallback:\", eto_ex)\n            for k in missing:\n                existing = data.get(k, na_value)\n                try:\n                    val = rs.GetString(f\"{typ} – {k}\", str(existing))\n                    if val is not None and val != \"\":\n                        data[k] = val\n                        rs.SetDocumentData(section, k, val)\n                except Exception as gs_ex:\n                    print(\"GetString fehlgeschlagen für\", k, \"Grund:\", gs_ex)\n    except Exception:\n        pass\n\ndef import_dimstyles_from_template(template_path):\n    try:\n        if os.path.isfile(template_path):\n            model = FileIO.File3dm.Read(template_path)\n            if model is None:\n                raise Exception(\"Template konnte nicht gelesen werden.\")\n            imported_count = 0\n            for ds in model.DimStyles:\n                if sc.doc.DimStyles.FindName(ds.Name) is None:\n                    dup = ds.Duplicate()\n                    index = sc.doc.DimStyles.Add(dup)\n                    if index is not None and index >= 0:\n                        imported_count += 1\n            if imported_count > 0:\n                print(f\"{imported_count} DimStyles aus Template importiert.\")\n            return True\n    except Exception as e:\n        print(\"Fehler beim Import der DimStyles aus Template:\", e)\n    return False\n\ndef create_leader_with_style(dimstyle_id):\n    rs.Command(\"_Leader _Pause _Pause _Pause _Enter\", echo=False)\n    objs = rs.LastCreatedObjects()\n    if not objs:\n        print(\"Kein Leader erstellt.\")\n        return None\n\n    for obj in objs:\n        if rs.ObjectType(obj) == 512:\n            rhobj = sc.doc.Objects.Find(obj)\n            geo = rhobj.Geometry\n            geo.DimensionStyleId = dimstyle_id\n            sc.doc.Objects.Replace(obj, geo)\n            return obj\n    return None\n\ndef attach_usertext(obj_id, data):\n    for key, value in data.items():\n        rs.SetUserText(obj_id, key, value)\n    print(f\"{len(data)} UserText-Einträge hinzugefügt.\")\n    try:\n        existing = rs.GetUserText(obj_id, \"LeaderGUID\")\n        if existing is None or existing == \"\":\n            rs.SetUserText(obj_id, \"LeaderGUID\", str(obj_id))\n        schema = rs.GetUserText(obj_id, \"SchemaVersion\")\n        if schema is None or schema == \"\":\n            rs.SetUserText(obj_id, \"SchemaVersion\", \"1.0\")\n    except Exception:\n        pass\n\ncfg = load_config()\ntypes_cfg = cfg.get(\"types\", {})\naliases_cfg = cfg.get(\"aliases\", {})\n\n# ✅ Aliasname aus CommandHistory holen\ntry:\n    alias_used = rs.CommandHistory().split(\"\\n\")[-2].lower().strip()\n    alias_used = alias_used.replace(\"_\", \"\")  # falls _bbzt verwendet wird\nexcept:\n    print(\"Alias konnte nicht erkannt werden.\")\n    sys.exit()\n\nif alias_used not in aliases_cfg:\n    print(f\"Alias '{alias_used}' nicht erkannt.\")\n    sys.exit()\n\ntyp = aliases_cfg[alias_used]\nif typ not in types_cfg:\n    print(f\"Typ '{typ}' nicht in Konfiguration gefunden.\")\n    sys.exit()\n\ndimstyle_name = types_cfg[typ][\"dimstyle\"]\n# Preset-Auswahl (falls vorhanden)\nentry = types_cfg.get(typ, {})\npresets = entry.get(\"presets\") or []\ncsv_filename = entry.get(\"csv\")\npreset_name = entry.get(\"default_preset\") or \"Standard\"\nif presets:\n    names = [p.get(\"name\") for p in presets if p.get(\"name\")]\n    default_name = entry.get(\"default_preset\")\n    default_name = default_name if (default_name in names) else (names[0] if names else None)\n    try:\n        selection = rs.ListBox(names, message=f\"Select preset for {typ}\", title=\"Choose Preset\", default=default_name)\n        chosen_name = selection or default_name\n        for p in presets:\n            if p.get(\"name\") == chosen_name:\n                csv_filename = p.get(\"csv\") or csv_filename\n                preset_name = chosen_name or preset_name\n                break\n    except Exception:\n        pass\n\n# ✅ Pfade aus Konfig beziehen (mit Fallback)\nuser_dir = os.path.expanduser(\"~\")\ndefault_base = os.path.join(user_dir, \"source\", \"repos\", \"work\", \"library\", \"RhinoLeaderTool\")\ncsv_base = get_selected_csv_folder(cfg, prompt_if_missing=True) or (cfg.get(\"base_path\") if (cfg.get(\"base_path\") and os.path.isdir(cfg.get(\"base_path\"))) else default_base)\ncsv_path = find_csv_in_tree(csv_base, csv_filename, prompt_user=True, typ=typ) or os.path.join(csv_base, csv_filename)\ntemplate_rel = cfg.get(\"template_path\") or \"LeaderAnnotationTemplate.3dm\"\ntemplate_path = template_rel if os.path.isabs(template_rel) else os.path.join(csv_base, template_rel)\n\n# Ablauf\ncsv_data = read_csv_attributes(csv_path)\ntry:\n    csv_data[\"Preset\"] = preset_name or \"Standard\"\nexcept Exception:\n    pass\ntry:\n    csv_data[\"LeaderType\"] = typ\nexcept Exception:\n    pass\n# Erst globalen Prompt (eigenes Buffer dict), dann globale Werte in CSV übernehmen, dann Overrides\nglobals_buf = {}\nmaybe_prompt_for_globals(cfg, globals_buf)\nsaved_globals = load_saved_globals(cfg)\nmerge_globals_into_data(cfg, csv_data, saved_globals)\n# Typ-spezifische Keys (z. B. Betriebsauftrag) erfragen und mergen\ntype_specific = {}\nmaybe_prompt_for_type_specific(cfg, typ, type_specific)\nmerge_globals_into_data(cfg, csv_data, type_specific)\napply_usertext_overrides(cfg, csv_data)\nstyle_id = get_dimstyle_id(dimstyle_name)\nif not style_id:\n    # Versuche DimStyles aus Template zu importieren\n    import_dimstyles_from_template(template_path)\n    style_id = get_dimstyle_id(dimstyle_name)\nif style_id:\n    leader_id = create_leader_with_style(style_id)\n    if leader_id:\n        attach_usertext(leader_id, csv_data)\n",
  "language": "python",
  "imports": [
    "Rhino",
    "Rhino.Geometry",
    "rhinoscriptsyntax",
    "scriptcontext"
  ],
  "has_docstring": false
}