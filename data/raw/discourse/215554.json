{
  "source_url": "https://discourse.mcneel.com/t/notifications-for-plugin-updates/215554",
  "topic_id": 215554,
  "title": "Notifications for Plugin Updates",
  "question": "Hi Team,\n\n\nI am aware that the Package Manager support private packages in the form of custom private repositories. In this approach, the user will not know that if there is a new package unless you communicate to them.\n\n\n\n\nIs there a mechanism to serve a notification to the user that there is an update to a custom package?\n\n\nIs there a mechanism to auto install a the latest version of a custom package on a users machine?\n\n\n\n\nWe have setup our own delivery pipeline that does this across the firm. But Iâ€™d be in favor of moving to a McNeel supported alternative if it exists.",
  "code_blocks": [
    {
      "code": "/// <summary>\n\t/// Use Rhino's Yak package manger to see if there are updates for ProductName\n\t/// <see curl=\"https://discourse.mcneel.com/t/installing-yak-packages-via-rhinocommon/119454\"/>\n\t/// </summary>\n\tinternal static class UpdateChecker {\n\t\tprivate const string Product = \"ProductName\";\n\n\t\tinternal static async void CheckForUpdates(bool silent = true) {\n\t\t\tvar logger = Serilog.Log.Logger;\n\t\t\tvar settings = ProductNamePlugin.Instance.Model.Settings;\n\t\t\tbool allowPreRelease = settings.UseVersionBeta || settings.UseVersionDEV;\n\t\t\t\n\t\t\ttry {\n\n\t\t\t\tvar yak = GetYakClient();\n\n\t\t\t\t// find out what is installed\n\t\t\t\tvar installedVer = GetInstalledVersion(yak);\n\n\t\t\t\tif (installedVer == null ) {\n\t\t\t\t\tlogger.RWarning(nameof(UpdateChecker), $\"Unable to find installed version of {Product}\", \"Install ProductName via Rhino's Package Manager.\");\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n                // get newest available package \n\t\t\t\tVersion[] versions         = await yak.Version.GetAll(Product);\n\n\t\t\t\tversions = versions.Where(v => v.Distributions.Any(d => d.IsCompatible())\n\t\t\t\t                            && (!v.Prerelease || allowPreRelease)\n\t\t\t\t                            && (!v.Number.Contains(\"dev\") || settings.UseVersionDEV)\n\t\t\t\t                            && (!v.Number.Contains(\"beta\") || settings.UseVersionBeta)).ToArray();\n\n\t\t\t\tvar latest = versions.OrderBy(v => VersionNumber.TryParse(v.Number, out var ver) ? ver : null).LastOrDefault();\n\n\t\t\t\t\n\t\t\t\tif ( latest == null || !VersionNumber.TryParse(latest.Number, out var latestVer)) {\n                    logger.RWarning(nameof(UpdateChecker), $\"Unable to find any compatible version of {Product}.\",Remedies.DevReport);\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n                // make a comparison \n\t\t\t\tif (latestVer.CompareTo(installedVer) > 0) {\n\t\t\t\t\tlogger.RInfo(nameof(UpdateChecker), \"An update to Version {updateVersion} is available.\", \"Please use the Rhino Package Manager to upgrade\", latestVer.ToNormalisedString());\n\t\t\t\t} else {\n\t\t\t\t\tif (!silent) {\n\t\t\t\t\t\tlogger.RInfo(nameof(UpdateChecker), \"You are running the latest version of {product} {latestVersion}\", \"Check back later for new versions.\", Product,\n\t\t\t\t\t\t             latestVer.ToNormalisedString());\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\t\n\t\t\t} catch (Exception e) {\n\t\t\t\tlogger.RError(nameof(UpdateChecker), \"Failed to check for updates.\", Remedies.DevReport, e);\n\t\t\t}\n\t\t}\n\n\t\t/// <summary>\n\t\t/// Semantic Version number e.g. 1.2.3-beta\n\t\t/// </summary>\n\t\tpublic static string GetInstalledVersion() {\n\t\t\tVersionNumber version = GetInstalledVersion(GetYakClient());\n\t\t\treturn version?.ToNormalisedString();\n\t\t}\n\n\t\tprivate static VersionNumber GetInstalledVersion(YakClient yak) {\n\t\t\tvar installedProduct = yak.List().FirstOrDefault(p => p.Name == Product);\n\t\t\treturn installedProduct != null && VersionNumber.TryParse(installedProduct.Version, out var installedVer) ? installedVer : null;\n\t\t}\n\n\t\tprivate static YakClient GetYakClient() {\n\t\t\t// init yak client and set package install folder for this version of rhino\n\t\t\t// product header value is included in user-agent for requests to yak.rhino3d.com (for analytics only)\n\t\t\tvar yak = new YakClient(Rhino.ApplicationSettings.PackageManagerSettings.Sources.Split(';').Select(s => PackageRepositoryFactory.Create(s, new ProductHeaderValue(Product))).ToArray()) {\n\t\t\t\tPackageFolder = Rhino.Runtime.HostUtils.AutoInstallPlugInFolder(true) // user\n\t\t\t};\n\t\t\treturn yak;\n\t\t}\n\n\t\t/// <summary>\n\t\t/// \n\t\t/// </summary>\n\t\t/// <param name=\"currentVersion\"></param>\n\t\t/// <param name=\"highestRunVersion\"></param>\n\t\t/// <returns> -ve if current lower than higher </returns>\n\t\tpublic static int CompareVersions(string currentVersion, string highestRunVersion) =>\n\t\t\tVersionNumber.TryParse(currentVersion, out var a) &&\n\t\t\tVersionNumber.TryParse(highestRunVersion, out var b)\n\t\t\t\t? a.CompareTo(b)\n\t\t\t\t: 0;\n\t}",
      "language": "csharp",
      "author": "david.birch.uk",
      "post_number": 2,
      "is_solution": false
    }
  ],
  "tags": [
    "csharp",
    "geometry",
    "rhinocommon"
  ],
  "has_accepted_answer": false,
  "category_id": 71,
  "posts_count": 3,
  "views": 44
}