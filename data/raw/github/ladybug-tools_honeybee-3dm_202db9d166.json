{
  "source_url": "https://github.com/ladybug-tools/honeybee-3dm/blob/256976aa1b173591f00699addf73f4377bcba142/honeybee_3dm/togeometry.py",
  "repo": "ladybug-tools/honeybee-3dm",
  "repo_stars": 2,
  "repo_description": "ðŸ ðŸ¦3DM - Honeybee extension for creating HBJSON model from Rhino 3dm",
  "license": "AGPL-3.0",
  "filepath": "honeybee_3dm/togeometry.py",
  "instruction": "Functions to create Ladybug Geometry objects from Rhino3dm objects.",
  "code": "\"\"\"Functions to create Ladybug Geometry objects from Rhino3dm objects.\"\"\"\n\nimport warnings\nimport rhino3dm\nimport ladybug.color as lbc\n\nfrom ladybug_geometry.geometry3d.pointvector import Point3D, Vector3D\nfrom ladybug_geometry.geometry3d.face import Face3D\nfrom ladybug_geometry.geometry3d.line import LineSegment3D\nfrom ladybug_geometry.geometry3d.polyline import Polyline3D\nfrom ladybug_geometry.geometry3d.mesh import Mesh3D\nfrom ladybug_geometry.geometry3d.polyface import Polyface3D\n\n\ndef to_point3d(point):\n    \"\"\"Create a Ladybug Point3D object from a rhino3dm point.\n\n    Args:\n        point: A rhino3dm point.\n\n    Returns:\n        A Ladybug Point3D object.\n    \"\"\"\n    return Point3D(point.X, point.Y, point.Z)\n\n\ndef to_vector3d(vector):\n    \"\"\"Create a Ladybug Vector3D from a rhino3dm Vector3d.\n\n    Args:\n        vector: A rhino3dm vector3d.\n\n    Returns:\n         A Ladybug Vector3D object.\n    \"\"\"\n    return Vector3D(vector.X, vector.Y, vector.Z)\n\n\ndef remove_dup_vertices(vertices, tolerance):\n    \"\"\"Remove vertices from an array of Point3Ds that are equal within the tolerance.\n\n    Args:\n        vertices: A list of Ladybug Point3D objects.\n        tolerance: A number for model tolerance. By default the tolerance is set to\n            the ModelAbsoluteTolerance value in input 3DM file.\n\n    Returns:\n         A list of Ladybug Point3D objects with duplicate points removed.\n\n    \"\"\"\n    return [pt for i, pt in enumerate(vertices)\n            if not pt.is_equivalent(vertices[i - 1], tolerance)]\n\n\ndef check_planarity(brep, tolerance):\n    \"\"\"Check the planarity of a Brep.\n\n    Args:\n        brep: Geometry of a Rhino3dm Brep.\n        tolerance: A rhino3dm tolerance object. Tolerance set in the rhino file.\n\n    Returns:\n        Bool. True if planar. Otherwise False.\n    \"\"\"\n    is_planar = [brep.Surfaces[i].IsPlanar(tolerance)\n                 for i in range(len(brep.Surfaces))]\n\n    return all(is_planar)\n\n\ndef extract_mesh_faces_colors(mesh, color_by_face=False):\n    \"\"\"Extract face indices and colors from a Rhino mesh.\n\n    Args:\n        mesh: Rhino3dm mesh.\n        color_by_face: Bool. True will derive colors from mesh faces.\n\n    Returns:\n        A tuple of mesh faces and mesh colors.\n    \"\"\"\n\n    colors = None\n    lb_faces = []\n    for i in range(len(mesh.Faces)):\n        face = mesh.Faces[i]\n        if len(face) == 4:\n            lb_faces.append((face[0], face[1], face[2], face[3]))\n        else:\n            lb_faces.append((face[0], face[1], face[2]))\n    if len(mesh.VertexColors) != 0:\n        colors = []\n        if color_by_face is True:\n            for j in range(len(mesh.Faces)):\n                face = mesh.Faces[j]\n                col = mesh.VertexColors[face[0]]\n                colors.append(lbc.Color(col.R, col.G, col.B))\n        else:\n            for k in range(len(mesh.VertexColors)):\n                col = mesh.VertexColors[k]\n                colors.append(lbc.Color(col.R, col.G, col.B))\n    return lb_faces, colors\n\n\ndef mesh_to_mesh3d(mesh, color_by_face=True):\n    \"\"\"Get a Ladybug Mesh3D object from a Rhino3dm Mesh.\n\n    Args:\n        mesh: Rhino3dm mesh.\n        color_by_face: Bool. True will derive colors from mesh faces.\n\n    Returns:\n        A Ladybug Mesh3D object.\n    \"\"\"\n    lb_verts = tuple(to_point3d(mesh.Vertices[i]) for i in range(len(mesh.Vertices)))\n    lb_faces, colors = extract_mesh_faces_colors(mesh, color_by_face)\n    return Mesh3D(lb_verts, lb_faces, colors)\n\n\ndef mesh_to_face3d(mesh):\n    \"\"\"Get a list of Ladybug Face3D objects from a rhino3dm Mesh.\n\n    Args:\n        mesh: A rhino3dm mesh geometry.\n\n    Returns:\n        A list of Ladybug Face3D objects.\n    \"\"\"\n\n    faces = []\n\n    pts = [to_point3d(mesh.Vertices[i]) for i in range(len(mesh.Vertices))]\n\n    for j in range(len(mesh.Faces)):\n        face = mesh.Faces[j]\n        if len(face) == 4:\n            all_verts = (pts[face[0]], pts[face[1]],\n                         pts[face[2]], pts[face[3]])\n        else:\n            all_verts = (pts[face[0]], pts[face[1]], pts[face[2]])\n\n        faces.append(Face3D(all_verts))\n\n    return faces\n\n\ndef brep_to_meshed_face3d(brep, tolerance):\n    \"\"\"Get a Ladybug Face3D object from a planar rhino3dm Brep.\n\n    This method meshes the brep in order to create a Ladybug\n    Face3D object.\n\n    Args:\n        brep: A rhino3dm Brep.\n        tolerance: A rhino3dm tolerance object. Tolerance set in the rhino file.\n\n    Returns:\n        A Ladybug Face3D object.\n    \"\"\"\n\n    for i in range(len(brep.Faces)):\n        mesh = brep.Faces[i].GetMesh(rhino3dm.MeshType.Any)\n        faces = mesh_to_face3d(mesh)\n        polyface = Polyface3D.from_faces(faces, tolerance)\n        lines = list(polyface.naked_edges)\n        polylines = Polyline3D.join_segments(lines, tolerance)\n        face3d = Face3D(boundary=polylines[0].vertices)\n\n    return face3d\n\n\ndef brep_to_mesh_to_face3d(brep):\n    \"\"\"Get a list of Ladybug Face3D objects from a rhino3dm Brep.\n\n    Args:\n        brep: A rhino3dm Brep.\n\n    Returns:\n        A list of Ladybug Face3D objects.\n    \"\"\"\n\n    faces = []\n    for i in range(len(brep.Faces)):\n        mesh = brep.Faces[i].GetMesh(rhino3dm.MeshType.Any)\n        faces.extend(mesh_to_face3d(mesh))\n    return faces\n\n\ndef brep_to_face3d(brep, tolerance, obj):\n    \"\"\"Get a list of Ladybug Face3D objects from a planar rhino3dm Brep.\n\n    Args:\n        brep: A rhino3dm Brep.\n        tolerance: A rhino3dm tolerance object. Tolerance set in the rhino file.\n        obj: A rhino3dm object.\n\n    Returns:\n        A list of Ladybug Face3D objects.\n    \"\"\"\n    mesh = brep.Faces[0].GetMesh(rhino3dm.MeshType.Any)\n\n    # If any of the edge is curved, mesh it\n    for i in range(len(brep.Edges)):\n        if not brep.Edges[i].IsLinear(tolerance):\n            return [brep_to_meshed_face3d(brep, tolerance)]\n\n    # If the brep has 3 or 4 vertices, mesh it\n    if len(mesh.Vertices) == 4 or len(mesh.Vertices) == 3:\n        return [brep_to_meshed_face3d(brep, tolerance)]\n\n    else:\n        lines = []\n        # Create Ladybug lines from start and end points of edges\n        for i in range(len(brep.Edges)):\n            start_pt = to_point3d(brep.Edges[i].PointAtStart)\n            end_pt = to_point3d(brep.Edges[i].PointAtEnd)\n            line = LineSegment3D.from_end_points(start_pt, end_pt)\n            lines.append(line)\n\n        # Create Ladybug Polylines from the lines\n        polylines = Polyline3D.join_segments(lines, tolerance)\n\n        # One polyline means there are no holes\n        if len(polylines) == 1:\n            boundary_pts = remove_dup_vertices(polylines[0].vertices, tolerance)\n            return [Face3D(boundary=boundary_pts)]\n\n        # More than one polylines means there are holes in the brep\n        elif len(polylines) > 1:\n            # while creating polylines from lines if lines are remaining,\n            # mesh the geometry\n            check_polylines = [\n                isinstance(polyline, Polyline3D) for polyline in polylines]\n\n            if not all(check_polylines):\n                faces = brep_to_mesh_to_face3d(brep)\n                return faces\n\n            # sort polylines based on area\n            polyline_areas = [\n                Face3D(polyline.vertices).area for polyline in polylines\n                if isinstance(polyline, Polyline3D)]\n\n            polyline_area_dict = dict(zip(polylines, polyline_areas))\n\n            sorted_dict = sorted(polyline_area_dict.items(),\n                                 key=lambda x: x[1], reverse=True)\n            sorted_polylines = [item[0] for item in sorted_dict]\n\n            # Points on boundary\n            boundary_pts = remove_dup_vertices(\n                sorted_polylines[0].vertices, tolerance)\n\n            hole_pts = [remove_dup_vertices(polyline.vertices, tolerance)\n                        for polyline in sorted_polylines[1:]]\n\n            # Points on holes\n            total_hole_pts = [\n                pts for pts_lst in hole_pts for pts in pts_lst]\n\n            hole_pts_on_boundary = [\n                pts for pts in total_hole_pts if pts in boundary_pts]\n\n            # If any of the hole is touching the boundary of the face, mesh it\n            if len(hole_pts_on_boundary) > 0:\n                warnings.warn(\n                    f'Object with id: {obj.Attributes.Id} has holes that touch the'\n                    ' boundary of the object. This object will be meshed.'\n                )\n                return brep_to_mesh_to_face3d(brep)\n            # else create a face3d with holes\n            else:\n                return [Face3D(boundary=boundary_pts, holes=hole_pts)]\n\n\ndef multiface_brep_to_face3d(brep, tolerance, obj):\n    \"\"\"Get a  list of Ladybug Face3D objects from a Brep with multiple Brep faces.\n\n    Args:\n        brep: A rhino3dm Brep.\n        tolerance: A rhino3dm tolerance object. Tolerance set in the rhino file.\n        obj: A rhino3dm object.\n\n    Returns:\n        A list of Ladybug Face3D objects.\n    \"\"\"\n    faces = []\n\n    for i in range(len(brep.Faces)):\n        face_brep = brep.Faces[i].DuplicateFace(True)\n        # For all the planar brep faces\n        if check_planarity(face_brep, tolerance):\n            faces.extend(brep_to_face3d(face_brep, tolerance, obj))\n        # For all the non-planar brep faces such as a curved face\n        else:\n            faces.extend(brep_to_mesh_to_face3d(face_brep))\n    return faces\n\n\ndef extrusion_to_face3d(extrusion, tolerance):\n    \"\"\"Get a list of Ladybug Face3D objects from a rhino3dm Extrusion.\n\n    Args:\n        brep: A rhino3dm Extrusion.\n        tolerance: A number for tolerance value. Tolerance will only be used for\n            converting mesh geometries.\n\n    Returns:\n        A list of Ladybug Face3D objects.\n    \"\"\"\n    faces = []\n\n    mesh = extrusion.GetMesh(rhino3dm.MeshType.Any)\n    # Create face3ds\n    faces = mesh_to_face3d(mesh)\n    if len(faces) == 1:\n        return faces\n    else:\n        # Group faces by normal direction\n        face_normal = {face: face.normal.z for face in faces}\n        face_groups = {}\n        for i, v in face_normal.items():\n            face_groups[v] = [i] if v not in face_groups.keys() else face_groups[v] + [i]\n        for normal in face_groups:\n            polyface = Polyface3D.from_faces(face_groups[normal], tolerance)\n            lines = list(polyface.naked_edges)\n            polylines = Polyline3D.join_segments(lines, tolerance)\n            face3d = Face3D(boundary=polylines[0].vertices)\n            faces.append(face3d)\n        return faces\n\n\ndef to_face3d(obj, tolerance, *, raise_exception=False):\n    \"\"\"Convert Rhino objects to Ladybug Face3D objects.\n\n    Supported object types are Brep, Extrusion and Meshes. If raise_exception is set to\n    True this method will raise a ValueError for unsupported object types.\n\n    Args:\n        obj: A Rhino3dm object.\n        tolerance: A number for tolerance value. Tolerance will only be used for\n            converting mesh geometries.\n        raise_exception: A Boolean to raise an exception for unsupported object types.\n            default is False.\n\n    Returns:\n        A list of Ladybug Face3D objects.\n    \"\"\"\n    rh_geo = obj.Geometry\n\n    # if it's a Brep\n    if isinstance(rh_geo, rhino3dm.Brep):\n        # If it's a planar brep\n        if check_planarity(rh_geo, tolerance) and len(rh_geo.Faces) == 1:\n            lb_face = brep_to_face3d(rh_geo, tolerance, obj)\n        # If it's a brep with multiple faces\n        else:\n            lb_face = multiface_brep_to_face3d(rh_geo, tolerance, obj)\n\n    # If it's an extrusion\n    elif isinstance(rh_geo, rhino3dm.Extrusion):\n        lb_face = extrusion_to_face3d(rh_geo, tolerance)\n\n    # If it's a mesh\n    elif isinstance(rh_geo, rhino3dm.Mesh):\n        lb_face = mesh_to_face3d(rh_geo)\n\n    else:\n        if raise_exception:\n            raise ValueError(f'Unsupported object type: {rh_geo.ObjectType}')\n        warnings.warn(\n            f'Unsupported object type: {rh_geo.ObjectType} is ignored'\n        )\n        lb_face = []\n\n    return lb_face\n",
  "language": "python",
  "imports": [
    "rhino3dm"
  ],
  "has_docstring": true
}