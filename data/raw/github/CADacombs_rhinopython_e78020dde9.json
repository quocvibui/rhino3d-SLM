{
  "source_url": "https://github.com/CADacombs/rhinopython/blob/541b4ade49f1dda6a3861d12b9e2613405182082/xBrepObject_modifyFaces.py",
  "repo": "CADacombs/rhinopython",
  "repo_stars": 37,
  "repo_description": "Python scripts for Rhinoceros (Rhino, Rhino3D).",
  "license": "LGPL-3.0",
  "filepath": "xBrepObject_modifyFaces.py",
  "instruction": "Library module.",
  "code": "\"\"\"\r\nLibrary module.\r\n\"\"\"\r\n\r\nfrom __future__ import absolute_import, print_function, unicode_literals\r\n\r\n\"\"\"\r\n220317: Created as a breakaway from another script.\r\n\"\"\"\r\n\r\nimport Rhino\r\nimport Rhino.DocObjects as rd\r\nimport Rhino.Geometry as rg\r\nimport rhinoscriptsyntax as rs\r\nimport scriptcontext as sc\r\n\r\nfrom System import Guid\r\nfrom System.Diagnostics import Stopwatch\r\n\r\nimport xBrepFace\r\nimport xBrepObject\r\n\r\n\r\ndef formatDistance(fDistance):\r\n    if fDistance is None:\r\n        return \"(No deviation was provided.)\"\r\n    if fDistance == 0.0:\r\n        return \"Exactly zero\"\r\n    if fDistance < 10.0**(-(sc.doc.DistanceDisplayPrecision-3)):\r\n        return \"{:.1e}\".format(fDistance)\r\n    else:\r\n        return \"{:.{}f}\".format(fDistance, sc.doc.ModelDistanceDisplayPrecision)\r\n\r\n\r\ndef sortObjrefsIntoBrepGuidsAndFaceIndices(objrefs):\r\n    \"\"\"\r\n    Sorts objrefs of entire breps or faces into 2 lists.\r\n\r\n    Returns on success:\r\n        list(GUIDs of breps)\r\n        list(lists(int(Indices of faces)) per brep in other list)\r\n    \"\"\"\r\n\r\n    gBreps = []\r\n    idx_Faces_PerBrep = []\r\n    \r\n    for objref in objrefs:\r\n        rdBrep = objref.Object()\r\n        gBrep = objref.ObjectId\r\n        compIndex = objref.GeometryComponentIndex.Index\r\n\r\n        if compIndex == -1:\r\n            rgBrep = objref.Brep()\r\n            if not rgBrep: continue\r\n            if gBrep in gBreps:\r\n                if rgBrep.Faces.Count == len(idx_Faces_PerBrep[gBreps.index(gBrep)]):\r\n                    continue\r\n                else:\r\n                    idx_Faces_PerBrep[gBreps.index(gBrep)] = range(rgBrep.Faces.Count)\r\n            else:\r\n                gBreps.append(gBrep)\r\n                idx_Faces_PerBrep.append(range(rgBrep.Faces.Count))\r\n        else:\r\n            # Face of polyface brep was selected.\r\n            rdObj = objref.Object()\r\n            if rdObj.ObjectType == rd.ObjectType.InstanceReference:\r\n                print(\"Objects in block instances are not supported.\")\r\n                continue\r\n            else:\r\n                if gBrep in gBreps:\r\n                    idx_gBrep = gBreps.index(gBrep)\r\n                    idx_Faces_PerBrep[idx_gBrep].append(compIndex)\r\n                else:\r\n                    gBreps.append(gBrep)\r\n                    idx_Faces_PerBrep.append([compIndex])\r\n\r\n    return gBreps, idx_Faces_PerBrep\r\n\r\n\r\ndef modifyFaces(rhBreps_In, idx_Faces_perBrep=None, surfaceFunc=None, bExtract=False, bEcho=True, bDebug=False):\r\n    \"\"\"\r\n    Parameters:\r\n        rhBreps_In, # Plural so that summary of \r\n    \"\"\"\r\n\r\n\r\n    if not idx_Faces_perBrep and isinstance(rhBreps_In[0], rd.ObjRef):\r\n        rc = sortObjrefsIntoBrepGuidsAndFaceIndices(objrefs=rhBreps_In)\r\n        if rc is None: return\r\n\r\n        rhBreps_In, idx_Faces_perBrep = rc\r\n\r\n        #print(gBreps_In)\r\n        #for idxs in idx_Faces_perBrep: print(idxs)\r\n\r\n\r\n    gBs_Out_All = []\r\n    srf_devs_All = []\r\n    sLogs_allBreps = []\r\n\r\n    sc.doc.Objects.UnselectAll()\r\n\r\n\r\n    for iB, rhBrep_In in enumerate(rhBreps_In):\r\n\r\n        if isinstance(rhBrep_In, Guid):\r\n            gBrep_In = rhBrep_In\r\n            rdBrep_In = sc.doc.Objects.FindId(gBrep_In) if Rhino.RhinoApp.ExeVersion >= 6 else sc.doc.Objects.Find(gBrep_In)\r\n        elif isinstance(rhBrep_In, rd.BrepObject):\r\n            rdBrep_In = rhBrep_In\r\n            gBrep_In = rdBrep_In.Id\r\n        else:\r\n            continue\r\n\r\n        rgBrep_In = rdBrep_In.BrepGeometry\r\n\r\n        if not idx_Faces_perBrep:\r\n            idx_Faces_toProcess = range(rgBrep_In.Faces.Count)\r\n        else:\r\n            idx_Faces_toProcess = idx_Faces_perBrep[iB]\r\n\r\n        s = \"brep {} of {}\".format(iB+1, len(rhBreps_In))\r\n        Rhino.RhinoApp.SetCommandPrompt(prompt=\"Processing {} ...\".format(s))\r\n\r\n        if bDebug: print(\"Processing brep {}.\".format(gBrep_In))\r\n\r\n\r\n        rgBs_1F_Processed_thisB = []\r\n        idx_Faces_Success_thisB = []\r\n        srf_devs_thisBrep = []\r\n\r\n        sCmdPrompt_In = Rhino.RhinoApp.CommandPrompt\r\n\r\n        for iF, idx_Face in enumerate(idx_Faces_toProcess):\r\n            Rhino.RhinoApp.SetCommandPrompt(\r\n                    prompt=sCmdPrompt_In +\r\n                    \"  Face[{}] of 0-{} ...\".\\\r\n                            format(iF, len(idx_Faces_toProcess)))\r\n            if bDebug: print(Rhino.RhinoApp.CommandPrompt)\r\n\r\n            rgF_B_In = rgBrep_In.Faces[idx_Face]\r\n\r\n            res, sLog = xBrepFace.createModifiedFace(\r\n                rgF_B_In,\r\n                surfaceFunc,\r\n                bDebug=bDebug,\r\n                )\r\n\r\n            if res is None:\r\n                sLogs_allBreps.append(sLog)\r\n                continue\r\n\r\n            rgB_1F_Created, srf_dev = res\r\n        \r\n            if not rgB_1F_Created.IsValid:\r\n                print(\"Invalid brep geometry for face (index={}) after modification.\".format(idx_Face))\r\n                print(\"It will not be included in processed results.\")\r\n                rgB_1F_Created.Dispose()\r\n                continue\r\n        \r\n            rgBs_1F_Processed_thisB.append(rgB_1F_Created)\r\n            idx_Faces_Success_thisB.append(idx_Face)\r\n            srf_devs_thisBrep.append(srf_dev)\r\n            srf_devs_All.append(srf_dev)\r\n\r\n        if not rgBs_1F_Processed_thisB:\r\n            continue # to next brep.\r\n\r\n\r\n        # Modify BrepObject with successful surface conversions.\r\n\r\n        rc = xBrepObject.replaceFaces(\r\n            rdBrep_In,\r\n            idx_Faces_Success_thisB,\r\n            rgBs_1F_Processed_thisB,\r\n            bExtract=bExtract)\r\n        if rc is None:\r\n            pass\r\n        else:\r\n            if bExtract:\r\n                gBs_Out_thisBrep, gRemaining = rc\r\n            else:\r\n                gBs_Out_thisBrep = rc\r\n            gBs_Out_All.extend(gBs_Out_thisBrep)\r\n\r\n\r\n    if bEcho:\r\n        for sLog in set(sLogs_allBreps):\r\n            print(\"[{}] {}\".format(sLogs_allBreps.count(sLog), sLog))\r\n\r\n\r\n    if not gBs_Out_All:\r\n        return []\r\n\r\n\r\n        if min(srf_devs_All) != max(srf_devs_All):\r\n            print(\"Maximum deviations range from {} to {}\".format(\r\n                    formatDistance(min(srf_devs_All)),\r\n                    formatDistance(max(srf_devs_All)))\r\n                    )\r\n        else:\r\n            print(\"Maximum deviation: {}\".format(formatDistance(max(srf_devs_All))))\r\n\r\n\r\n    return gBs_Out_All\r\n",
  "language": "python",
  "imports": [
    "Rhino",
    "Rhino.Geometry",
    "rhinoscriptsyntax",
    "scriptcontext"
  ],
  "has_docstring": true
}