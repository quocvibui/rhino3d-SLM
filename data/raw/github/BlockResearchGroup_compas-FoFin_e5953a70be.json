{
  "source_url": "https://github.com/BlockResearchGroup/compas-FoFin/blob/9ce50ac0bb4d9785fe387fba6b2edcfcf16665e1/commands/FF_session_undo.py",
  "repo": "BlockResearchGroup/compas-FoFin",
  "repo_stars": 7,
  "repo_description": "Rhino plugin for form finding of tension-only, compression-only, and mixed tension-compression structures with axial forces, using constrained force-density and dynamic relaxation solvers.",
  "license": "NOASSERTION",
  "filepath": "commands/FF_session_undo.py",
  "instruction": "venv: brg-csd r: compas_fofin>=0.15.3",
  "code": "#! python3\n# venv: brg-csd\n# r: compas_fofin>=0.15.3\n\nimport compas_rhino.objects\nfrom compas.colors import Color\nfrom compas_fofin.scene import RhinoCableMeshObject\nfrom compas_fofin.scene import RhinoConstraintObject\nfrom compas_fofin.session import FoFinSession\nfrom compas_fofin.solvers import AutoUpdateFD\n\n\ndef RunCommand():\n    session = FoFinSession()\n    session.clear_conduits()\n\n    oldscene = session.scene\n\n    if not session.undo():\n        return\n\n    oldscene.clear()\n\n    session.scene.draw()\n\n    meshobj: RhinoCableMeshObject = session.find_cablemesh()\n    if not meshobj:\n        return\n\n    # =============================================================================\n    # Remap constraints\n    # =============================================================================\n\n    for sceneobject in session.scene.objects:\n        if isinstance(sceneobject, RhinoConstraintObject):\n            session.scene.clear_context(sceneobject.guids)\n            session.scene.remove(sceneobject)\n\n    for guid in meshobj.mesh.constraints:\n        constraint = meshobj.mesh.constraints[guid]  # type: ignore\n        sceneobject = session.scene.add(constraint, color=Color.cyan())  # type: ignore\n        sceneobject.draw()\n\n        robj = compas_rhino.objects.find_object(sceneobject.guids[0])\n        robj.UserDictionary[\"constraint.guid\"] = str(guid)\n\n    # =============================================================================\n    # Update scene\n    # =============================================================================\n\n    meshobj.clear()\n    meshobj.clear_conduits()\n\n    if meshobj.mesh.is_solved:\n        autoupdate = AutoUpdateFD(meshobj.mesh, kmax=session.settings.solver.kmax)\n        autoupdate()\n\n        meshobj.show_vertices = list(meshobj.mesh.vertices_where(is_support=True))\n        meshobj.show_edges = False\n        meshobj.show_faces = False\n        meshobj.draw()\n        meshobj.display_forces_conduit(tmax=session.settings.display.tmax)\n        meshobj.display_reactions_conduit(scale=session.settings.drawing.scale_reactions)\n\n    else:\n        meshobj.show_vertices = list(meshobj.mesh.vertices_where(is_support=True))\n        meshobj.show_edges = False\n        meshobj.show_faces = False\n        meshobj.draw()\n        meshobj.display_edges_conduit(thickness=session.settings.drawing.edge_thickness)\n\n\n# =============================================================================\n# Main\n# =============================================================================\n\nif __name__ == \"__main__\":\n    RunCommand()\n",
  "language": "python",
  "imports": [],
  "has_docstring": true
}