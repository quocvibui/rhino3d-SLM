{
  "source_url": "https://github.com/ibois-epfl/Manis-timber-plate-joinery-solver/blob/9b0d22db181d4f55f01816440a5c0a31cda502bc/Gh%20compilation%20files/analysis.py",
  "repo": "ibois-epfl/Manis-timber-plate-joinery-solver",
  "repo_stars": 12,
  "repo_description": "A grasshopper plugin to create joints between timber panels and export CNC toolpath and robot trajectories for fully automated workflow from design to fabrication to assembly.",
  "license": "MIT",
  "filepath": "Gh compilation files/analysis.py",
  "instruction": "Run a structural analysis of the model using Abaqus solver through Compas framework.",
  "code": "\"\"\"Run a structural analysis of the model using Abaqus solver through Compas framework.\"\"\"\r\n\r\nfrom ghpythonlib.componentbase import dotnetcompiledcomponent as component\r\nimport Grasshopper, GhPython\r\nimport System\r\nimport rhinoscriptsyntax as rs\r\nimport scriptcontext as sc\r\nimport Rhino\r\nimport datetime\r\nimport json\r\n\r\n__author__ = \"Nicolas Rogeau and Aryan Rezaei Rad\"\r\n__laboratory__ = \"IBOIS, Laboratory for Timber Construction\" \r\n__university__ = \"EPFL, Ecole Polytechnique Federale de Lausanne\"\r\n__funding__ = \"NCCR Digital Fabrication, ETH Zurich\"\r\n__version__ = \"2021.09\"\r\n\r\nclass MyComponent(component):\r\n    def __new__(cls):\r\n        instance = Grasshopper.Kernel.GH_Component.__new__(cls,\r\n            \"FEM analysis\", \"FEM Analysis\", \"\"\"Run a structural analysis of the model using Abaqus solver through Compas framework.\"\"\", \"Manis\", \"FEM\")\r\n        return instance\r\n    \r\n    def get_ComponentGuid(self):\r\n        return System.Guid(\"a5d29a9e-1702-4ed8-8ccb-997c922f6911\")\r\n    \r\n    def SetUpParam(self, p, name, nickname, description):\r\n        p.Name = name\r\n        p.NickName = nickname\r\n        p.Description = description\r\n        p.Optional = True\r\n\r\n    def RegisterInputParams(self, pManager):\r\n        p = Grasshopper.Kernel.Parameters.Param_Boolean()\r\n        self.SetUpParam(p, \"run\", \"run\", \"Script input Boolean\")\r\n        p.Access = Grasshopper.Kernel.GH_ParamAccess.item\r\n        self.Params.Input.Add(p)\r\n        \r\n        p = Grasshopper.Kernel.Parameters.Param_Mesh()\r\n        self.SetUpParam(p, \"meshes\", \"meshes\", \"Script input meshes.\")\r\n        p.Access = Grasshopper.Kernel.GH_ParamAccess.list\r\n        self.Params.Input.Add(p)\r\n        \r\n        p = Grasshopper.Kernel.Parameters.Param_Line()\r\n\r\n        self.SetUpParam(p, \"lines\", \"lines\", \"Script input lines.\")\r\n        p.Access = Grasshopper.Kernel.GH_ParamAccess.list\r\n        self.Params.Input.Add(p)\r\n        \r\n        p = Grasshopper.Kernel.Parameters.Param_Point()\r\n        self.SetUpParam(p, \"supports\", \"supports\", \"Script input supports.\")\r\n        p.Access = Grasshopper.Kernel.GH_ParamAccess.list\r\n        self.Params.Input.Add(p)\r\n        \r\n        p = Grasshopper.Kernel.Parameters.Param_Point()\r\n        self.SetUpParam(p, \"load_points\", \"load_points\", \"Script input load_points.\")\r\n        p.Access = Grasshopper.Kernel.GH_ParamAccess.list\r\n        self.Params.Input.Add(p)\r\n        \r\n        p = Grasshopper.Kernel.Parameters.Param_Boolean()\r\n        self.SetUpParam(p, \"fixed\", \"fixed\", \"Script input fixed.\")\r\n        p.Access = Grasshopper.Kernel.GH_ParamAccess.item\r\n        self.Params.Input.Add(p)\r\n        \r\n        p = Grasshopper.Kernel.Parameters.Param_Number()\r\n        self.SetUpParam(p, \"elasticity\", \"elasticity\", \"Script input elasticity.\")\r\n        p.Access = Grasshopper.Kernel.GH_ParamAccess.item\r\n        self.Params.Input.Add(p)\r\n        \r\n        p = Grasshopper.Kernel.Parameters.Param_Number()\r\n        self.SetUpParam(p, \"poisson\", \"poisson\", \"Script input poisson.\")\r\n        p.Access = Grasshopper.Kernel.GH_ParamAccess.item\r\n        self.Params.Input.Add(p)\r\n        \r\n        p = Grasshopper.Kernel.Parameters.Param_Number()\r\n        self.SetUpParam(p, \"density\", \"density\", \"Script input density.\")\r\n        p.Access = Grasshopper.Kernel.GH_ParamAccess.item\r\n        self.Params.Input.Add(p)\r\n        \r\n        p = Grasshopper.Kernel.Parameters.Param_Number()\r\n        self.SetUpParam(p, \"thickness\", \"thickness\", \"Script input thickness.\")\r\n        p.Access = Grasshopper.Kernel.GH_ParamAccess.item\r\n        self.Params.Input.Add(p)\r\n        \r\n        p = Grasshopper.Kernel.Parameters.Param_Number()\r\n        self.SetUpParam(p, \"width\", \"width\", \"Script input width.\")\r\n        p.Access = Grasshopper.Kernel.GH_ParamAccess.item\r\n        self.Params.Input.Add(p)\r\n        \r\n        p = Grasshopper.Kernel.Parameters.Param_Number()\r\n        self.SetUpParam(p, \"height\", \"height\", \"Script input height.\")\r\n        p.Access = Grasshopper.Kernel.GH_ParamAccess.item\r\n        self.Params.Input.Add(p)\r\n        \r\n        p = Grasshopper.Kernel.Parameters.Param_Number()\r\n        self.SetUpParam(p, \"uni_load\", \"uni_load\", \"Script input uni_load.\")\r\n        p.Access = Grasshopper.Kernel.GH_ParamAccess.item\r\n        self.Params.Input.Add(p)\r\n        \r\n    def RegisterOutputParams(self, pManager):\r\n        pass\r\n\r\n    def SolveInstance(self, DA):\r\n        p0 = self.marshal.GetInput(DA, 0)\r\n        p1 = self.marshal.GetInput(DA, 1)\r\n        p2 = self.marshal.GetInput(DA, 2)\r\n        p3 = self.marshal.GetInput(DA, 3)\r\n        p4 = self.marshal.GetInput(DA, 4)\r\n        p5 = self.marshal.GetInput(DA, 5)\r\n        p6 = self.marshal.GetInput(DA, 6)\r\n        p7 = self.marshal.GetInput(DA, 7)\r\n        p8 = self.marshal.GetInput(DA, 8)\r\n        p9 = self.marshal.GetInput(DA, 9)\r\n        p10 = self.marshal.GetInput(DA, 10)\r\n        p11 = self.marshal.GetInput(DA, 11)\r\n        p12 = self.marshal.GetInput(DA, 12)\r\n        result = self.RunScript(p0, p1, p2, p3, p4, p5, p6, p7, p8, p9, p10, p11, p12)\r\n\r\n    def get_Internal_Icon_24x24(self):\r\n        o = \"iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAYAAADgdz34AAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAACxIAAAsSAdLdfvwAAAClSURBVEhL7ZLRDYAgDESZiWGZyZn8qS3JkVooaAz9sskzhfN6AU1EtJX6OI9MQi7lhrcPVr64ACW0o/E6cfEblbq2QMdaees86R8HYF8DXfsEN0B68CbA6vEB+CjK8AnMiwvAkVi0BZNXQ727orAA6TVcbYDVZvofsNS7gO2/6fYAHIlFWzB5NdS7KwoLkF7D1QZYbabHB+CjQADePlj54gL2QekC+ZuAi+2XxMIAAAAASUVORK5CYII=\"\r\n        return System.Drawing.Bitmap(System.IO.MemoryStream(System.Convert.FromBase64String(o)))\r\n\r\n    def RunScript(self, run, meshes, lines, supports, load_points, fixed, elasticity, poisson, density, thickness, width, height, uni_load):\r\n                    \r\n        def clear(layer_name):\r\n            sc.doc = Rhino.RhinoDoc.ActiveDoc\r\n            objects = sc.doc.Objects.FindByLayer(layer_name)\r\n            if objects != None:\r\n                for obj in objects: sc.doc.Objects.Delete(obj, True)\r\n            sc.doc = GhPython.DocReplacement.GrasshopperDocument()\r\n\r\n        def bake(objects, layer_name, color=(0,0,0,255)):\r\n            for obj in objects:\r\n                #create layer\r\n                sc.doc = Rhino.RhinoDoc.ActiveDoc\r\n                rs.AddLayer(layer_name, color, visible=True, locked=False, parent=None)\r\n\r\n                #create object\r\n                sc.doc = GhPython.DocReplacement.GrasshopperDocument()\r\n                try: obj = sc.doc.Objects.Add(obj)\r\n                except: obj = sc.doc.Objects.AddPoint(obj)\r\n                obj_object = rs.coercerhinoobject(obj)\r\n                obj_attributes = obj_object.Attributes\r\n                obj_geometry = obj_object.Geometry\r\n\r\n                #select layer to bake and add to the attributes\r\n                sc.doc = Rhino.RhinoDoc.ActiveDoc\r\n                layertable = sc.doc.Layers\r\n                obj_attributes.LayerIndex = layertable.Find(layer_name,True)\r\n\r\n                #bake object\r\n                sc.doc.Objects.Add(obj_geometry, obj_attributes, None, True)\r\n                sc.doc = GhPython.DocReplacement.GrasshopperDocument()\r\n\r\n        try:\r\n            from compas.geometry import cross_vectors\r\n            from compas.geometry import normalize_vector\r\n            from compas.geometry import subtract_vectors\r\n            from compas_fea.cad import rhino\r\n            from compas_fea.structure import ElasticIsotropic\r\n            from compas_fea.structure import ElementProperties as Properties\r\n            from compas_fea.structure import GeneralStep\r\n            from compas_fea.structure import FixedDisplacement\r\n            from compas_fea.structure import PinnedDisplacement\r\n            from compas_fea.structure import RollerDisplacementX\r\n            from compas_fea.structure import PointLoad\r\n            from compas_fea.structure import ShellSection\r\n            from compas_fea.structure import RectangularSection\r\n            from compas_fea.structure import CircularSection\r\n            from compas_fea.structure import Structure\r\n        except: self.AddRuntimeMessage(Grasshopper.Kernel.GH_RuntimeMessageLevel.Error, 'Compas and compas_fea are both required to run the analysis. Please verify that both are installed and available in Rhino.')\r\n        \r\n        if run is True:\r\n\r\n            meshes = [rs.coercemesh(mesh) for mesh in meshes]\r\n            lines = [line.ToNurbsCurve() for line in lines]\r\n            supports = rs.coerce3dpointlist(supports)\r\n            load_points = rs.coerce3dpointlist(load_points)\r\n\r\n            #Bake initial conditions in Rhino\r\n            clear(\"elset_mesh\")\r\n            bake(meshes, \"elset_mesh\", color=(50,150,150,255))\r\n            clear(\"elset_beams\")\r\n            bake(lines, \"elset_beams\", color=(250,200,50,255))\r\n            clear(\"nset_support\")\r\n            bake(supports, \"nset_support\", color=(250,0,0,255))\r\n            clear(\"nset_load\")\r\n            bake(load_points, \"nset_load\", color=(0,250,0,255))\r\n        \r\n            sc.doc = Rhino.RhinoDoc.ActiveDoc\r\n        \r\n            # Local Coordinate System per each element\r\n            for i in rs.ObjectsByLayer('elset_beams'):\r\n                ez = subtract_vectors(rs.CurveEndPoint(i), rs.CurveStartPoint(i))\r\n                ex = normalize_vector(cross_vectors(ez, [0, 0, 1]))\r\n                rs.ObjectName(i, '_{0}'.format(json.dumps({'ex': ex})))\r\n        \r\n            # Structure\r\n            mdl = Structure(name=datetime.datetime.now().strftime(\"%m_%d_%Y_%H_%M_%S\"), path='C:/temp/')\r\n        \r\n            # Elements\r\n            rhino.add_nodes_elements_from_layers(mdl, mesh_type='ShellElement', layers='elset_mesh')\r\n            rhino.add_nodes_elements_from_layers(mdl, line_type='BeamElement', layers='elset_beams')\r\n\r\n            # Sets\r\n            rhino.add_sets_from_layers(mdl, layers=['nset_load', 'nset_support'])\r\n\r\n            # Materials\r\n            mdl.add(ElasticIsotropic(name='mat_elastic_plate', E=elasticity, v=poisson, p=density))\r\n            mdl.add(ElasticIsotropic(name='mat_elastic_connections', E=elasticity, v=poisson, p=density))\r\n\r\n            # Sections\r\n            mdl.add(ShellSection(name='sec_plate', t=thickness))\r\n            mdl.add(RectangularSection(name='sec_beam', b=width, h=height))\r\n            \r\n            \r\n            # Properties\r\n            mdl.add(Properties(name='ep_plate', material='mat_elastic_plate', section='sec_plate', elset='elset_mesh'))\r\n            mdl.add(Properties(name='ep_beam', material='mat_elastic_connections', section='sec_beam', elset='elset_beams'))\r\n            \r\n            # Displacements\r\n            if fixed is True: mdl.add([FixedDisplacement(name='disp', nodes='nset_support')])\r\n            else: mdl.add([PinnedDisplacement(name='disp', nodes='nset_support')])\r\n        \r\n            # Loads\r\n            mdl.add(PointLoad(name='load_point', nodes='nset_load', z=uni_load))\r\n\r\n            # Steps\r\n            mdl.add([\r\n                GeneralStep(name='step_bc', displacements=['disp']),\r\n                GeneralStep(name='step_load', loads=['load_point'], tolerance=1, iterations=500),\r\n            ])\r\n            mdl.steps_order = ['step_bc', 'step_load']\r\n            \r\n            # Summary\r\n            mdl.summary()\r\n            \r\n            # Run\r\n            mdl.analyse_and_extract(software='abaqus',\r\n                fields=['u', 'sf', 'cf', 'rf', 's'],\r\n                components=['ux', 'uy', 'uz', 'rfx', 'rfy', 'rfz', 'cfx', 'cfy', 'cfz', 'sxx', 'syy', 'smises'])\r\n            \r\n            # Output\r\n            rhino.plot_data(mdl, step='step_load', field='uz', radius=10.0, scale=50.0)\r\n            #rhino.plot_data(mdl, step='step_load', field='sxx', radius=10., scale=100.0)\r\n            #rhino.plot_data(mdl, step='step_load', field='syy', radius=10., scale=100.0)\r\n            rhino.plot_reaction_forces(mdl, step='step_load', scale=100.0)\r\n            rhino.plot_concentrated_forces(mdl, step='step_load', scale=100.0)\r\n            rhino.plot_data(mdl, step='step_load', field='smises', radius=100.)\r\n            \r\n            mdl.save_to_obj()\r\n        \r\n            sc.doc = GhPython.DocReplacement.GrasshopperDocument()\r\n\r\n        return\r\n\r\nclass AssemblyInfo(GhPython.Assemblies.PythonAssemblyInfo):\r\n    def get_AssemblyName(self):\r\n        return \"FEM_analysis\"\r\n    \r\n    def get_AssemblyDescription(self):\r\n        return \"\"\"\"\"\"\r\n\r\n    def get_AssemblyVersion(self):\r\n        return \"0.1\"\r\n\r\n    def get_AuthorName(self):\r\n        return \"Nicolas Rogeau\"\r\n    \r\n    def get_Id(self):\r\n        return System.Guid(\"6a7710df-9747-452c-a3a5-67114d94b67a\")",
  "language": "python",
  "imports": [
    "Rhino",
    "ghpythonlib",
    "rhinoscriptsyntax",
    "scriptcontext"
  ],
  "has_docstring": true
}