{
  "source_url": "https://github.com/PH-Tools/honeybee_grasshopper_ph_plus/blob/b89f9887488d9c10eb732ffafe910cec70be0752/honeybee_ph_plus_rhino/gh_compo_io/reporting/build_erv_duct_objects.py",
  "repo": "PH-Tools/honeybee_grasshopper_ph_plus",
  "repo_stars": 2,
  "repo_description": "Additional Honeybe-PH Grasshopper Components",
  "license": "GPL-3.0",
  "filepath": "honeybee_ph_plus_rhino/gh_compo_io/reporting/build_erv_duct_objects.py",
  "instruction": "Create ERV duct Model-Objects from a Honeybee Model's PH-HVAC Ventilation Systems.",
  "code": "# -*- coding: utf-8 -*-\n# -*- Python Version: 2.7 -*-\n\n\"\"\"Create ERV duct Model-Objects from a Honeybee Model's PH-HVAC Ventilation Systems.\"\"\"\n\ntry:\n    from System import Object # type: ignore\n    from Grasshopper import DataTree # type: ignore\n    from Grasshopper.Kernel.Data import GH_Path # type: ignore\n    from Rhino.Geometry import PolylineCurve  # type: ignore\nexcept ImportError as e:\n    raise ImportError(\"\\nFailed to import ghpythonlib or Grasshopper:\\n\\t{}\".format(e))\n\ntry:\n    from ladybug_rhino.fromgeometry import from_linesegment3d\nexcept ImportError as e:\n    raise ImportError(\"\\nFailed to import ladybug_rhino:\\n\\t{}\".format(e))\n\ntry:\n    from honeybee.model import Model\nexcept ImportError as e:\n    raise ImportError(\"\\nFailed to import honeybee:\\n\\t{}\".format(e))\n\ntry:\n    from honeybee_phhvac.ducting import PhDuctElement, PhDuctSegment\nexcept ImportError as e:\n    raise ImportError(\"\\nFailed to import honeybee_phhvac:\\n\\t{}\".format(e))\n\ntry:\n    from ph_gh_component_io import gh_io\n    from ph_gh_component_io.input_tools import input_to_int\nexcept ImportError:\n    raise ImportError(\"Failed to import ph_gh_component_io\")\n\n\n# ----------------------------------------------------------------------\n# -- Helper Class and functions\n\n\nclass ErvDuctsContainer(object):\n    def __init__(self, _parent_vent_unit_name, _ducts):\n        self.parent_vent_unit_name = _parent_vent_unit_name\n        self.ducts = _ducts\n\n    def __str__(self):\n        return \"{}({}, [{} ducts])\".format(self.__class__.__name__, self.parent_vent_unit_name, len(self.ducts))\n\n    def ToString(self):\n        return str(self)\n\n\ndef curve_from_segments(_IGH, _segments):\n    # type: (gh_io.IGH, list[PhDuctSegment]) -> list[PolylineCurve]\n    segment_curves = _IGH.ghc.JoinCurves([from_linesegment3d(s.geometry) for s in _segments], False)\n    if not isinstance(segment_curves, list):  # Ensure consistent data structure\n        segment_curves = [segment_curves]\n    return segment_curves\n\n\ndef get_duct_block_name(_parent_name, _duct):\n    # type: (str, PhDuctElement) -> str\n    if _duct.is_round_duct:\n        shape = \"{}in Diam\".format(_duct.segments[0].diameter)\n    else:\n        shape = \"{}in x {}in\".format(_duct.segments[0].height, _duct.segments[0].width)\n    return \"{} | {} | {}\".format(_parent_name, \"OA\" if _duct.duct_type==1 else \"EA\", shape)\n\n\n# ----------------------------------------------------------------------\n# -- Component Interface Class\n\n\nclass GHCompo_BuildErvDucting(object):\n    def __init__(self, _IGH, _hb_model, _duct_type):\n        # type: (gh_io.IGH, Model, int) -> None\n        self.IGH = _IGH\n        self.hb_model = _hb_model\n        self.duct_type = _duct_type\n\n    @property\n    def duct_type(self):\n        # type: () -> int\n        return self._duct_type\n\n    @duct_type.setter\n    def duct_type(self, value):\n        # type: (int) -> None\n        input_int = input_to_int(value, _default=1)\n        if input_int in (1, 2):\n            self._duct_type = input_int\n        else:\n            raise ValueError(\"Duct Type must be 1 (Supply) or 2 (Exhaust). Got: {}\".format(value))\n\n    @property\n    def ready(self):\n        # type: () -> bool\n        return self.hb_model is not None\n\n    @property\n    def layer_name(self):\n        # type: () -> str\n        if self.duct_type == 1:\n            return \"OA\"\n        else:\n            return \"EA\"\n\n    def run(self):\n        # type: () -> None | DataTree[Object]\n\n        if not self.ready:\n            return None\n\n        # --------------------------------------------------------------------------------------------------------------\n        # -- Get all of the HB-Ducting from each of the Ventilation Systems from the Model\n        ph_ventilation_systems = {}\n        for room in self.hb_model.rooms:\n            vent_system = room.properties.ph_hvac.ventilation_system\n            if not vent_system:\n                continue\n            ph_ventilation_systems[vent_system.display_name] = vent_system\n\n        hb_ducts = DataTree[Object]()\n        for i, k in enumerate(sorted(ph_ventilation_systems.keys())):\n            vent_system = ph_ventilation_systems[k]\n\n            if self.duct_type == 1:\n                ducts = vent_system.supply_ducting\n            else:\n                ducts = vent_system.exhaust_ducting\n\n            hb_ducts.Add(\n                ErvDuctsContainer(vent_system.ventilation_unit.display_name, [d.duplicate() for d in ducts]), GH_Path(i)\n            )\n\n        # --------------------------------------------------------------------------------------------------------------\n        # -- Wrap each of the HB-Duct Groups into a Model Object\n        duct_model_objects_ = DataTree[Object]()\n        ea_layer = self.IGH.ghc.ModelLayer(layer=self.layer_name, name=self.layer_name).layer\n        for i, b in enumerate(hb_ducts.Branches):\n            ducting_obj = b[0]\n            for duct in ducting_obj.ducts:\n                for curve in curve_from_segments(self.IGH, duct.segments):\n\n                    # -- Build the actual Model Object\n                    model_obj = self.IGH.ghc.ModelObject(\n                        object=curve,\n                        geometry=curve,\n                        name=get_duct_block_name(ducting_obj.parent_vent_unit_name, duct),\n                        layer=ea_layer,\n                    ).object\n\n                    # -- Store the parent unit-name\n                    model_obj = self.IGH.ghc.UserText(\n                        content=model_obj, keys=[\"parent_vent_unit_name\"], values=[ducting_obj.parent_vent_unit_name]\n                    ).content\n\n                    # -- Package for Output\n                    duct_model_objects_.Add(model_obj, GH_Path(duct_model_objects_.BranchCount + 1))\n\n        # --------------------------------------------------------------------------------------------------------------\n        # -- Output\n        return duct_model_objects_\n",
  "language": "python",
  "imports": [
    "Rhino",
    "Rhino.Geometry",
    "ghpythonlib"
  ],
  "has_docstring": true
}