{
  "source_url": "https://github.com/larkspectral/Lark_Spectral_Lighting/blob/56d03f6c41535e675bea5f9f7c36ded9b5f16ae6/Lark%20Non-Visual%20Direct%20Response%20Model.py",
  "repo": "larkspectral/Lark_Spectral_Lighting",
  "repo_stars": 3,
  "repo_description": "Lark Spectral Lighting",
  "license": "NOASSERTION",
  "filepath": "Lark Non-Visual Direct Response Model.py",
  "instruction": "Use this to compute the relative and cumulative alerting response using the non-vidual direct response model (Amundadottir, 2016).\nThe nvRD model takes as input a time series of eye-level light...",
  "code": "# Relative and cumulative alerting response using the non-visual direct response model.\n\n# Lark Spectral Lighting (v0.0.1, v0.0.2 and v1.0) is a collaboration of University of Washington and ZGF Architects LLP\n# Authors Dr. Mehlika Inanici, Marty Brennan & Ed Clark\n# Lark v2.0 is a collaboration of EPFL, Oregon State University, and Eindhoven University of Technology\n# Authors Dr. Clotilde Pierson & Myrta Gkaintatzi-Masouti\n# Lark Spectral Lighting v3.0 is a collaboration of University of Washington and ZGF Architects LLP\n# Authors Bo Jung, Dr. Mehlika Inanici, Marty Brennan, and Zining Cheng \n# Copyright 2015-2022 University of Washington (Mehlika Inanici, Ph.D.) and ZGF Architects LLP\n# Copyright 2022 EPFL, Oregon State University (Clotilde Pierson, Ph.D.), and Eindhoven University of Technology (Myrta Gkaintatzi-Masouti, M.Sc.)\n# Copyright 2023 University of Washington (Bo Jung, M.Sc., Mehlika Inanici, Ph.D., Zining Cheng, M.Sc.) and ZGF Architects LLP\n# Licensed under The Modified 3-Clause BSD License (the \"License\");\n# You may obtain a copy of the License at\n# https://opensource.org/licenses/BSD-3-Clause\n\n\"\"\"\nUse this to compute the relative and cumulative alerting response using the non-vidual direct response model (Amundadottir, 2016).\nThe nvRD model takes as input a time series of eye-level light stimuli and translates it to a predicted human alerting response. The model accounts for light quantity, spectrum, duration and history. Relative repsonse is calculated each timestep of the analysis period (which saturates after a level of light stimulus is reached) which is summed up to a cumulative response at the end of the analysis period.\n-\nMore information about the model can be found in this PhD thesis:\nAmundadottir, 2016, \"Light-driven model for identifying indicators of non-visual health potential in the built environment\", https://infoscience.epfl.ch/record/221429?ln=en\n-\nProvided by Lark 3.0.0\n\n    Args:\n        spectral_data:A path to a csv file with timeseries of spectral irradiance. \n            The csv file should include the following information:\n            - point coordinates (in columns A,B,C)\n            - vector coordinates (in columns D,E,F)\n            - month, day and hour (in columns G,H,I)\n            - alpha-opic irradiance, ELR and EDI (in columns J,K,L) (these are not necessary for the calculation)\n            - spectral irradiance in W/m2/nm (in the next 400 columns)\n            - each row is a new timestep\n        calculate: A boolean toggle to run this component\n        time_step: Time step for timeseries in hours (e.g. for data every 6 minutes, input 6/60 = 0.1)\n    Returns:\n        result: The nvRD outputs (relative and cumulative responses) in a tree data structure \n\"\"\"\n\n__author__ = \"cpierson\"\n__version__ = \"2021.10.15\"\n\nghenv.Component.Name = \"Lark Non-Visual Direct Response Model v3\"\nghenv.Component.NickName = 'nvRD'\nghenv.Component.Message = '3.0.0'\nghenv.Component.Category = \"Lark\"\nghenv.Component.SubCategory = \"Timeseries\"\n\n\n\n#check all inputs\nerror_list = []\ninputs = [spectral_data,calculate,time_step]\ninputs_name = [\"spectral_data\",\"calculate\",\"time_step\"]\n\nfor idx, val in enumerate (inputs):\n    if val == None or val == []:\n        error_list.append(inputs_name[idx])\n\nif len(error_list) != 0:\n    check = \"error\"\nelse:\n    check = 1\n\nif check == \"error\":\n    print \"Warning! Connect the following inputs:\" \n    print error_list\n\n\n\n#apply nvRD model\nif check != \"error\":\n    \n    import rhinoscriptsyntax as rs\n    import scriptcontext\n    import csv\n    import collections\n    import math\n    from collections import OrderedDict\n    from Grasshopper import DataTree\n    from Grasshopper.Kernel.Data import GH_Path\n    \n    \n    \n    #define melanopic action spectra\n    IPRGC_SENS_WEIGHTING = [1.40458103669806e-05,\n                            1.70885602662509e-05,\n                            2.07872194946997e-05,\n                            2.52723036079605e-05,\n                            3.06959011323138e-05,\n                            3.72338574949650e-05,\n                            4.50877896278921e-05,\n                            5.44868055974823e-05,\n                            6.56887874058060e-05,\n                            7.89810842799403e-05,\n                            9.46804605773228e-05,\n                            0.000113132148989689,\n                            0.000134707877688535,\n                            0.000159802770356207,\n                            0.000188831060635101,\n                            0.000222220616172136,\n                            0.000260406329652919,\n                            0.000303822501342455,\n                            0.000352894405052384,\n                            0.000408029291932361,\n                            0.000469607138736220,\n                            0.000537971484397555,\n                            0.000613420717012346,\n                            0.000696200170260968,\n                            0.000786495363254041,\n                            0.000884426671966966,\n                            0.000990045656819256,\n                            0.00110333319401797,\n                            0.00122419947351010,\n                            0.00135248583974960,\n                            0.00148796836886473,\n                            0.00163036300247268,\n                            0.00177933199854958,\n                            0.00193449141630587,\n                            0.00209541932636663,\n                            0.00226166442970644,\n                            0.00243275477746793,\n                            0.00260820630672214,\n                            0.00278753094143541,\n                            0.00297024405006142,\n                            0.00315587109789220,\n                            0.00334395338040985,\n                            0.00353405277061527,\n                            0.00372575545644755,\n                            0.00391867468231596,\n                            0.00411245254041457,\n                            0.00430676088239128,\n                            0.00450130144009080,\n                            0.00469580525584614,\n                            0.00489003152879568,\n                            0.00508376598476375,\n                            0.00527681887426264,\n                            0.00546902269706799,\n                            0.00566022974345871,\n                            0.00585030953239263,\n                            0.00603914621629224,\n                            0.00622663601131579,\n                            0.00641268470143451,\n                            0.00659720525466831,\n                            0.00678011558068493,\n                            0.00696133645079111,\n                            0.00714078959421325,\n                            0.00731839597849908,\n                            0.00749407427684176,\n                            0.00766773952107771,\n                            0.00783930193595848,\n                            0.00800866594795239,\n                            0.00817572936019632,\n                            0.00834038268419216,\n                            0.00850250861833047,\n                            0.00866198166323489,\n                            0.00881866786417196,\n                            0.00897242467128552,\n                            0.00912310090912543,\n                            0.00927053684778657,\n                            0.00941456436890286,\n                            0.00955500722070634,\n                            0.00969168135732249,\n                            0.00982439535839490,\n                            0.00995295092598580,\n                            0.0100771434564557,\n                            0.0101967626856656,\n                            0.0103115934063473,\n                            0.0104214162568379,\n                            0.0105260085805595,\n                            0.0106251453556331,\n                            0.0107186001938462,\n                            0.0108061464078350,\n                            0.0108875581448027,\n                            0.0109626115843740,\n                            0.0110310861972966,\n                            0.0110927660606484,\n                            0.0111474412240244,\n                            0.0111949091198672,\n                            0.0112349760097167,\n                            0.0112674584566989,\n                            0.0112921848131126,\n                            0.0113089967105262,\n                            0.0113177505384268,\n                            0.0113183188962093,\n                            0.0113105920022081,\n                            0.0112944790426064,\n                            0.0112699094424563,\n                            0.0112368340407497,\n                            0.0111952261515405,\n                            0.0111450824935501,\n                            0.0110864239715329,\n                            0.0110192962939277,\n                            0.0109437704129872,\n                            0.0108599427756385,\n                            0.0107679353757622,\n                            0.0106678956013323,\n                            0.0105599958728939,\n                            0.0104444330730885,\n                            0.0103214277703019,\n                            0.0101912232429182,\n                            0.0100540843140268,\n                            0.00991029600965427,\n                            0.00976016205660267,\n                            0.00960400323866978,\n                            0.00944215563234619,\n                            0.00927496874495664,\n                            0.00910280357959258,\n                            0.00892603065203412,\n                            0.00874502798516498,\n                            0.00856017910614212,\n                            0.00837187107080856,\n                            0.00818049253856225,\n                            0.00798643191916143,\n                            0.00779007561081231,\n                            0.00759180634641297,\n                            0.00739200166208871,\n                            0.00719103249922495,\n                            0.00698926194815814,\n                            0.00678704413860025,\n                            0.00658472327881904,\n                            0.00638263284264213,\n                            0.00618109490055963,\n                            0.00598041958862225,\n                            0.00578090470651697,\n                            0.00558283543419087,\n                            0.00538648415471807,\n                            0.00519211036979155,\n                            0.00499996069328840,\n                            0.00481026890781823,\n                            0.00462325606902416,\n                            0.00443913064266381,\n                            0.00425808866014782,\n                            0.00408031387923890,\n                            0.00390597793799397,\n                            0.00373524049173527,\n                            0.00356824932482074,\n                            0.00340514043120267,\n                            0.00324603806015520,\n                            0.00309105472604745,\n                            0.00294029118356310,\n                            0.00279383637223515,\n                            0.00265176733648840,\n                            0.00251414912947358,\n                            0.00238103471075089,\n                            0.00225246484925860,\n                            0.00212846804391863,\n                            0.00200906047463784,\n                            0.00189424599633075,\n                            0.00178401618791290,\n                            0.00167835046701402,\n                            0.00157721627948104,\n                            0.00148056937065387,\n                            0.00138835414298932,\n                            0.00130050410198917,\n                            0.00121694238967068,\n                            0.00113758240212308,\n                            0.00106232848513698,\n                            0.000991076699581642,\n                            0.000923715646228176,\n                            0.000860127338145027,\n                            0.000800188107672747,\n                            0.000743769534340301,\n                            0.000690739379913642,\n                            0.000640962517044585,\n                            0.000594301838671729,\n                            0.000550619136356774,\n                            0.000509775937051074,\n                            0.000471634289304793,\n                            0.000436057491579037,\n                            0.000402910757028366,\n                            0.000372061810820601,\n                            0.000343381417695797,\n                            0.000316743838989650,\n                            0.000292027219722010,\n                            0.000269113907553981,\n                            0.000247890706432206,\n                            0.000228249068561421,\n                            0.000210085228978767,\n                            0.000193300287455012,\n                            0.000177800242732987,\n                            0.000163495984249637,\n                            0.000150303246495171,\n                            0.000138142531060983,\n                            0.000126939001238257,\n                            0.000116622353770586,\n                            0.000107126672055044,\n                            9.83902647429017e-05,\n                            9.03554933280295e-05,\n                            8.29685919400051e-05,\n                            7.61794821899259e-05,\n                            6.99415855580766e-05,\n                            6.42116354698873e-05,\n                            5.89494908845704e-05,\n                            5.41179529225379e-05,\n                            4.96825857848649e-05,\n                            4.56115429716332e-05,\n                            4.18753995858377e-05,\n                            3.84469913150812e-05,\n                            3.53012605134129e-05,\n                            3.24151096588775e-05,\n                            2.97672623369975e-05,\n                            2.73381317946982e-05,\n                            2.51096970211940e-05,\n                            2.30653862402975e-05,\n                            2.11899676406233e-05,\n                            1.94694471245595e-05,\n                            1.78909728220270e-05,\n                            1.64427460894767e-05,\n                            1.51139386969055e-05,\n                            1.38946158946840e-05,\n                            1.27756650465772e-05,\n                            1.17487295145357e-05,\n                            1.08061474837691e-05,\n                            9.94089542255343e-06,\n                            9.14653587951156e-06,\n                            8.41716933119752e-06,\n                            7.74738980422747e-06,\n                            7.13224400855155e-06,\n                            6.56719373140358e-06,\n                            6.04808125473909e-06,\n                            5.57109757234028e-06,\n                            5.13275319605860e-06,\n                            4.72985135372937e-06,\n                            4.35946339402177e-06,\n                            4.01890622579238e-06,\n                            3.70572163133157e-06,\n                            3.41765730418287e-06,\n                            3.15264947295106e-06,\n                            2.90880698267512e-06,\n                            2.68439671492658e-06,\n                            2.47783023680393e-06,\n                            2.28765157743717e-06,\n                            2.11252603851208e-06,\n                            1.95122995268638e-06,\n                            1.80264131062329e-06,\n                            1.66573118373392e-06,\n                            1.53955587562419e-06,\n                            1.42324974070835e-06,\n                            1.31601861350573e-06,\n                            1.21713379680570e-06,\n                            1.12592656119086e-06,\n                            1.04178311237639e-06,\n                            9.64139986475195e-07,\n                            8.92479836657872e-07,\n                            8.26327577763544e-07,\n                            7.65246858252820e-07,\n                            7.08836831496063e-07,\n                            6.56729200776859e-07,\n                            6.08585514578513e-07,\n                            5.64094690726326e-07,\n                            5.22970749794461e-07,\n                            4.84950739867450e-07,\n                            4.49792836284998e-07,\n                            4.17274601406358e-07,\n                            3.87191390718240e-07,\n                            3.59354892787527e-07,\n                            3.33591791636594e-07,\n                            3.09742541102874e-07,\n                            2.87660241643591e-07,\n                            2.67209610868210e-07,\n                            2.48266039831927e-07,\n                            2.30714727809335e-07,\n                            2.14449888893941e-07,\n                            1.99374024341513e-07,\n                            1.85397255097875e-07,\n                            1.72436709429308e-07,\n                            1.60415961009673e-07,\n                            1.49264513216717e-07,\n                            1.38917325753733e-07,\n                            1.29314380045003e-07,\n                            1.20400280156962e-07,\n                            1.12123886274166e-07,\n                            1.04437978012406e-07,\n                            9.72989450826439e-08,\n                            9.06665030307496e-08,\n                            8.45034319711577e-08,\n                            7.87753364089801e-08,\n                            7.34504244063617e-08,\n                            6.84993044962312e-08,\n                            6.38947988812856e-08,\n                            5.96117715791790e-08,\n                            5.56269702874580e-08,\n                            5.19188808446972e-08,\n                            4.84675932584252e-08,\n                            4.52546783565069e-08,\n                            4.22630741973801e-08,\n                            3.94769814465934e-08,\n                            3.68817669929844e-08,\n                            3.44638751381613e-08,\n                            3.22107457481439e-08,\n                            3.01107388065528e-08,\n                            2.81530648549914e-08,\n                            2.63277208486282e-08,\n                            2.46254309937757e-08,\n                            2.30375921697945e-08]\n    \n    \n    \n    #define mathematical functions\n    def trapz(y, x = False, delta = 1, initial = 0.0):\n        '''\n        Integrate along the given axis using the composite trapezoidal rule with delta = 1.\n        '''\n        area = cumtrapz(y, x, delta, initial)\n        return area[len(y)-1]\n    \n    def cumtrapz(y, x = False, delta = 1, initial = 0.0):\n        n_trapz = len(y)\n        if not x:\n            dx = [delta]*n_trapz\n        else:\n            dx = [j-i for i, j in zip(x[:-1], x[1:])] #https://stackoverflow.com/questions/2400840/python-finding-differences-between-elements-of-a-list\n        area = []\n        for i_trapz in range(n_trapz):\n            if i_trapz == 0:\n                area.append(initial)\n            else:\n                area.append( (((y[i_trapz]+y[i_trapz-1])/2)*dx[i_trapz-1]) + area[i_trapz-1] )\n        return area\n    \n    def naive_convolve(g, f):\n        vmax = len(f)\n        smax = len(g)\n        smid = smax // 2\n        xmax = vmax + 2 * smid\n        h = [0]*xmax\n        for x in range(xmax):\n            s_from = max(smid - x, -smid)\n            s_to = min((xmax - x) - smid, smid + 1)\n            value = 0\n            for s in range(s_from, s_to):\n                v = x - smid + s\n                value += g[smid - s] * f[v]\n            h[x] = value\n        return h\n    \n    def lfilter_base(b, a, x):\n        b = [i/a for i in b]\n        y = naive_convolve(b,x)\n        ind = slice(len(y) - len(b) + 1)\n        return y[ind]\n    \n    def effective_irradiance(spectral_irradiance):\n        '''\n        Effective irradiance evaluation\n        Parameters:\n            spectral_irradiance (vec): between 390nm and 700nm and step of 1 nm\n        Returns:\n            eff_irradiance (float) (Amundadottir, 2016)\n        '''\n        n_ieff = len(spectral_irradiance)\n        if n_ieff != 311:\n            return \"Error: Spectral irradiance should be within 390-700nm range!\"\n        for i in range(n_ieff):\n            spectral_irradiance[i] = spectral_irradiance[i]*IPRGC_SENS_WEIGHTING[i]\n        return trapz(spectral_irradiance)*311\n    \n    def filter_sma(filter_length, input_signal):\n        '''\n        Simple moving average (SMA) filter.\n        Parameters:\n            filter_length (int)\n            input_signal (list)\n        Returns:\n            sma_filter (list)\n        '''\n        filter_length = int(filter_length)\n        sma = [1.0/filter_length]*filter_length\n        sma_filter = lfilter_base(sma, sum(sma), input_signal)\n        return sma_filter\n    \n    def filter_ema(filter_length, input_signal):\n        '''\n        Exponential moving average (EMA) filter.\n        Parameters:\n            filter_length (int)\n            input_signal (list)\n        Returns:\n            ema_filter (list)\n        '''\n        filter_length = int(filter_length)\n        alpha = 2.0 / (filter_length + 1.0)\n        a_vec = [1.0-alpha]*filter_length\n        b_vec = range(1,filter_length+1)\n        c_vec = [a**b for a, b in zip(a_vec, b_vec)]\n        ema_filter = lfilter_base(c_vec, sum(c_vec), input_signal) # VERIFIED\n        return ema_filter\n    \n    def relative_response(light_stimuli, sigma, rate_growth):\n        '''\n        Compute relative response.\n        Parameters:\n            light_stimuli (list): irradiance\n            sigma (float): half max. response\n            rate_growth\n        Returns:\n            relative response (list)\n        '''\n        return [1.0/(1.0+(s/ls)**rate_growth) if ls!=0 else 0.0 for s, ls in zip(sigma,light_stimuli)]\n    \n    def adaptive_response(I, Ieff, sigma, n, d, FLOOR):\n        '''\n        Compute adaptive response.\n        Parameters:\n            I: light stimuli [W/m2 eff.]\n            sigma: half max. response\n            n: rate growth\n            d: filter length\n            FLOOR: boolean\n        Returns:\n            r: relative response\n        '''\n        H = filter_sma(d, [math.log10(i*118.5*2.2) if i!=0 else 0.0 for i in I]) #VERIFIED\n        H = [0 if h<0.0 else h for h in H] #VERIFIED\n        # print H #VERIFIED\n        if FLOOR == 1:\n            H = [math.floor(h) if h>0.0 else h for h in H] #VERIFIED\n        sigma = [sigma*2.0**(h-1) for h in H] #VERIFIED\n        return relative_response(Ieff, sigma, n)\n    \n    def direct_response(eff_irradiance, delta):\n        '''\n        Direct relative response model\n        Parameters:\n            eff_irradiance\n        Returns:\n            RD_p: relative response during photoperiod\n        '''\n        if delta > 0.3:\n            return \"Error: Step size must be smaller or equal to 0.3\"\n        # Spectral sensitivity\n        zeff = 310.0/683.0/118.5/1.42*0.91  # from lux to melanopic eff. irr (F11)\n        # Intensity response\n        EI50 = 106  # [lx]\n        slope = 3.55\n        # Filter L2\n        dFL2 = round(2.3/delta)\n        # Filter L1\n        dFL1 = round(0.3/delta)\n        # Filter LH\n        dFLH = round(1.7/delta)\n        # MODEL\n        u = filter_sma(dFL1, eff_irradiance) # VERIFIED\n        v = adaptive_response(eff_irradiance, u, EI50*zeff, slope, dFLH, 0) # VERIFIED\n        RD = filter_ema(dFL2, v) # VERIFIED\n        n_RD = len(RD)\n        RD_p = []\n        for i in range(n_RD):\n            if eff_irradiance[i] > 0.0:\n                RD_p.append(RD[i])\n            else:\n                RD_p.append(0)\n        return RD_p\n    \n    \n    \n    if calculate != True:\n        pass\n    else:\n        #run the nvRD model\n        file = spectral_data\n        with open(file,'r') as csv_file:\n            csv_reader = csv.reader(csv_file, delimiter=',', quotechar='\"')\n            next(csv_reader) # skip the headings\n            pts = []\n            vecs = []\n            month = []\n            day = []\n            pts_vecs_date = []\n            hour = []\n            data = []\n            eff_irradiance_timeseries = []\n            for line in csv_reader:\n                pts.append(\",\".join(line[:3]))\n                vecs.append(\",\".join(line[3:6]))\n                month.append(\"%02d\" % int(line[6])) # 2-digit number (needed for sorting)\n                day.append(\"%02d\" % int(line[7])) # 2-digit number (needed for sorting)\n                pts_vecs_date.append(\",\".join([\",\".join(line[:3]), \",\".join(line[3:6]), \"%02d\" % int(line[6]), \"%02d\" % int(line[7])]))\n                hour.append(float(line[8]))\n                data.append(\",\".join(line[12:]))\n            n = len(data)\n            for i in range(n):\n                wl = [float(x) for x in data[i].split(\",\")]\n                eff_irradiance_timeseries.append(effective_irradiance(wl[10:-80]))\n            zipped = zip(pts_vecs_date,hour,data,eff_irradiance_timeseries)\n            zipped.sort()\n            Dict = dict()\n            effIrrDict = dict()\n            hourDict = dict()\n            for item in zipped:\n                key = item[0] # points and vectors\n                if key in effIrrDict: # if the id exists in the dictionary\n                    # the id is the key and the value is the id,time,data\n                    Dict[key].append(item)\n                    effIrrDict[key].append(item[3])\n                    hourDict[key].append(item[1])\n                else:\n                    # the first time that the id appears\n                    Dict[key]     = [item]\n                    effIrrDict[key] = [item[3]]\n                    hourDict[key] = [item[1]]\n            \n            for key in list(set(pts_vecs_date)): # identify unique orientations\n                rD = direct_response(effIrrDict[key], 0.1)\n                RD = cumtrapz(rD, hourDict[key], initial=0.0)\n                Dict[key] = [old + (new1,new2,) for old, new1, new2 in zip(Dict[key], rD, RD)]\n                \n            oDict = collections.OrderedDict(sorted(Dict.items()))\n        \n        \n        \n        #put the values in a data tree structure to use them in GH\n        result = DataTree[str]()\n        pathCount = 0 \n        keys = oDict.keys()\n        for key in keys:\n            subPathCount = 0\n            for index, row in enumerate(oDict[key]):\n                new_sub_path = GH_Path(pathCount, subPathCount)\n                for v in row:\n                    result.Add(str(v), new_sub_path)\n                subPathCount +=1\n            pathCount += 1\n",
  "language": "python",
  "imports": [
    "rhinoscriptsyntax",
    "scriptcontext"
  ],
  "has_docstring": true
}