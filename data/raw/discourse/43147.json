{
  "source_url": "https://discourse.mcneel.com/t/extrude-from-an-open-and-non-planar-polysurface/43147",
  "topic_id": 43147,
  "title": "Extrude from an open and non-planar Polysurface",
  "question": "Hi guys!\n\nI wrote this macro for Extrusion.\n\n\nI almost completely automated the process. Except for _Move\n\nWhat can be added in order for the “extrusion cap” to automatically moving to the “extrusion sides”?\n\n\n_Select\n_Pause\n-Properties _Object _Color _Object 100,170,230 _Name ExtrudeCap _EnterEnd\n_Pause\n_DupBorder\n_Pause\n_ExtrudeCrv _Pause _Solid=Yes _DeleteInput=Yes\n_Pause\n_SelLast\n-Properties _Object _Color _Object 100,170,230 _Name ExtrudeSides _EnterEnd\n_SelNone\n-SelName ExtrudeCap\n_Copy _Pause _InPlace\n_Sellast\n_Move\n_Pause\n_Pause\n_Pause\n_SelColor\n_Join\n-Properties _Object _Color _Layer _Name ExtrudePolySrf _EnterEnd\n_SelNone",
  "code_blocks": [
    {
      "code": "_-RunPythonScript (\n\"\"\"\nExtrudePolySurface\n\nAuthor: leex\nDate: 15.11.2025\nRhino: 8\n\nDescription:\nCreates extruded solid bodies from selected surfaces and polysurfaces\n\nFeatures:\n- Extrude multiple objects at once\n- Add top and bottom caps\n- Preserve names, colors, and layers of the original objects\n- Interactive selection of extrusion direction\n- Works with surfaces, polysurfaces, planar and freeform geometry\n\"\"\"\n\nimport rhinoscriptsyntax as rs\nimport scriptcontext as sc\nimport Rhino\nimport time\n\ndef get_bbox_center(obj_id):\n    robj = sc.doc.Objects.Find(obj_id)\n    if not robj: return None\n    geo = robj.Geometry\n    bb = geo.GetBoundingBox(True)\n    return bb.Center\n\ndef to_vec_tuple(v):\n    return (v.X, v.Y, v.Z)\n\ndef is_planar_surface(obj_id):\n    surface = rs.coercesurface(obj_id)\n    if not surface: return False\n    return surface.IsPlanar()\n\ndef get_plane_normal(obj_id):\n    surface = rs.coercesurface(obj_id)\n    if not surface: return None\n    if surface.IsPlanar():\n        success, plane = surface.TryGetPlane()\n        if success:\n            return plane.ZAxis\n    return None\n\ndef main():\n    objs = rs.GetObjects(\"Select surface(s)/polysurface(s)\", rs.filter.surface | rs.filter.polysurface, preselect=True)\n    if not objs:\n        print(\"Nothing selected.\")\n        return\n\n    original_colors = {obj: rs.ObjectColor(obj) for obj in objs}\n    original_layers = {obj: rs.ObjectLayer(obj) for obj in objs}\n    temp_objs = []\n\n    planar_objects = [obj for obj in objs if is_planar_surface(obj)]\n    has_planar = len(planar_objects) > 0\n    only_planar = len(planar_objects) == len(objs)\n    planar_normal = get_plane_normal(planar_objects[0]) if has_planar else None\n\n    prev_redraw = sc.doc.Views.RedrawEnabled\n    sc.doc.Views.RedrawEnabled = False\n\n    try:\n        rs.UnselectAllObjects()\n        rs.SelectObjects(objs)\n        pre_all = set(rs.AllObjects() or [])\n\n        rs.Command(\"_-DupBorder\")\n        time.sleep(0.05)\n\n        post_dup = set(rs.AllObjects() or [])\n        dup_curves = [g for g in post_dup - pre_all if rs.IsCurve(g)]\n        if not dup_curves:\n            print(\"No border curves created.\")\n            return\n        temp_objs.extend(dup_curves)\n\n        curve_centers = [get_bbox_center(c) for c in dup_curves if get_bbox_center(c)]\n        if not curve_centers:\n            print(\"Could not calculate curve centers.\")\n            return\n\n        avg_curve_center = Rhino.Geometry.Point3d(\n            sum([c.X for c in curve_centers])/len(curve_centers),\n            sum([c.Y for c in curve_centers])/len(curve_centers),\n            sum([c.Z for c in curve_centers])/len(curve_centers)\n        )\n\n        sc.doc.Views.RedrawEnabled = True\n        rs.UnselectAllObjects()\n        rs.SelectObjects(dup_curves)\n\n        if only_planar and planar_normal:\n            print(\"Using normal for extrusion...\")\n            cmd = \"! _ExtrudeCrv _Solid=No _Direction {} {} {}\".format(planar_normal.X, planar_normal.Y, planar_normal.Z)\n            rs.Command(cmd)\n        else:\n            print(\"Specify ExtrudeCrv direction now (number or click)...\")\n            rs.Command(\"_-ExtrudeCrv _Solid=No\")\n\n        sc.doc.Views.RedrawEnabled = False\n\n        post_extrude = set(rs.AllObjects() or [])\n        new_extrusions = [g for g in post_extrude - pre_all if sc.doc.Objects.Find(g) and (rs.IsBrep(g) or rs.IsSurface(g))]\n        if not new_extrusions:\n            print(\"Extrusion failed.\")\n            return\n        temp_objs.extend(new_extrusions)\n\n        for e in new_extrusions:\n            if rs.IsObject(e):\n                rs.ObjectColor(e, original_colors[objs[0]])\n                rs.ObjectLayer(e, original_layers[objs[0]])\n\n        centers_after = [get_bbox_center(g) for g in new_extrusions if get_bbox_center(g)]\n        if not centers_after:\n            print(\"Could not calculate extrusion centers.\")\n            return\n\n        avg_extr_center = Rhino.Geometry.Point3d(\n            sum([c.X for c in centers_after])/len(centers_after),\n            sum([c.Y for c in centers_after])/len(centers_after),\n            sum([c.Z for c in centers_after])/len(centers_after)\n        )\n        vector = avg_extr_center - avg_curve_center\n        full_vector = vector * 2\n        vec_tuple = to_vec_tuple(full_vector)\n\n        top_copies = rs.CopyObjects(objs)\n        if top_copies:\n            rs.MoveObjects(top_copies, vec_tuple)\n            temp_objs.extend(top_copies)\n            for t in top_copies:\n                if rs.IsObject(t):\n                    rs.ObjectColor(t, original_colors[objs[0]])\n                    rs.ObjectLayer(t, original_layers[objs[0]])\n        else:\n            top_copies = []\n\n        if only_planar:\n            join_list = new_extrusions + top_copies\n        else:\n            join_list = new_extrusions + list(objs) + top_copies\n\n        valid_join_list = [obj for obj in join_list if rs.IsObject(obj)]\n        rs.UnselectAllObjects()\n        if len(valid_join_list) >= 2:\n            rs.SelectObjects(valid_join_list)\n            join_result = rs.Command(\"_-Join\")\n            if join_result:\n                print(\"Successfully joined all surfaces into a solid!\")\n            else:\n                print(\"Join failed, surfaces created but not unified.\")\n        else:\n            print(\"Not enough objects to join. Found: {}\".format(len(valid_join_list)))\n\n        for c in dup_curves:\n            if rs.IsObject(c):\n                rs.DeleteObject(c)\n                if c in temp_objs:\n                    temp_objs.remove(c)\n        print(\"Done. Solid with top and bottom surfaces, colors/layer preserved.\")\n\n    finally:\n        for obj in temp_objs:\n            if rs.IsObject(obj):\n                try: rs.DeleteObject(obj)\n                except: pass\n        sc.doc.Views.RedrawEnabled = prev_redraw\n        sc.doc.Views.Redraw()\n        rs.UnselectAllObjects()\n\nmain()\n)",
      "language": "python",
      "author": "leex",
      "post_number": 9,
      "is_solution": true
    }
  ],
  "tags": [
    "file-io",
    "geometry",
    "layers",
    "python",
    "rhinocommon",
    "rhinoscriptsyntax",
    "selection",
    "transformation"
  ],
  "has_accepted_answer": true,
  "category_id": 11,
  "posts_count": 9,
  "views": 1126
}