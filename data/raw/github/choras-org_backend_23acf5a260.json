{
  "source_url": "https://github.com/choras-org/backend/blob/83981cdf4fc703fdcefe1b8c57625423a98db039/app/factory/geometry_converter_factory/ObjConversion.py",
  "repo": "choras-org/backend",
  "repo_stars": 6,
  "repo_description": "CHORAS backend",
  "license": "unknown",
  "filepath": "app/factory/geometry_converter_factory/ObjConversion.py",
  "instruction": "Obj conversion",
  "code": "import logging\nimport os\n\nimport numpy as np\nimport rhino3dm\nimport trimesh\n\nfrom app.factory.geometry_converter_factory.GeometryConversionStrategy import (\n    GeometryConversionStrategy,\n)\n\n\nclass ObjConversion(GeometryConversionStrategy):\n    # Create logger for this module\n    logger = logging.getLogger(__name__)\n\n    def generate_3dm(self, obj_file_path, rhino_path):\n        \"\"\"\n        This method combines cleaning and converting an OBJ file to 3DM format.\n        It first cleans the OBJ file and then converts it to the 3DM format.\n\n        :param obj_file_path: Path to the original OBJ file\n        :param rhino_path: Path to save the converted 3DM file\n        :return: Path to the converted 3DM file if successful, otherwise None\n        \"\"\"\n        # Extract the directory path and file name\n        dir_path, file_name = os.path.split(obj_file_path)\n\n        # Generate the cleaned file path by appending '_clean' before the extension\n        base_name, ext = os.path.splitext(file_name)\n        obj_clean_path = os.path.join(dir_path, f\"{base_name}_clean{ext}\")\n\n        try:\n            # Clean the OBJ file\n            self._clean_obj_file(obj_file_path, obj_clean_path)\n\n            # Convert the cleaned OBJ file to 3DM\n            return self._convert_obj_to_3dm(obj_clean_path, rhino_path)\n\n        except Exception as ex:\n            self.logger.error(f\"Error processing OBJ to 3DM: {ex}\")\n            return None\n\n    def _clean_obj_file(self, obj_file_path, obj_clean_path):\n        with open(obj_file_path, \"r\") as infile, open(obj_clean_path, \"w\") as outfile:\n            lines = infile.readlines()\n            current_material = None\n            custom_material_counter = 1\n\n            for line in lines:\n                if line.startswith(\"usemtl\"):\n                    current_material = line.strip()\n                elif line.startswith(\"f\"):\n                    if current_material:\n                        outfile.write(current_material + \"\\n\")\n                    else:\n                        custom_material = f\"usemtl M_{custom_material_counter}\\n\"\n                        outfile.write(custom_material)\n                        current_material = custom_material.strip()\n                        custom_material_counter += 1\n                    outfile.write(line)\n                else:\n                    outfile.write(line)\n\n    def _convert_obj_to_3dm(self, obj_clean_path, rhino_path):\n        # Load the OBJ file using trimesh\n        scene = trimesh.load(\n            obj_clean_path,\n            group_material=False,\n            skip_materials=False,\n            maintain_order=True,\n            Process=False,\n        )\n\n        # Create a new 3dm file\n        model = rhino3dm.File3dm()\n\n        # Parse OBJ materials\n        material_map = _parse_obj_materials(obj_clean_path)\n\n        # Check if the loaded object is a scene with multiple geometries\n        if isinstance(scene, trimesh.Scene):\n            meshes = scene.dump(False)\n            meshes.reverse()\n        else:\n            meshes = [scene]\n\n        # Define a 90-degree rotation matrix around the X-axis\n        rotation_matrix = np.array([[1, 0, 0], [0, 0, -1], [0, 1, 0]])\n\n        for mesh_index, mesh in enumerate(meshes):\n            vertices = mesh.vertices\n            faces = mesh.faces\n\n            rhino_mesh = rhino3dm.Mesh()\n\n            for vertex in vertices:\n                rotated_vertex = np.dot(rotation_matrix, vertex)\n                rhino_mesh.Vertices.Add(\n                    rotated_vertex[0], rotated_vertex[1], rotated_vertex[2]\n                )\n\n            for face_index, face in enumerate(faces):\n                if len(face) == 3:  # Triangular face\n                    rhino_mesh.Faces.AddFace(face[0], face[1], face[2])\n                elif len(face) == 4:  # Quad face\n                    rhino_mesh.Faces.AddFace(face[0], face[1], face[2], face[3])\n\n            rhino_mesh.SetUserString(\"material_name\", str(material_map[mesh_index]))\n            model.Objects.AddMesh(rhino_mesh)\n\n        # Save the 3dm file\n        model.Write(rhino_path)\n        return rhino_path\n\n\ndef _parse_obj_materials(obj_path):\n    material_map = {}\n    face_index = 0\n\n    with open(obj_path, \"r\") as f:\n        for line in f:\n            line = line.strip()\n            if line.startswith(\"usemtl\"):\n                material_map[face_index] = line.split()[1]\n                face_index += 1\n    return material_map\n",
  "language": "python",
  "imports": [
    "rhino3dm"
  ],
  "has_docstring": false
}