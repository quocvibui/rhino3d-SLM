{
  "source_url": "https://github.com/BlockResearchGroup/compas-Masonry/blob/41cf6ce10135782dcef8de413281702f3702775e/commands/DEA_import.py",
  "repo": "BlockResearchGroup/compas-Masonry",
  "repo_stars": 4,
  "repo_description": "Rhino plugin for the design and equilibrium analysis of block models and for the stability assessment of (historic) masonry structures.",
  "license": "NOASSERTION",
  "filepath": "commands/DEA_import.py",
  "instruction": "venv: brg-csd r: compas_masonry>=0.2.7",
  "code": "#! python3\n# venv: brg-csd\n# r: compas_masonry>=0.2.7\n\nimport pathlib\n\nimport rhinoscriptsyntax as rs  # type: ignore\n\nimport compas\nimport compas_rhino.layers\nfrom compas_dem.elements import Block\nfrom compas_dem.interactions import FrictionContact\nfrom compas_dem.models import BlockModel\nfrom compas_masonry.session import MasonrySession as Session\nfrom compas_model.models import InteractionGraph\nfrom compas_rui import feedback\nfrom compas_rui.forms import FileForm\n\n\ndef RunCommand():\n    session = Session(basedir=pathlib.Path().home() / \".compas_session\", name=\"COMPAS-Masonry\")\n\n    path = rs.DocumentPath()  # to make sure the document has a path\n    if path:\n        basedir = pathlib.Path(path).parent\n    else:\n        basedir = pathlib.Path().home()\n\n    filepath = FileForm.open(str(basedir))\n    if not filepath:\n        return\n\n    try:\n        result = compas.json_load(filepath)\n    except Exception as e:\n        feedback.warn(f\"Failed to load datafrom {filepath}: {e}\")\n        return\n\n    if not isinstance(result, BlockModel):\n        feedback.warn(f\"The data in the file is not a BlockModel: {type(result)}\")\n        return\n\n    # =============================================================================\n    # Clear existing model\n    # =============================================================================\n\n    session.delete(\"blockmodel\")\n\n    for obj in session.scene.find_all_by_itemtype(Block):\n        session.scene.remove(obj)\n\n    for obj in session.scene.find_all_by_itemtype(FrictionContact):\n        session.scene.remove(obj)\n\n    for obj in session.scene.find_all_by_itemtype(InteractionGraph):\n        session.scene.remove(obj)\n\n    compas_rhino.layers.clear_layer(\"Masonry::DEA::Blocks\")\n    compas_rhino.layers.clear_layer(\"Masonry::DEA::Interactions\")\n    compas_rhino.layers.clear_layer(\"Masonry::DEA::Contacts\")\n\n    # =============================================================================\n    # Add new model\n    # =============================================================================\n\n    model: BlockModel = result\n    session[\"blockmodel\"] = model\n\n    # =============================================================================\n    # Update scene\n    # =============================================================================\n\n    # this should be simplifed by adding a helper method to the session\n\n    for block in model.elements():\n        node = block.graphnode\n        session.scene.add(\n            block,  # type: ignore\n            name=f\"Block_{node}\",  # type: ignore\n            group=f\"Masonry::DEA::Blocks::{node}\",  # type: ignore\n            layer=\"Masonry::DEA::Blocks\",  # type: ignore\n        )\n\n    if model.graph.number_of_edges() > 0:\n        session.scene.add(model.graph, layer=\"Masonry::DEA::Interactions\")  # type: ignore\n\n        for contact in model.contacts():\n            session.scene.add(contact, layer=\"Masonry::DEA::Contacts\")  # type: ignore\n\n    session.scene.redraw()\n\n    rs.Redraw()\n\n\n# =============================================================================\n# Run as main\n# =============================================================================\n\nif __name__ == \"__main__\":\n    RunCommand()\n",
  "language": "python",
  "imports": [
    "rhinoscriptsyntax"
  ],
  "has_docstring": true
}