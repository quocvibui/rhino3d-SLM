{
  "source_url": "https://discourse.mcneel.com/t/how-to-get-viewport-bitmap-of-raytraced-through-rhino-common/208424",
  "topic_id": 208424,
  "title": "How to get viewport bitmap of raytraced through Rhino common?",
  "question": "Hi \n@nathanletwory\n\n\nCan you please explain to me how I can capture the viewport bitmap from Cycles with Rhino Common?\n\n\nWhen I run this script that works for other display modes all I get is a white image. And it doesnâ€™t matter if raytraced is running or not.\n\n\n#! python 3\n\nimport scriptcontext as sc\nimport rhinoscriptsyntax as rs\nimport System\n\nSaveFileName = rs.SaveFileName(title=\"File name\", filter=\"JPEG (*.jpg)|*.jpg||\")\nif SaveFileName:\n    print(SaveFileName)\n    bitmap = sc.doc.Views.ActiveView.CaptureToBitmap()\n    bitmap.Save(SaveFileName, System.Drawing.Imaging.ImageFormat.Jpeg)\n\n\n\nI can work around this by using\n\n\nrs.Command(\"-ViewCaptureToFile NumberOfPasses=1 \" + save_path + \" Enter\", False)\n\n\n\nAnd then read that file back in to python, but it is a slow workaround that I would like to avoid.",
  "code_blocks": [
    {
      "code": "# Display regression script.\n# Usage:\n#     Set action to \"setup\" and run this script in the reference\n#     copy of Rhino. This will generate a series of \"* - reference.png\"\n#     files.\n#     \n#     Then, set action to \"test\" and run in your target copy of Rhino.\n#     \n#     At the end you will see \"x of y passed tests\" plus a list of all tests that failed.\n#     \n#     All resulting images are in the \"Results\" folder.\n#     \n#     To add test cases, add:\n#         * 3DM files to the \"Objects\" folder. Objects in the model\n#           that should have materials asigned must be named \"material_target\"\n#         * DisplayMode.ini files to the \"DisplayModes\" folder\n#         * Material.rmtl files to the \"Materials\" folder\n#\n#  IMPORTANT!!!\n#     Make sure that ALL built-in display modes have been set to their defaults\n#     in both situations (i.e.) Confirm they're at their defaults before running\n#     \"Setup\" phase, and confirm they're at their defaults before running the\n#     \"Test\" phase.  Since setup and test can be run at different points in time\n#     and even on different configurations, it is impotant that you make sure\n#     you're running regression tests using the EXACT same display settings...\n#     otherwise, it's possible that some, or even all, tests will fail\n#\n\naction = 'setup'  # To be run in known \"good\" instance of Rhino.\n#action = 'test'   # To be run in the Rhino to test.\n#action = 'db'     # Setup or update the test database.\n\nsamples = 100\n\n# match_amount controls how much the test frames must match the reference frames\n# This number is the number of different pixels divided by the total number\n# of pixels in the frame. When all are identical, this number is 1.000. When\n# all are different, this number is 0.000. Frames must match more than this much\n# for the tests to pass:\nmatch_amount = 0.999 \nstandard_res = (900,450)\nhigh_res = (standard_res[0]*4, standard_res[1]*4)\nimport clr\n\nclr.AddReference(\"System.Xml.Linq\")\n\nimport System.Xml.Linq as xml\n\nimport os, math\nimport Rhino\nimport System.Drawing\nimport time\nimport scriptcontext as sc\nimport itertools\nimport collections\nimport hashlib\nimport webbrowser\nfrom Rhino.Display import ViewCapture\n\nthis_dir = str(os.path.dirname(os.path.realpath(__file__)))\nmodel_dir = str(os.path.join(this_dir, \"Objects\"))\noutput_dir = str(os.path.join(this_dir, \"Results\"))\n\nbgstyle = sc.doc.RenderSettings.BackgroundStyle # SolidColor, Gradient, Environment\nprogramContext = Rhino.Render.RenderContent.ChangeContexts.Program\n\ncolEnvs = [\"color1.renv\", \"color2.renv\", \"color3.renv\"]\nhdrEnvs = [\"hdr1.renv\", \"hdr2.renv\", \"hdr3.renv\"]\nplanarEnvs = [\"planar1.renv\", \"planar2.renv\", \"planar3.renv\"]\n\ngpChoices = [\n    (True, \"shadows-only\"),\n    (True, \"material\"),\n    (False, \"disabled\")]\nenvBgChoices = [\n    (bgstyle.Environment, hdrEnvs[0]),\n    (bgstyle.Environment, planarEnvs[0]),\n    (bgstyle.Environment, colEnvs[0]),\n    (bgstyle.Gradient, \"gradient\"),\n    (bgstyle.SolidColor, \"solid\")]\ncustReflectChoices = [\n    (True, hdrEnvs[1]),\n    (True, planarEnvs[1]),\n    (True, colEnvs[1]),\n    (False, \"no-custom-reflection\")]\nskylightChoices = [\n    (False,\"no-skylight\"),\n    (True, hdrEnvs[1]),\n    (True, hdrEnvs[2]),\n    (True, planarEnvs[1]),\n    (True, planarEnvs[2]),\n    (True, colEnvs[1]),\n    (True, colEnvs[2]),\n    (True, \"no-custom-skylight\")]\nsunChoices = [(True, \"sun\"), (False, \"no-sun\")]\n\npossibleWorlds = [\n    x\n    for x\n    in itertools.product(\n        gpChoices,\n        envBgChoices,\n        custReflectChoices,\n        skylightChoices,\n        sunChoices)\n]\npossibleWorldsSha1 = hashlib.sha1()\npossibleWorldsSha1.update(\"{0}\".format(possibleWorlds))\npossibleWorldsName = possibleWorldsSha1.hexdigest()\n\ndef irange(a, b):\n    \"\"\"\n    Range from a to b inclusive.\n    \"\"\"\n    return range(a, b+1)\n\ndef flatten(l):\n    \"\"\"\n    flatten a list that can contain nested lists.\n    \"\"\"\n    for el in l:\n        if isinstance(el, collections.Iterable) and not isinstance(el, basestring):\n            for sub in flatten(el):\n                yield sub\n        else:\n            yield el\n\ndef test_ids(l, max):\n    \"\"\"\n    Generate index list from test ids. Can be used to generate broken sequences.\n    ranges tests_to_run = test_ids([irange(1,3), irange(6,10)], len(possibleWorlds))\n    will yield [1,2,3,6,7,8,9,10]\n    \"\"\"\n    ids = [x-1 for x in flatten(l) if (x-1)>=0 and x<=max]\n    ids = collections.OrderedDict((x, True) for x in ids).keys()\n    return ids\n\ndef colordiff(colora, colorb):\n    a = Rhino.Display.ColorLAB(colora)\n    b = Rhino.Display.ColorLAB(colorb)\n    lsq = (a.L-b.L)**2\n    asq = (a.A-b.A)**2\n    bsq = (a.B-b.B)**2\n    delta_e = math.sqrt(lsq+asq+bsq)\n    return delta_e\n\ndef compare_images(a, b):\n    '''Compare two System.Drawing.Bitmap images'''\n    pixel_count = 0\n    identical_pixel_count = 0\n    errorbmp = System.Drawing.Bitmap(b.Width, b.Height)\n    for x in range(0, b.Width):\n        for y in range(0, b.Height):\n            pixel_count += 1\n            a_color = a.GetPixel(x,y)\n            b_color = b.GetPixel(x,y)\n            if a_color == b_color:\n                identical_pixel_count += 1\n                errorbmp.SetPixel(x,y, System.Drawing.Color.FromArgb(0,0,0))\n            else:\n                delta_e = colordiff(a_color, b_color)\n                pcol = int(255.0 * delta_e)\n                errorbmp.SetPixel(x,y, System.Drawing.Color.FromArgb(pcol, pcol, pcol))\n                if(delta_e < 0.6):\n                    identical_pixel_count += 1\n            \n    \n    # Compute percent difference between two images\n    return (float(identical_pixel_count) / float(pixel_count), errorbmp)\n\n\ndef capture_viewport(display_mode, resolution):\n    view = sc.doc.Views.ActiveView\n    if display_mode:\n        Rhino.RhinoApp.RunScript(\"-_SetDisplayMode _Mode={0}\".format(display_mode), False)\n    else:\n        Rhino.RhinoApp.RunScript(\"-_line 0,0 1,1 sellast delete\", False)\n        view.Redraw()\n\n    vc = ViewCapture()\n    vc.Width = resolution[0]\n    vc.Height = resolution[1]\n    vc.RealtimeRenderPasses = samples\n    return vc.CaptureToBitmap(view)\n\n\ndef get_renv(name):\n    name = name.replace(\".renv\", \"\")\n    doc = sc.doc\n    for e in doc.RenderEnvironments:\n        if e.Name == name: return e\n    return None\n\ndef xn(s):\n    \"\"\"\n    Shorthand for xml.XName.Get(s).\n    \"\"\"\n    return xml.XName.Get(s)\n    \ndef xel(*args):\n    \"\"\"\n    Shorthand for xml.XElement(*args).\n    \"\"\"\n    return xml.XElement(*args)\n\ntrue = \"true\"\nfalse = \"false\"\n\ndef cleanpath(p):\n    if os.path.exists(p):\n        os.unlink(p)\n\nclass TestCase:\n    \"\"\"\n    TestCase represents a collection of settings that constitute one\n    test case (or setup thereof).\n    \"\"\"\n    def __init__(self, id, model_path, action, display_modes, world, resolution):\n        \"\"\"\n        Initialize a new TestCase.        \n        id (int) - is a numerical rank index.\n        model_path(str) - the path to the model to use for testing\n        action (str) - either 'test' or 'setup'. Setup creates captures, test creates several captures and compares them with\n                       captures created in setup.\n        display_mode (str) - a string representing a display mode to test with\n        world (tuple) - a tuple containing settings for the world\n        resolution (tuple) - a tuple containing the resolution at which to create the capture at.\n        \"\"\"\n        self.id = id\n        self.model_path = model_path\n        self.action = action\n        self.display_modes = display_modes\n        self.world = world\n        self.resolution = resolution\n\n        sh = hashlib.sha1()\n        _fnm = os.path.splitext(os.path.basename(self.model_path))[0]\n        sh.update(\"{0}\".format((_fnm, self.world)))\n        self.name = sh.hexdigest()\n        self.reference_image_name = dict()\n        self.test1_image_name = dict()\n        self.test1_error_name = dict()\n        self.test2_image_name = dict()\n        self.test2_error_name = dict()\n        self.timings = dict()\n        self.reference_compares = dict()\n        for dm in self.display_modes:\n            self.reference_image_name[dm] = \"{0:06d}_{1}_{2}_{3}x{4}_reference.png\".format(self.id, self.name, dm, self.resolution[0], self.resolution[1])\n            self.test1_image_name[dm] = \"{0:06d}_{1}_{2}_{3}x{4}_test1.png\".format(self.id, self.name, dm, self.resolution[0], self.resolution[1])\n            self.test1_error_name[dm] = \"{0:06d}_{1}_{2}_{3}x{4}_error.png\".format(self.id, self.name, dm, self.resolution[0], self.resolution[1])\n            self.test2_image_name[dm] = \"{0:06d}_{1}_{2}_{3}x{4}_test2.png\".format(self.id, self.name, dm, self.resolution[0], self.resolution[1])\n            self.test2_error_name[dm] = \"{0:06d}_{1}_{2}_{3}x{4}_error.png\".format(self.id, self.name, dm, self.resolution[0], self.resolution[1])\n            self.timings[dm] = -1.0\n\n        if len(self.display_modes)>1:\n            combos = list(itertools.combinations(self.display_modes, 2))\n            for combo in combos:\n                pass\n\n\n        self.bakefile_name = \"{0:06d}_{1}.3dm\".format(self.id, self.name)\n\n        self.cf = -1.0\n\n\n    def prepare_model(self):\n        \"\"\"\n        Load the model from filename. Environments (.renv) will be imported. The\n        model will be changed according the settings given in world.\n\n        The image name for the model will be returned.\n        \"\"\"\n        doc = sc.doc\n        doc.Open(self.model_path)\n\n        doc = sc.doc\n        view = doc.Views.ActiveView\n\n        if self.world:\n            envdir = os.path.dirname(self.model_path)\n\n            # import test environments\n            for f in os.listdir(envdir):\n                if not f.lower().endswith(\".renv\"): continue\n                \n                envimp = os.path.join(envdir, f)\n                Rhino.RhinoApp.RunScript(\"\"\"-_Environments\n                Options\n                LoadFromFile\n                \"{0}\"\n                Enter\n                Enter\n                \"\"\".format(envimp), False)\n\n            doc.UndoRecordingEnabled = False\n\n            # set up ground plane\n            gpsettings = self.gp_settings()\n            gp = doc.GroundPlane\n            gp.BeginChange(programContext)\n            gp.Enabled = gpsettings[0]\n            gp.ShadowOnly = gpsettings[1]==\"shadows-only\"\n            gp.EndChange()\n\n            # set bg\n            bgsettings = self.bg_settings()\n            rendersettings = doc.RenderSettings\n            rendersettings.BackgroundStyle = bgsettings[0]\n            if bgsettings[0] == bgstyle.Environment:\n                #print(\"setting environment to\", bgsettings[1])\n                doc.CurrentEnvironment.ForBackground = get_renv(bgsettings[1])\n            else:\n                doc.CurrentEnvironment.ForBackground = None\n\n            # set custom reflection\n            reflsettings = self.refl_settings()\n            if reflsettings[0]:\n                doc.CurrentEnvironment.ForReflectionAndRefraction = get_renv(reflsettings[1])\n            else:\n                doc.CurrentEnvironment.ForReflectionAndRefraction = None\n\n            # set skylight\n            skysettings = self.sky_settings()\n            skylight = doc.Lights.Skylight\n            skylight.BeginChange(programContext)\n            skylight.Enabled = skysettings[0]\n            skylight.EndChange()\n            if skysettings[0]:\n                skyenv = get_renv(skysettings[1])\n                print(\"setting sky env {0} [{1}]\".format(skysettings[0], skyenv))\n                doc.CurrentEnvironment.ForLighting = get_renv(skysettings[1])\n            else:\n                print(\"no sky\")\n                doc.CurrentEnvironment.ForLighting = None\n\n            # set sun\n            sunsettings = self.sun_settings()\n            sun = doc.Lights.Sun\n            sun.BeginChange(programContext)\n            sun.Enabled = sunsettings[0]\n            if sun.Enabled:\n                sun.SetPosition(120, 45)\n            sun.EndChange()\n\n        Rhino.RhinoApp.RunScript(\"-_line 0,0 1,1 sellast delete\", False)\n        view.Redraw()\n\n    def gp_settings(self):\n        \"\"\"\n        Get the groundplane settings from the world settings.\n        \"\"\"\n        return self.world[0]\n\n    def bg_settings(self):\n        \"\"\"\n        Get the background (render) settings from the world settings.\n        \"\"\"\n        return self.world[1]\n\n    def refl_settings(self):\n        \"\"\"\n        Get the custom reflection environment settings from the world settings.\n        \"\"\"\n        return self.world[2]\n\n    def sky_settings(self):\n        \"\"\"\n        Get the skylight settings from the world settings.\n        \"\"\"\n        return self.world[3]\n\n    def sun_settings(self):\n        \"\"\"\n        Get the sun settings from the world settings.\n        \"\"\"\n        return self.world[4]\n\n    def gp_xml(self):\n        \"\"\"\n        Create ground plane XML representation for database.\n        \"\"\"\n        gps = self.gp_settings()\n        g = xel(xn(\"groundplane\"),\n                xel(\"enabled\", gps[0]),\n                xel(\"shadows-only\", gps[1]==\"shadows-only\")\n            )\n#        g.SetAttributeValue(xn(\"enabled\"), gps[0])\n#        g.SetAttributeValue(xn(\"shadows-only\"), gps[1]==\"shadows-only\")\n\n        return g\n\n    def refl_settings_xml(self):\n        \"\"\"\n        Create custom reflection environment XML representation for database.\n        \"\"\"\n        refl = self.refl_settings()\n        r = xel(xn(\"custom_reflection\"),\n              xel(xn(\"use_custom\"), refl[0]),\n              xel(xn(\"reflenv\"), refl[1])\n            )\n        return r\n\n    def render_settings_xml(self):\n        \"\"\"\n        Create render settings XML representation for database.\n        \"\"\"\n        rs = self.bg_settings()\n\n        r = xel(xn(\"rendersettings\"),\n              xel(xn(\"backgroundstyle\"), rs[0]),\n              xel(xn(\"bgenv\"), rs[1])\n            )\n        return r\n\n    def sky_settings_xml(self):\n        \"\"\"\n        Create sky settings XML representation for database.\n        \"\"\"\n        ss = self.sky_settings()\n        s = xel(xn(\"skylight\"),\n              xel(xn(\"enabled\"), ss[0]),\n              xel(xn(\"skyenv\"), ss[1])\n            )\n        return s\n\n    def sun_settings_xml(self):\n        \"\"\"\n        Create sun settings XML representation for database.\n        \"\"\"\n        ss = self.sun_settings()\n        s = xel(xn(\"sun\"),\n              xel(xn(\"enabled\"), ss[0])\n            )\n        return s\n\n    def reference_files(self):\n        fs = [xel(xn(\"file\"), xel(xn(\"display_mode\"), dm), xel(xn(\"path\"), self.reference_image_name[dm])) for dm in self.reference_image_name]\n        rf = xel(xn(\"reference_files\"), fs)\n\n        return rf\n\n    def xml(self):\n        t = xel(xn(\"case\")\n             , self.gp_xml()\n             , self.render_settings_xml()\n             , self.refl_settings_xml()\n             , self.sky_settings_xml()\n             , self.sun_settings_xml()\n             , self.reference_files()\n        )\n        t.SetAttributeValue(xn(\"id\"), self.id)\n        t.SetAttributeValue(xn(\"code\"), self.name)\n        return t\n\n\n\n    def test_single(self, display_mode):\n        try:\n            reference_image = System.Drawing.Bitmap(os.path.join(output_dir, self.reference_image_name[display_mode]))\n        except:\n            return 0\n        \n        Rhino.RhinoApp.RunScript(\"-_SetDisplayMode _Mode={0}\".format(\"Wireframe\"), False)\n        Rhino.RhinoApp.RunScript(\"RotateView Left RotateView Right\", False)\n        time1 = time.time()\n        image1 = capture_viewport(display_mode, self.resolution)\n        time1 = time.time() - time1\n        image1path = os.path.join(output_dir, self.test1_image_name[display_mode])\n        cleanpath(image1path)\n        image1.Save(image1path, System.Drawing.Imaging.ImageFormat.Png)\n\n        Rhino.RhinoApp.RunScript(\"-_SetDisplayMode _Mode={0}\".format(\"Wireframe\"), False)\n        Rhino.RhinoApp.RunScript(\"RotateView Left RotateView Right\", False)\n        time2 = time.time()\n        image3 = capture_viewport(display_mode, self.resolution)\n        time2 = time.time() - time2\n        image3path = os.path.join(output_dir, self.test2_image_name[display_mode])\n        cleanpath(image3path)\n        image3.Save(image3path, System.Drawing.Imaging.ImageFormat.Png)\n        \n        f1_compare, err1 = compare_images(reference_image, image1)\n        f3_compare, err2 = compare_images(reference_image, image3)\n        err1path = os.path.join(output_dir, self.test1_error_name[display_mode])\n        err2path = os.path.join(output_dir, self.test2_error_name[display_mode])\n        cleanpath(err1path)\n        cleanpath(err2path)\n        err1.Save(err1path, System.Drawing.Imaging.ImageFormat.Png)\n        err2.Save(err2path, System.Drawing.Imaging.ImageFormat.Png)\n\n        image1.Dispose()\n        image3.Dispose()\n        err1.Dispose()\n        err2.Dispose()\n\n        self.timings[display_mode] = (time1 + time2) / 2.0\n        \n        sc.doc.Modified = False\n        return (f1_compare + f3_compare) / 2.0\n\n    def open3dm(self):\n        doc = sc.doc\n        fullpathbaked = os.path.join(this_dir, \"Baked\", possibleWorldsName, self.bakefile_name)\n        doc.Open(fullpathbaked)\n\n        print(\"opened\", fullpathbaked)\n\n    def setup_single(self, display_mode):\n        \"\"\"\n        Load given model from model_path, creating a capture in display_mode.\n        The model is prepared with settings from world, and captured at resolution.\n\n        Returns the full path to the image rendered.\n        \"\"\"\n        fullpath = \"\"\n        #self.open3dm()\n        #self.prepare_model()\n        Rhino.RhinoApp.RunScript(\"-_SetDisplayMode _Mode={0}\".format(\"Wireframe\"), False)\n        #Rhino.RhinoApp.RunScript(\"RotateView Left RotateView Right\", False)\n        start = time.time()\n        image = capture_viewport(display_mode, self.resolution)\n        self.timings[display_mode] = time.time() - start\n        fullpath = os.path.join(output_dir, self.reference_image_name[display_mode])\n        cleanpath(fullpath)\n        print(fullpath)\n        image.Save(fullpath, System.Drawing.Imaging.ImageFormat.Png)\n        sc.doc.Modified = False\n        #return fullpath\n\n    def create_3dm(self, root):\n        \"\"\"\n        Load given model from model_path, setting it up according the\n        settings specified in world. The resulting model will be saved\n        to the Baked folder for future reference.\n\n        Returns the full path to the created file.\n        \"\"\"\n        fullpath = \"\"\n        self.prepare_model()\n        Rhino.RhinoApp.RunScript(\"-_line 0,0 1,1 sellast delete\", False)\n        Rhino.RhinoApp.RunScript(\"RotateView Left RotateView Right\", False)\n        fwo = Rhino.FileIO.FileWriteOptions()\n        fwo.IncludeBitmapTable = True\n        fwo.IncludeRenderMeshes = True\n        fwo.SuppressDialogBoxes = True\n        fullpath = os.path.join(root, \"Baked\", possibleWorldsName, self.bakefile_name)\n        cleanpath(fullpath)\n        fullpathbak = fullpath+\"bak\"\n        dirname = os.path.dirname(fullpath)\n        if not os.path.exists(dirname):\n            os.makedirs(dirname)\n        sc.doc.WriteFile(fullpath, fwo)\n        sc.doc.Modified = False\n        cleanpath(fullpathbak)\n        return fullpath\n\n    def html(self):\n        info = \"\"\n        for dm in self.display_modes:\n            info += r\"\"\"\n            <td>\n            <h3>{0:06d}: {1} : {2} seconds</h3>\n            </td>\n            \"\"\".format(self.id, dm, self.timings[dm])\n        dmres = \"\"\n        for dm in self.display_modes:\n            dmres += r\"\"\"\n            <td>\n            <a href=\"{0}\"><img src=\"{0}\" width=\"300\" border=\"0\" title=\"{1:06d}:{2} - {3} seconds\"/></a>\n            </td>\n            \"\"\".format(self.reference_image_name[dm], self.id, dm, self.timings[dm])\n        templ = r\"\"\"\n        <table border=\"1\">\n        <tr>\n        {0}\n        </tr>\n        <tr colspan=\"2\">\n        <a href=\"{3}\">{1}</a>\n        </tr>\n        <tr>\n        {2}\n        </tr>\n        </table>\n        \"\"\".format(info, self.world, dmres, self.bakefile_name)\n        return templ\n\n    def do(self):\n        \"\"\"\n        Execute the action specified.\n        \"\"\"\n        sc.doc.Modified = False\n        if self.action == 'setup':\n            self.create_3dm(this_dir)\n            sc.doc.Modified = False\n        #self.prepare_model()\n        self.open3dm()\n        sc.doc.Modified = False\n        for dm in self.display_modes:\n            if self.action == 'test':\n                self.cf = self.test_single(dm)\n                #if self.cf < match_amount:\n                #    failed.append(model_path + \": {0}\".format(cf))\n                #else:\n                #    passed.append(model_path)\n            else:\n                self.setup_single(dm)\n            sc.doc.Modified = False\n    \ndef suite(all_cases):\n    s = xel(xn(\"suite\"), [t.xml() for t in all_cases])\n\n    return s\n\n\n    \ndef create_database(all_cases):\n    s = suite(all_cases)\n    print(s)\n    return s\n\ndef run(action):\n    display_modes = ['Raytraced', 'Rendered']\n    #display_modes = ['Raytraced']\n\n    start_all = time.time()\n\n    all_cases = []\n    run_cases = []\n\n    worldcount = len(possibleWorlds)\n    # all tests: tests_to_run = test_ids([irange(1,len(possibleWorlds))], len(possibleWorlds))\n    tests_to_run = test_ids([irange(1,worldcount)], worldcount)\n    # how to do different ranges tests_to_run = test_ids([irange(1,3), irange(6,10)], len(possibleWorlds))\n    #tests_to_run = test_ids([irange(101, 200)], len(possibleWorlds))\n    #tests_to_run = test_ids([irange(1,10)], len(possibleWorlds))\n    #tests_to_run = test_ids([irange(worldcount-3,worldcount)], worldcount)\n    tests_to_run = test_ids([129], worldcount)\n    print(tests_to_run)\n\n    for ttr in tests_to_run:\n        print(possibleWorlds[ttr])\n    \n    # Throw away modifications in current document\n    sc.doc.Modified = False\n\n    root = os.path.join(this_dir, \"Environments\")\n    for file in os.listdir(root):\n        if not file.lower().endswith(\".3dm\"):\n            continue\n        model_path = os.path.join(root, file)\n        all_cases.extend([TestCase(i+1, model_path, action, display_modes, world, standard_res) for i, world in enumerate(possibleWorlds)])\n\n    for ttr in tests_to_run:\n        print(all_cases[ttr].world, all_cases[ttr].bakefile_name)\n\n    #if action == 'setup':\n    #    for file in os.listdir(output_dir):\n    #        os.unlink(os.path.join(output_dir, file))\n\n    if action == 'db':\n        create_database(all_cases)\n    else:\n        root = os.path.join(this_dir, \"Environments\")\n        cnt = 0\n        for file in os.listdir(root):\n            if not file.lower().endswith(\".3dm\"):\n                continue\n            model_path = os.path.join(root, file)\n            for t in tests_to_run:\n                #world = possibleWorlds[t]\n                cnt = cnt + 1\n                #if cnt > 2: break\n                test_case = all_cases[t]# TestCase(cnt, model_path, action, display_modes, world, standard_res)\n                test_case.do()\n                run_cases.append(test_case)\n\n        total_time = time.time() - start_all\n\n        resultshtml = os.path.join(output_dir, \"results.html\")\n        with open(resultshtml, \"w\") as f:\n            f.write(\"<html><body>\")\n            f.write(\"<p>{0} tests ({1} renders) completed in {2} seconds</p>\".format(len(run_cases), len(run_cases) * len(display_modes), total_time))\n            for tc in all_cases:\n                f.write(tc.html())\n            f.write(\"</body></html>\")\n        webbrowser.open_new_tab(resultshtml)\n\n        runresultshtml = os.path.join(output_dir, \"runresults.html\")\n        with open(runresultshtml, \"w\") as f:\n            f.write(\"<html><body>\")\n            f.write(\"<p>{0} tests ({1} renders) completed in {2} seconds</p>\".format(len(run_cases), len(run_cases) * len(display_modes), total_time))\n            for tc in run_cases:\n                f.write(tc.html())\n            f.write(\"</body></html>\")\n        webbrowser.open_new_tab(runresultshtml)\n\n    # Throw away modifications in current document, in case some were left\n    sc.doc.Modified = False\n\nif __name__ == '__main__':\n    if not os.path.exists(output_dir):\n        os.mkdir(output_dir)\n    run(action)",
      "language": "python",
      "author": "nathanletwory",
      "post_number": 2,
      "is_solution": false
    },
    {
      "code": "#! python 3\n\nimport rhinoscriptsyntax as rs\nimport scriptcontext as sc\nimport Rhino\nimport os\nimport System\n\ndef captureBitmap():\n    # Check if realtimedisplay, get state and pause\n    rtdm = sc.doc.Views.ActiveView.RealtimeDisplayMode\n    if rtdm:\n        pauseState = rtdm.Paused\n        rtdm.Paused = True\n\n    # Get view and capture bitmap\n    view = sc.doc.Views.ActiveView\n    vc = Rhino.Display.ViewCapture()\n    vc.Width = sc.doc.Views.ActiveView.ClientRectangle.Width\n    vc.Height = sc.doc.Views.ActiveView.ClientRectangle.Height\n    # Ignore samples to capture current state\n    #samples = 1\n    #vc.RealtimeRenderPasses = samples\n    bitmap = vc.CaptureToBitmap(view)\n\n    # if realtimedisplay reset state\n    if rtdm:\n        rtdm.Paused = pauseState\n    \n    return bitmap\n\ndef runScript():\n\n    # Save path\n    #save_path = r\"D:\\temp\\capture.jpg\"\n    \n    save_path = rs.SaveFileName(\"Save JPEG\", \"JPEG (*.jpg)|*.jpg||\")\n    if not save_path: return\n\n    # Ensure directory exists\n    os.makedirs(os.path.dirname(save_path), exist_ok=True)\n\n    # Capture bitmap\n    bitmap = captureBitmap()\n\n    # Save as JPEG\n    bitmap.Save(save_path, System.Drawing.Imaging.ImageFormat.Jpeg)\n\n    print (\"Image saved to:\", save_path)\n\nrunScript()",
      "language": "python",
      "author": "Holo",
      "post_number": 3,
      "is_solution": false
    },
    {
      "code": "#! python 3\n\nimport scriptcontext as sc\nimport rhinoscriptsyntax as rs\nimport System\n\nSaveFileName = rs.SaveFileName(title=\"File name\", filter=\"JPEG (*.jpg)|*.jpg||\")\nif SaveFileName:\n    print(SaveFileName)\n    bitmap = sc.doc.Views.ActiveView.CaptureToBitmap()\n    bitmap.Save(SaveFileName, System.Drawing.Imaging.ImageFormat.Jpeg)",
      "language": "python",
      "author": "Holo",
      "post_number": 1,
      "is_solution": false
    }
  ],
  "tags": [
    "file-io",
    "geometry",
    "materials",
    "mesh",
    "python",
    "rhinoscriptsyntax",
    "transformation"
  ],
  "has_accepted_answer": false,
  "category_id": 11,
  "posts_count": 3,
  "views": 102
}