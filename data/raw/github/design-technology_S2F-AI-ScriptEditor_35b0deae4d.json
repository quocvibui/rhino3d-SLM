{
  "source_url": "https://github.com/design-technology/S2F-AI-ScriptEditor/blob/b8b186096f89bf831661ef8308693b98d2bb5b39/4-Running_in_Rhino/04-project/ai/Renderer.py",
  "repo": "design-technology/S2F-AI-ScriptEditor",
  "repo_stars": 5,
  "repo_description": null,
  "license": "unknown",
  "filepath": "4-Running_in_Rhino/04-project/ai/Renderer.py",
  "instruction": "Renderer",
  "code": "import io\nimport os\n\nimport torch\nfrom diffusers import StableDiffusionImg2ImgPipeline, OnnxStableDiffusionPipeline\n\nfrom PIL import Image\nimport scriptcontext as sc\n\nfrom System.IO import MemoryStream\nimport System.Drawing.Imaging as sdi\nimport System.Drawing as sd\nfrom System import Array, Byte\n\nimport Eto.Drawing as ed\nimport Eto.Forms as ef\n\nfrom Rhino import RhinoApp\nfrom Rhino.UI import EtoExtensions\n\n# Set the Python executable\nimport torch.multiprocessing as mp\nimport rhinocode\npython = rhinocode.get_python_executable()\nmp.set_executable(python)\n\nclass RenderPipe:\n    def __init__(self, use_onnx: bool = False, model_id: str = \"stabilityai/sd-turbo\"):\n        self.use_onnx = use_onnx\n        \n        self.model_id = model_id\n        self.pipe = self.get_pipe()\n\n    def get_pipe(self):\n        print(f\"Using model : {self.model_id}\")\n\n        if torch.backends.mps.is_available():\n            device = \"mps\"  # Apple's Metal Performance Shaders for Mac GPU acceleration\n        elif torch.cuda.is_available():\n            device = \"cuda\"  # NVIDIA GPU acceleration using CUDA\n        else:\n            device = \"cpu\"  # Fallback to CPU if no GPU is available\n\n        print(f\"Using device: {device}\")\n\n        if self.use_onnx:\n            print(\"Using ONNX\")\n            try:\n                # ONNX (Open Neural Network Exchange) allows optimized inference across platforms\n                # More info: https://onnx.ai/\n                execution_provider = \"CPUExecutionProvider\" if device == \"cpu\" else \"DmlExecutionProvider\"\n                pipe = OnnxStableDiffusionPipeline.from_pretrained(self.model_id, provider=execution_provider)\n                return pipe\n            except Exception as e:\n                print(f\"ONNX loading failed: {e}\")\n        \n        # Standard PyTorch pipeline for Stable Diffusion with img2img support\n        # More info: https://huggingface.co/docs/diffusers/main/en/api/pipelines/stable_diffusion\n\n        # Use lower precision for speed on GPUs (CPUs don't support 16 bit floats)\n        if device == \"cpu\":\n            dtype = torch.float32\n        else:\n            dtype = torch.float16\n\n        print(f\"Using precision {dtype}\")\n\n        pipe = StableDiffusionImg2ImgPipeline.from_pretrained(self.model_id, torch_dtype=dtype)\n        pipe.to(device)\n        return pipe\n\n    def bitmap_to_pil(self, bitmap: sd.Bitmap) -> Image.Image:\n        net_stream = MemoryStream()\n        \n        bitmap.Save(net_stream, sdi.ImageFormat.Png)\n        \n        byte_array = net_stream.ToArray()\n        pil_image = Image.open(io.BytesIO(byte_array))\n\n        return pil_image.convert(\"RGB\")\n        \n    def set_model(self, model_id: str):\n        if self.model_id == model_id:\n            return\n\n        self.dispose()\n        \n        self.model_id = model_id\n        self.pipe = self.get_pipe()\n\n    def generate_image(self, init_bitmap: sd.Bitmap, seed: int, prompt: str, negative_prompt: str, steps: int = 25, strength: float = 0.75):\n        try:\n            width, height = int(512), int(512)  # Fixed dimensions\n\n            init_image = self.bitmap_to_pil(init_bitmap)\n            init_image = init_image.resize((width, height), Image.LANCZOS)\n\n            generator = torch.Generator(device=\"cuda\" if torch.cuda.is_available() else \"cpu\").manual_seed(int(seed))\n\n            with torch.inference_mode():\n                result = self.pipe(\n                    prompt=prompt,\n                    negative_prompt=negative_prompt,\n                    image=init_image,\n                    guidance_scale=int(5),\n                    num_inference_steps=int(steps),\n                    num_images_per_prompt=int(1),\n                    strength=float(strength),\n                    height=int(height),\n                    width=int(width),\n                    generator=generator,  # Pass the seed generator\n                )\n\n                return result.images[0]\n        except Exception as e:\n            print(f\"Error generating image: {e}\")\n            return None\n\n    def pil_to_bitmap(self, pil_image: Image.Image) -> ed.Bitmap:\n        if pil_image is None:\n            return None\n        \n        stream = io.BytesIO()\n        pil_image.save(stream, format=\"PNG\")\n        byte_array = stream.getvalue()\n        byte_array_net = Array[Byte](byte_array)  # Convert to .NET Byte[]\n\n        return ed.Bitmap(byte_array_net)\n    \n    def dispose(self):\n        try:\n            if self.pipe == None:\n                return\n            \n            print(\"Disposing the pipeline...\")\n            del self.pipe  # Delete the pipeline object\n            self.pipe = None  # Reset reference\n\n            # Clear GPU memory if using CUDA\n            if torch.cuda.is_available():\n                torch.cuda.empty_cache()\n            \n        except:\n            pass\n\nif __name__ == \"__main__\":\n    pipe = RenderPipe(False, \"SG161222/RealVisXL_V4.0\")\n    \n    bitmap = sc.doc.Views.ActiveView.CaptureToBitmap(sd.Size(512,512), False, False, False)\n\n    prompt = \"a stunning view of a cluster of modular pavilions nestled within the lush Brazilian jungle the roof is built using woven bamboo elements surrounded by majestic mountains rising in the background and a serene river flowing in the foreground the trees are way taller than the pavilions earthy tones that blend harmoniously with the yellowish greens of the surrounding jungle volumetric sunlight goes across the jungle creating fascinating light rays 4k high resolution realistic render architectural visualization\"\n    negative_prompt = \"Low Quality\"\n    \n    pil_image = pipe.generate_image(bitmap, 500, prompt, negative_prompt, 25, 0.75)\n    if pil_image is not None:\n        eto_image = pipe.pil_to_bitmap(pil_image)\n\n        sfd = ef.SaveFileDialog()\n        if sfd.ShowDialog() == ef.DialogResult.Ok:\n            eto_image.Save(sfd.FileName, ed.ImageFormat.Png)\n\n    else:\n        print(\"Error!\")",
  "language": "python",
  "imports": [
    "Rhino",
    "scriptcontext"
  ],
  "has_docstring": false
}