{
  "source_url": "https://discourse.mcneel.com/t/twist-mesh-with-a-python-script/195064",
  "topic_id": 195064,
  "title": "Twist mesh with a Python script",
  "question": "Hello, The code below will import a mesh and create a line through the mesh. I now want to twist the mesh using the line as the twist axis. But all of my attempts have failed. If anyone could give me some guidance on how to do this I would be grateful!\n\n\nimport os\nimport rhinoscriptsyntax as rs\nimport random\n\ndef import_random_mesh_and_process():\n    print(\"Step 1: Starting script.\")\n\n    # Path to your folder containing OBJ files\n    folder_path = r\"C:\\Users\\jdm037\\Desktop\\rhino_python_scripts\\meshes_simple\"\n\n    # Delete all visible geometry in the scene\n    print(\"Step 2: Deleting all visible geometry.\")\n    visible_objects = rs.ObjectsByType(0, True, True)  # 0 = all objects, include_hidden=False, include_lights=True\n    if visible_objects:\n        rs.DeleteObjects(visible_objects)\n        print(\"Step 2: All visible geometry deleted.\")\n    else:\n        print(\"Step 2: No visible geometry to delete.\")\n\n    # Get a list of all .OBJ files in the folder\n    print(\"Step 3: Gathering .OBJ files.\")\n    mesh_files = [f for f in os.listdir(folder_path) if f.endswith('.obj')]\n\n    if not mesh_files:\n        print(\"Step 3: No OBJ files found in the specified folder.\")\n        return\n    print(\"Step 3: OBJ files found.\")\n\n    # Select a random OBJ file\n    print(\"Step 4: Selecting a random OBJ file.\")\n    random_mesh_file = random.choice(mesh_files)\n    mesh_file_path = os.path.join(folder_path, random_mesh_file)\n    print(\"Step 4: Selected file - {}\".format(random_mesh_file))\n\n    # Import the selected OBJ file into Rhino\n    print(\"Step 5: Importing the selected OBJ file.\")\n    try:\n        rs.Command('-Import \"{}\" _Enter'.format(mesh_file_path))\n        print(\"Step 5: Successfully imported - {}\".format(random_mesh_file))\n    except Exception as e:\n        print(\"Step 5: Failed to import mesh: {}\".format(e))\n        return\n\n    # Find the longest dimension of the imported mesh and create a line\n    print(\"Step 6: Processing the imported mesh.\")\n    try:\n        # Get the ...",
  "code_blocks": [
    {
      "code": "# assume you already have the variables defined as \"your_....\"\nimport Rhino.Geometry as rhg\nmorph = rhg.Morphs.TwistSpaceMorph()\nmorph.TwistAngleRadians = your_angle\nmorph.TwistAxis = your_line\nmorph.Morph(your_mesh)",
      "language": "python",
      "author": "Will_Wang",
      "post_number": 2,
      "is_solution": false
    },
    {
      "code": "import os\nimport rhinoscriptsyntax as rs\nimport random\nimport Rhino\nimport scriptcontext as sc\n\ndef import_random_mesh_and_process():\n    print(\"Step 1: Starting script.\")\n\n    folder_path = r\"C:\\Users\\jdm037\\Desktop\\rhino_python_scripts\\meshes_simple\"\n\n    print(\"Step 2: Deleting all visible geometry.\")\n    visible_objects = rs.ObjectsByType(0, True, True)\n    if visible_objects:\n        rs.DeleteObjects(visible_objects)\n        print(\"Step 2: All visible geometry deleted.\")\n    else:\n        print(\"Step 2: No visible geometry to delete.\")\n\n    print(\"Step 3: Gathering .OBJ files.\")\n    mesh_files = [f for f in os.listdir(folder_path) if f.endswith('.obj')]\n    if not mesh_files:\n        print(\"Step 3: No OBJ files found in the specified folder.\")\n        return\n\n    print(\"Step 4: Selecting a random OBJ file.\")\n    random_mesh_file = random.choice(mesh_files)\n    mesh_file_path = os.path.join(folder_path, random_mesh_file)\n    print(\"Step 4: Selected file - {}\".format(random_mesh_file))\n\n    print(\"Step 5: Importing the selected OBJ file.\")\n    try:\n        rs.Command('-Import \"{}\" _Enter'.format(mesh_file_path))\n        print(\"Step 5: Successfully imported - {}\".format(random_mesh_file))\n    except Exception as e:\n        print(\"Step 5: Failed to import mesh: {}\".format(e))\n        return\n\n    print(\"Step 6: Processing the imported mesh.\")\n    try:\n        imported_mesh = rs.LastCreatedObjects(select=False)\n        if not imported_mesh:\n            print(\"Step 6: No mesh was imported.\")\n            return\n\n        imported_mesh_id = imported_mesh[0]\n        bounding_box = rs.BoundingBox(imported_mesh_id)\n        if not bounding_box:\n            print(\"Step 6: Failed to calculate bounding box for the imported mesh.\")\n            return\n\n        center_x = (bounding_box[0][0] + bounding_box[6][0]) / 2\n        center_y = (bounding_box[0][1] + bounding_box[6][1]) / 2\n        center_z = (bounding_box[0][2] + bounding_box[6][2]) / 2\n\n        x_length = abs(bounding_box[1][0] - bounding_box[0][0])\n        y_length = abs(bounding_box[3][1] - bounding_box[0][1])\n        z_length = abs(bounding_box[4][2] - bounding_box[0][2])\n\n        longest_length = max(x_length, y_length, z_length)\n        axis = [\"X\", \"Y\", \"Z\"][ [x_length, y_length, z_length].index(longest_length) ]\n\n        if axis == \"X\":\n            line_start = (center_x - longest_length, center_y, center_z)\n            line_end = (center_x + longest_length, center_y, center_z)\n        elif axis == \"Y\":\n            line_start = (center_x, center_y - longest_length, center_z)\n            line_end = (center_x, center_y + longest_length, center_z)\n        else:\n            line_start = (center_x, center_y, center_z - longest_length)\n            line_end = (center_x, center_y, center_z + longest_length)\n\n        print(\"Step 6: Twist axis from {} to {}\".format(line_start, line_end))\n        rs.AddLine(line_start, line_end)\n\n        print(\"Step 8: Applying twist using RhinoCommon.\")\n\n        mesh = rs.coercegeometry(imported_mesh_id)\n        if not mesh:\n            print(\"RhinoCommon fallback: Failed to coerce geometry.\")\n            return\n        \n        # Create twisting effect\n        twist_angle = 360\n        line = Rhino.Geometry.Line(\n            Rhino.Geometry.Point3d(*line_start),\n            Rhino.Geometry.Point3d(*line_end)\n        )\n        twist_center = line.PointAt(0.5)\n        \n        def twist_deform(pt):\n            \"\"\"\n            Custom deformation function for twisting.\n            \"\"\"\n            t = line.ClosestParameter(pt)\n            angle = twist_angle * t\n            axis = line.UnitTangent\n            rotation = Rhino.Geometry.Transform.Rotation(\n                Rhino.RhinoMath.ToRadians(angle),\n                axis,\n                twist_center\n            )\n            pt.Transform(rotation)\n            return pt\n\n        twisted_mesh = mesh.Duplicate()\n        for i in range(twisted_mesh.Vertices.Count):\n            vertex = twisted_mesh.Vertices[i]\n            pt = twist_deform(Rhino.Geometry.Point3d(vertex.X, vertex.Y, vertex.Z))\n            twisted_mesh.Vertices.SetVertex(i, pt.X, pt.Y, pt.Z)\n\n        sc.doc.Objects.Replace(imported_mesh_id, twisted_mesh)\n        sc.doc.Views.Redraw()\n        print(\"Twist successfully applied using RhinoCommon.\")\n\n    except Exception as e:\n        print(\"Step 8: Failed to process mesh: {}\".format(e))\n\n# Run the function\nimport_random_mesh_and_process()",
      "language": "python",
      "author": "JoeMeiser",
      "post_number": 3,
      "is_solution": false
    },
    {
      "code": "import rhinoscriptsyntax as rs\nimport random\nimport scriptcontext as sc\nimport Rhino\n\ndef import_random_mesh_and_create_multipipe():\n    print(\"Starting the MultiPipe script...\")\n\n    # Path to your folder containing OBJ files\n    folder_path = r\"C:\\Users\\jdm037\\Desktop\\rhino_python_scripts\\meshes_simple\"\n    pipe_diameter_percentage = 0.001  # Set the pipe diameter as a percentage of the largest bounding box dimension\n    print(\"Pipe diameter percentage: {}\".format(pipe_diameter_percentage))\n\n    # Get a list of all .OBJ files in the folder\n    mesh_files = [f for f in os.listdir(folder_path) if f.endswith('.obj')]\n    print(\"Found {} OBJ files: {}\".format(len(mesh_files), mesh_files))\n\n    if not mesh_files:\n        print(\"No OBJ files found in the specified folder. Exiting script.\")\n        return\n\n    # Select a random OBJ file\n    random_mesh_file = random.choice(mesh_files)\n    mesh_file_path = os.path.join(folder_path, random_mesh_file)\n    print(\"Randomly selected mesh file: {}\".format(random_mesh_file))\n\n    # Import the selected OBJ file into Rhino\n    try:\n        print(\"Attempting to import the OBJ file...\")\n        rs.Command('-Import \"{}\" _Enter'.format(mesh_file_path))\n        print(\"Successfully imported random mesh: {}\".format(random_mesh_file))\n    except Exception as e:\n        print(\"Failed to import mesh: {}\".format(e))\n        return\n\n    # Get the most recently added object (the imported mesh)\n    imported_objects = rs.LastCreatedObjects()\n    print(\"Imported object IDs: {}\".format(imported_objects))\n\n    if not imported_objects:\n        print(\"No objects were imported. Exiting script.\")\n        return\n\n    # Check if the object is a mesh\n    mesh_id = imported_objects[0]  # Assuming the first imported object is the mesh\n    print(\"Processing object ID: {}\".format(mesh_id))\n\n    if rs.IsMesh(mesh_id):\n        print(\"The imported object is confirmed to be a mesh.\")\n\n        # Calculate the bounding box of the mesh\n        bbox = rs.BoundingBox(mesh_id)\n        if not bbox:\n            print(\"Failed to calculate bounding box. Exiting script.\")\n            return\n        print(\"Bounding box of the mesh: {}\".format(bbox))\n\n        # Calculate the maximum dimension of the mesh\n        max_dimension = max(\n            rs.Distance(bbox[0], bbox[1]),\n            rs.Distance(bbox[0], bbox[3]),\n            rs.Distance(bbox[0], bbox[4])\n        )\n        print(\"Mesh maximum dimension: {}\".format(max_dimension))\n\n        # Correctly calculate the pipe radius\n        pipe_radius = pipe_diameter_percentage * max_dimension\n        print(\"Calculated pipe radius: {:.3f}\".format(pipe_radius))\n\n        # Extract the wireframe (mesh edges as polylines)\n        print(\"Extracting wireframe from the mesh...\")\n        mesh_obj = sc.doc.Objects.Find(mesh_id)\n        if not mesh_obj:\n            print(\"Failed to retrieve the mesh object. Exiting script.\")\n            return\n\n        mesh_geometry = mesh_obj.Geometry\n        if not isinstance(mesh_geometry, Rhino.Geometry.Mesh):\n            print(\"The object is not a valid mesh. Exiting script.\")\n            return\n\n        edges = mesh_geometry.TopologyEdges\n        print(\"Mesh has {} topology edges.\".format(edges.Count))\n\n        edge_curves = []\n        for i in range(edges.Count):\n            curve = edges.EdgeLine(i).ToNurbsCurve()\n            if curve:\n                edge_curves.append(curve)\n        print(\"Extracted {} edge curves.\".format(len(edge_curves)))\n\n        # Add curves to Rhino document and store them\n        print(\"Adding curves to the Rhino document...\")\n        curve_ids = []\n        for curve in edge_curves:\n            curve_id = sc.doc.Objects.AddCurve(curve)\n            curve_ids.append(curve_id)\n        print(\"Added {} curves to the document.\".format(len(curve_ids)))\n\n        sc.doc.Views.Redraw()\n\n        # Ensure the curves are selected\n        rs.UnselectAllObjects()\n        rs.SelectObjects(curve_ids)\n        print(\"Selected {} curves for MultiPipe.\".format(len(curve_ids)))\n\n        # Explicitly set the radius interactively\n        print(\"Executing _MultiPipe command interactively...\")\n        rs.Command('_-MultiPipe _Radius={} _Enter _Enter'.format(pipe_radius))\n\n        print(\"MultiPipe created successfully. Check your Rhino workspace.\")\n    else:\n        print(\"The imported object is not a mesh. Exiting script.\")\n\n# Run the function\nimport_random_mesh_and_create_multipipe()\ntype or paste code here",
      "language": "python",
      "author": "JoeMeiser",
      "post_number": 4,
      "is_solution": false
    },
    {
      "code": "import os\nimport rhinoscriptsyntax as rs\nimport random\n\ndef import_random_mesh_and_process():\n    print(\"Step 1: Starting script.\")\n\n    # Path to your folder containing OBJ files\n    folder_path = r\"C:\\Users\\jdm037\\Desktop\\rhino_python_scripts\\meshes_simple\"\n\n    # Delete all visible geometry in the scene\n    print(\"Step 2: Deleting all visible geometry.\")\n    visible_objects = rs.ObjectsByType(0, True, True)  # 0 = all objects, include_hidden=False, include_lights=True\n    if visible_objects:\n        rs.DeleteObjects(visible_objects)\n        print(\"Step 2: All visible geometry deleted.\")\n    else:\n        print(\"Step 2: No visible geometry to delete.\")\n\n    # Get a list of all .OBJ files in the folder\n    print(\"Step 3: Gathering .OBJ files.\")\n    mesh_files = [f for f in os.listdir(folder_path) if f.endswith('.obj')]\n\n    if not mesh_files:\n        print(\"Step 3: No OBJ files found in the specified folder.\")\n        return\n    print(\"Step 3: OBJ files found.\")\n\n    # Select a random OBJ file\n    print(\"Step 4: Selecting a random OBJ file.\")\n    random_mesh_file = random.choice(mesh_files)\n    mesh_file_path = os.path.join(folder_path, random_mesh_file)\n    print(\"Step 4: Selected file - {}\".format(random_mesh_file))\n\n    # Import the selected OBJ file into Rhino\n    print(\"Step 5: Importing the selected OBJ file.\")\n    try:\n        rs.Command('-Import \"{}\" _Enter'.format(mesh_file_path))\n        print(\"Step 5: Successfully imported - {}\".format(random_mesh_file))\n    except Exception as e:\n        print(\"Step 5: Failed to import mesh: {}\".format(e))\n        return\n\n    # Find the longest dimension of the imported mesh and create a line\n    print(\"Step 6: Processing the imported mesh.\")\n    try:\n        # Get the imported mesh\n        imported_mesh = rs.LastCreatedObjects(select=False)\n        if not imported_mesh:\n            print(\"Step 6: No mesh was imported.\")\n            return\n\n        print(\"Step 6: Imported mesh detected.\")\n        imported_mesh_id = imported_mesh[0]\n        bounding_box = rs.BoundingBox(imported_mesh_id)\n        if not bounding_box:\n            print(\"Step 6: Failed to calculate bounding box for the imported mesh.\")\n            return\n\n        print(\"Step 6: Bounding box calculated.\")\n        # Calculate the center of the bounding box\n        center_x = (bounding_box[0][0] + bounding_box[6][0]) / 2\n        center_y = (bounding_box[0][1] + bounding_box[6][1]) / 2\n        center_z = (bounding_box[0][2] + bounding_box[6][2]) / 2\n        center = (center_x, center_y, center_z)\n\n        # Calculate dimensions along X, Y, Z\n        x_length = abs(bounding_box[1][0] - bounding_box[0][0])\n        y_length = abs(bounding_box[3][1] - bounding_box[0][1])\n        z_length = abs(bounding_box[4][2] - bounding_box[0][2])\n\n        print(\"Step 6: Dimensions calculated.\")\n        # Determine the longest axis\n        longest_length = max(x_length, y_length, z_length)\n        axis = [\"X\", \"Y\", \"Z\"][ [x_length, y_length, z_length].index(longest_length) ]\n\n        # Create a line along the longest axis, centered on the mesh\n        if axis == \"X\":\n            line_start = (center[0] - longest_length, center[1], center[2])\n            line_end = (center[0] + longest_length, center[1], center[2])\n        elif axis == \"Y\":\n            line_start = (center[0], center[1] - longest_length, center[2])\n            line_end = (center[0], center[1] + longest_length, center[2])\n        else:  # Z\n            line_start = (center[0], center[1], center[2] - longest_length)\n            line_end = (center[0], center[1], center[2] + longest_length)\n\n        rs.AddLine(line_start, line_end)\n        print(\"Step 7: Created a line along the {}-axis through the center.\".format(axis))\n    except Exception as e:\n        print(\"Step 7: Failed to process mesh: {}\".format(e))\n\n# Run the function\nimport_random_mesh_and_process()",
      "language": "python",
      "author": "JoeMeiser",
      "post_number": 1,
      "is_solution": false
    }
  ],
  "tags": [
    "csharp",
    "file-io",
    "geometry",
    "mesh",
    "nurbs",
    "python",
    "rhinocommon",
    "rhinoscriptsyntax",
    "transformation"
  ],
  "has_accepted_answer": false,
  "category_id": 11,
  "posts_count": 4,
  "views": 174
}