{
  "source_url": "https://github.com/KeithSloan/ImportExport_3DM/blob/c63ae55e24aeeef6c1ff31316977cae779b9a6ce/freecad/importExport3DM/improved_export3DM.py",
  "repo": "KeithSloan/ImportExport_3DM",
  "repo_stars": 3,
  "repo_description": null,
  "license": "NOASSERTION",
  "filepath": "freecad/importExport3DM/improved_export3DM.py",
  "instruction": "improved_export3DM.py Drop-in exporter for Rhino 8 using rhino3dm 8.x API Full analytic + BSpline support, simplified, debug-friendly",
  "code": "# improved_export3DM.py\n# Drop-in exporter for Rhino 8 using rhino3dm 8.x API\n# Full analytic + BSpline support, simplified, debug-friendly\n\nimport FreeCAD\nimport Part\nimport rhino3dm as r3\nimport traceback\nimport os\n\n# -----------------------\n# Utilities\n# -----------------------\ndef safe_point(p):\n    return r3.Point3d(float(p.x if hasattr(p, 'x') else p.X),\n                      float(p.y if hasattr(p, 'y') else p.Y),\n                      float(p.z if hasattr(p, 'z') else p.Z))\n\n# -----------------------\n# FreeCAD face -> Rhino NURBS surface\n# -----------------------\ndef fc_face_to_rhino(face):\n    try:\n        nurbs = face.Surface.toNurbsSurface() if hasattr(face.Surface, 'toNurbsSurface') else face.Surface\n        ns = r3.NurbsSurface.Create(3, False, nurbs.DegreeU + 1, nurbs.DegreeV + 1, len(nurbs.getPoles()), len(nurbs.getPoles()[0]))\n        for i, row in enumerate(nurbs.getPoles()):\n            for j, pt in enumerate(row):\n                ns.Points.SetControlPoint(i, j, safe_point(pt))\n                ns.Points.SetWeight(i, j, 1.0)\n        return ns if ns.IsValid else None\n    except Exception:\n        traceback.print_exc()\n        return None\n\n# -----------------------\n# FreeCAD edge -> Rhino curve\n# -----------------------\ndef fc_edge_to_rhino(edge, samples=20):\n    try:\n        try:\n            bs = edge.Curve.toNurbs()\n            pts = [safe_point(p) for p in bs.getPoles()]\n            nc = r3.NurbsCurve.Create(False, bs.Degree, pts)\n            if nc and nc.IsValid:\n                return nc\n        except Exception:\n            pass\n        # fallback: sample points\n        u1, u2 = edge.ParameterRange\n        pts = [safe_point(edge.valueAt(u1 + (u2 - u1) * i / samples)) for i in range(samples + 1)]\n        nc = r3.NurbsCurve.Create(False, 1, pts)\n        return nc if nc.IsValid else None\n    except Exception:\n        traceback.print_exc()\n        return None\n\n# -----------------------\n# FreeCAD face -> trimmed Brep\n# -----------------------\ndef fc_face_to_brep(face):\n    ns = fc_face_to_rhino(face)\n    if not ns:\n        return None\n    try:\n        br = r3.Brep.CreateFromSurface(ns)\n        return br\n    except Exception:\n        traceback.print_exc()\n        return None\n\n# -----------------------\n# Fallback mesh from face\n# -----------------------\ndef mesh_from_face(face, tol=0.03):\n    try:\n        verts, faces = face.tessellate(tol)\n        mesh = r3.Mesh()\n        for v in verts:\n            mesh.Vertices.Add(*safe_point(v))\n        for f in faces:\n            if len(f) == 3:\n                mesh.Faces.AddFace(*f)\n            elif len(f) == 4:\n                mesh.Faces.AddFace(*f)\n        return mesh\n    except Exception:\n        traceback.print_exc()\n        return None\n\n# -----------------------\n# Model class\n# -----------------------\nclass RhinoModel:\n    def __init__(self):\n        self.model = r3.File3dm()\n\n    def add_brep(self, br):\n        if br: self.model.Objects.AddBrep(br)\n    def add_mesh(self, mesh):\n        if mesh: self.model.Objects.AddMesh(mesh)\n    def write(self, path):\n        self.model.Write(os.path.abspath(path), 0)\n\n# -----------------------\n# Exporter\n# -----------------------\nclass Exporter3DM:\n    def __init__(self):\n        self.rmodel = RhinoModel()\n\n    def process_object(self, obj):\n        tid = getattr(obj, 'TypeId', '')\n        try:\n            shape = getattr(obj, 'Shape', None)\n            if not shape or shape.isNull(): return\n            for face in shape.Faces:\n                br = fc_face_to_brep(face)\n                if br:\n                    self.rmodel.add_brep(br)\n                else:\n                    mesh = mesh_from_face(face)\n                    if mesh: self.rmodel.add_mesh(mesh)\n        except Exception:\n            traceback.print_exc()\n\n    def export_document(self, filepath):\n        for obj in FreeCAD.ActiveDocument.Objects:\n            self.process_object(obj)\n        self.rmodel.write(filepath)\n\n# -----------------------\n# Main entry\n# -----------------------\ndef export3DM(filepath):\n    Exporter3DM().export_document(filepath)\n\n# Example usage:\n# export3DM('/tmp/test.3dm')\n\n",
  "language": "python",
  "imports": [
    "rhino3dm"
  ],
  "has_docstring": true
}