{
  "source_url": "https://github.com/mcneel/compute.rhino3d/blob/677087c3683fb307c9d3a6e55651377c28c41e92/src/ghhops-server-py/ghhops_server/params.py",
  "repo": "mcneel/compute.rhino3d",
  "repo_stars": 378,
  "repo_description": "REST geometry server based on RhinoCommon and headless Rhino",
  "license": "NOASSERTION",
  "filepath": "src/ghhops-server-py/ghhops_server/params.py",
  "instruction": "Hops Component Parameter wrappers",
  "code": "\"\"\"Hops Component Parameter wrappers\"\"\"\nimport json\nfrom enum import Enum\nimport inspect\nfrom ghhops_server.base import _HopsEncoder\nfrom ghhops_server.logger import hlogger\n\n\n__all__ = (\n    \"HopsParamAccess\",\n    # \"HopsArc\",\n    \"HopsBoolean\",\n    # \"HopsBox\",\n    \"HopsBrep\",\n    \"HopsCircle\",\n    # \"HopsColour\",\n    # \"HopsComplex\"\n    # \"HopsCulture\",\n    \"HopsCurve\",\n    # \"HopsField\",\n    # \"HopsFilePath\",\n    # \"HopsGeometry\",\n    \"HopsInteger\",\n    # \"HopsInterval\",\n    # \"HopsInterval2D\"\n    \"HopsLine\",\n    # \"HopsMatrix\",\n    \"HopsMesh\",\n    # \"HopsMeshFace\",\n    \"HopsNumber\",\n    \"HopsPlane\",\n    \"HopsPoint\",\n    # \"HopsRectangle\",\n    \"HopsString\",\n    # \"HopsStructurePath\",\n    \"HopsSubD\",\n    \"HopsSurface\",\n    # \"HopsTime\",\n    # \"HopsTransform\",\n    \"HopsVector\",\n)\n\n\nRHINO = None\nRHINO_FROMJSON = None\nRHINO_TOJSON = None\nRHINO_GEOM = None\nCONVERT_VALUE = None\n\n\ndef _init_rhinoinside():\n    global RHINO\n    global RHINO_FROMJSON\n    global RHINO_TOJSON\n    global RHINO_GEOM\n    global CONVERT_VALUE\n\n    # initialize with Rhino.Inside Cpython ==========\n    import clr\n\n    clr.AddReference(\"System.Collections\")\n    clr.AddReference(\"Newtonsoft.Json.Rhino\")\n    import System\n    import Newtonsoft.Json as NJ\n    from System.Collections.Generic import Dictionary\n\n    def from_json(json_obj):\n        \"\"\"Convert to RhinoCommon from json\"\"\"\n        data_dict = Dictionary[str, str]()\n        for k, v in json_obj.items():\n            data_dict[k] = str(v)\n        return RHINO.Runtime.CommonObject.FromJSON(data_dict)\n\n    def to_json(value):\n        \"\"\"Convert RhinoCommon object to json\"\"\"\n        return NJ.JsonConvert.SerializeObject(value)\n\n    def convert_value(value):\n        # FIXME: more value types probably need to be handled\n        if isinstance(value, bool):\n            return System.Boolean(value)\n        elif isinstance(value, int):\n            return System.Int32(value)\n        elif isinstance(value, float):\n            return System.Double(value)\n        elif isinstance(value, str):\n            return System.String(value)\n        return value\n\n    RHINO_FROMJSON = from_json\n    RHINO_TOJSON = to_json\n\n    import Rhino\n\n    RHINO = Rhino\n    RHINO_GEOM = Rhino.Geometry\n\n    CONVERT_VALUE = convert_value\n\n\ndef _init_rhino3dm():\n    global RHINO\n    global RHINO_FROMJSON\n    global RHINO_TOJSON\n    global RHINO_GEOM\n    global CONVERT_VALUE\n\n    import rhino3dm\n\n    def from_json(json_obj):\n        \"\"\"Convert to rhino3dm from json\"\"\"\n        return rhino3dm.CommonObject.Decode(json_obj)\n\n    def to_json(value):\n        \"\"\"Convert rhino3dm object to json\"\"\"\n        return json.dumps(value, cls=_HopsEncoder)\n\n    def convert_value(value):\n        return value\n\n    RHINO_FROMJSON = from_json\n    RHINO_TOJSON = to_json\n\n    RHINO_GEOM = rhino3dm\n\n    CONVERT_VALUE = convert_value\n\n\nclass HopsParamAccess(Enum):\n    \"\"\"GH Item Access\"\"\"\n\n    ITEM = 0\n    LIST = 1\n    TREE = 2\n\n\n# TODO:\n# - params can have icons too\n# cast methods\nclass _GHParam:\n    coercers = []\n    param_type = None\n    result_type = None\n\n    def __init__(\n        self,\n        name,\n        nickname=None,\n        desc=None,\n        access: HopsParamAccess = HopsParamAccess.ITEM,\n        optional=False,\n        default=None,\n    ):\n        self.name = name\n        self.nickname = nickname\n        self.description = desc\n        self.access: HopsParamAccess = access or HopsParamAccess.ITEM\n        self.optional = optional\n        self.default = default or inspect.Parameter.empty\n\n    def _coerce_value(self, param_type, param_data):\n        # get data as dict\n        data = json.loads(param_data)\n        # parse data\n        if isinstance(self.coercers, dict):\n            coercer = self.coercers.get(param_type, None)\n            if coercer:\n                return coercer(data)\n        elif param_type.startswith(\"Rhino.Geometry.\"):\n            return RHINO_FROMJSON(data)\n        return param_data\n\n    def encode(self):\n        \"\"\"Parameter serializer\"\"\"\n        param_def = {\n            \"Name\": self.name,\n            \"Nickname\": self.nickname,\n            \"Description\": self.description,\n            \"ParamType\": self.param_type,\n            \"ResultType\": self.result_type,\n            \"AtLeast\": 1,\n        }\n        if HopsParamAccess.ITEM == self.access:\n            param_def[\"AtMost\"] = 1\n        if HopsParamAccess.LIST == self.access:\n            param_def[\"AtMost\"] = 2147483647  # Max 32 bit integer value\n        if HopsParamAccess.TREE == self.access:\n            param_def[\"AtLeast\"] = -1\n            param_def[\"AtMost\"] = -1\n        if self.default != inspect.Parameter.empty:\n            param_def[\"Default\"] = self.default\n        return param_def\n\n    def from_input(self, input_data):\n        \"\"\"Extract parameter data from serialized input\"\"\"\n        if self.access == HopsParamAccess.TREE:\n            paths = input_data[\"InnerTree\"]\n            tree = {}\n            for k, v in paths.items():\n                data = []\n                for param_value_item in v:\n                    param_type = param_value_item[\"type\"]\n                    param_value = param_value_item[\"data\"]\n                    data.append(self._coerce_value(param_type, param_value))\n                tree[k] = data\n            return tree\n\n        data = []\n        for param_value_item in input_data[\"InnerTree\"][\"0\"]:\n            param_type = param_value_item[\"type\"]\n            param_value = param_value_item[\"data\"]\n            data.append(self._coerce_value(param_type, param_value))\n        if self.access == HopsParamAccess.ITEM:\n            return data[0]\n        return data\n\n    def from_result(self, value):\n        \"\"\"Serialize parameter with given value for output\"\"\"\n        if self.access == HopsParamAccess.TREE and isinstance(value, dict):\n            tree = {}\n            for key in value.keys():\n                branch_data = [\n                    {\n                        \"type\": self.result_type,\n                        \"data\": RHINO_TOJSON(CONVERT_VALUE(v)),\n                    }\n                    for v in value[key]\n                ]\n                tree[key] = branch_data\n            output = {\n                \"ParamName\": self.name,\n                \"InnerTree\": tree,\n            }\n            return output\n\n        if not isinstance(value, tuple) and not isinstance(value, list):\n            value = (value,)\n\n        output_list = [\n            {\"type\": self.result_type, \"data\": RHINO_TOJSON(CONVERT_VALUE(v))}\n            for v in value\n        ]\n\n        output = {\n            \"ParamName\": self.name,\n            \"InnerTree\": {\"0\": output_list},\n        }\n        return output\n\n\nclass HopsBoolean(_GHParam):\n    \"\"\"Wrapper for GH_Boolean\"\"\"\n\n    param_type = \"Boolean\"\n    result_type = \"System.Boolean\"\n\n    coercers = {\"System.Boolean\": lambda b: bool(b)}\n\n\nclass HopsBrep(_GHParam):\n    \"\"\"Wrapper for GH Brep\"\"\"\n\n    param_type = \"Brep\"\n    result_type = \"Rhino.Geometry.Brep\"\n\n\nclass HopsCircle(_GHParam):\n    \"\"\"Wrapper for GH_Circle\"\"\"\n\n    param_type = \"Circle\"\n    result_type = \"Rhino.Geometry.Circle\"\n\n    coercers = {\n        \"Rhino.Geometry.Circle\": lambda d: HopsCircle._make_circle(\n            HopsPlane._make_plane(\n                d[\"Plane\"][\"Origin\"], d[\"Plane\"][\"XAxis\"], d[\"Plane\"][\"YAxis\"]\n            ),\n            d[\"Radius\"],\n        )\n    }\n\n    @staticmethod\n    def _make_circle(p, r):\n        circle = RHINO_GEOM.Circle(r)\n        circle.Plane = p\n        return circle\n\n\nclass HopsCurve(_GHParam):\n    \"\"\"Wrapper for GH Curve\"\"\"\n\n    param_type = \"Curve\"\n    result_type = \"Rhino.Geometry.Curve\"\n\n\nclass HopsInteger(_GHParam):\n    \"\"\"Wrapper for GH_Integer\"\"\"\n\n    param_type = \"Integer\"\n    result_type = \"System.Int32\"\n\n    coercers = {\"System.Int32\": lambda i: int(i)}\n\n\nclass HopsLine(_GHParam):\n    \"\"\"Wrapper for GH_Line\"\"\"\n\n    param_type = \"Line\"\n    result_type = \"Rhino.Geometry.Line\"\n\n    coercers = {\n        \"Rhino.Geometry.Line\": lambda l: RHINO_GEOM.Line(\n            HopsLine._make_point(l[\"From\"]), HopsLine._make_point(l[\"To\"])\n        )\n    }\n\n    @staticmethod\n    def _make_point(a):\n        return RHINO_GEOM.Point3d(a[\"X\"], a[\"Y\"], a[\"Z\"])\n\n\nclass HopsMesh(_GHParam):\n    \"\"\"Wrapper for GH Mesh\"\"\"\n\n    param_type = \"Mesh\"\n    result_type = \"Rhino.Geometry.Mesh\"\n\n\nclass HopsNumber(_GHParam):\n    \"\"\"Wrapper for GH Number\"\"\"\n\n    param_type = \"Number\"\n    result_type = \"System.Double\"\n\n    coercers = {\n        \"System.Double\": lambda d: float(d),\n    }\n\n\nclass HopsPlane(_GHParam):\n    \"\"\"Wrapper for GH_Plane\"\"\"\n\n    param_type = \"Plane\"\n    result_type = \"Rhino.Geometry.Plane\"\n\n    coercers = {\n        \"Rhino.Geometry.Plane\": lambda p: HopsPlane._make_plane(\n            p[\"Origin\"], p[\"XAxis\"], p[\"YAxis\"]\n        )\n    }\n\n    @staticmethod\n    def _make_plane(o, x, y):\n        return RHINO_GEOM.Plane(\n            RHINO_GEOM.Point3d(o[\"X\"], o[\"Y\"], o[\"Z\"]),\n            RHINO_GEOM.Vector3d(x[\"X\"], x[\"Y\"], x[\"Z\"]),\n            RHINO_GEOM.Vector3d(y[\"X\"], y[\"Y\"], y[\"Z\"]),\n        )\n\n\nclass HopsPoint(_GHParam):\n    \"\"\"Wrapper for GH Point\"\"\"\n\n    param_type = \"Point\"\n    result_type = \"Rhino.Geometry.Point3d\"\n\n    coercers = {\n        \"Rhino.Geometry.Point2d\": lambda d: RHINO_GEOM.Point2d(d[\"X\"], d[\"Y\"]),\n        \"Rhino.Geometry.Point3d\": lambda d: RHINO_GEOM.Point3d(\n            d[\"X\"], d[\"Y\"], d[\"Z\"]\n        ),\n        \"Rhino.Geometry.Vector3d\": lambda d: RHINO_GEOM.Vector3d(\n            d[\"X\"], d[\"Y\"], d[\"Z\"]\n        ),\n    }\n\n\nclass HopsString(_GHParam):\n    \"\"\"Wrapper for GH_String\"\"\"\n\n    param_type = \"Text\"\n    result_type = \"System.String\"\n\n    coercers = {\"System.String\": lambda s: s}\n\n\nclass HopsSubD(_GHParam):\n    \"\"\"Wrapper for GH SubD\"\"\"\n\n    param_type = \"SubD\"\n    result_type = \"Rhino.Geometry.SubD\"\n\n\nclass HopsSurface(_GHParam):\n    \"\"\"Wrapper for GH Surface\"\"\"\n\n    param_type = \"Surface\"\n    result_type = \"Rhino.Geometry.Brep\"\n\n\nclass HopsVector(_GHParam):\n    \"\"\"Wrapper for GH Vector\"\"\"\n\n    param_type = \"Vector\"\n    result_type = \"Rhino.Geometry.Vector3d\"\n\n    coercers = {\n        \"Rhino.Geometry.Point2d\": lambda d: RHINO_GEOM.Point2d(d[\"X\"], d[\"Y\"]),\n        \"Rhino.Geometry.Point3d\": lambda d: RHINO_GEOM.Point3d(\n            d[\"X\"], d[\"Y\"], d[\"Z\"]\n        ),\n        \"Rhino.Geometry.Vector3d\": lambda d: RHINO_GEOM.Vector3d(\n            d[\"X\"], d[\"Y\"], d[\"Z\"]\n        ),\n    }\n",
  "language": "python",
  "imports": [
    "Rhino",
    "Rhino.Geometry",
    "RhinoCommon",
    "rhino3dm"
  ],
  "has_docstring": true
}