{
  "source_url": "https://github.com/Ennead-Architects-LLP/EA_Dist/blob/635520d89b8308b78eabf5b60bb80121d0fa3838/Apps/_rhino/View.tab/toggle_GFA.button/gfa_excel_import.py",
  "repo": "Ennead-Architects-LLP/EA_Dist",
  "repo_stars": 0,
  "repo_description": null,
  "license": "unknown",
  "filepath": "Apps/_rhino/View.tab/toggle_GFA.button/gfa_excel_import.py",
  "instruction": "GFA Excel Import Utility\r\n\r\nThis module provides functionality to import GFA (Gross Floor Area) target data\r\nfrom Excel files into the Rhino GFA system.\r\n\r\nFeatures:\r\n- Read Excel files with GFA...",
  "code": "# -*- coding: utf-8 -*-\r\n\"\"\"\r\nGFA Excel Import Utility\r\n\r\nThis module provides functionality to import GFA (Gross Floor Area) target data\r\nfrom Excel files into the Rhino GFA system.\r\n\r\nFeatures:\r\n- Read Excel files with GFA target data\r\n- Parse and validate imported data\r\n- Merge with existing GFA targets\r\n- Support for different Excel formats and structures\r\n\r\nUsage:\r\n- Called from GFA target dialog import button\r\n- Simulates Excel reading with print statements for testing\r\n\"\"\"\r\n\r\nimport rhinoscriptsyntax as rs # pyright: ignore\r\nimport scriptcontext as sc # pyright: ignore\r\nfrom EnneadTab import ERROR_HANDLE, EXCEL, NOTIFICATION\r\nfrom EnneadTab.RHINO import RHINO_PROJ_DATA\r\n\r\nclass GFAExcelImporter:\r\n    \"\"\"Handles importing GFA target data from Excel files\"\"\"\r\n    \r\n    def __init__(self):\r\n        self.supported_formats = ['.xlsx', '.xls']\r\n        self.expected_columns = ['Keyword', 'TargetArea']\r\n        self.expected_worksheet = 'Target Area'\r\n        \r\n    def import_from_excel(self, filepath=None):\r\n        \"\"\"\r\n        Import GFA targets from Excel file\r\n        \r\n        Args:\r\n            filepath (str): Path to Excel file. If None, will prompt user to select.\r\n            \r\n        Returns:\r\n            dict: Dictionary of imported GFA targets {keyword: area_value}\r\n        \"\"\"\r\n        print(\"=== GFA Excel Import Process Started ===\")\r\n        \r\n        if not filepath:\r\n            filepath = self.select_excel_file()\r\n            if not filepath:\r\n                print(\"No Excel file selected\")\r\n                return None\r\n                \r\n        print(\"Selected Excel file: {}\".format(filepath))\r\n        \r\n        # Read Excel file using EnneadTab.EXCEL\r\n        imported_data = self.read_excel_file(filepath)\r\n        \r\n        if imported_data:\r\n            print(\"Successfully imported {} GFA targets from Excel\".format(len(imported_data)))\r\n            return imported_data\r\n        else:\r\n            print(\"Failed to import data from Excel file\")\r\n            return None\r\n    \r\n    def select_excel_file(self):\r\n        \"\"\"Open file dialog to select Excel file\"\"\"\r\n        print(\"Opening file selection dialog...\")\r\n        print(\"Looking for Excel files with extensions: {}\".format(self.supported_formats))\r\n        \r\n        try:\r\n            # Use Rhino's file dialog to select Excel file\r\n            print(\"Calling rs.OpenFileName...\")\r\n            print(\"rs module available: {}\".format(rs is not None))\r\n            print(\"rs.OpenFileName available: {}\".format(hasattr(rs, 'OpenFileName')))\r\n            \r\n            filepath = rs.OpenFileName(\"Select Excel file with GFA targets\", \"Excel Files (*.xlsx;*.xls)|*.xlsx;*.xls||\")\r\n            print(\"rs.OpenFileName returned: {}\".format(filepath))\r\n            \r\n            if filepath:\r\n                print(\"Selected Excel file: {}\".format(filepath))\r\n                return filepath\r\n            else:\r\n                print(\"No Excel file selected (user cancelled or error)\")\r\n                return None\r\n                \r\n        except Exception as ex:\r\n            print(\"Error opening file dialog: {}\".format(str(ex)))\r\n            return None\r\n    \r\n    def read_excel_file(self, filepath):\r\n        \"\"\"\r\n        Read Excel file and extract GFA target data using EnneadTab.EXCEL\r\n        \r\n        Args:\r\n            filepath (str): Path to Excel file\r\n            \r\n        Returns:\r\n            dict: Dictionary of GFA targets\r\n        \"\"\"\r\n        print(\"=== Reading Excel File with EnneadTab.EXCEL ===\")\r\n        print(\"File path: {}\".format(filepath))\r\n        \r\n        # Validate file format\r\n        if not self.validate_file_format(filepath):\r\n            return None\r\n            \r\n        print(\"File format validated successfully\")\r\n        \r\n        try:\r\n            # Read Excel data using EnneadTab.EXCEL with structured parsing\r\n            print(\"Reading worksheet: 'Target Area'\")\r\n            excel_data = EXCEL.read_data_from_excel(filepath, worksheet=\"Target Area\", return_dict=True)\r\n            \r\n            if excel_data and len(excel_data) > 0:\r\n                print(\"Successfully read data from worksheet: 'Target Area'\")\r\n                print(\"Found {} cells of data\".format(len(excel_data)))\r\n                \r\n                # Try EnneadTab.EXCEL's structured parsing method first\r\n                gfa_targets = self.parse_excel_data_structured(excel_data)\r\n                \r\n                if gfa_targets:\r\n                    print(\"Found {} GFA targets using structured parsing\".format(len(gfa_targets)))\r\n                    return gfa_targets\r\n                else:\r\n                    print(\"Structured parsing failed, trying manual parsing...\")\r\n                    # Fallback to manual parsing\r\n                    gfa_targets = self.parse_excel_data(excel_data)\r\n                    \r\n                    if gfa_targets:\r\n                        print(\"Found {} GFA targets using manual parsing\".format(len(gfa_targets)))\r\n                        return gfa_targets\r\n                    else:\r\n                        print(\"No valid GFA target data found in worksheet: 'Target Area'\")\r\n                        print(\"Expected headers: 'Keyword' and 'TargetArea' (or 'Target Area')\")\r\n                        print(\"Please ensure your Excel file has:\")\r\n                        print(\"  - Worksheet named exactly: 'Target Area'\")\r\n                        print(\"  - Headers: 'Keyword' and 'TargetArea' (or 'Target Area')\")\r\n                        return None\r\n            else:\r\n                print(\"No data found in worksheet: 'Target Area'\")\r\n                print(\"Please ensure your Excel file has:\")\r\n                print(\"  - Worksheet named exactly: 'Target Area'\")\r\n                print(\"  - Headers: 'Keyword' and 'TargetArea' (or 'Target Area')\")\r\n                return None\r\n            \r\n        except Exception as ex:\r\n            print(\"Error reading Excel file: {}\".format(str(ex)))\r\n            NOTIFICATION.messenger(main_text=\"Error reading Excel file: {}\".format(str(ex)))\r\n            return None\r\n    \r\n    def parse_excel_data_structured(self, excel_data):\r\n        \"\"\"\r\n        Parse Excel data using EnneadTab.EXCEL's structured parsing method\r\n        \r\n        Args:\r\n            excel_data (dict): Excel data in (row, col) format\r\n            \r\n        Returns:\r\n            dict: Dictionary of GFA targets\r\n        \"\"\"\r\n        print(\"=== Using EnneadTab.EXCEL Structured Parsing ===\")\r\n        \r\n        try:\r\n            # Debug: Print the raw Excel data structure\r\n            print(\"Raw Excel data structure:\")\r\n            for i, (key, value) in enumerate(excel_data.items()):\r\n                if i < 10:  # Show first 10 entries\r\n                    try:\r\n                        print(\"  {}: {}\".format(key, value))\r\n                    except:\r\n                        print(\"  {}: <unprintable>\".format(key))\r\n                else:\r\n                    print(\"  ... and {} more entries\".format(len(excel_data) - 10))\r\n                    break\r\n            \r\n            # Use EnneadTab.EXCEL's parse_excel_data method with 'Keyword' as the key\r\n            parsed_data = EXCEL.parse_excel_data(excel_data, key_name=\"Keyword\", header_row=1)\r\n            \r\n            if not parsed_data:\r\n                print(\"No structured data found using 'Keyword' as key\")\r\n                # Try with 'TargetArea' as key if 'Keyword' doesn't work\r\n                parsed_data = EXCEL.parse_excel_data(excel_data, key_name=\"TargetArea\", header_row=1)\r\n                if not parsed_data:\r\n                    print(\"No structured data found using 'TargetArea' as key\")\r\n                    return None\r\n            \r\n            print(\"Found {} structured data entries\".format(len(parsed_data)))\r\n            \r\n            # Convert structured data to GFA targets format\r\n            gfa_targets = {}\r\n            \r\n            for key, data_obj in parsed_data.items():\r\n                try:\r\n                    # Get the keyword (should be the key)\r\n                    keyword = str(key).strip()\r\n                    \r\n                    # Get the target area value\r\n                    # Try different possible attribute names\r\n                    area_value = None\r\n                    if hasattr(data_obj, 'TargetArea'):\r\n                        area_value = getattr(data_obj, 'TargetArea')\r\n                    elif hasattr(data_obj, 'Target_Area'):\r\n                        area_value = getattr(data_obj, 'Target_Area')\r\n                    elif hasattr(data_obj, 'targetarea'):\r\n                        area_value = getattr(data_obj, 'targetarea')\r\n                    elif hasattr(data_obj, 'target_area'):\r\n                        area_value = getattr(data_obj, 'target_area')\r\n                    \r\n                    if area_value is not None:\r\n                        try:\r\n                            area_float = float(area_value)\r\n                            if area_float > 0:  # Only accept positive areas\r\n                                gfa_targets[keyword] = area_float\r\n                                print(\"  - {}: {:.2f}\".format(keyword, area_float))\r\n                            else:\r\n                                print(\"  - Skipping {}: invalid area value {}\".format(keyword, area_value))\r\n                        except (ValueError, TypeError):\r\n                            print(\"  - Skipping {}: could not convert area '{}' to number\".format(keyword, area_value))\r\n                    else:\r\n                        print(\"  - Skipping {}: no area value found\".format(keyword))\r\n                        \r\n                except Exception as ex:\r\n                    print(\"  - Error processing entry {}: {}\".format(key, str(ex)))\r\n                    continue\r\n            \r\n            print(\"Successfully parsed {} GFA targets using structured parsing\".format(len(gfa_targets)))\r\n            return gfa_targets if gfa_targets else None\r\n            \r\n        except Exception as ex:\r\n            print(\"Error in structured parsing: {}\".format(str(ex)))\r\n            return None\r\n    \r\n    def parse_excel_data(self, excel_data):\r\n        \"\"\"\r\n        Parse Excel data to extract GFA targets\r\n        \r\n        Args:\r\n            excel_data (dict): Excel data in (row, col) format\r\n            \r\n        Returns:\r\n            dict: Dictionary of GFA targets {keyword: area_value}\r\n        \"\"\"\r\n        print(\"=== Parsing Excel Data for GFA Targets ===\")\r\n        \r\n        gfa_targets = {}\r\n        \r\n        try:\r\n            # Find header row and column indices\r\n            header_info = self.find_header_columns(excel_data)\r\n            \r\n            if not header_info:\r\n                print(\"Could not find required header columns\")\r\n                return None\r\n            \r\n            keyword_col = header_info['keyword_col']\r\n            area_col = header_info['area_col']\r\n            start_row = header_info['start_row']\r\n            \r\n            print(\"Found headers - Keyword column: {}, Area column: {}, Start row: {}\".format(\r\n                keyword_col, area_col, start_row))\r\n            \r\n            # Extract data rows\r\n            for row in range(start_row + 1, 1000):  # Check up to row 1000\r\n                keyword_cell = (row, keyword_col)\r\n                area_cell = (row, area_col)\r\n                \r\n                if keyword_cell in excel_data and area_cell in excel_data:\r\n                    keyword = str(excel_data[keyword_cell]).strip()\r\n                    area_value = excel_data[area_cell]\r\n                    \r\n                    # Skip empty rows\r\n                    if not keyword or keyword == \"\":\r\n                        continue\r\n                    \r\n                    # Try to convert area to float\r\n                    try:\r\n                        area_float = float(area_value)\r\n                        if area_float > 0:  # Only accept positive areas\r\n                            gfa_targets[keyword] = area_float\r\n                            print(\"  - {}: {:.2f}\".format(keyword, area_float))\r\n                        else:\r\n                            print(\"  - Skipping {}: invalid area value {}\".format(keyword, area_value))\r\n                    except (ValueError, TypeError):\r\n                        print(\"  - Skipping {}: could not convert area '{}' to number\".format(keyword, area_value))\r\n                else:\r\n                    # No more data rows\r\n                    break\r\n            \r\n            print(\"Parsed {} GFA targets from Excel data\".format(len(gfa_targets)))\r\n            return gfa_targets if gfa_targets else None\r\n            \r\n        except Exception as ex:\r\n            print(\"Error parsing Excel data: {}\".format(str(ex)))\r\n            return None\r\n    \r\n    def find_header_columns(self, excel_data):\r\n        \"\"\"\r\n        Find the column indices for Keyword and Target_Area columns\r\n        \r\n        Args:\r\n            excel_data (dict): Excel data in (row, col) format\r\n            \r\n        Returns:\r\n            dict: Dictionary with column indices and start row\r\n        \"\"\"\r\n        print(\"Looking for exact header columns...\")\r\n        print(\"Expected headers: 'Keyword' and 'TargetArea' (or 'Target Area')\")\r\n        \r\n        # Exact header names to look for\r\n        keyword_headers = ['Keyword']\r\n        area_headers = ['TargetArea', 'Target Area']\r\n        \r\n        keyword_col = None\r\n        area_col = None\r\n        start_row = None\r\n        \r\n        # Debug: Print all cell values in the first few rows\r\n        print(\"Debug: All cell values in first 5 rows:\")\r\n        for row in range(1, 6):\r\n            row_values = []\r\n            for col in range(1, 11):  # Check first 10 columns\r\n                cell_key = (row, col)\r\n                if cell_key in excel_data:\r\n                    try:\r\n                        cell_value = str(excel_data[cell_key]).strip()\r\n                        row_values.append(\"'{}'\".format(cell_value))\r\n                    except:\r\n                        row_values.append(\"'<unprintable>'\")\r\n                else:\r\n                    row_values.append(\"(empty)\")\r\n            print(\"  Row {}: [{}]\".format(row, \", \".join(row_values)))\r\n        \r\n        # Search through the first 20 rows and columns\r\n        for row in range(1, 21):\r\n            for col in range(1, 21):\r\n                cell_key = (row, col)\r\n                if cell_key in excel_data:\r\n                    cell_value = str(excel_data[cell_key]).strip()\r\n                    \r\n                    # Check if this is a keyword header\r\n                    if cell_value in keyword_headers:\r\n                        keyword_col = col\r\n                        start_row = row\r\n                        print(\"Found keyword header '{}' at row {}, col {}\".format(cell_value, row, col))\r\n                    \r\n                    # Check if this is an area header\r\n                    if cell_value in area_headers:\r\n                        area_col = col\r\n                        if start_row is None:\r\n                            start_row = row\r\n                        print(\"Found area header '{}' at row {}, col {}\".format(cell_value, row, col))\r\n        \r\n        if keyword_col and area_col:\r\n            return {\r\n                'keyword_col': keyword_col,\r\n                'area_col': area_col,\r\n                'start_row': start_row\r\n            }\r\n        else:\r\n            print(\"Could not find required header columns\")\r\n            print(\"Expected headers: 'Keyword' and 'TargetArea' (or 'Target Area')\")\r\n            print(\"Please ensure your Excel file has:\")\r\n            print(\"  - Worksheet named exactly: 'Target Area'\")\r\n            print(\"  - Headers: 'Keyword' and 'TargetArea' (or 'Target Area')\")\r\n            return None\r\n    \r\n    def validate_file_format(self, filepath):\r\n        \"\"\"Validate that the file is a supported Excel format\"\"\"\r\n        print(\"Validating file format...\")\r\n        \r\n        # Check file extension\r\n        file_ext = filepath.lower().split('.')[-1]\r\n        if '.' + file_ext not in self.supported_formats:\r\n            print(\"ERROR: Unsupported file format: {}\".format(file_ext))\r\n            print(\"Supported formats: {}\".format(self.supported_formats))\r\n            return False\r\n            \r\n        print(\"File format is valid: {}\".format(file_ext))\r\n        return True\r\n    \r\n    \r\n    def merge_with_existing_targets(self, imported_data):\r\n        \"\"\"\r\n        Merge imported data with existing GFA targets\r\n        \r\n        Args:\r\n            imported_data (dict): Imported GFA targets\r\n            \r\n        Returns:\r\n            dict: Updated GFA targets dictionary\r\n        \"\"\"\r\n        print(\"=== Merging Imported Data with Existing Targets ===\")\r\n        \r\n        # Get current GFA targets from project data\r\n        data = RHINO_PROJ_DATA.get_plugin_data()\r\n        existing_targets = data.get(RHINO_PROJ_DATA.DocKeys.GFA_TARGET_DICT, {})\r\n        \r\n        print(\"Current GFA targets:\")\r\n        for key, value in existing_targets.items():\r\n            print(\"  - {}: {:.2f}\".format(key, value))\r\n        \r\n        # Track changes\r\n        updated_items = []\r\n        new_items = []\r\n        unchanged_items = []\r\n        \r\n        # Merge imported data\r\n        for keyword, area in imported_data.items():\r\n            if keyword in existing_targets:\r\n                if existing_targets[keyword] != area:\r\n                    updated_items.append((keyword, existing_targets[keyword], area))\r\n                else:\r\n                    unchanged_items.append(keyword)\r\n                existing_targets[keyword] = area\r\n            else:\r\n                new_items.append((keyword, area))\r\n                existing_targets[keyword] = area\r\n        \r\n        # Report changes\r\n        if updated_items:\r\n            print(\"Updated existing targets:\")\r\n            for keyword, old_value, new_value in updated_items:\r\n                print(\"  - {}: {:.2f} -> {:.2f}\".format(keyword, old_value, new_value))\r\n        \r\n        if new_items:\r\n            print(\"Added new targets:\")\r\n            for keyword, area in new_items:\r\n                print(\"  - {}: {:.2f}\".format(keyword, area))\r\n        \r\n        if unchanged_items:\r\n            print(\"Unchanged targets:\")\r\n            for keyword in unchanged_items:\r\n                print(\"  - {}: {:.2f}\".format(keyword, existing_targets[keyword]))\r\n        \r\n        # Save updated targets\r\n        data[RHINO_PROJ_DATA.DocKeys.GFA_TARGET_DICT] = existing_targets\r\n        RHINO_PROJ_DATA.set_plugin_data(data)\r\n        \r\n        print(\"Merge completed successfully!\")\r\n        print(\"Total GFA targets: {}\".format(len(existing_targets)))\r\n        \r\n        return existing_targets\r\n\r\n@ERROR_HANDLE.try_catch_error()\r\ndef import_gfa_from_excel(filepath=None):\r\n    \"\"\"\r\n    Main function to import GFA targets from Excel file\r\n    \r\n    Args:\r\n        filepath (str, optional): Path to Excel file\r\n        \r\n    Returns:\r\n        dict: Imported GFA targets or None if failed\r\n    \"\"\"\r\n    print(\"=== GFA Excel Import Function Called ===\")\r\n    print(\"Input filepath: {}\".format(filepath))\r\n    \r\n    importer = GFAExcelImporter()\r\n    imported_data = importer.import_from_excel(filepath)\r\n    \r\n    if imported_data:\r\n        print(\"Successfully imported data, merging with existing targets...\")\r\n        # Merge with existing targets\r\n        final_targets = importer.merge_with_existing_targets(imported_data)\r\n        return final_targets\r\n    else:\r\n        print(\"No data imported\")\r\n        return None\r\n\r\n@ERROR_HANDLE.try_catch_error() \r\ndef test_excel_import():\r\n    \"\"\"Test function to demonstrate Excel import functionality\"\"\"\r\n    print(\"=== Testing GFA Excel Import Functionality ===\")\r\n    \r\n    # Test the import process\r\n    result = import_gfa_from_excel()\r\n    \r\n    if result:\r\n        print(\"Test completed successfully!\")\r\n        print(\"Final GFA targets:\")\r\n        for keyword, area in result.items():\r\n            print(\"  - {}: {:.2f}\".format(keyword, area))\r\n    else:\r\n        print(\"Test failed - no data imported\")\r\n\r\nif __name__ == \"__main__\":\r\n    test_excel_import()\r\n",
  "language": "python",
  "imports": [
    "rhinoscriptsyntax",
    "scriptcontext"
  ],
  "has_docstring": true
}