{
  "source_url": "https://github.com/McMuff86/RhinoLeaderTool/blob/880966d9ae5c50786ba91882e3ffffcddcc64e1d/leader_editor_panel.py",
  "repo": "McMuff86/RhinoLeaderTool",
  "repo_stars": 0,
  "repo_description": null,
  "license": "unknown",
  "filepath": "leader_editor_panel.py",
  "instruction": "Leader editor panel",
  "code": "import rhinoscriptsyntax as rs\nimport scriptcontext as sc\nimport Rhino\nimport Rhino.UI\nimport os\nimport json\n\n\ndef _load_config_local():\n    try:\n        script_dir = os.path.dirname(os.path.abspath(__file__))\n    except Exception:\n        script_dir = os.getcwd()\n    default = {\n        \"export\": {\n            \"na_value\": \"NA\",\n            \"floor_sort\": True\n        }\n    }\n    try:\n        cfg_path = os.path.join(script_dir, \"config.json\")\n        if os.path.isfile(cfg_path):\n            with open(cfg_path, \"r\", encoding=\"utf-8\") as f:\n                loaded = json.load(f)\n            for k, v in loaded.items():\n                default[k] = v\n    except Exception:\n        pass\n    return default\n\n\ndef _scan_leaders_for_editor(cfg):\n    leaders = []\n    keys_union = []\n    seen_keys = set()\n    try:\n        for obj in sc.doc.Objects:\n            try:\n                geom = obj.Geometry\n            except Exception:\n                continue\n            if isinstance(geom, Rhino.Geometry.Leader):\n                leader = geom\n                dimstyle_id = leader.DimensionStyleId\n                dimstyle = sc.doc.DimStyles.FindId(dimstyle_id)\n                text = leader.Text.replace('\\r\\n', ' ').replace('\\n', ' ')\n                udict = {}\n                keys = obj.Attributes.GetUserStrings()\n                if keys:\n                    for k in keys.AllKeys:\n                        try:\n                            v = keys[k]\n                        except Exception:\n                            v = None\n                        if k not in udict:\n                            udict[k] = v\n                        if k not in seen_keys:\n                            seen_keys.add(k)\n                            keys_union.append(k)\n                # ensure LeaderGUID\n                try:\n                    guid_text = str(obj.Id)\n                except Exception:\n                    guid_text = None\n                if udict.get(\"LeaderGUID\") is None and guid_text:\n                    udict[\"LeaderGUID\"] = guid_text\n                    if \"LeaderGUID\" not in seen_keys:\n                        seen_keys.add(\"LeaderGUID\")\n                        keys_union.append(\"LeaderGUID\")\n                leaders.append({\n                    \"text\": text,\n                    \"dimstyle\": dimstyle.Name if dimstyle else \"\",\n                    \"guid\": guid_text,\n                    \"user\": udict,\n                })\n    except Exception:\n        pass\n    return leaders, keys_union\n\n\ndef show_leader_editor():\n    try:\n        import Eto.Forms as forms\n        import Eto.Drawing as drawing\n    except Exception as ex:\n        print(\"[LeaderEditor] Eto not available:\", ex)\n        return\n\n    cfg = _load_config_local()\n    try:\n        active_doc = Rhino.RhinoDoc.ActiveDoc\n        if active_doc is not None:\n            sc.doc = active_doc\n    except Exception:\n        pass\n\n    leaders, keys_union = _scan_leaders_for_editor(cfg)\n    if not leaders:\n        print(\"[LeaderEditor] No leaders found.\")\n    # Build grid data\n    header_keys = [\"text\", \"dimstyle\"] + [k for k in keys_union if k != \"LeaderGUID\"] + [\"LeaderGUID\"]\n\n    form = forms.Form()\n    form.Title = \"Leader Editor (Modeless)\"\n    try:\n        form.ClientSize = drawing.Size(1000, 640)\n    except Exception:\n        pass\n\n    layout = forms.DynamicLayout()\n    layout.Padding = drawing.Padding(10)\n    layout.Spacing = drawing.Size(6, 6)\n\n    search_tb = forms.TextBox()\n    try:\n        search_tb.PlaceholderText = \"Search\"\n    except Exception:\n        pass\n    layout.AddRow(search_tb)\n\n    grid = forms.TreeGridView()\n    grid.ShowHeader = True\n    grid.AllowMultipleSelection = False\n    try:\n        grid.RowHeight = 22\n    except Exception:\n        pass\n\n    # Column setup\n    col_keys = list(header_keys)\n    def add_col(idx, name, width=None, editable=False, visible=True):\n        col = forms.GridColumn()\n        col.HeaderText = name\n        try:\n            if width:\n                col.Width = width\n        except Exception:\n            pass\n        try:\n            col.Editable = editable\n        except Exception:\n            pass\n        try:\n            col.Sortable = True\n        except Exception:\n            pass\n        col.DataCell = forms.TextBoxCell(idx)\n        try:\n            col.Visible = bool(visible)\n        except Exception:\n            if not visible:\n                try:\n                    col.Width = 0\n                except Exception:\n                    pass\n        grid.Columns.Add(col)\n        return col\n\n    add_col(0, \"text\", 260, editable=False)\n    add_col(1, \"dimstyle\", 180, editable=False)\n    # editable keys in-between\n    for i, k in enumerate(header_keys[2:-1]):\n        add_col(i + 2, k, editable=True)\n    # hidden GUID\n    add_col(len(header_keys) - 1, \"LeaderGUID\", editable=False, visible=False)\n\n    # Build initial store\n    def build_rows(source):\n        try:\n            items = forms.TreeGridItemCollection()\n        except Exception:\n            class _S(list):\n                pass\n            items = _S()\n        for it in source:\n            vals = []\n            vals.append(it.get(\"text\", \"\"))\n            vals.append(it.get(\"dimstyle\", \"\"))\n            user = it.get(\"user\") or {}\n            for k in header_keys[2:-1]:\n                vals.append(\"\" if user.get(k) is None else str(user.get(k)))\n            vals.append(it.get(\"guid\", \"\"))\n            try:\n                tri = forms.TreeGridItem(vals)\n            except Exception:\n                tri = forms.TreeGridItem()\n                tri.Values = vals\n            try:\n                items.Add(tri)\n            except Exception:\n                items.append(tri)\n        return items\n\n    state = {\"rows\": leaders, \"view\": leaders}\n    grid.DataStore = build_rows(state[\"view\"])\n\n    def apply_filter():\n        s = (search_tb.Text or \"\").strip().lower()\n        if not s:\n            state[\"view\"] = list(state[\"rows\"])\n        else:\n            filtered = []\n            for it in state[\"rows\"]:\n                try:\n                    joined = \"{} {} {}\".format(it.get(\"text\", \"\"), it.get(\"dimstyle\", \"\"), \" \".join([\"{}={}\".format(k, v) for k, v in (it.get(\"user\") or {}).items() if v is not None])).lower()\n                    if s in joined:\n                        filtered.append(it)\n                except Exception:\n                    pass\n            state[\"view\"] = filtered\n        grid.DataStore = build_rows(state[\"view\"])\n\n    search_tb.TextChanged += lambda s, e: apply_filter()\n\n    # Commit on cell edited (RhinoCommon)\n    def on_cell_edited(sender, e):\n        try:\n            col_index = -1\n            try:\n                for i in range(len(grid.Columns)):\n                    if grid.Columns[i] == e.Column:\n                        col_index = i; break\n            except Exception:\n                col_index = -1\n            if col_index < 0 or col_index >= len(col_keys):\n                return\n            key = col_keys[col_index]\n            if key in (\"text\", \"dimstyle\", \"LeaderGUID\"):\n                return\n            vals = None\n            try:\n                vals = e.Item.Values\n            except Exception:\n                vals = None\n            if vals is None:\n                return\n            new_val = vals[col_index] if col_index < len(vals) else \"\"\n            guid_text = None\n            try:\n                gidx = col_keys.index(\"LeaderGUID\")\n                if gidx < len(vals):\n                    guid_text = vals[gidx]\n            except Exception:\n                guid_text = None\n            if not guid_text:\n                return\n            import System\n            try:\n                obj_id = System.Guid(guid_text)\n            except Exception:\n                obj_id = None\n            if obj_id is None:\n                return\n            # Write via RhinoCommon\n            ro = sc.doc.Objects.FindId(obj_id)\n            if ro is None:\n                return\n            try:\n                if ro.IsLocked:\n                    return\n            except Exception:\n                pass\n            attrs = None\n            try:\n                attrs = ro.Attributes.Duplicate()\n            except Exception:\n                attrs = None\n            if attrs is None:\n                return\n            try:\n                attrs.SetUserString(key, \"\" if new_val is None else str(new_val))\n            except Exception:\n                return\n            ok = False\n            try:\n                rec = sc.doc.BeginUndoRecord(\"Leader Editor Edit\")\n            except Exception:\n                rec = None\n            try:\n                ok = sc.doc.Objects.ModifyAttributes(ro, attrs, True)\n            except Exception:\n                ok = False\n            try:\n                if rec is not None:\n                    sc.doc.EndUndoRecord(rec)\n            except Exception:\n                pass\n            if ok:\n                try:\n                    sc.doc.Views.Redraw()\n                except Exception:\n                    pass\n                # update cached row model\n                try:\n                    for it in state[\"rows\"]:\n                        if it.get(\"guid\") == guid_text:\n                            it.get(\"user\", {})[key] = \"\" if new_val is None else str(new_val)\n                            break\n                except Exception:\n                    pass\n        except Exception:\n            pass\n\n    try:\n        grid.CellEdited += on_cell_edited\n    except Exception:\n        pass\n\n    # Buttons\n    def on_refresh(sender, e):\n        try:\n            leaders2, keys2 = _scan_leaders_for_editor(cfg)\n        except Exception:\n            leaders2, keys2 = [], []\n        # Rebuild columns if key set changed is more complex; for now just rebuild rows\n        state[\"rows\"] = leaders2\n        state[\"view\"] = leaders2\n        apply_filter()\n\n    def on_show(sender, e):\n        try:\n            sel = grid.SelectedItem\n        except Exception:\n            sel = None\n        if sel is None:\n            return\n        vals = None\n        try:\n            vals = sel.Values\n        except Exception:\n            vals = None\n        if not vals:\n            return\n        guid_text = None\n        try:\n            gidx = col_keys.index(\"LeaderGUID\")\n            if gidx < len(vals):\n                guid_text = vals[gidx]\n        except Exception:\n            guid_text = None\n        if not guid_text:\n            return\n        try:\n            import System\n            obj_id = System.Guid(guid_text)\n        except Exception:\n            obj_id = None\n        if obj_id:\n            try:\n                rs.UnselectAllObjects()\n            except Exception:\n                pass\n            try:\n                rs.SelectObject(obj_id)\n                rs.ZoomSelected()\n            except Exception:\n                pass\n\n    btn_refresh = forms.Button()\n    btn_show = forms.Button()\n    btn_close = forms.Button()\n    try:\n        btn_refresh.Text = \"Refresh\"\n        btn_show.Text = \"Show\"\n        btn_close.Text = \"Close\"\n    except Exception:\n        pass\n    try:\n        btn_refresh.Click += on_refresh\n        btn_show.Click += on_show\n        btn_close.Click += lambda s, e: form.Close()\n    except Exception:\n        pass\n\n    layout.AddRow(grid)\n    layout.AddSeparateRow(None, btn_show, btn_refresh, btn_close)\n    form.Content = layout\n\n    try:\n        form.Show()\n    except Exception:\n        try:\n            Rhino.UI.EtoExtensions.ShowSemiModal(form, sc.doc, Rhino.UI.RhinoEtoApp.MainWindow)\n        except Exception:\n            form.Show()\n\n\n\n",
  "language": "python",
  "imports": [
    "Rhino",
    "Rhino.Geometry",
    "RhinoCommon",
    "rhinoscriptsyntax",
    "scriptcontext"
  ],
  "has_docstring": false
}