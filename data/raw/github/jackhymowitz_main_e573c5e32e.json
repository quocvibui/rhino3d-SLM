{
  "source_url": "https://github.com/jackhymowitz/main/blob/7325131db23094f1a28bd184b6a68f864f41a729/01_GH_Components/py/BT_WriteXLWorkbook.py",
  "repo": "jackhymowitz/main",
  "repo_stars": 0,
  "repo_description": "IDF2PH is a free open source toolkit for working with E+ and PHPP Energy Models",
  "license": "GPL-3.0",
  "filepath": "01_GH_Components/py/BT_WriteXLWorkbook.py",
  "instruction": "Writes a series of objects to an excel sheet, then recalculates the sheet.\r\r\nThese objects should be in a Treemap, and need a Worksheet, Range, and Value variable.\r\r\nOptionally only writes the...",
  "code": "#\r\r\n# IDF2PHPP: A Plugin for exporting an EnergyPlus IDF file to the Passive House Planning Package (PHPP). Created by blgdtyp, llc\r\r\n# \r\r\n# This component is part of IDF2PHPP.\r\r\n# \r\r\n# Copyright (c) 2020, bldgtyp, llc <info@bldgtyp.com> \r\r\n# IDF2PHPP is free software; you can redistribute it and/or modify \r\r\n# it under the terms of the GNU General Public License as published \r\r\n# by the Free Software Foundation; either version 3 of the License, \r\r\n# or (at your option) any later version. \r\r\n# \r\r\n# IDF2PHPP is distributed in the hope that it will be useful,\r\r\n# but WITHOUT ANY WARRANTY; without even the implied warranty of \r\r\n# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the \r\r\n# GNU General Public License for more details.\r\r\n# \r\r\n# For a copy of the GNU General Public License\r\r\n# see <http://www.gnu.org/licenses/>.\r\r\n# \r\r\n# @license GPL-3.0+ <http://spdx.org/licenses/GPL-3.0+>\r\r\n#\r\r\n\"\"\"\r\r\nWrites a series of objects to an excel sheet, then recalculates the sheet.\r\r\nThese objects should be in a Treemap, and need a Worksheet, Range, and Value variable.\r\r\nOptionally only writes the differances from the last execution of this function, to reduce writing time.\r\r\n-\r\r\nComponent by Jack Hymowitz, July 31, 2020\r\r\n\r\r\n    Args:\r\r\n        _excel: A running ExcelInterface from OpenExcel Workbook\r\r\n        useDiff_: Set to True to only write the differance out to excel, enabled by default.\r\r\n        color_: set to True to highlight outputted fields, enabled by default.\r\r\n        _XL_Objects: TreeMap of objects to write with Worksheet, Range, and Value\r\r\n    Returns:\r\r\n        excel: The running ExcelInterface is outputted after this function runs.\r\r\n        numWrites: The number of writes that occured, for debugging purposes.\r\r\n\"\"\"\r\r\nghenv.Component.Name = \"BT_WriteXLWorkbook\"\r\r\nghenv.Component.NickName = \"Write XL Workbook\"\r\r\nghenv.Component.Message = 'JUL_31_2020'\r\r\nghenv.Component.IconDisplayMode = ghenv.Component.IconDisplayMode.application\r\r\nghenv.Component.Category = \"BT\"\r\r\nghenv.Component.SubCategory = \"02 | IDF2PHPP\"\r\r\n\r\r\nfrom ghpythonlib.componentbase import executingcomponent as component\r\r\nimport Grasshopper, GhPython\r\r\nimport System\r\r\nimport Rhino\r\r\nimport rhinoscriptsyntax as rs\r\r\nimport Grasshopper.Kernel as ghK\r\r\nimport scriptcontext as sc\r\r\nfrom System import Object\r\r\nfrom Grasshopper.Kernel.Data import GH_Path\r\r\nimport clr\r\r\nclr.AddReferenceByName('Microsoft.Office.Interop.Excel')#, Culture=neutral, PublicKeyToken=71e9bce111e9429c')\r\r\nfrom Microsoft.Office.Interop import Excel\r\r\n\r\r\n\r\r\nclass MyComponent(component):\r\r\n    #If useDiff is false, this is used. Simply reads all objects in\r\r\n    def doReadObjs(self,objects):\r\r\n        diff=[]\r\r\n        for eachBranch in objects.Branches:\r\r\n            for obj in eachBranch:\r\r\n                diff.append((obj.Worksheet,obj.Range,obj.Value))\r\r\n        return diff\r\r\n    #If useDiff is true (or not set), this is used. Only objects that have changed are written\r\r\n    def doDiff(self,objects):\r\r\n        newObj={}\r\r\n        for eachBranch in objects.Branches:\r\r\n            for obj in eachBranch:\r\r\n                newObj[(obj.Worksheet,obj.Range)]=obj.Value;\r\r\n        diff=[]\r\r\n        if \"XLSdata\" in sc.sticky:    #We are checking diffs\r\r\n            oldObj=sc.sticky[\"XLSdata\"]\r\r\n            for x in newObj.keys():\r\r\n                if not x in oldObj.keys() or oldObj[x]!=newObj[x]: #If the value didn't exist before or was changed, it's a change\r\r\n                    diff.append((x[0],x[1],newObj[x]))\r\r\n            for x in oldObj.keys():\r\r\n                if not x in newObj.keys():                         #If the value existed before and is now gone, it is a change\r\r\n                    diff.append((x[0],x[1],\"\"))\r\r\n            \r\r\n        else:                                       #Not checking diffs\r\r\n            for x in newObj.keys():\r\r\n                diff.append((x[0],x[1],newObj[x]))\r\r\n        sc.sticky[\"newXLSdata\"]=newObj\r\r\n        return diff\r\r\n        \r\r\n    #Write out the data we have found\r\r\n    def doWrite(self,excel,border,data):\r\r\n        print(excel.ex.Calculation)\r\r\n        excel.ex.Calculation = -4135 #= xlCalculationManual # only works AFTER the workbook is opened\r\r\n        for eachItem in data:\r\r\n            try:\r\r\n                #print(eachItem)\r\r\n                excel.sheetsDict[eachItem[0]].Range[eachItem[1]].Value2 = eachItem[2]\r\r\n                #excel.sheetsDict[eachItem[0]].Range[eachItem[1]].Interior.BorderAround(Weight=Excel.XLBorderWeight.xlThin,Color=(255,0,255))\r\r\n                if(border == None or border):\r\r\n                    excel.sheetsDict[eachItem[0]].Range[eachItem[1]].Interior.ColorIndex=8\r\r\n            except:\r\r\n                msg1 = \"Sheet not found: \"+eachItem[0]\r\r\n                ghenv.Component.AddRuntimeMessage(ghK.GH_RuntimeMessageLevel.Warning, msg1)\r\r\n        if \"newXLSdata\" in sc.sticky:\r\r\n            sc.sticky[\"XLSdata\"]=sc.sticky[\"newXLSdata\"]\r\r\n        excel.ex.Calculation = -4105 #= xlCalculationAuto # only works AFTER the workbook is opened\r\r\n    \r\r\n    def RunScript(self, excel, useDiff, border, XL_Objects):\r\r\n        if not excel or not excel.activeWorkbook or not XL_Objects:\r\r\n            msg1 = \"No Excel Instance!\"\r\r\n            ghenv.Component.AddRuntimeMessage(ghK.GH_RuntimeMessageLevel.Warning, msg1)\r\r\n            return (None,0)\r\r\n        if useDiff is None or useDiff:\r\r\n            diff=self.doDiff(XL_Objects)\r\r\n        else:\r\r\n            diff=self.doReadObjs(XL_Objects)\r\r\n        self.doWrite(excel, border,diff)\r\r\n        excel.ex.Calculate()\r\r\n        return (excel,len(diff))\r\r\n\r\n",
  "language": "python",
  "imports": [
    "Rhino",
    "ghpythonlib",
    "rhinoscriptsyntax",
    "scriptcontext"
  ],
  "has_docstring": true
}