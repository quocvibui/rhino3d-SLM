{
  "source_url": "https://github.com/dongwoosuk/grasshopper-quality-analyzer/blob/6247d27504eba565ae636e1a3e11c922ec5691a3/mcp/utilities/export_to_json.py",
  "repo": "dongwoosuk/grasshopper-quality-analyzer",
  "repo_stars": 1,
  "repo_description": "Automated quality analysis for Grasshopper definitions.  Real-time lint checking and code quality scoring to improve AEC  industry productivity. Includes MCP server for advanced analysis.",
  "license": "MIT",
  "filepath": "mcp/utilities/export_to_json.py",
  "instruction": "CPython Script Component: Export GH Definition to JSON\nExports the current Grasshopper definition to a structured JSON file for analysis",
  "code": "\"\"\"CPython Script Component: Export GH Definition to JSON\nExports the current Grasshopper definition to a structured JSON file for analysis\n\nInputs:\n    out_path: str (e.g. r\"C:\\...\\my_def.json\")\n\nOutputs:\n    a: string  # Status message\n\"\"\"\nimport json\nimport rhinoscriptsyntax as rs\nimport Rhino\nimport Grasshopper as gh\nimport scriptcontext as sc\n\n# Get the active Grasshopper document\ntry:\n    doc = ghenv.Component.OnPingDocument()\nexcept:\n    a = \"ERROR: Could not access Grasshopper document\"\n    raise Exception(a)\n\n# Get document properties safely\ndoc_title = \"\"\ndoc_path = \"\"\ngh_version = \"\"\n\ntry:\n    if hasattr(doc, 'Properties') and doc.Properties:\n        doc_title = str(doc.Properties.Description) if hasattr(doc.Properties, 'Description') else \"\"\nexcept:\n    pass\n\ntry:\n    if hasattr(doc, 'FilePath') and doc.FilePath:\n        doc_path = str(doc.FilePath)\nexcept:\n    pass\n\ntry:\n    gh_version = str(gh.Folders.GrasshopperVersion)\nexcept:\n    pass\n\ndata = {\n    \"document\": {\n        \"title\": doc_title,\n        \"path\": doc_path,\n        \"gh_version\": gh_version\n    },\n    \"components\": [],\n    \"params\": [],\n    \"wires\": [],\n    \"warnings\": []\n}\n\ndef pt_to_xy(pt):\n    try:\n        return [float(pt.X), float(pt.Y)]\n    except:\n        return [0.0, 0.0]\n\ndef get_group_id(obj):\n    \"\"\"Safely get group ID\"\"\"\n    try:\n        if hasattr(obj, 'Attributes') and obj.Attributes:\n            if hasattr(obj.Attributes, 'GetTopLevel'):\n                container = obj.Attributes.GetTopLevel\n                if container and hasattr(container, 'InstanceGuid'):\n                    return str(container.InstanceGuid)\n    except:\n        pass\n    return None\n\ndef get_owner_guid(param):\n    \"\"\"Get the GUID of the component or parameter that owns this parameter\"\"\"\n    try:\n        # Try to get parent component/parameter\n        if hasattr(param, 'Attributes') and param.Attributes:\n            if hasattr(param.Attributes, 'Parent') and param.Attributes.Parent:\n                parent_obj = param.Attributes.Parent.DocObject\n                if parent_obj and hasattr(parent_obj, 'InstanceGuid'):\n                    return str(parent_obj.InstanceGuid)\n        \n        # If no parent, the param itself might be the target (standalone parameter)\n        if hasattr(param, 'InstanceGuid'):\n            return str(param.InstanceGuid)\n    except:\n        pass\n    return None\n\ndef extract_volatile_data(param):\n    \"\"\"Extract actual data from parameter's VolatileData\"\"\"\n    try:\n        if not hasattr(param, 'VolatileData') or param.VolatileData is None:\n            return None\n        \n        volatile_data = param.VolatileData\n        if volatile_data.IsEmpty:\n            return None\n        \n        # Extract data from all branches\n        result = []\n        for i in range(volatile_data.PathCount):\n            path = volatile_data.get_Path(i)\n            branch = volatile_data.get_Branch(path)\n            \n            branch_data = []\n            for item in branch:\n                try:\n                    # Try to get the actual value\n                    if hasattr(item, 'Value'):\n                        val = item.Value\n                    else:\n                        val = item\n                    \n                    # Convert to string representation\n                    if val is not None:\n                        branch_data.append(str(val))\n                except:\n                    pass\n            \n            if branch_data:\n                result.append(branch_data)\n        \n        return result if result else None\n    except:\n        return None\n\n# First pass - collect all objects\nfor obj in doc.Objects:\n    try:\n        dobj = {\n            \"guid\": str(obj.InstanceGuid),\n            \"name\": str(obj.NickName or obj.Name or obj.Description or \"\"),\n            \"type\": str(obj.GetType().FullName),\n            \"category\": str(getattr(obj, \"Category\", \"\")),\n            \"subcategory\": str(getattr(obj, \"SubCategory\", \"\")),\n            \"pos\": pt_to_xy(obj.Attributes.Pivot) if hasattr(obj, 'Attributes') else [0, 0],\n            \"group\": get_group_id(obj)\n        }\n        \n        # Check if component\n        if isinstance(obj, gh.Kernel.IGH_Component):\n            ins = []\n            try:\n                for i, ip in enumerate(obj.Params.Input):\n                    param_info = {\n                        \"index\": i,\n                        \"name\": str(ip.NickName or ip.Name or \"\"),\n                        \"tree_access\": str(ip.Access) if hasattr(ip, 'Access') else \"\",\n                        \"source_count\": ip.SourceCount if hasattr(ip, 'SourceCount') else 0\n                    }\n                    if hasattr(ip, \"TypeHint\"):\n                        param_info[\"type_hint\"] = str(ip.TypeHint)\n                    ins.append(param_info)\n            except Exception as e:\n                data[\"warnings\"].append(f\"input_error: {e}\")\n            \n            outs = []\n            try:\n                for i, op in enumerate(obj.Params.Output):\n                    out_info = {\n                        \"index\": i,\n                        \"name\": str(op.NickName or op.Name or \"\"),\n                        \"tree_access\": str(op.Access) if hasattr(op, 'Access') else \"\",\n                        \"recipient_count\": op.RecipientCount if hasattr(op, 'RecipientCount') else 0\n                    }\n                    \n                    # Extract volatile data from output parameters\n                    volatile = extract_volatile_data(op)\n                    if volatile:\n                        out_info[\"data\"] = volatile\n                    \n                    outs.append(out_info)\n            except Exception as e:\n                data[\"warnings\"].append(f\"output_error: {e}\")\n            \n            dobj[\"inputs\"] = ins\n            dobj[\"outputs\"] = outs\n            data[\"components\"].append(dobj)\n        else:\n            # Parameter objects\n            dobj[\"param_kind\"] = str(obj.GetType().Name)\n            \n            # Add source/recipient counts for parameters too\n            try:\n                if hasattr(obj, 'SourceCount'):\n                    dobj[\"source_count\"] = obj.SourceCount\n                if hasattr(obj, 'RecipientCount'):\n                    dobj[\"recipient_count\"] = obj.RecipientCount\n            except:\n                pass\n            \n            # Slider values and Panel data\n            try:\n                from Grasshopper.Kernel.Special import GH_NumberSlider, GH_Panel\n                if isinstance(obj, GH_NumberSlider):\n                    dobj[\"slider\"] = {\n                        \"value\": float(obj.CurrentValue),\n                        \"min\": float(obj.Slider.Minimum),\n                        \"max\": float(obj.Slider.Maximum),\n                        \"rounding\": int(obj.Slider.Rounding)\n                    }\n                elif isinstance(obj, GH_Panel):\n                    # Get user text (static text)\n                    dobj[\"panel_text\"] = str(obj.UserText)\n                    \n                    # Get volatile data (actual displayed data from connected components)\n                    volatile = extract_volatile_data(obj)\n                    if volatile:\n                        dobj[\"panel_data\"] = volatile\n            except:\n                pass\n            \n            data[\"params\"].append(dobj)\n    \n    except Exception as e:\n        data[\"warnings\"].append(f\"critical_error: {obj.GetType().Name if hasattr(obj, 'GetType') else 'unknown'} -> {e}\")\n\n# Second pass - collect wires from ALL objects (components and parameters)\nfor obj in doc.Objects:\n    try:\n        # Check if this object has output parameters\n        outputs = None\n        \n        if isinstance(obj, gh.Kernel.IGH_Component):\n            outputs = obj.Params.Output\n        elif hasattr(obj, 'Recipients'):  # Standalone parameter with output\n            # Treat the parameter itself as having one output\n            outputs = [obj]\n        \n        if outputs:\n            for oi, op in enumerate(outputs):\n                try:\n                    if hasattr(op, 'Recipients'):\n                        for rec in op.Recipients:\n                            try:\n                                target_guid = get_owner_guid(rec)\n                                \n                                wire_info = {\n                                    \"from\": {\n                                        \"guid\": str(obj.InstanceGuid),\n                                        \"out_index\": oi if isinstance(obj, gh.Kernel.IGH_Component) else 0,\n                                        \"out_name\": str(op.NickName or op.Name or \"\") if hasattr(op, 'NickName') else str(obj.NickName or obj.Name or \"\")\n                                    },\n                                    \"to\": {\n                                        \"guid\": target_guid if target_guid else \"\",\n                                        \"in_name\": str(rec.NickName or rec.Name or \"\")\n                                    }\n                                }\n                                data[\"wires\"].append(wire_info)\n                            except Exception as wire_e:\n                                pass  # Skip individual wire errors\n                except:\n                    pass\n    except:\n        pass\n\n# Plugin summary\ntry:\n    plugins = sorted(list(set([(c.get(\"category\", \"\"), c.get(\"subcategory\", \"\"))\n                               for c in data[\"components\"] if c.get(\"category\") or c.get(\"subcategory\")])))\n    data[\"plugins\"] = [{\"category\": c, \"subcategory\": s} for (c, s) in plugins]\nexcept:\n    data[\"plugins\"] = []\n\n# Stats\ndata[\"stats\"] = {\n    \"total_components\": len(data[\"components\"]),\n    \"total_params\": len(data[\"params\"]),\n    \"total_wires\": len(data[\"wires\"]),\n    \"warnings_count\": len(data[\"warnings\"])\n}\n\n# Write JSON\ntry:\n    with open(out_path, \"w\", encoding=\"utf-8\") as f:\n        json.dump(data, f, ensure_ascii=False, indent=2)\n    \n    a = f\"✓ Exported to: {out_path}\\n{data['stats']['total_components']} components, {data['stats']['total_params']} params, {data['stats']['total_wires']} wires\"\n    if data['stats']['warnings_count'] > 0:\n        a += f\"\\n⚠ {data['stats']['warnings_count']} warnings (check JSON file)\"\nexcept Exception as write_e:\n    a = f\"ERROR: Failed to write file - {write_e}\"\n",
  "language": "python",
  "imports": [
    "Rhino",
    "rhinoscriptsyntax",
    "scriptcontext"
  ],
  "has_docstring": true
}