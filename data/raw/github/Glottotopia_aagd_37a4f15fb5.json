{
  "source_url": "https://github.com/Glottotopia/aagd/blob/a7df9a5a047aa6d41b9fb64f93ba6fd2ff42a6db/moin/local/moin/contrib/googleimport/driver.py",
  "repo": "Glottotopia/aagd",
  "repo_stars": 1,
  "repo_description": "Database of syntactic structures of Athabascan languages",
  "license": "MIT",
  "filepath": "moin/local/moin/contrib/googleimport/driver.py",
  "instruction": "MoinMoin wiki project -> Google Project Hosting converter\r\n\r\nFull of evil antipatterns, incl. Exception exceptions.\r\n\r\n@copyright: 2007,2010 MoinMoin:AlexanderSchremmer\r\n@license: GNU GPL, see...",
  "code": "#!/usr/bin/env python\r\n# -*- coding: iso-8859-1 -*-\r\n\"\"\"\r\nMoinMoin wiki project -> Google Project Hosting converter\r\n\r\nFull of evil antipatterns, incl. Exception exceptions.\r\n\r\n@copyright: 2007,2010 MoinMoin:AlexanderSchremmer\r\n@license: GNU GPL, see COPYING for details.\r\n\"\"\"\r\n\r\nimport sys\r\nimport re\r\nimport urllib2\r\nfrom urllib import quote\r\nimport xmlrpclib\r\nimport csv\r\n\r\nfrom MoinMoin.web.contexts import ScriptContext\r\nfrom MoinMoin.Page import Page\r\n\r\n# monkeypatch the formatter to avoid line_anchors:\r\nfrom MoinMoin.formatter import text_html\r\ntext_html.line_anchors = False\r\n\r\nrequest = ScriptContext(None, None)\r\n\r\n\r\nclass DataNotFoundException(Exception): pass\r\n\r\n\r\nclass Task(object):\r\n    def __init__(self, summary, desc, label, hours, mentors, difficulty, types):\r\n        self.summary = summary\r\n        self.label = label\r\n        self.hours = hours\r\n        self.mentors = mentors\r\n        self.difficulty = difficulty\r\n        self.types = types\r\n\r\n        page = Page(request, \"\")\r\n        page.set_raw_body(desc)\r\n        desc = request.redirectedOutput(page.send_page, content_only=1)\r\n        for s, r in [\r\n                ('\\n', ' '),\r\n                (' class=\"line862\"', ''),\r\n                (' class=\"line867\"', ''),\r\n                (' class=\"line874\"', ''),\r\n                (' class=\"line891\"', ''),\r\n            ]:\r\n            desc = desc.replace(s, r)\r\n        self.desc = desc\r\n\r\n    def __repr__(self):\r\n        return (u\"<Task summary=%r label=%r hours=%i mentors=%r difficulty=%r types=%r desc='''%s'''>\" % (\r\n            self.summary, self.label, self.hours, self.mentors, self.difficulty,\r\n            self.types, self.desc[:100])).encode(\"utf-8\")\r\n\r\n\r\ndef find_dict_entry(name, text):\r\n    m = re.search(r\"^ %s:: (.*)$\" % (name, ), text, re.M | re.U)\r\n    if not m:\r\n        raise DataNotFoundException(\"%s not found\" % (name, ))\r\n    return m.groups()[0]\r\n\r\n\r\ndesc_pattern = r\"\"\"= Description =\r\n([\\s\\S]*?)\r\n= Discussion =\"\"\"\r\n\r\nbugpage_pattern = r\"\"\"= Description =\r\n([\\s\\S]*?)\r\n=\"\"\"\r\n\r\nalready_pushed_pages = set([x.strip() for x in \"\"\"\r\n\"\"\".split(\"\\n\")])\r\n\r\nalready_pushed_bugs = set([x.strip() for x in \"\"\"\r\n\"\"\".split(\"\\n\")])\r\n\r\ngatherers = []\r\n\r\ndef first(s):\r\n    \"\"\" return first word or '' \"\"\"\r\n    splitted = s.strip().split()\r\n    if splitted:\r\n        return splitted[0]\r\n    else:\r\n        return ''\r\n\r\nclass Collector(object):\r\n    def is_gatherer(function):\r\n        gatherers.append(function)\r\n        return function\r\n\r\n    def __init__(self, url):\r\n        self.url = url\r\n        self.server = xmlrpclib.ServerProxy(url + \"?action=xmlrpc2\")\r\n\r\n    def collect_tasks(self):\r\n        tasks = []\r\n        for gatherer in gatherers:\r\n            new = list(gatherer(self))\r\n            tasks.extend(new)\r\n\r\n        return tasks\r\n\r\n    @is_gatherer\r\n    def easytodo_pages(self):\r\n        pages = self.server.getAllPagesEx(dict(prefix=\"EasyToDo/\"))\r\n        for page in pages:\r\n            if page in already_pushed_pages:\r\n                continue\r\n            page_contents = self.server.getPage(page)\r\n            try:\r\n                summary = find_dict_entry(\"Title\", page_contents)\r\n                count = int(first(find_dict_entry(\"Count\", page_contents)))\r\n                label = find_dict_entry(\"Tags\", page_contents)\r\n                hours = int(first(find_dict_entry(\"Duration\", page_contents)))\r\n                mentors = find_dict_entry(\"Mentors\", page_contents)\r\n                difficulty = find_dict_entry(\"Difficulty\", page_contents)\r\n                try:\r\n                    types = find_dict_entry(\"Types\", page_contents)\r\n                except DataNotFoundException:\r\n                    # old tasks use \"Type\"\r\n                    types = find_dict_entry(\"Type\", page_contents)\r\n            except (DataNotFoundException, ValueError), e:\r\n                print >>sys.stderr, \"Could not import %r because of %r\" % (page, e)\r\n                continue\r\n            desc_m = re.search(desc_pattern, page_contents)\r\n            if not desc_m:\r\n                raise Exception(\"Could not import %r because Desc not found\" % page)\r\n            desc = desc_m.groups()[0]\r\n\r\n            for i in range(1, count + 1):\r\n                text = desc\r\n                new_summary = summary\r\n                text += \"\\n\\nYou can discuss this issue in the !MoinMoin wiki: %s\" % (self.url + quote(page.encode(\"utf-8\")), )\r\n                if count > 1:\r\n                    text += \"\\n\\nThis issue is available multiple times. This one is %i of %i.\" % (i, count)\r\n                    new_summary += \" %i/%i\" % (i, count)\r\n                yield Task(new_summary, text, label, hours, mentors, difficulty, types)\r\n\r\n    #@is_gatherer\r\n    def moin_bugs(self):\r\n        pages = [pagename for pagename, contents in self.server.searchPages(r\"t:MoinMoinBugs/ r:CategoryEasy\\b\")]\r\n        for page in pages:\r\n            bug_name = page.replace(\"MoinMoinBugs/\", \"\")\r\n            if bug_name in already_pushed_bugs:\r\n                continue\r\n            page_contents = self.server.getPage(page)\r\n            m = re.search(bugpage_pattern, page_contents)\r\n            if not m:\r\n                raise Exception(\"Could not import %r because of bug desc not found\" % page)\r\n            desc = m.groups()[0]\r\n            desc = \"A user filed a bug report at the MoinMoin site. Here is a short description about the issue. A more detailed description is available at the MoinMoin wiki: %s\\n\\n\" % (self.url + quote(page.encode(\"utf-8\")), ) + desc\r\n            yield Task(bug_name, desc, \"Code\")\r\n\r\n    #@is_gatherer\r\n    def translation_items(self):\r\n        #languages = self.server.getPage(u\"EasyToDoTranslation/Languages\").strip().splitlines()\r\n        #languages = [\"Lithuanian (lt)\"]\r\n        languages = []\r\n        for language in languages:\r\n            page = u\"EasyToDoTranslation\"\r\n            page_contents = self.server.getPage(page)\r\n            page_contents = page_contents.replace(\"LANG\", language)\r\n            summary = find_dict_entry(\"Summary\", page_contents)\r\n            count = int(first(find_dict_entry(\"Count\", page_contents)))\r\n            desc_m = re.search(desc_pattern, page_contents)\r\n            if not desc_m:\r\n                raise Exception(\"Could not import %r because Desc not found\" % page)\r\n            desc = desc_m.groups()[0]\r\n            for i in range(1, count + 1):\r\n                text = desc\r\n                new_summary = summary\r\n                text += \"\\n\\nA more detailed description of this task is available at the MoinMoin wiki: %s\" % (self.url + quote(page.encode(\"utf-8\")), )\r\n                if count > 1:\r\n                    text += \"\\n\\nThis task is available multiple times. This one is %i of %i.\" % (i, count)\r\n                    new_summary += \" %i/%i\" % (i, count)\r\n                yield Task(new_summary, text, \"Translation\")\r\n\r\n\r\ndef pull_and_gencsv():\r\n    print >> sys.stderr, \"Collecting tasks ...\"\r\n    tasks = Collector(\"http://moinmo.in/\").collect_tasks()\r\n    print >> sys.stderr, \"Importing %i tasks ...\" % (len(tasks), )\r\n    print >> sys.stderr, \"\\n\".join(repr(task) for task in tasks)\r\n\r\n    summary_prefix = '' # \"[TEST] \" # EMPTY FOR PRODUCTION IMPORT!\r\n    tmin, tmax = 0, None\r\n    csvwriter = csv.writer(sys.stdout, delimiter=\",\", doublequote=True)\r\n    for task in tasks[tmin:tmax]:\r\n        csvwriter.writerow([summary_prefix + task.summary, task.desc, task.hours, task.mentors, task.difficulty, task.types, task.label])\r\n\r\n\r\nif __name__ == \"__main__\":\r\n    pull_and_gencsv()\r\n\r\n",
  "language": "python",
  "imports": [],
  "has_docstring": true
}