{
  "source_url": "https://github.com/mcneel/cloudzoo-issuer/blob/461a06c83b337bcde17bb6efe9211395d0801d51/app.py",
  "repo": "mcneel/cloudzoo-issuer",
  "repo_stars": 3,
  "repo_description": "A starting point for a third-party Cloud Zoo issuer",
  "license": "MIT",
  "filepath": "app.py",
  "instruction": null,
  "code": "from flask import Flask\nfrom flask_sqlalchemy import SQLAlchemy\nfrom flask import jsonify\nfrom os import environ\nimport datetime\nimport time\nfrom functools import wraps\nfrom flask import request\nfrom flask_talisman import Talisman\n\napp = Flask(__name__)\nTalisman(app)\ndb_uri = environ.get('DATABASE_URL')\nif not db_uri:\n    db_uri = 'sqlite:///test.db' # local dev\nelif db_uri.startswith(\"postgres://\"):\n    # https://help.heroku.com/ZKNTJQSK/why-is-sqlalchemy-1-4-x-not-connecting-to-heroku-postgres\n    db_uri = db_uri.replace(\"postgres://\", \"postgresql://\", 1)\napp.config['SQLALCHEMY_DATABASE_URI'] = db_uri\napp.config['SQLALCHEMY_TRACK_MODIFICATIONS'] = False\ndb = SQLAlchemy(app)\napp.config['JSONIFY_PRETTYPRINT_REGULAR'] = True\napp.config['JSON_SORT_KEYS'] = False\n\nISSUER_ID = environ.get('ISSUER_ID')\nISSUER_SECRET = environ.get('ISSUER_SECRET')\nISSUER_NAME = environ.get('ISSUER_NAME') or \"DolfinitoÂ®\"\nISSUER_SUPPORT_URL = environ.get('ISSUER_SUPPORT_URL') or \"https://www.dolfinito.com/support\"\n\n################################################## DATABSE CODE ########################################################\n\n\nclass License(db.Model):\n    __tablename__ = 'licenses'\n    \"\"\"This object represents a License object for your product. See https://developer.rhino3d.com/guides/rhinocommon/cloudzoo/cloudzoo-license/ for details on a license object.\"\"\"\n    serial = db.Column(db.String(), primary_key=True)\n    key = db.Column(db.String(), unique=True, nullable=False)\n    product_id = db.Column(db.String(), nullable=False)\n    entity_id = db.Column(db.String(), nullable=True)\n    enabled = db.Column(db.Boolean, nullable=False)\n    number_of_seats = db.Column(db.Integer(), nullable=False, default=1)\n    expiration_date = db.Column(db.DateTime(), nullable=True)\n    is_upgrade = db.Column(db.Boolean, nullable=False, default=False)\n    upgrade_from_key = db.Column(db.String(), nullable=True)\n    date = db.Column(db.DateTime(), nullable=True, onupdate=datetime.datetime.utcnow)\n\n    def to_json_dict(self):\n        return {\n            \"id\": self.serial,\n            \"key\": self.key,\n            \"aud\": self.product_id,\n            \"iss\": ISSUER_ID,\n            \"exp\": int(time.mktime(self.expiration_date.timetuple())) if self.expiration_date is not None else None,\n            \"numberOfSeats\": self.number_of_seats,\n            \"editions\": {\"en\": \"Full Edition\"},\n            \"metadata\": None\n        }\n\n    def __repr__(self):\n        return '<License %r>' % self.serial\n\n@app.cli.command()\ndef create_db():\n    \"\"\"This method simply creates some dummy licenses for demo purposes and inserts them into the database.\"\"\"\n    db.create_all()\n\n    license_1 = License(\n        key=\"LICENSE_KEY_1\",\n        serial=\"SERIAL_NO_1\",\n        product_id=\"3e200daa-6bf8-470b-bd6a-4f55996052c3\",\n        enabled=True\n    )\n\n    license_2 = License(\n        key=\"LICENSE_KEY_2\",\n        serial=\"SERIAL_NO_2\",\n        product_id=\"3e200daa-6bf8-470b-bd6a-4f55996052c3\",\n        enabled=False\n    )\n\n    license_3 = License(\n        key=\"LICENSE_KEY_3\",\n        serial=\"SERIAL_NO_3\",\n        product_id=\"3e200daa-6bf8-470b-bd6a-4f55996052c3\",\n        enabled=True,\n        entity_id=\"595959595959595-|-User\",\n        date=datetime.datetime(year=2018,month=11,day=30)\n    )\n\n    db.session.add(license_1)\n    db.session.add(license_2)\n    db.session.add(license_3)\n    db.session.commit()\n\n\n########################################### AUTHENTICATION CODE ########################################################\n\n\ndef check_auth(issuer_id, secret):\n    \"\"\"This function is called to check if a issuer_id /\n    secret combination is valid.\n    \"\"\"\n    return issuer_id == ISSUER_ID and secret == ISSUER_SECRET\n\ndef authenticate():\n    \"\"\"Sends a 401 response that enables basic auth\"\"\"\n    return (\n        jsonify({\"description\": \"Incorrect Credentials\"}),\n        401,\n        {'WWW-Authenticate': 'Basic realm=\"Credentials Required\"'})\n\ndef requires_auth(f):\n    \"\"\"A convenience decorator that makes it simple to enforce authentication on enddpoints.\"\"\"\n    @wraps(f)\n    def decorated(*args, **kwargs):\n        auth = request.authorization\n        if not auth or not check_auth(auth.username, auth.password):\n            return authenticate()\n        return f(*args, **kwargs)\n    return decorated\n\n\n##################################################### ENDPOINTS ########################################################\n\n\n@app.route(\"/\")\ndef hello():\n    return \"Hello World!\"\n\n@app.route(\"/info\")\ndef info():\n    licenses = License.query.all()\n    return \"You have {} licenses!\".format(len(licenses))\n\n\n@app.route(\"/add_license\", methods=[\"POST\"])\n@requires_auth\ndef add_license():\n    \"\"\"See if a license can be added to an entity or whether we should ask more information, or whether we should\n    deny the request. Note that you may have additional requirements depending on your business requirements.\n    See more info about this endpoint at: https://developer.rhino3d.com/guides/rhinocommon/cloudzoo/cloudzoo-implement-http-callbacks/#post-add_license\"\"\"\n    payload_dict = request.get_json()\n    product_id = payload_dict['license'].get(\"aud\")\n    key = payload_dict['license'].get(\"key\")\n    entity_id = payload_dict.get(\"entityId\")\n    precondition = payload_dict.get(\"precondition\")\n\n    license = License.query.filter_by(key=key, product_id=product_id).first()\n\n    #Add non-existing license.\n    if license is None:\n        return (\n            jsonify({\"description\": \"The license key '{}' is not a valid license\".format(key)}),\n            409\n        )\n\n    #Add disabled license.\n    if not license.enabled:\n        return (\n            jsonify({\"description\": \"The license key '{}' cannot be added at this time. Please contact \"\n                                    \"[{}]({}) for assistance.\".format(key, ISSUER_NAME, ISSUER_SUPPORT_URL)}),\n            409\n        )\n\n    #Add license to different entity.\n    if license.entity_id is not None and license.entity_id != entity_id:\n        return (\n            jsonify({\"description\": \"The license key '{}' has already been validated by someone else. Please contact \"\n                                    \"[{}]({}) for assistance.\".format(key, ISSUER_NAME, ISSUER_SUPPORT_URL)}),\n            409\n        )\n\n\n    #Add upgrade\n    if license.is_upgrade:\n        #Missing precondition.\n        if precondition is None:\n            return (\n                jsonify({\"description\": \"Please enter a previous license key to upgrade from.\"}),\n                428\n            )\n\n        previous_key = License.query.filter_by(key=precondition).first()\n\n        #Non-existing previous license key\n        if previous_key is None:\n            return (\n                jsonify({\"description\": \"The license key '{}' is not a valid license. \"\n                                        \"Please enter a different license to upgrade from.\".format(precondition)}),\n                412\n            )\n\n        #Previous license already upgraded\n        if license.upgrade_from_key is not None and license.upgrade_from_key != precondition:\n            return (\n                jsonify({\"description\": \"The license key '{}' has already been upgraded to a different license key. Please contact \"\n                                        \"[{}]({}) for assistance.\".format(precondition, ISSUER_NAME, ISSUER_SUPPORT_URL)}),\n                412\n            )\n\n        #Previous license is a non-validated upgrade.\n        if previous_key.is_upgrade and previous_key.entity_id is None:\n            return (\n                jsonify({\n                            \"description\": \"The license key '{}' cannot be used to upgrade. Please enter \"\n                                           \"a different license key to upgrade from.\".format(precondition)}),\n                412\n            )\n\n        #Valid upgrade. We make sure to cluster all licenses.\n        licenses = [previous_key.to_json_dict(), license.to_json_dict()]\n        a_license = previous_key\n\n        while a_license.upgrade_from_key is not None:\n            a_license = License.query.filter_by(key=a_license.upgrade_from_key).first()\n            licenses.append(a_license.to_json_dict())\n    else:\n        license.entity_id = entity_id\n        license.date = datetime.datetime.utcnow()\n        db.session.commit()\n        licenses = [license.to_json_dict()]\n\n    return jsonify({\"licenses\": licenses})\n\n@app.route(\"/remove_license\", methods=[\"POST\"])\n@requires_auth\ndef remove_license():\n    \"\"\"See if a license cluster can be removed from an entity. We make sure to note that a license is no longer\n    in the entity. See more info about this endpoint at: https://developer.rhino3d.com/guides/rhinocommon/cloudzoo/cloudzoo-implement-http-callbacks/#post-remove_license\"\"\"\n    payload_dict = request.get_json()\n\n    licenses = []\n\n    for license in payload_dict[\"licenseCluster\"][\"licenses\"]:\n        result = License.query.filter_by(\n            serial=license[\"id\"],\n            product_id=license[\"aud\"],\n            entity_id=payload_dict[\"entityId\"]\n        ).first()\n\n        if result is not None:\n            licenses.append(result)\n\n    if len(licenses) == 0 or len(licenses) == len(payload_dict[\"licenseCluster\"][\"licenses\"]):\n\n        # remove the entity id from the licenses\n        for license in licenses:\n            license.entity_id = None\n            license.date = datetime.datetime.utcnow()\n\n        db.session.commit()\n        return ('', 200)\n    else:\n        #There is an issue with the state of the data.\n        return (\n            jsonify({\"description\": \"The license(s) cannot be currently be removed. Please contact \"\n                                    \"[{}]({}) for assistance.\".format(ISSUER_NAME, ISSUER_SUPPORT_URL),\n                     \"details\": \"License key count mismatch\"}),\n            400\n        )\n\n@app.route(\"/get_license\", methods=[\"GET\"])\n@requires_auth\ndef get_license():\n    \"\"\"Return information about a specific license so users can see details about the license.\n    See more info about this endpoint at https://developer.rhino3d.com/guides/rhinocommon/cloudzoo/cloudzoo-implement-http-callbacks/#get-get_license\"\"\"\n    product_id = request.args.get(\"aud\")\n    key = request.args.get(\"key\")\n\n    license = License.query.filter_by(key=key, product_id=product_id).first()\n\n    if license is None:\n        return (\n            jsonify({\"description\": \"The license key is not valid\"}),\n            400\n        )\n    else:\n        return jsonify(license.to_json_dict())\n",
  "language": "python",
  "imports": [],
  "has_docstring": false
}