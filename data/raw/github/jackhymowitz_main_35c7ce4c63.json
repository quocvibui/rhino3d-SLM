{
  "source_url": "https://github.com/jackhymowitz/main/blob/7325131db23094f1a28bd184b6a68f864f41a729/01_GH_Components/py/BT_SetTB.py",
  "repo": "jackhymowitz/main",
  "repo_stars": 0,
  "repo_description": "IDF2PH is a free open source toolkit for working with E+ and PHPP Energy Models",
  "license": "GPL-3.0",
  "filepath": "01_GH_Components/py/BT_SetTB.py",
  "instruction": "Builds Thermal Bridge (linear, point) objects to add to the PHPP. Note that these objects are generally not inluced in the EnergyPlus model and so may be a source or discrepancy between the...",
  "code": "#\r\r\n# IDF2PHPP: A Plugin for exporting an EnergyPlus IDF file to the Passive House Planning Package (PHPP). Created by blgdtyp, llc\r\r\n# \r\r\n# This component is part of IDF2PHPP.\r\r\n# \r\r\n# Copyright (c) 2020, bldgtyp, llc <info@bldgtyp.com> \r\r\n# IDF2PHPP is free software; you can redistribute it and/or modify \r\r\n# it under the terms of the GNU General Public License as published \r\r\n# by the Free Software Foundation; either version 3 of the License, \r\r\n# or (at your option) any later version. \r\r\n# \r\r\n# IDF2PHPP is distributed in the hope that it will be useful,\r\r\n# but WITHOUT ANY WARRANTY; without even the implied warranty of \r\r\n# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the \r\r\n# GNU General Public License for more details.\r\r\n# \r\r\n# For a copy of the GNU General Public License\r\r\n# see <http://www.gnu.org/licenses/>.\r\r\n# \r\r\n# @license GPL-3.0+ <http://spdx.org/licenses/GPL-3.0+>\r\r\n#\r\r\n\"\"\"\r\r\nBuilds Thermal Bridge (linear, point) objects to add to the PHPP. Note that these objects are generally not inluced in the EnergyPlus model and so may be a source or discrepancy between the EnergyPlus reslults and the PHPP results. It will be more accurate to include these items in the final model.\r\r\n-\r\r\nEM August 1, 2020\r\r\n\r\r\n    Args:\r\r\n        estimated_tb_: <Optional> A single number (0 to 1) which represents the % increase in heat loss due to thermal bridging.\r\r\n        Typical values could be: Passive House: +0.05, Good: +0.10,Medium: +0.25, Bad +0.40\r\r\n        linear_tb_names_: <Optional> A list of names for the Thermal Bridge items to add to the PHPP. This will override any inputs in 'linear_tb_geom_'\r\r\n        linear_tb_lengths_: <Optional> A list of Lengths (m) for the Thermal Bridge items to add to the PHPP. This will override any inputs in 'linear_tb_geom_'\r\r\n        linear_tb_PsiValues_: <Optional> Either a single number or a list of Psi-Values (W/mk) to use for any Thermal Bridge items.\r\r\n        If no values are passed, a default 0.01 W/mk value will be used for all Thermal Bridge items. If only one number is input, it will be used for all Psi-Value items output.\r\r\n        linear_tb_geom_: <Optional> A list of Rhino Geometry (curves, lines) to use for finding lengths and names automatically.\r\r\n        ------\r\r\n        If you want this to read from Rhino rather than GH, pass all your referenced geometry thorugh an 'ID' (Primitive/GUID) object first before inputting.\r\r\n        This will try and read the name from the Rhino-Scene object and use the object's name for the PHPP entry (Rhino: Properties/Object Name/...)\r\r\n        -----\r\r\n        point_tb_Names_: <Optional> A list of the Point-Thermal-Bridge names. Each name will become a unique point-TB object in the PHPP.\r\r\n        point_tb_ChiValues_: <Optional> A list of Chi Values (W/mk) to use for the Point thermal bridges. If this list matches the 'point_tb_Names' input each will be used. If only one value is input, it will be used for all Chi-Values. If no values are input, a default of 0.1-W/mk will be used for all.\r\r\n        Returns:\r\r\n        thermalBridges_: Thermal Bridge objects to write to Excel. Connect to the 'thermalBridges_' input on the '2XL |  PHPP Geom' Component\r\r\n\"\"\"\r\r\n\r\r\nghenv.Component.Name = \"BT_SetTB\"\r\r\nghenv.Component.NickName = \"Thermal Bridges\"\r\r\nghenv.Component.Message = 'AUG_01_2020'\r\r\nghenv.Component.IconDisplayMode = ghenv.Component.IconDisplayMode.application\r\r\nghenv.Component.Category = \"BT\"\r\r\nghenv.Component.SubCategory = \"01 | Model\"\r\r\n\r\r\nimport scriptcontext as sc\r\r\nimport Grasshopper.Kernel as ghK\r\r\nimport rhinoscriptsyntax as rs\r\r\nimport ghpythonlib.components as ghc\r\r\nimport Rhino\r\r\nfrom contextlib import contextmanager\r\r\nimport json\r\r\n\r\r\npreview=sc.sticky['Preview']\r\r\n\r\r\nclass PHPP_ThermalBridge:\r\r\n    def __init__(self, _nm, _len, _psi, _geom, _groupNo=15, _fRsi=None):\r\r\n        self.Name = _nm\r\r\n        self.Length = float(_len)\r\r\n        \r\r\n        try: self.PsiValue = float(_psi)\r\r\n        except: \r\r\n            if '=SUM' in str(_psi): # Cus for estimated this wants to be a formula\r\r\n                self.PsiValue = _psi\r\r\n        \r\r\n        self.geometry = _geom\r\r\n        self.GroupNo = _groupNo\r\r\n        try: self.fRSI =  float(_fRsi)\r\r\n        except: self.fRSI = None\r\r\n    \r\r\n    def __repr__(self):\r\r\n        str =(\"A PHPP Thermal Bridge Object:\", \r\r\n                \" > Name: {}\".format(self.Name),\r\r\n                \" > Length: {:.02f} (m)\".format(self.Length),\r\r\n                \" > Psi-Value: {} (W/mk)\".format(self.PsiValue),\r\r\n                \" > Group Num: {}\".format(self.GroupNo),\r\r\n                \" > fRsi: {}\".format(self.fRSI),\r\r\n                )\r\r\n        \r\r\n        return \"\\n\".join(str)\r\r\n\r\r\ndef findLength(_inputItem):\r\r\n    # takes in an Input object and tries to find the length of it\r\r\n    \r\r\n    try:\r\r\n        length = float(_inputItem)\r\r\n    except:\r\r\n        try:\r\r\n            line = rs.coercecurve(_inputItem)\r\r\n            length = ghc.Length(line)\r\r\n        except:\r\r\n            msgLenError = \"Couldn't get the length from the inputs. Please input a Curve or Line for each Thermal Bridge item\"\r\r\n            ghenv.Component.AddRuntimeMessage(ghK.GH_RuntimeMessageLevel.Warning, msgLenError)\r\r\n    \r\r\n    return length\r\r\n\r\r\n@contextmanager\r\r\ndef rhDoc():\r\r\n    try:\r\r\n        sc.doc = Rhino.RhinoDoc.ActiveDoc\r\r\n        yield\r\r\n    finally:\r\r\n        sc.doc = ghdoc\r\r\n\r\r\ndef getTBLibFromDocText():\r\r\n    \"\"\" Goes and gets the TB library items from the Document User-Text\r\r\n    Will return a dict of dicts, ie:\r\r\n        {'TB_Name_01':{'Name':'example', 'fRsi':0.77, 'Psi-Value':0.1},... }\r\r\n    \"\"\"\r\r\n    dict = {}\r\r\n    \r\r\n    with rhDoc():\r\r\n        if rs.IsDocumentUserText():\r\r\n            keys = rs.GetDocumentUserText()\r\r\n            \r\r\n            tbKeys = [key for key in keys if 'PHPP_lib_TB_' in key]\r\r\n            for key in tbKeys:\r\r\n                try:\r\r\n                    val = json.loads( rs.GetDocumentUserText(key) )\r\r\n                    name = val.get('Name', 'Name Not Found')\r\r\n                    dict[name] = val\r\r\n                except:\r\r\n                    msg = \"Problem getting Psi-Values for '{}' from the File. Check the\\n\"\\\r\r\n                    \"DocumentUserText and make sure the TBs are loaded properly\".format(name)\r\r\n                    ghenv.Component.AddRuntimeMessage(ghK.GH_RuntimeMessageLevel.Warning, msg)\r\r\n    return dict\r\r\n\r\r\ndef getTBfromRhino(_tbEdges, _tbLib, _unames, _ulengths, _uPsiVals):\r\r\n    \"\"\"Looks at the edges passed in and tries to pull relevant params from Rhino\r\r\n    Will look for in the Edge's UserText and try and get the 'Typename' and 'Group'\r\r\n    will also look for any DocumentUserText TB libraries and get params based on\r\r\n    the object's 'Typename'\r\r\n    Will also allow for user-override by passing values into the GH Component directly\r\r\n    for names, lengths and Psi-Values\r\r\n    \"\"\"\r\r\n    tbGeom_ = []\r\r\n    tbLens_ = []\r\r\n    tbNames_ = []\r\r\n    tbPsiVals_ = []\r\r\n    tbGroups_ = []\r\r\n    tbrfRSIs_ = []\r\r\n    \r\r\n    with rhDoc():\r\r\n        for i, edge in enumerate(_tbEdges):\r\r\n            # Get the params from the Rhino Object\r\r\n            crv = rs.coercecurve(edge)\r\r\n            tbLen = ghc.Length(crv)\r\r\n            nm = rs.GetUserText(edge, 'Typename')\r\r\n            grp = rs.GetUserText(edge, 'Group')\r\r\n            \r\r\n            \r\r\n            if nm not in _tbLib.keys():\r\r\n                msg = \"Can not find the values for TB: '{}' in the file library?\\n\"\\\r\r\n                \"Check the file's DocumentUserText and make sure the name is correct?\".format(nm)\r\r\n                ghenv.Component.AddRuntimeMessage(ghK.GH_RuntimeMessageLevel.Warning, msg)\r\r\n            \r\r\n            # Get the params from the DocUserTxt Library\r\r\n            params = _tbLib.get(nm, None)\r\r\n            psiVal = params.get('psiValue', 0.01) if params != None else 0.01\r\r\n            fRSI = params.get('fRsi', None) if params != None else None\r\r\n            \r\r\n            # Get user input params\r\r\n            try: nm = _unames[i]\r\r\n            except: pass\r\r\n            \r\r\n            try: tbLen = _ulengths[i]\r\r\n            except: pass\r\r\n            \r\r\n            try: psiVal = _uPsiVals[i]\r\r\n            except: pass\r\r\n            \r\r\n            # Add params to the output lists\r\r\n            tbNames_.append(nm if nm != None else 'TB_{:0>2d}'.format(i+1))\r\r\n            tbLens_.append(tbLen)\r\r\n            tbGroups_.append(grp.split(':')[0] if grp != None else 15) # default = 15: Ambient\r\r\n            tbGeom_.append(crv if crv !=None else edge)\r\r\n            tbPsiVals_.append(psiVal)\r\r\n            tbrfRSIs_.append(fRSI)\r\r\n    \r\r\n    return tbNames_, tbLens_, tbPsiVals_, tbGeom_, tbGroups_, tbrfRSIs_\r\r\n\r\r\ndef getTBfromGH(_uNames, _uLens, _uPsiVals):\r\r\n    \r\r\n    def cleanAppend(_list, _i, _default=None):\r\r\n        try:\r\r\n            val = _list[_i]\r\r\n        except IndexError:\r\r\n            try:\r\r\n                val = _list[0]\r\r\n            except:\r\r\n                val = _default\r\r\n        return val\r\r\n    \r\r\n    tbGeom_ = []\r\r\n    tbLens_ = []\r\r\n    tbNames_ = []\r\r\n    tbPsiVals_ = []\r\r\n    tbGroups_ = []\r\r\n    tbrfRSIs_ = []\r\r\n    \r\r\n    for i, len in enumerate(_uLens):\r\r\n        tbLens_.append(len)\r\r\n        tbNames_.append( cleanAppend(_uNames, int(i), 'TB_{:0>2d}'.format(i+1)) )\r\r\n        tbPsiVals_.append( cleanAppend(_uPsiVals, int(i), 0.01) )\r\r\n        tbGroups_.append(15)\r\r\n        tbGeom_.append(None)\r\r\n        tbrfRSIs_.append(None)\r\r\n    \r\r\n    return tbNames_, tbLens_, tbPsiVals_, tbGeom_, tbGroups_, tbrfRSIs_\r\r\n\r\r\n# Go get the document's TB Library data\r\r\ntb_lib = getTBLibFromDocText()\r\r\n\r\r\n# Organize all the Linear TB Parameter data\r\r\nif len(linear_tb_geom_)==0 and len(linear_tb_lengths_)>0:\r\r\n    #First, try and get params from GH Doc\r\r\n    (tbNames,\r\r\n    tbLengths,\r\r\n    tbPsiVals,\r\r\n    tbGeom,\r\r\n    tbGroups,\r\r\n    tbfRSIs) = getTBfromGH(linear_tb_names_, linear_tb_lengths_, linear_tb_PsiValues_)\r\r\nelif len(linear_tb_geom_)>0:\r\r\n    # Then Try and get params from Rhino Scene\r\r\n    (tbNames,\r\r\n    tbLengths,\r\r\n    tbPsiVals,\r\r\n    tbGeom,\r\r\n    tbGroups,\r\r\n    tbfRSIs) = getTBfromRhino(linear_tb_geom_, tb_lib, linear_tb_names_, linear_tb_lengths_, linear_tb_PsiValues_)\r\r\n\r\r\n# Put together the new Linear TB Objects\r\r\nthermalBridges_ = []\r\r\nif len(linear_tb_geom_)>0 or len(linear_tb_lengths_)>0:\r\r\n    for i, name in enumerate(tbNames):\r\r\n        newTBObject = PHPP_ThermalBridge(tbNames[i], tbLengths[i], tbPsiVals[i], tbGeom[i], tbGroups[i], tbfRSIs[i])\r\r\n        \r\r\n        thermalBridges_.append(newTBObject)\r\r\n\r\r\n# Include Point TBs\r\r\nif len(point_tb_Names_)>0  and len(point_tb_ChiValues_)>0:\r\r\n    if len(point_tb_Names_) == len(point_tb_ChiValues_):\r\r\n        for j, point_tb_name in enumerate(point_tb_Names_):\r\r\n            thermalBridges_.append( PHPP_ThermalBridge(point_tb_name, 1, point_tb_ChiValues_[j], None, 15, None) )\r\r\n    elif len(point_tb_Names_) != len(point_tb_ChiValues_):\r\r\n        for j, point_tb_name in enumerate(point_tb_Names_):\r\r\n            thermalBridges_.append( PHPP_ThermalBridge(point_tb_name, 1, point_tb_ChiValues_[0], None, 15, None) )\r\r\nelif len(point_tb_Names_)>0  and len(point_tb_ChiValues_)==0:\r\r\n    for j, point_tb_name in enumerate(point_tb_Names_):\r\r\n        thermalBridges_.append( PHPP_ThermalBridge(point_tb_name, 1, 0.1, None, 15, None) )\r\r\n\r\r\n# Inlcude estimated TBs if there are any input\r\r\nif estimated_tb_:\r\r\n    if estimated_tb_ > 1:\r\r\n        estimated_tb_ = float(estimated_tb_) / 100\r\r\n    thermalBridges_.append( PHPP_ThermalBridge('Estimated', float(estimated_tb_), \"=SUM('Annual heating'!O12:O19)/'Annual heating'!M12\", None, 15, None)  )\r\r\n\r\r\n# Preview output\r\r\nfor each in thermalBridges_:\r\r\n    preview(each)\r\n",
  "language": "python",
  "imports": [
    "Rhino",
    "ghpythonlib",
    "rhinoscriptsyntax",
    "scriptcontext"
  ],
  "has_docstring": true
}