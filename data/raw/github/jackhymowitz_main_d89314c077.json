{
  "source_url": "https://github.com/jackhymowitz/main/blob/7325131db23094f1a28bd184b6a68f864f41a729/01_GH_Components/py/BT_DHW_Piping_Recirc.py",
  "repo": "jackhymowitz/main",
  "repo_stars": 0,
  "repo_description": "IDF2PH is a free open source toolkit for working with E+ and PHPP Energy Models",
  "license": "GPL-3.0",
  "filepath": "01_GH_Components/py/BT_DHW_Piping_Recirc.py",
  "instruction": "Creates DHW Recirculation loops for the 'DHW+Distribution' PHPP worksheet. Can create up to 5 recirculation loops. Will take in a DataTree of curves from Rhino and calculate their lengths...",
  "code": "#\r\r\n# IDF2PHPP: A Plugin for exporting an EnergyPlus IDF file to the Passive House Planning Package (PHPP). Created by blgdtyp, llc\r\r\n# \r\r\n# This component is part of IDF2PHPP.\r\r\n# \r\r\n# Copyright (c) 2020, bldgtyp, llc <info@bldgtyp.com> \r\r\n# IDF2PHPP is free software; you can redistribute it and/or modify \r\r\n# it under the terms of the GNU General Public License as published \r\r\n# by the Free Software Foundation; either version 3 of the License, \r\r\n# or (at your option) any later version. \r\r\n# \r\r\n# IDF2PHPP is distributed in the hope that it will be useful,\r\r\n# but WITHOUT ANY WARRANTY; without even the implied warranty of \r\r\n# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the \r\r\n# GNU General Public License for more details.\r\r\n# \r\r\n# For a copy of the GNU General Public License\r\r\n# see <http://www.gnu.org/licenses/>.\r\r\n# \r\r\n# @license GPL-3.0+ <http://spdx.org/licenses/GPL-3.0+>\r\r\n#\r\r\n\"\"\"\r\r\nCreates DHW Recirculation loops for the 'DHW+Distribution' PHPP worksheet. Can create up to 5 recirculation loops. Will take in a DataTree of curves from Rhino and calculate their lengths automatically. Will try and pull curve object attributes from Rhino as well - use attribute setter to assign the pipe diameter, insulation, etc... on the Rhino side.\r\r\n-\r\r\nEM August 11, 2020\r\r\n    Args:\r\r\n        pipe_geom_: <Tree> A DataTree where each branch describes one 'set' of recirculation piping. \r\r\n        PHPP allows up to 5 'sets' of recirc piping. Each 'set' should include the forward and return piping lengths for that distribution leg.\r\r\n        Use the 'Entwine' component to organize your inputs into branches before inputing if more than one set of piping is passed in.\r\r\n------\r\r\nThe input here will accept either:\r\r\n>  A single number representing the length (m) of the total loop in meters\r\r\n>  A list (multiline input) representing multiple pipe lengths (m). These will be summed together for each branch\r\r\n>  A curve or curves with no parameter values. The length of the curves will be summed together for each branch. You'll then need to enter the diam, insulation, etc here in the GH Component.\r\r\n>  A curve or curves with paramerer values applied back in the Rhino scene. If passing in geometry with parameter value, be sure to use an 'ID' component before inputing the geometry here.\r\r\n        pipe_diam_: <Optional> (mm) A List of numbers representing the nominal diameters (mm) of the pipes in each branch. This will override any values goten from the Rhino scene objects. If only one value is passed, will be used for all objects.\r\r\n        insulThickness_: <Optional> (mm) A List of numbers representing the insulation thickness (mm) of the pipes in each branch. This will override any values goten from the Rhino scene objects. If only one value is passed, will be used for all objects.\r\r\n        insulConductivity_: <Optional> (W/mk) A List of numbers representing the insulation conductivity (W/mk) of the pipes in each branch. This will override any values goten from the Rhino scene objects. If only one value is passed, will be used for all objects.\r\r\n        insulReflective_: <Optional> A List of True/False values for the pipes in each branch. True=Reflective Wrapper, False=No Reflective Wrapper. This will override any values goten from the Rhino scene objects. If only one value is passed, will be used for all objects.\r\r\n        insul_quality_: (\"1-None\", \"2-Moderate\", \"3-Good\") The Quality of the insulaton installation at the mountings, pipe-suspentions, couplings, valves, etc.. (Note: not the quality of the overall pipe insulation).\r\r\n        daily_period_: (hours) The usage period in hours/day that the recirculation system operates. Default is 18 hrs/day.\r\r\n    Returns:\r\r\n        circulation_piping_: The Recirculation Piping object(s). Connect this to the 'circulation_piping_' input on the 'DHW System' component in order to pass along to the PHPP.\r\r\n\"\"\"\r\r\n\r\r\nghenv.Component.Name = \"BT_DHW_Piping_Recirc\"\r\r\nghenv.Component.NickName = \"Piping | Recirc\"\r\r\nghenv.Component.Message = 'AUG_11_2020'\r\r\nghenv.Component.IconDisplayMode = ghenv.Component.IconDisplayMode.application\r\r\nghenv.Component.Category = \"BT\"\r\r\nghenv.Component.SubCategory = \"01 | Model\"\r\r\n\r\r\nimport Rhino\r\r\nimport scriptcontext as sc\r\r\nfrom contextlib import contextmanager\r\r\nimport rhinoscriptsyntax as rs\r\r\nimport ghpythonlib.components as ghc\r\r\nimport Grasshopper.Kernel as ghK\r\r\nimport inspect\r\r\n\r\r\n\r\r\n# Classes and Defs\r\r\npreview = sc.sticky['Preview']\r\r\nPHPP_DHW_RecircPipe = sc.sticky['PHPP_DHW_RecircPipe']\r\r\n\r\r\n@contextmanager\r\r\ndef rhDoc():\r\r\n    try:\r\r\n        sc.doc = Rhino.RhinoDoc.ActiveDoc\r\r\n        yield\r\r\n    finally:\r\r\n        sc.doc = ghdoc\r\r\n\r\r\ndef cleanPipeDimInputs(_diam, _thickness):\r\r\n    # Clean diam, thickness\r\r\n    if _diam != None:\r\r\n        if \" (\" in _diam: \r\r\n            _diam = float( _diam.split(\" (\")[0] )\r\r\n    \r\r\n    if _thickness != None:\r\r\n        if \" (\" in _thickness: \r\r\n            _thickness = float( _thickness.split(\" (\")[0] )\r\r\n    \r\r\n    return _diam, _thickness\r\r\n\r\r\ndef getPipe_FromRhino(_pipeObj, _i):\r\r\n    # If its a numeric input, just return that as the length and the rest as blank\r\r\n    try:\r\r\n        return float(_pipeObj), None, None, None, None\r\r\n    except:\r\r\n        pass\r\r\n    \r\r\n    # Otherwise, try and pull the required info from the Rhino scene\r\r\n    # Note, in order to keep the component's Type-Hint as 'No Type Hint' so that\r\r\n    # I can input either crvs or numbers, need to get the Rhino GUID using the \r\r\n    # Compo.Params.Input method below.\r\r\n    try:\r\r\n        rhinoGuid = ghenv.Component.Params.Input[0].VolatileData[0][_i].ReferenceID.ToString()\r\r\n        pipeLen = ghc.Length( rs.coercecurve(_pipeObj) )\r\r\n    except:\r\r\n        rhinoGuid = None\r\r\n        pipeLen = None\r\r\n    \r\r\n    with rhDoc():\r\r\n        if pipeLen and rhinoGuid:\r\r\n            try:\r\r\n                conductivity =  float( rs.GetUserText(rhinoGuid, 'insulation_conductivity') )\r\r\n                reflective = rs.GetUserText(rhinoGuid, 'insulation_reflective')\r\r\n                thickness =  rs.GetUserText(rhinoGuid, 'insulation_thickness')\r\r\n                diam = rs.GetUserText(rhinoGuid, 'pipe_diameter')\r\r\n                \r\r\n                diam, thickness = cleanPipeDimInputs(diam, thickness)\r\r\n                \r\r\n                return pipeLen, diam, thickness, conductivity, reflective\r\r\n            except:\r\r\n                msg = \"Note: I could not find any parameters assigned to the pipe geometry in the Rhino Scene.\\n\"\\\r\r\n                \"Be sure that you enter parameter information for the diam, thickness, etc... in the component here.\\n\"\\\r\r\n                \"------\\n\"\\\r\r\n                \"If you did assign information to the curves in the Rhino scene, be sure to use an 'ID' component\\n\"\\\r\r\n                \"BEFORE you pass those curves into the 'pipe_geom_' input.\"\r\r\n                ghenv.Component.AddRuntimeMessage( ghK.GH_RuntimeMessageLevel.Remark, msg)\r\r\n                \r\r\n                return pipeLen, None, None, None, None\r\r\n        else:\r\r\n            msg = \"Something went wrong getting the Curve length?\\n\"\\\r\r\n            \"Be sure you are passing in a curve / polyline object or a number to the 'pipe_geom_'?\"\r\r\n            ghenv.Component.AddRuntimeMessage(ghK.GH_RuntimeMessageLevel.Warning, msg)\r\r\n            \r\r\n            return None, None, None, None, None\r\r\n\r\r\ndef checkFloat(_inputVal, _nm):\r\r\n    if _inputVal == None:\r\r\n        return None\r\r\n    else:\r\r\n        try:\r\r\n            return float(_inputVal)\r\r\n        except:\r\r\n            unitWarning = \"Inputs for '{}' should be numbers\".format(_nm)\r\r\n            ghenv.Component.AddRuntimeMessage(ghK.GH_RuntimeMessageLevel.Warning, unitWarning)\r\r\n            return _inputVal\r\r\n\r\r\ndef getParams_fromGH(_ghParams, _pipeObj, _attrName):\r\r\n        # Check the input type\r\r\n        for eachParam in _ghParams:\r\r\n            checkFloat(eachParam, _attrName)\r\r\n        \r\r\n        if len(_ghParams) == len(_pipeObj):\r\r\n            for i, eachObj in enumerate(_pipeObj):\r\r\n                setattr(eachObj, _attrName, _ghParams[i])\r\r\n        else:\r\r\n            for eachObj in _pipeObj:\r\r\n                setattr(eachObj, _attrName, _ghParams[0])\r\r\n        \r\r\n        return _pipeObj\r\r\n\r\r\ndef combinePipeObjs(_pipeObjList):\r\r\n    # for each pipe object, make a dict of all the values \r\r\n    masterDict = {}\r\r\n    for pipeObj in _pipeObjList:\r\r\n        for k, v in pipeObj.__dict__.items():\r\r\n            if k in masterDict.keys():\r\r\n                masterDict[k] = masterDict[k] + [v]\r\r\n            else:\r\r\n                masterDict[k] = [v]\r\r\n    \r\r\n    # Go through all the keys, if any variation occurs, throw an error\r\r\n    for k, v in masterDict.items():\r\r\n        if 'length' not in k:\r\r\n            if len(set(v)) != 1:\r\r\n                paramWarning = \"Warning: Component found multiple parameters for '{}' on the geometry?\\nOnly the parameter values from the first object will be used for this pipe-set.\".format(k) \r\r\n                ghenv.Component.AddRuntimeMessage(ghK.GH_RuntimeMessageLevel.Warning, paramWarning)\r\r\n    \r\r\n    # combine the lengths\r\r\n    totalLength = sum(masterDict['length'])\r\r\n    \r\r\n    # return a single pipe object\r\r\n    new_pipe_obj = _pipeObjList[0]\r\r\n    new_pipe_obj.length = totalLength\r\r\n    \r\r\n    return new_pipe_obj\r\r\n\r\r\n# ------------------------------------------------------------------------------\r\r\n# Default Inputs, Clean Inputs\r\r\nif insul_quality_:\r\r\n    if \"3\" in str(insul_quality_)  or \"Good\" in str(insul_quality_): insulQual = \"3-Good\"\r\r\n    elif \"2\" in str(insul_quality_) or \"Moderate\" in str(insul_quality_): insulQual = \"2-Moderate\"\r\r\n    else: insulQual = \"1-None\"\r\r\nelse:\r\r\n    insulQual = \"1-None\"\r\r\n\r\r\ndlyperiod = daily_period_ if daily_period_ != None else 18\r\r\nif dlyperiod:\r\r\n    try: float(dlyperiod)\r\r\n    except: ghenv.Component.AddRuntimeMessage(ghK.GH_RuntimeMessageLevel.Warning, '\"daily_period_\" should be a number.')\r\r\n\r\r\n# ------------------------------------------------------------------------------\r\r\n# Build the Re-Circ Pipe Objects\r\r\ncirculation_piping_ = []\r\r\nif pipe_geom_.BranchCount > 0:\r\r\n    for branch in pipe_geom_.Branches:\r\r\n        branch_pipe_objs = []\r\r\n        for i, geom in enumerate(branch):\r\r\n            \r\r\n            newRecircObj = PHPP_DHW_RecircPipe()\r\r\n            \r\r\n            (newRecircObj.length,        \r\r\n            newRecircObj.diam,\r\r\n            newRecircObj.insulThck,\r\r\n            newRecircObj.insulCond,\r\r\n            newRecircObj.insulRefl ) = getPipe_FromRhino(geom, i)\r\r\n            \r\r\n            newRecircObj.quality = insulQual\r\r\n            newRecircObj.period = dlyperiod\r\r\n            \r\r\n            branch_pipe_objs.append(newRecircObj)\r\r\n        \r\r\n        # If multiple pipes in a single branch, combine them into one\r\r\n        if len(branch_pipe_objs) > 1:\r\r\n            circulation_piping_.append( combinePipeObjs(branch_pipe_objs) )\r\r\n        elif len(branch_pipe_objs) == 1:\r\r\n            circulation_piping_.append( branch_pipe_objs[0] )\r\r\n\r\r\n# ------------------------------------------------------------------------------\r\r\n# Override Rhino obj with GH params (if any)\r\r\nif len(pipe_diam_)>0: circulation_piping_ = getParams_fromGH(pipe_diam_, circulation_piping_, 'diam')\r\r\nif len(insulThickness_)>0: circulation_piping_ = getParams_fromGH(insulThickness_, circulation_piping_, 'insulThck')\r\r\nif len(insulConductivity_)>0: circulation_piping_ = getParams_fromGH(insulConductivity_, circulation_piping_, 'insulCond')\r\r\nif len(insulReflective_)>0: circulation_piping_ = getParams_fromGH(insulReflective_, circulation_piping_, 'insulRefl')\r\r\n\r\r\n# ------------------------------------------------------------------------------\r\r\n# Preview the objects\r\r\nfor each in circulation_piping_:\r\r\n    print('----\\nDHW Recirc Piping:')\r\r\n    preview(each)\r\n",
  "language": "python",
  "imports": [
    "Rhino",
    "ghpythonlib",
    "rhinoscriptsyntax",
    "scriptcontext"
  ],
  "has_docstring": true
}