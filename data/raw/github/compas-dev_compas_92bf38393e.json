{
  "source_url": "https://github.com/compas-dev/compas/blob/HEAD/src/compas_rhino/uninstall.py",
  "repo": "compas-dev/compas",
  "repo_stars": 352,
  "repo_description": "Main library of the COMPAS framework and CAD integrations for Rhino/GH and Blender.",
  "license": "MIT",
  "filepath": "src/compas_rhino/uninstall.py",
  "instruction": "Uninstall",
  "code": "from __future__ import absolute_import\nfrom __future__ import division\nfrom __future__ import print_function\n\nimport itertools\nimport os\nimport sys\n\nimport compas._os\nimport compas.plugins\nimport compas_rhino\nfrom compas_rhino.install import _run_post_execution_steps\nfrom compas_rhino.install import installable_rhino_packages\n\n\ndef uninstall(version=None, packages=None):\n    \"\"\"Uninstall COMPAS from Rhino.\n\n    Parameters\n    ----------\n    version : {'5.0', '6.0', '7.0', '8.0'}, optional\n        The version number of Rhino.\n        Default is ``'7.0'``.\n    packages : list of str, optional\n        List of packages to uninstall.\n        Default is to uninstall all packages installed by the COMPAS installer.\n\n    Examples\n    --------\n    .. code-block:: python\n\n        import compas_rhino\n\n        compas_rhino.uninstall()\n\n    .. code-block:: bash\n\n        python -m compas_rhino.uninstall\n\n    \"\"\"\n    version = compas_rhino._check_rhino_version(version)\n\n    # We install COMPAS packages in the scripts folder\n    # instead of directly as IPy module.\n    scripts_path = compas_rhino._get_rhino_scripts_path(version)\n\n    # This is for old installs\n    ipylib_path = compas_rhino._get_rhino_ironpython_lib_path(version)\n\n    # Filter the provided list of packages\n    # If no packages are provided\n    # this first collects all installable packages from the environment.\n    packages = _filter_installed_packages(version, packages)\n\n    # Also remove all broken symlinks\n    # because ... they're broken!\n    for name in os.listdir(scripts_path):\n        path = os.path.join(scripts_path, name)\n        if os.path.islink(path):\n            if not os.path.exists(path):\n                if name not in packages:\n                    packages.append(name)\n\n    # Collect paths for removal based on package names\n    symlinks_to_uninstall = []\n\n    for package in packages:\n        symlink_path = os.path.join(scripts_path, package)\n        symlinks_to_uninstall.append(dict(name=package, link=symlink_path))\n\n        # Handle legacy install location\n        # This does not always work,\n        # and especially not in cases where it is in any case not necessary :)\n        if ipylib_path:\n            legacy_path = os.path.join(ipylib_path, package)\n            if os.path.exists(legacy_path):\n                symlinks_to_uninstall.append(dict(name=package, link=legacy_path))\n\n    # There is nothing to uninstall\n    if not symlinks_to_uninstall:\n        print(\"\\nNo packages to uninstall from Rhino {0} scripts folder: \\n{1}.\".format(version, scripts_path))\n        return\n\n    # -------------------------\n    # Start uninstalling\n    # -------------------------\n\n    uninstalled_packages = []\n    results = []\n    exit_code = 0\n\n    symlinks = [link[\"link\"] for link in symlinks_to_uninstall]\n    uninstall_results = compas._os.remove_symlinks(symlinks)\n\n    for uninstall_data, success in zip(symlinks_to_uninstall, uninstall_results):\n        if success:\n            uninstalled_packages.append(uninstall_data[\"name\"])\n            result = \"OK\"\n        else:\n            result = \"ERROR: Cannot remove symlink, try to run as administrator.\"\n\n        results.append((uninstall_data[\"name\"], result))\n\n    if not all(uninstall_results):\n        exit_code = -1\n\n    if exit_code == -1:\n        results.append(\n            (\n                \"compas_bootstrapper\",\n                \"WARNING: One or more packages failed, will not uninstall bootstrapper.\",\n            )\n        )\n\n    else:\n        if compas_rhino._try_remove_bootstrapper(scripts_path):\n            results.append((\"compas_bootstrapper\", \"OK\"))\n        else:\n            results.append(\n                (\n                    \"compas_bootstrapper\",\n                    \"ERROR: Cannot remove compas_bootstrapper, try to run as administrator.\",\n                )\n            )\n\n        # Handle legacy bootstrapper\n        # Again, only if possible...\n        if ipylib_path:\n            if not compas_rhino._try_remove_bootstrapper(ipylib_path):\n                results.append(\n                    (\n                        \"compas_bootstrapper\",\n                        \"ERROR: Cannot remove legacy compas_bootstrapper, try to run as administrator.\",\n                    )\n                )\n\n    # -------------------------\n    # Output results\n    # -------------------------\n\n    print(\"Uninstalling COMPAS packages from Rhino {0} scripts folder: \\n{1}\".format(version, scripts_path))\n    print(\"\\nThe following packages have been detected and will be uninstalled:\\n\")\n\n    for package, status in results:\n        print(\"   {} {}\".format(package.ljust(20), status))\n\n        if status != \"OK\":\n            exit_code = -1\n\n    if exit_code == 0 and uninstalled_packages:\n        print(\"\\nRunning post-uninstallation steps...\\n\")\n\n        if not _run_post_execution_steps(after_rhino_uninstall(uninstalled_packages)):\n            exit_code = -1\n\n    print(\"\\nUninstall completed.\")\n\n    if exit_code != 0:\n        sys.exit(exit_code)\n\n\ndef _filter_installed_packages(version, packages):\n    ipylib_path = compas_rhino._get_rhino_ironpython_lib_path(version)\n    scripts_path = compas_rhino._get_rhino_scripts_path(version)\n\n    compas_bootstrapper = compas_rhino._get_bootstrapper_path(scripts_path)\n    bootstrapper_data = compas_rhino._get_bootstrapper_data(compas_bootstrapper)\n\n    # Don't modify the original list if we have one\n    if packages:\n        packages = packages[:]\n    else:\n        packages = bootstrapper_data.get(\"INSTALLED_PACKAGES\", None)\n\n        # No info, fall back to installable packages list\n        if packages is None:\n            packages = list(itertools.chain.from_iterable(installable_rhino_packages()))  # type: ignore\n\n    # Handle legacy install\n    if ipylib_path:\n        legacy_bootstrapper = compas_rhino._get_bootstrapper_path(ipylib_path)\n        if os.path.exists(legacy_bootstrapper):\n            bootstrapper_data = compas_rhino._get_bootstrapper_data(legacy_bootstrapper)\n            legacy_packages = bootstrapper_data.get(\"INSTALLED_PACKAGES\", None)\n\n            if legacy_packages:\n                packages.extend(legacy_packages)\n\n    return packages\n\n\n@compas.plugins.pluggable(category=\"install\", selector=\"collect_all\")\ndef after_rhino_uninstall(uninstalled_packages):\n    \"\"\"Allows extensions to execute actions after uninstall from Rhino is done.\n\n    Extensions providing Rhino or Grasshopper features\n    can implement this pluggable interface to perform\n    additional steps after the uninstall from Rhino has\n    been completed.\n\n    Parameters\n    ----------\n    uninstalled_packages : :obj:`list` of :obj:`str`\n        List of packages that have been uninstalled.\n\n    Examples\n    --------\n    >>> import compas.plugins\n    >>> @compas.plugins.plugin(category=\"install\")\n    ... def after_rhino_uninstall(uninstalled_packages):\n    ...     # Do something cleanup, eg remove copied files.\n    ...     return [(\"compas_ghpython\", \"GH Components uninstalled\", True)]\n\n    Returns\n    -------\n    :obj:`list` of 3-tuple (str, str, bool)\n        List containing a 3-tuple with component name, message and True/False success flag.\n    \"\"\"\n    pass\n\n\n# ==============================================================================\n# Main\n# ==============================================================================\n\nif __name__ == \"__main__\":\n    import argparse\n\n    parser = argparse.ArgumentParser()\n\n    parser.add_argument(\n        \"-v\",\n        \"--version\",\n        choices=compas_rhino.SUPPORTED_VERSIONS,\n        default=compas_rhino.DEFAULT_VERSION,\n        help=\"The version of Rhino to install the packages in.\",\n    )\n    parser.add_argument(\"-p\", \"--packages\", nargs=\"+\", help=\"The packages to uninstall.\")\n\n    args = parser.parse_args()\n    compas_rhino.INSTALLATION_ARGUMENTS = args\n\n    uninstall(version=args.version, packages=args.packages)\n",
  "language": "python",
  "imports": [],
  "has_docstring": false
}