{
  "source_url": "https://github.com/CADacombs/rhinopython/blob/541b4ade49f1dda6a3861d12b9e2613405182082/spb_Crv_Trim_to_end_pt_of_other_crv.py",
  "repo": "CADacombs/rhinopython",
  "repo_stars": 37,
  "repo_description": "Python scripts for Rhinoceros (Rhino, Rhino3D).",
  "license": "LGPL-3.0",
  "filepath": "spb_Crv_Trim_to_end_pt_of_other_crv.py",
  "instruction": "This script trims one curve at the end point of a reference curve closest to\r\nthe picked point on the latter.\r\n\r\nSend any questions, comments, or script development service needs to\r\n@spb on the...",
  "code": "\"\"\"\r\nThis script trims one curve at the end point of a reference curve closest to\r\nthe picked point on the latter.\r\n\r\nSend any questions, comments, or script development service needs to\r\n@spb on the McNeel Forums, https://discourse.mcneel.com/\r\n\"\"\"\r\n\r\n#! python 2  Must be on a line number less than 32.\r\nfrom __future__ import absolute_import, division, print_function, unicode_literals\r\n\r\n\"\"\"\r\n250323-24: Created.\r\n\"\"\"\r\n\r\nimport Rhino\r\nimport Rhino.Geometry as rg\r\nimport Rhino.Input as ri\r\nimport rhinoscriptsyntax as rs\r\nimport scriptcontext as sc\r\n\r\nfrom System import Guid\r\n\r\n\r\nclass Opts():\r\n\r\n    keys = []\r\n    values = {}\r\n    names = {}\r\n    riOpts = {}\r\n    listValues = {}\r\n    stickyKeys = {}\r\n\r\n\r\n    key = 'bReplace'; keys.append(key)\r\n    values[key] = True\r\n    names[key] = 'DocAction'\r\n    riOpts[key] = ri.Custom.OptionToggle(values[key], 'Add', 'Replace')\r\n    stickyKeys[key] = '{}({})'.format(key, __file__)\r\n\r\n    key = 'bEcho'; keys.append(key)\r\n    values[key] = True\r\n    riOpts[key] = ri.Custom.OptionToggle(values[key], 'No', 'Yes')\r\n    stickyKeys[key] = '{}({})'.format(key, __file__)\r\n    \r\n    key = 'bDebug'; keys.append(key)\r\n    values[key] = False\r\n    riOpts[key] = ri.Custom.OptionToggle(values[key], 'No', 'Yes')\r\n    stickyKeys[key] = '{}({})'.format(key, __file__)\r\n\r\n\r\n    for key in keys:\r\n        if key not in names:\r\n            names[key] = key[1:]\r\n\r\n\r\n    # Load sticky.\r\n    for key in stickyKeys:\r\n        if stickyKeys[key] in sc.sticky:\r\n            if key in riOpts:\r\n                riOpts[key].CurrentValue = values[key] = sc.sticky[stickyKeys[key]]\r\n            else:\r\n                values[key] = sc.sticky[stickyKeys[key]]\r\n\r\n\r\n    @classmethod\r\n    def addOption(cls, go, key):\r\n\r\n        idxOpt = None\r\n\r\n        if key in cls.riOpts:\r\n            if key[0] == 'b':\r\n                idxOpt = go.AddOptionToggle(\r\n                        cls.names[key], cls.riOpts[key])[0]\r\n            elif key[0] == 'f':\r\n                idxOpt = go.AddOptionDouble(\r\n                    cls.names[key], cls.riOpts[key])[0]\r\n            elif key[0] == 'i':\r\n                idxOpt = go.AddOptionInteger(\r\n                    englishName=cls.names[key], intValue=cls.riOpts[key])[0]\r\n        else:\r\n            idxOpt = go.AddOptionList(\r\n                englishOptionName=cls.names[key],\r\n                listValues=cls.listValues[key],\r\n                listCurrentIndex=cls.values[key])\r\n\r\n        return idxOpt\r\n\r\n\r\n    @classmethod\r\n    def setValue(cls, key, idxList=None):\r\n\r\n        if key in cls.riOpts:\r\n            cls.values[key] = cls.riOpts[key].CurrentValue\r\n        elif key in cls.listValues:\r\n            cls.values[key] = idxList\r\n        else:\r\n            return\r\n        sc.sticky[cls.stickyKeys[key]] = cls.values[key]\r\n\r\n\r\ndef getInput_Ref():\r\n    \"\"\"\r\n    Get curve to use its end for trimming.\r\n    \"\"\"\r\n\r\n    go = ri.Custom.GetObject()\r\n\r\n    go.SetCommandPrompt(\"Select curve near its end point to use\")\r\n\r\n    go.GeometryFilter = Rhino.DocObjects.ObjectType.Curve\r\n\r\n    go.DisablePreSelect()\r\n\r\n    idxs_Opt = {}\r\n    def addOption(key): idxs_Opt[key] = Opts.addOption(go, key)\r\n\r\n    while True:\r\n        go.ClearCommandOptions()\r\n\r\n        idxs_Opt.clear()\r\n\r\n        addOption('bReplace')\r\n        addOption('bEcho')\r\n        addOption('bDebug')\r\n\r\n\r\n        res = go.Get()\r\n\r\n        if res == ri.GetResult.Cancel:\r\n            go.Dispose()\r\n            return\r\n\r\n        if res == ri.GetResult.Object:\r\n            objref = go.Object(0)\r\n            go.Dispose()\r\n            return objref\r\n\r\n        for key in idxs_Opt:\r\n            if go.Option().Index == idxs_Opt[key]:\r\n                Opts.setValue(key, go.Option().CurrentListOptionIndex)\r\n                break\r\n\r\n\r\ndef getInput_to_trim(objref_Ref):\r\n    \"\"\"\r\n    Get curve to trim.\r\n    \"\"\"\r\n\r\n    edge_Ref = objref_Ref.Edge()\r\n    idxE_Ref = None if edge_Ref is None else edge_Ref.EdgeIndex\r\n    gRef = objref_Ref.ObjectId\r\n\r\n    go = ri.Custom.GetObject()\r\n\r\n    go.SetCommandPrompt(\"Select curve to trim\")\r\n\r\n    go.GeometryFilter = Rhino.DocObjects.ObjectType.Curve\r\n\r\n    def customGeomFilter(rdObj, geom, compIdx):\r\n        #print(rdObj, geom, compIdx.ComponentIndexType, compIdx.Index\r\n\r\n        if rdObj.Id == gRef:\r\n            if isinstance(geom, rg.BrepEdge):\r\n                # GUID may be the same as reference curve, so only edge index need be different.\r\n                if geom.EdgeIndex == idxE_Ref:\r\n                    #print(\"Same edge index {}\".format(idxE_Ref))\r\n                    return False\r\n            else:\r\n                return False\r\n\r\n        return True\r\n\r\n    go.SetCustomGeometryFilter(customGeomFilter)\r\n\r\n    go.DisablePreSelect()\r\n\r\n    idxs_Opt = {}\r\n    def addOption(key): idxs_Opt[key] = Opts.addOption(go, key)\r\n\r\n    while True:\r\n        go.ClearCommandOptions()\r\n\r\n        idxs_Opt.clear()\r\n\r\n        addOption('bReplace')\r\n        addOption('bEcho')\r\n        addOption('bDebug')\r\n\r\n\r\n        res = go.Get()\r\n\r\n        if res == ri.GetResult.Cancel:\r\n            go.Dispose()\r\n            return\r\n\r\n        if res == ri.GetResult.Object:\r\n            objref = go.Object(0)\r\n            go.Dispose()\r\n            return objref\r\n\r\n        for key in idxs_Opt:\r\n            if go.Option().Index == idxs_Opt[key]:\r\n                Opts.setValue(key, go.Option().CurrentListOptionIndex)\r\n                break\r\n\r\n\r\ndef _formatDistance(fDistance, iPrecision=6):\r\n    if fDistance is None:\r\n        return \"(No deviation provided)\"\r\n\r\n    if fDistance < 10**-iPrecision:\r\n        return \"{:.{}e}\".format(fDistance, 0)\r\n\r\n    if fDistance < 0.1:\r\n        return \"{:.{}g}\".format(fDistance, iPrecision)\r\n\r\n    return \"{:.{}g}\".format(fDistance, iPrecision)\r\n\r\n\r\ndef trimCurve(rgCrv_TrimMe, t_on_trim_side, t_closest_to_trimming_pt, bDebug=False):\r\n    \"\"\"\r\n    Parameters:\r\n        rgCrv_TrimMe\r\n        t_on_trim_side\r\n        bDebug: bool\r\n\r\n    Returns: tuple of 2 items:\r\n        list(rg.Curves) or None\r\n        str(Feedback on fail, etc.) or None\r\n    \"\"\"\r\n\r\n    if t_on_trim_side > t_closest_to_trimming_pt:\r\n        return rgCrv_TrimMe.Trim(\r\n            t0=rgCrv_TrimMe.Domain.T0,\r\n            t1=t_closest_to_trimming_pt)\r\n\r\n    return rgCrv_TrimMe.Trim(\r\n        t0=t_closest_to_trimming_pt,\r\n        t1=rgCrv_TrimMe.Domain.T1)\r\n\r\n\r\ndef _pt_at_curve_end_closest_to_pick(objref_Crv):\r\n    rgCrv = objref_Crv.Curve()\r\n\r\n    bSuccess, t = rgCrv.ClosestPoint(objref_Crv.SelectionPoint())\r\n    if not bSuccess:\r\n        return\r\n\r\n    t_MidLength = rgCrv.DivideByCount(segmentCount=2, includeEnds=False)[0]\r\n\r\n    return rgCrv.PointAtEnd if t >= t_MidLength else rgCrv.PointAtStart\r\n\r\n\r\ndef _closest_pt(rgCurve, testPoint):\r\n    bSuccess, t = rgCurve.ClosestPoint(\r\n        testPoint=testPoint)\r\n    if not bSuccess: raise Exception(\"ClosestPoint failed.\")\r\n    return t\r\n\r\n\r\ndef processObjRefs(objref_TrimMe, objref_Ref, bReplace=True, bEcho=True, bDebug=False):\r\n    \"\"\"\r\n    \"\"\"\r\n\r\n    edge_TrimMe = objref_TrimMe.Edge()\r\n\r\n    pt_on_trim_side = objref_TrimMe.SelectionPoint()\r\n    rgC_TrimMe, t_on_trim_side = objref_TrimMe.CurveParameter()\r\n    pt_Trimming = _pt_at_curve_end_closest_to_pick(objref_Ref)\r\n    t_closest_to_trimming_pt = _closest_pt(\r\n        rgC_TrimMe,\r\n        testPoint=pt_Trimming)\r\n    fDist_between_pts = rgC_TrimMe.PointAt(t_closest_to_trimming_pt).DistanceTo(pt_Trimming)\r\n\r\n    #maximumDistance = sc.doc.ModelAbsoluteTolerance if tolerance is None else tolerance\r\n    fMaxDistFromCrv = sc.doc.ModelAbsoluteTolerance\r\n\r\n    print(\"End point is {} from curve to trim.\".format(_formatDistance(fDist_between_pts)))\r\n\r\n    if fDist_between_pts > fMaxDistFromCrv:\r\n        print(\"Curve not trimmed.\")\r\n        return\r\n\r\n\r\n    rdC_TrimMe = objref_TrimMe.Object()\r\n    #rgC_TrimMe = rdC_TrimMe.Geometry\r\n\r\n    rgC_Out = trimCurve(\r\n        rgCrv_TrimMe=rgC_TrimMe,\r\n        t_on_trim_side=t_on_trim_side,\r\n        t_closest_to_trimming_pt=t_closest_to_trimming_pt,\r\n        bDebug=bDebug,\r\n        )\r\n    if rgC_Out is None:\r\n        return\r\n\r\n\r\n    if bReplace and edge_TrimMe is None:\r\n        gOut = rdC_TrimMe.Id\r\n        bReplaced = sc.doc.Objects.Replace(gOut, rgC_Out)\r\n        if bReplaced:\r\n            if bEcho: print(\"Curve was replaced.\")\r\n        else:\r\n            gOut = None\r\n            if bEcho: print(\"Curve could not be replaced.\")\r\n    else:\r\n        gOut = sc.doc.Objects.AddCurve(rgC_Out)\r\n        if gOut == Guid.Empty:\r\n            gOut = None\r\n            if bEcho: print(\"Curve could not be added.\")\r\n        else:\r\n            if bEcho: print(\"Curve was added.\")\r\n\r\n    return gOut\r\n\r\n\r\ndef _curveEnd_closestToPick(objref_Crv):\r\n    rgCrv = objref_Crv.Curve()\r\n\r\n    bSuccess, t = rgCrv.ClosestPoint(objref_Crv.SelectionPoint())\r\n    if not bSuccess:\r\n        return\r\n\r\n    t_MidLength = rgCrv.DivideByCount(segmentCount=2, includeEnds=False)[0]\r\n\r\n    return rg.CurveEnd.End if t >= t_MidLength else rg.CurveEnd.Start\r\n\r\n\r\ndef main():\r\n\r\n    objref_Ref = getInput_Ref()\r\n    if objref_Ref is None: return\r\n\r\n    objref_TrimMe = getInput_to_trim(objref_Ref)\r\n    if objref_TrimMe is None: return\r\n\r\n    bReplace = Opts.values['bReplace']\r\n    bEcho = Opts.values['bEcho']\r\n    bDebug = Opts.values['bDebug']\r\n\r\n    if not bDebug: sc.doc.Views.RedrawEnabled = False\r\n\r\n    processObjRefs(\r\n        objref_TrimMe=objref_TrimMe,\r\n        objref_Ref=objref_Ref,\r\n        bReplace=bReplace,\r\n        bEcho=bEcho,\r\n        bDebug=bDebug,\r\n        )\r\n\r\n    sc.doc.Views.RedrawEnabled = True\r\n\r\n\r\nif __name__ == '__main__': main()",
  "language": "python",
  "imports": [
    "Rhino",
    "Rhino.Geometry",
    "rhinoscriptsyntax",
    "scriptcontext"
  ],
  "has_docstring": true
}