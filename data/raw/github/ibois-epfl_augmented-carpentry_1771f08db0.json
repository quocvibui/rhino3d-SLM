{
  "source_url": "https://github.com/ibois-epfl/augmented-carpentry/blob/414eeb93984fad40a4e57daa60e1bb268cbd406c/assets/illustration/meshbit_illustration/moveit.py",
  "repo": "ibois-epfl/augmented-carpentry",
  "repo_stars": 15,
  "repo_description": "Main repository hosting the main AR software developed for Augmented Carpentry rersearch at Ibois, Epfl.",
  "license": "GPL-3.0",
  "filepath": "assets/illustration/meshbit_illustration/moveit.py",
  "instruction": "r: pillow r: Wand",
  "code": "#! python3\n#r: pillow\n#r: Wand\n\nimport System\nimport System.Drawing\nfrom enum import Enum\n\nimport typing\n\nimport math\nimport sys\nimport os\n\nfrom wand.image import Image\nfrom wand.api import library\n\nimport Rhino\nimport Rhino.Geometry as rg\nimport rhinoscriptsyntax as rs\n\ndef _gaussian(x, mu, sigma):\n    return (1.0 / (sigma * math.sqrt(2 * math.pi))) * math.exp(-0.5 * ((x - mu) / sigma) ** 2)\n\ndef _generate_normalized_gaussian_values(num_frames: int):\n    mu = num_frames // 2\n    sigma = num_frames // 6\n    gaussian_values = [_gaussian(x, mu, sigma) for x in range(num_frames)]\n    max_gaussian = max(gaussian_values)\n    normalized_gaussian_values = [val / max_gaussian for val in gaussian_values]\n    total_gaussian_sum = sum(normalized_gaussian_values)\n    normalized_gaussian_values = [val / total_gaussian_sum for val in normalized_gaussian_values]\n    return normalized_gaussian_values\n\ndef get_translation_axis(option_value: int) -> rg.Vector3d:\n    \"\"\"\n        Returns the axis based on the option value.\n\n        :param option_value: The option value to determine the axis.\n\n        :return The axis based on the option value.\n    \"\"\"\n    if option_value == 0:\n        return rg.Vector3d.XAxis\n    elif option_value == 1:\n        return rg.Vector3d.YAxis\n    elif option_value == 2:\n        return rg.Vector3d.ZAxis\n    else:\n        return rg.Vector3d(0,0,0)\n\ndef generate_animation_values(num_frames: int, is_gaussian_move: bool, animation_magnitude: float):\n    \"\"\"\n        Generate a list of values to animate an object.\n\n        :param num_frames: Number of frames to animate.\n        :is_gaussian_move: If True, the animation will be a gaussian move otherwise linear.\n        :param animation_magnitude: The magnitude of the animation. This should be the total extent of the animation\n        (e.g. total rotation in degrees or total translation distance in units).\n        :return: A list of values to animate the object to pass to a transformation function.\n    \"\"\"\n    animation_values = []\n\n    if is_gaussian_move:\n        normalized_gaussian_values = _generate_normalized_gaussian_values(num_frames)\n    else:\n        standard_value = 1 / num_frames\n\n    for i in range(num_frames):\n        translation = 0\n        if is_gaussian_move:\n            translation = normalized_gaussian_values[i] * animation_magnitude\n        else:\n            translation = standard_value * animation_magnitude\n        animation_values.append(translation)\n\n    return animation_values\n\ndef save_frame(view_capture, view, build_folder, frame_index, num_frames):\n    \"\"\" Save the Rhino current view of the animation to a bitmap file. \"\"\"\n    bitmap = view_capture.CaptureToBitmap(view)\n    if bitmap is None:\n        raise Exception(\"Failed to capture view to bitmap\")\n    bitmap.Save(os.path.join(build_folder, f\"frame_{frame_index}.png\"), System.Drawing.Imaging.ImageFormat.Png)\n    print_progress_bar(frame_index + 1, num_frames, prefix='Animate:', suffix='Complete')\n\ndef print_progress_bar(\n        iteration, total,\n        prefix='', suffix='',\n        decimals=1, length=10,\n        fill='▒', empty='■'):\n    percent = (\"{0:.\" + str(decimals) + \"f}\").format(100 * (iteration / float(total)))\n    filled_length = int(length * iteration // total)\n    bar = fill * filled_length + empty * (length - filled_length)\n    Rhino.RhinoApp.SetCommandPrompt(f'{prefix} |{bar}| {percent}% {suffix}')\n    if iteration == total:\n        Rhino.RhinoApp.SetCommandPrompt(f'{prefix} |{bar}| {percent}% {suffix}\\n')\n\nclass AnimationType(Enum):\n    ROTATION = \"rotation\"\n    TRANSLATION = \"translation\"\n\n\ndef main() -> None:\n    #------------------------------------------------------------\n    # Rhin commandline options\n    #------------------------------------------------------------\n    start_log = \\\n    \">\" * 60 + \\\n        r\"\"\"\n                                                                 __  __       __\n        >-->-->    .--------..-----..--.--..-----.  |__||  |_     |  |  >-->-->\n          >-->-->  |          ||   _   ||   |   ||   -__|  |  ||   _|    |__|    >-->-->\n        >-->-->    |__|__|__||_____| \\___/ |_____|  |__||____|  |__|  >-->-->\n        \"\"\" + \"\\n\" + \\\n        \"Author: @AndreaSettimi: andrea.settimi@epfl.ch (IBOIS,EPFL)\" + \"\\n\" + \\\n        \"Description: Animate a mesh object in Rhino and save the animation as a gif.\" + \"\\n\" + \\\n        \"Usage: Select an object to animate and set the options.\" + \"\\n\" + \\\n    \">\" * 60\n    print(start_log)\n\n    go = Rhino.Input.Custom.GetObject()\n    go.SetCommandPrompt(\"Select object to animate\")\n    go.AcceptNothing(True)\n    go.ClearCommandOptions()\n    go.EnableHighlight(False)\n\n    __OPT_is_saving_gif = Rhino.Input.Custom.OptionToggle(False, \"Off\", \"On\")\n    __OPT_transparent_background = Rhino.Input.Custom.OptionToggle(True, \"Off\", \"On\")\n    __OPT_fps = Rhino.Input.Custom.OptionInteger(30, 0, 120)\n    __OPT_duration = Rhino.Input.Custom.OptionInteger(15000, 1, 100000)\n    _build_folder = os.path.dirname(Rhino.RhinoDoc.ActiveDoc.Path)\n    __OPT_width = Rhino.Input.Custom.OptionInteger(1500, 1, 5000)\n    __OPT_height = Rhino.Input.Custom.OptionInteger(1500, 1, 5000)\n\n    __OPT_gaussian_move = Rhino.Input.Custom.OptionToggle(True, \"Off\", \"On\")\n\n    __OPT_rot_degrees = Rhino.Input.Custom.OptionInteger(360, 0, 360)\n    __OPT_rotation_axis = Rhino.Input.Custom.OptionInteger(2, 0, 2)\n    __OPT_rotation_clockwise = Rhino.Input.Custom.OptionToggle(False, \"Off\", \"On\")\n\n    __OPT_translation_axis = Rhino.Input.Custom.OptionInteger(2, 0, 2)\n    __OPT_translation_distance = Rhino.Input.Custom.OptionDouble(0.03, 0., 10000.)\n    __OPT_translation_go_back = Rhino.Input.Custom.OptionToggle(True, \"Off\", \"On\")\n    \n    is_subopt = False\n    animation_type = AnimationType.ROTATION\n\n    while True:\n        if not is_subopt:\n            go.ClearCommandOptions()\n            go.AddOption(\"AnimationType\", animation_type.name)\n            go.AddOptionToggle(\"isSavingGif\", __OPT_is_saving_gif)\n            go.AddOptionToggle(\"TransparentBackground\", __OPT_transparent_background)\n            go.AddOptionInteger(\"Fps\", __OPT_fps)\n            go.AddOptionInteger(\"Duration_ms\", __OPT_duration)\n            go.AddOption(\"BuildDirectory\")\n            go.AddOptionInteger(\"Width\", __OPT_width)\n            go.AddOptionInteger(\"Height\", __OPT_height)\n            go.AddOption(\"Options\")\n\n        get_rc: Rhino.Input.GetResult = go.Get()\n\n        if get_rc == Rhino.Input.GetResult.Object:\n            break\n        elif get_rc == Rhino.Input.GetResult.Cancel:\n            if is_subopt:\n                is_subopt = False\n                continue\n            return Rhino.Commands.Result.Cancel\n\n        elif get_rc == Rhino.Input.GetResult.Option:\n            option = go.Option().EnglishName\n            if option == \"BuildDirectory\":\n                folder = rs.BrowseForFolder(\"Select folder to save the animation\")\n                if folder:\n                    _build_folder = folder\n\n            elif option == \"AnimationType\":\n                is_subopt = True\n                go.ClearCommandOptions()\n                go.AddOption(AnimationType.ROTATION.name)\n                go.AddOption(AnimationType.TRANSLATION.name)\n            elif option == \"ROTATION\":\n                animation_type = AnimationType.ROTATION\n                is_subopt = False\n                continue\n            elif option == \"TRANSLATION\":\n                animation_type = AnimationType.TRANSLATION\n                is_subopt = False\n                continue\n\n            elif option == \"Options\":\n                is_subopt = True\n                go.ClearCommandOptions()\n                if animation_type == AnimationType.ROTATION:\n                    go.AddOptionInteger(\"TotalRotation\", __OPT_rot_degrees)\n                    go.AddOptionInteger(\"RotationAxis\", __OPT_rotation_axis)\n                    go.AddOptionToggle(\"RotationClockwise\", __OPT_rotation_clockwise)\n                if animation_type == AnimationType.TRANSLATION:\n                    go.AddOptionInteger(\"TranslationAxis\", __OPT_translation_axis)\n                    go.AddOptionDouble(\"TranslationDistance\", __OPT_translation_distance)\n                    go.AddOptionToggle(\"TranslationGoBack\", __OPT_translation_go_back)\n                go.AddOptionToggle(\"GaussianMove\", __OPT_gaussian_move)\n            continue\n        break\n \n    go.Get()\n    obj_ref = go.Object(0)\n    mesh = obj_ref.Geometry()\n\n    _is_saving_gif = __OPT_is_saving_gif.CurrentValue\n    _transparent_background = __OPT_transparent_background.CurrentValue\n    _fps = __OPT_fps.CurrentValue\n    _duration = __OPT_duration.CurrentValue\n    _width = __OPT_width.CurrentValue\n    _height = __OPT_height.CurrentValue\n    \n    _is_gaussian_move = __OPT_gaussian_move.CurrentValue\n    \n    _total_rotation = __OPT_rot_degrees.CurrentValue\n    _rotation_axis = get_translation_axis(__OPT_rotation_axis.CurrentValue)\n    _rotation_clockwise = __OPT_rotation_clockwise.CurrentValue\n\n    _translation_axis = get_translation_axis(__OPT_translation_axis.CurrentValue)\n    _translation_distance = __OPT_translation_distance.CurrentValue\n    _translation_go_back = __OPT_translation_go_back.CurrentValue\n    \n    num_frames = int(_fps * (_duration / 1000) / 2) if _translation_go_back else int(_fps * (_duration / 1000))\n    gif_delay = int(1000 / _fps) // 10\n    sleep_time = _duration / num_frames\n    \n    print(\"\\nOptions values:\")\n    print(f\"\\tSaving gif: {_is_saving_gif}\")\n    print(f\"\\tTransparent background: {_transparent_background}\")\n    print(f\"\\tFPS: {_fps}\")\n    print(f\"\\tNumber of frames: {num_frames}\")\n    print(f\"\\tGif delay (hundredths secs): {gif_delay}\")\n    print(f\"\\tDuration: {_duration}\")\n    print(f\"\\tWidth: {_width}\")\n    print(f\"\\tHeight: {_height}\\n\")\n\n    build_folder = os.path.join(_build_folder, \"build\")\n    if os.path.exists(build_folder):\n        for file in os.listdir(build_folder):\n            os.remove(os.path.join(build_folder, file))\n    else:\n        os.makedirs(build_folder)\n\n    if _is_saving_gif:\n        view = Rhino.RhinoDoc.ActiveDoc.Views.ActiveView\n        if view is None:\n            raise Exception(\"No active view found\")\n        view_capture = Rhino.Display.ViewCapture()\n        view_capture.Width = _width\n        view_capture.Height = _height\n        view_capture.ScaleScreenItems = False\n        view_capture.DrawAxes = False\n        view_capture.DrawGrid = False\n        view_capture.DrawGridAxes = False\n        view_capture.TransparentBackground = _transparent_background\n\n    #------------------------------------------------------------\n    # Animation + save bitmpas on memory\n    #------------------------------------------------------------\n    if animation_type == AnimationType.ROTATION:\n        rotation_values = generate_animation_values(\n            num_frames,\n            _is_gaussian_move,\n            _total_rotation\n        )\n\n        total_angle = 0\n        mesh_ctr = mesh.GetBoundingBox(True).Center\n        for i in range(num_frames):\n            angle = rotation_values[i] if _rotation_clockwise else -rotation_values[i]\n            total_angle += angle\n            xform = rg.Transform.Rotation(math.radians(angle), _rotation_axis, mesh_ctr)\n            mesh.Transform(xform)\n            Rhino.RhinoDoc.ActiveDoc.Objects.Replace(obj_ref, mesh)\n            Rhino.RhinoDoc.ActiveDoc.Views.Redraw()\n            \n            if _is_saving_gif:\n                save_frame(view_capture, view, build_folder, i, num_frames)\n                rs.Sleep(1)\n\n    elif animation_type == AnimationType.TRANSLATION:\n        translation_values = generate_animation_values(\n            num_frames,\n            _is_gaussian_move,\n            _translation_distance\n        )\n        if _translation_go_back:\n            backwards = translation_values[::-1]\n            backwards = [val * -1 for val in backwards]\n            translation_values += backwards\n            num_frames *= 2\n\n        total_distance = 0\n        for i in range(num_frames):\n            translation = translation_values[i]\n            total_distance += translation\n            xform = rg.Transform.Translation(_translation_axis * translation)\n            mesh.Transform(xform)\n            Rhino.RhinoDoc.ActiveDoc.Objects.Replace(obj_ref, mesh)\n            Rhino.RhinoDoc.ActiveDoc.Views.Redraw()\n            \n            if _is_saving_gif:\n                save_frame(view_capture, view, build_folder, i, num_frames)\n                rs.Sleep(1)\n\n    rs.UnselectAllObjects()\n\n    #------------------------------------------------------------\n    # Bake gif\n    #------------------------------------------------------------\n    if _is_saving_gif:\n        gif_path = os.path.join(build_folder, \"animation.gif\")\n        frames = [os.path.join(build_folder, f\"frame_{i}.png\") for i in range(num_frames)]\n        \n        with Image() as new_gif:\n            arg2 = library.NewPixelWand()\n            library.MagickSetOption(\n                new_gif.wand,\n                b\"dispose\",\n                b\"2\"\n            )\n            for img_path in frames:\n                library.MagickReadImage(\n                    new_gif.wand,\n                    img_path.encode('utf-8')\n                )\n                new_gif.delay = gif_delay\n                print_progress_bar(frames.index(img_path) + 1, len(frames), prefix='Saving:', suffix='Complete')\n                rs.Sleep(1)\n            Rhino.RhinoApp.SetCommandPrompt(\"Saving gif, please wait..\")\n            new_gif.save(filename=gif_path)\n            \n        for frame in frames:\n            os.remove(frame)\n\n        os.system(f\"start {gif_path}\")\n        print(f\"Animation saved to: {gif_path}\")\n\n    print(\"Closing moveit.\")\n\n\nif __name__ == \"__main__\":\n    main()",
  "language": "python",
  "imports": [
    "Rhino",
    "Rhino.Geometry",
    "rhinoscriptsyntax"
  ],
  "has_docstring": true
}