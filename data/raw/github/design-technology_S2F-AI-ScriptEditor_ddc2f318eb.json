{
  "source_url": "https://github.com/design-technology/S2F-AI-ScriptEditor/blob/b8b186096f89bf831661ef8308693b98d2bb5b39/5-Running_in_Rhino_Simple/app.py",
  "repo": "design-technology/S2F-AI-ScriptEditor",
  "repo_stars": 5,
  "repo_description": null,
  "license": "unknown",
  "filepath": "5-Running_in_Rhino_Simple/app.py",
  "instruction": null,
  "code": "import os, sys, threading, tempfile\nimport os.path as op\n# -------------------------------------------\n# make sure to change the cache path\n# -------------------------------------------\ncache_path = \"Z:\\\\Development Projects\\\\huggingface\"\nos.environ[\"TRANSFORMERS_CACHE\"] = cache_path\nos.environ[\"HF_HUB_CACHE\"] = cache_path\nos.environ[\"HUGGINGFACE_HUB_CACHE\"] = cache_path \nos.environ[\"HF_HOME\"] = cache_path\n\nimport rhinoscriptsyntax as rs\nimport Rhino\nimport scriptcontext as sc\nimport Eto.Forms as forms\nimport Eto.Drawing as drawing\nfrom System.Drawing import Bitmap, Imaging\nfrom PIL import Image, ImageOps\n\n# -------------------------------------------\n# make sure to change the env environment path\n# -------------------------------------------\n\n# Configure environment\nCONDA_ENV = r'C:\\Users\\Hesham.Shawqy\\anaconda3\\envs\\generative_ai'\nsys.path.append(op.join(CONDA_ENV, r\"Lib\\site-packages\"))\nos.add_dll_directory(op.join(CONDA_ENV, r'Library\\bin'))\n\nfrom image_generation.image_generation import generate_from_rhino_view, initialize_models, is_loading_complete\n# viewport to bitmap to pil image\ndef capture_viewport():\n    view = sc.doc.Views.ActiveView\n    bitmap = view.CaptureToBitmap()\n    \n    with tempfile.NamedTemporaryFile(suffix='.png', delete=False) as temp_file:\n        temp_path = temp_file.name\n    \n    bitmap.Save(temp_path, Imaging.ImageFormat.Png)\n    pil_image = Image.open(temp_path)\n    \n    return pil_image\n\n# pil to bitmap to eto\ndef pil_to_eto_image(pil_image):\n    with tempfile.NamedTemporaryFile(suffix='.png', delete=False) as temp_file:\n        temp_path = temp_file.name\n    \n    pil_image.save(temp_path, format='PNG')\n    bitmap = Bitmap(temp_path)\n    \n    with tempfile.NamedTemporaryFile(suffix='.png', delete=False) as eto_temp_file:\n        eto_temp_path = eto_temp_file.name\n    \n    bitmap.Save(eto_temp_path, Imaging.ImageFormat.Png)\n    eto_bitmap = drawing.Bitmap(eto_temp_path)\n\n    return eto_bitmap\n\n# Initialize sticky dictionary for form reference\n# if 'negative_viewport_form' not in sc.sticky:\n#     sc.sticky['negative_viewport_form'] = None\n\n# creating the UI components\ndef create_ui_controls():\n    # Create image view\n    image_view = forms.ImageView()\n    image_view.BackgroundColor = drawing.Color.FromArgb(255, 255, 255)\n    \n    \n    ai_button = forms.Button()\n    ai_button.Text = \"Generate AI Image\"\n    # only active when the model is loaded\n    ai_button.Enabled = is_loading_complete()\n    \n    # Create status label\n    status_label = forms.Label()\n    if not is_loading_complete():\n        status_label.Text = \"Loading AI models...this might take a few minutes\"\n        status_label.TextColor = drawing.Color.FromArgb(200, 0, 0)\n    else:\n        status_label.Text = \"AI models loaded and ready\"\n        status_label.TextColor = drawing.Color.FromArgb(0, 128, 0)\n    \n    # Create prompt controls\n    prompt_label = forms.Label()\n    prompt_label.Text = \"Text Prompt\"\n    \n    prompt_text = forms.TextArea()\n    prompt_text.Text = \"a stunning architectural visualization of the design, photorealistic render, 4k, high resolution\"\n    prompt_text.Height = 60\n    \n    return image_view, ai_button, status_label, prompt_label, prompt_text\n\n\ndef show_image_dialog():\n    \n    initialize_models()\n    \n    # Create form\n    form = forms.Form()\n    form.Title = \"Rhino AI Image Generator\"\n    form.ClientSize = drawing.Size(600, 600)\n    form.Padding = drawing.Padding(10)\n    # bring the form forward above other applications\n    form.Topmost = True\n    \n    # Get UI controls\n    image_view, ai_button, status_label, prompt_label, prompt_text = create_ui_controls()\n    \n    # Create the main layout\n    layout = forms.DynamicLayout()\n    layout.Padding = drawing.Padding(10)\n    layout.Spacing = drawing.Size(5, 5)\n    \n    layout.Add(image_view, yscale=True)\n    layout.Add(prompt_label)\n    layout.Add(prompt_text)\n    layout.Add(status_label)\n    \n    # Create button layout\n    button_layout = forms.DynamicLayout()\n    button_layout.Spacing = drawing.Size(5, 0)\n    button_layout.AddRow(None, ai_button)\n    \n    layout.Add(button_layout)\n    form.Content = layout\n    \n    # Store image capture\n    captured_image = None\n    \n    # Setup loading timer\n    check_loading_timer = forms.UITimer()\n    check_loading_timer.Interval = 1.0\n    \n    #timer event handler\n    def update_loading_status(sender, e):\n        if is_loading_complete():\n            status_label.Text = \"AI models loaded and ready\"\n            status_label.TextColor = drawing.Color.FromArgb(0, 128, 0)\n            ai_button.Enabled = True\n            check_loading_timer.Stop()\n    \n    check_loading_timer.Elapsed += update_loading_status\n    check_loading_timer.Start()\n    \n    \n    def on_ai_button_click(sender, e):\n        try:\n            if not is_loading_complete():\n                print(\"AI models are still loading. Please wait...\")\n                return\n            \n            nonlocal captured_image\n            captured_image = capture_viewport()\n            \n            prompt = prompt_text.Text\n            status_label.Text = \"Generating AI image...\"\n            ai_button.Enabled = False\n            \n            def generate_in_background():\n                try:\n                    ai_image = generate_from_rhino_view(captured_image, prompt=prompt)\n                    \n                    def update_ui():\n                        nonlocal ai_image\n                        if image_view.Image is not None:\n                            image_view.Image = None\n                        \n                        image_view.Image = pil_to_eto_image(ai_image)\n                        \n                        ai_button.Enabled = True\n                        status_label.Text = \"AI models loaded and ready\"\n                        \n                        print(\"AI image generated and displayed\")\n                    \n                    forms.Application.Instance.Invoke(update_ui)\n                    \n                except Exception as ex:\n                    def show_error():\n                        nonlocal ex\n                        print(f\"Error generating AI image: {str(ex)}\")\n                        status_label.Text = f\"Error: {str(ex)}\"\n                        ai_button.Enabled = True\n                    \n                    forms.Application.Instance.Invoke(show_error)\n            \n            threading.Thread(target=generate_in_background).start()\n            \n        except Exception as e:\n            print(f\"Error generating AI image: {str(e)}\")\n            status_label.Text = f\"Error: {str(e)}\"\n            ai_button.Enabled = True\n    \n    def on_form_closing(sender, e):\n        if image_view.Image is not None:\n            image_view.Image = None\n        check_loading_timer.Stop()\n    \n    # Connect events\n    ai_button.Click += on_ai_button_click\n    form.Closing += on_form_closing\n    \n    form.Show()\n    \n    return form\n\nif __name__ == \"__main__\":\n    show_image_dialog()",
  "language": "python",
  "imports": [
    "Rhino",
    "rhinoscriptsyntax",
    "scriptcontext"
  ],
  "has_docstring": false
}