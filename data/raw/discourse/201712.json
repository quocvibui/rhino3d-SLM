{
  "source_url": "https://discourse.mcneel.com/t/new-custom-snapping-with-rhinocommon/201712",
  "topic_id": 201712,
  "title": "New custom snapping with RhinoCommon",
  "question": "Hi Scripting Guru.\n\n\nI’m trying to create a RhinoCommon script for snapping to the highest points in a cluster of points. I’m at loss for word trying to fix this error for the past week. I even used ChatGPT to diagnose these 2 persistent errors. So far no dice. Any advice? Thanks in advance!\n\n\nCS0019  'Operator ‘==’ cannot be applied to operands of type ‘method group’ and ‘int’\n\nCS8602 Dereference of a possibly null reference.\n\n\n\n\nusing System;\nusing Rhino;\nusing Rhino.Geometry;\nusing Rhino.Commands;\nusing Rhino.DocObjects;\nusing Rhino.Input.Custom;\n\npublic class DynamicSnapCommand : Command\n{\n    public override string EnglishName => \"DynamicSnapCommand\";\n\n    // To track if the command is running or not\n    private bool _isRunning;\n\n    protected override Result RunCommand(RhinoDoc doc, RunMode mode)\n    {\n        // Define the snap radius (100mm)\n        double snapRadius = 100.0;\n\n        // Start running the dynamic snap\n        _isRunning = true;\n        RhinoApp.WriteLine(\"Dynamic snapping is now active. Press ESC to stop.\");\n\n        // Event-based method is better than continuous loops\n        while (_isRunning)\n        {\n            // Track mouse movement and snap logic\n            var activeView = doc.Views.ActiveView;\n\n            // Check if the active view and viewport are not null\n            if (activeView == null || activeView.ActiveViewport == null)\n            {\n                RhinoApp.WriteLine(\"No active view or viewport.\");\n                return Result.Failure;\n            }\n\n            // Use GetPoint to track user input (mouse position)\n            var gp = new GetPoint();\n            gp.SetCommandPrompt(\"Select point for snapping\");\n\n            gp.Get(); // This ensures we capture the mouse position or user input\n\n            // Check if the user canceled or accepted the command\n            if (gp.CommandResult() != Result.Success)  // Ensure you're calling the method (gp.CommandResult())\n            {\n                RhinoApp.WriteLine...",
  "code_blocks": [
    {
      "code": "using System;\nusing Rhino;\nusing Rhino.Geometry;\nusing Rhino.Commands;\nusing Rhino.DocObjects;\nusing Rhino.Input.Custom;\n\npublic class DynamicSnapCommand : Command\n{\n    public override string EnglishName => \"DynamicSnapCommand\";\n\n    // To track if the command is running or not\n    private bool _isRunning;\n\n    protected override Result RunCommand(RhinoDoc doc, RunMode mode)\n    {\n        // Define the snap radius (100mm)\n        double snapRadius = 100.0;\n\n        // Start running the dynamic snap\n        _isRunning = true;\n        RhinoApp.WriteLine(\"Dynamic snapping is now active. Press ESC to stop.\");\n\n        // Event-based method is better than continuous loops\n        while (_isRunning)\n        {\n            // Track mouse movement and snap logic\n            var activeView = doc.Views.ActiveView;\n\n            // Check if the active view and viewport are not null\n            if (activeView == null || activeView.ActiveViewport == null)\n            {\n                RhinoApp.WriteLine(\"No active view or viewport.\");\n                return Result.Failure;\n            }\n\n            // Use GetPoint to track user input (mouse position)\n            var gp = new GetPoint();\n            gp.SetCommandPrompt(\"Select point for snapping\");\n\n            gp.Get(); // This ensures we capture the mouse position or user input\n\n            // Check if the user canceled or accepted the command\n            if (gp.CommandResult() != Result.Success)  // Ensure you're calling the method (gp.CommandResult())\n            {\n                RhinoApp.WriteLine(\"Failed to get point.\");\n                return Result.Failure;\n            }\n\n            var mousePos = gp.Point(); // This is the point selected by the user (mouse position)\n\n            // Retrieve the points in the model space\n            var pointObjs = doc.Objects.FindByObjectType(ObjectType.Point);\n            if (pointObjs == null || pointObjs.Count == 0)\n            {\n                RhinoApp.WriteLine(\"No points found in the model space.\");\n                return Result.Failure;\n            }\n\n            // Find the highest point within 100mm radius\n            Point3d? snapPoint = null;\n            double maxZ = double.MinValue;\n\n            foreach (var pointObj in pointObjs)\n            {\n                var point = pointObj.Geometry as Point;\n                if (point == null) continue;\n\n                double distance = point.Location.DistanceTo(mousePos);\n                if (distance <= snapRadius)\n                {\n                    if (point.Location.Z > maxZ)\n                    {\n                        maxZ = point.Location.Z;\n                        snapPoint = point.Location; // Store the highest Z within range\n                    }\n                }\n            }\n\n            // If a valid snap point is found, display the result\n            if (snapPoint.HasValue)  // Correctly check if snapPoint has a value\n            {\n                RhinoApp.WriteLine($\"Snapping to the highest point at {snapPoint.Value}\");\n            }\n            else\n            {\n                RhinoApp.WriteLine(\"No valid snap points found within the defined radius.\");\n            }\n\n            // Check for user input or stop conditions (ESC key press)\n            if (gp.CommandResult() == Result.Cancel)  // Ensure you're calling the method (gp.CommandResult())\n            {\n                _isRunning = false;\n                RhinoApp.WriteLine(\"Dynamic snapping stopped.\");\n            }\n\n            // Allow Rhino to update its UI (this is equivalent to allowing the program to update the screen during a loop)\n            RhinoApp.Wait();\n        }\n\n        return Result.Success;\n    }\n}",
      "language": "csharp",
      "author": "IceTea",
      "post_number": 1,
      "is_solution": false
    }
  ],
  "tags": [
    "csharp",
    "geometry",
    "python",
    "rhinocommon",
    "transformation"
  ],
  "has_accepted_answer": true,
  "category_id": 11,
  "posts_count": 7,
  "views": 164
}