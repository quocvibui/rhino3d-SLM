{
  "source_url": "https://github.com/Prasanna721/AgenticModelling/blob/a14a122d8bc650b47275c7d47c3366d7229c45ff/RLI_agent/rli_agent/tools/converter_tool.py",
  "repo": "Prasanna721/AgenticModelling",
  "repo_stars": 0,
  "repo_description": null,
  "license": "unknown",
  "filepath": "RLI_agent/rli_agent/tools/converter_tool.py",
  "instruction": "3D file format converter tool.",
  "code": "\"\"\"3D file format converter tool.\"\"\"\n\nimport os\nimport json\nimport tempfile\nfrom pathlib import Path\n\nfrom claude_agent_sdk import tool\n\nfrom .firebase_tool import download_file_bytes, upload_to_firebase\n\n\nSUPPORTED_CONVERSIONS = {\n    \"3dm\": {\n        \"extension\": \".3dm\",\n        \"content_type\": \"application/octet-stream\",\n        \"description\": \"Rhino 3DM format\"\n    },\n    \"obj\": {\n        \"extension\": \".obj\",\n        \"content_type\": \"model/obj\",\n        \"description\": \"Wavefront OBJ format\"\n    },\n    \"stl\": {\n        \"extension\": \".stl\",\n        \"content_type\": \"model/stl\",\n        \"description\": \"STL format\"\n    },\n    \"fbx\": {\n        \"extension\": \".fbx\",\n        \"content_type\": \"application/octet-stream\",\n        \"description\": \"FBX format\"\n    }\n}\n\n\nasync def convert_glb_to_obj(glb_data: bytes) -> bytes:\n    \"\"\"Convert GLB to OBJ format using trimesh.\"\"\"\n    import trimesh\n\n    with tempfile.NamedTemporaryFile(suffix='.glb', delete=False) as f:\n        f.write(glb_data)\n        glb_path = f.name\n\n    try:\n        # Load GLB with trimesh\n        mesh = trimesh.load(glb_path)\n\n        # If it's a scene, get the geometry\n        if hasattr(mesh, 'geometry'):\n            # Combine all geometries\n            meshes = list(mesh.geometry.values())\n            if meshes:\n                mesh = trimesh.util.concatenate(meshes)\n\n        # Export to OBJ\n        obj_data = mesh.export(file_type='obj')\n        return obj_data.encode() if isinstance(obj_data, str) else obj_data\n    finally:\n        os.unlink(glb_path)\n\n\nasync def convert_glb_to_stl(glb_data: bytes) -> bytes:\n    \"\"\"Convert GLB to STL format using trimesh.\"\"\"\n    import trimesh\n\n    with tempfile.NamedTemporaryFile(suffix='.glb', delete=False) as f:\n        f.write(glb_data)\n        glb_path = f.name\n\n    try:\n        mesh = trimesh.load(glb_path)\n\n        if hasattr(mesh, 'geometry'):\n            meshes = list(mesh.geometry.values())\n            if meshes:\n                mesh = trimesh.util.concatenate(meshes)\n\n        return mesh.export(file_type='stl')\n    finally:\n        os.unlink(glb_path)\n\n\nasync def convert_glb_to_3dm(glb_data: bytes) -> bytes:\n    \"\"\"Convert GLB to 3DM (Rhino) format.\"\"\"\n    import trimesh\n    import rhino3dm\n\n    with tempfile.NamedTemporaryFile(suffix='.glb', delete=False) as f:\n        f.write(glb_data)\n        glb_path = f.name\n\n    try:\n        # Load GLB with trimesh\n        scene = trimesh.load(glb_path)\n\n        # Create Rhino 3DM file\n        model = rhino3dm.File3dm()\n\n        # Get meshes from scene\n        if hasattr(scene, 'geometry'):\n            meshes = list(scene.geometry.values())\n        else:\n            meshes = [scene]\n\n        for mesh in meshes:\n            if not hasattr(mesh, 'vertices') or not hasattr(mesh, 'faces'):\n                continue\n\n            # Create Rhino mesh\n            rhino_mesh = rhino3dm.Mesh()\n\n            # Add vertices\n            for vertex in mesh.vertices:\n                rhino_mesh.Vertices.Add(float(vertex[0]), float(vertex[1]), float(vertex[2]))\n\n            # Add faces\n            for face in mesh.faces:\n                if len(face) == 3:\n                    rhino_mesh.Faces.AddFace(int(face[0]), int(face[1]), int(face[2]))\n                elif len(face) == 4:\n                    rhino_mesh.Faces.AddFace(int(face[0]), int(face[1]), int(face[2]), int(face[3]))\n\n            # Compute normals\n            rhino_mesh.Normals.ComputeNormals()\n            rhino_mesh.Compact()\n\n            # Add to model\n            model.Objects.AddMesh(rhino_mesh)\n\n        # Save to temp file and read bytes\n        with tempfile.NamedTemporaryFile(suffix='.3dm', delete=False) as out_f:\n            out_path = out_f.name\n\n        model.Write(out_path)\n\n        with open(out_path, 'rb') as f:\n            result = f.read()\n\n        os.unlink(out_path)\n        return result\n\n    finally:\n        os.unlink(glb_path)\n\n\nasync def convert_file(source_url: str, target_format: str) -> str:\n    \"\"\"\n    Convert a 3D file to a different format.\n\n    Args:\n        source_url: URL of the source 3D file (GLB/GLTF)\n        target_format: Target format (3dm, obj, stl)\n\n    Returns:\n        Firebase URL of the converted file\n    \"\"\"\n    target_format = target_format.lower().strip('.')\n\n    if target_format not in SUPPORTED_CONVERSIONS:\n        raise ValueError(f\"Unsupported target format: {target_format}. Supported: {list(SUPPORTED_CONVERSIONS.keys())}\")\n\n    # Download source file\n    source_data = await download_file_bytes(source_url, timeout=300)\n\n    # Determine conversion function based on target format\n    if target_format == \"3dm\":\n        converted_data = await convert_glb_to_3dm(source_data)\n    elif target_format == \"obj\":\n        converted_data = await convert_glb_to_obj(source_data)\n    elif target_format == \"stl\":\n        converted_data = await convert_glb_to_stl(source_data)\n    else:\n        raise ValueError(f\"Conversion to {target_format} not yet implemented\")\n\n    # Upload to Firebase\n    format_info = SUPPORTED_CONVERSIONS[target_format]\n    filename = f\"converted_model{format_info['extension']}\"\n\n    url = await upload_to_firebase(\n        converted_data,\n        filename,\n        path_prefix=\"models_3d\",\n        content_type=format_info['content_type']\n    )\n\n    return url\n\n\n# ============================================================================\n# SDK Tool Wrapper\n# ============================================================================\n\n@tool(\n    \"convert_file\",\n    \"Convert 3D files between formats. Supports GLB to 3DM, OBJ, STL conversion.\",\n    {\n        \"source_url\": str,\n        \"target_format\": str\n    }\n)\nasync def convert_file_tool(args: dict) -> dict:\n    \"\"\"Convert 3D file to different format.\"\"\"\n    try:\n        url = await convert_file(\n            source_url=args[\"source_url\"],\n            target_format=args[\"target_format\"]\n        )\n        return {\n            \"content\": [{\n                \"type\": \"text\",\n                \"text\": json.dumps({\n                    \"success\": True,\n                    \"url\": url,\n                    \"format\": args[\"target_format\"]\n                })\n            }]\n        }\n    except Exception as e:\n        return {\n            \"content\": [{\n                \"type\": \"text\",\n                \"text\": json.dumps({\n                    \"success\": False,\n                    \"error\": str(e)\n                })\n            }],\n            \"is_error\": True\n        }\n",
  "language": "python",
  "imports": [
    "rhino3dm"
  ],
  "has_docstring": true
}