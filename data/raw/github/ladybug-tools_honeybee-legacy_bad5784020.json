{
  "source_url": "https://github.com/ladybug-tools/honeybee-legacy/blob/bd62af4862fe022801fb87dbc8794fdf1dff73a9/src/Honeybee_Re-run%20OSM.py",
  "repo": "ladybug-tools/honeybee-legacy",
  "repo_stars": 129,
  "repo_description": ":bee: Honeybee is a free and open source plugin to connect Grasshopper3D to EnergyPlus, Radiance, Daysim and OpenStudio for building energy and daylighting simulation",
  "license": "NOASSERTION",
  "filepath": "src/Honeybee_Re-run OSM.py",
  "instruction": "This is a component for running a previoulsy-generated .osm file through EnergyPlus.",
  "code": "# This is a component for running a previoulsy-generated .idf file through EnergyPlus with a different weather file.\n#\n# Honeybee: A Plugin for Environmental Analysis (GPL) started by Mostapha Sadeghipour Roudsari\n# \n# This file is part of Honeybee.\n# \n# Copyright (c) 2013-2020, Mostapha Sadeghipour Roudsari <mostapha@ladybug.tools> \n# Honeybee is free software; you can redistribute it and/or modify \n# it under the terms of the GNU General Public License as published \n# by the Free Software Foundation; either version 3 of the License, \n# or (at your option) any later version. \n# \n# Honeybee is distributed in the hope that it will be useful,\n# but WITHOUT ANY WARRANTY; without even the implied warranty of \n# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the \n# GNU General Public License for more details.\n# \n# You should have received a copy of the GNU General Public License\n# along with Honeybee; If not, see <http://www.gnu.org/licenses/>.\n# \n# @license GPL-3.0+ <http://spdx.org/licenses/GPL-3.0+>\n\n\n\"\"\"\nThis is a component for running a previoulsy-generated .osm file through EnergyPlus.\n\n-\nProvided by Ladybug 0.0.45\n    \n    Args:\n        _osmFilePath: A full file path to an OpenStdio Model (.osm) file.\n        _epwFileAddress: A full file path to an epw weather file.\n        parallel_: Set to \"True\" to run multiple IDFs using multiple CPUs.  Note that this input is only relevant when you have plugged in a list of OSM file addresses.\n        _runIt: Set to \"True\" to have the component generate an IDF file from the OSM file and run the IDF through through EnergyPlus.  Set to \"False\" to not run the file (this is the default).  You can also connect an integer for the following options:\n            0 = Do Not Run OSM and IDF thrrough EnergyPlus\n            1 = Run the OSM and IDF through EnergyPlus with a command prompt window that displays the progress of the simulation\n            2 = Run the OSM and IDF through EnergyPlus in the background (without the command line popup window).\n            3 = Generate an IDF from the OSM file but do not run it through EnergyPlus\n    Returns:\n        report: Report!\n        idfFileAddress: The file path of the IDF file that has been generated on your machine. This file is only generated when you set \"runSimulation_\" to \"True.\"\n        resultFileAddress: The address of the EnergyPlus result file.\n        eioFileAddress:  The file path of the EIO file that has been generated on your machine.  This file contains information about the sizes of all HVAC equipment from the simulation.  This file is only generated when you set \"runSimulation_\" to \"True.\"\n        rddFileAddress: The file path of the Result Data Dictionary (.rdd) file that is generated after running the file through EnergyPlus.  This file contains all possible outputs that can be requested from the EnergyPlus model.  Use the \"Honeybee_Read Result Dictionary\" to see what outputs can be requested.\n\"\"\"\n\nghenv.Component.Name = \"Honeybee_Re-run OSM\"\nghenv.Component.NickName = 'Re-Run OSM'\nghenv.Component.Message = 'VER 0.0.66\\nJUL_07_2020'\nghenv.Component.IconDisplayMode = ghenv.Component.IconDisplayMode.application\nghenv.Component.Category = \"HB-Legacy\"\nghenv.Component.SubCategory = \"10 | Energy | Energy\"\n#compatibleHBVersion = VER 0.0.56\\nJUL_24_2016\n#compatibleLBVersion = VER 0.0.59\\nFEB_01_2015\nghenv.Component.AdditionalHelpFromDocStrings = \"0\"\n\n\nimport os\nimport scriptcontext as sc\nimport shutil\nimport Grasshopper.Kernel as gh\nimport time\nimport subprocess\nimport System.Threading.Tasks as tasks\n\ndef checkTheInputs(osmFileName, epwWeatherFile):\n    w = gh.GH_RuntimeMessageLevel.Warning\n    if not os.path.isfile(epwWeatherFile):\n        msg = \"EPW weather file does not exist in the specified location!\"\n        print msg\n        ghenv.Component.AddRuntimeMessage(w, msg)\n        return -1\n    if not epwWeatherFile.lower().endswith('.epw'):\n        msg = \"EPW weather file is not a valid epw!\"\n        print msg\n        ghenv.Component.AddRuntimeMessage(w, msg)\n        return -1\n    \n    if not os.path.isfile(osmFileName):\n        msg = \"OSM file does not exist in the specified location!\"\n        print msg\n        ghenv.Component.AddRuntimeMessage(w, msg)\n        return -1\n    if not osmFileName.lower().endswith('.osm'):\n        msg = \"OSM file is not a valid OSM!\"\n        print msg\n        ghenv.Component.AddRuntimeMessage(w, msg)\n        return -1\n    # Check for white space in file path.\n    if ' ' in osmFileName:\n        warning = \"A white space was found in the .osm file path.  EnergyPlus cannot run out of directories with white spaces.\\n\" + \\\n        \"Copy the .osm file to a directory without a white space and try again.\"\n        print warning\n        w = gh.GH_RuntimeMessageLevel.Warning\n        ghenv.Component.AddRuntimeMessage(w, warning)\n        return -1\n    \n    return True\n\ndef writeBatchFile(workingDir, idfFileName, epwFileAddress, EPDirectory, runInBackground = False):\n    workingDrive = workingDir[:2]\n    if idfFileName.EndsWith('.idf'):  shIdfFileName = idfFileName.replace('.idf', '')\n    else: shIdfFileName = idfFileName\n    \n    if not workingDir.EndsWith('\\\\'): workingDir = workingDir + '\\\\'\n    \n    fullPath = workingDir + shIdfFileName\n    folderName = workingDir.replace( (workingDrive + '\\\\'), '')\n    batchStr = workingDrive + '\\ncd\\\\' +  folderName + '\\n\"' + EPDirectory + \\\n            '\\\\Epl-run\" ' + fullPath + ' ' + fullPath + ' idf ' + epwFileAddress + ' EP N nolimit N N 0 Y'\n\n    batchFileAddress = fullPath +'.bat'\n    batchfile = open(batchFileAddress, 'w')\n    batchfile.write(batchStr)\n    batchfile.close()\n    \n    #execute the batch file\n    if runInBackground:\t\t\n        runCmd(batchFileAddress)\t\t\n    else:\n        os.system(batchFileAddress)\n    \n    return fullPath + \".csv\"\n\ndef runCmd(batchFileAddress, shellKey = True):\n    batchFileAddress.replace(\"\\\\\", \"/\")\n    p = subprocess.Popen([\"cmd /c \", batchFileAddress], shell=shellKey, stdout=subprocess.PIPE, stderr=subprocess.PIPE)\t\t\n    out, err = p.communicate()\n\ndef getEPFolder(osmDirect):\n    try:\n        return sc.sticky[\"honeybee_folders\"][\"EPPath\"]\n    except:\n        raise Exception(\"Failed to find EnergyPlus folder.\")\n\ndef osmToidf(workingDir, projectName, osmPath):\n    # create a new folder to run the analysis\n    projectFolder =os.path.join(workingDir, projectName)\n    \n    try: os.mkdir(projectFolder)\n    except: pass\n    \n    idfFolder = os.path.join(projectFolder)\n    idfFilePath = os.path.join(projectFolder, \"ModelToIdf\", \"in.idf\")\n    try:\n       idfFilePath = ops.Path(idfFilePath)\n    except TypeError:\n        # OpenStudio 2.6.1\n        idfFilePath = ops.Path(ops.OpenStudioUtilitiesCore.toPath(idfFilePath))\n    \n    # load the test model\n    model = ops.Model().load(ops.Path(osmPath)).get()\n    forwardTranslator = ops.EnergyPlusForwardTranslator()\n    workspace = forwardTranslator.translateModel(model)\n    \n    # remove the current object\n    tableStyleObjects = workspace.getObjectsByType(ops.IddObjectType(\"OutputControl_Table_Style\"))\n    for obj in tableStyleObjects: obj.remove()\n    \n    tableStyle = ops.IdfObject(ops.IddObjectType(\"OutputControl_Table_Style\"))\n    tableStyle.setString(0, \"CommaAndHTML\")\n    workspace.addObject(tableStyle)\n    \n    workspace.save(idfFilePath, overwrite = True)\n    \n    return idfFolder, idfFilePath\n\ndef main(epwFile, osmFile, runEnergyPlus, openStudioLibFolder):\n    # Preparation\n    workingDir, fileName = os.path.split(osmFile)\n    projectName = (\".\").join(fileName.split(\".\")[:-1])\n    try:\n        osmPath = ops.Path(osmFile)\n    except TypeError:\n        # OpenStudio 2.6.1\n        osmPath = ops.Path(ops.OpenStudioUtilitiesCore.toPath(osmFile))\n\n    # create idf - I separated this job as putting them together\n    # was making EnergyPlus to crash\n    idfFolder, idfPath = osmToidf(workingDir, projectName, osmPath)\n    print 'OSM > IDF: ' + str(idfPath)\n    \n    if runEnergyPlus < 3:\n        osmDirect = '/'.join(openStudioLibFolder.split('/')[:-3])\n        resultFile = writeBatchFile(idfFolder, \"ModelToIdf\\\\in.idf\", epwFile, getEPFolder(osmDirect), runEnergyPlus > 1)\n        print '...'\n        print 'RUNNING SIMULATION'\n        print '...'\n        \n        try:\n            errorFileFullName = str(idfPath).replace('.idf', '.err')\n            errFile = open(errorFileFullName, 'r')\n            for line in errFile:\n                print line\n                if \"**  Fatal  **\" in line:\n                    warning = \"The simulation has failed because of this fatal error: \\n\" + str(line)\n                    w = gh.GH_RuntimeMessageLevel.Warning\n                    ghenv.Component.AddRuntimeMessage(w, warning)\n                    resultFile = None\n                elif \"** Severe  **\" in line and 'CheckControllerListOrder' not in line:\n                    comment = \"The simulation has not run correctly because of this severe error: \\n\" + str(line)\n                    c = gh.GH_RuntimeMessageLevel.Warning\n                    ghenv.Component.AddRuntimeMessage(c, comment)\n            errFile.close()\n        except:\n            pass\n    else:\n        resultFile = None\n    \n    eioFile = None\n    rddFile = None\n    try:\n        eioFile = resultFile.replace('.csv', '.eio')\n        rddFile = resultFile.replace('.csv', '.rdd')\n    except:\n        pass\n    \n    return workingDir, os.path.join(idfFolder, \"ModelToIdf\", \"in.idf\"), resultFile, eioFile, rddFile\n\ndef main_parallel(epwFile, osmFiles, runEnergyPlus, parallel, openStudioLibFolder):\n    # placeholders.\n    idfFileAddress = [None for x in osmFiles]\n    resultFileAddress = [None for x in osmFiles]\n    eioFileAddress = [None for x in osmFiles]\n    rddFileAddress = [None for x in osmFiles]\n    \n    runInBackground = False\n    if parallel == True:\n        runInBackground = True\n    elif runEnergyPlus > 1:\n        runInBackground = True\n    \n    def runOS(i):\n        fileCheck = checkTheInputs(osmFiles[i], epwFile)\n        if fileCheck != -1:\n            # Preparation\n            workingDir, fileName = os.path.split(osmFiles[i])\n            projectName = (\".\").join(fileName.split(\".\")[:-1])\n            osmPath = ops.Path(osmFiles[i])\n            # create idf\n            idfFolder, idfPath = osmToidf(workingDir, projectName, osmPath)\n            idfFileAddress[i] = idfFolder + \"ModelToIdf\\\\in.idf\"\n            \n            if runEnergyPlus < 3:\n                osmDirect = '/'.join(openStudioLibFolder.split('/')[:-3])\n                resultFile = writeBatchFile(idfFolder, \"ModelToIdf\\\\in.idf\", epwFile, getEPFolder(osmDirect), runInBackground)\n                resultFileAddress[i] = resultFile\n                eioFileAddress[i] = resultFile.replace('.csv', '.eio')\n                rddFileAddress[i] = resultFile.replace('.csv', '.rdd')\n    \n    if parallel == True:\n        tasks.Parallel.ForEach(range(len(osmFiles)), runOS)\n    else:\n        for x in range(len(osmFiles)):\n            runOS(x)\n    \n    return None, idfFileAddress, resultFileAddress, eioFileAddress, rddFileAddress\n\n#Honeybee check.\ninitCheck = True\nif not sc.sticky.has_key('honeybee_release') == True:\n    initCheck = False\n    print \"You should first let Honeybee fly...\"\n    ghenv.Component.AddRuntimeMessage(w, \"You should first let Honeybee fly...\")\nelse:\n    try:\n        if not sc.sticky['honeybee_release'].isCompatible(ghenv.Component): initCheck = False\n        if sc.sticky['honeybee_release'].isInputMissing(ghenv.Component): initCheck = False\n        hb_hvacProperties = sc.sticky['honeybee_hvacProperties']()\n        hb_airDetail = sc.sticky[\"honeybee_hvacAirDetails\"]\n        hb_heatingDetail = sc.sticky[\"honeybee_hvacHeatingDetails\"]\n        hb_coolingDetail = sc.sticky[\"honeybee_hvacCoolingDetails\"]\n    except:\n        initCheck = False\n        warning = \"You need a newer version of Honeybee to use this compoent.\" + \\\n        \"Use updateHoneybee component to update userObjects.\\n\" + \\\n        \"If you have already updated userObjects drag Honeybee_Honeybee component \" + \\\n        \"into canvas and try again.\"\n        ghenv.Component.AddRuntimeMessage(w, warning)\n\nif sc.sticky.has_key('honeybee_release'):\n    if sc.sticky[\"honeybee_folders\"][\"OSLibPath\"] != None:\n        # openstudio is there\n        openStudioLibFolder = sc.sticky[\"honeybee_folders\"][\"OSLibPath\"]\n        openStudioIsReady = True\n        import clr\n        clr.AddReferenceToFileAndPath(openStudioLibFolder+\"\\\\openStudio.dll\")\n        \n        import sys\n        if openStudioLibFolder not in sys.path:\n            sys.path.append(openStudioLibFolder)\n        \n        import OpenStudio as ops\n    else:\n        openStudioIsReady = False\n        # let the user know that they need to download OpenStudio libraries\n        msg1 = \"You do not have OpenStudio installed on Your System.\\n\" + \\\n            \"You wont be able to use this component until you install it.\\n\" + \\\n            \"Download the latest OpenStudio for Windows from:\\n\"\n        msg2 = \"https://www.openstudio.net/downloads\"\n        print msg1\n        print msg2\n        ghenv.Component.AddRuntimeMessage(gh.GH_RuntimeMessageLevel.Warning, msg1)\n        ghenv.Component.AddRuntimeMessage(gh.GH_RuntimeMessageLevel.Warning, msg2)\nelse:\n    openStudioIsReady = False\n\n\nif initCheck == True and openStudioIsReady == True and _runIt > 0:\n    if len(_osmFilePath) == 1:\n        fileCheck = checkTheInputs(_osmFilePath[0], _epwFileAddress)\n        if fileCheck != -1:\n            result = main(_epwFileAddress, _osmFilePath[0], _runIt, openStudioLibFolder)\n    else:\n        result = main_parallel(_epwFileAddress, _osmFilePath, _runIt, parallel_, openStudioLibFolder)\n    \n    if result != -1:\n        studyFolder, idfFileAddress, resultFileAddress, eioFileAddress, rddFileAddress = result\n",
  "language": "python",
  "imports": [
    "scriptcontext"
  ],
  "has_docstring": true
}