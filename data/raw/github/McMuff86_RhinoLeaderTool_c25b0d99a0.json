{
  "source_url": "https://github.com/McMuff86/RhinoLeaderTool/blob/880966d9ae5c50786ba91882e3ffffcddcc64e1d/export_ui.py",
  "repo": "McMuff86/RhinoLeaderTool",
  "repo_stars": 0,
  "repo_description": null,
  "license": "unknown",
  "filepath": "export_ui.py",
  "instruction": "UI helpers for export dialog and preview Note: kept minimal; main logic still resides in write_leaders_to_file.py",
  "code": "# UI helpers for export dialog and preview\n# Note: kept minimal; main logic still resides in write_leaders_to_file.py\n\ndef group_radio_buttons(forms, drawing):\n    rb_desktop = forms.RadioButton(); rb_desktop.Text = \"Desktop (Standardpfad)\"; rb_desktop.Checked = True\n    try:\n        rb_doc = forms.RadioButton(rb_desktop)\n    except Exception:\n        rb_doc = forms.RadioButton()\n        try:\n            rb_doc.Group = rb_desktop\n        except Exception:\n            pass\n    rb_doc.Text = \"Ordner der 3dm-Datei\"\n    return rb_desktop, rb_doc\n\ndef show_preview_dialog(cfg, leaders, final_keys):\n    print(\"[Preview] ========================================\")\n    print(\"[Preview] show_preview_dialog() called\")\n    print(\"[Preview] Number of leaders:\", len(leaders) if leaders else 0)\n    print(\"[Preview] Number of keys:\", len(final_keys) if final_keys else 0)\n    print(\"[Preview] ========================================\")\n    \n    try:\n        import rhinoscriptsyntax as rs\n        import scriptcontext as sc\n        import Rhino\n        import Eto.Forms as forms\n        import Eto.Drawing as drawing\n        from rhino_sync import write_usertext_ui as _write_usertext_ui\n        print(\"[Preview] All imports successful\")\n    except Exception as e:\n        try:\n            print(\"[Preview] UI imports failed:\", e)\n        except Exception:\n            pass\n        return True\n\n    try:\n        # Debug helper: write to Rhino StatusBar and console/print as fallback\n        def _dbg(*parts):\n            msg = \" \".join([str(p) for p in parts])\n            try:\n                Rhino.UI.StatusBar.SetText(msg)\n            except Exception:\n                pass\n            try:\n                Rhino.RhinoApp.WriteLine(msg)\n            except Exception:\n                try:\n                    print(msg)\n                except Exception:\n                    pass\n\n        dialog = forms.Dialog()\n        dialog.Title = \"Vorschau – Export\"\n        \n        try:\n            # Larger dialog to accommodate content\n            dialog.ClientSize = drawing.Size(1400, 700)\n            print(\"[Preview] Set dialog ClientSize to 1400x700\")\n        except Exception as ex:\n            print(\"[Preview] Failed to set ClientSize:\", ex)\n        try:\n            dialog.MinimumSize = drawing.Size(900, 600)\n            print(\"[Preview] Set dialog MinimumSize to 900x600\")\n        except Exception as ex:\n            print(\"[Preview] Failed to set MinimumSize:\", ex)\n        try:\n            dialog.Resizable = True\n        except Exception:\n            pass\n\n        # CRITICAL: Create handler_refs at function scope to prevent GC\n        handler_refs = []\n        \n        header_cols = [\"text\", \"dimstyle\"] + list(final_keys)\n        # Daten vorbereiten (Liste von Dicts)\n        rows = []\n        guid_to_row = {}\n        guid_to_leader = {}\n        pending_changes = {}\n        def add_pending(guid_text, key, value):\n            try:\n                if not guid_text or key in (\"text\", \"dimstyle\", \"LeaderGUID\"):\n                    return\n                if guid_text not in pending_changes:\n                    pending_changes[guid_text] = {}\n                pending_changes[guid_text][key] = \"\" if value is None else str(value)\n                try:\n                    if pending_count_lbl is not None:\n                        total = sum(len(v) for v in pending_changes.values())\n                        pending_count_lbl.Text = \"Änderungen: {}\".format(total)\n                except Exception:\n                    pass\n            except Exception:\n                pass\n        try:\n            for it in leaders:\n                try:\n                    gtxt = None\n                    try:\n                        gtxt = it.get(\"user\", {}).get(\"LeaderGUID\")\n                    except Exception:\n                        gtxt = None\n                    if gtxt:\n                        guid_to_leader[str(gtxt)] = it\n                except Exception:\n                    pass\n        except Exception:\n            pass\n        for item in leaders:\n            r = {\"text\": item.get(\"text\", \"\"), \"dimstyle\": item.get(\"dimstyle\", \"\")}\n            user = item.get(\"user\") or {}\n            for k in final_keys:\n                try:\n                    r[k] = \"\" if k not in user else (\"\" if user.get(k) is None else str(user.get(k)))\n                except Exception:\n                    r[k] = \"\"\n            try:\n                guid_val = user.get(\"LeaderGUID\")\n            except Exception:\n                guid_val = None\n            # persist guid under two keys: visible map key and internal helper\n            if guid_val is not None:\n                r[\"LeaderGUID\"] = str(guid_val)\n            r[\"_guid\"] = None if guid_val is None else str(guid_val)\n            rows.append(r)\n            if r.get(\"_guid\"):\n                guid_to_row[r.get(\"_guid\")] = r\n\n        # Suchfeld für Tabellenansicht\n        search_lbl = forms.Label(); search_lbl.Text = \"Suche:\"\n        search_tb = forms.TextBox()\n        try:\n            search_tb.Size = drawing.Size(320, -1)\n        except Exception:\n            pass\n\n        # Tabellenansicht\n        grid = None\n        try:\n            grid = forms.TreeGridView()\n            grid.ShowHeader = True\n            grid.AllowMultipleSelection = False\n            # Height will be controlled by Scrollable container\n            try:\n                grid.RowHeight = 22\n            except Exception:\n                pass\n            row_data = list(rows)\n            row_view_ref = {\"data\": row_data}\n            col_keys = [\"text\", \"dimstyle\"]\n            def add_col(idx, name, width=None):\n                col = forms.GridColumn()\n                col.HeaderText = name\n                col.DataCell = forms.TextBoxCell(idx)\n                \n                # Set explicit width (CRITICAL for horizontal scrollbar)\n                try:\n                    if width is not None and width > 0:\n                        col.Width = width\n                    else:\n                        col.Width = 120  # Default width\n                    print(\"[Preview] Column '{}' width set to: {}\".format(name, col.Width if width else 120))\n                except Exception as ex:\n                    print(\"[Preview] Failed to set column width for '{}': {}\".format(name, ex))\n                \n                # Disable auto-sizing (CRITICAL - prevents auto-fit to container)\n                try:\n                    col.AutoSize = False\n                    print(\"[Preview] Column '{}' AutoSize disabled\".format(name))\n                except Exception as ex:\n                    print(\"[Preview] AutoSize not available for column '{}'\".format(name))\n                \n                # Allow manual resizing\n                try:\n                    col.Resizable = True\n                except Exception:\n                    pass\n                \n                # Set editability\n                try:\n                    col.Editable = (name not in (\"text\", \"dimstyle\", \"LeaderGUID\"))\n                except Exception:\n                    pass\n                \n                # Enable sorting\n                try:\n                    col.Sortable = True\n                except Exception:\n                    pass\n                \n                grid.Columns.Add(col)\n                return col\n            add_col(0, \"text\", 260)\n            add_col(1, \"dimstyle\", 180)\n            max_cols = 40\n            for i, k in enumerate(final_keys):\n                if i >= max_cols:\n                    break\n                # Width is now set by default in add_col function\n                add_col(i + 2, k)\n                col_keys.append(k)\n            if \"LeaderGUID\" not in col_keys:\n                col_keys.append(\"LeaderGUID\")\n                try:\n                    _guid_col = add_col(len(col_keys) - 1, \"LeaderGUID\")\n                    try:\n                        _guid_col.Visible = False\n                    except Exception:\n                        try:\n                            _guid_col.Width = 0\n                        except Exception:\n                            pass\n                except Exception:\n                    pass\n\n            def build_store(data_rows):\n                try:\n                    items = forms.TreeGridItemCollection()\n                except Exception:\n                    items = None\n                if items is None:\n                    class _SimpleStore(list): pass\n                    items = _SimpleStore()\n                for r in data_rows:\n                    try:\n                        vals = [\"\" if r.get(k) is None else str(r.get(k)) for k in col_keys]\n                    except Exception:\n                        vals = [\"\" for _ in col_keys]\n                    try:\n                        it = forms.TreeGridItem(vals)\n                    except Exception:\n                        it = forms.TreeGridItem(); it.Values = vals\n                    try:\n                        items.Add(it)\n                    except Exception:\n                        items.append(it)\n                return items\n\n            sort_state = {\"key\": None, \"desc\": False}\n            def on_header_click(sender, e):\n                try:\n                    col_index = -1\n                    try:\n                        for i in range(len(grid.Columns)):\n                            if grid.Columns[i] == e.Column:\n                                col_index = i; break\n                    except Exception:\n                        col_index = -1\n                    if col_index < 0 or col_index >= len(col_keys):\n                        return\n                    key = col_keys[col_index]\n                    if sort_state.get(\"key\") == key:\n                        sort_state[\"desc\"] = not bool(sort_state.get(\"desc\", False))\n                    else:\n                        sort_state[\"key\"] = key; sort_state[\"desc\"] = False\n                    data = list(row_view_ref.get(\"data\") or [])\n                    def make_sort_tuple(val):\n                        try:\n                            if val is None:\n                                return (2, \"\")\n                            s = str(val).strip()\n                            try:\n                                return (0, float(s.replace(\",\", \".\")))\n                            except Exception:\n                                return (1, s.lower())\n                        except Exception:\n                            return (2, \"\")\n                    try:\n                        data.sort(key=lambda r: make_sort_tuple(r.get(key)), reverse=bool(sort_state[\"desc\"]))\n                    except Exception:\n                        pass\n                    row_view_ref[\"data\"] = data\n                    grid.DataStore = build_store(data)\n                except Exception:\n                    pass\n            # Store handler to prevent GC\n            handler_refs.append(on_header_click)\n            wired = False\n            try:\n                grid.ColumnHeaderClick += on_header_click; wired = True\n            except Exception:\n                wired = False\n            if not wired:\n                try:\n                    for c in grid.Columns:\n                        try:\n                            c.HeaderClick += on_header_click; wired = True\n                        except Exception:\n                            pass\n                except Exception:\n                    pass\n\n            def update_change_counter():\n                try:\n                    try:\n                        guid_idx = col_keys.index(\"LeaderGUID\")\n                    except Exception:\n                        guid_idx = -1\n                    if guid_idx < 0:\n                        return\n                    try:\n                        datastore = grid.DataStore\n                    except Exception:\n                        datastore = None\n                    if datastore is None:\n                        return\n                    changes = 0\n                    for item in datastore:\n                        try:\n                            vals = item.Values\n                        except Exception:\n                            vals = None\n                        if vals is None or guid_idx >= len(vals):\n                            continue\n                        guid_text = vals[guid_idx]\n                        if not guid_text:\n                            try:\n                                t_idx = col_keys.index(\"text\")\n                            except Exception:\n                                t_idx = -1\n                            if t_idx >= 0 and t_idx < len(vals):\n                                row_txt = vals[t_idx]\n                                if row_txt:\n                                    try:\n                                        for r in (row_view_ref.get(\"data\") or []):\n                                            if r.get(\"text\") == row_txt and r.get(\"_guid\"):\n                                                guid_text = r.get(\"_guid\"); break\n                                    except Exception:\n                                        pass\n                        base_row = guid_to_row.get(guid_text)\n                        if not base_row:\n                            continue\n                        for idx, key in enumerate(col_keys):\n                            if key in (\"text\", \"dimstyle\", \"LeaderGUID\"):\n                                continue\n                            new_val = vals[idx] if idx < len(vals) else \"\"\n                            old_val = base_row.get(key, \"\")\n                            if str(new_val) != str(old_val):\n                                changes += 1\n                    try:\n                        pending_count_lbl.Text = \"Änderungen: {}\".format(changes)\n                    except Exception:\n                        pass\n                except Exception:\n                    pass\n\n            def on_cell_editing(sender, e):\n                try:\n                    col_index = -1\n                    try:\n                        for i in range(len(grid.Columns)):\n                            if grid.Columns[i] == e.Column:\n                                col_index = i; break\n                    except Exception:\n                        col_index = -1\n                    if col_index < 0 or col_index >= len(col_keys):\n                        return\n                    key = col_keys[col_index]\n                    if key in (\"text\", \"dimstyle\", \"LeaderGUID\"):\n                        try:\n                            e.Cancel = True\n                        except Exception:\n                            pass\n                except Exception:\n                    pass\n            # Store handler to prevent GC\n            handler_refs.append(on_cell_editing)\n            try:\n                grid.CellEditing += on_cell_editing\n            except Exception:\n                pass\n\n            def on_cell_edited(sender, e):\n                try:\n                    col_index = -1\n                    try:\n                        for i in range(len(grid.Columns)):\n                            if grid.Columns[i] == e.Column:\n                                col_index = i; break\n                    except Exception:\n                        col_index = -1\n                    if col_index < 0 or col_index >= len(col_keys):\n                        return\n                    key = col_keys[col_index]\n                    if key in (\"text\", \"dimstyle\", \"LeaderGUID\"):\n                        return\n                    vals = None\n                    try:\n                        vals = e.Item.Values\n                    except Exception:\n                        vals = None\n                    if vals is None:\n                        return\n                    new_val = None\n                    if col_index < len(vals):\n                        new_val = vals[col_index]\n                    guid_text = None\n                    try:\n                        gidx = col_keys.index(\"LeaderGUID\")\n                        if gidx < len(vals):\n                            guid_text = vals[gidx]\n                    except Exception:\n                        guid_text = None\n                    if not guid_text:\n                        try:\n                            t_idx = col_keys.index(\"text\")\n                        except Exception:\n                            t_idx = -1\n                        if t_idx >= 0 and t_idx < len(vals):\n                            row_txt = vals[t_idx]\n                            if row_txt:\n                                for r in (row_view_ref.get(\"data\") or []):\n                                    if r.get(\"text\") == row_txt and r.get(\"_guid\"):\n                                        guid_text = r.get(\"_guid\"); break\n                    if not guid_text:\n                        return\n                    try:\n                        import System\n                        obj_id = System.Guid(guid_text)\n                    except Exception:\n                        obj_id = None\n                    if obj_id is not None:\n                        try:\n                            _write_usertext_ui(obj_id, key, new_val)\n                        except Exception:\n                            pass\n                    add_pending(guid_text, key, new_val)\n                    try:\n                        e.Item.Values = vals\n                    except Exception:\n                        pass\n                    try:\n                        update_change_counter()\n                    except Exception:\n                        pass\n                except Exception:\n                    pass\n            # Store handler to prevent GC\n            handler_refs.append(on_cell_edited)\n            try:\n                grid.CellEdited += on_cell_edited\n            except Exception:\n                pass\n\n            def on_cell_double(sender, e):\n                try:\n                    r = e.Row; col = e.Column\n                    if r is None or col is None:\n                        return\n                    col_index = -1\n                    try:\n                        for i in range(len(grid.Columns)):\n                            if grid.Columns[i] == col:\n                                col_index = i; break\n                    except Exception:\n                        col_index = -1\n                    if col_index < 0 or col_index >= len(col_keys):\n                        return\n                    key = col_keys[col_index]\n                    if key in (\"text\", \"dimstyle\", \"LeaderGUID\"):\n                        return\n                    item = e.Item\n                    if item is None:\n                        return\n                    vals = None\n                    try:\n                        vals = item.Values\n                    except Exception:\n                        vals = None\n                    if vals is None:\n                        return\n                    # simple inline editor\n                    try:\n                        dlg = forms.Dialog(); dlg.Title = \"Wert bearbeiten\"\n                        lay = forms.DynamicLayout(); lay.Padding = drawing.Padding(10); lay.Spacing = drawing.Size(6,6)\n                        tb = forms.TextBox(); tb.Text = vals[col_index] if col_index < len(vals) else \"\"\n                        lay.AddRow(tb)\n                        okb = forms.Button(); okb.Text = \"OK\"\n                        cb = forms.Button(); cb.Text = \"Abbrechen\"\n                        def _ok(s,ev): dlg.Tag = tb.Text; dlg.Close()\n                        def _cb(s,ev): dlg.Tag = None; dlg.Close()\n                        okb.Click += _ok; cb.Click += _cb\n                        lay.AddSeparateRow(None, okb, cb)\n                        dlg.Content = lay; dlg.Tag = None\n                        dlg.ShowModal()\n                        new_val = dlg.Tag\n                    except Exception:\n                        new_val = None\n                    if new_val is None:\n                        return\n                    try:\n                        if col_index < len(vals):\n                            vals[col_index] = new_val\n                        else:\n                            return\n                    except Exception:\n                        pass\n                    try:\n                        e.Item.Values = vals\n                    except Exception:\n                        pass\n                    guid_text = None\n                    try:\n                        gidx = col_keys.index(\"LeaderGUID\")\n                        if gidx < len(vals):\n                            guid_text = vals[gidx]\n                    except Exception:\n                        guid_text = None\n                    if not guid_text:\n                        try:\n                            t_idx = col_keys.index(\"text\")\n                            row_txt = vals[t_idx] if t_idx < len(vals) else None\n                            if row_txt:\n                                for r in (row_view_ref.get(\"data\") or []):\n                                    if r.get(\"text\") == row_txt and r.get(\"_guid\"):\n                                        guid_text = r.get(\"_guid\"); break\n                        except Exception:\n                            pass\n                    if guid_text:\n                        add_pending(guid_text, key, new_val)\n                        update_change_counter()\n                except Exception:\n                    pass\n            # Store handler to prevent GC\n            handler_refs.append(on_cell_double)\n\n            def apply_filter_grid():\n                try:\n                    s = (search_tb.Text or \"\").strip().lower()\n                    if not s:\n                        row_view_ref[\"data\"] = row_data\n                        grid.DataStore = build_store(row_view_ref[\"data\"]) ; return\n                    filtered_rows = []\n                    for r in row_data:\n                        try:\n                            joined = \" \".join([str(v) for v in r.values() if v is not None]).lower()\n                            if s in joined:\n                                filtered_rows.append(r)\n                        except Exception:\n                            pass\n                    row_view_ref[\"data\"] = filtered_rows\n                    grid.DataStore = build_store(filtered_rows)\n                except Exception:\n                    row_view_ref[\"data\"] = row_data\n                    grid.DataStore = build_store(row_view_ref[\"data\"])        \n            # Wire search handler\n            def _on_search_changed(s, e):\n                apply_filter_grid()\n            handler_refs.append(_on_search_changed)\n            search_tb.TextChanged += _on_search_changed\n            row_view_ref[\"data\"] = row_data\n            grid.DataStore = build_store(row_view_ref[\"data\"])\n\n            # Grid is ready, will be added to main layout later\n        except Exception as grid_ex:\n            try:\n                print(\"[Preview] Tabellenansicht deaktiviert:\", grid_ex)\n            except Exception:\n                pass\n\n        # BUILD MAIN LAYOUT using TableLayout for precise control\n        print(\"[Preview] ===== Starting layout construction =====\")\n        count_lbl = forms.Label()\n        try:\n            count_lbl.Text = \"{} Leader in der Vorschau\".format(len(leaders))\n            print(\"[Preview] Count label created:\", count_lbl.Text)\n        except Exception as ex:\n            count_lbl.Text = \"Leader in der Vorschau\"\n            print(\"[Preview] Failed to set count label text:\", ex)\n        \n        # Configure grid for scrolling (TreeGridView has built-in scroll support)\n        if grid is not None:\n            try:\n                # Don't set fixed width - let TreeGridView handle its own scrolling\n                # Just ensure it has enough height\n                try:\n                    grid.Height = 450  # Fixed height to enable vertical scrollbar\n                    print(\"[Preview] Set grid height to 450\")\n                except Exception as ex:\n                    print(\"[Preview] Failed to set grid height:\", ex)\n            except Exception as ex:\n                print(\"[Preview] Failed to configure grid:\", ex)\n        else:\n            print(\"[Preview] WARNING: Grid is None!\")\n        \n        # Create main layout with TableLayout for better control\n        try:\n            print(\"[Preview] Creating TableLayout...\")\n            main_table = forms.TableLayout()\n            main_table.Padding = drawing.Padding(10)\n            main_table.Spacing = drawing.Size(5, 5)\n            print(\"[Preview] TableLayout created successfully\")\n        except Exception as ex:\n            print(\"[Preview] CRITICAL: Failed to create TableLayout:\", ex)\n            import traceback\n            traceback.print_exc()\n            raise\n        \n        # Row 0: Count label\n        try:\n            print(\"[Preview] Adding count label row...\")\n            # TableRow needs TableCell, not raw controls!\n            main_table.Rows.Add(forms.TableRow(forms.TableCell(count_lbl, scaleWidth=True)))\n            print(\"[Preview] Count label row added\")\n        except Exception as ex:\n            print(\"[Preview] ERROR adding count label:\", ex)\n            import traceback\n            traceback.print_exc()\n        \n        # Row 1: Search box\n        try:\n            print(\"[Preview] Creating search box row...\")\n            # Create horizontal layout for search label + textbox\n            search_row = forms.TableLayout()\n            search_row.Spacing = drawing.Size(5, 5)\n            search_row.Rows.Add(forms.TableRow(\n                forms.TableCell(search_lbl),\n                forms.TableCell(search_tb, scaleWidth=True)\n            ))\n            main_table.Rows.Add(forms.TableRow(forms.TableCell(search_row, scaleWidth=True)))\n            print(\"[Preview] Search box added to layout\")\n        except Exception as ex:\n            print(\"[Preview] ERROR adding search box:\", ex)\n            import traceback\n            traceback.print_exc()\n        \n        # Row 2: Grid (scalable)\n        if grid is not None:\n            try:\n                print(\"[Preview] Adding grid row...\")\n                # Grid needs to be in a TableCell, and the row should scale vertically\n                grid_cell = forms.TableCell(grid, scaleWidth=True)\n                grid_row = forms.TableRow(grid_cell)\n                grid_row.ScaleHeight = True  # Allow this row to expand vertically\n                main_table.Rows.Add(grid_row)\n                print(\"[Preview] Grid added to layout\")\n            except Exception as ex:\n                print(\"[Preview] ERROR adding grid:\", ex)\n                import traceback\n                traceback.print_exc()\n        else:\n            print(\"[Preview] Skipping grid row (grid is None)\")\n\n        btn_export = forms.Button(); btn_export.Text = \"Exportieren\"\n        btn_cancel = forms.Button(); btn_cancel.Text = \"Abbrechen\"\n        btn_show = forms.Button(); btn_show.Text = \"Element anzeigen\"\n        btn_commit = forms.Button(); btn_commit.Text = \"Commit All\"\n        pending_count_lbl = forms.Label(); pending_count_lbl.Text = \"Änderungen: 0\"\n        # Ensure buttons are enabled/visible\n        try:\n            btn_export.Enabled = True; btn_export.Visible = True\n            btn_cancel.Enabled = True; btn_cancel.Visible = True\n            btn_show.Enabled = True; btn_show.Visible = True\n            btn_commit.Enabled = True; btn_commit.Visible = True\n        except Exception:\n            pass\n\n        # Close handlers - set result BEFORE closing (Eto doesn't accept Close() argument)\n        def on_export(sender, e):\n            try:\n                _dbg(\"[Preview] Export clicked\")\n                dialog.Tag = True  # Set return value\n                dialog.Close()     # Close without argument\n            except Exception as ex:\n                try:\n                    print(\"[Preview] Error closing dialog:\", ex)\n                except Exception:\n                    pass\n        \n        def on_cancel(sender, e):\n            try:\n                _dbg(\"[Preview] Cancel clicked\")\n                dialog.Tag = False  # Set return value\n                dialog.Close()      # Close without argument\n            except Exception as ex:\n                try:\n                    print(\"[Preview] Error closing dialog:\", ex)\n                except Exception:\n                    pass\n\n        def on_show(sender, e):\n            try:\n                _dbg(\"[Preview] Show clicked\")\n                sel = None\n                try:\n                    sel = grid.SelectedItem\n                except Exception:\n                    sel = None\n                if sel is None:\n                    return\n                vals = None\n                try:\n                    vals = sel.Values\n                except Exception:\n                    vals = None\n                guid_text = None\n                if vals is not None:\n                    try:\n                        gidx = col_keys.index(\"LeaderGUID\")\n                        if gidx < len(vals):\n                            guid_text = vals[gidx]\n                    except Exception:\n                        guid_text = None\n                if not guid_text:\n                    try:\n                        tidx = col_keys.index(\"text\")\n                        txt = vals[tidx] if (vals and tidx < len(vals)) else None\n                        if txt:\n                            for r in (row_view_ref.get(\"data\") or []):\n                                if r.get(\"text\") == txt and r.get(\"_guid\"):\n                                    guid_text = r.get(\"_guid\"); break\n                    except Exception:\n                        pass\n                if not guid_text:\n                    return\n                try:\n                    import System\n                    guid_obj = System.Guid(guid_text)\n                except Exception:\n                    guid_obj = None\n                if guid_obj:\n                    try:\n                        rs.UnselectAllObjects()\n                    except Exception:\n                        pass\n                    try:\n                        rs.SelectObject(guid_obj); rs.ZoomSelected()\n                    except Exception:\n                        pass\n            except Exception:\n                pass\n        \n        # Wire button handlers directly (store in handler_refs to prevent GC)\n        handler_refs.extend([on_export, on_cancel, on_show])\n        try:\n            btn_export.Click += on_export\n            print(\"[Preview] Export button wired\")\n        except Exception as ex:\n            print(\"[Preview] Error wiring export button:\", ex)\n        \n        try:\n            btn_cancel.Click += on_cancel\n            print(\"[Preview] Cancel button wired\")\n        except Exception as ex:\n            print(\"[Preview] Error wiring cancel button:\", ex)\n        \n        try:\n            btn_show.Click += on_show\n            print(\"[Preview] Show button wired\")\n        except Exception as ex:\n            print(\"[Preview] Error wiring show button:\", ex)\n\n        def on_commit(sender, e):\n            try:\n                _dbg(\"[Preview] Commit clicked\")\n                total = 0\n                # Commit changes from the visible grid back to Rhino user text\n                try:\n                    guid_idx = col_keys.index(\"LeaderGUID\")\n                    print(\"[Commit Debug] LeaderGUID index:\", guid_idx)\n                except Exception as ex:\n                    guid_idx = -1\n                    print(\"[Commit Debug] LeaderGUID not found in col_keys:\", ex)\n                try:\n                    ds = grid.DataStore\n                    print(\"[Commit Debug] DataStore retrieved:\", ds is not None)\n                except Exception as ex:\n                    ds = None\n                    print(\"[Commit Debug] Failed to get DataStore:\", ex)\n                if ds is not None and guid_idx >= 0:\n                    print(\"[Commit Debug] Starting to process rows...\")\n                    try:\n                        import System\n                        # TreeGridStore is not directly iterable in Python - use Count and indexer\n                        row_count = 0\n                        try:\n                            total_rows = ds.Count\n                            print(\"[Commit Debug] DataStore has {} rows\".format(total_rows))\n                        except Exception:\n                            # Fallback: try to get count another way or iterate differently\n                            total_rows = 0\n                            for item in ds:\n                                total_rows += 1\n                        \n                        for i in range(total_rows):\n                            row_count = i + 1\n                            try:\n                                it = ds[i]\n                            except Exception as ex:\n                                print(\"[Commit Debug] Failed to access row {}: {}\".format(i, ex))\n                                continue\n                            try:\n                                vals = it.Values\n                            except Exception as ex:\n                                vals = None\n                                print(\"[Commit Debug] Row {}: Failed to get Values:\".format(row_count), ex)\n                            if vals is None or guid_idx >= len(vals):\n                                print(\"[Commit Debug] Row {}: Skipping (vals={}, guid_idx={}, len={})\".format(\n                                    row_count, vals is not None, guid_idx, len(vals) if vals else 0))\n                                continue\n                            gtxt = vals[guid_idx]\n                            print(\"[Commit Debug] Row {}: GUID={}\".format(row_count, gtxt))\n                            if not gtxt:\n                                # Fallback via text value to map back to guid\n                                try:\n                                    t_idx = col_keys.index(\"text\")\n                                except Exception:\n                                    t_idx = -1\n                                if t_idx >= 0 and t_idx < len(vals):\n                                    row_txt = vals[t_idx]\n                                    if row_txt:\n                                        try:\n                                            for r in (row_view_ref.get(\"data\") or []):\n                                                if r.get(\"text\") == row_txt and r.get(\"_guid\"):\n                                                    gtxt = r.get(\"_guid\"); break\n                                        except Exception:\n                                            pass\n                            if not gtxt:\n                                continue\n                            try:\n                                obj_id = System.Guid(gtxt)\n                            except Exception:\n                                obj_id = None\n                            if obj_id is None:\n                                continue\n                            base_row = guid_to_row.get(gtxt)\n                            print(\"[Commit Debug] Row {}: base_row found: {}\".format(row_count, base_row is not None))\n                            changes_in_row = 0\n                            for c_index, key in enumerate(col_keys):\n                                if key in (\"text\", \"dimstyle\", \"LeaderGUID\"):\n                                    continue\n                                new_val = vals[c_index] if c_index < len(vals) else \"\"\n                                old_val = \"\"\n                                try:\n                                    if base_row is not None:\n                                        old_val = base_row.get(key, \"\")\n                                except Exception:\n                                    old_val = \"\"\n                                if str(new_val) != str(old_val):\n                                    print(\"[Commit Debug] Row {}: Change detected in '{}': '{}' -> '{}'\".format(\n                                        row_count, key, old_val, new_val))\n                                    try:\n                                        write_result = _write_usertext_ui(obj_id, key, new_val)\n                                        print(\"[Commit Debug] Row {}: _write_usertext_ui('{}', '{}') returned: {}\".format(\n                                            row_count, key, new_val, write_result))\n                                        if write_result:\n                                            total += 1\n                                            changes_in_row += 1\n                                            if base_row is not None:\n                                                base_row[key] = \"\" if new_val is None else str(new_val)\n                                            print(\"[Commit Debug] Row {}: Successfully wrote '{}' = '{}'\".format(\n                                                row_count, key, new_val))\n                                        else:\n                                            print(\"[Commit Debug] Row {}: ❌ Write FAILED for key '{}' (returned False)\".format(row_count, key))\n                                    except Exception as ex:\n                                        print(\"[Commit Debug] Row {}: ❌ Exception writing '{}': {}\".format(row_count, key, ex))\n                            if changes_in_row == 0:\n                                print(\"[Commit Debug] Row {}: No changes detected\".format(row_count))\n                    except Exception as ex:\n                        print(\"[Commit Debug] Exception in main loop:\", ex)\n                else:\n                    print(\"[Commit Debug] Skipped grid processing: ds={}, guid_idx={}\".format(ds is not None, guid_idx))\n                # also apply any pending changes captured from inline editors\n                print(\"[Commit Debug] Pending changes:\", len(pending_changes))\n                for gtxt, kv in list(pending_changes.items()):\n                    print(\"[Commit Debug] Pending change for GUID {}: {}\".format(gtxt, kv))\n                    try:\n                        import System\n                        obj_id = System.Guid(gtxt)\n                    except Exception:\n                        obj_id = None\n                    if obj_id is None:\n                        continue\n                    for k, v in kv.items():\n                        try:\n                            if _write_usertext_ui(obj_id, k, v):\n                                total += 1\n                                print(\"[Commit Debug] Pending: Wrote {} = {}\".format(k, v))\n                        except Exception as ex:\n                            print(\"[Commit Debug] Pending: Failed to write {} = {}: {}\".format(k, v, ex))\n                pending_changes.clear()\n                try:\n                    pending_count_lbl.Text = \"Änderungen: 0\"\n                except Exception:\n                    pass\n                try:\n                    sc.doc.Views.Redraw()\n                except Exception:\n                    pass\n                try:\n                    print(\"[Preview] Commit: {} Werte in UserText geschrieben.\".format(total))\n                except Exception:\n                    pass\n            except Exception:\n                pass\n        \n        # Wire commit button handler\n        handler_refs.append(on_commit)\n        try:\n            btn_commit.Click += on_commit\n            print(\"[Preview] Commit button wired\")\n        except Exception as ex:\n            print(\"[Preview] Error wiring commit button:\", ex)\n\n        # Create Commands for toolbar (without overriding Click handlers)\n        cmd_export = None\n        cmd_cancel = None\n        cmd_commit = None\n        cmd_show = None\n        try:\n            cmd_export = forms.Command(); cmd_export.MenuText = \"Exportieren\"; cmd_export.ToolBarText = \"Exportieren\"\n            _cmd_export_handler = lambda s, e: on_export(s, e)\n            cmd_export.Executed += _cmd_export_handler\n            handler_refs.append(_cmd_export_handler)\n        except Exception:\n            pass\n        try:\n            cmd_cancel = forms.Command(); cmd_cancel.MenuText = \"Abbrechen\"; cmd_cancel.ToolBarText = \"Abbrechen\"\n            _cmd_cancel_handler = lambda s, e: on_cancel(s, e)\n            cmd_cancel.Executed += _cmd_cancel_handler\n            handler_refs.append(_cmd_cancel_handler)\n        except Exception:\n            pass\n        try:\n            cmd_commit = forms.Command(); cmd_commit.MenuText = \"Commit All\"; cmd_commit.ToolBarText = \"Commit All\"\n            _cmd_commit_handler = lambda s, e: on_commit(s, e)\n            cmd_commit.Executed += _cmd_commit_handler\n            handler_refs.append(_cmd_commit_handler)\n        except Exception:\n            pass\n        try:\n            cmd_show = forms.Command(); cmd_show.MenuText = \"Element anzeigen\"; cmd_show.ToolBarText = \"Anzeigen\"\n            _cmd_show_handler = lambda s, e: on_show(s, e)\n            cmd_show.Executed += _cmd_show_handler\n            handler_refs.append(_cmd_show_handler)\n        except Exception:\n            pass\n        # Add toolbar (optional alternative trigger path)\n        try:\n            tb = forms.ToolBar()\n            if cmd_export: tb.Items.Add(cmd_export)\n            if cmd_commit: tb.Items.Add(cmd_commit)\n            if cmd_show: tb.Items.Add(cmd_show)\n            if cmd_cancel: tb.Items.Add(cmd_cancel)\n            dialog.ToolBar = tb\n        except Exception:\n            pass\n\n        _dbg(\"[Preview] Buttons wired: export=\", isinstance(btn_export, forms.Button), \n             \", cancel=\", isinstance(btn_cancel, forms.Button), \n             \", show=\", isinstance(btn_show, forms.Button), \n             \", commit=\", isinstance(btn_commit, forms.Button))\n\n        # Attach handler_refs to dialog to ensure they survive GC\n        try:\n            dialog._handler_refs = handler_refs\n        except Exception:\n            pass\n\n        # Row 3: Buttons\n        try:\n            print(\"[Preview] Creating button row...\")\n            button_row = forms.TableLayout()\n            button_row.Spacing = drawing.Size(5, 5)\n            # All controls must be wrapped in TableCell!\n            button_row.Rows.Add(forms.TableRow(\n                forms.TableCell(None, scaleWidth=True),  # Stretcher to push buttons right\n                forms.TableCell(pending_count_lbl),\n                forms.TableCell(btn_show),\n                forms.TableCell(btn_commit),\n                forms.TableCell(btn_export),\n                forms.TableCell(btn_cancel)\n            ))\n            main_table.Rows.Add(forms.TableRow(forms.TableCell(button_row, scaleWidth=True)))\n            print(\"[Preview] Buttons added to layout\")\n        except Exception as ex:\n            print(\"[Preview] ERROR adding buttons:\", ex)\n            import traceback\n            traceback.print_exc()\n\n        # designate default/abort buttons to improve behavior across Rhino/Eto versions\n        try:\n            dialog.DefaultButton = btn_export\n            print(\"[Preview] Set DefaultButton\")\n        except Exception as ex:\n            print(\"[Preview] Failed to set DefaultButton:\", ex)\n        try:\n            dialog.AbortButton = btn_cancel\n            print(\"[Preview] Set AbortButton\")\n        except Exception as ex:\n            print(\"[Preview] Failed to set AbortButton:\", ex)\n\n        try:\n            print(\"[Preview] Setting dialog.Content to main_table...\")\n            dialog.Content = main_table  # Use TableLayout instead of DynamicLayout\n            dialog.Tag = False  # Initialize return value\n            print(\"[Preview] Dialog content set successfully - ready to show!\")\n        except Exception as ex:\n            print(\"[Preview] CRITICAL ERROR setting dialog.Content:\", ex)\n            import traceback\n            traceback.print_exc()\n            raise\n        # Global key bindings (Enter=Export, Escape=Abbrechen) on dialog and main widgets\n        try:\n            def _on_key_down(s, e):\n                try:\n                    k = getattr(e, 'Key', None)\n                    ks = str(k)\n                except Exception:\n                    ks = None\n                if not ks:\n                    return\n                ks_l = ks.lower()\n                try:\n                    if ks_l.endswith('enter') or ks_l.endswith('return'):\n                        on_export(s, e)\n                    elif ks_l.endswith('escape'):\n                        on_cancel(s, e)\n                except Exception:\n                    pass\n            dialog.KeyDown += _on_key_down\n            try:\n                grid.KeyDown += _on_key_down\n            except Exception:\n                pass\n            try:\n                search_tb.KeyDown += _on_key_down\n            except Exception:\n                pass\n            handler_refs.append(_on_key_down)\n        except Exception:\n            pass\n        # Show modal dialog and get return value from dialog.Tag\n        print(\"[Preview] ===== Attempting to show dialog =====\")\n        try:\n            try:\n                dialog.Owner = Rhino.UI.RhinoEtoApp.MainWindow\n                print(\"[Preview] Dialog owner set to RhinoEtoApp.MainWindow\")\n            except Exception as ex:\n                print(\"[Preview] Failed to set dialog owner:\", ex)\n            print(\"[Preview] Calling dialog.ShowModal()...\")\n            dialog.ShowModal()\n            print(\"[Preview] Dialog closed normally\")\n        except Exception as show_ex:\n            print(\"[Preview] ShowModal failed, trying alternatives:\", show_ex)\n            try:\n                print(\"[Preview] Trying ShowSemiModal...\")\n                Rhino.UI.EtoExtensions.ShowSemiModal(dialog, sc.doc, Rhino.UI.RhinoEtoApp.MainWindow)\n                print(\"[Preview] ShowSemiModal succeeded\")\n            except Exception as semi_ex:\n                print(\"[Preview] ShowSemiModal failed:\", semi_ex)\n                try:\n                    print(\"[Preview] Trying ShowModal with owner parameter...\")\n                    dialog.ShowModal(Rhino.UI.RhinoEtoApp.MainWindow)\n                    print(\"[Preview] ShowModal with owner succeeded\")\n                except Exception as modal_ex:\n                    print(\"[Preview] All dialog show methods failed:\", modal_ex)\n                    import traceback\n                    traceback.print_exc()\n                    return True\n        # Return the value set in dialog.Tag by button handlers\n        result = bool(dialog.Tag) if dialog.Tag is not None else True\n        print(\"[Preview] Dialog result:\", result)\n        return result\n    except Exception as e:\n        try:\n            print(\"[Preview] !!!!! CRITICAL ERROR beim Aufbau der Vorschau !!!!!\")\n            print(\"[Preview] Error type:\", type(e).__name__)\n            print(\"[Preview] Error message:\", str(e))\n            import traceback\n            print(\"[Preview] Full traceback:\")\n            traceback.print_exc()\n        except Exception as print_ex:\n            print(\"[Preview] Could not print error details:\", print_ex)\n        return True\n\n\n",
  "language": "python",
  "imports": [
    "Rhino",
    "rhinoscriptsyntax",
    "scriptcontext"
  ],
  "has_docstring": true
}