{
  "source_url": "https://discourse.mcneel.com/t/using-a-dependency-from-another-project/210674",
  "topic_id": 210674,
  "title": "Using a dependency from another project",
  "question": "I’m struggling to load a dll from a grasshopper plugin (from yak) inside of my Rhp.\n\n\nSetup:\n\n\nLINK_Dashboards.gha is shipped on public yak.\n\n\nOur inhouse LINK_EP.Rhp needs dashboards.\n\n\nIssue:\n\n\nIf I ship dashboards with our RHP, then the grasshopper plugin cannot load because “the dll is already loaded”.\n\n\n\nAn error occured during GHA assembly loading:\n  Path: C:\\Users\\mm1013\\AppData\\Roaming\\McNeel\\Rhinoceros\\packages\\8.0\\LINK_Dashboards\\2.5.20173.22506\\LINK_EP.Dashboards.gha\n  Exception System.IO.FileLoadException: \n  Message: Assembly with same name is already loaded\n\n\n\n\nIf I try using assemblyResolve in rhp to find the .gha file, then Rhino won’t load the dll. I can find it with my own assemblyResolve but it seems that Rhino is scanning for ContextTypes before I get to intercept the call and thus just rejects my rhp to run at all.\n\n\nSystem.IO.FileNotFoundException: Could not load file or assembly 'LINK_EP.Dashboards, Version=2.6.20368.16210, Culture=neutral, PublicKeyToken=null'. The system cannot find the file specified.\nFile name: 'LINK_EP.Dashboards, Version=2.6.20368.16210, Culture=neutral, PublicKeyToken=null'\n   at System.Reflection.RuntimeAssembly.GetExportedTypes(QCallAssembly assembly, ObjectHandleOnStack retTypes)\n   at System.Reflection.RuntimeAssembly.GetExportedTypes()\n   at Rhino.PlugIns.PlugIn.CreateFromAssembly(Assembly pluginAssembly, Boolean displayDebugInfo, Boolean useRhinoDotNet)\nFailed to load LINK_EP_LINK_RH plugin\n\n\n\n\nAlternative: I tried shipping 2 rhp files: 1 that checks and tries to load dashboards and error handling + 1 that actually uses dashboards. That was a mess, but I got to get the following messages in my console:\n\n\nDashboard Checker: Found Dashboards DLL at C:\\Users\\mm1013\\AppData\\Roaming\\McNeel\\Rhinoceros\\packages\\8.0\\Linkajou\\2.6.20367-prerelease\\Fallback\\LINK_EP.Dashboards.dll\n\nSystem.IO.FileNotFoundException: Could not load file or assembly 'LINK_EP.Dashboards, Version=2.6.20368.16210, Culture=neutral, PublicKeyToken=nul...",
  "code_blocks": [
    {
      "code": "public class LINK_RH_Plugin : Rhino.PlugIns.PlugIn\n{\n    /// <summary>\n    /// Static constructor - runs BEFORE instance constructor and BEFORE GetExportedTypes()\n    /// This ensures AssemblyResolve handler is registered early enough to catch Dashboards loading\n    /// </summary>\n    static LINK_RH_Plugin()\n    {\n        WL.Debug(LogCategories.UIRhino, \"Static constructor: Registering AssemblyResolve handler\");\n        AppDomain.CurrentDomain.AssemblyResolve += OnAssemblyResolve_Dashboards_Static;\n    }\n}\n\n\n\n /// <summary>\n /// Resolves LINK_Dashboards assembly with fallback strategy:\n /// 1. Check if already loaded (avoid duplicate loading)\n /// 2. Yak packages: Read version from manifest.txt, try LINK_Dashboards.gha then .dll\n /// 3. Local fallback: Use Fallback\\LINK_Dashboards.dll shipped with build (only if Yak doesn't exist)\n /// Note: Local DLL is in Fallback subfolder to prevent .NET auto-loading, ensuring Yak has priority\n /// </summary>\n private static Assembly OnAssemblyResolve_Dashboards_Static(object sender, ResolveEventArgs args)\n {\n     // Log every assembly resolve attempt for debugging\n     WL.Debug(LogCategories.FileIO, () => $\"AssemblyResolve triggered for: {args.Name}\");\n\n     if (args.Name.Contains(\"resources\", StringComparison.InvariantCultureIgnoreCase))\n         return null;\n     if (!args.Name.StartsWith(\"LINK_EP.Dashboards\"))\n         return null;\n\n     WL.Debug(LogCategories.FileIO, () => $\"Resolving LINK_EP.Dashboards assembly...\");\n\n     // PRIORITY 0: Check if assembly is already loaded\n     var loadedAssembly = AppDomain.CurrentDomain.GetAssemblies()\n         .FirstOrDefault(a => a.FullName.StartsWith(\"LINK_EP.Dashboards\"));\n\n     if (loadedAssembly is not null)\n     {\n         WL.Debug(LogCategories.FileIO, () => $\"LINK_Dashboards already loaded: {loadedAssembly.Location}\");\n         return loadedAssembly;\n     }\n\n     // PRIORITY 1: Try Yak packages folder\n     string yakBasePath = Path.Combine(\n         Environment.GetFolderPath(Environment.SpecialFolder.ApplicationData),\n         \"McNeel\",\n         \"Rhinoceros\",\n         \"packages\",\n         $\"{RhinoApp.ExeVersion}.0\",\n         \"LINK_Dashboards\");\n\n     if (Directory.Exists(yakBasePath))\n     {\n         WL.Debug(LogCategories.FileIO, () => $\"Searching for LINK_Dashboards in Yak packages: {yakBasePath}\");\n\n         // Try reading version from manifest.txt (Yak standard)\n         string manifestPath = Path.Combine(yakBasePath, \"manifest.txt\");\n         string version = null;\n\n         if (File.Exists(manifestPath))\n         {\n             try\n             {\n                 version = File.ReadAllText(manifestPath).Trim();\n                 WL.Debug(LogCategories.FileIO, () => $\"Read version {version} from manifest.txt\");\n             }\n             catch (Exception ex)\n             {\n                 WL.Error(LogCategories.FileIO, () => $\"Failed to read manifest.txt: {ex.Message}\");\n             }\n         }\n\n         // If manifest.txt exists and has valid version, use it\n         if (!string.IsNullOrWhiteSpace(version))\n         {\n             // Try .gha first (Grasshopper assembly extension)\n             string ghaPath = Path.Combine(yakBasePath, version, \"LINK_Dashboards.gha\");\n             if (File.Exists(ghaPath))\n             {\n                 try\n                 {\n                     WL.Debug(LogCategories.FileIO, () => $\"Loaded LINK_Dashboards from Yak package (.gha v{version}): {ghaPath}\");\n                     return Assembly.LoadFrom(ghaPath);\n                 }\n                 catch (Exception ex)\n                 {\n                     WL.Error(LogCategories.FileIO, () => $\"Failed to load {ghaPath}: {ex.Message}\");\n                 }\n             }\n\n             // Fallback to .dll in same Yak folder\n             string dllPath = Path.Combine(yakBasePath, version, \"LINK_Dashboards.dll\");\n             if (File.Exists(dllPath))\n             {\n                 try\n                 {\n                     WL.Debug(LogCategories.FileIO, () => $\"Loaded LINK_Dashboards from Yak package (.dll v{version}): {dllPath}\");\n                     return Assembly.LoadFrom(dllPath);\n                 }\n                 catch (Exception ex)\n                 {\n                     WL.Error(LogCategories.FileIO, () => $\"Failed to load {dllPath}: {ex.Message}\");\n                 }\n             }\n\n             WL.Warn(LogCategories.FileIO, () => $\"LINK_Dashboards v{version} not found in Yak version folder\");\n         }\n         else\n         {\n             // Fallback: manifest.txt doesn't exist or is empty - use highest version directory\n             WL.Debug(LogCategories.FileIO, () => $\"manifest.txt not found, scanning for highest version\");\n\n             var versionDirs = Directory.GetDirectories(yakBasePath)\n                 .Select(Path.GetFileName)\n                 .Select(v =>\n                 {\n                     bool ok = System.Version.TryParse(v, out var parsed);\n                     return new { Version = parsed, IsValid = ok, FolderName = v };\n                 })\n                 .Where(x => x.IsValid)\n                 .OrderByDescending(x => x.Version)\n                 .ToList();\n\n             foreach (var versionDir in versionDirs)\n             {\n                 // Try .gha first\n                 string ghaPath = Path.Combine(yakBasePath, versionDir.FolderName, \"LINK_Dashboards.gha\");\n                 if (File.Exists(ghaPath))\n                 {\n                     try\n                     {\n                         WL.Debug(LogCategories.FileIO, () => $\"Loaded LINK_Dashboards from Yak package (.gha v{versionDir.FolderName}): {ghaPath}\");\n                         return Assembly.LoadFrom(ghaPath);\n                     }\n                     catch (Exception ex)\n                     {\n                         WL.Error(LogCategories.FileIO, () => $\"Failed to load {ghaPath}: {ex.Message}\");\n                     }\n                 }\n\n                 // Fallback to .dll\n                 string dllPath = Path.Combine(yakBasePath, versionDir.FolderName, \"LINK_Dashboards.dll\");\n                 if (File.Exists(dllPath))\n                 {\n                     try\n                     {\n                         WL.Debug(LogCategories.FileIO, () => $\"Loaded LINK_Dashboards from Yak package (.dll v{versionDir.FolderName}): {dllPath}\");\n                         return Assembly.LoadFrom(dllPath);\n                     }\n                     catch (Exception ex)\n                     {\n                         WL.Error(LogCategories.FileIO, () => $\"Failed to load {dllPath}: {ex.Message}\");\n                     }\n                 }\n             }\n\n             WL.Warn(LogCategories.FileIO, () => $\"LINK_Dashboards not found in any Yak version folder\");\n         }\n\n         // If Yak folder exists, don't try local fallback to avoid conflicts\n         WL.Error(LogCategories.FileIO, \"LINK_Dashboards found in Yak packages but failed to load\");\n         return null;\n     }\n     else\n     {\n         WL.Debug(LogCategories.FileIO, () => $\"Yak packages folder not found: {yakBasePath}\");\n\n         // PRIORITY 2: Local fallback - LINK_EP.Dashboards.dll shipped with build (only if Yak doesn't exist)\n         // Stored in Fallback subfolder to prevent .NET auto-loading\n         string localDllPath = Path.Combine(\n             Path.GetDirectoryName(typeof(LINK_RH_Plugin).Assembly.Location),\n             \"Fallback\",\n             \"LINK_EP.Dashboards.dll\");\n\n         if (File.Exists(localDllPath))\n         {\n             try\n             {\n                 WL.Debug(LogCategories.FileIO, () => $\"Loading LINK_Dashboards from local fallback: {localDllPath}\");\n                 return Assembly.LoadFrom(localDllPath);\n             }\n             catch (Exception ex)\n             {\n                 WL.Error(LogCategories.FileIO, () => $\"Failed to load local fallback {localDllPath}: {ex.Message}\");\n             }\n         }\n         else\n         {\n             WL.Debug(LogCategories.FileIO, () => $\"Local fallback LINK_EP.Dashboards.dll not found at: {localDllPath}\");\n         }\n\n         // All attempts failed\n         WL.Error(LogCategories.FileIO, \"LINK_Dashboards could not be loaded from any location (Yak not found, local fallback failed)\");\n         return null;\n     }\n }",
      "language": "csharp",
      "author": "sonderskovmathias",
      "post_number": 1,
      "is_solution": false
    }
  ],
  "tags": [
    "boolean",
    "file-io",
    "grasshopper"
  ],
  "has_accepted_answer": true,
  "category_id": 3,
  "posts_count": 3,
  "views": 77
}