{
  "source_url": "https://github.com/Xiaohu1009/AI-architecture/blob/30e0a2f9a6394ab1a8e3fc368875fa875753ff44/AI_mcp_server/src/ai_mcp_server/core/server.py",
  "repo": "Xiaohu1009/AI-architecture",
  "repo_stars": 3,
  "repo_description": "AI MCP Server is a unified Model Context Protocol (MCP) server that integrates both Rhino and Grasshopper functionality, providing AI agents with comprehensive 3D modeling and parametric design capabilities.",
  "license": "MIT",
  "filepath": "AI_mcp_server/src/ai_mcp_server/core/server.py",
  "instruction": "Main AI MCP Server implementation",
  "code": "\"\"\"\r\nMain AI MCP Server implementation\r\n\"\"\"\r\n\r\nimport asyncio\r\nimport logging\r\nfrom typing import Dict, Any, Optional\r\nfrom contextlib import asynccontextmanager\r\n\r\nfrom mcp.server.fastmcp import FastMCP, Context\r\nfrom .config import Config\r\nfrom ..bridges.rhino_bridge import RhinoBridge\r\nfrom ..bridges.grasshopper_bridge import GrasshopperBridge\r\nfrom ..tools.unified_tools import register_unified_tools\r\nfrom ..tools.rhino_tools import register_rhino_tools\r\nfrom ..tools.grasshopper_tools import register_grasshopper_tools\r\n\r\n\r\nclass AIServer:\r\n    \"\"\"Main AI MCP Server class\"\"\"\r\n    \r\n    def __init__(self, config: Optional[Config] = None):\r\n        self.config = config or Config.from_env()\r\n        self.logger = self._setup_logging()\r\n        \r\n        # Initialize bridges\r\n        self.rhino_bridge = RhinoBridge(self.config.rhino, self.logger)\r\n        self.grasshopper_bridge = GrasshopperBridge(self.config.grasshopper, self.logger)\r\n        \r\n        # Initialize MCP server\r\n        self.mcp_server = FastMCP(\r\n            self.config.server.name,\r\n            lifespan=self._server_lifespan\r\n        )\r\n        \r\n        # Register tools\r\n        self._register_tools()\r\n        \r\n        self.logger.info(f\"AI MCP Server initialized: {self.config.server.name} v{self.config.server.version}\")\r\n    \r\n    def _setup_logging(self) -> logging.Logger:\r\n        \"\"\"Setup logging configuration\"\"\"\r\n        logging.basicConfig(\r\n            level=getattr(logging, self.config.server.log_level),\r\n            format='%(asctime)s - %(name)s - %(levelname)s - %(message)s'\r\n        )\r\n        return logging.getLogger(\"AIServer\")\r\n    \r\n    def _register_tools(self) -> None:\r\n        \"\"\"Register all MCP tools\"\"\"\r\n        # Register unified tools (smart routing)\r\n        register_unified_tools(self.mcp_server, self.rhino_bridge, self.grasshopper_bridge)\r\n        \r\n        # Register platform-specific tools\r\n        register_rhino_tools(self.mcp_server, self.rhino_bridge)\r\n        register_grasshopper_tools(self.mcp_server, self.grasshopper_bridge)\r\n        \r\n        self.logger.info(\"All MCP tools registered\")\r\n    \r\n    @asynccontextmanager\r\n    async def _server_lifespan(self, server: FastMCP) -> Dict[str, Any]:\r\n        \"\"\"Manage server startup and shutdown lifecycle\"\"\"\r\n        try:\r\n            self.logger.info(\"Starting AI MCP Server...\")\r\n            \r\n            # Initialize bridges\r\n            await self.rhino_bridge.initialize()\r\n            await self.grasshopper_bridge.initialize()\r\n            \r\n            # Check connections\r\n            rhino_status = await self.rhino_bridge.check_connection()\r\n            grasshopper_status = await self.grasshopper_bridge.check_connection()\r\n            \r\n            self.logger.info(f\"Rhino connection: {'Connected' if rhino_status else 'Disconnected'}\")\r\n            self.logger.info(f\"Grasshopper connection: {'Connected' if grasshopper_status else 'Disconnected'}\")\r\n            \r\n            if not rhino_status and not grasshopper_status:\r\n                self.logger.warning(\"Neither Rhino nor Grasshopper is connected. Some tools may not work.\")\r\n            \r\n            yield {}\r\n            \r\n        except Exception as e:\r\n            self.logger.error(f\"Error during server startup: {e}\")\r\n            raise\r\n        finally:\r\n            self.logger.info(\"Shutting down AI MCP Server...\")\r\n            await self.rhino_bridge.cleanup()\r\n            await self.grasshopper_bridge.cleanup()\r\n            self.logger.info(\"AI MCP Server shutdown complete\")\r\n    \r\n    def start(self) -> None:\r\n        \"\"\"Start the MCP server\"\"\"\r\n        try:\r\n            self.logger.info(\"Starting MCP server...\")\r\n            # Use stdio transport for MCP\r\n            self.mcp_server.run(transport=\"stdio\")\r\n        except Exception as e:\r\n            self.logger.error(f\"Error starting MCP server: {e}\")\r\n            raise\r\n    \r\n    def run(self) -> None:\r\n        \"\"\"Run the server (blocking)\"\"\"\r\n        try:\r\n            self.start()\r\n        except KeyboardInterrupt:\r\n            self.logger.info(\"Server stopped by user\")\r\n        except Exception as e:\r\n            self.logger.error(f\"Server error: {e}\")\r\n            raise\r\n    \r\n    async def get_status(self) -> Dict[str, Any]:\r\n        \"\"\"Get server status\"\"\"\r\n        rhino_status = await self.rhino_bridge.check_connection()\r\n        grasshopper_status = await self.grasshopper_bridge.check_connection()\r\n        \r\n        return {\r\n            \"server\": {\r\n                \"name\": self.config.server.name,\r\n                \"version\": self.config.server.version,\r\n                \"status\": \"running\"\r\n            },\r\n            \"connections\": {\r\n                \"rhino\": {\r\n                    \"connected\": rhino_status,\r\n                    \"host\": self.config.rhino.host,\r\n                    \"port\": self.config.rhino.port\r\n                },\r\n                \"grasshopper\": {\r\n                    \"connected\": grasshopper_status,\r\n                    \"host\": self.config.grasshopper.host,\r\n                    \"port\": self.config.grasshopper.port\r\n                }\r\n            }\r\n        }\r\n",
  "language": "python",
  "imports": [],
  "has_docstring": true
}