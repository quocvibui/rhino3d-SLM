{
  "source_url": "https://github.com/ed-p-may/LBT-2-PH/blob/3c2bbdf0cb26deb92d36b870aeb920cbc31d8da2/rh_plugin_v6/PHPPexport%20%7B82540871-2420-4c7f-8efa-78b7d078cbfe%7D/dev/PHPP_EditTBLibrary_cmd.py",
  "repo": "ed-p-may/LBT-2-PH",
  "repo_stars": 12,
  "repo_description": "LBT2PH is a free toolkit for creating PHPP energy models from Ladybug Tools v1.0+ definitions.",
  "license": "GPL-3.0",
  "filepath": "rh_plugin_v6/PHPPexport {82540871-2420-4c7f-8efa-78b7d078cbfe}/dev/PHPP_EditTBLibrary_cmd.py",
  "instruction": "Creates the input dialog window for all the component library information\r\nsuch as windows, frames, glasss. This uses a Model-View-Controller configuration\r\nmostly just cus' I wanted to test that...",
  "code": "#\r\n# LBT2PH: A Plugin for creating Passive House Planning Package (PHPP) models from LadybugTools. Created by blgdtyp, llc\r\n# \r\n# This component is part of the PH-Tools toolkit <https://github.com/PH-Tools>.\r\n# \r\n# Copyright (c) 2020, bldgtyp, llc <phtools@bldgtyp.com> \r\n# LBT2PH is free software; you can redistribute it and/or modify \r\n# it under the terms of the GNU General Public License as published \r\n# by the Free Software Foundation; either version 3 of the License, \r\n# or (at your option) any later version. \r\n# \r\n# LBT2PH is distributed in the hope that it will be useful,\r\n# but WITHOUT ANY WARRANTY; without even the implied warranty of \r\n# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the \r\n# GNU General Public License for more details.\r\n# \r\n# For a copy of the GNU General Public License\r\n# see <http://www.gnu.org/licenses/>.\r\n# \r\n# @license GPL-3.0+ <http://spdx.org/licenses/GPL-3.0+>\r\n#\r\n\"\"\"\r\nCreates the input dialog window for all the component library information\r\nsuch as windows, frames, glasss. This uses a Model-View-Controller configuration\r\nmostly just cus' I wanted to test that out. Might be way overkill for something like\r\nthis... but was fun to build.\r\n-\r\nEM September 21, 2020\r\n\"\"\"\r\n\r\nimport rhinoscriptsyntax as rs\r\nimport Eto\r\nimport Rhino\r\nimport json\r\nfrom collections import defaultdict\r\nfrom System import Array\r\nfrom System.IO import File\r\nimport System.Windows.Forms.DialogResult\r\nimport System.Drawing.Image\r\nimport os\r\nimport random\r\nfrom shutil import copyfile\r\nimport clr\r\nclr.AddReferenceByName('Microsoft.Office.Interop.Excel, Culture=neutral, PublicKeyToken=71e9bce111e9429c')\r\nfrom Microsoft.Office.Interop import Excel\r\nimport re\r\n\r\n__commandname__ = \"PHPP_EditTBLibrary\"\r\n\r\nclass Model:\r\n    \r\n    unitsConversionSchema = {\r\n        'W/M2K': {'SI':1, 'IP':5.678264134},\r\n        'M': {'SI': 1, 'M':1, 'CM':0.01, 'MM':0.001, 'FT':0.3048, \"'\":0.3048, 'IN':0.0254, '\"':0.0254},\r\n        'W/MK': {'SI':1, 'IP':1.730734908}\r\n        }\r\n    \r\n    def __init__(self, selObjs):\r\n        self.selectedObjects = selObjs\r\n        self.GroupContent = self.setGroupContent()\r\n        self.setInitialGroupData()\r\n    \r\n    def setInitialGroupData(self):\r\n        for gr in self.GroupContent:\r\n            gr.getDocumentLibraryExgValues()\r\n    \r\n    def updateGroupData(self, _data):\r\n        for gr in self.GroupContent:\r\n            gr.updateGroupData( [v['Data'] for v in _data.values() if gr.LibType == v['LibType']] )\r\n    \r\n    def addBlankRowToGroupData(self, _grID):\r\n        for gr in self.GroupContent:\r\n            if gr.Name == _grID:\r\n                gr.addBlankRowToData()\r\n    \r\n    def _clearDocumentLibValues(self, _keys):\r\n        if not rs.IsDocumentUserText():\r\n            return\r\n            \r\n        for eachKey in rs.GetDocumentUserText():\r\n            for k in _keys:\r\n                if k in eachKey:\r\n                    rs.SetDocumentUserText(eachKey) # no second val = delete\r\n    \r\n    def setDocumentLibValues(self, _data):\r\n        # First, clear out all the existing values in the dict\r\n        keys = set()\r\n        for v in _data.values():\r\n            keys.add(v['LibType'])\r\n        self._clearDocumentLibValues( list(keys) )\r\n        \r\n        # Now add in all the values from the GridView Window\r\n        for k, v in _data.items():\r\n            idNum = self._idAsInt(v['Data']['ID'])\r\n            key = \"{}_{:02d}\".format( v['LibType'], idNum )\r\n            rs.SetDocumentUserText(key, json.dumps(v['Data']) )\r\n    \r\n    def _idAsInt(self, _in):\r\n        try:\r\n            return int(_in)\r\n        except:\r\n            print 'ID was not an integer?!?! Enter valid Int for ID-Number'\r\n            return 1\r\n    \r\n    def setGroupContent(self):\r\n        # Set up the Content to display\r\n        gr1 = Group()\r\n        gr1.Name = 'Construction Thermal Bridges'\r\n        gr1.ViewOrder = ['ID','Name', 'psiValue', 'fRsi']\r\n        gr1.LibType = 'PHPP_lib_TB'\r\n        gr1.Editable = [False, True, True, True]\r\n        gr1.ColUnit = [None, None, 'w/mk', '-']\r\n        gr1.ColType = ['int', 'str', 'float', 'float']\r\n        gr1.getBlankRow()\r\n        gr1.getDocumentLibraryExgValues()\r\n        \r\n        gr2 = Group()\r\n        gr2.Name = 'Window Psi-Install Types (w/mk)'\r\n        gr2.ViewOrder = ['ID','Name', 'Left', 'Right', 'Bottom', 'Top']\r\n        gr2.LibType = 'PHPP_lib_PsiInstall'\r\n        gr2.Editable = [False, True, True, True, True, True]\r\n        gr2.ColUnit = [None, None, 'w/mk', 'w/mk', 'w/mk', 'w/mk']\r\n        gr2.ColType = ['int', 'str', 'float', 'float', 'float', 'float']\r\n        gr2.getBlankRow()\r\n        gr2.getDocumentLibraryExgValues()\r\n        \r\n        return [gr1, gr2]\r\n    \r\n    def removeRow(self, _grID, _rowID):\r\n        for gr in self.GroupContent:\r\n            if gr.Name == _grID:\r\n                gr.removeRow( _rowID )\r\n    \r\n    def getTBLibAddress(self):\r\n        if rs.IsDocumentUserText():\r\n            return rs.GetDocumentUserText('PHPP_TB_Lib')\r\n        else:\r\n            return '...'\r\n    \r\n    def setLibraryFileAddress(self):\r\n        \"\"\" Opens a dialogue window so the use can select a file\r\n        \"\"\"\r\n        fd = Rhino.UI.OpenFileDialog()\r\n        fd.Filter = \"Excel Files (*.xlsx;*.xls)|*.xlsx;*.xls\"\r\n        \r\n        #-----------------------------------------------------------------------\r\n        # Add a warning to the user before proceeding\r\n        # https://developer.rhino3d.com/api/rhinoscript/user_interface_methods/messagebox.htm\r\n        msg = \"Loading TB parameters from a file will overwright all \"\\\r\n        \"the TB and Psi-Install values in the current Rhino \"\\\r\n        \"file's library. Be sure you want to do this before proceeding.\"\r\n        proceed = rs.MessageBox(msg, 1 | 48, 'Warning:')\r\n        if proceed == 2:\r\n            return fd.FileName\r\n        \r\n        #-----------------------------------------------------------------------\r\n        if fd.ShowDialog()!= System.Windows.Forms.DialogResult.OK:\r\n            print 'Load is Canceled...'\r\n            return None\r\n        else:\r\n            rs.SetDocumentUserText('PHPP_TB_Lib', fd.FileName)\r\n            return fd.FileName\r\n    \r\n    def readTBDataFromExcel(self):\r\n        if rs.IsDocumentUserText():\r\n            libPath = rs.GetDocumentUserText('PHPP_TB_Lib')\r\n        \r\n        try:\r\n            if libPath != None:\r\n                # If a Library File is set in the file...\r\n                if os.path.exists(libPath):\r\n                    print 'Reading the Thermal Bridge Library File....'\r\n                    \r\n                    # Make a Temporary copy\r\n                    saveDir = os.path.split(libPath)[0]\r\n                    tempFile = '{}_temp.xlsx'.format(random.randint(0,1000))\r\n                    tempFilePath = os.path.join(saveDir, tempFile)\r\n                    copyfile(libPath, tempFilePath) # create a copy of the file to read from\r\n                    \r\n                    # Open the Excel Instance and File\r\n                    ex = Excel.ApplicationClass()   \r\n                    ex.Visible = False  # False means excel is hidden as it works\r\n                    ex.DisplayAlerts = False\r\n                    workbook = ex.Workbooks.Open(tempFilePath)\r\n                    worksheets = workbook.Worksheets\r\n                    \r\n                    try:\r\n                        xlArray_TBs = None\r\n                        ws_TBs = worksheets['Thermal Bridges']\r\n                        xlArray_TBs = ws_TBs.Range['A2:C100'].Value2\r\n                    except:\r\n                        print 'Could not find a worksheet named \"Thermal Bridges\" in the taget file?'\r\n                        \r\n                    try:\r\n                        xlArray_Psi = None\r\n                        ws_PsiInst = worksheets['Psi-Installs']\r\n                        xlArray_Psi = ws_PsiInst.Range['B3:F103'].Value2\r\n                    except:\r\n                        print 'Could not find a worksheet named \"Psi-Installs\" in the target file?'\r\n                    \r\n                    workbook.Close()  # Close the worbook itself\r\n                    ex.Quit()  # Close out the instance of Excel\r\n                    os.remove(tempFilePath) # Remove the temporary read-file\r\n                    \r\n                    # Build the Thermal Bridge Library\r\n                    lib_TBs = []\r\n                    if xlArray_TBs:\r\n                        xlList_TBs = list(xlArray_TBs)\r\n                        for i in range(0, len(xlList_TBs), 3):\r\n                            newAssembly = [xlList_TBs[i],\r\n                                    xlList_TBs[i+1],\r\n                                    xlList_TBs[i+2],\r\n                            ]\r\n                            lib_TBs.append(newAssembly)\r\n                    \r\n                    # Build the Psi-Installs Library\r\n                    lib_PsiInst = []\r\n                    if xlArray_Psi:\r\n                        xlList_Psi = list(xlArray_Psi)\r\n                        for i in range(0, len(xlList_Psi), 5):\r\n                            if xlList_Psi[i] != None:\r\n                                newPsiInstall = [\r\n                                        xlList_Psi[i],\r\n                                        xlList_Psi[i+1],\r\n                                        xlList_Psi[i+2],\r\n                                        xlList_Psi[i+3],\r\n                                        xlList_Psi[i+4]\r\n                                ]\r\n                                lib_PsiInst.append(newPsiInstall)\r\n                    \r\n                return lib_TBs, lib_PsiInst\r\n        except:\r\n            print('Woops... something went wrong reading from the Excel file?')\r\n            return [], []\r\n    \r\n    def addTBDataToDocumentUserText(self, _tbs, _psiInstalls):\r\n        self._clearDocumentLibValues(['PHPP_lib_TB_', 'PHPP_lib_PsiInstall'])\r\n        \r\n        print('Writing New Library elements to the Document UserText....')\r\n        # Write the new Assemblies to the Document's User-Text\r\n        for i, eachTB in enumerate(_tbs):\r\n            if eachTB[0] != None and len(eachTB[0])>0: # Filter our Null values\r\n                newTB = {\"Name\":eachTB[0],\r\n                        \"psiValue\":eachTB[1],\r\n                        \"fRsi\":eachTB[2],\r\n                        \"ID\": int(i+1)\r\n                        }\r\n                rs.SetDocumentUserText(\"PHPP_lib_TB_{:02d}\".format(i+1), json.dumps(newTB) )\r\n        \r\n        for i, eachPsiInst in enumerate(_psiInstalls):\r\n            if eachPsiInst[0] != None and len(eachPsiInst[0])>0: # Filter our Null values\r\n                newTB = {\"Name\":eachPsiInst[0],\r\n                        \"Left\":eachPsiInst[1],\r\n                        \"Right\":eachPsiInst[2],\r\n                        \"Bottom\":eachPsiInst[3],\r\n                        \"Top\":eachPsiInst[4],                        \r\n                        \"ID\": int(i+1)\r\n                        }\r\n                rs.SetDocumentUserText(\"PHPP_lib_PsiInstall_{:02d}\".format(i+1), json.dumps(newTB) )\r\n    \r\n    \r\n    \r\n    #TODO: Fix / Revise all this eval and read from Excel stuff\r\n    # so that it works like the Component Dialog ones.....\r\n    \r\n    \r\n    \r\n    def _determineInputUnits(self, _inputString):\r\n        # If its just a number, its SI so just pass it along\r\n        # otherwise, pull out the numerical values and the non-numeric values\r\n        # And figure out the units in the str, if any\r\n        \r\n        value = _inputString\r\n        evalString = str(_inputString).upper()\r\n        \r\n        try:\r\n            value = float(_inputString)\r\n            inputUnit = 'SI'\r\n        except:\r\n            if 'FT' in evalString or \"'\" in evalString:\r\n                inputUnit = 'FT'\r\n            elif 'IN' in evalString or '\"' in evalString:\r\n                inputUnit = 'IN'\r\n            elif 'MM' in evalString:\r\n                inputUnit = 'MM'\r\n            elif 'CM' in evalString:\r\n                inputUnit = 'CM'\r\n            elif 'M' in evalString and 'MM' not in evalString:\r\n                inputUnit = 'M'\r\n            elif 'IP' in evalString:\r\n                inputUnit = 'IP'\r\n            else:\r\n                inputUnit = 'SI'\r\n            \r\n            # Pull out just the decimal numeric characters, if any\r\n            for each in re.split(r'[^\\d\\.]', _inputString):\r\n                if len(each)>0:\r\n                    value = each\r\n            \r\n        return (value, inputUnit)\r\n    \r\n    def convertToOutputUnits(self, _inputVal, _inputUnit, _displayColumnUnit):\r\n        \"\"\" Converts the user values to the right SI values for the column being edited \"\"\"\r\n        \r\n        outputUnitFactors = self.unitsConversionSchema.get(str(_displayColumnUnit).upper(), {})\r\n        conversionFactor = outputUnitFactors.get(_inputUnit, 1)\r\n        \r\n        try:\r\n            return float(_inputVal) * float(conversionFactor)\r\n        except:\r\n            return _inputVal\r\n    \r\n    def determineDisplayVal(self, _inputVal, _displayColumnUnit):\r\n        \"\"\" Decide how to show the value in the cell \"\"\"\r\n        \r\n        # If it a 'name' field, don't want to do any conversions\r\n        if _displayColumnUnit is None:\r\n            return _inputVal\r\n        \r\n        try:\r\n            val, inputUnit = self._determineInputUnits(_inputVal)\r\n            displayValue = self.convertToOutputUnits(val, inputUnit, _displayColumnUnit)\r\n            \r\n            return displayValue\r\n        except:\r\n            print 'Something went wrong converting the input value?'\r\n            return _inputVal\r\n\r\n\r\n\r\nclass Group:\r\n    \"\"\"Data Class to hold info about each Group setup\"\"\"\r\n    def __init__(self, _nm=None, _vo=None, _lt=None):\r\n        self.Name = _nm\r\n        self.ViewOrder = _vo\r\n        self.LibType = _lt\r\n        self.Layout = None\r\n        self.BlankRow = {}\r\n        self.Data = []\r\n    \r\n    def getDocumentLibraryExgValues(self):\r\n        assmblyLib = {}\r\n        \r\n        if rs.IsDocumentUserText():\r\n            for eachKey in rs.GetDocumentUserText():\r\n                if self.LibType in eachKey:\r\n                    d = json.loads(rs.GetDocumentUserText(eachKey))\r\n                    d['ID'] = self.ensureIDisInt(d['ID'])\r\n                    assmblyLib[d['ID']] = d\r\n        \r\n        if len(assmblyLib.keys()) == 0:\r\n            assmblyLib[1] = self.getBlankRow(1)\r\n        \r\n        self.Data = assmblyLib\r\n        return assmblyLib\r\n    \r\n    def ensureIDisInt(self, _in):\r\n        try:\r\n            return int(_in)\r\n        except:\r\n            return random.randint(100, 999)\r\n    \r\n    def getDataForGrid(self):\r\n        \"\"\" Return the obj dict data as lists for GridView DataStore Display\r\n        \r\n        Instead of using a simple List for the DataStore, here I'm using an\r\n        Eto FilterCollection. This is so that later, if the values are changed by a callback\r\n        while the window is running (for the unit conversions) I can just use\r\n        .DataStore.Refresh() to update all the values in the GridView.\r\n        \"\"\"\r\n        \r\n        outputList = []\r\n        \r\n        for k, v in self.Data.items():\r\n            temp = []\r\n            for field in self.ViewOrder:\r\n                temp.append( v.get(field, '') )\r\n            outputList.append(temp)\r\n        \r\n        if len(outputList) == 0:\r\n            outputList = ['']\r\n            output_FilterCollection = Eto.Forms.FilterCollection[System.Object]()\r\n            output_FilterCollection.AddRange(outputList)\r\n            \r\n            return output_FilterCollection\r\n        else:\r\n            output_FilterCollection = Eto.Forms.FilterCollection[System.Object]()\r\n            output_FilterCollection.AddRange(outputList)\r\n            \r\n            return output_FilterCollection\r\n    \r\n    def updateGroupData(self, _data):\r\n        for item in _data:\r\n            self.Data[item['ID']] = item\r\n    \r\n    def getBlankRow(self, _id=None):\r\n        self.BlankRow = {k:'' for k in self.ViewOrder}\r\n        if _id:\r\n            self.BlankRow['ID'] = int(_id)\r\n        \r\n        return self.BlankRow\r\n    \r\n    def addBlankRowToData(self):\r\n        id = len(self.Data) + 1\r\n        self.Data[id] = self.getBlankRow(id)\r\n    \r\n    def removeRow(self, _rowID):\r\n        # First, build a new dataset without the selected row\r\n        # remember, 'ID' is 1 based, not 0 based\r\n        # Note: In case there are 'gaps' in the dataset where the 'ID' skips over\r\n        # some numnber, first get the keys and then make sure they are sorted\r\n        \r\n        dataKeys = list(self.Data.keys())\r\n        dataKeys.sort()\r\n        \r\n        dataAsList = []\r\n        for key in dataKeys:\r\n            if self.Data.get(key, {'ID':None}).get('ID', None) == _rowID:\r\n                continue\r\n            \r\n            dataAsList.append( self.Data.get(key) )\r\n        \r\n        # In case the user deletes the last row, add back in a single blank one\r\n        if len(dataAsList) == 0:\r\n            self.addBlankRowToData()\r\n        \r\n        # Now turn the new list back into a dict, update the IDs as you go\r\n        newDataDict = {}\r\n        for i, dataRow in enumerate(dataAsList):\r\n            key = i + 1\r\n            dataRow['ID'] = key\r\n            newDataDict[key] = dataRow\r\n        \r\n        self.Data = newDataDict\r\n\r\n\r\n\r\nclass View(Eto.Forms.Dialog):\r\n    \r\n    def __init__(self, controller):\r\n        self.controller = controller\r\n        \r\n        self._setWindowParams()\r\n        self.buildWindow()\r\n    \r\n    def buildWindow(self):\r\n        self.layout = self._addContentToLayout()\r\n        self.Content = self._addOKCancelButtons(self.layout)\r\n    \r\n    def showWindow(self):\r\n        self.ShowModal(Rhino.UI.RhinoEtoApp.MainWindow)\r\n    \r\n    def _setWindowParams(self):\r\n        self.Title = \"PHPP Thermal Bridge Libraries\"\r\n        self.Padding = Eto.Drawing.Padding(15)\r\n        self.Resizable = True\r\n    \r\n    def _getHeaderDisplayName(self, _in):\r\n        headerNames = {'Name': 'Name',\r\n        'psiValue': 'Psi-Value\\n(w/mk)',\r\n        'fRsi': 'f-Rsi=0.25\\n(%)'\r\n        }\r\n        \r\n        return headerNames.get(_in, _in)\r\n    \r\n    def _addContentToLayout(self):\r\n        layout = Eto.Forms.DynamicLayout()\r\n        layout.Spacing = Eto.Drawing.Size(10,10)\r\n        \r\n        self.groupContent = self.controller.getGroupContent()\r\n        for groupContent in self.groupContent:\r\n            groupContent.Layout = self._createGridLayout(groupContent)\r\n            \r\n            if len(groupContent.Layout.DataStore) == 0:\r\n                continue\r\n            \r\n            for i, data in enumerate(groupContent.Layout.DataStore[0]):\r\n                groupContent.Layout.Columns.Add(self._createGridColumn(groupContent.ViewOrder[i], groupContent.Editable[i], groupContent.ColUnit[i], i))\r\n            \r\n            groupObj = Eto.Forms.GroupBox(Text = groupContent.Name)\r\n            groupObjLayout = Eto.Forms.DynamicLayout()\r\n            groupObjLayout.Add(self._addGridToScrollPanel(groupContent.Layout))\r\n            groupObjLayout = self._addControlButtonsToLayout(groupObjLayout, groupContent)\r\n            \r\n            groupObj.Content = groupObjLayout\r\n            layout.Add(groupObj)\r\n        \r\n        return layout\r\n    \r\n    def _addControlButtonsToLayout(self, _layout, _gr):\r\n        self.Button_Add = Eto.Forms.Button(Text = 'Add Row')\r\n        self.Button_Add.Click += self.controller.OnAddRowButtonClick\r\n        self.Button_Add.ID = _gr.Name\r\n        self.Button_Del = Eto.Forms.Button(Text = 'Remove Selected Row')\r\n        self.Button_Del.Click += self.controller.OnDelRowButtonClick\r\n        self.Button_Del.ID = _gr.Name\r\n        \r\n        # Add the Buttons at the bottom\r\n        self.vert = _layout.BeginVertical()\r\n        self.vert.Padding = Eto.Drawing.Padding(10)\r\n        self.vert.Spacing = Eto.Drawing.Size(15,0)\r\n        _layout.AddRow(None, self.Button_Add, self.Button_Del, None)\r\n        _layout.EndVertical()\r\n        \r\n        return _layout\r\n        \r\n    def _createGridLayout(self, _grContent):\r\n        grid_Layout = Eto.Forms.GridView()\r\n        grid_Layout.ShowHeader = True\r\n        grid_Layout.DataStore = _grContent.getDataForGrid()\r\n        grid_Layout.ShowCellBorders = True\r\n        grid_Layout.CellEdited += self.controller.evalInput\r\n        \r\n        return grid_Layout\r\n    \r\n    def _createGridColumn(self, grpContent, _editable, _unit, count):\r\n        column = Eto.Forms.GridColumn()\r\n        column.HeaderText = self._getHeaderDisplayName(grpContent)\r\n        column.Editable = _editable\r\n        column.Sortable = True\r\n        column.Width = 125\r\n        column.AutoSize = True\r\n        column.DataCell = Eto.Forms.TextBoxCell(count)\r\n        column.Properties['ColumnUnit'] = _unit\r\n        \r\n        return column\r\n    \r\n    def _addGridToScrollPanel(self, _grContent):\r\n        Scroll_panel = Eto.Forms.Scrollable()\r\n        Scroll_panel.ExpandContentWidth = True\r\n        Scroll_panel.ExpandContentHeight = True\r\n        Scroll_panel.Size = Eto.Drawing.Size(600, 200)\r\n        Scroll_panel.Content = _grContent\r\n        \r\n        return Scroll_panel\r\n        \r\n    def _addOKCancelButtons(self, _layout):\r\n        # Create the OK / Cancel Button\r\n        self.Button_LoadLib = Eto.Forms.Button(Text = 'Import From Libary File...')\r\n        self.Button_LoadLib.Click += self.controller.OnLoadLibButtonClick\r\n        self.Lib_txtBox = Eto.Forms.TextBox( Text = self.controller.getTBLibraryFileAddress() )\r\n        self.Lib_txtBox.Width=200\r\n        \r\n        self.Button_OK = Eto.Forms.Button(Text = 'OK')\r\n        self.Button_OK.Click += self.controller.OnOKButtonClick\r\n        self.Button_Cancel = Eto.Forms.Button(Text = 'Cancel')\r\n        self.Button_Cancel.Click += self.controller.OnCancelButtonClick\r\n        \r\n        # Add the Buttons at the bottom\r\n        self.vert = _layout.BeginVertical()\r\n        self.vert.Padding = Eto.Drawing.Padding(10)\r\n        self.vert.Spacing = Eto.Drawing.Size(15,0)\r\n        _layout.AddRow(None, self.Button_LoadLib, self.Lib_txtBox, None, None, self.Button_Cancel, self.Button_OK, None)\r\n        _layout.EndVertical()\r\n        \r\n        return _layout\r\n    \r\n    def _cleanInput(self, _in, _type='str'):\r\n        \"\"\"Cast input data correctly\"\"\"\r\n        \r\n        castToType = {\"float\": lambda x: float(x),\r\n                \"int\": lambda x: int(x),\r\n                \"str\": lambda x: str(x),\r\n                }\r\n        \r\n        if '=' in str(_in):\r\n            try:\r\n                _in = eval(_in.replace('=', ''))\r\n            except:\r\n                pass\r\n        \r\n        try:\r\n            return castToType[_type](_in)\r\n        except:\r\n            return _in\r\n    \r\n    def getGridValues(self):\r\n        dataFromGridItems = {}\r\n        for group in self.groupContent:\r\n            gr_fields = group.ViewOrder\r\n            gr_data = group.Layout.DataStore\r\n            gr_dataTypes = group.ColType\r\n            \r\n            try:\r\n                for dataRow in gr_data:\r\n                    d = {gr_fields[i]: self._cleanInput(dataRow[i], gr_dataTypes[i]) for i in range(len(gr_fields))}\r\n                    \r\n                    if len(d.get('Name')) > 0:\r\n                        tempDict = {}\r\n                        nm = \"{}_{}\".format(group.LibType, d.get('Name'))\r\n                        \r\n                        tempDict['Name'] = nm\r\n                        tempDict['LibType'] = group.LibType\r\n                        tempDict['Data'] = d\r\n                        \r\n                        dataFromGridItems[nm] = tempDict \r\n            except:\r\n                return {}             \r\n        \r\n        return dataFromGridItems\r\n\r\n\r\n\r\nclass Controller:\r\n    \r\n    def __init__(self, selObjs):\r\n        self.model = Model(selObjs)\r\n        self.view = View(self)\r\n    \r\n    def main(self):\r\n        self.view.showWindow()\r\n    \r\n    def OnOKButtonClick(self, sender, e):\r\n        print(\"Applying the changes to the file's component library\")\r\n        data = self.view.getGridValues()\r\n        self.model.setDocumentLibValues(data)\r\n        self.Update = True\r\n        self.view.Close()\r\n    \r\n    def OnCancelButtonClick(self, sender, e):\r\n        print('Canceled...')\r\n        self.Update = False\r\n        self.view.Close()\r\n    \r\n    def OnLoadLibButtonClick(self, sender, e):\r\n        update = self.view.Lib_txtBox = self.model.setLibraryFileAddress()\r\n        \r\n        if update:\r\n            tbs, psiInstalls = self.model.readTBDataFromExcel()\r\n            self.model.addTBDataToDocumentUserText( tbs, psiInstalls )\r\n            \r\n            self.model.setInitialGroupData()\r\n            self.view.layout.Clear()\r\n            self.view.buildWindow()\r\n    \r\n    def OnAddRowButtonClick(self, sender, e):\r\n        data = self.view.getGridValues()\r\n        self.model.updateGroupData(data)\r\n        self.model.addBlankRowToGroupData(sender.ID)\r\n        self.view.layout.Clear()\r\n        self.view.buildWindow()\r\n    \r\n    def OnDelRowButtonClick(self, sender, e):\r\n        selectedRowData = None\r\n        for gr in self.view.groupContent:\r\n            if gr.Name == sender.ID:\r\n                for each in gr.Layout.SelectedItems:\r\n                    selectedRowData = each\r\n        \r\n        if selectedRowData:\r\n            data = self.view.getGridValues()\r\n            self.model.updateGroupData(data)\r\n            self.model.removeRow(sender.ID, selectedRowData[0])\r\n            self.view.layout.Clear()\r\n            self.view.buildWindow()\r\n        \r\n    def getGroupContent(self):\r\n        return self.model.GroupContent\r\n    \r\n    def getTBLibraryFileAddress(self):\r\n        return self.model.getTBLibAddress()\r\n    \r\n    def evalInput(self, sender, e):\r\n        # Determine if the user provides some 'Units' such as 'ft' or 'in' \r\n        # If so, do the conversion to the right SI value and reset the grid cell value\r\n        \r\n        #print('-'*20)\r\n        #for attr in dir(sender):\r\n            #print attr, '::', getattr(sender, attr)\r\n        \r\n        #print('-'*20)\r\n        #for attr in dir(e):\r\n            #print attr, '::', getattr(e, attr)\r\n        \r\n        #Figure out the correct 'units' for the column being edited\r\n        GridColumn = getattr(e, 'GridColumn')\r\n        colProperties = getattr(GridColumn, 'Properties')\r\n        for each in colProperties:\r\n            if each.Key == 'ColumnUnit':\r\n                colUnit = each.Value\r\n        \r\n        # Get the input value, decide what to do with it\r\n        #print e.Row, e.Column\r\n        #print sender.DataStore.Item[e.Row][e.Column]\r\n        \r\n        inputVal = sender.DataStore.Item[e.Row][e.Column]\r\n        displayVal = self.model.determineDisplayVal(inputVal, colUnit)\r\n        \r\n        # Update with the new value\r\n        sender.DataStore.Item[e.Row][e.Column] = displayVal\r\n        sender.DataStore.Refresh()\r\n\r\n\r\ndef RunCommand( is_interactive ):\r\n    dialog = Controller(rs.SelectedObjects())\r\n    dialog.main()\r\n\r\n# Use for debuging in editor\r\n#RunCommand(True)",
  "language": "python",
  "imports": [
    "Rhino",
    "rhinoscriptsyntax"
  ],
  "has_docstring": true
}