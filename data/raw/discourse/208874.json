{
  "source_url": "https://discourse.mcneel.com/t/custom-gh-geometricgoo-preview/208874",
  "topic_id": 208874,
  "title": "Custom GH_GeometricGoo Preview",
  "question": "Hi,\n\n\nI wrapped a Rhino.Geometry.Curve inside a custom GH_GeometricGoo that implements IGH_PreviewData.  Despite the goo reporting a valid BoundingBox and DrawViewportWires being called, the component’s has no preview. (standard red/green document preview)\n\n\nWhat I am i missing? Is it expected that Grasshopper does not auto-preview custom GH_GeometricGoo?\n\n\nIdeally the component output should preview the curve automatically, identical to a component that outputs a native Curve. Below is a minimal version of the logic\n\nThanks for any help!!\n\n\nas a workaround i tried :\n\n\n\n\n\n\nOutput the raw Curve alongside the custom goo. (inefficient and confusing)\n\n\n\n\n\n\na IGH_PreviewObject  and manually drawing contents. (disregards documents preview colors)\n\n\n\n\n\n\nComponent\n\n\n\nusing Grasshopper.Kernel;\nusing Rhino.Geometry;\nusing System;\n\nnamespace Toolpaths.MinimalRepro\n{\n    // Minimal reproduction: outputs ReproGoo which implements IGH_PreviewData.\n    // EXPECTED: Grasshopper would preview the curve directly when the component is selected or in normal mode.\n    // ACTUAL: No preview appears until the output is connected to another parameter that itself previews.\n    public class ReproComponent : GH_Component\n    {\n        public ReproComponent() : base(\"Repro Component\", \"ReproCmp\", \"Minimal reproduction component showing missing preview until consumed.\", \"Repro\", \"Repro\") { }\n        public override Guid ComponentGuid => new Guid(\"fa3af4d8-27ca-48a5-b2c3-7d7c8a1fd202\");\n        protected override void RegisterInputParams(GH_InputParamManager p) { p.AddCurveParameter(\"Curve\", \"C\", \"Input curve\", GH_ParamAccess.item); }\n        protected override void RegisterOutputParams(GH_OutputParamManager p) { p.AddParameter(new ReproParam(), \"Repro\", \"R\", \"Repro goo\", GH_ParamAccess.item); }\n        protected override void SolveInstance(IGH_DataAccess da)\n        {\n            Curve c = null; if (!da.GetData(0, ref c)) return; if (c == null || !c.IsValid) { AddRuntimeMessage(GH_RuntimeMessag...",
  "code_blocks": [
    {
      "code": "1 using Grasshopper.Kernel;\n2 using Grasshopper.Kernel.Types;\n3 using Rhino.Geometry;\n4 using System;\n5 using System.Collections.Generic;\n6\n7 namespace Toolpaths.MinimalRepro\n8 {\n9     public class ReproParam : GH_PersistentParam<ReproGoo>, IGH_PreviewObject\n\n\n10     {\n11         public ReproParam() : base(“Repro”, “R”, “Repro goo”, “Repro”, “Repro”) { }\n12\n13         public override Guid ComponentGuid => new Guid(“d53512cb-38ff-4e38-bc02-6f5cbfdbcbf5”);\n14\n15         protected override GH_GetterResult Prompt_Singular(ref ReproGoo value) =>\nGH_GetterResult.cancel;\n16\n17         protected override GH_GetterResult Prompt_Plural(ref List values) =>\nGH_GetterResult.cancel;\n18\n19         #region IGH_PreviewObject Implementation\n20\n21         public bool Hidden { get; set; }\n22\n23         public bool IsPreviewCapable => true;\n24\n25         public BoundingBox ClippingBox\n26         {\n27             get\n28             {\n29                 var box = BoundingBox.Empty;\n30                 foreach (var goo in VolatileData.AllData(true))\n31                 {\n32                     if (goo?.IsValid ?? false)\n33                     {\n34                         box.Union(goo.Boundingbox);\n35                     }\n36                 }\n37                 return box;\n38             }\n39         }\n40\n41         public void DrawViewportWires(IGH_PreviewArgs args)\n42         {\n43             if (Hidden) return;\n44\n45             // Use the correct color based on the parameter’s selection state\n46             var color = Attributes.Selected ? args.WireColour_Selected : args.WireColour;\n47\n48             foreach (var goo in VolatileData.AllData(true))\n49             {\n50                 if (goo?.IsValid ?? false)\n51                 {\n52                     // The parameter itself is responsible for drawing the geometry\n53                     args.Display.DrawCurve(goo.Value, color);\n54                 }\n55             }\n56         }\n57\n58         public void DrawViewportMeshes(IGH_PreviewArgs args)\n59         {\n60             // No meshes to draw in this example\n61         }\n62\n63         #endregion\n64     }\n65 }",
      "language": "csharp",
      "author": "Konrad",
      "post_number": 2,
      "is_solution": false
    },
    {
      "code": "using Grasshopper.Kernel;\nusing Rhino.Geometry;\nusing System;\n\nnamespace Toolpaths.MinimalRepro\n{\n    // Minimal reproduction: outputs ReproGoo which implements IGH_PreviewData.\n    // EXPECTED: Grasshopper would preview the curve directly when the component is selected or in normal mode.\n    // ACTUAL: No preview appears until the output is connected to another parameter that itself previews.\n    public class ReproComponent : GH_Component\n    {\n        public ReproComponent() : base(\"Repro Component\", \"ReproCmp\", \"Minimal reproduction component showing missing preview until consumed.\", \"Repro\", \"Repro\") { }\n        public override Guid ComponentGuid => new Guid(\"fa3af4d8-27ca-48a5-b2c3-7d7c8a1fd202\");\n        protected override void RegisterInputParams(GH_InputParamManager p) { p.AddCurveParameter(\"Curve\", \"C\", \"Input curve\", GH_ParamAccess.item); }\n        protected override void RegisterOutputParams(GH_OutputParamManager p) { p.AddParameter(new ReproParam(), \"Repro\", \"R\", \"Repro goo\", GH_ParamAccess.item); }\n        protected override void SolveInstance(IGH_DataAccess da)\n        {\n            Curve c = null; if (!da.GetData(0, ref c)) return; if (c == null || !c.IsValid) { AddRuntimeMessage(GH_RuntimeMessageLevel.Error, \"Invalid curve\"); return; }\n            da.SetData(0, new ReproGoo(c));\n        }\n    }\n}",
      "language": "csharp",
      "author": "Konrad",
      "post_number": 1,
      "is_solution": false
    },
    {
      "code": "using System.Collections.Generic;\nusing Grasshopper.Kernel.Types;\nusing Grasshopper.Kernel;\nusing Rhino.Geometry;\n\nnamespace Toolpaths.MinimalRepro\n{\n    // Minimal geometric goo wrapping a Curve\n    public class ReproGoo : GH_GeometricGoo<Curve>, IGH_PreviewData\n    {\n        public ReproGoo() { }\n        public ReproGoo(Curve c) { Value = c; }\n        public override string TypeName => \"ReproGoo\";\n        public override string TypeDescription => \"Minimal reproduction goo wrapping a curve\";\n        public override IGH_Goo Duplicate() => new ReproGoo(Value?.DuplicateCurve());\n        public override bool IsValid => Value != null && Value.IsValid;\n        public override BoundingBox Boundingbox => Value?.GetBoundingBox(true) ?? BoundingBox.Empty;\n        public override IGH_GeometricGoo DuplicateGeometry() => new ReproGoo(Value?.DuplicateCurve());\n        public override BoundingBox GetBoundingBox(Transform xform) => xform.TransformBoundingBox(Boundingbox);\n        public override IGH_GeometricGoo Morph(SpaceMorph xmorph)\n        {\n            if (Value == null) return new ReproGoo();\n            var dup = Value.DuplicateCurve();\n            xmorph.Morph(dup);\n            return new ReproGoo(dup);\n        }\n        public override IGH_GeometricGoo Transform(Transform xform)\n        {\n            if (Value == null) return new ReproGoo();\n            var dup = Value.DuplicateCurve();\n            dup.Transform(xform);\n            return new ReproGoo(dup);\n        }\n        public BoundingBox ClippingBox => Boundingbox;\n        public void DrawViewportWires(GH_PreviewWireArgs args)\n        {\n            if (IsValid) args.Pipeline.DrawCurve(Value, args.Color);\n        }\n        public void DrawViewportMeshes(GH_PreviewMeshArgs args) { }\n        public override string ToString() => IsValid ? $\"ReproGoo Length={Value.GetLength():0.##}\" : \"ReproGoo (null)\";\n    }\n}",
      "language": "csharp",
      "author": "Konrad",
      "post_number": 1,
      "is_solution": false
    }
  ],
  "tags": [
    "csharp",
    "geometry",
    "grasshopper",
    "mesh",
    "rhinocommon",
    "transformation"
  ],
  "has_accepted_answer": false,
  "category_id": 8,
  "posts_count": 2,
  "views": 83
}