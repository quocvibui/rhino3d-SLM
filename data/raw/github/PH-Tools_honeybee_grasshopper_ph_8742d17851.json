{
  "source_url": "https://github.com/PH-Tools/honeybee_grasshopper_ph/blob/c433bc8e66f3a51fd05ee4c485f4c54c03d2a569/honeybee_ph_rhino/make_spaces/make_space.py",
  "repo": "PH-Tools/honeybee_grasshopper_ph",
  "repo_stars": 6,
  "repo_description": "Honeybe-PH plugin for Rhino / Grasshopper ",
  "license": "GPL-3.0",
  "filepath": "honeybee_ph_rhino/make_spaces/make_space.py",
  "instruction": "Functions to Add Spaces onto Honeybee Rooms.",
  "code": "# -*- coding: utf-8 -*-\n# -*- Python Version: 2.7 -*-\n\n\"\"\"Functions to Add Spaces onto Honeybee Rooms.\"\"\"\n\ntry:\n    from typing import Dict, List, Tuple\nexcept ImportError:\n    pass  # IronPython 2.7\n\ntry:\n    from honeybee import room\n    from honeybee_energy.properties.room import RoomEnergyProperties\nexcept ImportError as e:\n    raise ImportError(\"\\nFailed to import honeybee:\\n\\t{}\".format(e))\n\ntry:\n    from ladybug_rhino.fromgeometry import from_point3d\n    from ladybug_rhino.togeometry import to_point3d\nexcept ImportError as e:\n    raise ImportError(\"\\nFailed to import ladybug_rhino:\\n\\t{}\".format(e))\n\ntry:\n    from ladybug_geometry import geometry3d\nexcept ImportError as e:\n    raise ImportError(\"\\nFailed to import ladybug_geometry:\\n\\t{}\".format(e))\n\ntry:\n    from honeybee_ph import space\n    from honeybee_ph.properties.room import RoomPhProperties\n    from honeybee_ph.properties.space import SpacePhProperties\nexcept ImportError as e:\n    raise ImportError(\"\\nFailed to import honeybee_ph:\\n\\t{}\".format(e))\n\ntry:\n    from honeybee_ph_rhino import gh_io\nexcept ImportError as e:\n    raise ImportError(\"\\nFailed to import honeybee_ph_rhino:\\n\\t{}\".format(e))\n\n\nclass MissingVentilationProgramError(Exception):\n    def __init__(self, room):\n        self.room = room\n        self.message = (\n            \"HB-Room '{}' with an HB-Program of: '{}' does not have an HB-Energy-Ventilation-Program? \"\n            \"Cannot add HBPH-Space with ventilation flow rates to an HB-Room without an HB-Energy-Ventilation-Program. \"\n            \"You should either use an HB-Energy-Program type for the Room which already has an HB-Energy-Ventilation-Program, \"\n            \"or add one to the Room's HB-Program before proceeding.\".format(\n                room.display_name, room.properties.energy.program_type\n            )\n        )\n        # type: (room.Room) -> None\n        super(MissingVentilationProgramError, self).__init__(self.message)\n\n\nclass SpaceData(object):\n    \"\"\"Temporary data class for organizing the space data and test points\"\"\"\n\n    def __init__(self, space, reference_points):\n        # type: (space.Space, List[geometry3d.Point3D]) -> None\n        self.space = space\n        self.reference_points = reference_points\n\n\ndef offset_space_reference_points(IGH, _space, _dist=0.0):\n    # type: (gh_io.IGH, space.Space, float) -> space.Space\n    \"\"\"Move the Space's floor-segment's reference point 'up' in the world-Z some distance. This is\n        useful since if the reference point is directly 'on' the honeybee-Room's floor\n        surface, sometimes it will not test as 'inside' correctly. Tolerance issue?\n\n    Arguments:\n    ----------\n        * IGH (gh_io.IGH): The Grasshopper interface object.\n        * _space (space.Space): A Space to operate on.\n        * _dist (float): A distance to offset the reference point.\n\n    Returns:\n    --------\n        * space.Space: A copy of the input Space with the floor-segment reference\n            points modified.\n    \"\"\"\n    # -------------------------------------------------------------------------\n    if _dist == 0:\n        return _space\n\n    # -------------------------------------------------------------------------\n    new_space = _space.duplicate()\n    for volume in new_space.volumes:\n        for seg in volume.floor._floor_segments:\n            if not seg.reference_point:\n                continue\n            seg.reference_point = to_point3d(\n                IGH.ghc.Move(\n                    from_point3d(seg.reference_point),\n                    IGH.ghpythonlib_components.UnitZ(_dist),\n                ).geometry\n            )\n    return new_space\n\n\ndef set_absolute_ventilation(_hb_room, _new_room_airflow):\n    # type: (room.Room, float) -> room.Room\n    \"\"\"Set the Absolute Ventilation on an HB-Room's .properties.energy\n\n    Implemented to support HBE <1.5 and 1.6 where they corrected the type on the\n    attribute name (added the missing 's' in 'absolute')\n\n    Arguments:\n    ----------\n        * _hb_room (room.Room): The Room to set the\n            .properties.energy.absolute_ventilation rate for.\n        * _new_room_airflow (float): The new absolute ventilation flow-rate.\n\n    Returns:\n    --------\n        * (room.Room): The HB-Room with the .properties.energy modified.\n    \"\"\"\n\n    rm_prop_energy = _hb_room.properties.energy  # type: RoomEnergyProperties # type: ignore\n    if hasattr(_hb_room, \"abolute_ventilation\"):\n        rm_prop_energy.abolute_ventilation(_new_room_airflow)  # type: ignore\n    else:\n        rm_prop_energy.absolute_ventilation(_new_room_airflow)\n\n    return _hb_room\n\n\ndef add_spaces_to_honeybee_rooms(_spaces, _hb_rooms, _inherit_names=False):\n    # type: (List[space.Space], List[room.Room], bool) -> Tuple[List[room.Room], List[SpaceData], List[room.Room]]\n    \"\"\"Sorts a list of Spaces, checks which are 'in' which HB-Room, and adds the space to that room.\n\n    Arguments:\n    ----------\n        * _spaces (list[space.Space]) A list of Spaces.\n        * _hb_rooms (list[room.Room]): A list of Honeybee Rooms.\n        * _inherit_names (bool) default=False. Set True to override all space names\n            with the name of the parent Honeybee-Room.\n\n    Returns:\n    --------\n        (list[room.Room]): A list of Honeybee rooms with Spaces added to them.\n    \"\"\"\n\n    # -------------------------------------------------------------------------\n    # -- Organize the spaces into a dict and pull out the reference points\n    # -- This is done to avoid re-collecting the points at each is_point_inside\n    # -- check and so that 'del' can be used to speed up the hosting checks.\n    spaces_dict = {}  # type: Dict[int, SpaceData]\n    for space in _spaces:\n        spaces_dict[id(space)] = SpaceData(space, [pt for pt in space.reference_points])\n\n    # -------------------------------------------------------------------------\n    # -- Add the spaces to the host-rooms\n    new_rooms = []\n    open_rooms = []\n    for hb_room in _hb_rooms:\n        dup_room = hb_room.duplicate()  # type: room.Room # type: ignore\n\n        # -- Check to ensure that the room is actually solid first\n        if not dup_room.geometry.is_solid:\n            print(\"Error: Room {} not solid. Cannot host spaces.\".format(dup_room.display_name))\n            open_rooms.append(dup_room)\n            continue\n\n        # -- See if any of the Space Reference points are inside the Room Geometry\n        for space_data_id, space_data in spaces_dict.items():\n            for pt in space_data.reference_points:\n                if not dup_room.geometry.is_point_inside(pt):\n                    continue\n\n                print(\"Hosting Space: {}  in HB-Room: {}\".format(space_data.space.full_name, dup_room.display_name))\n\n                sp = space_data.space.duplicate()\n                sp.host = dup_room\n\n                # -- If 'inherit names', simplify the spaces so that\n                # -- there is only a single space inside of the HB-Room\n                # -- and it will inherit its name from the parent HB-Room.\n                dup_rm_prop_ph = getattr(dup_room.properties, \"ph\")  # type: RoomPhProperties\n                if _inherit_names:\n                    sp.name = dup_room.display_name\n                    dup_rm_prop_ph.merge_new_space(sp)\n                else:\n                    dup_rm_prop_ph.add_new_space(sp)\n\n                # -- Add in any detailed PH-Style vent flow rates if they exist\n                space_prop_ph = getattr(sp.properties, \"ph\")  # type: SpacePhProperties\n                if space_prop_ph.has_ventilation_flow_rates:\n                    # -- Ensure that the Room has a Ventilation Program\n                    # -- Some in HB-Energy don't have any Vent program at all. Which is weird.\n                    dup_room_prop_energy = getattr(dup_room.properties, \"energy\")  # type: RoomEnergyProperties\n                    if not dup_room_prop_energy.ventilation:\n                        raise MissingVentilationProgramError(dup_room)\n\n                    # -- Get any Sup/Eta/Trans PH-Style flow-rate overrides / supplements\n                    space_flow_rate_override = space_prop_ph.honeybee_flow_rate or 0.0\n\n                    # -- Set the Honeybee-Energy Ventilation Flow Rates\n                    existing_room_flow = float(dup_room_prop_energy.ventilation.flow_per_zone)\n                    new_room_flow = space_flow_rate_override + existing_room_flow\n                    dup_room = set_absolute_ventilation(dup_room, new_room_flow)\n\n                # -- to speed up further checks\n                del spaces_dict[space_data_id]\n                break\n\n        new_rooms.append(dup_room)\n\n    # -- There should not be any spaces left in the dict if all were\n    # -- hosted properly. Raise warning error if any are un-hosted?\n    un_hosted_spaces = []\n    if spaces_dict:\n        for space in spaces_dict.values():\n            un_hosted_spaces.append(space)\n\n    return new_rooms, un_hosted_spaces, open_rooms\n",
  "language": "python",
  "imports": [
    "ghpythonlib"
  ],
  "has_docstring": true
}