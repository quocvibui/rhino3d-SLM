{
  "source_url": "https://github.com/diff-arch/Tapeworm/blob/6413ebcb6788b7341423cba9bcb54f7dff214ecc/src/ghComp/Tapeworm_Settings%20Frames-to-Video.py",
  "repo": "diff-arch/Tapeworm",
  "repo_stars": 11,
  "repo_description": "FFmpeg controller plugin for GrasshopperÂ® ",
  "license": "GPL-3.0",
  "filepath": "src/ghComp/Tapeworm_Settings Frames-to-Video.py",
  "instruction": "Configures a set of instructions for a FFmpeg frames-to-video conversion\r\n    Inputs:\r\n        IO: Tapeworm input/output information\r\n        Framerate: Optional framerate, by default 30\r\n       ...",
  "code": "# Tapeworm: FFmpeg Controller Grasshopper plug-in (GPL)\r\n# initiated by Marc Differding and Antoine Maes\r\n#\r\n# This file is part of Tapeworm.\r\n# GitHub : https://www.github.com/diff-arch/Tapeworm\r\n# Food4Rhino : https://www.food4rhino.com/app/tapeworm\r\n#\r\n# Copyright (c) 2020-2021, Marc Differding and Antoine Maes <tapeworm.gh@gmail.com>\r\n# Tapeworm is a free software; you can redistribute it and/or modify\r\n# it under the terms of the GNU General Public License as published\r\n# by the Free Software Foundation; either version 3 of the License,\r\n# or (at your option) any later version.\r\n#\r\n# Tapeworm is distributed in the hope to be useful,\r\n# but WITHOUT ANY WARRANTY; without even the implied warranty of\r\n# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\r\n# GNU General Public License for more details.\r\n#\r\n# You should have received a copy of the GNU General Public License\r\n# along with Tapeworm; if not see <http://www.gnu.org/licenses/>\r\n#\r\n# @license GPL-3.0 <http://www.gnu.org/licenses/gpl.html>\r\n\r\n# -------------------------- COMPONENT INFORMATION -----------------------------\r\n\r\n\"\"\"Configures a set of instructions for a FFmpeg frames-to-video conversion\r\n    Inputs:\r\n        IO: Tapeworm input/output information\r\n        Framerate: Optional framerate, by default 30\r\n        StartFrame: Optional start frame, by default the first frame of the image sequence\r\n        Format: Optional output video format, by default 'MP4'\r\n        Bitrate : Optional video quality between 0 and 12, by default 5\r\n        Loop: Optional loop count, by default 1 (play once)\r\n    Output:\r\n        Settings: Set of Tapeworm instructions for a FFmpeg frames-to-video conversion\r\n\"\"\"\r\n\r\nghenv.Component.Name = \"Frames-to-Video\"\r\nghenv.Component.NickName = \"Frames-Video\"\r\nghenv.Component.IconDisplayMode = ghenv.Component.IconDisplayMode.application\r\nghenv.Component.Category = \"Tapeworm\"\r\nghenv.Component.SubCategory = \"2 | Settings\"\r\n\r\n__version__ = \"0.2.9 (2021-06-05)\"\r\n\r\n# ------------------------------ COMPONENT CODE --------------------------------\r\n\r\nimport sys\r\nimport os\r\n\r\nimport Grasshopper as gh\r\nimport Rhino as rh\r\n\r\n\r\nif \"Tapeworm\" not in sys.modules:\r\n    plugin_path = gh.Folders.DefaultAssemblyFolder\r\n    if plugin_path not in sys.path:\r\n        sys.path.append(plugin_path)\r\n\r\n    try:\r\n        from Tapeworm import __version__\r\n    except ImportError:\r\n        sys.path.remove(plugin_path)\r\n\r\n        # Recurse the auto-install plug-in folders and\r\n        # get directories with \"active\" versions of plug-ins\r\n        avd = rh.Runtime.HostUtils.GetActivePlugInVersionFolders(True)\r\n        # Return the Tapeworm installation directory, or None\r\n        find_path = lambda: next((a.FullName for a in avd\r\n                                  if a.FullName.find(\"Tapeworm\") != -1), None)\r\n        plugin_path = find_path()\r\n        if plugin_path not in sys.path:\r\n            sys.path.append(plugin_path)\r\n\r\n        try:\r\n            from Tapeworm import __version__\r\n        except ImportError as e:\r\n            raise e\r\n\r\n\r\n# If Tapeworm is available, import the required classes and functions\r\nfrom Tapeworm import (InputOutput, SettingsFramesToVideo, is_integer_num,\r\n                      is_num, VID_FORMATS, IMG_FORMATS)\r\n\r\nSUPP_FORMATS = list(IMG_FORMATS)\r\nSUPP_FORMATS.remove(\"GIF\")\r\n\r\n\r\ndef main(io, framerate, start_frame, video_format, video_bitrate, loop):\r\n    # Verify values of the component inputs\r\n    if io is None:\r\n        e = \"Input parameter IO failed to collect data\"\r\n        ghenv.Component.AddRuntimeMessage(\r\n            gh.Kernel.GH_RuntimeMessageLevel.Warning, e\r\n        )\r\n        return\r\n    else:\r\n        if not isinstance(io, InputOutput):\r\n            e = \"Data conversion failed from {} to I/O Information\" \\\r\n                .format(type(io).__name__)\r\n            ghenv.Component.AddRuntimeMessage(\r\n                gh.Kernel.GH_RuntimeMessageLevel.Error, e\r\n            )\r\n            return\r\n\r\n        ext = io.input_fname.split(\".\")[-1].upper()\r\n        if ext not in SUPP_FORMATS:\r\n            e = \"'{}' does not have a valid file format, \\n\" \\\r\n                .format(io.input_fname)\r\n            e += \"currently supported formats include: \\n{}\" \\\r\n                .format(\", \".join(sorted(SUPP_FORMATS)))\r\n            ghenv.Component.AddRuntimeMessage(\r\n                gh.Kernel.GH_RuntimeMessageLevel.Error, e\r\n            )\r\n            return\r\n\r\n    if io.im is not None and io.im.get_start_number() < 0:  # is single image\r\n        e = \"This component does not work with single images\"\r\n        ghenv.Component.AddRuntimeMessage(\r\n            gh.Kernel.GH_RuntimeMessageLevel.Error, e\r\n        )\r\n        return\r\n\r\n    _, in_ext = os.path.splitext(io.input_fname)\r\n    in_ext = in_ext.strip(\".\").upper()\r\n    if in_ext not in SUPP_FORMATS:\r\n        e = \"'{}' is not a valid file format, \".format(in_ext)\r\n        e += \"currently supported formats include: \\n{}\" \\\r\n            .format(\", \".join(SUPP_FORMATS))\r\n        ghenv.Component.AddRuntimeMessage(\r\n            gh.Kernel.GH_RuntimeMessageLevel.Error, e\r\n        )\r\n        return\r\n\r\n    if framerate is None:\r\n        framerate = 30  # default value\r\n    else:\r\n        if is_num(framerate):\r\n            if float(framerate) <= 0:  # fixes invalid string literal\r\n                e = \"Optional input parameter Framerate must be greater than 0\"\r\n                ghenv.Component.AddRuntimeMessage(\r\n                    gh.Kernel.GH_RuntimeMessageLevel.Error, e\r\n                )\r\n                return\r\n        else:\r\n            e = \"Optional input parameter Framerate must be a number\"\r\n            ghenv.Component.AddRuntimeMessage(\r\n                gh.Kernel.GH_RuntimeMessageLevel.Error, e\r\n            )\r\n            return\r\n\r\n    if start_frame is None:\r\n        start_frame = io.im.get_start_number()\r\n    else:\r\n        first_frame = io.im.get_start_number()\r\n        last_frame = first_frame + len(io.im.get_sequence_files(False)) - 1\r\n        if is_integer_num(start_frame):\r\n            if first_frame > int(float(start_frame)) or \\\r\n                    int(float(start_frame)) >= last_frame:\r\n                e = \"Optional input parameter StartFrame must be bigger than or \"\r\n                e += \"equal to {}, or smaller than {}\".format(first_frame, last_frame)\r\n                ghenv.Component.AddRuntimeMessage(\r\n                    gh.Kernel.GH_RuntimeMessageLevel.Error, e\r\n                )\r\n                return\r\n            start_frame = int(start_frame)\r\n        else:\r\n            e = \"Optional input parameter StartFrame must be an integer\"\r\n            ghenv.Component.AddRuntimeMessage(\r\n                gh.Kernel.GH_RuntimeMessageLevel.Error, e\r\n            )\r\n            return\r\n\r\n    if video_format is None:\r\n        video_format = \"MP4\"  # default value\r\n    else:\r\n        if isinstance(video_format, str) and not is_integer_num(video_format):\r\n            vformat = video_format.strip().upper().replace(\".\", \"\")\r\n            if vformat not in VID_FORMATS:\r\n                e = \"{} is not a valid video format, \".format(video_format)\r\n                e += \"currently available formats include: {}\" \\\r\n                    .format(\", \".join(VID_FORMATS))\r\n                ghenv.Component.AddRuntimeMessage(\r\n                    gh.Kernel.GH_RuntimeMessageLevel.Error, e\r\n                )\r\n                return\r\n            video_format = vformat\r\n        elif is_integer_num(video_format):\r\n            idx = int(float(video_format))\r\n            if idx < 0 or idx >= len(VID_FORMATS):\r\n                options = [\"{}: {}\".format(i, fmt)\r\n                           for i, fmt in enumerate(VID_FORMATS)]\r\n                e = \"{} is not a valid a video format, \".format(idx)\r\n                e += \"currently available formats include: {}\" \\\r\n                    .format(\", \".join(options))\r\n                ghenv.Component.AddRuntimeMessage(\r\n                    gh.Kernel.GH_RuntimeMessageLevel.Error, e\r\n                )\r\n                return\r\n            video_format = VID_FORMATS[idx]\r\n        else:\r\n            e = \"Optional input parameter VideoFormat must be a string, \" \\\r\n                + \"representing a video file extension, or an integer \" \\\r\n                + \"number from 0 to {}\".format(len(VID_FORMATS) - 1)\r\n            ghenv.Component.AddRuntimeMessage(\r\n                gh.Kernel.GH_RuntimeMessageLevel.Error, e\r\n            )\r\n            return\r\n\r\n    if video_bitrate is None:\r\n        video_bitrate = 5.0  # default megabytes value\r\n    else:\r\n        if is_num(video_bitrate):\r\n            if float(video_bitrate) < 0.1 or float(video_bitrate) > 12.0:\r\n                e = \"Optional input parameter VideoBitrate must be greater \" \\\r\n                    + \"than or equal to 0.1, and less than or equal to 12.0\"\r\n                ghenv.Component.AddRuntimeMessage(\r\n                    gh.Kernel.GH_RuntimeMessageLevel.Error, e\r\n                )\r\n                return\r\n            else:\r\n                # Convert from megabytes to octets and round to closest integer\r\n                video_bitrate = float(video_bitrate)\r\n        else:\r\n            e = \"Optional input parameter VideoBitrate must be a number \" \\\r\n                + \"greater than or equal to 0.1, and less than or equal to 12.0\"\r\n            ghenv.Component.AddRuntimeMessage(\r\n                gh.Kernel.GH_RuntimeMessageLevel.Error, e\r\n            )\r\n            return\r\n\r\n    if loop is None:\r\n        loop = 0  # default value\r\n    else:\r\n        if is_integer_num(loop):\r\n            if int(float(loop)) < 0:  # fixes invalid string literal\r\n                e = \"Optional input parameter Loop must be greater than \" \\\r\n                    + \"or equal to 0\"\r\n                ghenv.Component.AddRuntimeMessage(\r\n                    gh.Kernel.GH_RuntimeMessageLevel.Error, e\r\n                )\r\n                return\r\n            elif int(float(loop)) >= 15:  # excessive loop count message\r\n                msg = \"Setting an excessively high loop count for videos \" \\\r\n                      + \"can lead to huge file sizes and crash Rhino, \" \\\r\n                      + \"while FFmpeg keeps running in the background\"\r\n                ghenv.Component.AddRuntimeMessage(\r\n                    gh.Kernel.GH_RuntimeMessageLevel.Remark, msg\r\n                )\r\n            else:\r\n                loop = int(loop)\r\n        else:\r\n            e = \"Optional input parameter Loop must be an integer\"\r\n            ghenv.Component.AddRuntimeMessage(\r\n                gh.Kernel.GH_RuntimeMessageLevel.Error, e\r\n            )\r\n            return\r\n\r\n    # Configure the settings\r\n    st = SettingsFramesToVideo(\r\n        io, framerate, start_frame, video_format, video_bitrate, loop\r\n    )\r\n\r\n    return st\r\n\r\n\r\nif __name__ == \"__main__\":\r\n    Settings = main(IO, Framerate, StartFrame, Format, Bitrate, Loop)\r\n",
  "language": "python",
  "imports": [
    "Rhino"
  ],
  "has_docstring": true
}