{
  "source_url": "https://discourse.mcneel.com/t/surface-to-mesh-python/169332",
  "topic_id": 169332,
  "title": "Surface to mesh python",
  "question": "First I’m working on a code that converts files and generates a mesh. An error occurs while converting surface to mesh.\n\n\nTraceback (most recent call last):\n\nFile “C:\\Users\\jjang\\Desktop\\YG2\\nurbs_file\\convert_file.py”, line 113, in\n\nconvert_to_mesh_and_save_as_ply(objects, f’{filename}.ply’)\n\nFile “C:\\Users\\jjang\\Desktop\\YG2\\nurbs_file\\convert_file.py”, line 75, in convert_to_mesh_and_save_as_ply\n\nmesh = rh.Mesh.CreateFromSurface(surface)\n\nAttributeError: type object ‘rhino3dm._rhino3dm.Mesh’ has no attribute ‘CreateFromSurface’\n\n\nIs there any other good way to generate mesh on surface?\n\n\nimport math\nimport rhino3dm\nimport rhino3dm as rh\nimport ezdxf\nfrom ezdxf.math import BSpline\nimport numpy as np\nfrom plyfile import PlyData, PlyElement\nimport os\n\n\n# 곡선을 DXF 파일로 저장하는 함수\ndef save_curves_as_dxf(curves, filename):\n    doc = ezdxf.new('R2010')\n    msp = doc.modelspace()\n\n    for curve in curves:\n        if isinstance(curve, rh.LineCurve):  # 직선 곡선\n            start = curve.PointAtStart\n            end = curve.PointAtEnd\n            msp.add_line((start.X, start.Y, start.Z), (end.X, end.Y, end.Z))\n        elif isinstance(curve, rh.ArcCurve):\n            arc = curve.Arc\n            # 아크의 중심, 반지름, 시작 각도, 끝 각도를 사용\n            msp.add_arc(\n                center=(arc.Center.X, arc.Center.Y, arc.Center.Z),\n                radius=arc.Radius,\n                start_angle=math.degrees(arc.StartAngle),\n                end_angle=math.degrees(arc.EndAngle),\n                is_counter_clockwise=True\n            )\n\n        elif isinstance(curve, rh.NurbsCurve):\n            # 곡선의 파라미터 범위를 얻음\n            t0 = curve.Domain.T0  # 시작 파라미터\n            t1 = curve.Domain.T1  # 끝 파라미터\n            point_count = max(100, len(curve.Points) * 2)  # 충분한 분해능을 위해 점의 개수 조정\n            points = []\n\n            # 곡선을 여러 점들로 이산화\n            for i in range(point_count + 1):\n                t = t0 + (t1 - t0) * i / point_count\n                pt = curve.PointAt(t)\n                points.append((pt.X, pt....",
  "code_blocks": [
    {
      "code": "import math\nimport rhino3dm\nimport rhino3dm as rh\nimport ezdxf\nfrom ezdxf.math import BSpline\nimport numpy as np\nfrom plyfile import PlyData, PlyElement\nimport os\n\n\n# 곡선을 DXF 파일로 저장하는 함수\ndef save_curves_as_dxf(curves, filename):\n    doc = ezdxf.new('R2010')\n    msp = doc.modelspace()\n\n    for curve in curves:\n        if isinstance(curve, rh.LineCurve):  # 직선 곡선\n            start = curve.PointAtStart\n            end = curve.PointAtEnd\n            msp.add_line((start.X, start.Y, start.Z), (end.X, end.Y, end.Z))\n        elif isinstance(curve, rh.ArcCurve):\n            arc = curve.Arc\n            # 아크의 중심, 반지름, 시작 각도, 끝 각도를 사용\n            msp.add_arc(\n                center=(arc.Center.X, arc.Center.Y, arc.Center.Z),\n                radius=arc.Radius,\n                start_angle=math.degrees(arc.StartAngle),\n                end_angle=math.degrees(arc.EndAngle),\n                is_counter_clockwise=True\n            )\n\n        elif isinstance(curve, rh.NurbsCurve):\n            # 곡선의 파라미터 범위를 얻음\n            t0 = curve.Domain.T0  # 시작 파라미터\n            t1 = curve.Domain.T1  # 끝 파라미터\n            point_count = max(100, len(curve.Points) * 2)  # 충분한 분해능을 위해 점의 개수 조정\n            points = []\n\n            # 곡선을 여러 점들로 이산화\n            for i in range(point_count + 1):\n                t = t0 + (t1 - t0) * i / point_count\n                pt = curve.PointAt(t)\n                points.append((pt.X, pt.Y, pt.Z))\n\n            # 폴리라인으로 변환된 점들을 DXF 파일에 추가\n            msp.add_lwpolyline(points)\n\n\n        elif isinstance(curve, rh.PolylineCurve):\n            polyline = curve.ToPolyline()  # PolylineCurve를 Polyline 객체로 변환\n            points = [(pt.X, pt.Y, pt.Z) for pt in polyline]  # Polyline의 점들을 가져옴\n            msp.add_lwpolyline(points)\n\n\n    doc.saveas(filename)\n\n\ndef explode_brep_to_surfaces(brep):\n    return [brep.Faces[i].UnderlyingSurface() for i in range(len(brep.Faces))]\n\ndef convert_to_mesh_and_save_as_ply(objects, filename):\n    vertices = []  # 메시의 정점들을 저장할 리스트\n    faces = []     # 메시의 면들을 저장할 리스트\n\n    for obj in objects:\n        surfaces = []\n\n        if isinstance(obj, rh.Brep):\n            # Brep을 개별 서피스로 분해\n            surfaces.extend(explode_brep_to_surfaces(obj))\n        elif isinstance(obj, rh.Surface):\n            # 서피스 객체인 경우 리스트에 추가\n            surfaces.append(obj)\n\n        for surface in surfaces:\n            mesh = rh.Mesh.CreateFromSurface(surface)\n            if mesh:\n                start_index = len(vertices)\n                vertices.extend([v for v in mesh.Vertices])\n                faces.extend([[v + start_index for v in f] for f in mesh.Faces])\n\n    # 정점과 면 데이터를 PlyElement 형식으로 변환\n    vertex_element = np.array(vertices, dtype=[('x', 'f4'), ('y', 'f4'), ('z', 'f4')])\n    face_element = np.array(faces, dtype=[('vertex_indices', 'i4', (3,))])\n\n    ply_data = PlyData([PlyElement.describe(vertex_element, 'vertex'),\n                        PlyElement.describe(face_element, 'face')], text=True)\n    ply_data.write(filename)\n    pass\n\n# 파일에서 포인트 클라우드 추출하는 함수\ndef extract_pointcloud_from_file(filename):\n    # 파일 형식에 따른 포인트 클라우드 추출 로직 필요\n    return np.random.rand(100, 3)  # 예시: 랜덤 포인트 클라우드 생성\n\n# 두 포인트 클라우드를 병합하여 PLY 파일로 저장하는 함수\ndef merge_and_save_pointclouds_as_ply(pointcloud1, pointcloud2, filename):\n    merged_pointcloud = np.vstack((pointcloud1, pointcloud2))\n    # PLY 파일 저장 로직 구현 필요\n    pass\n\n# Rhino 3dm 파일 불러오기\nmodel = rh.File3dm.Read('C:/Users/jjang/Desktop/YG2/nurbs_file/1113.3dm')\n\n# 객체 분류\ncurves = [obj.Geometry for obj in model.Objects if obj.Geometry.ObjectType == rh.ObjectType.Curve]\nobjects = [obj.Geometry for obj in model.Objects if obj.Geometry.ObjectType in [rh.ObjectType.Brep, rh.ObjectType.Surface]]\n\n# 파일 이름 추출 (확장자 제외)\nfilename = os.path.splitext('C:/Users/jjang/Desktop/YG2/nurbs_file/1113.3dm')[0]\n\n# DXF 및 PLY 파일 저장\nsave_curves_as_dxf(curves, f'{filename}.dxf')\nconvert_to_mesh_and_save_as_ply(objects, f'{filename}.ply')\n\n# 포인트 클라우드 추출 및 병합\n#pointcloud_dxf = extract_pointcloud_from_file(f'{filename}.ply')\n#pointcloud_ply = extract_pointcloud_from_file(f'{filename}.ply')\n#merge_and_save_pointclouds_as_ply(pointcloud_dxf, pointcloud_ply, f'{filename}_merged.ply')",
      "language": "python",
      "author": "장유경",
      "post_number": 1,
      "is_solution": false
    }
  ],
  "tags": [
    "file-io",
    "geometry",
    "mesh",
    "nurbs",
    "python"
  ],
  "has_accepted_answer": true,
  "category_id": 11,
  "posts_count": 5,
  "views": 612
}