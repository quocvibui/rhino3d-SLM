{
  "source_url": "https://github.com/a01110946/timber_framing_generator/blob/0b689e23c0ee24a9cfbdf280b219f659a54afd43/src/timber_framing_generator/framing_elements/king_studs.py",
  "repo": "a01110946/timber_framing_generator",
  "repo_stars": 3,
  "repo_description": "A Python tool bridging Revit and Rhino through Rhino.Inside.Revit to automate timber frame design. Processes Revit walls to generate complete framing solutions including studs, plates, headers, and cripples. Features intelligent wall decomposition, opening analysis, and automated documentation generation.",
  "license": "unknown",
  "filepath": "src/timber_framing_generator/framing_elements/king_studs.py",
  "instruction": "File: timber_framing_generator/framing_elements/king_studs.py",
  "code": "# File: timber_framing_generator/framing_elements/king_studs.py\n\nfrom typing import Dict, List, Any, Tuple\nimport Rhino.Geometry as rg\nfrom src.timber_framing_generator.framing_elements.plate_geometry import PlateGeometry\nfrom src.timber_framing_generator.config.framing import FRAMING_PARAMS, get_framing_param\nfrom src.timber_framing_generator.framing_elements.framing_geometry import (\n    create_stud_profile,\n)\nfrom src.timber_framing_generator.utils.safe_rhino import safe_create_extrusion\n\n# Import our custom logging module\nfrom ..utils.logging_config import get_logger\n\n# Initialize logger for this module\nlogger = get_logger(__name__)\n\n\ndef debug_stud_position(base_plane: rg.Plane, u_coord: float, stud_depth: float):\n    \"\"\"Helps visualize and verify stud positioning relative to openings.\"\"\"\n    inner_face = base_plane.PointAt(u_coord + stud_depth / 2, 0, 0)\n    outer_face = base_plane.PointAt(u_coord - stud_depth / 2, 0, 0)\n    center = base_plane.PointAt(u_coord, 0, 0)\n\n    logger.debug(f\"Stud position check:\")\n    logger.debug(f\"- Center: {center}\")\n    logger.debug(f\"- Inner face: {inner_face}\")\n    logger.debug(f\"- Outer face: {outer_face}\")\n\n\ndef create_king_studs(\n    wall_data: Dict[str, Any],\n    opening_data: Dict[str, Any],\n    plate_data: Dict[str, float],\n    framing_params: Dict[str, Any],\n) -> Tuple[List[rg.Brep], Dict[str, List[rg.GeometryBase]]]:\n    \"\"\"\n    Creates king studs with debug geometry.\n\n    Returns a tuple of:\n    - List of king stud Breps\n    - Dictionary of debug geometry containing:\n        - points: List[rg.Point3d]\n        - planes: List[rg.Plane]\n        - profiles: List[rg.Rectangle3d]\n        - paths: List[rg.Curve]\n    \"\"\"\n    logger.info(\"Creating king studs\")\n    logger.debug(f\"Wall data: {wall_data}\")\n    logger.debug(f\"Opening data: {opening_data}\")\n    logger.debug(f\"Plate data: {plate_data}\")\n    logger.debug(f\"Framing params: {framing_params}\")\n    \n    # Initialize debug geometry collections\n    debug_geom = {\"points\": [], \"planes\": [], \"profiles\": [], \"paths\": []}\n\n    try:\n        # Get base geometry and parameters\n        base_plane = wall_data[\"base_plane\"]\n        debug_geom[\"planes\"].append(base_plane)\n        logger.debug(\"Retrieved base plane from wall data\")\n\n        # 1. Extract dimensions\n        stud_width = framing_params.get(\"stud_width\", 1.5 / 12)\n        stud_depth = framing_params.get(\"stud_depth\", 3.5 / 12)\n        trimmer_width = framing_params.get(\"trimmer_width\", 1.5 / 12)\n        king_stud_width = framing_params.get(\"king_stud_width\", 1.5 / 12)\n\n        logger.debug(\"Dimensions:\")\n        logger.debug(f\"  Stud width: {stud_width}\")\n        logger.debug(f\"  Stud depth: {stud_depth}\")\n        logger.debug(f\"  Trimmer width: {trimmer_width}\")\n        logger.debug(f\"  King stud width: {king_stud_width}\")\n\n        # 2. Get elevations - convert from absolute to relative (above base plane origin)\n        # BUG FIX: plate_data elevations are absolute Z coordinates, but\n        # base_plane.PointAt() adds the v parameter to origin.Z, causing double elevation\n        base_z = base_plane.Origin.Z\n        bottom_elevation = plate_data[\"bottom_plate_elevation\"] - base_z\n        top_elevation = plate_data[\"top_elevation\"] - base_z\n\n        logger.debug(\"Elevations (relative to base plane origin):\")\n        logger.debug(f\"  Base plane Z: {base_z}\")\n        logger.debug(f\"  Bottom (relative): {bottom_elevation}\")\n        logger.debug(f\"  Top (relative): {top_elevation}\")\n\n        # 3. Calculate horizontal positions\n        opening_start = opening_data[\"start_u_coordinate\"]\n        opening_width = opening_data[\"rough_width\"]\n\n        left_u = opening_start - trimmer_width - (king_stud_width / 2)\n        right_u = opening_start + opening_width + trimmer_width + (king_stud_width / 2)\n        \n        logger.debug(\"Position calculations:\")\n        logger.debug(f\"Opening start: {opening_start}\")\n        logger.debug(f\"Opening width: {opening_width}\")\n        logger.debug(f\"Trimmer offset: {trimmer_width}\")\n        logger.debug(f\"King stud offset: {king_stud_width}\")\n        logger.debug(f\"Left king stud position: {left_u}\")\n        logger.debug(f\"Right king stud position: {right_u}\")\n\n        # 4. Create points using the wall's coordinate system\n        stud_points = []\n        for u_coord in [left_u, right_u]:\n            # Create bottom point\n            logger.debug(f\"Creating points for u_coord = {u_coord}:\")\n            bottom = base_plane.PointAt(\n                u_coord,  # X - Position along wall\n                bottom_elevation,  # Z - Height from base\n                0,  # Y - Center in wall thickness\n            )\n            debug_geom[\"points\"].append(bottom)\n            logger.debug(f\"Resulting point: X={bottom.X}, Y={bottom.Y}, Z={bottom.Z}\")\n            logger.debug(\n                f\"Base plane origin: X={base_plane.Origin.X}, Y={base_plane.Origin.Y}, Z={base_plane.Origin.Z}\"\n            )\n            logger.debug(\n                f\"Base plane X axis: X={base_plane.XAxis.X}, Y={base_plane.XAxis.Y}, Z={base_plane.XAxis.Z}\"\n            )\n\n            # Create top point\n            top = base_plane.PointAt(\n                u_coord,  # X - Same position along wall\n                top_elevation,  # Z - Height at top\n                0,  # Y - Center in wall thickness\n            )\n            debug_geom[\"points\"].append(top)\n            logger.debug(f\"Top point: X={top.X}, Y={top.Y}, Z={top.Z}\")\n\n            # Create path line for visualization\n            path_line = rg.Line(bottom, top)\n            debug_geom[\"paths\"].append(path_line)\n            logger.debug(f\"Created path line with length: {path_line.Length}\")\n\n            stud_points.append((bottom, top))\n\n        # 5. Generate king stud geometry\n        logger.debug(\"Generating king stud geometry\")\n        king_studs = []\n        for i, (bottom, top) in enumerate(stud_points):\n            try:\n                # Calculate path vector\n                path_vector = top - bottom\n                path_length = path_vector.Length\n                logger.debug(f\"King stud {i+1} path length: {path_length}\")\n\n                # Create profile plane\n                stud_plane = rg.Plane(bottom, base_plane.XAxis, base_plane.ZAxis * (-1))\n                debug_geom[\"planes\"].append(stud_plane)\n                logger.debug(f\"Created profile plane for king stud {i+1}\")\n\n                # Create profile\n                profile = create_stud_profile(\n                    bottom, stud_plane, stud_width, stud_depth\n                )\n                debug_geom[\"profiles\"].append(profile)\n                logger.debug(f\"Created profile for king stud {i+1}\")\n\n                profile_curve = profile.ToNurbsCurve()\n                logger.debug(\"Converted profile to NURBS curve\")\n\n                # Create extrusion using safe method\n                extrusion_vector = top - bottom\n                try:\n                    logger.debug(\"Attempting to create extrusion\")\n                    extrusion = safe_create_extrusion(profile_curve, extrusion_vector)\n                    if not (extrusion and hasattr(extrusion, 'IsValid') and extrusion.IsValid):\n                        logger.warning('Invalid extrusion created, will try alternative method')\n                        raise AttributeError('Invalid extrusion created')\n                    \n                    # Convert to Brep with safe handling\n                    if hasattr(extrusion, 'ToBrep'):\n                        king_stud = extrusion.ToBrep(True)\n                    else:\n                        # Already a Brep\n                        king_stud = extrusion\n                \n                except Exception as e:\n                    logger.warning(f'Failed to create extrusion with default method: {str(e)}')\n                    \n                    # Try creating a direct box instead\n                    try:\n                        # Create box using path and profile dimensions\n                        width = framing_params.get(\"king_stud_width\", 1.5 / 12)\n                        depth = framing_params.get(\"framing_depth\", 3.5 / 12)\n                        \n                        # Get the path points\n                        origin = bottom\n                        path_length = (top - bottom).Length\n                        \n                        # Create a box along the vertical axis\n                        logger.debug(f\"Attempting to create box with dimensions w={width}, d={depth}, h={path_length}\")\n                        \n                        # Create a plane for the box\n                        plane = rg.Plane(origin, rg.Vector3d.XAxis, rg.Vector3d.YAxis)\n                        \n                        try:\n                            # Box centered on the stud position\n                            box = rg.Box(\n                                plane,\n                                rg.Interval(-width/2, width/2),\n                                rg.Interval(-depth/2, depth/2),\n                                rg.Interval(0, path_length)\n                            )\n                            king_stud = box.ToBrep()\n                            logger.debug(\"Successfully created box geometry for king stud\")\n                        except Exception as box_error:\n                            logger.warning(f\"Box creation failed: {str(box_error)}\")\n                            \n                            # Try creating an extrusion directly\n                            try:\n                                rect = rg.Rectangle3d(\n                                    rg.Plane(origin, rg.Vector3d.XAxis, rg.Vector3d.YAxis),\n                                    width,\n                                    depth\n                                )\n                                profile_curve = rect.ToNurbsCurve()\n                                king_stud = safe_create_extrusion(profile_curve, top - bottom)\n                                logger.debug(\"Created king stud via direct rectangle extrusion\")\n                            except Exception as rect_error:\n                                logger.warning(f\"Rectangle extrusion failed: {str(rect_error)}\")\n                                king_stud = None\n                    except Exception as fallback_error:\n                        logger.warning(f\"All fallback methods failed: {str(fallback_error)}\")\n                        king_stud = None\n                \n                # Check and add valid king stud\n                if king_stud and hasattr(king_stud, 'IsValid') and king_stud.IsValid:\n                    king_studs.append(king_stud)\n                    logger.debug(f\"Successfully created king stud {i+1}\")\n                else:\n                    logger.warning(f\"Failed to create valid king stud {i+1}\")\n\n            except Exception as e:\n                logger.error(f\"Error creating king stud: {str(e)}\")\n                import traceback\n                logger.error(traceback.format_exc())\n\n        logger.info(f\"Created {len(king_studs)} king studs\")\n        return king_studs, debug_geom\n\n    except Exception as e:\n        logger.error(f\"Error in create_king_studs: {str(e)}\")\n        import traceback\n        logger.error(traceback.format_exc())\n        return [], debug_geom\n\n\nclass KingStudGenerator:\n    \"\"\"\n    Generates king studs for wall openings based on plate boundaries.\n\n    This class coordinates the creation of king studs by:\n    1. Using plate geometry to establish vertical bounds\n    2. Using opening data to determine horizontal positions\n    3. Generating the actual stud geometry with proper profiles\n    \"\"\"\n\n    def __init__(\n        self,\n        wall_data: Dict[str, Any],\n        bottom_plate: PlateGeometry,\n        top_plate: PlateGeometry,\n    ):\n        logger.debug(\"Initializing KingStudGenerator\")\n        logger.debug(f\"Wall data: {wall_data}\")\n        \n        self.wall_data = wall_data\n        self.bottom_plate = bottom_plate\n        self.top_plate = top_plate\n        self.king_studs_cache = {}\n        \n        logger.debug(\"KingStudGenerator initialized\")\n\n    def generate_king_studs(self, opening_data: Dict[str, Any]) -> List[rg.Brep]:\n        \"\"\"Generates king studs for a given opening with detailed debug info.\"\"\"\n        logger.info(f\"Generating king studs for opening\")\n        logger.debug(f\"Opening data: {opening_data}\")\n        \n        # Get boundary data from both plates\n        bottom_data = self.bottom_plate.get_boundary_data()\n        top_data = self.top_plate.get_boundary_data()\n\n        logger.debug(\"Plate boundary data:\")\n        logger.debug(\"Bottom plate:\")\n        logger.debug(f\"  Reference elevation: {bottom_data['reference_elevation']}\")\n        logger.debug(f\"  Boundary elevation: {bottom_data['boundary_elevation']}\")\n        logger.debug(f\"  Thickness: {bottom_data['thickness']}\")\n        logger.debug(\"Top plate:\")\n        logger.debug(f\"  Reference elevation: {top_data['reference_elevation']}\")\n        logger.debug(f\"  Boundary elevation: {top_data['boundary_elevation']}\")\n        logger.debug(f\"  Thickness: {top_data['thickness']}\")\n\n        # Create plate data dictionary with the correct keys\n        plate_data = {\n            \"bottom_plate_elevation\": bottom_data[\"boundary_elevation\"],\n            \"top_elevation\": top_data[\n                \"boundary_elevation\"\n            ],  \n            \"plate_thickness\": bottom_data[\"thickness\"],\n        }\n\n        logger.debug(\"Opening data:\")\n        logger.debug(f\"  {opening_data}\")\n\n        # Initialize debug geometry storage\n        self.debug_geometry = {\"points\": [], \"planes\": [], \"profiles\": [], \"paths\": []}\n\n        # Build framing params - use wall_data config if available, else FRAMING_PARAMS\n        framing_params = {\n            \"stud_width\": get_framing_param(\"stud_width\", self.wall_data, 1.5 / 12),\n            \"stud_depth\": get_framing_param(\"stud_depth\", self.wall_data, 3.5 / 12),\n            \"trimmer_width\": get_framing_param(\"trimmer_width\", self.wall_data, 1.5 / 12),\n            \"king_stud_width\": get_framing_param(\"king_stud_width\", self.wall_data, 1.5 / 12),\n            \"framing_depth\": get_framing_param(\"stud_depth\", self.wall_data, 3.5 / 12),\n        }\n        logger.debug(f\"Using framing params: {framing_params}\")\n\n        # Generate king studs with debug geometry\n        king_studs, debug_geom = create_king_studs(\n            self.wall_data, opening_data, plate_data, framing_params\n        )\n\n        # Store debug geometry\n        self.debug_geometry.update(debug_geom)\n\n        # Log what we created\n        logger.debug(f\"Debug geometry generated:\")\n        logger.debug(f\"  Points: {len(self.debug_geometry['points'])}\")\n        logger.debug(f\"  Planes: {len(self.debug_geometry['planes'])}\")\n        logger.debug(f\"  Profiles: {len(self.debug_geometry['profiles'])}\")\n        logger.debug(f\"  Paths: {len(self.debug_geometry['paths'])}\")\n\n        return king_studs\n",
  "language": "python",
  "imports": [
    "Rhino",
    "Rhino.Geometry"
  ],
  "has_docstring": true
}