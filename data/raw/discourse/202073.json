{
  "source_url": "https://discourse.mcneel.com/t/clash-detection/202073",
  "topic_id": 202073,
  "title": "Clash Detection",
  "question": "@dale\n,\n\n\nBased on our tests with this we can’t get outpoints to return anything in the following cases:\n\n\n\n\nThe breps are overlapping (‘true clash’)\n\n\nThe breps are touching (following a boolean split, for example)\n\n\nThe breps are touching at only a single point in space.\n\n\n\n\nWe’re trying to solve for cases where we have ‘true clashes’ vs. just touching.  Is Rhino.Geometry.Intersect.Intersection.BrepBrep() this correct method for doing this?  If not, can you suggest another method that would accomplish this goal?\n\n\nThanks,\n\n\nDan",
  "code_blocks": [
    {
      "code": "import Rhino\nimport rhinoscriptsyntax as rs\nimport scriptcontext as sc\nimport System\nimport Rhino.Geometry as rg\n\ndef create_layer(layer_name, color):\n    \"\"\"\n    Creates a layer with the specified name and color if it doesn't already exist.\n    \"\"\"\n    if not rs.IsLayer(layer_name):\n        rs.AddLayer(layer_name, color)\n    else:\n        rs.LayerColor(layer_name, color)\n\ndef is_brep_valid(brep_id):\n    \"\"\"\n    Checks if the BRep object is valid.\n    \"\"\"\n    brep = rs.coercebrep(brep_id)\n    return brep.IsValid if brep else False\n\ndef add_invalid_dots(brep_id):\n    \"\"\"\n    Adds a text dot at the location of the invalid BRep object.\n    \"\"\"\n    bbox = rs.BoundingBox(brep_id)\n    if bbox:\n        center_point = rs.PointAdd(bbox[0], bbox[6]) / 2  # Calculate the center of the bounding box\n        rs.AddTextDot(\"Invalid Object\", center_point)\n\ndef add_dot_with_layer(dot_text, point, layer_name):\n    \"\"\"\n    Adds a text dot at the specified point and sets it to the specified layer.\n    \"\"\"\n    current_layer = rs.CurrentLayer()\n    rs.CurrentLayer(layer_name)\n    dot_id = rs.AddTextDot(dot_text, point)\n    rs.CurrentLayer(current_layer)\n    return dot_id\n\ndef clash_detection_optimized():\n    # Setup layers for TOUCHING and CLASHING dots\n    create_layer(\"DOTS::TOUCHING\", (255, 255, 0))  # Yellow for touching\n    create_layer(\"DOTS::CLASHING\", (255, 0, 0))  # Red for clashing\n\n    brep_ids = rs.GetObjects(\"Select multiple Brep objects for clash detection\", rs.filter.polysurface, minimum_count=2)\n    if brep_ids is None or len(brep_ids) < 2:\n        print(\"You must select at least two Brep objects.\")\n        return\n\n    valid_breps = []\n    brep_names = []\n    centerpoints = []\n    no_clash_instances = []\n    clashes = []\n    clash_breps = []\n\n    for brep_id in brep_ids:\n        if is_brep_valid(brep_id):\n            brep = rs.coercebrep(brep_id)\n            valid_breps.append((brep, brep_id))\n            name = rs.ObjectName(brep_id) if rs.ObjectName(brep_id) else str(brep_id)\n            centroid_result = rs.SurfaceVolumeCentroid(brep_id)\n            if centroid_result:\n                centerpoint = centroid_result[0]\n                centerpoints.append(centerpoint)\n                brep_names.append(name)\n            else:\n                print(\"Warning: Could not compute centroid for object '{}'. This object will be excluded from clash detection.\".format(name))\n        else:\n            add_invalid_dots(brep_id)\n\n    if len(valid_breps) < 2:\n        print(\"Valid BRep objects not found or less than two valid objects selected.\")\n        return\n\n    #tolerance = sc.doc.ModelAbsoluteTolerance\n    tolerance = 0.001\n    model_units = rs.UnitSystem()\n    max_distance = 40 * 12 if model_units == 8 else None  # Assumes inches if not, manual change required.\n\n    if max_distance is None:\n        rs.MessageBox(\"This script requires the model units to be in inches. Please change the unit system.\")\n        return\n\n    for i in range(len(valid_breps)):\n        for j in range(i + 1, len(valid_breps)):\n            distance = centerpoints[i].DistanceTo(centerpoints[j])\n            if distance <= max_distance:\n                intersection = Rhino.Geometry.Intersect.Intersection.BrepBrep(valid_breps[i][0], valid_breps[j][0], tolerance)\n                if intersection[0] and len(intersection[1]) > 0:\n                    #print len(intersection[2])\n                    #print len(intersection[1])\n                    points = intersection[2]\n                    curves = intersection[1]\n                    #print curves\n                    #print points\n                    #print intersection[0]\n                    joined = rg.Curve.JoinCurves(curves)\n                    #print joined\n                    #print len(joined)\n                    #for curve in joined:\n                        #print curve.IsClosed\n                        #sc.doc.Objects.AddCurve(curve)\n                        #print curve.Geometry\n                    #for point in points:\n                        #print curve.IsClosed\n                        #sc.doc.Objects.AddPoint(point)\n                        #print curve.Geometry\n                    feedback = \"Touching\" if len(intersection[1]) <= 5 else \"True Clash\" #based on qty of curves returned, very rudimentary.  \n                    layer_name = \"DOTS::TOUCHING\" if feedback == \"Touching\" else \"DOTS::CLASHING\"\n                    point = centerpoints[i]\n                    clash_text = \"{} between '{}' and '{}'\".format(feedback, brep_names[i], brep_names[j])\n                    add_dot_with_layer(clash_text, point, layer_name)\n                    #print(clash_text)\n                    if feedback == \"True Clash\":\n                        clashes.append(feedback) \n                        clash_breps.append(valid_breps[i][1])\n                        clash_breps.append(valid_breps[j][1])\n                else:\n                    no_clash_instances.append((brep_names[i], brep_names[j]))\n\n    if clashes:\n        message = \"{} True Clahses detected.\".format(len(clashes))\n        rs.MessageBox(message, 0, \"Clash Detection Summary\")\n        rs.SelectObjects(clash_breps)\n\nif __name__ == \"__main__\":\n    clash_detection_optimized()",
      "language": "python",
      "author": "lignindes",
      "post_number": 3,
      "is_solution": false
    }
  ],
  "tags": [
    "boolean",
    "file-io",
    "geometry",
    "layers",
    "python",
    "rhinocommon",
    "rhinoscriptsyntax",
    "selection",
    "ui"
  ],
  "has_accepted_answer": false,
  "category_id": 3,
  "posts_count": 6,
  "views": 181
}