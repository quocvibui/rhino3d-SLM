{
  "source_url": "https://github.com/compas-dev/compas/blob/HEAD/src/compas_rhino/devtools.py",
  "repo": "compas-dev/compas",
  "repo_stars": 352,
  "repo_description": "Main library of the COMPAS framework and CAD integrations for Rhino/GH and Blender.",
  "license": "MIT",
  "filepath": "src/compas_rhino/devtools.py",
  "instruction": "Devtools",
  "code": "import os\nimport sys\n\n__all__ = [\n    \"DevTools\",\n]\n\n\nclass DevTools(object):\n    \"\"\"Tools for working with Python code in development mode, unloading, and reloading code.\"\"\"\n\n    def __init__(self):\n        \"\"\"Initializes a new instance of the DevTools class.\"\"\"\n        self.watcher = None\n\n    @staticmethod\n    def unload_modules(top_level_module_name):\n        \"\"\"Unloads all modules named starting with the specified string.\n\n        This function eases the development workflow when editing a library that is\n        used from Rhino/Grasshopper.\n\n        Parameters\n        ----------\n        top_level_module_name : :obj:`str`\n            Name of the top-level module to unload.\n\n        Returns\n        -------\n        list\n            List of unloaded module names.\n        \"\"\"\n        to_remove = [name for name in sys.modules if name.startswith(top_level_module_name)]\n\n        for module in to_remove:\n            sys.modules.pop(module)\n\n        return to_remove\n\n    @classmethod\n    def enable_reloader(cls):\n        \"\"\"Enables the code reload on the current folder.\n\n        The file must have been saved already in order for this to work.\"\"\"\n        cls._manage_reloader(enable=True)\n\n    @classmethod\n    def disable_reloader(cls):\n        \"\"\"Disables the code reload on the current folder.\n\n        The file must have been saved already in order for this to work.\"\"\"\n        cls._manage_reloader(enable=False)\n\n    @classmethod\n    def _manage_reloader(cls, enable):\n        import scriptcontext\n\n        doc_id = scriptcontext.doc.Component.OnPingDocument().DocumentID.ToString()\n        key = \"__compas_devtools_{}__\".format(doc_id)\n        if key in scriptcontext.sticky:\n            reloader = scriptcontext.sticky[key]\n            reloader.stop_watcher()\n            reloader = None\n            del reloader\n\n        if enable:\n            reloader = DevTools()\n            reloader.start_watcher()\n            scriptcontext.sticky[key] = reloader\n\n    @staticmethod\n    def ensure_path():\n        \"\"\"Ensures the current folder is in the system path.\"\"\"\n        # Not sure why we need to import sys inside this method but GH complains otherwise\n        import scriptcontext\n\n        # First ensure the current folder is in the system path\n        filepath = scriptcontext.doc.Component.OnPingDocument().FilePath\n\n        if not filepath:\n            raise Exception(\"It seems this file is not saved, cannot reload files without knowning where to search for them!\")\n\n        dirname = os.path.dirname(filepath)\n        if dirname not in sys.path:\n            sys.path.append(dirname)\n\n        return dirname\n\n    def start_watcher(self):\n        try:\n            from System.IO import FileSystemWatcher  # noqa : F401\n            from System.IO import NotifyFilters  # noqa : F401\n        except ImportError:\n            raise Exception(\"This component requires the System.IO.FileSystemWatcher class to work\")\n\n        dirname = self.ensure_path()\n\n        # Disable previous watchers if any\n        if self.watcher:\n            self.disable()\n\n        # Setup file system watcher on python files\n        self.watcher = FileSystemWatcher()\n        self.watcher.Path = dirname\n        self.watcher.NotifyFilter = NotifyFilters.LastWrite\n        self.watcher.IncludeSubdirectories = False\n        self.watcher.Filter = \"*.py\"\n        self.watcher.Changed += self.on_changed\n        self.watcher.EnableRaisingEvents = True\n\n    def on_changed(self, sender, args):\n        try:\n            # Get module name from full path\n            filename = os.path.basename(args.FullPath)\n            if filename.lower().endswith(\".py\"):\n                module_name = filename.split(\".\")[0]\n\n                # Unload the modified module\n                self.unload_modules(module_name)\n        except Exception:\n            print(\"Something failed during unload, this message will not be printed anywhere thou, deal with it\")\n\n    def stop_watcher(self):\n        try:\n            if self.watcher:\n                self.watcher.Changed\n                self.watcher.Dispose()\n                del self.watcher\n        except:  # noqa : E722\n            pass\n        self.watcher = None\n\n\nunload_modules = DevTools.unload_modules\n",
  "language": "python",
  "imports": [
    "scriptcontext"
  ],
  "has_docstring": false
}