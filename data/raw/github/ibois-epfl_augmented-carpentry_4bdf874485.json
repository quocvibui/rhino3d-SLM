{
  "source_url": "https://github.com/ibois-epfl/augmented-carpentry/blob/414eeb93984fad40a4e57daa60e1bb268cbd406c/py/components/acimexporter/code.py",
  "repo": "ibois-epfl/augmented-carpentry",
  "repo_stars": 15,
  "repo_description": "Main repository hosting the main AR software developed for Augmented Carpentry rersearch at Ibois, Epfl.",
  "license": "GPL-3.0",
  "filepath": "py/components/acimexporter/code.py",
  "instruction": "r: augmented-carpentry-py==1.0.0",
  "code": "#! python3\n\n# r: augmented-carpentry-py==1.0.0\n\nimport sys\nimport os\nimport time\nimport io\n\nimport System\n\nimport Grasshopper\nimport Grasshopper as gh\nfrom Grasshopper.Kernel import GH_RuntimeMessageLevel as RML\nfrom ghpythonlib.componentbase import executingcomponent as component\n\nimport Rhino\nimport Rhino.Geometry as rg\n\nimport typing\n\nimport ACPy\nimport ACPy.ac_acim\nimport ACPy.ac_transformations\nimport ACPy.ac_jointdetector\nimport ACPy.ac_util\nimport ACPy.ac_hole\nimport ACPy.ac_cut\n\nTOL_DOC = Rhino.RhinoDoc.ActiveDoc.ModelAbsoluteTolerance\nACTIVE_DOC = Rhino.RhinoDoc.ActiveDoc\n\n\nclass ACPyAcimExporter(component):\n    def __init__(self):\n        super(ACPyAcimExporter, self).__init__()\n        self._var_output = []\n\n    def RunScript(self,\n        i_acim_path : str,\n        i_transform_back : bool,\n        i_inflate_AABB : bool,\n        i_divide_tolerance : bool,\n        i_dump_data : bool,\n        i_beams : typing.List[rg.Brep],\n        i_GUIDs : typing.List[System.Guid]\n    ):\n        ghenv.Component.Message = f\"ACPyApp v{ACPy.__version__}\"\n\n        o_debug_holes = []\n        o_debug_cuts = []\n        o__debugger_o__ = []\n        o_debug_bbox = []\n        for idx, i_beam in enumerate(i_beams):\n            debug_holes = []\n            debug_cuts = []\n            __debugger_o__ = []\n            debug_bbox = []\n\n            # retrieve the name of the beam from document\n            beam_name = ACPy.ac_util.get_brep_object_name(i_beam, i_GUIDs[idx])\n            ACIM = ACPy.ac_acim.ACIM(out_dir=i_acim_path, \n                                    out_name=beam_name)\n            ACIM.add_timber(beam_name)\n\n            # bring the beam to the XY axis for AC system axis compatibility\n            x_form = ACPy.ac_transformations.pln_2_pln_world_transform(i_beam)\n            \n            try:\n                bbox_b, holes_b, cuts_b, __debugger__ = ACPy.ac_jointdetector.distinguish_holes_cuts(\n                    i_beam,\n                    ACIM,\n                    beam_name,\n                    i_divide_tolerance,\n                    i_inflate_AABB)\n                _ = [debug_holes.append(h) for h in holes_b]\n                _ = [debug_cuts.append(c) for c in cuts_b]\n                _ = [__debugger_o__.append(d) for d in __debugger__]\n                debug_bbox.append(bbox_b)\n            except ValueError as e:\n                print(e)\n                ghenv.Component.AddRuntimeMessage(RML.Error, str(e))\n                ACPy.ac_util.highlight_object_by_GUID(i_GUIDs[idx])\n                break\n            \n            print(\"Joint detector found:\\n\" \\\n                + \"\\t --holes: \" +  str(len(holes_b)) + \"\\n\" \\\n                + \"\\t --cuts: \" + str(len(cuts_b)) + \"\\n\")\n\n            # loading holes and cuts into .acim to exports\n            if holes_b.__len__() != 0:\n                for hole_b in holes_b:\n                    hole_objects = ACPy.ac_hole.parse_data_from_brep(ACIM, str(beam_name), hole_b, bbox_b)\n                    if hole_objects is not None:\n                        _ = [debug_holes.append(h) for h in hole_objects]\n            if cuts_b.__len__() != 0:\n                cut_counter = 1\n                for cut_b in cuts_b:\n                    cut_objects = ACPy.ac_cut.parse_data_from_brep(ACIM, str(beam_name), cut_b, bbox_b)\n                    if cut_objects is not None:\n                        _ = [debug_cuts.append(c) for c in cut_objects]\n\n            if i_dump_data:\n                ACIM.dump_data(is_overwrite=True)\n            \n            # transform back for visualization\n            if i_transform_back:\n                x_form_back = ACPy.ac_transformations.get_inverse_transform(x_form)\n                _ = [h.Transform(x_form_back) for h in debug_holes]\n                _ = [c.Transform(x_form_back) for c in debug_cuts]\n                _ = [d.Transform(x_form_back) for d in __debugger_o__]\n                _ = [b.Transform(x_form_back) for b in debug_bbox]\n\n            _ = [o_debug_holes.append(h) for h in debug_holes]\n            _ = [o_debug_cuts.append(c) for c in debug_cuts]\n            _ = [o__debugger_o__.append(d) for d in __debugger_o__]\n            _ = [o_debug_bbox.append(b) for b in debug_bbox]\n\n        o_holes = o_debug_holes\n        o_cuts = o_debug_cuts\n        # o_AABB = o_debug_bbox\n        # o__debugger__ = o__debugger_o__\n\n        return o_holes, o_cuts\n\n\n# ############################################################################################\n# ## only for DEBUG: erase before componentize\n# ############################################################################################\n# if __name__ == \"__main__\":\n#     comp = ACPyAcimExporter()\n#     o_holes, o_cuts = comp.RunScript(\n#         i_acim_path,\n#         i_transform_back,\n#         i_inflate_AABB,\n#         i_divide_tolerance,\n#         i_dump_data,\n#         i_beams,\n#         i_GUIDs\n#     )",
  "language": "python",
  "imports": [
    "Rhino",
    "Rhino.Geometry",
    "ghpythonlib"
  ],
  "has_docstring": true
}