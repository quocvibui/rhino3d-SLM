{
  "source_url": "https://github.com/germanbodenbender/MACAD-AIA-PREDICTION-MODEL/blob/ead2aff5734dc933ad7f3b7831a1c95673d22881/hops-v01-built_in.py",
  "repo": "germanbodenbender/MACAD-AIA-PREDICTION-MODEL",
  "repo_stars": 1,
  "repo_description": "Testing of the HOPS component on the Com-Vision exercise using the Patter Model ML model from Gabriella Rossi",
  "license": "unknown",
  "filepath": "hops-v01-built_in.py",
  "instruction": "Hops v01 built in",
  "code": "from typing import Literal\nfrom flask import Flask\nimport ghhops_server as hs\nimport rhino3dm\nimport numpy as np\nimport os\nimport sys\nimport tensorflow as tf\nfrom PIL import Image\nfrom matplotlib import pyplot as plt\n\nos.environ['TF_CPP_MIN_LOG_LEVEL'] = '3'\n\napp = Flask(__name__)\nhops = hs.Hops(app)\n\n@hops.component(\n    \"/runml\",\n    name=\"runml\",\n    description=\"Run Machine Learning prediction\",\n    icon=\"examples/pointat.png\",\n    inputs=[\n        hs.HopsCurve(\"Curve\", \"C\", \"Curve to evaluate\"),\n        hs.HopsNumber(\"t\", \"t\", \"Parameter on Curve to evaluate\"),\n    ],\n    outputs=[\n        hs.HopsPoint(\"P\", \"P\", \"Point on curve at t\"),\n    ]\n)\n\n\ndef run_ml():\n    new_model = tf.keras.models.load_model(\"D:\\German Profile\\Desktop\\PREDICTION MODEL\\pattern_model.h5\")\n    new_model.summary()\n    print(\"Model OK\")\n\n    #LOAD QUERY\n    query_flat = np.loadtxt(\"query.txt\") #load\n    query = np.reshape(query_flat,(128,128,3))\n    query = query.astype(np.float32)\n    query_norm = np.multiply(query, 2)\n    query_norm = np.subtract(query_norm , 1)  #normalize -1 to 1, it is already 0 to 1\n    query_t = tf.convert_to_tensor(query_norm)\n    query_t = tf.expand_dims(query_t, 0)\n\n    #MAKE PREDICTION\n    IMG_WIDTH = 128\n    IMG_HEIGHT = 128\n    CHANNELS = 3\n\n    def plot(tensor):\n        array = np.asarray(tensor)\n        array = array.astype('float64')\n        array = array.reshape(IMG_HEIGHT, IMG_WIDTH,CHANNELS)\n        return array\n\n    def generate_images(model, test_input):\n        prediction = model(test_input, training=True)\n\n        # remap to [0,1]\n        test_input = test_input * 0.5 + 0.5\n        prediction = prediction * 0.5 + 0.5\n\n        display_list = [plot(test_input), plot(prediction)]\n        title = ['Input Image', 'Predicted Image']\n\n        for i in range(2):\n            plt.subplot(1, 2, i + 1)\n            plt.title(title[i])\n            # getting the pixel values between [0, 1] to plot it.\n            plt.imshow(display_list[i])\n            plt.axis('off')\n        plt.draw()\n        plt.savefig(\"D:\\German Profile\\Desktop\\PREDICTION MODEL\\log.png\")\n\n        return prediction\n\n    pred = generate_images(new_model,query_t)\n    print(\"Prediction OK\")\n\n    #SAVE TO FOLDER\n    pred = np.reshape(pred,(128,128,3))\n    np.savetxt(\"prediction.txt\", pred.flatten())\n    print(\"text Saved\")\n\n    img = Image.fromarray(np.uint8(pred * 255), 'RGB')\n    img.save(\"pred_image.png\")\n    print(\"imagesaved\")\n\n\nif __name__ == \"__main__\":\n    app.run()",
  "language": "python",
  "imports": [
    "rhino3dm"
  ],
  "has_docstring": false
}