{
  "source_url": "https://github.com/colinlsmatthews/merlin_remote/blob/610962044fe29e4b7616974b53afd56aad5bb400/PythonScripts/ExampleScript.py",
  "repo": "colinlsmatthews/merlin_remote",
  "repo_stars": 0,
  "repo_description": null,
  "license": "unknown",
  "filepath": "PythonScripts/ExampleScript.py",
  "instruction": "Example script",
  "code": "﻿import clr\nimport sys\nimport os\n\nimport clr\nfrom System.Reflection import Assembly\n\nexecuting_assembly = Assembly.GetExecutingAssembly()\nversion = executing_assembly.GetName().Version\n\nroaming_folder = os.getenv('APPDATA')\n\nsys.path.append(r\"D:\\Programs\\Autodesk\\AutoCAD 2024\")\nsys.path.append(roaming_folder + r\"\\Autodesk\\ApplicationPlugins\\AWI Rhino.Inside AutoCAD.bundle\" + str(version) + r\"\\Win64\")\n\nclr.AddReference(\"AWI.RhinoInside.Services\")\nfrom AWI.RhinoInside.Services import *\n\nclr.AddReference(\"AWI.RhinoInside.Interop\")\nimport AWI\nfrom AWI.RhinoInside.Interop.Geometry import *\nfrom AWI.RhinoInside.Interop import *\n\nclr.AddReference(\"AWI.RhinoInside.Core\")\nfrom AWI.RhinoInside.Core import *\nfrom AWI.RhinoInside.Core.Interfaces import *\n\n# AutoCAD File API\nclr.AddReference(\"Acdbmgd\")\nimport Autodesk\nfrom Autodesk.AutoCAD.DatabaseServices import Curve as CadDBCurve\nfrom Autodesk.AutoCAD.DatabaseServices import DBObjectCollection\n\n# AutoCAD Application API\nclr.AddReference(\"accoremgd\")\nfrom Autodesk.AutoCAD.ApplicationServices.Core import Application\n\nimport System\nfrom System import Func\n\nimport Rhino.Geometry as rg\nimport rhinoscriptsyntax as rs\n\n# Document interop\ndocumentMananger = AWI.RhinoInside.Interop.DocumentManager.Instance\ndocument = documentMananger.Document\n\n# Use closeAction.SetCloseAction(CloseActionType) to:\n# 1. Close the document without saving (default) input CloseActionType.Unmodified.\n# 2. Close the document and save changes input CloseActionType.Save.\n# 3. Close the document, save changes, and close the underlying AutoCAD document input CloseActionType.SaveAndClose.\n# Alternatively, if you want to save the document after modifying it you can use document.Transaction(func, true) \n# which sets the save flags to option 2.\ncloseAction = documentMananger.CloseAction\n\n# For converting internal geometry types to Rhino geometry types or visa versa\ninternalGeometryConverter = InternalGeometryConverter.Instance;\n\n# For converting Rhino geometry types to AutoCAD geometry types or visa versa\nrhinoGeometryConverter = RhinoGeometryConverter.Instance;\n\nfrom AWI.RhinoInside.Core import UnitSystem\n# tell the converter your \"internal\" units are inches\ninternal_unit_system = UnitSystem.Inches\n\ndef CreateCADRectangle(transactionManagerWrapper):\n    xyPlane = rg.Plane.WorldXY\n\n    # The command internalUnits = mm therefore these units are in mm.\n    rectangle = rg.Rectangle3d(xyPlane, 23.0, 84.0)\n\n    rectangleCurve = rectangle.ToPolyline().ToPolylineCurve()\n\n    # Conversion methods ending Db convert to curves that can be added to the document\n    # Non-db methods create curves that cannot be added to the document. Units Conversion\n    # is handled dynamically. \n    autoCADCurve = rhinoGeometryConverter.ConvertDb(rectangleCurve)\n\n\n    # Call dispose on any AutoCAD object that implements IDisposable to avoid memory leaks.\n    autoCADCurve.Dispose()\n    rectangleCurve.Dispose()\n\n    return True\n\ndef CreateCADRectangleOLD(transactionManagerWrapper):\n    xyPlane = rg.Plane.WorldXY\n\n    # The command internalUnits = mm therefore these units are in mm.\n    rectangle = rg.Rectangle3d(xyPlane, 1500.0, 4300.0)\n\n    rectangleCurve = rectangle.ToPolyline().ToPolylineCurve()\n\n    # Conversion methods ending Db convert to curves that can be added to the document\n    # Non-db methods create curves that cannot be added to the document. Units Conversion\n    # is handled dynamically. \n    autoCADCurve = rhinoGeometryConverter.ConvertDb(rectangleCurve)\n\n    # Get the model space block table to add the curves to and unwrap it.\n    modelSpace = InteropConverter.Unwrap(transactionManagerWrapper.GetModelSpaceBlockTableRecord(True));\n    \n    # Unwrap the transaction manager\n    transactionManger = InteropConverter.Unwrap(transactionManagerWrapper)\n\n    for dbCurve in autoCADCurves:\n        # Append the curve to the model space.\n        modelSpace.AppendEntity(dbCurve);\n\n        # Add the curve to the document DB.\n        transactionManger.AddNewlyCreatedDBObject(dbCurve, True);\n\n        # Call dispose on any AutoCAD object that implements IDisposable to avoid memory leaks.\n        dbCurve.Dispose()\n\n    return True\n\n# Create a .NET Func<ITransactionManager, T> delegate to pass into Document.Transaction.\nnet_CreateCADRectangle = Func[ITransactionManager, bool](CreateCADRectangle)\n\n# Run the transaction to modify the document.\nsuccess = document.Transaction(net_CreateCADRectangle)\n\n\ndef CreateCADSrf4pt(transactionManagerWrapper):\n    # Create surface points\n    points = [(0,0,0), (20,3,0), (25, 35,0), (-2,30,0)]\n    \n    # Convert to Point3d objects\n    rhinoPoints = [rg.Point3d(x, y, z) for x, y, z in points]\n    \n    # Create surface from points using Rhino common geometry\n    srfGeometry = rg.NurbsSurface.CreateFromCorners(rhinoPoints[0], rhinoPoints[1], rhinoPoints[2], rhinoPoints[3])\n    \n    # Convert surface to Brep for better CAD compatibility\n    brepGeometry = srfGeometry.ToBrep()\n    \n    # Convert the Rhino brep geometry to AutoCAD\n    autoCADSrf = rhinoGeometryConverter.ConvertDb(brepGeometry)\n\n    # Get the model space block table to add the surfaces to and unwrap it.\n    modelSpace = InteropConverter.Unwrap(transactionManagerWrapper.GetModelSpaceBlockTableRecord(True));\n    \n    # Unwrap the transaction manager\n    transactionManger = InteropConverter.Unwrap(transactionManagerWrapper)\n\n    for dbSrf in autoCADSrf:\n        # Append the surface to the model space.\n        modelSpace.AppendEntity(dbSrf);\n\n        # Add the surface to the document DB.\n        transactionManger.AddNewlyCreatedDBObject(dbSrf, True);\n\n        # Call dispose on any AutoCAD object that implements IDisposable to avoid memory leaks.\n        dbSrf.Dispose()  # Fixed: was dbCurve.Dispose(), now dbSrf.Dispose()\n\n    return True\n\n# Create a .NET Func<ITransactionManager, T> delegate to pass into Document.Transaction.\nnet_CreateCADSrf4pt = Func[ITransactionManager, bool](CreateCADSrf4pt)\n\n# Run the transaction to modify the document.\n#success = document.Transaction(net_CreateCADSrf4pt)\n\ndef CreateCADPolySurfaceBox(transactionManagerWrapper):\n    \"\"\"Create a simple box polysurface\"\"\"\n    # Define box dimensions\n    width = 30.0\n    height = 20.0\n    depth = 15.0\n    \n    # Create a box as a polysurface\n    box = rg.Box(rg.Plane.WorldXY, rg.Interval(0, width), rg.Interval(0, height), rg.Interval(0, depth))\n    brepGeometry = box.ToBrep()\n    \n    # Convert the Rhino brep geometry to AutoCAD\n    autoCADPolySrf = rhinoGeometryConverter.ConvertDb(brepGeometry)\n\n    # Get the model space block table to add the surfaces to and unwrap it.\n    modelSpace = InteropConverter.Unwrap(transactionManagerWrapper.GetModelSpaceBlockTableRecord(True))\n    \n    # Unwrap the transaction manager\n    transactionManger = InteropConverter.Unwrap(transactionManagerWrapper)\n\n    for dbSrf in autoCADPolySrf:\n        # Append the surface to the model space.\n        modelSpace.AppendEntity(dbSrf)\n\n        # Add the surface to the document DB.\n        transactionManger.AddNewlyCreatedDBObject(dbSrf, True)\n\n        # Call dispose on any AutoCAD object that implements IDisposable to avoid memory leaks.\n        dbSrf.Dispose()\n\n    return True\n\ndef CreateCADPolySurfaceCylinder(transactionManagerWrapper):\n    \"\"\"Create a cylindrical polysurface\"\"\"\n    # Define cylinder parameters\n    baseCenter = rg.Point3d(0, 0, 0)\n    topCenter = rg.Point3d(0, 0, 25)\n    radius = 10.0\n    \n    # Create cylinder\n    cylinder = rg.Cylinder(rg.Circle(baseCenter, radius), 25.0)\n    brepGeometry = cylinder.ToBrep(True, True)  # True for cap bottom and top\n    \n    # Convert the Rhino brep geometry to AutoCAD\n    autoCADPolySrf = rhinoGeometryConverter.ConvertDb(brepGeometry)\n\n    # Get the model space block table to add the surfaces to and unwrap it.\n    modelSpace = InteropConverter.Unwrap(transactionManagerWrapper.GetModelSpaceBlockTableRecord(True))\n    \n    # Unwrap the transaction manager\n    transactionManger = InteropConverter.Unwrap(transactionManagerWrapper)\n\n    for dbSrf in autoCADPolySrf:\n        # Append the surface to the model space.\n        modelSpace.AppendEntity(dbSrf)\n\n        # Add the surface to the document DB.\n        transactionManger.AddNewlyCreatedDBObject(dbSrf, True)\n\n        # Call dispose on any AutoCAD object that implements IDisposable to avoid memory leaks.\n        dbSrf.Dispose()\n\n    return True\n\ndef CreateCADPolySurfaceFromSurfaces(transactionManagerWrapper, surfaces):\n    \"\"\"Create a polysurface from multiple individual surfaces\"\"\"\n    # Convert surface list to breps\n    breps = []\n    for srf in surfaces:\n        if hasattr(srf, 'ToBrep'):\n            breps.append(srf.ToBrep())\n        else:\n            breps.append(srf)  # Already a brep\n    \n    # Join the breps into a polysurface\n    joinedBreps = rg.Brep.JoinBreps(breps, 0.01)  # 0.01 is tolerance\n    \n    if joinedBreps and len(joinedBreps) > 0:\n        polysurfaceBrep = joinedBreps[0]  # Take the first joined result\n    else:\n        # If joining fails, create a compound brep\n        polysurfaceBrep = rg.Brep()\n        for brep in breps:\n            polysurfaceBrep.Append(brep)\n    \n    # Convert the Rhino brep geometry to AutoCAD\n    autoCADPolySrf = rhinoGeometryConverter.ConvertDb(polysurfaceBrep)\n\n    # Get the model space block table to add the surfaces to and unwrap it.\n    modelSpace = InteropConverter.Unwrap(transactionManagerWrapper.GetModelSpaceBlockTableRecord(True))\n    \n    # Unwrap the transaction manager\n    transactionManger = InteropConverter.Unwrap(transactionManagerWrapper)\n\n    for dbSrf in autoCADPolySrf:\n        # Append the surface to the model space.\n        modelSpace.AppendEntity(dbSrf)\n\n        # Add the surface to the document DB.\n        transactionManger.AddNewlyCreatedDBObject(dbSrf, True)\n\n        # Call dispose on any AutoCAD object that implements IDisposable to avoid memory leaks.\n        dbSrf.Dispose()\n\n    return True\n\ndef CreateCADPolySurfaceCustom(transactionManagerWrapper):\n    \"\"\"Create a custom polysurface from multiple surfaces\"\"\"\n    # Create multiple surfaces that will form a polysurface\n    surfaces = []\n    \n    # Bottom surface\n    bottomPoints = [rg.Point3d(0,0,0), rg.Point3d(20,0,0), rg.Point3d(20,20,0), rg.Point3d(0,20,0)]\n    bottomSrf = rg.NurbsSurface.CreateFromCorners(bottomPoints[0], bottomPoints[1], bottomPoints[2], bottomPoints[3])\n    surfaces.append(bottomSrf)\n    \n    # Top surface (offset up)\n    topPoints = [rg.Point3d(0,0,15), rg.Point3d(20,0,15), rg.Point3d(20,20,15), rg.Point3d(0,20,15)]\n    topSrf = rg.NurbsSurface.CreateFromCorners(topPoints[0], topPoints[1], topPoints[2], topPoints[3])\n    surfaces.append(topSrf)\n    \n    # Side surfaces\n    # Front\n    frontSrf = rg.NurbsSurface.CreateFromCorners(bottomPoints[0], bottomPoints[1], topPoints[1], topPoints[0])\n    surfaces.append(frontSrf)\n    \n    # Right\n    rightSrf = rg.NurbsSurface.CreateFromCorners(bottomPoints[1], bottomPoints[2], topPoints[2], topPoints[1])\n    surfaces.append(rightSrf)\n    \n    # Back\n    backSrf = rg.NurbsSurface.CreateFromCorners(bottomPoints[2], bottomPoints[3], topPoints[3], topPoints[2])\n    surfaces.append(backSrf)\n    \n    # Left\n    leftSrf = rg.NurbsSurface.CreateFromCorners(bottomPoints[3], bottomPoints[0], topPoints[0], topPoints[3])\n    surfaces.append(leftSrf)\n    \n    # Convert surfaces to breps and join them\n    breps = [srf.ToBrep() for srf in surfaces]\n    joinedBreps = rg.Brep.JoinBreps(breps, 0.01)\n    \n    if joinedBreps and len(joinedBreps) > 0:\n        polysurfaceBrep = joinedBreps[0]\n    else:\n        # Create a single brep from all surfaces\n        polysurfaceBrep = rg.Brep()\n        for brep in breps:\n            for face in brep.Faces:\n                polysurfaceBrep.Faces.Add(face)\n    \n    # Convert the Rhino brep geometry to AutoCAD\n    autoCADPolySrf = rhinoGeometryConverter.ConvertDb(polysurfaceBrep)\n\n    # Get the model space block table to add the surfaces to and unwrap it.\n    modelSpace = InteropConverter.Unwrap(transactionManagerWrapper.GetModelSpaceBlockTableRecord(True))\n    \n    # Unwrap the transaction manager\n    transactionManger = InteropConverter.Unwrap(transactionManagerWrapper)\n\n    for dbSrf in autoCADPolySrf:\n        # Append the surface to the model space.\n        modelSpace.AppendEntity(dbSrf)\n\n        # Add the surface to the document DB.\n        transactionManger.AddNewlyCreatedDBObject(dbSrf, True)\n\n        # Call dispose on any AutoCAD object that implements IDisposable to avoid memory leaks.\n        dbSrf.Dispose()\n\n    return True\n\n# Create .NET Func delegates for each function\nnet_CreateCADPolySurfaceBox = Func[ITransactionManager, bool](CreateCADPolySurfaceBox)\nnet_CreateCADPolySurfaceCylinder = Func[ITransactionManager, bool](CreateCADPolySurfaceCylinder)\nnet_CreateCADPolySurfaceCustom = Func[ITransactionManager, bool](CreateCADPolySurfaceCustom)\n\n#To Activate:\n#success = document.Transaction(net_CreateCADPolySurfaceBox)\n#success = document.Transaction(net_CreateCADPolySurfaceCylinder)\n#success = document.Transaction(net_CreateCADPolySurfaceCustom)\n\n# For using the function that takes parameters, you'd need to create a wrapper:\ndef CreatePolySurfaceFromSurfacesWrapper(surfaces_list):\n    def wrapper(transactionManagerWrapper):\n        return CreateCADPolySurfaceFromSurfaces(transactionManagerWrapper, surfaces_list)\n    return wrapper\n\n# Example usage with custom surfaces:\n# my_surfaces = [surface1, surface2, surface3]  # Your list of surfaces\n# wrapper_func = CreatePolySurfaceFromSurfacesWrapper(my_surfaces)\n# net_wrapper = Func[ITransactionManager, bool](wrapper_func)\n# success = document.Transaction(net_wrapper)\n\n####################################################\n\ndef CreateCADLoftedSurfaceSimple(transactionManagerWrapper, add_profile_curves=False):\n    \"\"\"\n    Builds 4 rectangular polylines at different Z levels (in INTERNAL units),\n    lofts them into a Brep surface, converts to AutoCAD DB entities, and appends\n    them to ModelSpace under the active transaction.\n\n    If add_profile_curves=True, it also drops the source profile curves into ModelSpace.\n    \"\"\"\n    # Unwrap DB objects (ModelSpace opened for write)\n    model_space = InteropConverter.Unwrap(transactionManagerWrapper.GetModelSpaceBlockTableRecord(True))\n    transaction = InteropConverter.Unwrap(transactionManagerWrapper)\n\n    # --- 1) Build UN-SCALED Rhino curves (units = your app's InternalUnitSystem)\n    def _closed_polyline_curve(pts):\n        pl = rg.Polyline(pts)\n        pl.Add(pts[0])\n        return pl.ToPolylineCurve()  # IDisposable\n\n    loft_curve1 = _closed_polyline_curve([rg.Point3d( 0,  0,  0), rg.Point3d(20,  0,  0),\n                                          rg.Point3d(20, 15,  0), rg.Point3d( 0, 15,  0)])\n    loft_curve2 = _closed_polyline_curve([rg.Point3d( 2,  1.5, 10), rg.Point3d(18,  1.5, 10),\n                                          rg.Point3d(18, 13.5, 10), rg.Point3d( 2, 13.5, 10)])\n    loft_curve3 = _closed_polyline_curve([rg.Point3d( 4,  3, 20), rg.Point3d(16,  3, 20),\n                                          rg.Point3d(16, 12, 20), rg.Point3d( 4, 12, 20)])\n    loft_curve4 = _closed_polyline_curve([rg.Point3d( 6,  4.5, 30), rg.Point3d(14,  4.5, 30),\n                                          rg.Point3d(14, 10.5, 30), rg.Point3d( 6, 10.5, 30)])\n\n    loft_curves = [loft_curve1, loft_curve2, loft_curve3, loft_curve4]\n\n    # --- 2) Loft to Brep\n    lofted = rg.Brep.CreateFromLoft(loft_curves, rg.Point3d.Unset, rg.Point3d.Unset,\n                                    rg.LoftType.Normal, closed=False)\n    if not lofted or len(lofted) == 0:\n        # Clean up curves if loft failed\n        for c in loft_curves:\n            try: c.Dispose()\n            except: pass\n        print(\"[CreateCADLoftedSurfaceSimple] Loft failed.\")\n        return False\n\n    loft_brep = lofted[0]  # IDisposable\n\n    cad_entities = None\n    try:\n        # --- 3) Convert lofted Brep to AutoCAD DB objects\n        converter = RhinoGeometryConverter.Instance\n        cad_entities = converter.ConvertDb(loft_brep)\n\n        # Some converters return a single entity, others an iterable — normalize\n        if cad_entities is None:\n            print(\"[CreateCADLoftedSurfaceSimple] ConvertDb(loft_brep) returned None.\")\n            return False\n        if not hasattr(cad_entities, \"__iter__\"):\n            cad_entities = [cad_entities]\n\n        # --- 4) Append + register\n        for db_obj in cad_entities:\n            obj_id = model_space.AppendEntity(db_obj)\n            transaction.AddNewlyCreatedDBObject(db_obj, True)\n            # Safe to dispose after registering with the transaction\n            db_obj.Dispose()\n\n        # (Optional) also drop the Rhino profile curves into ModelSpace (as curves)\n        if add_profile_curves:\n            for c in loft_curves:\n                db_curve = converter.ConvertDb(c)\n                if db_curve is None:\n                    continue\n                if not hasattr(db_curve, \"__iter__\"):\n                    db_curve = [db_curve]\n                for ent in db_curve:\n                    obj_id = model_space.AppendEntity(ent)\n                    transaction.AddNewlyCreatedDBObject(ent, True)\n                    ent.Dispose()\n\n        print(\"[CreateCADLoftedSurfaceSimple] Loft and (optional) profiles created.\")\n        return True\n\n    finally:\n        # --- 5) Dispose Rhino objects\n        try:\n            loft_brep.Dispose()\n        except: pass\n        for c in loft_curves:\n            try: c.Dispose()\n            except: pass\n\n# Create .NET Func delegate\nnet_CreateCADLoftedSurfaceSimple = Func[ITransactionManager, bool](CreateCADLoftedSurfaceSimple)\n\n# Usage:\n#success = document.Transaction(net_CreateCADLoftedSurfaceSimple)\n\n#########################################\n\ndef CreateCADUndulatingLoftedSurface(transactionManagerWrapper):\n    # Get the model space block table and transaction manager\n    modelSpace = InteropConverter.Unwrap(transactionManagerWrapper.GetModelSpaceBlockTableRecord(True))\n    transactionManger = InteropConverter.Unwrap(transactionManagerWrapper)\n    \n    # Scale factor for curves only\n    scale = 25.4  # Convert inches to mm for curves\n    \n    # STEP 1: Create ORIGINAL unscaled undulating curves using polylines for the lofted surface\n    \n    # Curve 1 - Bottom undulating curve\n    points1_orig = [\n        rg.Point3d(0, 0, 0),\n        rg.Point3d(5, 3, 0),\n        rg.Point3d(10, -2, 0),\n        rg.Point3d(15, 4, 0),\n        rg.Point3d(20, 1, 0),\n        rg.Point3d(25, -1, 0),\n        rg.Point3d(30, 2, 0)\n    ]\n    polyline1_orig = rg.Polyline(points1_orig)\n    loftCurve1 = polyline1_orig.ToPolylineCurve()\n    \n    # Curve 2 - Second level - different undulation pattern\n    points2_orig = [\n        rg.Point3d(2, 1, 8),\n        rg.Point3d(7, -2, 8),\n        rg.Point3d(12, 4, 8),\n        rg.Point3d(17, 0, 8),\n        rg.Point3d(22, 3, 8),\n        rg.Point3d(27, -1, 8),\n        rg.Point3d(32, 2, 8)\n    ]\n    polyline2_orig = rg.Polyline(points2_orig)\n    loftCurve2 = polyline2_orig.ToPolylineCurve()\n    \n    # Curve 3 - Third level - more pronounced undulation\n    points3_orig = [\n        rg.Point3d(4, -1, 16),\n        rg.Point3d(9, 5, 16),\n        rg.Point3d(14, -3, 16),\n        rg.Point3d(19, 4, 16),\n        rg.Point3d(24, 0, 16),\n        rg.Point3d(29, 3, 16),\n        rg.Point3d(34, 1, 16)\n    ]\n    polyline3_orig = rg.Polyline(points3_orig)\n    loftCurve3 = polyline3_orig.ToPolylineCurve()\n    \n    # Curve 4 - Top curve - gentle waves\n    points4_orig = [\n        rg.Point3d(6, 2, 24),\n        rg.Point3d(11, -1, 24),\n        rg.Point3d(16, 3, 24),\n        rg.Point3d(21, 1, 24),\n        rg.Point3d(26, -2, 24),\n        rg.Point3d(31, 2, 24),\n        rg.Point3d(36, 0, 24)\n    ]\n    polyline4_orig = rg.Polyline(points4_orig)\n    loftCurve4 = polyline4_orig.ToPolylineCurve()\n    \n    loftCurves = [loftCurve1, loftCurve2, loftCurve3, loftCurve4]\n    \n    # STEP 2: Create lofted surface from UNSCALED curves (this will be OPEN)\n    loftedBreps = rg.Brep.CreateFromLoft(loftCurves, rg.Point3d.Unset, rg.Point3d.Unset, rg.LoftType.Normal, False)\n    \n    if loftedBreps and len(loftedBreps) > 0:\n        loftedBrep = loftedBreps[0]\n        \n        # Convert the lofted surface to AutoCAD\n        autoCADSrf = rhinoGeometryConverter.ConvertDb(loftedBrep)\n\n        for dbSrf in autoCADSrf:\n            # Append the surface to the model space\n            modelSpace.AppendEntity(dbSrf)\n            # Add the surface to the document DB\n            transactionManger.AddNewlyCreatedDBObject(dbSrf, True)\n            # Dispose of the surface\n            dbSrf.Dispose()\n    \n    # STEP 3: Create and add SCALED curves as separate entities\n    \n    # Curve 1 - Bottom undulating curve (scaled)\n    points1 = [rg.Point3d(x*scale, y*scale, z*scale) for x, y, z in [(0, 0, 0), (5, 3, 0), (10, -2, 0), (15, 4, 0), (20, 1, 0), (25, -1, 0), (30, 2, 0)]]\n    polyline1 = rg.Polyline(points1)\n    curve1 = polyline1.ToPolylineCurve()\n    \n    autoCADCurves1 = rhinoGeometryConverter.ConvertDb(curve1)\n    for dbCurve in autoCADCurves1:\n        modelSpace.AppendEntity(dbCurve)\n        transactionManger.AddNewlyCreatedDBObject(dbCurve, True)\n        dbCurve.Dispose()\n    \n    # Curve 2 - Second level (scaled)\n    points2 = [rg.Point3d(x*scale, y*scale, z*scale) for x, y, z in [(2, 1, 8), (7, -2, 8), (12, 4, 8), (17, 0, 8), (22, 3, 8), (27, -1, 8), (32, 2, 8)]]\n    polyline2 = rg.Polyline(points2)\n    curve2 = polyline2.ToPolylineCurve()\n    \n    autoCADCurves2 = rhinoGeometryConverter.ConvertDb(curve2)\n    for dbCurve in autoCADCurves2:\n        modelSpace.AppendEntity(dbCurve)\n        transactionManger.AddNewlyCreatedDBObject(dbCurve, True)\n        dbCurve.Dispose()\n    \n    # Curve 3 - Third level (scaled)\n    points3 = [rg.Point3d(x*scale, y*scale, z*scale) for x, y, z in [(4, -1, 16), (9, 5, 16), (14, -3, 16), (19, 4, 16), (24, 0, 16), (29, 3, 16), (34, 1, 16)]]\n    polyline3 = rg.Polyline(points3)\n    curve3 = polyline3.ToPolylineCurve()\n    \n    autoCADCurves3 = rhinoGeometryConverter.ConvertDb(curve3)\n    for dbCurve in autoCADCurves3:\n        modelSpace.AppendEntity(dbCurve)\n        transactionManger.AddNewlyCreatedDBObject(dbCurve, True)\n        dbCurve.Dispose()\n    \n    # Curve 4 - Top curve (scaled)\n    points4 = [rg.Point3d(x*scale, y*scale, z*scale) for x, y, z in [(6, 2, 24), (11, -1, 24), (16, 3, 24), (21, 1, 24), (26, -2, 24), (31, 2, 24), (36, 0, 24)]]\n    polyline4 = rg.Polyline(points4)\n    curve4 = polyline4.ToPolylineCurve()\n    \n    autoCADCurves4 = rhinoGeometryConverter.ConvertDb(curve4)\n    for dbCurve in autoCADCurves4:\n        modelSpace.AppendEntity(dbCurve)\n        transactionManger.AddNewlyCreatedDBObject(dbCurve, True)\n        dbCurve.Dispose()\n\n    return True\n\n# Create .NET Func delegate for the working function\nnet_CreateCADUndulatingLoftedSurface = Func[ITransactionManager, bool](CreateCADUndulatingLoftedSurface)\n\n# Usage:\n#success = document.Transaction(net_CreateCADUndulatingLoftedSurface)\n\n#############################################\n\ndef CreateCADHybridNurbsLoftedSurfaceWPolyLines(transactionManagerWrapper):\n    # Get the model space block table and transaction manager\n    modelSpace = InteropConverter.Unwrap(transactionManagerWrapper.GetModelSpaceBlockTableRecord(True))\n    transactionManger = InteropConverter.Unwrap(transactionManagerWrapper)\n    \n    # Scale factor for curves only\n    scale = 25.4  # Convert inches to mm for curves\n    \n    import math\n    \n    # STEP 1: Create ORIGINAL unscaled NURBS curves for the lofted surface\n    \n    # Curve 1 - Bottom undulating curve\n    points1_orig = [\n        rg.Point3d(0, 0, 0),\n        rg.Point3d(5, 3, 0),\n        rg.Point3d(10, -2, 0),\n        rg.Point3d(15, 4, 0),\n        rg.Point3d(20, 1, 0),\n        rg.Point3d(25, -1, 0),\n        rg.Point3d(30, 2, 0)\n    ]\n    loftCurve1 = rg.Curve.CreateInterpolatedCurve(points1_orig, 3)\n    \n    # Curve 2 - Second level\n    points2_orig = [\n        rg.Point3d(2, 1, 8),\n        rg.Point3d(7, -2, 8),\n        rg.Point3d(12, 4, 8),\n        rg.Point3d(17, 0, 8),\n        rg.Point3d(22, 3, 8),\n        rg.Point3d(27, -1, 8),\n        rg.Point3d(32, 2, 8)\n    ]\n    loftCurve2 = rg.Curve.CreateInterpolatedCurve(points2_orig, 3)\n    \n    # Curve 3 - Third level\n    points3_orig = [\n        rg.Point3d(4, -1, 16),\n        rg.Point3d(9, 5, 16),\n        rg.Point3d(14, -3, 16),\n        rg.Point3d(19, 4, 16),\n        rg.Point3d(24, 0, 16),\n        rg.Point3d(29, 3, 16),\n        rg.Point3d(34, 1, 16)\n    ]\n    loftCurve3 = rg.Curve.CreateInterpolatedCurve(points3_orig, 3)\n    \n    # Curve 4 - Top curve\n    points4_orig = [\n        rg.Point3d(6, 2, 24),\n        rg.Point3d(11, -1, 24),\n        rg.Point3d(16, 3, 24),\n        rg.Point3d(21, 1, 24),\n        rg.Point3d(26, -2, 24),\n        rg.Point3d(31, 2, 24),\n        rg.Point3d(36, 0, 24)\n    ]\n    loftCurve4 = rg.Curve.CreateInterpolatedCurve(points4_orig, 3)\n    \n    loftCurves = [loftCurve1, loftCurve2, loftCurve3, loftCurve4]\n    \n    # STEP 2: Create PURE NURBS lofted surface\n    loftedBreps = rg.Brep.CreateFromLoft(loftCurves, rg.Point3d.Unset, rg.Point3d.Unset, rg.LoftType.Normal, False)\n    \n    if loftedBreps and len(loftedBreps) > 0:\n        loftedBrep = loftedBreps[0]\n        \n        # Convert the NURBS surface directly (this works!)\n        autoCADSrf = rhinoGeometryConverter.ConvertDb(loftedBrep)\n        for dbSrf in autoCADSrf:\n            modelSpace.AppendEntity(dbSrf)\n            transactionManger.AddNewlyCreatedDBObject(dbSrf, True)\n            dbSrf.Dispose()\n    \n    # STEP 3: Create SCALED curves as PolyCurves with smooth 3-degree segments\n    \n    all_points_orig = [points1_orig, points2_orig, points3_orig, points4_orig]\n    #POLYLINE CONVERSION IS BELOW!!!!!!\n    for points_orig in all_points_orig:\n        # Scale the original control points\n        import clr\n        clr.AddReference(\"AcDbMgd\")  # needed for Autodesk.AutoCAD.Geometry\n\n        from System import Array\n        from Autodesk.AutoCAD.Geometry import Point3d\n\n        # Scale the original control points (assumes points_orig is a sequence of rg.Point3d)\n        scaled_points = [rg.Point3d(p.X * scale, p.Y * scale, p.Z * scale) for p in points_orig]\n\n        # Convert Rhino -> AutoCAD Point3d\n        # If your converter returns AutoCAD Point3d already:\n        scaled_cad_points_list = [\n            rhinoGeometryConverter.Convert(pt) for pt in scaled_points\n        ]\n        # If your converter returns Rhino points instead, use this line instead of the one above:\n        # scaled_cad_points_list = [Point3d(pt.X, pt.Y, pt.Z) for pt in scaled_points]\n\n        # Optional: filter out any Nones from a converter\n        scaled_cad_points_list = [p for p in scaled_cad_points_list if p is not None]\n\n        # Create a typed .NET array Point3d[]\n        scaled_cad_points = Array[Point3d](scaled_cad_points_list)\n\n        # Create a smooth 3-degree curve through all points, then add to PolyCurve\n        # polyCurve = rg.PolyCurve()\n        \n        # Create a single smooth 3-degree interpolated curve through all points\n        # try:\n        # Fallback to polyline if interpolated curve fails\n        polytype = Autodesk.AutoCAD.DatabaseServices.Poly3dType.SimplePoly\n        acadPoint3dCollection = Autodesk.AutoCAD.Geometry.Point3dCollection(scaled_cad_points)\n        acadPolyline3d = Autodesk.AutoCAD.DatabaseServices.Polyline3d(polytype, acadPoint3dCollection, False)\n            \n        # except:\n        #     smooth_curve = rg.Curve.CreateInterpolatedCurve(scaled_points, 3)\n        #     if smooth_curve is not None:\n        #         polyCurve.Append(smooth_curve)\n       \n        modelSpace.AppendEntity(acadPolyline3d)\n        transactionManger.AddNewlyCreatedDBObject(acadPolyline3d, True)\n        acadPolyline3d.Dispose()\n    return True\n\n# Create .NET Func delegate\nCreateCADHybridNurbsLoftedSurfaceWPolyLines = Func[ITransactionManager, bool](CreateCADHybridNurbsLoftedSurfaceWPolyLines)\n\n# Usage:\n#success = document.Transaction(CreateCADHybridNurbsLoftedSurfaceWPolyLines)\n\n#########################################\n\ndef CreateCADHybridNurbsLoftedSurface(transactionManagerWrapper, add_profile_curves=True):\n    \"\"\"\n    Builds 4 smooth (degree-3) interpolated NURBS curves at different Z levels\n    in the app's INTERNAL units, lofts them into a Brep, converts to AutoCAD DB\n    objects, and appends them to ModelSpace under the active transaction.\n\n    If add_profile_curves=True, also converts/appends the source NURBS curves.\n    \"\"\"\n    # Unwrap DB objects (ModelSpace opened for write)\n    model_space = InteropConverter.Unwrap(transactionManagerWrapper.GetModelSpaceBlockTableRecord(True))\n    transaction = InteropConverter.Unwrap(transactionManagerWrapper)\n\n    # --- 1) Build UN-SCALED NURBS curves (units = your InternalUnitSystem)\n    points1 = [\n        rg.Point3d(0, 0, 0),\n        rg.Point3d(5, 3, 0),\n        rg.Point3d(10, -2, 0),\n        rg.Point3d(15, 4, 0),\n        rg.Point3d(20, 1, 0),\n        rg.Point3d(25, -1, 0),\n        rg.Point3d(30, 2, 0)\n    ]\n    points2 = [\n        rg.Point3d(2, 1, 8),\n        rg.Point3d(7, -2, 8),\n        rg.Point3d(12, 4, 8),\n        rg.Point3d(17, 0, 8),\n        rg.Point3d(22, 3, 8),\n        rg.Point3d(27, -1, 8),\n        rg.Point3d(32, 2, 8)\n    ]\n    points3 = [\n        rg.Point3d(4, -1, 16),\n        rg.Point3d(9, 5, 16),\n        rg.Point3d(14, -3, 16),\n        rg.Point3d(19, 4, 16),\n        rg.Point3d(24, 0, 16),\n        rg.Point3d(29, 3, 16),\n        rg.Point3d(34, 1, 16)\n    ]\n    points4 = [\n        rg.Point3d(6, 2, 24),\n        rg.Point3d(11, -1, 24),\n        rg.Point3d(16, 3, 24),\n        rg.Point3d(21, 1, 24),\n        rg.Point3d(26, -2, 24),\n        rg.Point3d(31, 2, 24),\n        rg.Point3d(36, 0, 24)\n    ]\n\n    # Degree-3 interpolated curves\n    loft_curve1 = rg.Curve.CreateInterpolatedCurve(points1, 3)\n    loft_curve2 = rg.Curve.CreateInterpolatedCurve(points2, 3)\n    loft_curve3 = rg.Curve.CreateInterpolatedCurve(points3, 3)\n    loft_curve4 = rg.Curve.CreateInterpolatedCurve(points4, 3)\n\n    loft_curves = [loft_curve1, loft_curve2, loft_curve3, loft_curve4]\n\n    # --- 2) Loft to Brep\n    lofted = rg.Brep.CreateFromLoft(loft_curves, rg.Point3d.Unset, rg.Point3d.Unset,\n                                    rg.LoftType.Normal, closed=False)\n    if not lofted or len(lofted) == 0:\n        for c in loft_curves:\n            try: c.Dispose()\n            except: pass\n        print(\"[CreateCADHybridNurbsLoftedSurface] Loft failed.\")\n        return False\n\n    loft_brep = lofted[0]  # IDisposable\n\n    try:\n        converter = RhinoGeometryConverter.Instance\n\n        # --- 3) Convert lofted Brep to AutoCAD DB objects\n        cad_entities = converter.ConvertDb(loft_brep)\n        if cad_entities is None:\n            print(\"[CreateCADHybridNurbsLoftedSurface] ConvertDb(loft_brep) returned None.\")\n            return False\n        if not hasattr(cad_entities, \"__iter__\"):\n            cad_entities = [cad_entities]\n\n        # --- 4) Append + register loft result\n        for db_obj in cad_entities:\n            obj_id = model_space.AppendEntity(db_obj)\n            transaction.AddNewlyCreatedDBObject(db_obj, True)\n            db_obj.Dispose()\n\n        # (Optional) also drop the Rhino profile curves into ModelSpace\n        if add_profile_curves:\n            for c in loft_curves:\n                db_curve = converter.ConvertDb(c)\n                if db_curve is None:\n                    continue\n                # Normalize return shape\n                if not hasattr(db_curve, \"__iter__\"):\n                    db_curve = [db_curve]\n                for ent in db_curve:\n                    obj_id = model_space.AppendEntity(ent)\n                    transaction.AddNewlyCreatedDBObject(ent, True)\n                    ent.Dispose()\n\n        print(\"[CreateCADHybridNurbsLoftedSurface] NURBS loft and (optional) profiles created.\")\n        return True\n\n    finally:\n        # Dispose Rhino geometry\n        try: loft_brep.Dispose()\n        except: pass\n        for c in loft_curves:\n            try: c.Dispose()\n            except: pass\n\n\n# Create .NET Func delegate\nnet_CreateCADHybridNurbsLoftedSurface = Func[ITransactionManager, bool](CreateCADHybridNurbsLoftedSurface)\n\n# Usage:\nsuccess = document.Transaction(net_CreateCADHybridNurbsLoftedSurface)",
  "language": "python",
  "imports": [
    "Rhino",
    "Rhino.Geometry",
    "rhinoscriptsyntax"
  ],
  "has_docstring": false
}