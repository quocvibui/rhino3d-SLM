{
  "source_url": "https://discourse.mcneel.com/t/headless-document-throw-popup-error-and-stops/208080",
  "topic_id": 208080,
  "title": "Headless document throw popup error and stops",
  "question": "I’ve got an .stl file which might be not valid.\n\n\nA code like:\n\n\nRhino.RhinoDoc tempdoc = Rhino.RhinoDoc.CreateHeadless(null);\ntempdoc.Import(\"C:\\Users\\maje\\Desktop\\test.stl\");\n\n\n\nthrows me an error like:\n\n\n2025-08-06 15_34_31-Grasshopper - unnamed\n384×154 2.65 KB\n\n\nThere is a way to catch this error from the code?\n\nThis popup stops the execution and wait for user interaction",
  "code_blocks": [
    {
      "code": "import Rhino\nimport System\nimport clr\nimport os\nimport time\nimport threading\n\nclr.AddReference('UIAutomationClient')\nclr.AddReference('UIAutomationTypes')\nclr.AddReference('WindowsBase')\n\nfrom System.Windows.Automation import *\nfrom System import IntPtr, Int32\n\nclass DialogDetector:\n    \n    def __init__(self):\n        self.dialog_detected = False\n        self.dialog_hwnd = None\n        self.event_handler = None\n        self.dialog_dismissed = False\n        \n    def start_listening(self):\n        try:\n            self.event_handler = AutomationEventHandler(self._on_window_opened)\n            \n            Automation.AddAutomationEventHandler(\n                WindowPattern.WindowOpenedEvent,\n                AutomationElement.RootElement,\n                TreeScope.Subtree,\n                self.event_handler\n            )\n            \n            print(\"UI Automation listener started\")\n            \n        except Exception as e:\n            print(\"Error starting listener: \" + str(e))\n            \n    def stop_listening(self):\n        try:\n            if self.event_handler:\n                Automation.RemoveAutomationEventHandler(\n                    WindowPattern.WindowOpenedEvent,\n                    AutomationElement.RootElement,\n                    self.event_handler\n                )\n                print(\"UI Automation listener stopped\")\n        except:\n            pass\n            \n    def _on_window_opened(self, sender, e):\n        try:\n            element = sender\n            \n            name_property = element.GetCurrentPropertyValue(AutomationElement.NameProperty)\n            class_property = element.GetCurrentPropertyValue(AutomationElement.ClassNameProperty)\n            \n            window_name = str(name_property) if name_property else \"\"\n            \n            if \"STL File Read Error\" in window_name and \"Rhino\" in window_name:\n                print(\"STL error dialog detected!\")\n                self.dialog_detected = True\n                \n                hwnd_property = element.GetCurrentPropertyValue(AutomationElement.NativeWindowHandleProperty)\n                if hwnd_property:\n                    self.dialog_hwnd = int(str(hwnd_property))\n                \n                self._dismiss_dialog(element)\n                \n        except Exception as ex:\n            pass\n            \n    def _dismiss_dialog(self, element):\n        try:\n            button_condition = PropertyCondition(\n                AutomationElement.ControlTypeProperty, \n                ControlType.Button\n            )\n            \n            buttons = element.FindAll(TreeScope.Descendants, button_condition)\n            \n            if buttons and buttons.Count > 0:\n                ok_button = buttons[0]\n                \n                try:\n                    invoke_pattern = ok_button.GetCurrentPattern(InvokePattern.Pattern)\n                    if invoke_pattern:\n                        invoke_pattern.Invoke()\n                        self.dialog_dismissed = True\n                        print(\"Dialog dismissed by clicking OK\")\n                        return\n                except:\n                    pass\n                    \n            try:\n                window_pattern = element.GetCurrentPattern(WindowPattern.Pattern)\n                if window_pattern:\n                    window_pattern.Close()\n                    self.dialog_dismissed = True\n                    print(\"Dialog closed using window pattern\")\n                    return\n            except:\n                pass\n                \n            self._send_keyboard_dismiss()\n                    \n        except Exception as ex:\n            print(\"Could not dismiss dialog automatically: \" + str(ex))\n            \n    def _send_keyboard_dismiss(self):\n        try:\n            import ctypes\n            user32 = ctypes.windll.user32\n            \n            VK_RETURN = 0x0D\n            KEYEVENTF_KEYUP = 0x0002\n            \n            user32.keybd_event(VK_RETURN, 0, 0, 0)\n            time.sleep(0.05)\n            user32.keybd_event(VK_RETURN, 0, KEYEVENTF_KEYUP, 0)\n            \n            self.dialog_dismissed = True\n            print(\"Dialog dismissed using Enter key\")\n            \n        except Exception as e:\n            print(\"Keyboard dismiss failed: \" + str(e))\n\ndef detect_stl_error(filename):\n    \n    detector = DialogDetector()\n    error_detected = False\n    \n    try:\n        if not filename:\n            print(\"Error: No filename provided\")\n            return True\n            \n        if not os.path.exists(filename):\n            print(\"Error: File not found at path: \" + filename)\n            return True\n            \n        print(\"Preparing to import: \" + filename)\n        \n        detector.start_listening()\n        \n        System.Threading.Thread.Sleep(200)\n        \n        print(\"Creating temporary Rhino document...\")\n        temp_doc = None\n        \n        try:\n            temp_doc = Rhino.RhinoDoc.CreateHeadless(None)\n            \n            if temp_doc is None:\n                print(\"Error: Failed to create temporary Rhino document\")\n                return True\n            \n            print(\"Attempting import...\")\n            \n            import_success = temp_doc.Import(filename)\n            \n            System.Threading.Thread.Sleep(300)\n            \n            if detector.dialog_detected:\n                print(\"STL error dialog was detected during import\")\n                error_detected = True\n                \n            elif not import_success:\n                print(\"Import returned false - file may be invalid\")\n                error_detected = True\n            else:\n                print(\"Import completed successfully\")\n                error_detected = False\n                \n        finally:\n            if temp_doc is not None:\n                try:\n                    temp_doc.Dispose()\n                    print(\"Temporary document disposed\")\n                except:\n                    pass\n                    \n    except System.Exception as e:\n        print(\"System exception: \" + str(e.Message))\n        error_detected = True\n        \n    except Exception as e:\n        print(\"Python exception: \" + str(e))\n        error_detected = True\n        \n    finally:\n        detector.stop_listening()\n        \n        if detector.dialog_detected:\n            print(\"\\nResult: STL read error dialog was detected\")\n        elif error_detected:\n            print(\"\\nResult: Import failed\")\n        else:\n            print(\"\\nResult: Import successful - no errors detected\")\n    \n    return error_detected\n\ndef test_stl_error_detection():\n    \n    stl_path = r\"C:\\Users\\admin\\Documents\\pcuse\\test.stl\"\n    \n    print(\"=\" * 50)\n    print(\"Starting STL error detection test\")\n    print(\"=\" * 50)\n    \n    error_found = detect_stl_error(stl_path)\n    \n    if error_found:\n        print(\"\\nError detected!\")\n    else:\n        print(\"\\nNo errors detected!\")\n    \n    return error_found\n\nif __name__ == \"__main__\":\n    test_stl_error_detection()",
      "language": "python",
      "author": "farouk.serragedine",
      "post_number": 7,
      "is_solution": false
    }
  ],
  "tags": [
    "file-io",
    "grasshopper",
    "python",
    "transformation"
  ],
  "has_accepted_answer": false,
  "category_id": 3,
  "posts_count": 8,
  "views": 161
}