{
  "source_url": "https://github.com/ed-p-may/LBT-2-PH/blob/3c2bbdf0cb26deb92d36b870aeb920cbc31d8da2/ghuser_py/LBT2PH%20XL%20Write%20to%20Workbook.py",
  "repo": "ed-p-may/LBT-2-PH",
  "repo_stars": 12,
  "repo_description": "LBT2PH is a free toolkit for creating PHPP energy models from Ladybug Tools v1.0+ definitions.",
  "license": "GPL-3.0",
  "filepath": "ghuser_py/LBT2PH XL Write to Workbook.py",
  "instruction": "Writes a series of objects to an excel sheet, then recalculates the sheet.\nThese objects should be in a Treemap, and need a Worksheet, Range, and Value variable.\nOptionally only writes the...",
  "code": "#\n# LBT2PH: A Plugin for creating Passive House Planning Package (PHPP) models from LadybugTools. Created by blgdtyp, llc\n# \n# This component is part of the PH-Tools toolkit <https://github.com/PH-Tools>.\n# \n# Copyright (c) 2020, bldgtyp, llc <phtools@bldgtyp.com> \n# LBT2PH is free software; you can redistribute it and/or modify \n# it under the terms of the GNU General Public License as published \n# by the Free Software Foundation; either version 3 of the License, \n# or (at your option) any later version. \n# \n# LBT2PH is distributed in the hope that it will be useful,\n# but WITHOUT ANY WARRANTY; without even the implied warranty of \n# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the \n# GNU General Public License for more details.\n# \n# For a copy of the GNU General Public License\n# see <http://www.gnu.org/licenses/>.\n# \n# @license GPL-3.0+ <http://spdx.org/licenses/GPL-3.0+>\n#\n\"\"\"\nWrites a series of objects to an excel sheet, then recalculates the sheet.\nThese objects should be in a Treemap, and need a Worksheet, Range, and Value variable.\nOptionally only writes the differances from the last execution of this function, \nto reduce writing time.\n-\nOriginal component design by Jack Hymowitz <https://github.com/jackhymowitz>, \nPinacle Scholar Summer Research Student, Stevens Institute of Technology\n-\nMarch 1, 2021\n    Args:\n        _excel: A running ExcelInterface from OpenExcel Workbook\n        useDiff_: Set to True to only write the differance out to excel, enabled by default.\n        color_: set to True to highlight outputted fields, enabled by default.\n        _XL_Objects: TreeMap of objects to write with Worksheet, Range, and Value\n    Returns:\n        excel: The running ExcelInterface is outputted after this function runs.\n        numWrites: The number of writes that occured, for debugging purposes.\n\"\"\"\n\nfrom ghpythonlib.componentbase import executingcomponent as component\nimport Grasshopper, GhPython\nimport System\nimport Rhino\nimport rhinoscriptsyntax as rs\nimport Grasshopper.Kernel as ghK\nimport scriptcontext as sc\nfrom System import Object\nfrom Grasshopper.Kernel.Data import GH_Path\nimport clr\nfrom contextlib import contextmanager\nclr.AddReferenceByName('Microsoft.Office.Interop.Excel')#, Culture=neutral, PublicKeyToken=71e9bce111e9429c')\nfrom Microsoft.Office.Interop import Excel\n\nimport LBT2PH.__versions__\nreload(LBT2PH.__versions__)\n\nghenv.Component.Name = \"LBT2PH XL Write to Workbook\"\nLBT2PH.__versions__.set_component_params(ghenv, dev=False)\n#-------------------------------------------------------------------------------\n\nclass MyComponent(component):\n    \n    @staticmethod\n    @contextmanager\n    def writingToExcel(_excel):\n        \"\"\" Changes the Excel Doc settings to help speed up \"\"\"\n        \n        # Note: xlCalculationManual / Automatic set only works AFTER the workbook is opened\n        \n        try:\n            _excel.excel_app.Calculation = -4135 \n            _excel.excel_app.ScreenUpdating = False\n            yield\n        finally:\n            _excel.excel_app.Calculation = -4105 \n            _excel.excel_app.ScreenUpdating = True\n    \n    def checkPHPPVersion(self, _excel):\n        \"\"\" Looks at !Data:D3 to find version number. Returns 'SI' or 'IP' unit type\"\"\"\n        version = _excel.sheets_dict['Data'].Range['B3'].Value2\n        \n        if not version:\n            print('Using \"SI\" Units')\n            return 'SI'\n        elif 'IP' in version:\n            print('Using \"IP\" Units')\n            return 'IP'\n        else:\n            print('Using \"SI\" Units')\n            return 'SI'\n    \n    def doReadObjs(self, objects, _unitType):\n        #If useDiff is false, this is used. Simply reads all objects in\n        \n        diff=[]\n        for eachBranch in objects.Branches:\n            for obj in eachBranch:\n                diff.append((obj.getWorksheet(_unitType),obj.Range,obj.getValue(_unitType)))\n        return diff\n    \n    def doDiff(self, objects, _unitType):\n        #If useDiff is true (or not set), this is used. Only objects that have changed are written\n        \n        newObj={}\n        for eachBranch in objects.Branches:\n            for obj in eachBranch:\n                newObj[(obj.getWorksheet(_unitType),obj.Range)]=obj.getValue(_unitType);\n        \n        diff=[]\n        if \"XLSdata\" in sc.sticky:    #We are checking diffs\n            oldObj=sc.sticky[\"XLSdata\"]\n            for x in newObj.keys():\n                if not x in oldObj.keys() or oldObj[x]!=newObj[x]: #If the value didn't exist before or was changed, it's a change\n                    diff.append((x[0],x[1],newObj[x]))\n            for x in oldObj.keys():\n                if not x in newObj.keys():                         #If the value existed before and is now gone, it is a change\n                    diff.append((x[0],x[1],\"\"))\n            \n        else:                                       #Not checking diffs\n            for x in newObj.keys():\n                diff.append((x[0],x[1],newObj[x]))\n        sc.sticky[\"newXLSdata\"]=newObj\n        return diff\n    \n    def doWrite(self, excel, border, data):\n        #Write out the data we have found\n        \n        with self.writingToExcel(excel):\n            for eachItem in data:\n                try:\n                    excel.sheets_dict[eachItem[0]].Range[eachItem[1]].Value2 = eachItem[2]\n                    if(border == None or border):\n                        excel.sheets_dict[eachItem[0]].Range[eachItem[1]].Interior.ColorIndex=8\n                except:\n                    msg1 = \"Sheet not found: \" + eachItem[0]\n                    ghenv.Component.AddRuntimeMessage(ghK.GH_RuntimeMessageLevel.Warning, msg1)\n            if \"newXLSdata\" in sc.sticky:\n                sc.sticky[\"XLSdata\"]=sc.sticky[\"newXLSdata\"]\n    \n    def RunScript(self, excel, useDiff, border, XL_Objects):\n        \n        if not excel or not excel.active_workbook or not XL_Objects:\n            msg1 = \"No Excel Instance!\"\n            ghenv.Component.AddRuntimeMessage(ghK.GH_RuntimeMessageLevel.Warning, msg1)\n            return (None,0)\n        \n        unitType = self.checkPHPPVersion(excel)\n        \n        if useDiff is None or useDiff:\n            diff=self.doDiff(XL_Objects, unitType)\n        else:\n            diff=self.doReadObjs(XL_Objects, unitType)\n        \n        self.doWrite(excel, border,diff)\n        excel.excel_app.Calculate()\n        \n        return (excel,len(diff))\n",
  "language": "python",
  "imports": [
    "Rhino",
    "ghpythonlib",
    "rhinoscriptsyntax",
    "scriptcontext"
  ],
  "has_docstring": true
}