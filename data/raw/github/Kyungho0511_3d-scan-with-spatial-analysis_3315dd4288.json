{
  "source_url": "https://github.com/Kyungho0511/3d-scan-with-spatial-analysis/blob/ae047ace35223fc021ac1c65d7b8d5c17f0043f4/scripts/_ss/testBoundingBox.py",
  "repo": "Kyungho0511/3d-scan-with-spatial-analysis",
  "repo_stars": 3,
  "repo_description": null,
  "license": "unknown",
  "filepath": "scripts/_ss/testBoundingBox.py",
  "instruction": "Test bounding box",
  "code": "import pyarrow.parquet as pq\nimport os\nimport pandas as pd\nimport numpy as np\nimport open3d as o3d\nimport trimesh\nimport ghhops_server as hs\nimport rhino3dm\nfrom flask import Flask\nimport open3d as o3d\nimport json\n\ndef o3d_to_rhino3dm(o3d_mesh):\n    \"\"\"\n    Converts an Open3D mesh into a Rhino3dm mesh.\n\n    Parameters:\n        o3d_mesh (o3d.geometry.TriangleMesh): The Open3D mesh to convert.\n\n    Returns:\n        rhino3dm.Mesh: The converted Rhino3dm mesh.\n    \"\"\"\n\n    \n    # Create a new Rhino3dm mesh\n    rhino_mesh = rhino3dm.Mesh()\n\n    # Add vertices to the Rhino mesh\n    for vertex in o3d_mesh.vertices:\n        rhino_mesh.Vertices.Add(vertex[0], vertex[1], vertex[2])\n\n    # Add faces to the Rhino mesh\n    for triangle in o3d_mesh.triangles:\n        rhino_mesh.Faces.AddFace(triangle[0], triangle[1], triangle[2])\n\n    return rhino_mesh\n\n\ndef dfToMesh(df):\n    # Convert DataFrame to NumPy array\n    points = df[['x', 'y', 'z']].to_numpy()\n\n    # Create an Open3D point cloud object\n    point_cloud = o3d.geometry.PointCloud()\n    point_cloud.points = o3d.utility.Vector3dVector(points)\n\n    # Downsample the point cloud\n    pcd = point_cloud.voxel_down_sample(voxel_size=0.01)\n\n    # Remove outliers\n    cl, ind = pcd.remove_statistical_outlier(nb_neighbors=20, std_ratio=2.0)\n    clean_pcd = pcd.select_by_index(ind)\n\n    # Visualize the cleaned point cloud\n    # o3d.visualization.draw_geometries([clean_pcd])\n\n    # Estimate normals\n    clean_pcd.estimate_normals(search_param=o3d.geometry.KDTreeSearchParamHybrid(radius=0.05, max_nn=30))\n\n    # Orient the normals\n    clean_pcd.orient_normals_consistent_tangent_plane(100)\n    mesh, densities = o3d.geometry.TriangleMesh.create_from_point_cloud_poisson(\n        clean_pcd, depth=9\n    )\n\n    # Define a threshold to remove low-density vertices\n    vertices = np.asarray(mesh.vertices)\n    density_threshold = np.percentile(densities, 5)  # Remove the bottom 5% of densities\n    vertices_to_remove = densities < density_threshold\n\n    # Filter vertices based on the density threshold\n    mesh.remove_vertices_by_mask(vertices_to_remove)\n    return mesh\n\n\n\n\ndef dfToRhinoMesh(df):\n    return o3d_to_rhino3dm(dfToMesh(df))\n\n\n# def add_numbers(a: str, b: float) -> rhino3dm.Mesh:\na = dir_path = os.path.dirname(os.path.realpath(__file__)) + \"/setup_0.parquet\"\n\n# Read the Parquet file\ntable = pq.read_table(a)\n\n# Convert to a pandas DataFrame if needed\ndf = table.to_pandas()\ndfWalls = df[df['cat'] == 2]\ndfFloor = df[df['cat'] == 1]\ndfCeiling = df[df['cat'] == 0]\ndfWindow =df[df['cat'] == 10]\n\n\ndf_sampleWalls = dfWalls.sample(n=40000, random_state=1)\ndf_sampleFloor = dfFloor.sample(n=40000, random_state=1)\ndf_sampleCeiling = dfCeiling.sample(n=40000, random_state=1)\ndf_sampleWindow = df[df['cat'] == 10]\n\nwalls = dfToRhinoMesh(df_sampleWalls)\nfloor = dfToRhinoMesh(df_sampleFloor)\nceiling = dfToRhinoMesh(df_sampleCeiling)\nwindow = dfToRhinoMesh(df_sampleWindow)\n\n\n\n\n# Create a 3dm file\nmodel = rhino3dm.File3dm()\n\n# Add the point to the model\nmodel.Objects.AddMesh(walls)\nmodel.Objects.AddMesh(floor)\nmodel.Objects.AddMesh(ceiling)\nmodel.Objects.AddMesh(window)\n\n\n# Write the model to a file\nmodel.Write(\"my_geometry.3dm\", 6) \n\n\n\n\n\n\n",
  "language": "python",
  "imports": [
    "rhino3dm"
  ],
  "has_docstring": false
}