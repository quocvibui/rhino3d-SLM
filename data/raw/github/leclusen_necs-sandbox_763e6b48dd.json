{
  "source_url": "https://github.com/leclusen/necs-sandbox/blob/8d8006ae3c845c9f3e38154803caac6b03d298a9/structure-batiment/scripts/compare_3dm.py",
  "repo": "leclusen/necs-sandbox",
  "repo_stars": 0,
  "repo_description": null,
  "license": "unknown",
  "filepath": "structure-batiment/scripts/compare_3dm.py",
  "instruction": "Compare layer structure and object metadata between two .3dm files.",
  "code": "#!/usr/bin/env python3\n\"\"\"Compare layer structure and object metadata between two .3dm files.\"\"\"\nimport json, os\nfrom collections import defaultdict\nimport rhino3dm\n\nBEFORE = '/Users/nicolaslecluse/Documents/GitHub/necs/structure-batiment/data/input/before.3dm'\nAFTER  = '/Users/nicolaslecluse/Documents/GitHub/necs/structure-batiment/data/input/after.3dm'\nOUTPUT_DIR = '/private/tmp/claude-501/-Users-nicolaslecluse-Documents-GitHub-necs-structure-batiment/b09d2d51-6bea-4e28-bc0f-f3133f5afc34/scratchpad'\nOUTPUT_FILE = os.path.join(OUTPUT_DIR, 'layer_structure_comparison.json')\n\ndef color_to_dict(c):\n    try:\n        return {'R': c.R, 'G': c.G, 'B': c.B, 'A': c.A}\n    except Exception:\n        try:\n            return {'R': c[0], 'G': c[1], 'B': c[2], 'A': c[3] if len(c)>3 else 255}\n        except Exception:\n            return str(c)\n\ndef brep_details(geom):\n    info = {}\n    for an, key in [('Faces','faces_count'),('Edges','edges_count'),('Vertices','vertices_count'),('Surfaces','surfaces_count'),('Trims','trims_count'),('Loops','loops_count')]:\n        try:\n            info[key] = len(getattr(geom, an))\n        except Exception:\n            info[key] = 'N/A'\n    face_details = []\n    try:\n        for i in range(len(geom.Faces)):\n            fd = {'face_index': i}\n            try:\n                fd['surface_index'] = geom.Faces[i].SurfaceIndex\n            except Exception:\n                pass\n            face_details.append(fd)\n    except Exception:\n        pass\n    if face_details: info['face_details'] = face_details\n    return info\n\ndef extract_object_info(obj, lmap):\n    geom, attr = obj.Geometry, obj.Attributes\n    info = {\n        'id': str(attr.Id) if attr else None,\n        'name': attr.Name if attr else None,\n        'layer_index': attr.LayerIndex if attr else None,\n        'layer_name': lmap.get(attr.LayerIndex, 'UNKNOWN') if attr else 'UNKNOWN',\n        'geometry_type': type(geom).__name__ if geom else 'None',\n        'geometry_class': type(geom).__name__ if geom else None,\n    }\n    if attr:\n        try:\n            info['color'] = color_to_dict(attr.ObjectColor)\n        except Exception:\n            info['color'] = None\n        try:\n            info['color_source'] = int(attr.ColorSource)\n        except Exception:\n            info['color_source'] = None\n        for aname in ['LinetypeIndex','MaterialIndex','Visible']:\n            try:\n                info[aname[0].lower()+aname[1:]] = getattr(attr, aname)\n            except Exception:\n                pass\n        try:\n            info['mode'] = int(attr.Mode)\n        except Exception:\n            pass\n    if geom is not None:\n        gtype = type(geom).__name__\n        info['is_brep'] = 'Brep' in gtype\n        if info['is_brep']:\n            info['brep'] = brep_details(geom)\n        info['is_extrusion'] = 'Extrusion' in gtype\n        if info['is_extrusion']:\n            try:\n                info['extrusion_profile_count'] = geom.ProfileCount\n            except Exception:\n                pass\n        info['is_mesh'] = 'Mesh' in gtype\n        if info['is_mesh']:\n            try:\n                info['mesh_vertices'] = len(geom.Vertices)\n            except Exception:\n                pass\n            try:\n                info['mesh_faces'] = len(geom.Faces)\n            except Exception:\n                pass\n        info['is_surface'] = 'Surface' in gtype\n        try:\n            bb = geom.GetBoundingBox()\n            info['bounding_box'] = {'min': [bb.Min.X,bb.Min.Y,bb.Min.Z], 'max': [bb.Max.X,bb.Max.Y,bb.Max.Z]}\n        except Exception:\n            pass\n    return info\n\ndef extract_layer_hierarchy(f3dm):\n    layers_info, idx_name = [], {}\n    for i, layer in enumerate(f3dm.Layers):\n        idx_name[i] = layer.Name\n        li = {'index': i, 'name': layer.Name, 'id': str(layer.Id), 'parent_id': str(layer.ParentLayerId),\n              'color': color_to_dict(layer.Color), 'visible': layer.Visible, 'locked': layer.Locked}\n        try:\n            li['full_path'] = layer.FullPath\n        except Exception:\n            li['full_path'] = layer.Name\n        layers_info.append(li)\n    return layers_info, idx_name\n\ndef extract_file_metadata(f3dm):\n    meta, s = {}, f3dm.Settings\n    pairs = [('ModelUnitSystem','model_unit_system'),('ModelAbsoluteTolerance','model_absolute_tolerance'),\n             ('ModelAngleToleranceRadians','model_angle_tolerance_radians'),('ModelAngleToleranceDegrees','model_angle_tolerance_degrees'),\n             ('ModelRelativeTolerance','model_relative_tolerance'),('PageUnitSystem','page_unit_system'),('PageAbsoluteTolerance','page_absolute_tolerance')]\n    for an, key in pairs:\n        try:\n            val = getattr(s, an)\n            meta[key] = str(val) if 'Unit' in an else val\n        except Exception:\n            pass\n    return meta\n\ndef analyze_file(filepath):\n    f = rhino3dm.File3dm.Read(filepath)\n    if f is None:\n        raise RuntimeError('Could not open ' + filepath)\n    layers, idx_name = extract_layer_hierarchy(f)\n    metadata = extract_file_metadata(f)\n    objects = []\n    opl = defaultdict(int)\n    gtc = defaultdict(int)\n    ext_c = mesh_c = surf_c = brep_c = 0\n    for obj in f.Objects:\n        info = extract_object_info(obj, idx_name)\n        objects.append(info)\n        opl[info['layer_name']] += 1\n        gtc[info['geometry_class'] or 'None'] += 1\n        if info.get('is_extrusion'): ext_c += 1\n        if info.get('is_mesh'): mesh_c += 1\n        if info.get('is_surface'): surf_c += 1\n        if info.get('is_brep'): brep_c += 1\n    return {'filepath': filepath, 'layers': layers, 'layer_index_to_name': {str(k):v for k,v in idx_name.items()},\n            'metadata': metadata, 'objects': objects, 'total_objects': len(objects),\n            'object_count_per_layer': dict(opl), 'geometry_type_counts': dict(gtc),\n            'extrusion_count': ext_c, 'mesh_count': mesh_c, 'surface_count': surf_c, 'brep_count': brep_c}\n\ndef compare(before, after):\n    report = {}\n    bln = {l['name'] for l in before['layers']}\n    aln = {l['name'] for l in after['layers']}\n    blm = {l['name']: l for l in before['layers']}\n    alm = {l['name']: l for l in after['layers']}\n    layer_diff = []\n    for name in sorted(bln & aln):\n        diffs = {}\n        for key in ['id','parent_id','color','visible','locked','full_path']:\n            bv = blm[name].get(key)\n            av = alm[name].get(key)\n            if bv != av: diffs[key] = {'before': bv, 'after': av}\n        if diffs: layer_diff.append({'layer': name, 'changes': diffs})\n    report['layers'] = {'before_count': len(before['layers']), 'after_count': len(after['layers']),\n                        'added': sorted(aln-bln), 'removed': sorted(bln-aln), 'common': sorted(bln&aln), 'attribute_diffs': layer_diff}\n    opl = {}\n    for ln in sorted(bln | aln):\n        bc = before['object_count_per_layer'].get(ln, 0)\n        ac = after['object_count_per_layer'].get(ln, 0)\n        opl[ln] = {'before': bc, 'after': ac, 'diff': ac - bc}\n    report['object_count_per_layer'] = opl\n    bids = {o['id'] for o in before['objects']}\n    aids = {o['id'] for o in after['objects']}\n    bom = {o['id']: o for o in before['objects']}\n    aom = {o['id']: o for o in after['objects']}\n    added_ids = sorted(aids - bids)\n    removed_ids = sorted(bids - aids)\n    common_ids = bids & aids\n    report['objects_added_removed'] = {\n        'total_before': before['total_objects'], 'total_after': after['total_objects'],\n        'added_count': len(added_ids), 'removed_count': len(removed_ids), 'common_count': len(common_ids),\n        'added': [{'id':i,'name':aom[i]['name'],'layer':aom[i]['layer_name'],'geometry_type':aom[i]['geometry_class']} for i in added_ids],\n        'removed': [{'id':i,'name':bom[i]['name'],'layer':bom[i]['layer_name'],'geometry_type':bom[i]['geometry_class']} for i in removed_ids],\n    }\n    gtc = []\n    for oid in sorted(common_ids):\n        if bom[oid]['geometry_class'] != aom[oid]['geometry_class']:\n            gtc.append({'id':oid,'name':bom[oid]['name'],'before_type':bom[oid]['geometry_class'],'after_type':aom[oid]['geometry_class']})\n    report['geometry_type_changes'] = gtc\n    report['geometry_type_counts'] = {'before': before['geometry_type_counts'], 'after': after['geometry_type_counts']}\n    attr_diffs = []\n    for oid in sorted(common_ids):\n        changes = {}\n        for k in ['name','layer_name','color','color_source','visible','mode','linetypeIndex','materialIndex']:\n            bv = bom[oid].get(k)\n            av = aom[oid].get(k)\n            if bv != av: changes[k] = {'before': bv, 'after': av}\n        if changes: attr_diffs.append({'id':oid,'name':bom[oid]['name'],'changes':changes})\n    report['object_attribute_diffs'] = attr_diffs\n    mk = set(list(before['metadata'].keys()) + list(after['metadata'].keys()))\n    report['file_metadata'] = {}\n    for k in sorted(mk):\n        bv = before['metadata'].get(k)\n        av = after['metadata'].get(k)\n        report['file_metadata'][k] = {'before': bv, 'after': av, 'changed': bv != av}\n    report['special_geometry_counts'] = {\n        'extrusions': {'before': before['extrusion_count'], 'after': after['extrusion_count']},\n        'meshes': {'before': before['mesh_count'], 'after': after['mesh_count']},\n        'surfaces': {'before': before['surface_count'], 'after': after['surface_count']},\n        'breps': {'before': before['brep_count'], 'after': after['brep_count']},\n    }\n    brep_cmp = []\n    for oid in sorted(common_ids):\n        if bom[oid].get('is_brep') or aom[oid].get('is_brep'):\n            bb = bom[oid].get('brep', {})\n            ab = aom[oid].get('brep', {})\n            entry = {'id': oid, 'name': bom[oid]['name'], 'layer': bom[oid]['layer_name']}\n            for fld in ['faces_count','edges_count','vertices_count','surfaces_count','trims_count','loops_count']:\n                bv = bb.get(fld)\n                av = ab.get(fld)\n                entry[fld] = {'before': bv, 'after': av, 'same': bv == av}\n            entry['vertices_same'] = bb.get('vertices_count') == ab.get('vertices_count')\n            t_s = bb.get('trims_count') == ab.get('trims_count')\n            f_s = bb.get('faces_count') == ab.get('faces_count')\n            l_s = bb.get('loops_count') == ab.get('loops_count')\n            entry['trim_face_topology_same'] = t_s and f_s and l_s\n            brep_cmp.append(entry)\n    report['brep_topology_comparison'] = brep_cmp\n    return report\n\ndef print_summary(before, after, report):\n    sep = '=' * 80\n    print(sep)\n    print('  3DM FILE COMPARISON REPORT')\n    print(sep)\n    lr = report['layers']\n    print('\\n1. LAYER HIERARCHY')\n    print('  Layers in BEFORE:', lr['before_count'], ' |  Layers in AFTER:', lr['after_count'])\n    print('  Added:', lr['added'] if lr['added'] else '(none)')\n    print('  Removed:', lr['removed'] if lr['removed'] else '(none)')\n    print('\\n  BEFORE layers:')\n    for l in before['layers']:\n        pi = '  parent=' + l['parent_id'] if l['parent_id'] != '00000000-0000-0000-0000-000000000000' else ''\n        print('    [' + str(l['index']) + '] ' + l['full_path'] + '  id=' + l['id'] + pi)\n    print('\\n  AFTER layers:')\n    for l in after['layers']:\n        pi = '  parent=' + l['parent_id'] if l['parent_id'] != '00000000-0000-0000-0000-000000000000' else ''\n        print('    [' + str(l['index']) + '] ' + l['full_path'] + '  id=' + l['id'] + pi)\n    if lr['attribute_diffs']:\n        print('\\n  Layer attribute changes:')\n        for d in lr['attribute_diffs']:\n            print('    ' + d['layer'] + ': ' + json.dumps(d['changes'], default=str))\n    else:\n        print('  No attribute changes on common layers.')\n    print('\\n2. OBJECT COUNT PER LAYER')\n    print('  ' + 'Layer'.ljust(40) + 'Before'.rjust(7) + 'After'.rjust(7) + 'Diff'.rjust(7))\n    for ln, v in report['object_count_per_layer'].items():\n        ds = '+' + str(v['diff']) if v['diff'] > 0 else str(v['diff'])\n        m = ' ***' if v['diff'] != 0 else ''\n        print('  ' + ln.ljust(40) + str(v['before']).rjust(7) + str(v['after']).rjust(7) + ds.rjust(7) + m)\n    ar = report['objects_added_removed']\n    print('\\n3. OBJECTS ADDED / REMOVED')\n    print('  Total BEFORE:', ar['total_before'], ' AFTER:', ar['total_after'], ' Common:', ar['common_count'], ' Added:', ar['added_count'], ' Removed:', ar['removed_count'])\n    for label, lst in [('Added', ar['added']), ('Removed', ar['removed'])]:\n        if lst:\n            print('  ' + label + ':')\n            for o in lst[:20]:\n                print('    id=' + o['id'] + '  name=' + repr(o['name']) + '  layer=' + o['layer'] + '  type=' + str(o['geometry_type']))\n            if len(lst) > 20: print('    ... and ' + str(len(lst)-20) + ' more')\n    print('\\n4. GEOMETRY TYPES')\n    print('  BEFORE:', json.dumps(before['geometry_type_counts']))\n    print('  AFTER: ', json.dumps(after['geometry_type_counts']))\n    if report['geometry_type_changes']:\n        for c in report['geometry_type_changes']:\n            print('  CHANGED: ' + c['id'] + ' ' + repr(c['name']) + ' ' + c['before_type'] + ' -> ' + c['after_type'])\n    else:\n        print('  No geometry type changes.')\n    print('\\n5. OBJECT ATTRIBUTE DIFFS')\n    ad = report['object_attribute_diffs']\n    if ad:\n        print('  ' + str(len(ad)) + ' objects differ:')\n        for d in ad[:30]:\n            print('    ' + d['id'] + '  name=' + repr(d['name']))\n            for k, v in d['changes'].items():\n                print('      ' + k + ': ' + str(v['before']) + ' -> ' + str(v['after']))\n    else:\n        print('  No attribute diffs.')\n    print('\\n6. FILE METADATA')\n    for k, v in report['file_metadata'].items():\n        ch = '  ***' if v['changed'] else ''\n        print('  ' + k + ': before=' + str(v['before']) + '  after=' + str(v['after']) + ch)\n    print('\\n7. SPECIAL GEOMETRY COUNTS')\n    for gt, c in report['special_geometry_counts'].items():\n        d = c['after'] - c['before']\n        ds = '+' + str(d) if d > 0 else str(d)\n        m = ' ***' if d != 0 else ''\n        print('  ' + gt.ljust(12) + ' before=' + str(c['before']).rjust(5) + '  after=' + str(c['after']).rjust(5) + '  diff=' + ds + m)\n    print('\\n8-10. BREP TOPOLOGY')\n    bc = report['brep_topology_comparison']\n    if bc:\n        changed = [b for b in bc if not b['vertices_same'] or not b['trim_face_topology_same']]\n        unchanged = [b for b in bc if b['vertices_same'] and b['trim_face_topology_same']]\n        print('  ' + str(len(bc)) + ' Breps compared: Unchanged=' + str(len(unchanged)) + ' Changed=' + str(len(changed)))\n        if changed:\n            for b in changed[:30]:\n                print('  CHANGED: ' + b['id'] + '  name=' + repr(b['name']) + '  layer=' + b['layer'])\n                for fld in ['faces_count','edges_count','vertices_count','trims_count','loops_count','surfaces_count']:\n                    if not b[fld]['same']:\n                        print('    ' + fld + ': ' + str(b[fld]['before']) + ' -> ' + str(b[fld]['after']))\n                print('    vertices_same=' + str(b['vertices_same']) + '  trim_face_topology_same=' + str(b['trim_face_topology_same']))\n        else:\n            print('  All Breps identical.')\n        if unchanged:\n            print('  Sample unchanged (first 5):')\n            for b in unchanged[:5]:\n                print('    ' + b['id'] + '  name=' + repr(b['name']) + '  F=' + str(b['faces_count']['before']) + ' E=' + str(b['edges_count']['before']) + ' V=' + str(b['vertices_count']['before']))\n    else:\n        print('  No common Breps.')\n    print('\\n' + sep)\n    print('  END OF REPORT')\n    print(sep)\n\nprint('Reading BEFORE:', BEFORE)\nbefore_data = analyze_file(BEFORE)\nprint('  ->', before_data['total_objects'], 'objects,', len(before_data['layers']), 'layers')\nprint('Reading AFTER: ', AFTER)\nafter_data = analyze_file(AFTER)\nprint('  ->', after_data['total_objects'], 'objects,', len(after_data['layers']), 'layers')\nprint('\\nComparing...\\n')\nreport = compare(before_data, after_data)\nprint_summary(before_data, after_data, report)\nfull_output = {'before_file': BEFORE, 'after_file': AFTER,\n    'before_analysis': {k: before_data[k] for k in ['layers','metadata','total_objects','object_count_per_layer','geometry_type_counts','extrusion_count','mesh_count','surface_count','brep_count','objects']},\n    'after_analysis': {k: after_data[k] for k in ['layers','metadata','total_objects','object_count_per_layer','geometry_type_counts','extrusion_count','mesh_count','surface_count','brep_count','objects']},\n    'comparison': report}\nos.makedirs(OUTPUT_DIR, exist_ok=True)\nwith open(OUTPUT_FILE, 'w', encoding='utf-8') as fout:\n    json.dump(full_output, fout, indent=2, default=str)\nprint('\\nFull results saved to:', OUTPUT_FILE)\n",
  "language": "python",
  "imports": [
    "rhino3dm"
  ],
  "has_docstring": true
}