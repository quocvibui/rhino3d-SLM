{
  "source_url": "https://discourse.mcneel.com/t/help-scripting-mouse-press-and-release-events-sketch/195220",
  "topic_id": 195220,
  "title": "Help: Scripting mouse press and release events? (Sketch)",
  "question": "Hi,\n\n\nI’m working on a tool that lets you draw ‘freehand’ more precisely and with more control than the sketch tool.\n\n\nCertain posts in the forum require it:\n\n\nSketch tool settings\n\n\nSketch tool smoothness control\n\n\niPad sketching for rhino\n\n\nHere are two scripts that enable you to draw degree 1 or 3 curves by capturing very precise points and offering the option of simplifying the curve directly as a function of a percentage of the total number of points.\n\n\nSketchD1Rebuild.py\n (5.9 KB)\n\n\nSketchD3Rebuild.py\n (6.1 KB)\n\n\nimport Rhino\nimport rhinoscriptsyntax as rs\nfrom System.Drawing import Color\n\ndrawing_started = False\ntemporary_point_id = None\npoints = []\n\n\ndef simplify_points(points, tolerance):\n    if not points or len(points) < 2:\n        return points\n    simplified = [points[0]]\n    for pt in points[1:]:\n        if rs.Distance(simplified[-1], pt) > tolerance:\n            simplified.append(pt)\n    return simplified\n\n\ndef rebuild_polyline_proportional(polyline_id, reduction_percentage):\n    if not rs.IsCurve(polyline_id):\n        print(\"The selected object is not a polyline.\")\n        return None\n    points = rs.CurvePoints(polyline_id)\n    if not points or len(points) < 2:\n        print(\"Unable to retrieve points from the polyline.\")\n        return None\n    initial_points = len(points)\n    new_point_count = max(2, int(initial_points * (reduction_percentage / 100.0)))\n    reduced_points = rs.DivideCurve(polyline_id, new_point_count - 2, create_points=False)\n    if not reduced_points:\n        print(\"Failed to reduce points.\")\n        return None\n    final_points = [points[0]] + reduced_points + [points[-1]]\n    rebuilt_polyline = rs.AddPolyline(final_points)\n    if rebuilt_polyline:\n        print(\"Polyline rebuilt with {} points.\".format(len(final_points)))\n        rs.DeleteObject(polyline_id)\n        print(\"Original polyline deleted.\")\n        return rebuilt_polyline\n    else:\n        print(\"Failed to rebuild the polyline.\")\n        return None\n\n\ndef dynamic_dra...",
  "code_blocks": [
    {
      "code": "import Rhino\nfrom Rhino.Geometry import Point3d, Polyline\nfrom System.Drawing import Color\n\n\nclass DragCurveDrawer(Rhino.Input.Custom.GetPoint):\n    def __init__(self):\n        super(DragCurveDrawer, self).__init__()\n        self.points = []\n        self.is_drawing = False\n\n    def OnMouseDown(self, e):\n        \"\"\"Start drawing when the mouse is pressed.\"\"\"\n        self.is_drawing = True\n        self.points = [e.Point]  # Add the initial point\n        super(DragCurveDrawer, self).OnMouseDown(e)\n\n    def OnMouseMove(self, e):\n        \"\"\"Collect points while dragging the mouse.\"\"\"\n        if self.is_drawing:\n            self.points.append(e.Point)\n        super(DragCurveDrawer, self).OnMouseMove(e)\n\n    def OnMouseUp(self, e):\n        \"\"\"Finalize the curve when the mouse is released.\"\"\"\n        if self.is_drawing:\n            self.points.append(e.Point)  # Add the final point\n            self.is_drawing = False\n            self.SetCommandResult(Rhino.Commands.Result.Success)\n        super(DragCurveDrawer, self).OnMouseUp(e)\n\n    def OnDynamicDraw(self, e):\n        \"\"\"Draw the polyline dynamically.\"\"\"\n        if len(self.points) > 1:\n            dynamic_points = self.points + [e.CurrentPoint]\n            e.Display.DrawPolyline(dynamic_points, Color.Blue, 2)\n        super(DragCurveDrawer, self).OnDynamicDraw(e)\n\n\ndef simplify_points(points, tolerance):\n    \"\"\"Simplify points by removing close duplicates.\"\"\"\n    if len(points) < 2:\n        return points\n    simplified = [points[0]]\n    for pt in points[1:]:\n        if pt.DistanceTo(simplified[-1]) > tolerance:\n            simplified.append(pt)\n    return simplified\n\n\ndef rebuild_polyline_proportional(points, reduction_percentage):\n    \"\"\"Rebuild the polyline with a proportional reduction in points.\"\"\"\n    if len(points) < 2:\n        return points\n\n    new_count = max(2, int(len(points) * (reduction_percentage / 100.0)))\n    interval = len(points) / float(new_count - 1)\n\n    reduced_points = [points[int(round(i * interval))] for i in range(new_count)]\n    return reduced_points\n\n\ndef sketch_with_drag():\n    \"\"\"Main function to sketch a curve by dragging the mouse.\"\"\"\n    print(\"Click and hold to draw. Release to finish.\")\n\n    # Instantiate the custom curve drawer\n    drawer = DragCurveDrawer()\n    drawer.SetCommandPrompt(\"Click and hold to draw. Release to finish.\")\n\n    # Wait for user input\n    result = drawer.Get()\n\n    if result != Rhino.Commands.Result.Success or not drawer.points:\n        print(\"Drawing canceled or failed.\")\n        return\n\n    points = drawer.points\n    if len(points) < 2:\n        print(\"Not enough points captured.\")\n        return\n\n    # Simplify the points\n    tol = 0.1\n    simplified_points = simplify_points(points, tol)\n    if len(simplified_points) < 2:\n        print(\"Simplified points are insufficient to create a polyline.\")\n        return\n\n    # Create the polyline using RhinoCommon\n    polyline = Polyline(simplified_points)\n    if not polyline.IsValid:\n        print(\"Failed to create a valid polyline.\")\n        return\n\n    # Add the polyline to the document\n    polyline_curve = polyline.ToNurbsCurve()\n    if polyline_curve and polyline_curve.IsValid:\n        Rhino.RhinoDoc.ActiveDoc.Objects.AddCurve(polyline_curve)\n        print(\"Polyline added to the document.\")\n    else:\n        print(\"Failed to add the polyline.\")\n\n    # Rebuild the polyline proportionally\n    reduction_percentage = Rhino.Input.RhinoGet.GetNumber(\n        \"Enter the percentage of points to retain (0-100%)\", True, 100\n    )[1]\n    if reduction_percentage is None:\n        print(\"Simplification canceled.\")\n        return\n\n    rebuilt_points = rebuild_polyline_proportional(simplified_points, reduction_percentage)\n    rebuilt_polyline = Polyline(rebuilt_points)\n    rebuilt_curve = rebuilt_polyline.ToNurbsCurve()\n\n    if rebuilt_curve and rebuilt_curve.IsValid:\n        Rhino.RhinoDoc.ActiveDoc.Objects.AddCurve(rebuilt_curve)\n        print(f\"Rebuilt polyline with {len(rebuilt_points)} points added to the document.\")\n    else:\n        print(\"Failed to rebuild the polyline.\")\n\n\nif __name__ == \"__main__\":\n    sketch_with_drag()",
      "language": "python",
      "author": "Pipouille",
      "post_number": 3,
      "is_solution": false
    },
    {
      "code": "﻿using System.Collections.Generic;\nusing Rhino;\nusing Rhino.Commands;\nusing Rhino.Geometry;\nusing Rhino.Input;\nusing Rhino.Input.Custom;\n\nnamespace SampleCsCommands\n{\n  /// <summary>\n  /// GetSketchPoints class\n  /// </summary>\n  internal class GetSketchPoints : GetPoint\n  {\n    private System.Drawing.Point m_previous_point = new System.Drawing.Point(-1, -1);\n\n    public List<Point3d> Points { get; } = new List<Point3d>(2048);\n\n    public GetResult GetPoints()\n    {",
      "language": "csharp",
      "author": "kyle_faulkner",
      "post_number": 4,
      "is_solution": false
    },
    {
      "code": "import Rhino\nimport rhinoscriptsyntax as rs\nfrom System.Drawing import Color\n\ndrawing_started = False\ntemporary_point_id = None\npoints = []\n\n\ndef simplify_points(points, tolerance):\n    if not points or len(points) < 2:\n        return points\n    simplified = [points[0]]\n    for pt in points[1:]:\n        if rs.Distance(simplified[-1], pt) > tolerance:\n            simplified.append(pt)\n    return simplified\n\n\ndef rebuild_polyline_proportional(polyline_id, reduction_percentage):\n    if not rs.IsCurve(polyline_id):\n        print(\"The selected object is not a polyline.\")\n        return None\n    points = rs.CurvePoints(polyline_id)\n    if not points or len(points) < 2:\n        print(\"Unable to retrieve points from the polyline.\")\n        return None\n    initial_points = len(points)\n    new_point_count = max(2, int(initial_points * (reduction_percentage / 100.0)))\n    reduced_points = rs.DivideCurve(polyline_id, new_point_count - 2, create_points=False)\n    if not reduced_points:\n        print(\"Failed to reduce points.\")\n        return None\n    final_points = [points[0]] + reduced_points + [points[-1]]\n    rebuilt_polyline = rs.AddPolyline(final_points)\n    if rebuilt_polyline:\n        print(\"Polyline rebuilt with {} points.\".format(len(final_points)))\n        rs.DeleteObject(polyline_id)\n        print(\"Original polyline deleted.\")\n        return rebuilt_polyline\n    else:\n        print(\"Failed to rebuild the polyline.\")\n        return None\n\n\ndef dynamic_draw(sender, args):\n    global drawing_started, points\n    if drawing_started:\n        current_point = args.CurrentPoint\n        if isinstance(current_point, Rhino.Geometry.Point3d):\n            points.append(current_point)\n            if len(points) > 1:\n                args.Display.DrawPolyline(points, Color.Blue, 2)\n            args.Display.DrawPoint(current_point, Color.Red)\n\n\ndef start_and_stop_drawing():\n    global drawing_started, temporary_point_id, points\n    start_point = rs.GetPoint(\"Click to start drawing.\")\n    if not start_point:\n        print(\"Drawing canceled.\")\n        return False\n    if not isinstance(start_point, Rhino.Geometry.Point3d):\n        start_point = Rhino.Geometry.Point3d(start_point)\n    temporary_point_id = rs.AddPoint(start_point)\n    if not temporary_point_id:\n        print(\"Unable to add the temporary point.\")\n        return False\n    points.append(start_point)\n    drawing_started = True\n    gp = Rhino.Input.Custom.GetPoint()\n    gp.AcceptNothing(True)\n    gp.DynamicDraw += dynamic_draw\n    while True:\n        result = gp.Get()\n        if result == Rhino.Input.GetResult.Point:\n            end_point = gp.Point()\n            points.append(end_point)\n            print(\"Drawing finished with a click.\")\n            break\n        elif result == Rhino.Input.GetResult.Nothing:\n            print(\"Validation with Enter.\")\n            break\n        else:\n            print(\"Drawing canceled or interrupted.\")\n            return False\n    drawing_started = False\n    if temporary_point_id:\n        rs.DeleteObject(temporary_point_id)\n    return True\n\n\ndef sketch_with_proportional_simplification():\n    global points\n    tol = 0.1\n    print(\"Click to start drawing. Move the mouse to sketch. Click or press 'Enter' to finish.\")\n    if not start_and_stop_drawing():\n        return\n    if len(points) < 2:\n        print(\"Not enough points captured to create a polyline.\")\n        return\n    simplified_points = simplify_points(points, tol)\n    polyline_id = rs.AddPolyline(simplified_points)\n    if not polyline_id:\n        print(\"Failed to create the polyline.\")\n        return\n    print(\"Sketch completed with a tolerance of {}.\".format(tol))\n    reduction_percentage = rs.GetReal(\"Enter the percentage of points to retain (0-100%)\", 100, 0, 100)\n    if reduction_percentage is None:\n        print(\"Simplification canceled.\")\n        return\n    rebuilt_polyline = rebuild_polyline_proportional(polyline_id, reduction_percentage)\n    if rebuilt_polyline:\n        print(\"The final polyline has been proportionally simplified with {}% of points retained.\".format(reduction_percentage))\n    else:\n        print(\"Failed to simplify the polyline.\")\n\n\nif __name__ == \"__main__\":\n    sketch_with_proportional_simplification()",
      "language": "python",
      "author": "Pipouille",
      "post_number": 1,
      "is_solution": false
    }
  ],
  "tags": [
    "csharp",
    "file-io",
    "geometry",
    "nurbs",
    "python",
    "rhinocommon",
    "rhinoscriptsyntax",
    "transformation",
    "ui"
  ],
  "has_accepted_answer": false,
  "category_id": 11,
  "posts_count": 4,
  "views": 128
}