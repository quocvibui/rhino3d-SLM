{
  "source_url": "https://github.com/colinlsmatthews/merlin_remote/blob/610962044fe29e4b7616974b53afd56aad5bb400/PythonScripts/SheetFoldingExample.py",
  "repo": "colinlsmatthews/merlin_remote",
  "repo_stars": 0,
  "repo_description": null,
  "license": "unknown",
  "filepath": "PythonScripts/SheetFoldingExample.py",
  "instruction": "Sheet folding example",
  "code": "import clr\nimport sys\nimport os\nsys.path.append(r\"\\\\gilns010\\Merlin\\merlin_remote\\PythonScripts\")\nfrom merlin import VERSION\nfrom merlin.types import *\nfrom merlin.types.cadtypes import LoadModule\n\nfrom System.Reflection import Assembly\n\nroaming_folder = os.getenv(\"APPDATA\")\n\nbundle_path = os.path.join(\n    roaming_folder,\n    \"Autodesk\",\n    \"ApplicationPlugins\",\n    \"AWI Rhino.Inside AutoCAD.bundle\",\n    VERSION,\n    \"Win64\",\n)\n\n# AutoCAD File API\nclr.AddReference(\"Acdbmgd\")\nimport Autodesk\n\n# AutoCAD Application API\nclr.AddReference(\"accoremgd\")\nfrom Autodesk.AutoCAD.ApplicationServices.Core import Application\n\nclr.AddReference(\"AWI.RhinoInside.Interop\")\nimport AWI\nfrom AWI.RhinoInside.Interop.Geometry import *\nfrom AWI.RhinoInside.Interop import *\n\nclr.AddReference(\"AWI.RhinoInside.Core\")\nfrom AWI.RhinoInside.Core import *\nfrom AWI.RhinoInside.Core.Interfaces import *\n\n# NOTE\n# For creating associated dimensions, we have to force AutoCAD to load\n# the ObjectArx runtime extension that is created from the C++ ObjectArx\n# project. Otherwise `clr.AddReference(\"AWI.RhinoInside.ObjectArxWrapper\")`\n# will throw an error and fail. The loading operation will show a warning\n# in AutoCAD the first time and prompt the user to allow loading of a\n# new extension. This might be confusing to some people.\narx_path = os.path.join(bundle_path, \"AWI.RhinoInside.ObjectArx.arx\")\nLoadModule(arx_path, True, False)\n\nclr.AddReference(\"AWI.RhinoInside.ObjectArxWrapper\")\nfrom AWI.RhinoInside.ObjectArxWrapper import *\n\nclr.AddReference(\"AWI.RhinoInside.Services\")\nfrom AWI.RhinoInside.Services import *\n\nclr.AddReference(\"AWI.RhinoInside.API\")\nfrom AWI.RhinoInside.API import *\n\nimport System\nfrom System import Func\n\nimport Rhino.Geometry as rg\nimport rhinoscriptsyntax as rs\n\n# Document interop\ndocumentMananger = AWI.RhinoInside.Interop.DocumentManager.Instance\ndocument = documentMananger.Document\n\n# Use closeAction.SetCloseAction(CloseActionType) to:\n# 1. Close the document without saving (default) input CloseActionType.Unmodified.\n# 2. Close the document and save changes input CloseActionType.Save.\n# 3. Close the document, save changes, and close the underlying AutoCAD document input CloseActionType.SaveAndClose.\n# Alternatively, if you want to save the document after modifying it you can use document.Transaction(func, true) \n# which sets the save flags to option 2.\ncloseAction = documentMananger.CloseAction\n\n# For converting internal geometry types to Rhino geometry types or visa versa\ninternalGeometryConverter = InternalGeometryConverter.Instance\n\n# For converting Rhino geometry types to AutoCAD geometry types or visa versa\nrhinoGeometryConverter = RhinoGeometryConverter.Instance\n\nimport uuid\nimport math\nfrom typing import List, Optional\n\n\nclass SheetMetalFoldingResults:\n    \"\"\"Container class for sheet metal folding results\"\"\"\n    def __init__(self):\n        self.flat_curves: List = []\n        self.fold_curves: List = []\n        self.relief_curves: List = []\n        self.labels: List[str] = []\n        self.meshes: List = []\n        self.breps: List = []\n\n\nclass SheetMetalFolder:\n    \"\"\"Main class for sheet metal folding operations\"\"\"\n    \n    def __init__(\n        self,\n        mold_model,\n        flip: bool,\n        material_thickness: float,\n        material_k_factor: float,\n        bend_radius: float,\n        relief_definition,\n        input_unit_system\n    ):\n        \"\"\"\n        Initialize the sheet metal folder\n        \n        Args:\n            mold_model: RhinoBrep object representing the mold\n            flip: Whether to flip the brep\n            material_thickness: Thickness of the material\n            material_k_factor: K-factor for bend calculations\n            bend_radius: Radius of the bend\n            relief_definition: Relief definition object\n            input_unit_system: Unit system for input values\n        \"\"\"\n        # Store constructor parameters as private instance attributes\n        self._brep = mold_model\n        self._flip = flip\n        self._thickness = material_thickness\n        self._k_factor = material_k_factor\n        self._bend_radius = bend_radius\n        self._relief_definition = relief_definition\n        self._input_unit_system = input_unit_system\n        \n        # Internal unit system (constant)\n        self._internal_unit_system = AwiUnitSystem.Inches\n        \n        # Unit system manager\n        self._unit_system_manager = UnitSystemManager(\n            self._input_unit_system, \n            self._internal_unit_system\n        )\n        \n        # Geometry converters (initialized later)\n        self._geometry_converter = None\n        self._internal_geometry_converter = None\n        \n        # Axis definitions\n        self._x_axis = AwiVector3d.x_axis()\n        self._y_axis = AwiVector3d.y_axis()\n        self._z_axis = AwiVector3d.z_axis()\n        \n        # Initialize converters\n        self._initialize_converters(self._unit_system_manager)\n    \n    def fold(self) -> SheetMetalFoldingResults:\n        \"\"\"\n        Main folding operation that calculates both 2D flat pattern and 3D folded model\n        \n        Returns:\n            SheetMetalFoldingResults object containing all calculated geometry\n        \"\"\"\n        # Initialize output container class\n        output_results = SheetMetalFoldingResults()\n        \n        # Create material and tool definitions\n        material_definition = SheetMetalMaterialDefinition()\n        material_definition.id = uuid.uuid4()\n        material_definition.thickness = UnitLength(self._thickness, self._input_unit_system)\n        material_definition.name = \"Grasshopper Dynamic Sheet Metal Material\"\n        material_definition.k_factor = self._k_factor\n        \n        folding_tool_definition = FoldingToolDefinition()\n        folding_tool_definition.radius = UnitLength(self._bend_radius, self._input_unit_system)\n        \n        # Prepare brep for 2d and 3d calculations\n        brep_for_2d = self._brep.duplicate_brep()\n        if self._flip:\n            brep_for_2d.flip()\n        brep_for_3d = self._brep.duplicate_brep()\n        \n        # Calculate the 2d flat pattern\n        solid = Solid(brep_for_2d)\n        panel_mold_model_3d = PanelMoldModel3d(solid)\n        folded_panel = FoldedPanel(\n            panel_mold_model_3d, \n            material_definition, \n            folding_tool_definition\n        )\n        panel_flat = PanelFlat(folded_panel, self._relief_definition)\n        \n        drawing_plane_origin = Point3d(0, 0, 0)\n        drawing_plane = Plane(drawing_plane_origin, self._x_axis, self._y_axis)\n        panel_flat_drawing = PanelFlatDrawing(panel_flat, drawing_plane, True)\n        \n        # Calculate the 3d folded model\n        solid_for_3d = Solid(brep_for_3d)\n        panel_mold_model_3d_for_3d = PanelMoldModel3d(solid_for_3d)\n        folded_panel_for_3d = FoldedPanel(\n            panel_mold_model_3d_for_3d, \n            material_definition, \n            folding_tool_definition\n        )\n        model_3d = FoldedModel3d(folded_panel_for_3d)\n        \n        # Convert results to Rhino types\n        self._create_panel_flat_in_rhino(panel_flat_drawing, output_results)\n        self._create_folded_model_in_rhino(model_3d, output_results)\n        \n        return output_results\n    \n    def _create_panel_flat_in_rhino(\n        self, \n        panel_flat_drawing, \n        results: SheetMetalFoldingResults\n    ) -> None:\n        \"\"\"\n        Create flat panel representation and populate results\n        \n        Args:\n            panel_flat_drawing: IPanelFlatDrawing object\n            results: SheetMetalFoldingResults object to populate\n        \"\"\"\n        # Process panel outline curves\n        flat_curves_output = []\n        for outline_curve in panel_flat_drawing.panel_outlines:\n            if outline_curve.get_length() < 0.1:\n                continue\n            \n            rhino_curve = self._internal_geometry_converter.to_rhino_type(outline_curve)\n            nurbs_curve = rhino_curve.to_nurbs_curve()\n            flat_curves_output.append(nurbs_curve)\n        \n        results.flat_curves = flat_curves_output\n        \n        # Process fold line curves\n        fold_curves_output = []\n        for fold_curve in panel_flat_drawing.fold_lines:\n            rhino_curve = self._internal_geometry_converter.to_rhino_type(fold_curve)\n            nurbs_curve = rhino_curve.to_nurbs_curve()\n            fold_curves_output.append(nurbs_curve)\n        \n        results.fold_curves = fold_curves_output\n        \n        # Process relief profile curves\n        relief_profiles_output = []\n        for relief_profile in panel_flat_drawing.relief_profiles:\n            rhino_curve = self._internal_geometry_converter.to_rhino_type(relief_profile)\n            nurbs_curve = rhino_curve.to_nurbs_curve()\n            relief_profiles_output.append(nurbs_curve)\n        \n        results.relief_curves = relief_profiles_output\n        \n        # Process fold labels\n        index = 0\n        labels_output = []\n        for item in panel_flat_drawing.fold_labels:\n            # Get corresponding fold line if available\n            corresponding_fold = None\n            if index < len(panel_flat_drawing.fold_lines):\n                corresponding_fold = panel_flat_drawing.fold_lines[index]\n            \n            # Calculate rotation\n            if corresponding_fold is None:\n                rotation = 0\n            else:\n                rotation = corresponding_fold.tangent_at_start.angle_on_plane_to(\n                    self._x_axis, \n                    self._z_axis\n                )\n                if rotation > math.pi / 2:\n                    rotation -= math.pi\n            \n            # Format label text\n            text = (f\"Index: {item.index_text}, \"\n                   f\"Bend Angle: {item.bend_text}, \"\n                   f\"Fold: {item.orientation_text}\")\n            \n            # Get location for future updates which will return a text dot (for Rhino 8)\n            rhino_location = self._internal_geometry_converter.to_rhino_type(item.location)\n            \n            labels_output.append(text)\n            index += 1\n        \n        results.labels = labels_output\n    \n    def _create_folded_model_in_rhino(\n        self, \n        model_3d, \n        results: SheetMetalFoldingResults\n    ) -> None:\n        \"\"\"\n        Create 3D folded model and populate results\n        \n        Args:\n            model_3d: IFoldedModel3d object\n            results: SheetMetalFoldingResults object to populate\n        \"\"\"\n        panel_3d_geometry = model_3d.get_combined_model_3d()\n        \n        output_meshes = []\n        output_breps = []\n        \n        for solid in panel_3d_geometry:\n            rhino_brep = self._internal_geometry_converter.to_rhino_type(solid)\n            \n            if rhino_brep is None:\n                continue\n            \n            output_breps.append(rhino_brep)\n            \n            # Create meshes from brep\n            meshes = RhinoMesh.create_from_brep(\n                rhino_brep, \n                Rhino.Geometry.MeshingParameters.default_analysis_mesh()\n            )\n            \n            # Join and process meshes\n            mesh_joined = RhinoMesh()\n            mesh_joined.append(meshes)\n            mesh_joined.faces.cull_degenerate_faces()\n            mesh_joined.vertices.cull_unused()\n            mesh_joined.unify_normals()\n            mesh_joined.normals.compute_normals()\n            \n            output_meshes.append(mesh_joined)\n        \n        results.meshes = output_meshes\n        results.breps = output_breps\n    \n    def _initialize_converters(self, unit_system_manager) -> None:\n        \"\"\"\n        Initialize geometry converters (singleton pattern)\n        \n        Args:\n            unit_system_manager: UnitSystemManager instance\n        \"\"\"\n        if self._geometry_converter is None:\n            RhinoGeometryConverter.initialize(unit_system_manager)\n        \n        if self._internal_geometry_converter is None:\n            InternalGeometryConverter.initialize(unit_system_manager)\n        \n        self._geometry_converter = RhinoGeometryConverter.instance\n        self._internal_geometry_converter = InternalGeometryConverter.instance\n\n\n# Example usage:\n# folder = SheetMetalFolder(\n#     mold_model=my_brep,\n#     flip=False,\n#     material_thickness=0.125,\n#     material_k_factor=0.44,\n#     bend_radius=0.0625,\n#     relief_definition=my_relief_def,\n#     input_unit_system=UnitSystem.INCHES\n# )\n# results = folder.fold()\n# print(f\"Generated {len(results.flat_curves)} flat curves\")\n# print(f\"Generated {len(results.meshes)} meshes\")",
  "language": "python",
  "imports": [
    "Rhino",
    "Rhino.Geometry",
    "rhinoscriptsyntax"
  ],
  "has_docstring": false
}