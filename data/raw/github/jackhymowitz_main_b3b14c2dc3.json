{
  "source_url": "https://github.com/jackhymowitz/main/blob/7325131db23094f1a28bd184b6a68f864f41a729/01_GH_Components/py/BT_PHPProomsFromRH.py",
  "repo": "jackhymowitz/main",
  "repo_stars": 0,
  "repo_description": "IDF2PH is a free open source toolkit for working with E+ and PHPP Energy Models",
  "license": "GPL-3.0",
  "filepath": "01_GH_Components/py/BT_PHPProomsFromRH.py",
  "instruction": "Will try and figure out the 'Rooms' inside each of the HB zones.\r\r\n-\r\r\n> Rooms hold onto floor-area data, Ventilation system configurations, fresh-air flow rate, etc.\r\r\n> This component allows for...",
  "code": "#\r\r\n# IDF2PHPP: A Plugin for exporting an EnergyPlus IDF file to the Passive House Planning Package (PHPP). Created by blgdtyp, llc\r\r\n# \r\r\n# This component is part of IDF2PHPP.\r\r\n# \r\r\n# Copyright (c) 2020, bldgtyp, llc <info@bldgtyp.com> \r\r\n# IDF2PHPP is free software; you can redistribute it and/or modify \r\r\n# it under the terms of the GNU General Public License as published \r\r\n# by the Free Software Foundation; either version 3 of the License, \r\r\n# or (at your option) any later version. \r\r\n# \r\r\n# IDF2PHPP is distributed in the hope that it will be useful,\r\r\n# but WITHOUT ANY WARRANTY; without even the implied warranty of \r\r\n# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the \r\r\n# GNU General Public License for more details.\r\r\n# \r\r\n# For a copy of the GNU General Public License\r\r\n# see <http://www.gnu.org/licenses/>.\r\r\n# \r\r\n# @license GPL-3.0+ <http://spdx.org/licenses/GPL-3.0+>\r\r\n#\r\r\n\"\"\"\r\r\nWill try and figure out the 'Rooms' inside each of the HB zones.\r\r\n-\r\r\n> Rooms hold onto floor-area data, Ventilation system configurations, fresh-air flow rate, etc.\r\r\n> This component allows for user-input of geometry for floor areas and rooms in the Rhino Scene.\r\r\n> If no room geometry is input, wil create a new room for each TFA surface with a height of 2.5m\r\r\n> Note that a 'Room' can have more than one floor area / volume / space (closets in bedrooms, for instance).\r\r\n> This component will need to be able to read TFA and Room Name/Number data from the Rhino Scene (User-Text 'Object Name', 'Room_Number', 'TFA_Factor').\r\r\n-\r\r\nEM July 31, 2020\r\r\n\r\r\n    Args:\r\r\n        _roomTFASurfaces: (List) An input for the user-determined room floor area(s) to use.\r\r\n        Supply inputs as surfaces. Use the Rhino tools to apply TFA information (TFA Factor, Roomname, etc..)\r\r\n        in the Rhino scene before passing in here. Will bundle together rooms with the same number+name and\r\r\n        will try and join together tfa surfaces that touch (if they have the same number+name).\r\r\n        _roomGeometry: (List) <Optional> An input for user-determined room geometry describing the space-shape of the rooms. \r\r\n        If no inputs are supplied, the component will just build a room with a standard ceiling height of 2.5m (8.2ft).\r\r\n        If supplied, best-practice is to join together each room's surfaces (walls+ceilings) into a single poly-surface (1 per room). Be sure\r\r\n        to leave off the TFA surface (leave 'open' on the bottom) so that the TFA srfc can be joined to it in the component here.\r\r\n        _HBZones: (List) A list of all the HB Zones to use.\r\r\n    Returns:\r\r\n        roomBreps_: A preview of all the PHPP-Room Breps built by this component\r\r\n        rooms_: A list of all the PHPP-Room Objects built\r\r\n        HBZones_: the HB Zone Objects with the new PHPP-Rooms added. (Added as attribute 'PHPProoms' - a list of all the Room Objects)\r\r\n\"\"\"\r\r\n\r\r\nghenv.Component.Name = \"BT_PHPProomsFromRH\"\r\r\nghenv.Component.NickName = \"PHPP Rooms from Rhino\"\r\r\nghenv.Component.Message = 'JUL_31_2020'\r\r\nghenv.Component.IconDisplayMode = ghenv.Component.IconDisplayMode.application\r\r\nghenv.Component.Category = \"BT\"\r\r\nghenv.Component.SubCategory = \"01 | Model\"\r\r\n\r\r\nimport rhinoscriptsyntax as rs\r\r\nimport Grasshopper.Kernel as ghK\r\r\nimport ghpythonlib.components as ghc\r\r\nimport scriptcontext as sc\r\r\nimport Rhino\r\r\nfrom contextlib import contextmanager\r\r\nimport copy\r\r\nfrom collections import defaultdict\r\r\n\r\r\n# Classes and Defs\r\r\npreview=sc.sticky['Preview']\r\r\nPHPP_TFA_Surface = sc.sticky['PHPP_TFA_Surface']\r\r\nPHPP_Room = sc.sticky['PHPP_Room']\r\r\nPHPP_RoomVolume = sc.sticky['PHPP_RoomVolume']\r\r\nPHPP_Sys_Ventilation = sc.sticky['PHPP_Sys_Ventilation']\r\r\n\r\r\nhb_hive = sc.sticky[\"honeybee_Hive\"]()\r\r\nHBZoneObjects = hb_hive.callFromHoneybeeHive(_HBZones)\r\r\n\r\r\n@contextmanager\r\r\ndef rhDoc():\r\r\n    \"\"\"For reaching into the Rhino document\r\r\n    to get params for Objects\"\"\"\r\r\n    \r\r\n    try:\r\r\n        sc.doc = Rhino.RhinoDoc.ActiveDoc\r\r\n        yield\r\r\n    finally:\r\r\n        sc.doc = ghdoc\r\r\n\r\r\ndef joinTouchingTFAsurfaces(_tfaSrfcObjs, _HBzoneObjs):\r\r\n    # Takes in a set of TFA Surface Objects that are touching\r\r\n    # Returns a new single TFA Surface Obj with averaged / joined values\r\r\n    srfcExtPerims = []\r\r\n    AreaGross = []\r\r\n    TFAs = []\r\r\n    \r\r\n    # Figure out the new joined room's Ventilation Flow Rates\r\r\n    ventFlowRates_Sup = []\r\r\n    ventFlowRates_Eta = []\r\r\n    ventFlowRates_Tran = []\r\r\n    # Get all the already input flow rates for the TFA Surfaces (if any)\r\r\n    for srfcObj in _tfaSrfcObjs:\r\r\n        ventFlowRates_Sup.append(srfcObj.V_sup)\r\r\n        ventFlowRates_Eta.append(srfcObj.V_eta)\r\r\n        ventFlowRates_Tran.append(srfcObj.V_trans)\r\r\n    \r\r\n    # Use the max values from the input set as the new Unioned objs' vent flow rates\r\r\n    unionedSrfcVentRates = [max(ventFlowRates_Sup), max(ventFlowRates_Eta), max(ventFlowRates_Tran) ]\r\r\n    \r\r\n    for srfcObj in _tfaSrfcObjs:\r\r\n        TFAs.append( srfcObj.getArea_TFA() )\r\r\n        AreaGross.append(srfcObj.Area_Gross)\r\r\n        srfcExtEdges = ghc.BrepEdges( rs.coercebrep(srfcObj.Surface) )[0]\r\r\n        srfcExtPerims.append( ghc.JoinCurves( srfcExtEdges, preserve=False ) )\r\r\n    \r\r\n    unionedSrfc = ghc.RegionUnion(srfcExtPerims)\r\r\n    unionedTFAObj = PHPP_TFA_Surface(unionedSrfc, _HBzoneObjs, unionedSrfcVentRates, _inset=0, _offsetZ=0)\r\r\n    \r\r\n    # Set the TFA Surface Attributes\r\r\n    unionedTFAObj.Area_Gross = sum(AreaGross)\r\r\n    unionedTFAObj.TFAfactor = sum(TFAs) / sum(AreaGross)\r\r\n    unionedTFAObj.RoomNumber = _tfaSrfcObjs[0].RoomNumber\r\r\n    unionedTFAObj.RoomName = _tfaSrfcObjs[0].RoomName\r\r\n    \r\r\n    return unionedTFAObj\r\r\n\r\r\ndef createTFASurfaces(_tfaSrfcs, _HBZoneObjects):\r\r\n    \"\"\"Creates TFA Surface Objects from input with all their parameter values\"\"\"\r\r\n    \r\r\n    tfaSurfacObjs = []\r\r\n    tfaSurfacObjsDict = {}\r\r\n    \r\r\n    for srfc in _tfaSrfcs:\r\r\n        # Create a new TFA Surface Object for the geometry item (Curve, Surface) input\r\r\n        try:\r\r\n            newTFASurfaceObj = PHPP_TFA_Surface(srfc, _HBZoneObjects, _roomVentFlowRates='Automatic', _inset=0, _offsetZ=0)\r\r\n            tfaSurfacObjs.append(newTFASurfaceObj)\r\r\n            \r\r\n            # Add to the dictionary\r\r\n            key = \"{}-{}\".format(newTFASurfaceObj.RoomNumber, newTFASurfaceObj.RoomName)\r\r\n            if key not in tfaSurfacObjsDict.keys():\r\r\n                tfaSurfacObjsDict[key] = [newTFASurfaceObj]\r\r\n            else:\r\r\n                tfaSurfacObjsDict[key].append(newTFASurfaceObj)\r\r\n        except:\r\r\n            errorMsg = \"Something went wrong building the TFA Floor Surfaces. Are you sure you applied TFA and Room Name info for all the surfaces?\"\r\r\n            ghenv.Component.AddRuntimeMessage(ghK.GH_RuntimeMessageLevel.Warning, errorMsg)\r\r\n        \r\r\n    return tfaSurfacObjsDict\r\r\n\r\r\ndef findNeighbors(_srfcList):\r\r\n    \"\"\" Takes in a list of surfaces. tests against others in the\r\r\n    set to see if they are touching. Adds a 'Neighbor' marker if so\"\"\"\r\r\n    \r\r\n    for i, srfc in enumerate(_srfcList):\r\r\n        \r\r\n        for k in range(0, len(_srfcList)):\r\r\n            #print 'Surface: {} looking at Surface: {}...'.format(i, k)\r\r\n            vertsI =  ghc.DeconstructBrep( _srfcList[i].Surface ).vertices\r\r\n            vertsK =  ghc.DeconstructBrep( _srfcList[k].Surface ).vertices\r\r\n            \r\r\n            if ghc.BrepXBrep(_srfcList[i].Surface, _srfcList[k].Surface).curves:\r\r\n                if _srfcList[i].Neighbors != None:\r\r\n                    matchSetID = _srfcList[i].Neighbors\r\r\n                elif _srfcList[k].Neighbors != None:\r\r\n                    matchSetID = _srfcList[k].Neighbors\r\r\n                else:\r\r\n                    matchSetID = i\r\r\n                \r\r\n                _srfcList[i].addNeighbor(matchSetID) #branch[k].ID)\r\r\n                _srfcList[k].addNeighbor(matchSetID) #branch[i].ID)\r\r\n    \r\r\n    return _srfcList\r\r\n\r\r\ndef binByNeighbor(_srfcList):\r\r\n    \"\"\"Creates a dict of surfaces, using the 'Neighbor' as key. So\r\r\n    will return a dict with lists of surfaces with multiple values if\r\r\n    they are touching\"\"\"\r\r\n    \r\r\n    srfcSets = {}\r\r\n    \r\r\n    for each in _srfcList:\r\r\n        if each.Neighbors == None:\r\r\n            srfcSets[each.ID] = [each]\r\r\n        else:\r\r\n            if each.Neighbors not in srfcSets.keys():\r\r\n                srfcSets[each.Neighbors] = [each]\r\r\n            else:\r\r\n                srfcSets[each.Neighbors].append(each)\r\r\n    \r\r\n    return srfcSets\r\r\n\r\r\nroomGeomBreps = []\r\r\nroomBreps_ = []\r\r\ntfaSrfcBreps = []\r\r\nrooms_ = []\r\r\ntfaSrfcObjs_Unioned = []\r\r\ntfaSrfcObjs = {}\r\r\nroomsDict = defaultdict()\r\r\n\r\r\n#------------------------------------------------------------------------------\r\r\n# Get the Brep Geometry from Rhino Scene\r\r\n# Get all the Room Geomerty Breps, TFA Geometry Breps, TFA Surface Objects\r\r\nwith rhDoc():\r\r\n    for i, brepGUID in enumerate(_roomGeometry): roomGeomBreps.append(rs.coercebrep(brepGUID) )\r\r\n    for i, brepGUID in enumerate(_roomTFASurfaces): tfaSrfcBreps.append(rs.coercebrep(brepGUID) )\r\r\n    if len(_roomTFASurfaces)>0 and len(_HBZones)>0: tfaSrfcObjs = createTFASurfaces(_roomTFASurfaces, HBZoneObjects)\r\r\n\r\r\n#------------------------------------------------------------------------------\r\r\n# Build a Default room if nothing is passed in\r\r\nif len(_HBZones)>0 and len(_roomTFASurfaces)==0:\r\r\n    # Create the TFA surface from the floor\r\r\n    for i in range(len(HBZoneObjects)):\r\r\n        for surface in HBZoneObjects[i].surfaces:\r\r\n            if surface.type >= 2 and surface.type <3: # 2-3 are the Floor surface types\r\r\n                # Get the Vent flow rates, if any\r\r\n                try:\r\r\n                    ventFlowRates = roomVentFlowRates_.Branch(0)\r\r\n                except:\r\r\n                    ventFlowRates = ['Automatic']\r\r\n                try:\r\r\n                    newTFASurfaceObj = PHPP_TFA_Surface(surface.geometry, HBZoneObjects, ventFlowRates, _inset=0.1, _offsetZ=0.1)\r\r\n                except:\r\r\n                    errorMsg = \"Something went wrong building the TFA Floor Surfaces.\"\\\r\r\n                    \"Are you sure you applied TFA and Room Name info for all the surfaces?\"\r\r\n                    ghenv.Component.AddRuntimeMessage(ghK.GH_RuntimeMessageLevel.Warning, errorMsg)\r\r\n                tfaSrfcObjs = {'000-DEFAULT' : [newTFASurfaceObj] }\r\r\n\r\r\n#------------------------------------------------------------------------------\r\r\n# Join Together any touching TFA Surfaces\r\r\nfor k, tfaSrfcObjList in tfaSrfcObjs.items():\r\r\n    # Join TFA surfaces if needed\r\r\n    if len(tfaSrfcObjList)>1:\r\r\n        srfcSets = findNeighbors(tfaSrfcObjList)\r\r\n        srfcSets_Joined = binByNeighbor(srfcSets)\r\r\n        for k, each in srfcSets_Joined.items():\r\r\n            if len(each)>1:\r\r\n                joinedSrfc = joinTouchingTFAsurfaces(each, HBZoneObjects)\r\r\n                tfaSrfcObjs_Unioned.append( joinedSrfc )\r\r\n            else:\r\r\n                tfaSrfcObjs_Unioned.append( each[0] )\r\r\n    else:\r\r\n        tfaSrfcObjs_Unioned.append( tfaSrfcObjList[0] )\r\r\n\r\r\n#------------------------------------------------------------------------------\r\r\n# Build the Rooms for each TFA Surface\r\r\n# Sort the rooms into a dict based on RoomNumber and RoomName\r\r\n\r\r\nfor tfaSrfcObj in tfaSrfcObjs_Unioned:\r\r\n    if tfaSrfcObj.HostError == True:\r\r\n        roomName = getattr(tfaSrfcObj, 'RoomName', 'No Room Name')\r\r\n        roomNum = getattr(tfaSrfcObj, 'RoomNumber', 'No Room Number')\r\r\n        msg = \"Couldn't figure out which zone the room '{}-{}' should \"\\\r\r\n        \"go in?\\nMake sure the room is completely inside one or another zone.\".format(roomNum, roomName)\r\r\n        ghenv.Component.AddRuntimeMessage(ghK.GH_RuntimeMessageLevel.Warning, msg)\r\r\n        continue\r\r\n    \r\r\n    # If Room Geometry passed in, do:\r\r\n    # See if you can make a closed room Brep\r\r\n    # If you can, create a new Room Volume from the closed Brep set\r\r\n    # Then remove that Room's Geom from the set to test (to speed future search?)\r\r\n    # If no closables match found, create a default room volume\r\r\n    # If no room geom input, just build a default size room for each\r\r\n    if len(roomGeomBreps)>0:\r\r\n        for i, roomGeom in enumerate(roomGeomBreps):\r\r\n            tfaFloorJoinedToGeom = ghc.BrepJoin([roomGeom, tfaSrfcObj.Surface])\r\r\n            if tfaFloorJoinedToGeom.closed==True:\r\r\n                newRmVol = PHPP_RoomVolume(tfaSrfcObj, roomGeom)\r\r\n                roomGeomBreps.pop(i)\r\r\n                break\r\r\n        else:\r\r\n            newRmVol = PHPP_RoomVolume(tfaSrfcObj, _roomGeom=None, _roomHeightUD=2.5)\r\r\n            roomName = getattr(tfaSrfcObj, 'RoomName', 'No Room Name')\r\r\n            roomNum = getattr(tfaSrfcObj, 'RoomNumber', 'No Room Number')\r\r\n            msg = \"I could not join the room TFA surface and any room\\n\"\\\r\r\n            \"geometry together to make a closed Brep for room: '{}-{}'.\\n\"\\\r\r\n            \"Please ensure that the geometry can be joined and try again.\".format(roomNum, roomName)\r\r\n            ghenv.Component.AddRuntimeMessage(ghK.GH_RuntimeMessageLevel.Remark, msg)\r\r\n    else:\r\r\n        newRmVol = PHPP_RoomVolume(tfaSrfcObj, _roomGeom=None, _roomHeightUD=2.5)\r\r\n    \r\r\n    # Sort the new Room Volume into the master Dict based on name\r\r\n    if tfaSrfcObj.RoomNumber != 'None' and tfaSrfcObj.RoomName.upper() != 'None':\r\r\n        key = str(tfaSrfcObj.RoomNumber) + '_' + str(tfaSrfcObj.RoomName).upper()\r\r\n    else:\r\r\n        key = len(roomsDict.keys())\r\r\n    \r\r\n    if key in roomsDict.keys():\r\r\n        roomsDict[key].append( newRmVol )\r\r\n    else:\r\r\n        roomsDict[key] = [ newRmVol ]\r\r\n\r\r\n#------------------------------------------------------------------------------\r\r\n# Build the final Rooms from all the the Room Volume Objects\r\r\nfor roomVolumes in roomsDict.values():\r\r\n    # Create a single new Room from the list of Room Volumes\r\r\n    newRoomObj = PHPP_Room( roomVolumes)\r\r\n    \r\r\n    # Preview Outputs\r\r\n    rooms_.append(newRoomObj)\r\r\n    for eachRoomBrep in newRoomObj.RoomBreps:\r\r\n        roomBreps_.append(eachRoomBrep)\r\r\n\r\r\n#------------------------------------------------------------------------------\r\r\n# Add a list of the Room Objects to the Zone as an attribute\r\r\nif len(_HBZones)>0:\r\r\n    # Add the new Rooms to the right host Honeybee Zone\r\r\n    for zone in HBZoneObjects:\r\r\n        # Add a Default Vent System to the Zone\r\r\n        defaultVentSystem = PHPP_Sys_Ventilation()\r\r\n        setattr(zone, 'PHPP_VentSys', defaultVentSystem)\r\r\n        \r\r\n        zoneRooms = []\r\r\n        for room in rooms_:\r\r\n            if room.HostZoneName == zone.name:\r\r\n                # Assign the Default Vent Unit for the Zone's rooms\r\r\n                setattr(room, 'VentUnitName', defaultVentSystem.Unit_Name)\r\r\n                setattr(room, 'VentSystemName', defaultVentSystem.SystemName)\r\r\n                zoneRooms.append(room)\r\r\n        setattr(zone, 'PHPProoms', zoneRooms)\r\r\n    \r\r\n    # Add the modified Honeybee zone objects back to the HB dictionary\r\r\n    HBZones_  = hb_hive.addToHoneybeeHive(HBZoneObjects, ghenv.Component)\r\n",
  "language": "python",
  "imports": [
    "Rhino",
    "ghpythonlib",
    "rhinoscriptsyntax",
    "scriptcontext"
  ],
  "has_docstring": true
}