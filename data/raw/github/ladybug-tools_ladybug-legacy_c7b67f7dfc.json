{
  "source_url": "https://github.com/ladybug-tools/ladybug-legacy/blob/d90db02f2776febbb38100dea26ec0c93e77aa53/src/Ladybug_Export%20Ladybug.py",
  "repo": "ladybug-tools/ladybug-legacy",
  "repo_stars": 202,
  "repo_description": ":beetle: Ladybug is an environmental plugin for Grasshopper.",
  "license": "NOASSERTION",
  "filepath": "src/Ladybug_Export Ladybug.py",
  "instruction": "Code Developers of Ladybug and Honeybee can use this component to export Ladybug/Honeybee user objects and source code that they create to the Github folder on their computer.\nThis eases and...",
  "code": "#\n# Ladybug: A Plugin for Environmental Analysis (GPL) started by Mostapha Sadeghipour Roudsari\n# \n# This file is part of Ladybug.\n# \n# Copyright (c) 2013-2019, Mostapha Sadeghipour Roudsari <Sadeghipour@gmail.com> \n# Ladybug is free software; you can redistribute it and//or modify \n# it under the terms of the GNU General Public License as published \n# by the Free Software Foundation; either version 3 of the License, \n# or (at your option) any later version. \n# \n# Ladybug is distributed in the hope that it will be useful,\n# but WITHOUT ANY WARRANTY; without even the implied warranty of \n# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the \n# GNU General Public License for more details.\n# \n# You should have received a copy of the GNU General Public License\n# along with Ladybug; If not, see <http://www.gnu.org/licenses/>.\n# \n# @license GPL-3.0+ <http://spdx.org/licenses/GPL-3.0+>\n\n\n\"\"\"\nCode Developers of Ladybug and Honeybee can use this component to export Ladybug/Honeybee user objects and source code that they create to the Github folder on their computer.\nThis eases and automates the steps before commiting new components to the Github.\nThis component was written thanks to Giulio Piacentino a really helpful example.\n-\nProvided by Ladybug 0.0.67\n\n    Args:\n        _components: Any output from a new Ladybug (or Honeybee) component that you wish to export. Right now, only one component can be connected at a time but you can input a \"*\" (without quotation marks) to search all changed Ladybug components on a grasshopper canvas.\n        _targetFolder: A file path on your system which you would like to export the user object and source code to.  For most code developers, this file path will lead to their Github folder for Ladybug (or Honeybee), which is usually installed in \"My Documents\" by default. Exported source code will be saved at .\\src and exported userObjects will be saved at .\\userObjects in this _targetFolder.\n        _export: Set to \"True\" to export Ladybug (or Honeybee) components to the _targerFolder.\n    Returns:\n        readMe!: ...\n\"\"\"\n\nghenv.Component.Name = \"Ladybug_Export Ladybug\"\nghenv.Component.NickName = 'exportLadybug'\nghenv.Component.Message = 'VER 0.0.69\\nJUL_07_2020'\nghenv.Component.Category = \"LB-Legacy\"\nghenv.Component.SubCategory = \"6 | Developers\"\n#compatibleLBVersion = VER 0.0.59\\nFEB_01_2015\ntry: ghenv.Component.AdditionalHelpFromDocStrings = \"1\"\nexcept: pass\n\nimport Grasshopper.Folders as folders\nimport Grasshopper.Kernel as gh\nimport scriptcontext as sc\nimport shutil\nimport os\nimport uuid\n\nUOFolder = folders.UserObjectFolders[0]\ncs = gh.GH_ComponentServer()\n\n#gh.GH_ComponentServer\n\nexposureDict = {0 : ghenv.Component.Exposure.dropdown,\n                1 : ghenv.Component.Exposure.primary,\n                2 : ghenv.Component.Exposure.secondary,\n                3 : ghenv.Component.Exposure.tertiary,\n                4 : ghenv.Component.Exposure.quarternary,\n                5 : ghenv.Component.Exposure.quinary,\n                6 : ghenv.Component.Exposure.senary,\n                7 : ghenv.Component.Exposure.septenary\n                }\n\ndef exportToUserObject(component, targetFolder, lb_preparation):\n    \n    targetFolder = os.path.join(targetFolder, \"userObjects\")\n    \n    if not os.path.isdir(targetFolder):\n        os.mkdir(targetFolder)\n    \n    def isNewerVersion(currentUO, component):\n        # check if the component has a newer version than the current userObjects\n        # version of the connected component\n        if component.Message == None: return True\n        if len(component.Message.split(\"\\n\"))<2: return True\n        \n        ghVersion, ghDate = component.Message.split(\"\\n\")\n        ghCompVersion = map(int, ghVersion.split(\"VER \")[1].split(\".\"))\n        month, day, ghYear  = ghDate.split(\"_\")\n        # print version, date\n        month = lb_preparation.monthList.index(month.upper()) + 1\n        ghCompDate = int(lb_preparation.getJD(month, day))\n        \n        # in case there was no date for the userobject\n        # the file will be considered older and will be overwrittern\n        ghComponent = currentUO.InstantiateObject()\n        # this is not the best way but works for now!\n        # should be a better way to compute the component and get the message\n        componentCode = ghComponent.Code.split(\"\\n\")\n        \n        UODate = ghCompDate - 1\n        # version of the file\n        for lineCount, line in enumerate(componentCode):\n            if lineCount > 200: break\n            if line.strip().startswith(\"ghenv.Component.Message\"):\n                #print line\n                # print line.split(\"=\")[1].strip().split(\"\\n\")\n                version, date = line.split(\"=\")[1].strip().split(\"\\\\n\")\n                \n                # in case the file doesn't have an standard Ladybug message let it be updated\n                try: UOVersion = map(int, version.split(\"VER \")[1].split(\".\"))\n                except: return True\n                month, day, UOYear  = date.split(\"_\")\n                \n                # should find the reason and fix it later\n                if month == \"SEPT\": month = \"SEP\"\n                \n                month = lb_preparation.monthList.index(month.upper()) + 1\n                UODate = int(lb_preparation.getJD(month, day))\n                break\n        \n        # check if the version of the code is newer\n        try:\n            if int(ghYear.strip()) > int(UOYear[:-1].strip()):\n                    return True\n            elif ghCompDate > UODate:\n                return True\n            elif ghCompDate == UODate:\n                for ghVer, UOVer in zip(UOVersion, UOVersion):\n                    if ghVer < UOVer: return False\n                return True\n            else:\n                print \"\\nThere is a newer userObject in Grasshopper folder that will be copied: \" + currentUO.Path + \".\" + \\\n                      \"\\nUserObject version is: \" +  version + \" \" + date + \\\n                      \"\\nThe component version is: \"  +  ghVersion + \" \" + ghDate + \".\\n\"\n                \n                return False\n        except:\n            return True\n            \n    # check if the userObject is already existed in the folder\n    try:\n        filePath = os.path.join(UOFolder, component.Name + \".ghuser\")\n        currentUO = gh.GH_UserObject(filePath)\n    except:\n        try:\n            #  new folder structure\n            filePath = os.path.join(UOFolder, component.Category,\n                                    component.Name + \".ghuser\")\n            currentUO = gh.GH_UserObject(filePath)\n        except:\n            # the userobject is not there so just create it\n            currentUO = None\n\n\n    if currentUO != None:\n        # if is newer remove\n        if isNewerVersion(currentUO, component):\n            # it has a newer version so let's remove the old one and creat\n            # a new userobject\n            pass\n            if not component.Category == \"Maths\":\n                removeNicely = cs.RemoveCachedObject(filePath)\n                if not removeNicely:\n                    os.remove(filePath)\n        else:\n            # there is already a newer version so just copy that to the folder\n            # instead and return\n            dstFullPath = os.path.join(targetFolder, component.Name + \".ghuser\")\n            shutil.copy2(filePath, dstFullPath)\n            return\n    \n    # create the new userObject in Grasshopper folder\n    uo = gh.GH_UserObject()\n    uo.Icon = component.Icon_24x24\n\n    try: uo.Exposure = exposureDict[int(component.AdditionalHelpFromDocStrings)]\n    except:\n        try:\n            compCode = component.Code\n            # this is so dirty\n            exposureNumber = compCode.split(\"ghenv.Component.AdditionalHelpFromDocStrings\")[1].split(\"\\n\")[0].replace(\"=\", \"\").replace('\"', \"\").strip()\n            uo.Exposure = exposureDict[int(exposureNumber)]\n            \n        except:\n            uo.Exposure = exposureDict[int(1)]\n    \n    uo.BaseGuid = component.ComponentGuid\n    uo.Description.Name = component.Name\n    uo.Description.Description = component.Description\n    \n    # if user hasn't identified the category then put it\n    # into honeybee as an unknown!\n    if component.Category == \"Maths\":\n        uo.Description.Category = \"Honeybee\"\n    else:\n        uo.Description.Category = component.Category\n        \n    if component.SubCategory == \"Script\":\n        uo.Description.SubCategory = \"UnknownBees\"\n    else:\n        uo.Description.SubCategory = component.SubCategory\n    \n    uo.CreateDefaultPath(True)\n    uo.SetDataFromObject(component)\n    uo.SaveToFile()\n    \n    # copy the component over\n    uoFullPath = os.path.join(UOFolder, component.Name + \".ghuser\")\n    dstFullPath = os.path.join(targetFolder, component.Name + \".ghuser\")\n    shutil.copy2(uoFullPath, dstFullPath)\n    \n    # move under the folder for the plugin\n    uoPluginFullPath = os.path.join(UOFolder, component.Category,\n                                    component.Name + \".ghuser\")\n    try:\n        os.remove(uoPluginFullPath)\n    except:\n        pass\n    shutil.move(uoFullPath, uoPluginFullPath)\n\n    gh.GH_ComponentServer.UpdateRibbonUI()\n    \n    print \"Added UserObject successfully!\"\n\n\ndef exportToFile(component, targetFolder, lb_preparation):\n    \"\"\"Export userobject to a folder (usually clone of GitHub repo).\"\"\"\n\n    targetFolder = os.path.join(targetFolder, \"src\")\n    if not os.path.isdir(targetFolder): os.mkdir(targetFolder)\n    \n    def isNewerVersion(componentCode, fileName):\n        # check if the component has a newer version of source code\n        # version of the connected component\n        if component.Message == None: return True\n        if len(component.Message.split(\"\\n\"))<2: return True\n        \n        ghVersion, ghDate = component.Message.split(\"\\n\")\n        ghCompVersion = map(int, ghVersion.split(\"VER \")[1].split(\".\"))\n        month, day, ghYear  = ghDate.split(\"_\")\n        # print version, date\n        month = lb_preparation.monthList.index(month.upper()) + 1\n        ghCompDate = int(lb_preparation.getJD(month, day))\n        \n        # in case there was no date in the file\n        # the file will be considered older and will be overwrittern\n        # \n        pyFileDate = ghCompDate - 1\n        \n        # version of the file\n        with open(os.path.join(targetFolder,fileName), \"r\") as pyFile:\n            for lineCount, line in enumerate(pyFile):\n                if lineCount > 200: break\n                if line.strip().startswith(\"ghenv.Component.Message\"):\n                    # print line\n                    # print line.split(\"=\")[1].strip().split(\"\\n\")\n                    version, date = line.split(\"=\")[1].strip().split(\"\\\\n\")\n                    try:\n                        pyFileVersion = map(int, version.split(\"VER \")[1].split(\".\"))\n                    except:\n                        # in case the file doesn't have an standard Ladybug message\n                        return True\n                    month, day, pyYear  = date.split(\"_\")\n                    month = lb_preparation.monthList.index(month.upper()) + 1\n                    pyFileDate = int(lb_preparation.getJD(month, day))\n                    break\n        \n        # check if the version of the code is newer\n        try:\n            if int(ghYear.strip()) > int(pyYear[:-1].strip()):\n                    return True\n            elif ghCompDate > pyFileDate:\n                return True\n            elif ghCompDate == pyFileDate:\n                for ghVer, pyVer in zip(ghVersion, pyFileVersion):\n                    if ghVer < pyVer: return False\n                return True\n            else:\n                print \"\\nThere is already a newer version in the folder for: \" + fileName + \".\" + \\\n                      \"\\nCurrent file version is: \" +  version + \" \" + date + \\\n                      \"\\nThe component version is: \"  +  ghVersion + \" \" + ghDate + \".\\n\"\n                \n                return False\n        except:\n            print \"Failed to check version for %s\"%fileName\n            with open(\"c:\\\\ladybug\\\\failed.txt\", \"w\") as ff:\n                ff.write(fileName)\n            return True\n    \n    if component.Name.find(\"Honeybee\")>=0 or component.Name.find(\"Ladybug\")>=0 \\\n        or component.Name.find(\"DF\")>=0 or component.Name.find(\"Hydra\")>=0 \\\n        or component.Name.find(\"Butterfly\")>=0:\n        \n        fileName = component.Name + \".py\"\n        \n        # code inside the component\n        code = component.Code\n        \n        # check if the file already exist\n        if os.path.isfile(os.path.join(targetFolder, fileName)):\n            if not isNewerVersion(code, fileName):\n                return False\n                \n        with open(os.path.join(targetFolder, fileName), \"w\") as pyoutf:\n            if isinstance(code, unicode):\n                code = code.encode('ascii','ignore').replace(\"\\r\", \"\")\n            pyoutf.write(code)\n        \n        print \"Exported \" + fileName + \" to: \" + os.path.join(targetFolder, fileName)\n        return True\n\ndef getAllTheComponents(onlyGHPython = True):\n    components = []\n    \n    document = ghenv.Component.OnPingDocument()\n    \n    for component in document.Objects:\n        if onlyGHPython and type(component)!= type(ghenv.Component):\n            pass\n        else:\n            components.append(component)\n    \n    return components\n\ndef getListOfConnectedComponents(componentInputParamIndex = 0, onlyGHPython = True):\n    # this function is edited version of Guilio's code from here:\n    # [github link]\n    components = []\n    \n    param = ghenv.Component.Params.Input[componentInputParamIndex]\n    sources = param.Sources\n    if sources.Count == 0: return components\n    \n    for source in sources:\n        attr = source.Attributes\n        if (attr is None) or (attr.GetTopLevel is None):\n            pass\n        else:\n            component = attr.GetTopLevel.DocObject\n    \n    if component == None or (onlyGHPython and type(component) != type(ghenv.Component)):\n            #collect only python components\n            pass\n    else:\n        components.append(component)\n    \n    return components\n\ndef main(components, targetFolder):\n    if not sc.sticky.has_key('ladybug_release'):\n        return \"you need to let Ladybug fly first!\"\n    lb_preparation = sc.sticky[\"ladybug_Preparation\"]()\n    \n    if not os.path.isdir(targetFolder): os.mkdir(targetFolder)\n        \n    if str(components[0]) == \"*\":\n        ghComps = getAllTheComponents()\n    else:\n        ghComps = getListOfConnectedComponents()\n    \n    if len(ghComps)== 0: return \"Found 0 components!\"\n    \n    for ghComp in ghComps:\n        fileExported = exportToFile(ghComp, targetFolder, lb_preparation)\n        if fileExported:\n            exportToUserObject(ghComp, targetFolder, lb_preparation)\n        \n\nif _export and len(_components)!=0 and _targetFolder!=None:\n    msg = main(_components, _targetFolder)\n    ghenv.Component.AddRuntimeMessage(gh.GH_RuntimeMessageLevel.Warning, msg)\nelse:\n    print \"At the minimum one of the components are missing!\"\n",
  "language": "python",
  "imports": [
    "scriptcontext"
  ],
  "has_docstring": true
}