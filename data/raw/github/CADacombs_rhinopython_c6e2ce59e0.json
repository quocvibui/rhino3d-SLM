{
  "source_url": "https://github.com/CADacombs/rhinopython/blob/541b4ade49f1dda6a3861d12b9e2613405182082/xBlock.py",
  "repo": "CADacombs/rhinopython",
  "repo_stars": 37,
  "repo_description": "Python scripts for Rhinoceros (Rhino, Rhino3D).",
  "license": "LGPL-3.0",
  "filepath": "xBlock.py",
  "instruction": "160618: Created by importing functions from SrfRadius.py.\r\n160625: Fixed bugs in brepOrExtrusionOfBlock_WireframePick() and tryPickedFaceOfBlock().\r\n160702: Changed EpsilonEquals tolerance in...",
  "code": "\"\"\"\r\n160618: Created by importing functions from SrfRadius.py.\r\n160625: Fixed bugs in brepOrExtrusionOfBlock_WireframePick() and tryPickedFaceOfBlock().\r\n160702: Changed EpsilonEquals tolerance in tryPickedFaceOfBlock from Rhino.RhinoMath.ZeroTolerance to trying from 1.e-11 to sc.doc.ModelAbsoluteTolerance.\r\n160713: Fixed bug in tryPickedFaceOfBlock() and made more efficient by looping through the faces of the brep only once.\r\n        Modified tolerance value in brepOrExtrusionOfBlock_WireframePick() from ...ZeroTolerance to (.001 * sc.doc.ModelAbsoluteTolerance).\r\n160719: In tryPickedFaceOfBlock(), changed \"return\" to \"return None, None\".\r\n190314: Updated an import name.\r\n\"\"\"\r\n\r\nimport Rhino\r\nimport Rhino.DocObjects as rd\r\nimport Rhino.Geometry as rg\r\nimport rhinoscriptsyntax as rs\r\nimport scriptcontext as sc\r\n\r\nimport xLayer\r\n\r\n\r\ndef brepOrExtrusionOfBlock_ShadedPick(rdInstRef, ptPicked, planeCam):\r\n    \"\"\"Create intersecting line that passes through the actual picked point.\r\n    Its vector is that of the camera view.\r\n    The line extends to the bounding box of the block instance.\"\"\"\r\n    \r\n    vector = rg.Vector3d.Negate(planeCam.ZAxis)\r\n    ptOnCameraPlane = planeCam.ClosestPoint(ptPicked)\r\n    pts_bbox = rs.BoundingBox(rdInstRef.Id)\r\n    bbox = rg.BoundingBox(pts_bbox[0], pts_bbox[6])\r\n    \r\n    rgLine = rg.Line(ptOnCameraPlane, vector, 1.)\r\n    rgLine.ExtendThroughBox(bbox)\r\n    rgLineCrv = rg.LineCurve(rgLine)\r\n    \r\n    rgBreps_Intrsct, pts_Intrsct_All = (\r\n            brepsOrExtrusionsAndPtsInBlockInstThatIntrsctLine(rdInstRef, rgLineCrv))\r\n    \r\n    rgObj_Nearest = pt_Nearest = None\r\n    \r\n    for i, pts_Intrsct in enumerate(pts_Intrsct_All):\r\n        for pt_Intrsct in pts_Intrsct:\r\n            fDistPtToPlane = ptOnCameraPlane.DistanceTo(pt_Intrsct)\r\n            if pt_Nearest is None or fDistPtToPlane < fDistPtToPlane_Min:\r\n                rgObj_Nearest = rgBreps_Intrsct[i]\r\n                pt_Nearest = pt_Intrsct\r\n                fDistPtToPlane_Min = fDistPtToPlane\r\n    \r\n    return rgObj_Nearest, pt_Nearest\r\n\r\n\r\ndef brepOrExtrusionOfBlock_WireframePick(rdInstRef, pt, xform=rg.Transform.Identity):\r\n    \r\n    xform *= rdInstRef.InstanceXform\r\n    rdInstDef = rdInstRef.InstanceDefinition\r\n    rdObjs = rdInstDef.GetObjects()\r\n    \r\n    for rdObj in rdObjs:\r\n        if not xLayer.areLayerAndAllAncestorsVisible(rdObj.Attributes.LayerIndex):\r\n            continue\r\n        elif rdObj.ObjectType == rd.ObjectType.InstanceReference:\r\n            rgObj = brepOrExtrusionOfBlock_WireframePick(rdObj, pt, xform)\r\n            if rgObj: return rgObj # Otherwise, continue with loop.\r\n        else: # Object is not a block instance\r\n            rgObj = rdObj.Geometry\r\n            rgObj.Transform(xform)\r\n            if rgObj.ObjectType == rd.ObjectType.Brep:\r\n                ptOn = rgObj.ClosestPoint(pt)\r\n            elif rgObj.ObjectType == rd.ObjectType.Extrusion:\r\n                bPt, u, v = rgObj.ClosestPoint(pt)\r\n                ptOn = rgObj.PointAt(u, v)\r\n            else: continue # Not brep or extrusion.\r\n            \r\n            if pt.EpsilonEquals(ptOn, .001 * sc.doc.ModelAbsoluteTolerance):\r\n                return rgObj\r\n\r\n\r\ndef brepsOrExtrusionsAndPtsInBlockInstThatIntrsctLine(rdInstRef, rgLineCrv, xform=rg.Transform.Identity, rgBreps_Intrsct=None, pts_Intrsct_All=None):\r\n    \r\n    if rgBreps_Intrsct is None: rgBreps_Intrsct = []\r\n    if pts_Intrsct_All is None: pts_Intrsct_All = []\r\n    \r\n    fTol = .1 * sc.doc.ModelAbsoluteTolerance # Tolerances < 0  in Intersection.CurveBrep() seem to produce results within 1e-14 of each other.\r\n    xform *= rdInstRef.InstanceXform\r\n    rdInstDef = rdInstRef.InstanceDefinition\r\n    rdObjs = rdInstDef.GetObjects()\r\n    \r\n    for rdObj in rdObjs:\r\n        if not xLayer.areLayerAndAllAncestorsVisible(rdObj.Attributes.LayerIndex):\r\n            continue\r\n        elif rdObj.ObjectType == (\r\n                rd.ObjectType.InstanceReference):\r\n            rgBreps_Intrsct, pts_Intrsct_All = (\r\n                    brepsOrExtrusionsAndPtsInBlockInstThatIntrsctLine(\r\n                    rdObj, rgLineCrv, xform, rgBreps_Intrsct, pts_Intrsct_All))\r\n        else: # Object is not a block instance\r\n            rgObj = rdObj.Geometry\r\n            if rgObj.ObjectType == rd.ObjectType.Brep:\r\n                pass\r\n            elif rgObj.ObjectType == rd.ObjectType.Extrusion:\r\n                rgObj = rdObj.Geometry.ToBrep()\r\n            else: continue\r\n            \r\n            rgObj.Transform(xform)\r\n            bIntrsct, rgCrvs_Intrsct, pts_Intrsct = (\r\n                    rg.Intersect.Intersection.CurveBrep(\r\n                            rgLineCrv, rgObj, fTol))\r\n            if len(pts_Intrsct) > 0: # bIntrsct = True even when no intersection\r\n                rgBreps_Intrsct.append(rgObj)\r\n                pts_Intrsct_All.append(tuple(pts_Intrsct))\r\n            \r\n            #return rgBreps_Intrsct, pts_Intrsct_All\r\n    \r\n    return rgBreps_Intrsct, pts_Intrsct_All\r\n\r\n\r\ndef tryPickedFaceOfBlock(rdObj, ptPicked):\r\n    \"\"\"\r\n    Parameters:\r\n        rdObj\r\n        ptPicked\r\n    Returns:\r\n        rgFace\r\n        ptPicked\r\n    \r\n    Although it would be better to capture the view properties\r\n    immediately after the point is picked, the code is located here so\r\n    that planeCam doesn't need to be passed to the current function.\r\n    planeCam will be used when a shaded brep face is picked.\r\n    \"\"\"\r\n    \r\n    viewport = sc.doc.Views.ActiveView.MainViewport\r\n    bCamPlane, planeCam = viewport.GetCameraFrame()\r\n    if bCamPlane is None: return None, None\r\n    \r\n    bWireFrameView = not viewport.DisplayMode.SupportsShading\r\n    if bWireFrameView:\r\n        rgObj = brepOrExtrusionOfBlock_WireframePick(\r\n                rdObj, ptPicked) # Get brep\r\n    else: # Shaded brep face was picked.\r\n        rgObj, ptPicked = brepOrExtrusionOfBlock_ShadedPick(\r\n                rdObj, ptPicked, planeCam) # Note that ptPicked is reassigned.\r\n    \r\n    if rgObj is not None and (rgObj.ObjectType ==\r\n            rd.ObjectType.Brep or rd.ObjectType.Extrusion): # Get face\r\n        if rgObj.ObjectType == rd.ObjectType.Extrusion:\r\n            rgObj = rgObj.ToBrep()\r\n        fDist_Min = 1./Rhino.RhinoMath.ZeroTolerance\r\n        for f, rgFace in enumerate(rgObj.Faces):\r\n            bPt, u, v = rgFace.ClosestPoint(ptPicked)\r\n            if rgFace.IsPointOnFace(u, v): # Works because values are 0 for Exterior, 1 for Interior, 2 for Boundary\r\n                ptOn = rgFace.PointAt(u, v)\r\n                fDist = ptPicked.DistanceTo(ptOn)\r\n                if fDist < fDist_Min:\r\n                    idxFace_Closest = f\r\n                    fDist_Min = fDist\r\n        #sPrint = 'fDist_Min'; print sPrint + ':', eval(sPrint)\r\n        return rgObj.Faces[idxFace_Closest], ptPicked\r\n    else: rgFace = None\r\n    \r\n    return None, None",
  "language": "python",
  "imports": [
    "Rhino",
    "Rhino.Geometry",
    "rhinoscriptsyntax",
    "scriptcontext"
  ],
  "has_docstring": true
}