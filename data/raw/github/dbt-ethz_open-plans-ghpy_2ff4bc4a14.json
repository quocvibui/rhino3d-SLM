{
  "source_url": "https://github.com/dbt-ethz/open-plans-ghpy/blob/cadac60fe7934051b09011db0d621f0479100ab4/src/OpenPlansGH/code.py",
  "repo": "dbt-ethz/open-plans-ghpy",
  "repo_stars": 2,
  "repo_description": "Interact with Open Plans in Rhino Grasshopper",
  "license": "unknown",
  "filepath": "src/OpenPlansGH/code.py",
  "instruction": "Retrieve floor plans from the Open Plans database with a geometircal search.\n    Inputs:\n        searchShape:    Closed Polyline that represents the desired shape of retrieved floor plans.\n          ...",
  "code": "\"\"\"\nRetrieve floor plans from the Open Plans database with a geometircal search.\n    Inputs:\n        searchShape:    Closed Polyline that represents the desired shape of retrieved floor plans.\n                        {item, polyline}\n        numberOfPlans:  (optional: default is 20) Set this value to specify the number of plans \n                        returned from the database.\n                        {item, int)\n\n\n    Output:\n        projects:       List of open plans projects as dictionaries (not readable by Grasshopper)\n                        {list, dict}\n        properties:     Property values from open plans projects (readable by Grasshopper in tree structure)\n                        {item, list}\n        propertyNames:  Property names from open plans projects (readable by Grasshopper in list)\n                        {item, list}\n\n    \n    Remarks:\n        Author: \n        License:\n        Version: \n\"\"\"\n\n# PYTHON LIBRARY IMPORTS\nimport urllib2\nfrom urllib2 import HTTPError\nimport json\n\n# GHPYTHON SDK IMPORTS\nfrom ghpythonlib.componentbase import executingcomponent as component\nimport Rhino.Geometry as rg\nimport ghpythonlib.treehelpers as th\n\n\nclass OpenPlansSearch:\n\n    def __init__(self, search_shape, number_of_plans):\n        self.searchShape = search_shape\n        self.numberOfPlans = number_of_plans if number_of_plans else 20\n        self.uri = \"https://open-plans.herokuapp.com/\"\n        self.similarPlans = self.api_search_by_shape()\n        self.openPlansItems = []\n        \n    def api_search_by_shape(self):\n        url = self.uri + 'searchbyshape?number={}'.format(self.numberOfPlans)\n        req = urllib2.Request(url, self.search_shape_to_polygon(), headers={'Content-Type': 'application/json'})\n    \n        try:\n            response = urllib2.urlopen(req)\n            json_string = response.read().decode('utf-8')\n            ret_val = dict(json.loads(json_string))\n            if ret_val['succeeded']:\n                if len(ret_val) == 0:\n                    raise Exception(\" No plans are retrieved from the database \")\n                return ret_val['similar_plan_list']\n        except HTTPError as e:\n            if e.code == 503:\n                raise HTTPError(e.url, e.code, \"It did not work this time, please try again.\")\n            else:\n                raise\n            \n    def search_shape_to_polygon(self):\n        polygon = self.format_polygon(x_coords=[x for x in self.searchShape.X], y_coords=[y*-1 for y in self.searchShape.Y])\n        return json.dumps(polygon)\n    \n    @staticmethod\n    def format_polygon(x_coords, y_coords):\n        return {'polygon': [{'x': x, 'y': y} for x, y in zip(x_coords, y_coords)]}\n        \n    def get_open_plans_items(self):\n        self.openPlansItems = [OpenPlansItem(data=p) for p in self.similarPlans]\n\n\nclass OpenPlansItem:\n    \n    def __init__(self, data):\n        self.building_outline = self.building_outline_pts_to_rhino_geom(points=data['points'])\n        self.name = data['name']\n        self.architects = data['architects']\n        self.civil_engineers = data['civil_engineers']\n        self.description = data['description']\n        self.year_of_completion = data['year_of_completion']\n        self.floor_area = self.get_polygon_area()\n        self.floors = data['floors']\n        self.level = data['floor']\n        self.geolocation = self.format_geolocation(data['geolocation'])\n        self.height = data['height']\n        self.projectURL = 'https://plans.arch.ethz.ch/#/project/{}'.format(data['project_id'])\n\n            \n    def get_polygon_area(self):\n        try:\n            props = rg.AreaMassProperties.Compute(self.building_outline)\n            return props.Area * 10**-6\n        except:\n            return None\n          \n    def building_outline_pts_to_rhino_geom(self, points):\n        if points[0] != points[-1]:\n            points.append(points[0])\n        pts = map(self.transform_to_rhino_coords, points)\n        polyline = rg.Polyline()\n        for pt in pts:\n            polyline.Add(rg.Point3d(pt[0], pt[1], 0))\n        polylineCrv = polyline.ToPolylineCurve()\n        return polylineCrv\n\n    def transform_to_rhino_coords(self, coordinate):\n        return list([coordinate[0], coordinate[1]*-1])\n    \n    @staticmethod\n    def format_geolocation(data):\n        if data:\n            try:\n                point_str = data.replace('POINT(', '').replace(')', '')\n                longitude, latitude = point_str.split(' ')\n                return '{}  {}'.format(latitude, longitude)\n            except:\n                return None\n        return None\n\n\nclass OpenPlansGH(component):\n\n    def RunScript(self, searchShape, numberOfPlans):\n\n        if not searchShape:\n            return None, None, None\n        \n        if numberOfPlans == 0:\n            return None, None, None\n\n        if searchShape.IsValid and searchShape.IsClosed:\n\n            op = OpenPlansSearch(searchShape, number_of_plans=numberOfPlans)\n            \n            if op.similarPlans:\n                op.get_open_plans_items()\n            else:\n                raise Exception(' Not able to fetch projects from open plans ')\n            \n            if op.openPlansItems:\n                projects = [item.__dict__ for item in op.openPlansItems]\n                properties = th.list_to_tree( [p.values() for p in projects] )\n                propertyNames = projects[0].keys()\n            \n            return projects, properties, propertyNames \n        \n        else:\n            raise Exception(' searchShape; polyline is not valid/closed ')",
  "language": "python",
  "imports": [
    "Rhino",
    "Rhino.Geometry",
    "ghpythonlib"
  ],
  "has_docstring": true
}