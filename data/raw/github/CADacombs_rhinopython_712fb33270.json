{
  "source_url": "https://github.com/CADacombs/rhinopython/blob/541b4ade49f1dda6a3861d12b9e2613405182082/xBrep_findSharpEdges.py",
  "repo": "CADacombs/rhinopython",
  "repo_stars": 37,
  "repo_description": "Python scripts for Rhinoceros (Rhino, Rhino3D).",
  "license": "LGPL-3.0",
  "filepath": "xBrep_findSharpEdges.py",
  "instruction": "160406: Created.\r\n161212: Commented out alias maker.\r\n170501: Added sticky for fAngleTol_Deg.  Removed alias maker.\r\n170507: Modified command option text.\r\n171104: Split from 1 function into 3.\r\n    ...",
  "code": "\"\"\"\r\n160406: Created.\r\n161212: Commented out alias maker.\r\n170501: Added sticky for fAngleTol_Deg.  Removed alias maker.\r\n170507: Modified command option text.\r\n171104: Split from 1 function into 3.\r\n        Now waits for input even when objects are preselected.\r\n        Can now escape out of face loop.\r\n171108: Modified printed output.\r\n180317: Added DotFontHt option and if executed in V6 or greater, default dot font height will be 3* that in V5.\r\n180427: Renamed from findSharpEdges.py to markSharpEdges.py.\r\n180725: Added concavity option.\r\n        Renamed from markSharpEdges.py to sharpEdges.py.\r\n181025: Bug fix in printed output.\r\n\"\"\"\r\n\r\nimport Rhino\r\nimport Rhino.DocObjects as rd\r\nimport Rhino.Geometry as rg\r\nimport Rhino.Input as ri\r\nimport rhinoscriptsyntax as rs\r\nimport scriptcontext as sc\r\n\r\nfrom System import Guid\r\n\r\n\r\ndef getInput():\r\n    \r\n    sRhFileName = '{}'.format(sc.doc.Name) # If Name doesn't exist, an empty string is created.\r\n    \r\n    fAngleTol_Deg_Default = 50.0 * sc.doc.ModelAngleToleranceDegrees\r\n    idxConcavityType_Default = idxConcavityType = 2 # 2 = Either concave or convex.\r\n    iDotHeight_Default = 33 if Rhino.RhinoApp.ExeVersion >= 6 else 11\r\n    \r\n    # Create options with default values before any are changed with those in sticky.\r\n    optD_fAngleTol_Deg = ri.Custom.OptionDouble(\r\n            fAngleTol_Deg_Default, True, Rhino.RhinoMath.ZeroTolerance)\r\n    sConcavityTypes = 'ConcaveOnly', 'ConvexOnly', 'EitherConcaveOrConvex'\r\n    optT_bDupEdge = ri.Custom.OptionToggle(False, 'No', 'Yes')\r\n    optT_bAddDot = ri.Custom.OptionToggle(True, 'No', 'Yes')\r\n    optI_iDotFontHt = ri.Custom.OptionInteger(iDotHeight_Default, True, 3)\r\n    \r\n    # Load sticky.\r\n    stickyKeys = [\r\n            'fAngleTol_Deg({})'.format(__file__),\r\n            'idxConcavityType({})'.format(__file__),\r\n            'bDupEdge({})'.format(__file__),\r\n            'bAddDot({})({})'.format(__file__, sRhFileName),\r\n            'iDotFontHt({})'.format(__file__),\r\n    ]\r\n    stickyValues = [\r\n            optD_fAngleTol_Deg.CurrentValue,\r\n            idxConcavityType_Default,\r\n            optT_bDupEdge.CurrentValue,\r\n            optT_bAddDot.CurrentValue,\r\n            optI_iDotFontHt.CurrentValue,\r\n    ]\r\n    for i, stickyKey in enumerate(stickyKeys):\r\n        if sc.sticky.has_key(stickyKey): stickyValues[i] = sc.sticky[stickyKey]\r\n    (\r\n            optD_fAngleTol_Deg.CurrentValue,\r\n            idxConcavityType,\r\n            optT_bDupEdge.CurrentValue,\r\n            optT_bAddDot.CurrentValue,\r\n            optI_iDotFontHt.CurrentValue,\r\n    ) = stickyValues\r\n    \r\n    # Get objects with optional input\r\n    \r\n    dictOptListIdxs = {'idxConcavityType': None}\r\n    \r\n    def addOptions():\r\n        go.AddOptionDouble(\"AngleTolerance\" + chr(176), optD_fAngleTol_Deg)\r\n        dictOptListIdxs['idxConcavityType'] = go.AddOptionList(\r\n                englishOptionName='ConcavityType',\r\n                listValues=sConcavityTypes,\r\n                listCurrentIndex=idxConcavityType)\r\n        go.AddOptionToggle('DuplicateEdges', optT_bDupEdge)\r\n        go.AddOptionToggle('AddDots', optT_bAddDot)\r\n        if optT_bAddDot.CurrentValue:\r\n            go.AddOptionInteger('DotFontHt', optI_iDotFontHt)\r\n    \r\n    go = ri.Custom.GetObject()\r\n    go.SetCommandPrompt(\"Select breps\")\r\n    \r\n    go.GeometryFilter = rd.ObjectType.PolysrfFilter\r\n    \r\n    addOptions()\r\n    \r\n    go.AcceptNumber(True, True)\r\n    \r\n    go.AlreadySelectedObjectSelect = True\r\n    go.DeselectAllBeforePostSelect = False # So objects won't be deselected on repeats of While loop.\r\n    go.SubObjectSelect = False\r\n    go.EnableClearObjectsOnEntry(False) # Keep objects in go on repeats of While loop.\r\n    go.EnableUnselectObjectsOnExit(False)\r\n    \r\n    bPreselectedObjsChecked = False\r\n    \r\n    while True:\r\n        if sc.escape_test(False): return\r\n        \r\n        bDupEdge_Old = optT_bDupEdge.CurrentValue\r\n        bAddDot_Old = optT_bAddDot.CurrentValue\r\n        \r\n        res = go.GetMultiple(1, 0)\r\n        \r\n        # Use bPreselectedObjsChecked so that only objects before the\r\n        # first call to go.GetMultiple is considered.\r\n        if not bPreselectedObjsChecked and go.ObjectsWerePreselected:\r\n            bPreselectedObjsChecked = True\r\n            go.EnablePreSelect(False, True)\r\n            continue\r\n        \r\n        if res == ri.GetResult.Object:\r\n            break\r\n        elif res == ri.GetResult.Cancel:\r\n            return # Esc key was pressed.\r\n        \r\n        # An option was selected or a number was entered.\r\n        \r\n        if res == ri.GetResult.Number:\r\n            optD_fAngleTol_Deg.CurrentValue = abs(go.Number())\r\n        \r\n        elif res == ri.GetResult.Option and go.Option().Index == 2:\r\n            idxConcavityType = go.Option().CurrentListOptionIndex\r\n        \r\n        if optD_fAngleTol_Deg.CurrentValue == 0.0:\r\n                optD_fAngleTol_Deg.CurrentValue = fAngleTol_Deg_Default\r\n        \r\n        # Do not allow both bDupEdge and bAddDot to be False.\r\n        if optT_bDupEdge.CurrentValue != bDupEdge_Old:\r\n            optT_bAddDot.CurrentValue = True\r\n        elif optT_bAddDot.CurrentValue != bAddDot_Old:\r\n            optT_bDupEdge.CurrentValue = True\r\n        \r\n        # Save sticky\r\n        stickyValues = (\r\n                optD_fAngleTol_Deg.CurrentValue,\r\n                idxConcavityType,\r\n                optT_bDupEdge.CurrentValue,\r\n                optT_bAddDot.CurrentValue,\r\n                optI_iDotFontHt.CurrentValue,\r\n        )\r\n        for i, stickyKey in enumerate(stickyKeys):\r\n            sc.sticky[stickyKey] = stickyValues[i]\r\n        \r\n        go.ClearCommandOptions()\r\n        addOptions()\r\n    \r\n    return (\r\n            [objref.ObjectId for objref in go.Objects()],\r\n            optD_fAngleTol_Deg.CurrentValue,\r\n            idxConcavityType,\r\n            optT_bDupEdge.CurrentValue,\r\n            optT_bAddDot.CurrentValue,\r\n            optI_iDotFontHt.CurrentValue,\r\n    )\r\n\r\n\r\ndef sharpEdges(brep, fAngleTol_Deg=sc.doc.ModelAngleToleranceDegrees, idxConcavityType=2):\r\n    \"\"\"\r\n    Parameters:\r\n        brep: Can be Object document or geometry.\r\n        fAngleTol_Deg: Used to determine how many iterations to use to refine fAngle.\r\n        idxConcavityType: 0=Concave only, 1=Convex only , 2=Either concave or convex\r\n    Returns:\r\n        List of indices of sharp BrepEdges of desired concavity in brep.\r\n    \"\"\"\r\n    \r\n    rgBrep = brep if isinstance(brep, rg.Brep) else rs.coercebrep(brep)\r\n    \r\n    idx_rgEdges_Sharp = []\r\n    gCrvs1 = [] # Accumulation of duplicated edges (curves)\r\n    \r\n    fAngleTol_Rad = Rhino.RhinoMath.ToRadians(fAngleTol_Deg)\r\n    \r\n    decimalFractions = 0.5, 0.4, 0.6, 0.3, 0.7, 0.2, 0.8, 0.1, 0.9, 0.0, 1.0\r\n    \r\n    # Accumulate indices of sharp edges.\r\n    for rgEdge in rgBrep.Edges:\r\n        if rgEdge.Valence != rg.EdgeAdjacency.Interior:\r\n            # Skip edge because it doesn't have 2 faces.\r\n            continue\r\n        \r\n        if rgEdge.IsSmoothManifoldEdge(fAngleTol_Rad): continue\r\n        \r\n        if idxConcavityType != 2:\r\n            # Test for concavity vs. convexity against desired state.\r\n            \r\n            tMax = rgEdge.Domain.Max\r\n            tMin = rgEdge.Domain.Min\r\n            \r\n            for d in decimalFractions:\r\n                t = (tMax-tMin) * d + tMin\r\n                \r\n                concavity = rgEdge.ConcavityAt(\r\n                        t=t,\r\n                        tolerance=fAngleTol_Rad)\r\n                if idxConcavityType == 0 and concavity == rg.Concavity.Concave:\r\n                    # Concave found.\r\n                    break\r\n                elif idxConcavityType == 1 and concavity == rg.Concavity.Convex:\r\n                    # Convex found.\r\n                    break\r\n            else:\r\n                # Desired concavity not found, so continue onto next edge.\r\n                continue\r\n        \r\n        idx_rgEdges_Sharp.append(rgEdge.EdgeIndex)\r\n    \r\n    return idx_rgEdges_Sharp\r\n\r\n\r\ndef main(bDebug=False):\r\n    \r\n    rc = getInput()\r\n    if rc is None: return\r\n    (\r\n            gBreps,\r\n            fAngleTol_Deg,\r\n            idxConcavityType,\r\n            bDupEdge,\r\n            bAddDot,\r\n            iDotFontHt,\r\n    ) = rc\r\n    \r\n    nSharp_All = iBrepWithoutSharps_ct = 0\r\n    \r\n    if bDupEdge: sc.doc.Objects.UnselectAll()\r\n    \r\n    if idxConcavityType == 0:\r\n        sConcavityPrint = 'some concavity'\r\n    elif idxConcavityType == 1:\r\n        sConcavityPrint = 'some convexity'\r\n    else:\r\n        sConcavityPrint = 'both concavity and convexity'\r\n    \r\n    print \"Searching for sharp edges with {} within {}{}...\".format(\r\n            sConcavityPrint,\r\n            fAngleTol_Deg,\r\n            chr(176)\r\n    )\r\n    \r\n    # Process breps.\r\n    for gBrep in gBreps:\r\n        rgBrep = rs.coercebrep(gBrep)\r\n        \r\n        rgEdges_All = rgBrep.Edges\r\n        \r\n        rc = sharpEdges(rgBrep, fAngleTol_Deg, idxConcavityType)\r\n        if rc is None: return\r\n        idx_rgEdges_Sharp = rc\r\n        \r\n        if len(idx_rgEdges_Sharp) == 0:\r\n            # No sharps of desired concavity found in this brep.\r\n            iBrepWithoutSharps_ct += 1\r\n            continue\r\n        \r\n        for idx in idx_rgEdges_Sharp:\r\n            rgEdge = rgBrep.Edges[idx]\r\n            if bDupEdge:\r\n                sc.doc.Objects.Select(sc.doc.Objects.AddCurve(rgEdge))\r\n            if bAddDot:\r\n                t = rgEdge.DivideByCount(segmentCount=2, includeEnds=False)[0]\r\n                rgDot = rg.TextDot(str(''), rgEdge.PointAt(t))\r\n                rgDot.FontHeight = iDotFontHt\r\n                sc.doc.Objects.AddTextDot(rgDot)\r\n        \r\n        print \"{} sharp, interior edges with {} found in {}.\".format(\r\n                len(idx_rgEdges_Sharp),\r\n                sConcavityPrint,\r\n                gBrep)\r\n    \r\n    if iBrepWithoutSharps_ct == len(gBreps):\r\n        print \"No sharps with {} found in {} polyface breps.\".format(\r\n                sConcavityPrint,\r\n                iBrepWithoutSharps_ct)\r\n    \r\n    sc.doc.Views.Redraw()\r\n\r\n\r\nif __name__ == '__main__': main(bDebug=bool(0))",
  "language": "python",
  "imports": [
    "Rhino",
    "Rhino.Geometry",
    "rhinoscriptsyntax",
    "scriptcontext"
  ],
  "has_docstring": true
}