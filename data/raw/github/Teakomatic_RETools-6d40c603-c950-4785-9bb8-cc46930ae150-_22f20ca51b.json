{
  "source_url": "https://github.com/Teakomatic/RETools-6d40c603-c950-4785-9bb8-cc46930ae150-/blob/eba4673906419c4113e196b14d0fa16304b13823/dev/services/import_tools.py",
  "repo": "Teakomatic/RETools-6d40c603-c950-4785-9bb8-cc46930ae150-",
  "repo_stars": 0,
  "repo_description": null,
  "license": "unknown",
  "filepath": "dev/services/import_tools.py",
  "instruction": "/RETools/dev/services/import_tools.py\r\n(c) 2023 Mars Industrial (AGPLv3)\r\n\r\nThis module contains tools for importing DXF files into Rhino.\r\n\r\nUsage:\r\nimport_dxfs(folder, border=20)\r\n\r\nEffects:\r\n-...",
  "code": "\"\"\"\r\n/RETools/dev/services/import_tools.py\r\n(c) 2023 Mars Industrial (AGPLv3)\r\n\r\nThis module contains tools for importing DXF files into Rhino.\r\n\r\nUsage:\r\nimport_dxfs(folder, border=20)\r\n\r\nEffects:\r\n- Imports DXF files from the current job directory into the open .3dm file.\r\n- Arrange large 2d items horizontally, small 2d items vertically, and 3d items to the left.\r\n\"\"\"\r\n\r\nimport scriptcontext as sc\r\nimport rhinoscriptsyntax as rs\r\nfrom Rhino.Geometry import Point3d\r\n\r\nfrom conf import TEXT_HEIGHT, TEXT_HEIGHT_3D, SHORT_ITEM_LENGTH\r\nfrom file import name, get_dxfs_recursive, current_folder\r\nfrom rhino import bbox, silent, text_centered, text_centered_vertical\r\nimport log\r\n\r\ndef import_dxf(file):\r\n    \"\"\"\r\n    Import a single dxf file.\r\n\r\n    Note: Requires user to set default DXF import settings\r\n    \"\"\"\r\n\r\n    debug(\"Importing {}\".format(file))\r\n\r\n    command = '-import \"{}\" enter'.format(file)\r\n\r\n    silent(command)\r\n\r\n    sel = rs.SelectedObjects()\r\n\r\n    silent(\"selnone\")\r\n\r\n    return sel\r\n\r\n\r\nclass Import:\r\n    def __init__(self, dxf):\r\n        # Import document\r\n        self.object = import_dxf(dxf)\r\n\r\n        # Process import metadata\r\n        self.name = name(dxf)\r\n        self.update_metadata()\r\n\r\n        # Align import centerline to y axis\r\n        self.move(-self.base)\r\n\r\n    def move(self, vector):\r\n        rs.MoveObjects(self.object, vector)\r\n        self.update_metadata()\r\n\r\n    def update_metadata(self):\r\n        box = self.box\r\n        self.length = box.Diagonal.Y\r\n        self.width = box.Diagonal.X\r\n        self.mid = self.width / 2\r\n        self.area = box.Area\r\n        self.is_2d = box.IsDegenerate(sc.doc.ModelAbsoluteTolerance)\r\n        self.corner = box.Min\r\n        self.center = box.Min + box.Diagonal / 2\r\n        self.base = box.Min + Point3d(self.mid, 0, 0)\r\n\r\n    @property\r\n    def box(self):\r\n        return bbox(self.object)\r\n\r\n\r\ndef label_2d_item(item, spacing):\r\n    # Name item below, centered\r\n    position = (item.base.X, item.base.Y - spacing)\r\n    text_centered(item.name, TEXT_HEIGHT, position)\r\n\r\n\r\ndef label_small_2d_item(item, spacing):\r\n    # Name item right, centered\r\n    position = item.base.X + item.mid + spacing, item.base.Y + item.length / 2\r\n    text_centered_vertical(item.name, TEXT_HEIGHT, position)\r\n\r\n\r\ndef label_3d_item(item, spacing):\r\n    # Name item below, centered\r\n    name_position = item.base.X, item.base.Y - spacing\r\n    text_centered(item.name, TEXT_HEIGHT, name_position)\r\n    # Mark 3d item on center\r\n    marker_position = item.center.X, item.center.Y\r\n    text_centered(\"3D\", TEXT_HEIGHT_3D, marker_position)\r\n\r\n\r\ndef import_dxfs(source_folder, border):\r\n    half_border = border / 2\r\n\r\n    import_items = get_dxfs_recursive(source_folder)\r\n\r\n    # Report items\r\n    if not import_items:\r\n        log.info(\"No items to import. Doing nothing.\")\r\n        return\r\n\r\n    log.info(\"Importing {} items:\".format(len(import_items)))\r\n    for dxf in import_items:\r\n        log.info(name(dxf))\r\n\r\n    # Import  and preprocess item metadata\r\n    _3d_imports = []\r\n    _2d_imports = []\r\n    for dxf in import_items:\r\n        item = Import(dxf)\r\n\r\n        # Sort imports by 2d/3d status\r\n        if item.is_2d:\r\n            _2d_imports.append(item)\r\n        else:\r\n            _3d_imports.append(item)\r\n\r\n    # Sort imports by size\r\n    by_area = lambda item: item.area\r\n    _2d_imports.sort(key=by_area, reverse=True)\r\n    _3d_imports.sort(key=by_area, reverse=True)\r\n\r\n    # Split short and long 2d imports\r\n    _2d_imports_long = [x for x in _2d_imports if x.length >= SHORT_ITEM_LENGTH]\r\n    _2d_imports_short = [x for x in _2d_imports if x.length < SHORT_ITEM_LENGTH]\r\n\r\n    # Arrange and label 2d imports\r\n    base_point_2d = Point3d.Origin\r\n    first_long_2d_item = True\r\n\r\n    # Align large 2d items horizontally to right of origin\r\n    for item in _2d_imports_long:\r\n        # Leave first 2d item on midline\r\n        if first_long_2d_item:\r\n            first_long_2d_item = False\r\n\r\n        # Accomodate left side of subsequent items\r\n        else:\r\n            base_point_2d.X += item.mid\r\n\r\n        item.move(base_point_2d)\r\n\r\n        label_2d_item(item, spacing=half_border)\r\n\r\n        # Accomodate right side of object\r\n        base_point_2d.X += item.mid\r\n\r\n        #  Invariant: Offset point is now at right end of item\r\n\r\n        # Add a border\r\n        base_point_2d.X += border\r\n\r\n    # Align small 2d items vertically to right of large items\r\n\r\n    for item in _2d_imports_short:\r\n        # Accomodate left side of item\r\n        item.move(base_point_2d + Point3d(item.mid, 0, 0))\r\n\r\n        label_small_2d_item(item, spacing=half_border)\r\n\r\n        # Accomodate item length\r\n        base_point_2d.Y += item.length\r\n\r\n        # Invariant: Offset is now at top end of item\r\n\r\n        # Add border\r\n        base_point_2d.Y += border\r\n\r\n    # Report bad imports with short placeholders\r\n\r\n    # Arrange and label 3d imports\r\n    base_point_3d = Point3d.Origin\r\n\r\n    # Shift 3d base point to avoid 2d imports\r\n    if _2d_imports_long:\r\n        base_point_3d.X -= _2d_imports_long[0].mid + border\r\n    elif _2d_imports_short:\r\n        base_point_3d = _2d_imports_short[0].corner\r\n        base_point_3d.X -= _2d_imports_short[0].mid\r\n\r\n    # Align 3d items horizontally to the left\r\n    for item in _3d_imports:\r\n        # Accomodate right end of item\r\n        base_point_3d.X -= item.mid\r\n\r\n        item.move(base_point_3d)\r\n\r\n        label_3d_item(item, spacing=half_border)\r\n\r\n        # Accomodate left end of item\r\n        base_point_3d.X -= item.mid\r\n\r\n        # Invariant: Offset point is now at left end of item\r\n\r\n        # Add border between items\r\n        base_point_3d.X -= border\r\n\r\n\r\nif __name__ == \"__main__\":\r\n    folder = current_folder()\r\n    import_dxfs(folder, border=20)",
  "language": "python",
  "imports": [
    "Rhino",
    "Rhino.Geometry",
    "rhinoscriptsyntax",
    "scriptcontext"
  ],
  "has_docstring": true
}