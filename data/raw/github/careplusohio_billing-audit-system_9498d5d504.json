{
  "source_url": "https://github.com/careplusohio/billing-audit-system/blob/9646be39fef77a928a45e06c5462c0ffb6be9780/audits/views_rhino.py",
  "repo": "careplusohio/billing-audit-system",
  "repo_stars": 0,
  "repo_description": null,
  "license": "unknown",
  "filepath": "audits/views_rhino.py",
  "instruction": "/backend/audits/views_rhino.py",
  "code": "# /backend/audits/views_rhino.py\nfrom django.http import JsonResponse, HttpResponse\nfrom django.shortcuts import render, get_object_or_404, redirect\nfrom django.template.loader import render_to_string\nfrom django.contrib import messages\nfrom django.db.models import Q, Sum\nfrom django.db import connection\nfrom django.contrib.admin.views.decorators import staff_member_required\nfrom django.contrib.auth.decorators import login_required\nfrom django.views.decorators.csrf import csrf_exempt\nfrom django.utils.decorators import method_decorator\nfrom django.utils.datastructures import MultiValueDictKeyError\nfrom rest_framework.parsers import MultiPartParser\nfrom rest_framework.views import APIView\nfrom rest_framework.response import Response\nfrom rest_framework import status\nfrom rest_framework.decorators import api_view, permission_classes\nfrom rest_framework.permissions import IsAuthenticated\n\nimport csv\nimport zipfile\nimport io\nfrom weasyprint import HTML\n\nfrom .models import RhinoClaim\nfrom .serializers import RhinoClaimSerializer\n\n\n@login_required\ndef rhino_claims_dashboard(request):\n    query = request.GET.get('q', '')\n    start_date = request.GET.get('start_date')\n    end_date = request.GET.get('end_date')\n    payer = request.GET.get('payer')\n\n    claims = RhinoClaim.objects.all()\n\n    if query:\n        claims = claims.filter(\n            Q(patient_first_name__icontains=query) |\n            Q(patient_last_name__icontains=query) |\n            Q(rb_claim_id__icontains=query) |\n            Q(claim_status__icontains=query) |\n            Q(payer__icontains=query)\n        )\n\n    if start_date:\n        claims = claims.filter(date_of_service__gte=start_date)\n    if end_date:\n        claims = claims.filter(date_of_service__lte=end_date)\n    if payer:\n        claims = claims.filter(payer__icontains=payer)\n\n    total_claims = claims.count()\n    total_billed = claims.aggregate(Sum('total_billed'))['total_billed__sum'] or 0\n    total_paid = claims.aggregate(Sum('total_paid'))['total_paid__sum'] or 0\n\n    context = {\n        \"claims\": claims.order_by(\"-created_date\")[:200],\n        \"query\": query,\n        \"total_claims\": total_claims,\n        \"total_billed\": total_billed,\n        \"total_paid\": total_paid,\n        \"start_date\": start_date,\n        \"end_date\": end_date,\n        \"payer\": payer,\n    }\n    return render(request, \"audits/rhino_claims_dashboard.html\", context)\n\n\n@staff_member_required\ndef export_rhino_claims_pdf(request):\n    claims = RhinoClaim.objects.all().order_by(\"-id\")[:200]\n    html_string = render_to_string(\"audits/rhino_claims_pdf.html\", {\"claims\": claims})\n    pdf_file = HTML(string=html_string).write_pdf()\n\n    response = HttpResponse(pdf_file, content_type=\"application/pdf\")\n    response[\"Content-Disposition\"] = \"attachment; filename=rhino_claims.pdf\"\n    return response\n\n\n@staff_member_required\ndef export_rhino_claims_csv(request):\n    claims = RhinoClaim.objects.all().order_by(\"-id\")[:200]\n    response = HttpResponse(content_type=\"text/csv\")\n    response[\"Content-Disposition\"] = \"attachment; filename=rhino_claims.csv\"\n\n    writer = csv.writer(response)\n    headers = [field.name for field in RhinoClaim._meta.fields]\n    writer.writerow(headers)\n\n    for claim in claims:\n        writer.writerow([getattr(claim, field) for field in headers])\n\n    return response\n\n\n@staff_member_required\ndef export_rhino_claims_zip(request):\n    claims = RhinoClaim.objects.all().order_by(\"-id\")[:200]\n    buffer = io.BytesIO()\n\n    with zipfile.ZipFile(buffer, \"w\") as zip_file:\n        csv_io = io.StringIO()\n        writer = csv.writer(csv_io)\n        headers = [field.name for field in RhinoClaim._meta.fields]\n        writer.writerow(headers)\n\n        for claim in claims:\n            writer.writerow([getattr(claim, field) for field in headers])\n\n        zip_file.writestr(\"rhino_claims.csv\", csv_io.getvalue())\n\n    buffer.seek(0)\n    response = HttpResponse(buffer, content_type=\"application/zip\")\n    response[\"Content-Disposition\"] = \"attachment; filename=rhino_claims.zip\"\n    return response\n\n\n@api_view(['GET'])\n@permission_classes([IsAuthenticated])\ndef rhino_claim_detail(request, id):\n    try:\n        claim = RhinoClaim.objects.get(id=id)\n    except RhinoClaim.DoesNotExist:\n        return Response({\"error\": \"Rhino claim not found\"}, status=404)\n\n    serializer = RhinoClaimSerializer(claim)\n    return Response(serializer.data)\n\n\n@csrf_exempt\ndef upload_rhino_csv(request):\n    if request.method == \"POST\":\n        csv_file = request.FILES.get(\"file\")\n        if not csv_file or not csv_file.name.endswith('.csv'):\n            return JsonResponse({\"error\": \"Invalid file uploaded.\"}, status=400)\n\n        decoded_file = csv_file.read().decode('utf-8')\n        io_string = io.StringIO(decoded_file)\n        reader = csv.DictReader(io_string)\n\n        count = 0\n        for row in reader:\n            try:\n                RhinoClaim.objects.create(\n                    patient_first_name=row.get('patient_first_name', ''),\n                    patient_last_name=row.get('patient_last_name', ''),\n                    patient_dob=row.get('patient_dob', None),\n                    date_of_service=row.get('date_of_service', None),\n                    total_billed=row.get('total_billed') or 0,\n                    total_paid=row.get('total_paid') or 0,\n                    patient_payer=row.get('patient_payer', ''),\n                    claim_status=row.get('claim_status', '')\n                )\n                count += 1\n            except Exception as e:\n                return JsonResponse({\"error\": f\"Error on row {count + 1}: {str(e)}\"}, status=400)\n\n        return JsonResponse({\"message\": f\"Successfully uploaded {count} claims.\"})\n\n    return JsonResponse({\"error\": \"Invalid request method.\"}, status=405)\n\n\n@method_decorator(csrf_exempt, name='dispatch')\n\nclass RhinoCSVUploadView(APIView):\n    def post(self, request, *args, **kwargs):\n        file_obj = request.FILES.get(\"file\")\n        if not file_obj:\n            return Response({\"error\": \"No file provided.\"}, status=status.HTTP_400_BAD_REQUEST)\n\n        decoded_file = file_obj.read().decode(\"utf-8\").splitlines()\n        reader = csv.DictReader(decoded_file)\n        required_fields = {\"trading_partner_name\", \"patient_id\", \"date_of_service\"}\n        missing_fields = required_fields - set(reader.fieldnames)\n\n        if missing_fields:\n            return Response({\n                \"error\": \"Missing required fields in CSV: \" + \", \".join(missing_fields)\n            }, status=status.HTTP_400_BAD_REQUEST)\n\n        # Just simulate accepting file for now\n        return Response({\"message\": \"CSV uploaded and validated successfully.\"})\n",
  "language": "python",
  "imports": [],
  "has_docstring": true
}