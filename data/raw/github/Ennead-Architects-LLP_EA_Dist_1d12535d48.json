{
  "source_url": "https://github.com/Ennead-Architects-LLP/EA_Dist/blob/635520d89b8308b78eabf5b60bb80121d0fa3838/Apps/_revit/EnneaDuck.extension/EnneadTab.tab/Import%20Export.panel/Rhino.pulldown/room2diagram.pushbutton/revit_process.py",
  "repo": "Ennead-Architects-LLP/EA_Dist",
  "repo_stars": 0,
  "repo_description": null,
  "license": "unknown",
  "filepath": "Apps/_revit/EnneaDuck.extension/EnneadTab.tab/Import Export.panel/Rhino.pulldown/room2diagram.pushbutton/revit_process.py",
  "instruction": "Revit-specific processing for room2diagram export.",
  "code": "#!/usr/bin/python\r\n# -*- coding: utf-8 -*-\r\n\r\n\"\"\"\r\nRevit-specific processing for room2diagram export.\r\n\"\"\"\r\n\r\n# ============================================================================\r\n# RHINOINSIDE IMPORT CHECK - MUST BE FIRST\r\n# ============================================================================\r\ntry:\r\n    import clr  # pyright: ignore\r\n    clr.AddReference('RhinoCommon')\r\n    import Rhino  # pyright: ignore\r\n    clr.AddReference('RhinoInside.Revit')\r\n    from RhinoInside.Revit.Convert.Geometry import GeometryEncoder as RIR_ENCODER  # pyright: ignore\r\n    RHINO_IMPORT_OK = True\r\nexcept:\r\n    RHINO_IMPORT_OK = False\r\n\r\n# ============================================================================\r\n# STANDARD IMPORTS\r\n# ============================================================================\r\nimport System  # pyright: ignore\r\nfrom EnneadTab import TIME, SAMPLE_FILE\r\nfrom EnneadTab.REVIT import REVIT_VIEW, REVIT_SELECTION, REVIT_UNIT, REVIT_FAMILY, REVIT_APPLICATION\r\nfrom Autodesk.Revit import DB # pyright: ignore\r\nfrom base_processor import BaseProcessor\r\n\r\n\r\nclass RevitProcess(BaseProcessor):\r\n    \"\"\"Handles Revit-specific processing for floor plan view export with filled regions.\"\"\"\r\n    \r\n    def __init__(self, revit_doc, fillet_radius, offset_distance):\r\n        \"\"\"Initialize Revit processor.\r\n        \r\n        Args:\r\n            revit_doc: Active Revit document\r\n            fillet_radius: Corner fillet radius in feet\r\n            offset_distance: Inner offset distance in feet\r\n        \"\"\"\r\n        BaseProcessor.__init__(self, revit_doc, fillet_radius, offset_distance)\r\n        print(\"RevitProcess initialized with fillet_radius={}, offset_distance={}\".format(fillet_radius, offset_distance))\r\n    \r\n    def _has_curves(self, curve_loop):\r\n        \"\"\"Check if a CurveLoop has any curves using iterator approach.\"\"\"\r\n        if not curve_loop:\r\n            return False\r\n        \r\n        try:\r\n            curve_iterator = curve_loop.GetCurveLoopIterator()\r\n            return curve_iterator.MoveNext()\r\n        except Exception as e:\r\n            print(\"Error checking curve loop: {}\".format(str(e)))\r\n            return False\r\n    \r\n    def _process_curves_for_drafting(self, curve_loop):\r\n        \"\"\"Process curves for drafting view with fillet and offset operations.\"\"\"\r\n        if not curve_loop:\r\n            return None\r\n        \r\n        # Convert curve loop to list of curves\r\n        curves = []\r\n        curve_iterator = curve_loop.GetCurveLoopIterator()\r\n        while curve_iterator.MoveNext():\r\n            curves.append(curve_iterator.Current)\r\n        \r\n        print(\"Processing {} curves with fillet_radius={}, offset_distance={}\".format(len(curves), self.fillet_radius, self.offset_distance))\r\n        \r\n        # Use base class curve processing (returns processed Rhino curves)\r\n        processed_rhino_curves = self.process_curves(curves, \"revit\")\r\n        \r\n        if not processed_rhino_curves:\r\n            return curve_loop  # Return original if processing fails\r\n        \r\n        # Convert processed Rhino curves back to Revit CurveLoop\r\n        return self._convert_rhino_curves_to_curve_loop(processed_rhino_curves)\r\n    \r\n    def _convert_rhino_curves_to_curve_loop(self, rhino_curves):\r\n        \"\"\"Convert processed Rhino curves to Revit CurveLoop using ToCurveLoop.\"\"\"\r\n        if not rhino_curves or len(rhino_curves) == 0:\r\n            return None\r\n        \r\n        try:\r\n            # BaseProcessor typically returns a single joined polycurve with fillet and offset applied\r\n            # RIR_ENCODER.ToCurveLoop() can convert this directly to a Revit CurveLoop\r\n            if len(rhino_curves) > 0:\r\n                rhino_curve = rhino_curves[0]  # Get the first (and typically only) curve\r\n                \r\n                if not rhino_curve:\r\n                    return None\r\n                \r\n                if not hasattr(rhino_curve, 'IsValid') or not rhino_curve.IsValid:\r\n                    return None\r\n                \r\n                # Use RIR_ENCODER.ToCurveLoop() to convert the joined polycurve directly to Revit CurveLoop\r\n                try:\r\n                    curve_loop = RIR_ENCODER.ToCurveLoop(rhino_curve)\r\n                    if curve_loop and self._has_curves(curve_loop):\r\n                        return curve_loop\r\n                    else:\r\n                        return None\r\n                except Exception as e:\r\n                    print(\"Error converting joined polycurve to CurveLoop: {}\".format(str(e)))\r\n                    return None\r\n            else:\r\n                return None\r\n            \r\n        except Exception as e:\r\n            print(\"Error in _convert_rhino_curves_to_curve_loop: {}\".format(str(e)))\r\n            return None\r\n\r\n    def _create_filled_region_from_curves(self, curve_loop, filled_region_type, floor_plan_view):\r\n        \"\"\"Create filled region from curve loop.\"\"\"\r\n        try:\r\n            if not curve_loop or not filled_region_type or not floor_plan_view:\r\n                return False, None\r\n            \r\n            # Create filled region within transaction\r\n            t = DB.Transaction(self.revit_doc, \"Create Bubble Diagram Filled Region\")\r\n            t.Start()\r\n            try:\r\n                # Create a list of curve loops - DB.FilledRegion.Create expects a collection\r\n                curve_loops = System.Collections.Generic.List[DB.CurveLoop]()\r\n                curve_loops.Add(curve_loop)\r\n                \r\n                # Create filled region\r\n                filled_region = DB.FilledRegion.Create(\r\n                    self.revit_doc,\r\n                    filled_region_type.Id,\r\n                    floor_plan_view.Id,\r\n                    curve_loops\r\n                )\r\n                \r\n                if filled_region:\r\n                    t.Commit()\r\n                    return True, filled_region\r\n                else:\r\n                    t.RollBack()\r\n                    return False, None\r\n                    \r\n            except Exception as e:\r\n                print(\"Error in transaction creating filled region: {}\".format(str(e)))\r\n                t.RollBack()\r\n                return False, None\r\n                \r\n        except Exception as e:\r\n            print(\"Error creating filled region: {}\".format(str(e)))\r\n            return False, None\r\n    \r\n    def _add_comment_to_filled_region(self, filled_region, space_identifier, space_area, space_object):\r\n        \"\"\"Add comment to filled region with space information including original area and department.\r\n        \r\n        Args:\r\n            filled_region: Revit filled region object\r\n            space_identifier: Space identifier string\r\n            space_area: Area value in square feet\r\n            space_object: Original Revit space object to get parameters from\r\n        \"\"\"\r\n        try:\r\n            if not filled_region or not space_object:\r\n                return False\r\n            \r\n            # Get original area from space object\r\n            original_area = 0\r\n            try:\r\n                area_param = space_object.LookupParameter(\"Area\")\r\n                if area_param:\r\n                    original_area = area_param.AsDouble()\r\n                    # Convert to square feet if needed\r\n                    original_area_sf = DB.UnitUtils.ConvertFromInternalUnits(original_area, REVIT_UNIT.lookup_unit_id(\"squareFeet\"))\r\n                    original_area_rounded = int(round(original_area_sf)) if original_area_sf > 0 else 0\r\n                else:\r\n                    original_area_rounded = 0\r\n            except Exception as e:\r\n                print(\"Warning: Could not get original area from space: {}\".format(str(e)))\r\n                original_area_rounded = 0\r\n            \r\n            \r\n            \r\n            # Create comment content with original area and department\r\n            comment_content = \"{} - {:,} SF\".format(space_identifier, original_area_rounded)\r\n            \r\n            # Add comment to filled region within transaction\r\n            t = DB.Transaction(self.revit_doc, \"Add Comment to Filled Region\")\r\n            t.Start()\r\n            try:\r\n                # Use only the \"Comments\" parameter per preference\r\n                comment_param = filled_region.LookupParameter(\"Comments\")\r\n                if comment_param and not comment_param.IsReadOnly:\r\n                    comment_param.Set(comment_content)\r\n                    t.Commit()\r\n                    return True\r\n                \r\n                print(\"Warning: 'Comments' parameter not found or read-only on filled region\")\r\n                t.RollBack()\r\n                return False\r\n            except Exception as e:\r\n                print(\"Error in transaction adding comment: {}\".format(str(e)))\r\n                t.RollBack()\r\n                return False\r\n                \r\n        except Exception as e:\r\n            print(\"Error adding comment to filled region: {}\".format(str(e)))\r\n            return False\r\n    \r\n    def _get_or_create_bubble_diagram_tag_family(self):\r\n        \"\"\"Get or create bubble diagram tag family for filled regions.\"\"\"\r\n        try:\r\n            # Try to get existing tag family or load from file if not found\r\n            tag_family_name = \"BubbleDiagram Tag\"\r\n            \r\n            # Use SAMPLE_FILE.get_file to get the family file path\r\n            family_file_path = SAMPLE_FILE.get_file(\"BubbleDiagram Tag.rfa\")\r\n            \r\n            if family_file_path:\r\n                # print(\"Found BubbleDiagram Tag.rfa at: {}\".format(family_file_path))\r\n                # Use get_family_by_name with load_path_if_not_exist parameter\r\n                tag_family = REVIT_FAMILY.get_family_by_name(\r\n                    tag_family_name, \r\n                    doc=self.revit_doc,\r\n                    load_path_if_not_exist=family_file_path\r\n                )\r\n                \r\n                if tag_family:\r\n                    # print(\"Successfully loaded BubbleDiagram Tag family\")\r\n                    return tag_family\r\n                else:\r\n                    print(\"Failed to load BubbleDiagram Tag family from file\")\r\n                    return None\r\n            else:\r\n                print(\"BubbleDiagram Tag.rfa not found using SAMPLE_FILE.get_file\")\r\n                print(\"Please ensure the family file is available in the EnneadTab sample files folder\")\r\n                return None\r\n                \r\n        except Exception as e:\r\n            print(\"Error getting or creating tag family: {}\".format(str(e)))\r\n            return None\r\n    \r\n    def _create_tag_for_filled_region(self, filled_region, space_identifier, floor_plan_view):\r\n        \"\"\"Create tag for filled region using tag family and type.\r\n        \r\n        Args:\r\n            filled_region: Revit filled region object\r\n            space_identifier: Space identifier string\r\n            floor_plan_view: Revit floor plan view to create tag in\r\n        \"\"\"\r\n        try:\r\n            if not filled_region or not floor_plan_view:\r\n                return False\r\n            \r\n            # Get or create tag family\r\n            tag_family = self._get_or_create_bubble_diagram_tag_family()\r\n            if not tag_family:\r\n                print(\"Warning: Could not create or find tag family. Tags will be skipped.\")\r\n                return False\r\n            \r\n            # Find an IndependentTagType to use (by family or name)\r\n            tag_type = None\r\n            try:\r\n                candidate_types = DB.FilteredElementCollector(self.revit_doc) \\\r\n                    .OfClass(DB.IndependentTagType) \\\r\n                    .WhereElementIsElementType() \\\r\n                    .ToElements()\r\n                for tt in candidate_types:\r\n                    try:\r\n                        if hasattr(tt, 'FamilyName') and tt.FamilyName and 'BubbleDiagram' in tt.FamilyName:\r\n                            tag_type = tt\r\n                            break\r\n                        if tt.Name and 'BubbleDiagram' in tt.Name:\r\n                            tag_type = tt\r\n                            break\r\n                    except:\r\n                        continue\r\n                if not tag_type and candidate_types:\r\n                    tag_type = candidate_types[0]\r\n            except Exception as _e:\r\n                tag_type = None\r\n            \r\n            # Create tag within transaction\r\n            t = DB.Transaction(self.revit_doc, \"Create Bubble Diagram Tag\")\r\n            t.Start()\r\n            try:\r\n                # Create tag for the filled region using the tag type\r\n                # Determine a placement point from the filled region's bounding box (in view coordinates)\r\n                bbox = filled_region.get_BoundingBox(floor_plan_view)\r\n                if bbox and bbox.Min and bbox.Max:\r\n                    center = DB.XYZ(\r\n                        (bbox.Min.X + bbox.Max.X) / 2.0,\r\n                        (bbox.Min.Y + bbox.Max.Y) / 2.0,\r\n                        (bbox.Min.Z + bbox.Max.Z) / 2.0,\r\n                    )\r\n                else:\r\n                    center = DB.XYZ(0, 0, 0)\r\n\r\n                # Try to create an IndependentTag first (may not be supported for FilledRegion)\r\n                tag = None\r\n                try:\r\n                    tag = DB.IndependentTag.Create(\r\n                        self.revit_doc,\r\n                        floor_plan_view.Id,\r\n                        DB.Reference(filled_region),\r\n                        False,\r\n                        DB.TagMode.TM_ADDBY_CATEGORY,\r\n                        DB.TagOrientation.Horizontal,\r\n                        center,\r\n                    )\r\n                    if tag and tag_type:\r\n                        try:\r\n                            tag.ChangeTypeId(tag_type.Id)\r\n                        except Exception as change_type_err:\r\n                            print(\"Warning: Could not change tag type: {}\".format(str(change_type_err)))\r\n                except Exception:\r\n                    tag = None\r\n                \r\n                if tag:\r\n                    t.Commit()\r\n                    return True\r\n                \r\n\r\n                \r\n            except Exception as e:\r\n                print(\"Error in transaction creating tag: {}\".format(str(e)))\r\n                t.RollBack()\r\n                return False\r\n                \r\n        except Exception as e:\r\n            print(\"Error creating tag for filled region {}: {}\".format(space_identifier, str(e)))\r\n            return False\r\n    \r\n    def _create_get_floor_plan_view(self, level_name, prefix):\r\n        \"\"\"Create or get existing floor plan view for Revit export and hide all model categories except detail items.\"\"\"\r\n        try:\r\n            # Create floor plan view name\r\n            view_name = \"{}_{}\".format(prefix, level_name)\r\n            \r\n            # First check if view already exists - if so, clean it and return it\r\n            existing_view = REVIT_VIEW.get_view_by_name(view_name, self.revit_doc)\r\n            if existing_view:\r\n                print(\"Found existing floor plan view: '{}'. Cleaning existing filled regions and returning view.\".format(view_name))\r\n                \r\n                # Delete all filled regions with type names beginning with _ColorScheme_\r\n                self._delete_existing_color_scheme_filled_regions(existing_view)\r\n                \r\n                return existing_view\r\n            \r\n            # Find the level by name\r\n            level = None\r\n            levels = DB.FilteredElementCollector(self.revit_doc).OfClass(DB.Level).ToElements()\r\n            for lvl in levels:\r\n                if lvl.Name == level_name:\r\n                    level = lvl\r\n                    break\r\n            \r\n            if not level:\r\n                print(\"Warning: Could not find level '{}', using first available level\".format(level_name))\r\n                if levels:\r\n                    level = levels[0]\r\n                else:\r\n                    print(\"Error: No levels found in document\")\r\n                    return None\r\n            \r\n            # Create new floor plan view within transaction\r\n            floor_plan_view = None\r\n            t = DB.Transaction(self.revit_doc, \"Create Bubble Diagram Floor Plan View\")\r\n            t.Start()\r\n            try:\r\n                # Get the floor plan view type\r\n                view_types = DB.FilteredElementCollector(self.revit_doc).OfClass(DB.ViewFamilyType).ToElements()\r\n                floor_plan_type = None\r\n                for view_type in view_types:\r\n                    if view_type.FamilyName == \"Floor Plan\":\r\n                        floor_plan_type = view_type\r\n                        break\r\n                \r\n                if not floor_plan_type:\r\n                    print(\"Warning: Could not find Floor Plan view type, using first available\")\r\n                    if view_types:\r\n                        floor_plan_type = view_types[0]\r\n                    else:\r\n                        print(\"Error: No view plan types found in document\")\r\n                        t.RollBack()\r\n                        return None\r\n                \r\n                # Create floor plan view\r\n                floor_plan_view = DB.ViewPlan.Create(self.revit_doc, \r\n                                                    floor_plan_type.Id, \r\n                                                    level.Id)\r\n                \r\n                if floor_plan_view:\r\n                    # Set view name\r\n                    floor_plan_view.Name = view_name\r\n                    \r\n                    # Set ViewGroup and ViewSeries properties\r\n                    view_group_param = floor_plan_view.LookupParameter(\"Views_$Group\")\r\n                    if view_group_param and not view_group_param.IsReadOnly:\r\n                        view_group_param.Set(\"EnneadTab\")\r\n                    \r\n                    view_series_param = floor_plan_view.LookupParameter(\"Views_$Series\")\r\n                    if view_series_param and not view_series_param.IsReadOnly:\r\n                        view_series_param.Set(\"BubbleDiagram\")\r\n                    \r\n                    # print(\"Set Views_$Group to 'EnneadTab' and Views_$Series to 'BubbleDiagram'\")\r\n                    \r\n                    # Set view scale to match the original source view\r\n                    try:\r\n                        scale_param = floor_plan_view.LookupParameter(\"View Scale\")\r\n                        if scale_param and not scale_param.IsReadOnly:\r\n                            # Get scale from source view if available\r\n                            if hasattr(self, 'source_view') and self.source_view:\r\n                                try:\r\n                                    source_scale_param = self.source_view.LookupParameter(\"View Scale\")\r\n                                    if source_scale_param:\r\n                                        source_scale = source_scale_param.AsInteger()\r\n                                        scale_param.Set(source_scale)\r\n                                        # print(\"Set view scale to match source view: 1:{}\".format(source_scale))\r\n                                    else:\r\n                                        # Fallback to 1/8\" = 1'-0\" scale (1:96)\r\n                                        scale_param.Set(96)\r\n                                        print(\"Set view scale to default 1/8\\\" = 1'-0\\\" (source view scale not available)\")\r\n                                except Exception as e:\r\n                                    print(\"Warning: Could not get scale from source view: {}. Using default scale.\".format(str(e)))\r\n                                    scale_param.Set(96)\r\n                                    print(\"Set view scale to default 1/8\\\" = 1'-0\\\"\")\r\n                            else:\r\n                                # No source view available, use default scale\r\n                                scale_param.Set(96)\r\n                                print(\"Set view scale to default 1/8\\\" = 1'-0\\\" (no source view)\")\r\n                    except Exception as e:\r\n                        print(\"Warning: Could not set view scale: {}\".format(str(e)))\r\n                    \r\n                    # Set view discipline to Coordination for better category control\r\n                    try:\r\n                        discipline_param = floor_plan_view.LookupParameter(\"Discipline\")\r\n                        if discipline_param and not discipline_param.IsReadOnly:\r\n                            discipline_param.Set(1)  # 1 = Coordination\r\n                            # print(\"Set view discipline to Coordination\")\r\n                    except Exception as e:\r\n                        print(\"Warning: Could not set view discipline: {}\".format(str(e)))\r\n                    \r\n                    # Configure view categories for bubble diagram\r\n                    self._configure_bubble_diagram_view_categories(floor_plan_view)\r\n                \r\n                t.Commit()\r\n                \r\n            except Exception as e:\r\n                print(\"Error in transaction creating floor plan view: {}\".format(str(e)))\r\n                t.RollBack()\r\n                return None\r\n            \r\n            return floor_plan_view\r\n            \r\n        except Exception as e:\r\n            print(\"Error creating floor plan view: {}\".format(str(e)))\r\n            return None\r\n    \r\n    def _delete_existing_color_scheme_filled_regions(self, view):\r\n        \"\"\"Delete all filled regions in the view that have type names beginning with '_ColorScheme_'.\"\"\"\r\n        try:\r\n            # Get all filled regions in the view\r\n            filled_regions = DB.FilteredElementCollector(self.revit_doc, view.Id) \\\r\n                .OfClass(DB.FilledRegion) \\\r\n                .ToElements()\r\n            \r\n            if not filled_regions:\r\n                return\r\n            \r\n            # Filter filled regions by type name\r\n            regions_to_delete = []\r\n            for region in filled_regions:\r\n                try:\r\n                    # Get the filled region type\r\n                    region_type = self.revit_doc.GetElement(region.GetTypeId())\r\n                    if region_type:\r\n                        # Get type name using LookupParameter(\"Type Name\")\r\n                        type_name_param = region_type.LookupParameter(\"Type Name\")\r\n                        if type_name_param:\r\n                            type_name = type_name_param.AsString()\r\n                            if type_name and type_name.startswith('_ColorScheme_'):\r\n                                regions_to_delete.append(region)\r\n                except Exception as e:\r\n                    print(\"Warning: Could not check type name for filled region: {}\".format(str(e)))\r\n                    continue\r\n            \r\n            if not regions_to_delete:\r\n                return\r\n            \r\n            # Delete the filtered filled regions within a transaction\r\n            t = DB.Transaction(self.revit_doc, \"Delete Existing Color Scheme Filled Regions\")\r\n            t.Start()\r\n            try:\r\n                for region in regions_to_delete:\r\n                    try:\r\n                        self.revit_doc.Delete(region.Id)\r\n                    except Exception as e:\r\n                        print(\"Warning: Could not delete filled region: {}\".format(str(e)))\r\n                        continue\r\n                \r\n                t.Commit()\r\n                \r\n            except Exception as e:\r\n                print(\"Error in transaction deleting filled regions: {}\".format(str(e)))\r\n                t.RollBack()\r\n                    \r\n        except Exception as e:\r\n            print(\"Error deleting existing color scheme filled regions: {}\".format(str(e)))\r\n    \r\n    def _configure_bubble_diagram_view_categories(self, view):\r\n        \"\"\"Configure view categories for bubble diagram - hide all except detail items, detail item tags, and grids.\"\"\"\r\n        try:\r\n            # Define categories to keep visible\r\n            visible_categories = [\r\n                DB.BuiltInCategory.OST_DetailComponents,     # Detail items (detail components)\r\n                DB.BuiltInCategory.OST_DetailComponentTags,  # Detail item tags\r\n                DB.BuiltInCategory.OST_Grids                 # Grids\r\n            ]\r\n            \r\n            print(\"Starting category configuration for bubble diagram view...\")\r\n            \r\n            # Note: This method is called from within an active transaction in _create_get_floor_plan_view\r\n            # so we don't need to create a new transaction here\r\n            # Method 1: Use document settings categories (more reliable approach)\r\n            for category in self.revit_doc.Settings.Categories:\r\n                try:\r\n                    # Skip categories that can't be hidden\r\n                    if not view.CanCategoryBeHidden(category.Id):\r\n                        continue\r\n                    \r\n                    # Check if this category should be visible\r\n                    should_be_visible = category.Id in [DB.Category.GetCategory(self.revit_doc, cat).Id for cat in visible_categories]\r\n                    \r\n                    # Set category visibility using the standard pattern from codebase\r\n                    view.SetCategoryHidden(category.Id, not should_be_visible)\r\n                    \r\n                    # Keep logging minimal; only errors/warnings are printed elsewhere\r\n                        \r\n                except Exception as e:\r\n                    # Some categories might not be controllable, skip them\r\n                    print(\"Warning: Could not control category {}: {}\".format(category.Name, str(e)))\r\n                    continue\r\n            \r\n            # Method 2 removed per request; rely solely on category visibility control above\r\n            \r\n        except Exception as e:\r\n            print(\"Error hiding categories: {}\".format(str(e)))\r\n            import traceback\r\n            print(\"Full traceback: {}\".format(traceback.format_exc()))\r\n    \r\n    def _process_space_for_revit(self, space_data, floor_plan_view):\r\n        \"\"\"Process a single space for Revit export.\"\"\"\r\n        try:\r\n            # Handle both space_data dictionary and direct space object\r\n            if isinstance(space_data, dict):\r\n                # Input is a processed space_data dictionary\r\n                space = space_data['space']\r\n                space_identifier = space_data['identifier']\r\n                space_area = space_data['area']\r\n                boundary_curves = space_data['curves']\r\n                revit_color = space_data['color']\r\n                \r\n            else:\r\n                # Input is a direct space object (legacy support)\r\n                space = space_data\r\n                space_identifier = space.LookupParameter(self.para_name).AsString()\r\n                if not space_identifier:\r\n                    return False\r\n                \r\n                # Get area from space object\r\n                try:\r\n                    space_area = int(round(space.Area)) if space.Area > 0 else 0\r\n                except:\r\n                    space_area = 0\r\n                \r\n                # Get color from color dictionary\r\n                revit_color = self.color_dict.get(space_identifier)\r\n                \r\n                # Use boundary curves from space_data (already extracted by BaseProcessor)\r\n                boundary_curves = space_data.get('curves', [])\r\n            \r\n            # Validate color\r\n            if not revit_color:\r\n                print(\"No color found, skipping space\")\r\n                return False\r\n            \r\n            # Get or create filled region type (wrapped in transaction for type creation)\r\n            region_type_name = \"_ColorScheme_{}\".format(space_identifier)\r\n            \r\n            # First check if type exists\r\n            filled_region_type = REVIT_SELECTION.get_filledregion_type(\r\n                self.revit_doc,\r\n                region_type_name,\r\n                color_if_not_exist=None\r\n            )\r\n            \r\n            # If type doesn't exist, create it within a transaction\r\n            if not filled_region_type:\r\n                t = DB.Transaction(self.revit_doc, \"Create Filled Region Type\")\r\n                t.Start()\r\n                try:\r\n                    filled_region_type = REVIT_SELECTION.get_filledregion_type(\r\n                        self.revit_doc,\r\n                        region_type_name,\r\n                        color_if_not_exist=(revit_color.Red, revit_color.Green, revit_color.Blue)\r\n                    )\r\n                    t.Commit()\r\n                except Exception as e:\r\n                    print(\"Error creating filled region type: {}\".format(str(e)))\r\n                    t.RollBack()\r\n                    filled_region_type = None\r\n            \r\n            if not filled_region_type:\r\n                print(\"Could not get or create filled region type\")\r\n                return False\r\n            \r\n            # Create filled region and add comment/tag\r\n            filled_region_success = False\r\n            comment_success = False\r\n            tag_success = False\r\n            \r\n            # Process boundary curves and create filled region\r\n            filled_region_success = False\r\n            created_filled_region = None\r\n            #\r\n            if boundary_curves:\r\n                try:\r\n                    # First, process the curves through BaseProcessor to apply fillet and offset\r\n                    #\r\n                    processed_curves = self.process_curves(boundary_curves, \"revit\")\r\n                    \r\n                    if processed_curves and len(processed_curves) > 0:\r\n                        #\r\n                        \r\n                        # Get the first (and typically only) processed curve from BaseProcessor\r\n                        processed_curve = processed_curves[0]\r\n                        if processed_curve and hasattr(processed_curve, 'IsValid') and processed_curve.IsValid:\r\n                            #\r\n                            try:\r\n                                # Use RIR_ENCODER.ToCurveLoop() to convert the processed curve directly to Revit CurveLoop\r\n                                curve_loop = RIR_ENCODER.ToCurveLoop(processed_curve)\r\n                                if curve_loop and self._has_curves(curve_loop):\r\n                                    #\r\n                                    \r\n                                    # Create filled region with the CurveLoop\r\n                                    try:\r\n                                        filled_region_success, created_filled_region = self._create_filled_region_from_curves(curve_loop, filled_region_type, floor_plan_view)\r\n                                        if filled_region_success:\r\n                                            # print(\"Created filled region with processed curves (fillet and offset applied)\")\r\n                                            pass\r\n                                    except Exception as e:\r\n                                        print(\"Failed to create filled region with processed curves for space {}: {}\".format(space_identifier, str(e)))\r\n                                else:\r\n                                    #\r\n                                    curve_loop = None\r\n                            except Exception as e:\r\n                                #\r\n                                curve_loop = None\r\n                        else:\r\n                            #\r\n                            curve_loop = None\r\n                    else:\r\n                        #\r\n                        curve_loop = None\r\n                    \r\n                    if not curve_loop:\r\n                        print(\"No valid curve loop created for space: {}\".format(space_identifier))\r\n                except Exception as e:\r\n                    print(\"Error processing boundary curves for space {}: {}\".format(space_identifier, str(e)))\r\n            \r\n            # Add comment and tag to the filled region if it was created successfully\r\n            if filled_region_success and created_filled_region:\r\n                try:\r\n                    # Verify filled region creation and list available parameters\r\n                    # print(\"Verifying filled region creation for space: {}\".format(space_identifier))\r\n                    self._verify_filled_region_creation(created_filled_region, space_identifier)\r\n                    \r\n                    # Add comment to filled region\r\n                    # print(\"Adding comment to filled region for space: {}\".format(space_identifier))\r\n                    comment_success = self._add_comment_to_filled_region(created_filled_region, space_identifier, space_area, space)\r\n                    \r\n                    # Create tag for filled region\r\n                    # print(\"Creating tag for filled region for space: {}\".format(space_identifier))\r\n                    tag_success = self._create_tag_for_filled_region(created_filled_region, space_identifier, floor_plan_view)\r\n                except Exception as e:\r\n                    print(\"Failed to add comment/tag for space {}: {}\".format(space_identifier, str(e)))\r\n                    import traceback\r\n                    print(\"Full traceback: {}\".format(traceback.format_exc()))\r\n            \r\n            # Return success if filled region was created successfully\r\n            success = filled_region_success\r\n            if success:\r\n                # print(\"Successfully processed space: {} (region: {}, comment: {}, tag: {})\".format(\r\n                #     space_identifier, filled_region_success, comment_success, tag_success))\r\n                pass\r\n            else:\r\n                print(\"Failed to process space: {} (region: {}, comment: {}, tag: {})\".format(\r\n                    space_identifier, filled_region_success, comment_success, tag_success))\r\n            \r\n            return success\r\n            \r\n        except Exception as e:\r\n            print(\"Error processing space for Revit: {}\".format(str(e)))\r\n            return False\r\n    \r\n    def _process_spaces_for_revit(self, results, source_view=None):\r\n        \"\"\"Process spaces for Revit export.\"\"\"\r\n        try:\r\n            # Store source view for use in floor plan creation\r\n            if source_view:\r\n                self.source_view = source_view\r\n            \r\n            # Get level name and processed spaces\r\n            level_name = results.get('level_name', 'Unknown_Level')\r\n            processed_spaces = results.get('processed_spaces', [])\r\n            \r\n            # Processing spaces for Revit export\r\n            \r\n            # Create floor plan view\r\n            if self.source_view.ViewType == DB.ViewType.FloorPlan:\r\n                prefix = \"BubbleDiagram\"\r\n            else:\r\n                area_scheme_name = self.source_view.AreaScheme.Name\r\n                prefix = \"BubbleDiagram_{}\".format(area_scheme_name)\r\n            floor_plan_view = self._create_get_floor_plan_view(level_name, prefix)\r\n            if not floor_plan_view:\r\n                return False\r\n            \r\n            # Process each space\r\n            processed_count = 0\r\n            for space_data in processed_spaces:\r\n                if self._process_space_for_revit(space_data, floor_plan_view):\r\n                    processed_count += 1\r\n            \r\n            # Set the floor plan view as active view after processing\r\n            try:\r\n                # Get the UIDocument to set active view\r\n                uidoc = REVIT_APPLICATION.get_uidoc()\r\n                uidoc.ActiveView = floor_plan_view\r\n            except Exception as e:\r\n                print(\"Warning: Could not set active view: {}\".format(str(e)))\r\n            \r\n            # Done processing spaces for Revit\r\n            return True\r\n            \r\n        except Exception as e:\r\n            print(\"Error in Revit processing: {}\".format(str(e)))\r\n            return False\r\n    \r\n    def process_spaces_from_results(self, results, source_view=None):\r\n        \"\"\"Process spaces from results for Revit export.\r\n        \r\n        Args:\r\n            results: Dictionary containing processed space data\r\n            source_view: Original source view (for getting scale and other properties)\r\n        \"\"\"\r\n        try:\r\n            # Store source view for use in floor plan creation\r\n            self.source_view = source_view\r\n            \r\n            # Delegate to Revit-specific processing\r\n            return self._process_spaces_for_revit(results, source_view)\r\n            \r\n        except Exception as e:\r\n            print(\"Error in Revit processing: {}\".format(str(e)))\r\n            return False\r\n    \r\n    def _verify_filled_region_creation(self, filled_region, space_identifier):\r\n        \"\"\"Verify that filled region was created successfully and has necessary parameters.\r\n        \r\n        Args:\r\n            filled_region: The created filled region object\r\n            space_identifier: Space identifier for debugging\r\n            \r\n        Returns:\r\n            bool: True if filled region is valid and has parameters, False otherwise\r\n        \"\"\"\r\n        try:\r\n            if not filled_region:\r\n                print(\"ERROR: Filled region is None for space: {}\".format(space_identifier))\r\n                return False\r\n            \r\n            if not filled_region.IsValidObject:\r\n                print(\"ERROR: Filled region is not valid for space: {}\".format(space_identifier))\r\n                return False\r\n            \r\n            # Check if filled region has parameters\r\n            if not filled_region.Parameters:\r\n                print(\"WARNING: Filled region has no parameters for space: {}\".format(space_identifier))\r\n                return False\r\n            \r\n            \r\n            \r\n            return True\r\n            \r\n        except Exception as e:\r\n            print(\"Error verifying filled region: {}\".format(str(e)))\r\n            return False\r\n\r\n\r\nif __name__ == \"__main__\":\r\n    pass\r\n\r\n",
  "language": "python",
  "imports": [
    "Rhino",
    "RhinoCommon"
  ],
  "has_docstring": true
}