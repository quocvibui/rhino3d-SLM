{
  "source_url": "https://github.com/Ennead-Architects-LLP/EA_Dist/blob/635520d89b8308b78eabf5b60bb80121d0fa3838/Apps/_rhino/Revit.tab/import_revit_collection.button/import_revit_collection_left.py",
  "repo": "Ennead-Architects-LLP/EA_Dist",
  "repo_stars": 0,
  "repo_description": null,
  "license": "unknown",
  "filepath": "Apps/_rhino/Revit.tab/import_revit_collection.button/import_revit_collection_left.py",
  "instruction": "Import revit collection left",
  "code": "\r\n__title__ = \"ImportRevitCollection\"\r\n__doc__ = \"Organize dwgs export from Revit to readable Rhino layer tree.\"\r\n\r\nimport scriptcontext as sc\r\nimport rhinoscriptsyntax as rs\r\nfrom EnneadTab import NOTIFICATION, FOLDER, DATA_FILE, ENVIRONMENT\r\nfrom EnneadTab import LOG, ERROR_HANDLE\r\nfrom EnneadTab.RHINO import RHINO_LAYER, RHINO_CLEANUP, RHINO_FORMS, RHINO_MATERIAL\r\n\r\nimport imp\r\nimport os\r\nrandom_layer_color_script_folder = \"{}\\\\Layer.tab\\\\random_layer_color.button\".format(ENVIRONMENT.RHINO_FOLDER)\r\nREF_MODULE = imp.load_source(\"random_layer_color_left\", '{}\\\\random_layer_color_left.py'.format(random_layer_color_script_folder))\r\n\r\n\r\n\r\ndef process_dwg(file, units, is_using_default_layer_structure):\r\n    RHINO_CLEANUP.purge_block()\r\n\r\n\r\n    print (\"working on file:\" + file)\r\n    \"\"\"\r\n    pick a layer to use:\r\n        curtain wall type, non basic roof, stair-----> as parent layer, subC name as child layer name\r\n        basic wall type, column, floor ----> type name as layer name\r\n    \"\"\"\r\n    #rs.Command(\"_-import \\\"{}\\\" -enter -enter\".format(file))\r\n    #units = \"Millimeters\"\r\n    rs.Command(\"_-import \\\"{}\\\" _ModelUnits={} -enter -enter\".format(file, units))\r\n\r\n    NOTIFICATION.messenger(\"Import Finish! Come Back, come back!\")\r\n    imported_objs = rs.LastCreatedObjects()\r\n    #print imported_objs\r\n    layers_used = set()\r\n\r\n\r\n    if not imported_objs:\r\n        # NOTIFICATION.messenger(main_text = \"Cannot find impoted objs.\")\r\n        NOTIFICATION.messenger(\"Cannot find impoted objs in file\\n{}.\".format(file))\r\n        return\r\n\r\n    for obj in imported_objs:\r\n        layer = rs.ObjectLayer(obj)\r\n        layers_used.add(layer)\r\n    layers_used = list(layers_used)\r\n\r\n    all_layers = rs.LayerNames()\r\n    all_layers_user = [RHINO_LAYER.rhino_layer_to_user_layer(x) for x in all_layers]\r\n    special_note =  \"<Type in a new parent layer name>\"\r\n    all_layers_user.insert(0, special_note)\r\n    if is_using_default_layer_structure:\r\n        parent_layer_prefix = all_layers_user[0]\r\n    else:\r\n        parent_layer_prefix = RHINO_FORMS.select_from_list(all_layers_user,\r\n                                                            title = \"Migrate imported Layers under another parent\",\r\n                                                            message = \"Enter text or select for the name of the parent layer\",\r\n                                                            multi_select = False,\r\n                                                            button_names = [\"Select Single Layer as Parent\"],\r\n                                                            width = 500,\r\n                                                            height = 500)\r\n    if parent_layer_prefix is None:\r\n        return\r\n    print (\"#########\")\r\n    print (parent_layer_prefix)\r\n    if parent_layer_prefix == special_note:\r\n        default_prefix = FOLDER.get_file_name_from_path(file).split(\".dwg\")[0]\r\n        if is_using_default_layer_structure:\r\n            parent_layer_prefix = default_prefix\r\n        else:\r\n            \r\n            parent_layer_prefix = rs.StringBox(message = \"type in parent layer name\", default_value = default_prefix, title = \"EnneadTab\")\r\n            if parent_layer_prefix is None:\r\n                return\r\n        parent_layer_prefix = \"[\" + parent_layer_prefix + \"]\"\r\n    parent_layer_prefix = RHINO_LAYER.user_layer_to_rhino_layer(parent_layer_prefix)\r\n    print (parent_layer_prefix)\r\n\r\n    #only need to change layer\r\n    change_objs_layer(imported_objs, parent_layer_prefix)\r\n    safely_delete_used_layer(layers_used)\r\n    REF_MODULE.random_layer_color(default_opt = True)\r\n    \r\n    # Redraw the view after processing this file\r\n    rs.Redraw()\r\n\r\n\r\n\r\ndef safely_delete_used_layer(layers_to_remove):\r\n    for layer in layers_to_remove:\r\n        rs.DeleteLayer(layer)\r\n\r\ndef change_objs_layer(objs, parent_layer_prefix):\r\n    cate_layer = parent_layer_prefix.split(\"Type_\")[0]\r\n    for obj in objs:\r\n        current_layer = rs.ObjectLayer(obj)\r\n        current_layer_color = rs.LayerColor(current_layer)\r\n        desired_layer = cate_layer + \"::\" + parent_layer_prefix + \"::\" + current_layer\r\n        if not rs.IsLayer(desired_layer):\r\n            rs.AddLayer(name = desired_layer, color=current_layer_color)\r\n            layer_material_index = retrive_OST_material(current_layer)\r\n            if layer_material_index is not None:\r\n                rs.LayerMaterialIndex(desired_layer, layer_material_index)\r\n        rs.ObjectLayer(obj, desired_layer)\r\n    rs.ExpandLayer(cate_layer, False)\r\n\r\n\r\ndef retrive_OST_material(current_layer):\r\n    global OST_MATERIAL_MAP\r\n    for ost_name in OST_MATERIAL_MAP:\r\n        if current_layer.find(ost_name) != -1:\r\n            break\r\n    else:\r\n        return None\r\n    \r\n    \r\n    \r\n    mat_id = RHINO_MATERIAL.get_material_by_name(ost_name, return_index=True)\r\n    if mat_id:\r\n        return mat_id\r\n    \r\n    material_data = OST_MATERIAL_MAP.get(ost_name, None)\r\n    if material_data is None:\r\n        return None\r\n    name = material_data.get(\"name\", \"Default\")\r\n    diffuse = material_data[\"color\"].get(\"diffuse\", (0,0,0))\r\n    R, G, B = diffuse\r\n    alpha = material_data[\"color\"].get(\"transparency\", 0)\r\n    alpha = int(alpha/100)\r\n    reflection = material_data[\"color\"].get(\"shininess\", 0)\r\n    reflection = int(255*reflection/128 )\r\n    RGBAR = (R, G, B, alpha,reflection)\r\n    \r\n    id, _ = RHINO_MATERIAL.create_material(name, RGBAR, return_index = True)\r\n    return id\r\n\r\ndef change_objs_layer_in_block(block_name, parent_layer_prefix):\r\n    block_definition = sc.doc.InstanceDefinitions.Find(block_name)\r\n    objs = block_definition.GetObjects()\r\n    change_objs_layer(objs, parent_layer_prefix)\r\n\r\n\r\n\r\n@LOG.log(__file__, __title__)\r\n@ERROR_HANDLE.try_catch_error()\r\ndef import_revit_collection():\r\n    rs.EnableRedraw(False)\r\n    unit_opts = [\"Millimeters\", \"Feet\", \"Inches\"]\r\n    units = rs.ListBox(unit_opts , \r\n                       message = \"Use which unit for the DWG?\" , \r\n                       default = unit_opts[0],\r\n                       title=\"EnneadTab Import Revit Exports\")\r\n    if units is None:\r\n        return\r\n    filenames = rs.OpenFileNames(title = \"pick dwg files to import collection\",\r\n                                filter = \"DWG exports from Revit (*.dwg)|*.dwg||\")\r\n    if not filenames:\r\n        return\r\n    \r\n    auto_opts = [\"Yes, Use Everything Default Layer Structure\", \"No, Let me pick each layer structure\"]\r\n    auto_opt = rs.ListBox(auto_opts, message = \"Use auto process option for layer structure?\", default = auto_opts[0], title=\"EnneadTab Importing Revit Export Under Rhino\")\r\n    if auto_opt is None:\r\n        return\r\n    if auto_opt == auto_opts[0]:\r\n        is_using_default = True\r\n    else:\r\n        is_using_default = False\r\n    rs.EnableRedraw(False)\r\n    \r\n    global OST_MATERIAL_MAP\r\n    OST_MATERIAL_MAP  = DATA_FILE.get_data(\"OST_MATERIAL_MAP\")\r\n    if not OST_MATERIAL_MAP:\r\n        NOTIFICATION.messenger(\"No mapping data found. Did you export setting from Revit side?\")\r\n        return\r\n    map(lambda x: process_dwg(x, units, is_using_default), filenames)\r\n    \r\n\r\n    \r\n    NOTIFICATION.duck_pop(\"All imported!\")\r\n\r\n\r\nif __name__ == \"__main__\":\r\n    import_revit_collection()",
  "language": "python",
  "imports": [
    "rhinoscriptsyntax",
    "scriptcontext"
  ],
  "has_docstring": false
}