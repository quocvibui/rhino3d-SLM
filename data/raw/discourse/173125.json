{
  "source_url": "https://discourse.mcneel.com/t/gmsh-in-grasshopper/173125",
  "topic_id": 173125,
  "title": "Gmsh in Grasshopper",
  "question": "For an exciting personal project, I’ve been exploring remeshing techniques using Grasshopper. Typically, I rely on \n@DanielPiker\n 's \nRemesh by Color\n - a fantastic component that’s been essential to my workflow (see an example \nhere\n). However, for this project, I decided to look beyond the usual and integrate \nGmsh\n, a popular finite element mesh generator, into Grasshopper. Surprisingly, incorporating Gmsh was a smooth process, thanks to the new Python script which now supports Python 3. Here’s my code. It’s quite basic and there’s room for improvement. The key part is converting a Gmsh mesh into a Rhino mesh.\n\n\n#r: gmsh\n\nimport gmsh\nimport Rhino.Geometry as rg\nimport numpy as np\n\ngmsh.initialize()\n\ngmsh.clear()\ngmsh.option.setNumber(\"Mesh.CharacteristicLengthMin\", length.Min)\ngmsh.option.setNumber(\"Mesh.CharacteristicLengthMax\", length.Max)\n\n\ndef create_loop(pts):\n    p_tags = [gmsh.model.geo.add_point(p.X, p.Y, 0.0, p.Z+0.01) for p in pts]\n    p_tags.append(p_tags[0])\n    l_tags = [gmsh.model.geo.add_line(pt1, pt2) for pt1, pt2 in zip(p_tags, p_tags[1:])]\n    return gmsh.model.geo.add_curve_loop(l_tags)\n\n\nloops = [create_loop(outer)]\nloops.extend(create_loop(inner) for inner in inners.Branches)\nplane_surface = gmsh.model.geo.add_plane_surface(loops)\n\nif nodes != None:\n    p_tags = [gmsh.model.geo.add_point(n.X, n.Y, n.Z) for n in nodes]\n    field = gmsh.model.mesh.field.add(\"Distance\")\n    gmsh.model.mesh.field.setNumbers(field, \"PointsList\", p_tags)\n    threshold_field = gmsh.model.mesh.field.add(\"Threshold\")\n    gmsh.model.mesh.field.setNumber(threshold_field, \"IField\", field)\n    gmsh.model.mesh.field.setNumber(threshold_field, \"LcMin\", length.Min / 50)\n    gmsh.model.mesh.field.setNumber(threshold_field, \"LcMax\", length.Max * 2)\n    gmsh.model.mesh.field.setNumber(threshold_field, \"DistMin\", length.Min * 2)\n    gmsh.model.mesh.field.setNumber(\n        threshold_field, \"DistMax\", length.Min * 10 + length.Max * 10\n    )\n    gmsh.model.mesh.field.setAsBackgrou...",
  "code_blocks": [
    {
      "code": "using Rhino;\nusing Rhino.Geometry;\nusing System.Collections.Generic;\nusing System.Linq;\nusing GmshNet; // If using Gmsh.Net\n\nvoid RunScript(List<Point3d> outer, List<List<Point3d>> inners, double lengthMin, double lengthMax, \n               bool quad, List<Mesh> nodes, ref object A)\n{\n    // 1. Initialize Gmsh\n    Gmsh.Initialize();\n    Gmsh.Clear();\n\n    // 2. Set mesh properties\n    Gmsh.Option.SetNumber(\"Mesh.CharacteristicLengthMin\", lengthMin);\n    Gmsh.Option.SetNumber(\"Mesh.CharacteristicLengthMax\", lengthMax);\n\n    // 3. Geometry definition\n    int CreateLoop(List<Point3d> pts)\n    {\n        List<int> pointTags = pts.Select(\n            p => Gmsh.Model.Geo.AddPoint(p.X, p.Y, p.Z, lengthMin)).ToList();\n        pointTags.Add(pointTags[0]);\n\n        List<int> lineTags = new List<int>();\n        for (int i = 0; i < pointTags.Count - 1; i++)\n        {\n            lineTags.Add(Gmsh.Model.Geo.AddLine(pointTags[i], pointTags[i + 1]));\n        }\n\n        return Gmsh.Model.Geo.AddCurveLoop(lineTags.ToArray());\n    }\n\n    var outerLoop = CreateLoop(outer);\n\n    List<int> loops = new List<int> { outerLoop };\n    foreach (var inner in inners)\n    {\n        loops.Add(CreateLoop(inner));\n    }\n\n    int planeSurface = Gmsh.Model.Geo.AddPlaneSurface(loops.ToArray());\n\n    // 4. Configure meshing field (if target nodes are provided)\n    if (nodes != null && nodes.Count > 0)\n    {\n        var pointTags = nodes.Select(node => Gmsh.Model.Geo.AddPoint(node.Vertices[0].X, \n                                                                     node.Vertices[0].Y, \n                                                                     node.Vertices[0].Z)).ToList();\n\n        int field = Gmsh.Model.Mesh.Field.Add(\"Distance\");\n        Gmsh.Model.Mesh.Field.SetNumbers(field, \"PointsList\", pointTags);\n\n        int thresholdField = Gmsh.Model.Mesh.Field.Add(\"Threshold\");\n        Gmsh.Model.Mesh.Field.SetNumber(thresholdField, \"IField\", field);\n        Gmsh.Model.Mesh.Field.SetNumber(thresholdField, \"LcMin\", lengthMin / 50);\n        Gmsh.Model.Mesh.Field.SetNumber(thresholdField, \"LcMax\", lengthMax * 2);\n        Gmsh.Model.Mesh.Field.SetNumber(thresholdField, \"DistMin\", lengthMin * 2);\n        Gmsh.Model.Mesh.Field.SetNumber(thresholdField, \"DistMax\", lengthMin * 10 + lengthMax * 10);\n\n        Gmsh.Model.Mesh.Field.SetAsBackgroundMesh(thresholdField);\n    }\n\n    // 5. Enable quadrangular meshing if specified\n    if (quad)\n    {\n        Gmsh.Model.Mesh.Recombine(2, planeSurface);\n    }\n\n    Gmsh.Model.Geo.Synchronize();\n\n    // 6. Generate the mesh\n    Gmsh.Model.Mesh.Generate(2);\n\n    // 7. Extract mesh nodes and connectivity\n    var nodesArray = Gmsh.Model.Mesh.GetNodes();\n    var coords = nodesArray.Item2;\n\n    var elements = Gmsh.Model.Mesh.GetElements();\n    var elementNodes = elements.Item3[0];\n\n    // Convert data to a Rhino.Geometry.Mesh\n    Mesh mesh = new Mesh();\n    for (int i = 0; i < coords.Length; i += 3)\n    {\n        mesh.Vertices.Add(coords[i], coords[i + 1], coords[i + 2]);\n    }\n\n    int faceSize = quad ? 4 : 3;\n    for (int i = 0; i < elementNodes.Length; i += faceSize)\n    {\n        if (quad)\n        {\n            mesh.Faces.AddFace((int)elementNodes[i] - 1, (int)elementNodes[i + 1] - 1,\n                               (int)elementNodes[i + 2] - 1, (int)elementNodes[i + 3] - 1);\n        }\n        else\n        {\n            mesh.Faces.AddFace((int)elementNodes[i] - 1, (int)elementNodes[i + 1] - 1,\n                               (int)elementNodes[i + 2] - 1);\n        }\n    }\n    mesh.RebuildNormals();\n    mesh.Compact();\n\n    // 8. Output the mesh to Grasshopper\n    A = mesh;\n\n    // Finalize Gmsh\n    Gmsh.Finalize();\n}",
      "language": "csharp",
      "author": "Rh-3d-p",
      "post_number": 29,
      "is_solution": false
    },
    {
      "code": "#r: gmsh\n\nimport gmsh\nimport Rhino.Geometry as rg\nimport numpy as np\n\ngmsh.initialize()\n\ngmsh.clear()\ngmsh.option.setNumber(\"Mesh.CharacteristicLengthMin\", length.Min)\ngmsh.option.setNumber(\"Mesh.CharacteristicLengthMax\", length.Max)\n\n\ndef create_loop(pts):\n    p_tags = [gmsh.model.geo.add_point(p.X, p.Y, 0.0, p.Z+0.01) for p in pts]\n    p_tags.append(p_tags[0])\n    l_tags = [gmsh.model.geo.add_line(pt1, pt2) for pt1, pt2 in zip(p_tags, p_tags[1:])]\n    return gmsh.model.geo.add_curve_loop(l_tags)\n\n\nloops = [create_loop(outer)]\nloops.extend(create_loop(inner) for inner in inners.Branches)\nplane_surface = gmsh.model.geo.add_plane_surface(loops)\n\nif nodes != None:\n    p_tags = [gmsh.model.geo.add_point(n.X, n.Y, n.Z) for n in nodes]\n    field = gmsh.model.mesh.field.add(\"Distance\")\n    gmsh.model.mesh.field.setNumbers(field, \"PointsList\", p_tags)\n    threshold_field = gmsh.model.mesh.field.add(\"Threshold\")\n    gmsh.model.mesh.field.setNumber(threshold_field, \"IField\", field)\n    gmsh.model.mesh.field.setNumber(threshold_field, \"LcMin\", length.Min / 50)\n    gmsh.model.mesh.field.setNumber(threshold_field, \"LcMax\", length.Max * 2)\n    gmsh.model.mesh.field.setNumber(threshold_field, \"DistMin\", length.Min * 2)\n    gmsh.model.mesh.field.setNumber(\n        threshold_field, \"DistMax\", length.Min * 10 + length.Max * 10\n    )\n    gmsh.model.mesh.field.setAsBackgroundMesh(threshold_field)\n    \nif quad:\n    gmsh.model.geo.mesh.setRecombine(2, 1)\ngmsh.model.geo.synchronize()\ngmsh.model.mesh.generate(2)  # 2 for 2D mesh\n\n\ncoords = np.array(gmsh.model.mesh.getNodes()[1]).reshape(-1, 3)\nfaces = np.array((gmsh.model.mesh.getElements()[2][1]) - 1).reshape(\n    -1, 4 if quad else 3\n)\ngmsh.finalize()\n\nmesh = rg.Mesh()\nfor point in coords:\n    mesh.Vertices.Add(*point)\nfor face in faces:\n    mesh.Faces.AddFace(*[int(v) for v in face])\nmesh.RebuildNormals()\nmesh.Compact()\na = mesh",
      "language": "python",
      "author": "Mahdiyar",
      "post_number": 1,
      "is_solution": false
    }
  ],
  "tags": [
    "csharp",
    "file-io",
    "geometry",
    "grasshopper",
    "mesh",
    "python",
    "rhinocommon"
  ],
  "has_accepted_answer": false,
  "category_id": 2,
  "posts_count": 31,
  "views": 3848
}