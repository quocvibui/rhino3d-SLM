{
  "source_url": "https://github.com/armankhalilbeigi/SimpleTCPSocketConnection/blob/09d8e6d56c26169b9226b6e0d11586e0b1e4c667/Connector.py",
  "repo": "armankhalilbeigi/SimpleTCPSocketConnection",
  "repo_stars": 0,
  "repo_description": "a simple connection created for McNeel's Grasshopper3D",
  "license": "unknown",
  "filepath": "Connector.py",
  "instruction": "Connector",
  "code": "from ghpythonlib.componentbase import executingcomponent as component\nimport GhPython\nimport Grasshopper\nimport Grasshopper as gh\nimport System\nimport Rhino\nimport rhinoscriptsyntax as rs\nimport threading\nimport System.Net as net\nimport time\nimport System.Drawing as sd\n\n\nclass Test:\n    def __init__(self, ip, port, Timeout, comp ,as_server=True):\n        self.compon = comp\n        self.client = None\n        self.socket_stream = None\n        self.received_msg = \"Streaming Started ...\"\n        self.try_connect = True\n        self.receive_thread = None\n        self.receiver_list = []\n        self.kill_thread = False\n        self.myip = net.IPAddress.Parse(str(ip))\n        self.port = port\n        self.rmsg = None #to Print Msgs in Log output\n        self.timeout = Timeout\n        self.msghistory = []\n        if as_server:\n            self.server = net.Sockets.TcpListener(self.myip, int(self.port))\n            self.connection_thread = threading.Thread(target=self.connect_as_server, args =(lambda : self.kill_thread, ))\n            self.rmsg = \"111111111111111111\" #to Print Msgs in Log output\n        else:\n            self.client = net.Sockets.TcpClient()\n            self.connection_thread = threading.Thread(target=self.connect_as_client)\n        self.connection_thread.daemon = True\n    \n    def __delete__(self):\n        self.clean_up()\n    \n    def clean_up(self):\n        self.rmsg =  \"Cleaning up and restarting\".center(100, '=')\n        if self.socket_stream:\n            try:\n                self.socket_stream.Close()\n            except Exception as e:\n                print e\n        if self.client:\n            try:\n                self.client.Dispose()\n            except Exception as e:\n                print e\n        else:\n            try:\n                self.server.Stop()\n            except Exception as e:\n                print e\n        \n        self.received_msg = \"Beginning of the Stream \"\n        self.receiver_list = []\n        self.kill_thread = True\n        self.server = None\n        self.con = None\n        self.socket_stream = None\n        self.connection_thread = None\n        self.receive_thread = None\n        self.try_connect = True\n        \n        self.log()\n    \n    def connect(self):\n        if not self.try_connect:\n            return\n\n        self.rmsg =  \"Starting Listener Thread\".center(10, '=') # Not Running\n        \n        if not self.connection_thread.is_alive() :\n            self.rmsg =  \"Starting Server\".center(10, '=')\n            try:\n                self.connection_thread.start()\n            except Exception as e:\n                self.rmsg =  \"Couldn't start the thread ! > \", e\n        else:\n            self.rmsg =  \"Thread is already running\".center(100, '-')\n        self.log()\n    \n    def connect_as_client(self):\n        self.rmsg =  \"$>\\tAttempting to Connect . . .\"\n        ipep = net.IPEndPoint(self.myip, self.port)\n        self.client.Connect(ipep)\n        self.socket_stream = self.client.GetStream()\n        self.socket_stream.ReadTimeout = int(self.timeout)\n        self.compon.ExpireSolution(True)\n    \n    def connect_as_server(self, kill_flag):\n        self.rmsg =  \"$>\\tStarting to Connect . . .\"\n        try:\n            self.server.Start()\n            self.rmsg =  \"$>\\tListening . . .\"\n            while not kill_flag():\n                if self.server.Pending():\n                    self.rmsg =  \"$>\\tPending Connection Detected\"\n                    self.client = self.server.AcceptTcpClient()\n                    self.socket_stream = self.client.GetStream()\n                    self.socket_stream.ReadTimeout = int(self.timeout)   ##Timeout\n                    break\n        except Exception as e:\n            self.rmsg =  \"$>\\tFailed to connect >>> \", e     #Mention to User to try to Set server Off and On \n        finally:\n            if self.server:\n                self.server.Stop()\n            self.try_connect = False\n            self.compon.ExpireSolution(True)\n    \n    def receiver_thread_start(self):\n        if not self.receive_thread:\n            self.receive_thread = threading.Thread(target=self.receive_message, args =(lambda : self.receiver_list, lambda : self.kill_thread, ))\n            self.receive_thread.daemon = True\n            self.receive_thread.start()\n    \n    def receive_message(self, comps, kill_flag):\n        tempmsg = \"\"\n        while not kill_flag():\n            try:\n                c = chr(self.socket_stream.ReadByte())\n                tempmsg += c\n                if c == '&':\n                    self.received_msg = tempmsg\n                    self.msghistory.append(tempmsg[:-1])\n                    tempmsg = \"\"\n                    for comp in comps():\n                        comp.ExpireSolution(True)\n            except:\n                self.received_msg = \"Server: Client was inactive for too long  or ended connection: Thread Stopped..\"\n                for comp in comps():\n                    comp.ExpireSolution(True)\n                break\n    \n    def log(self):\n        return \"###Report###\", \"\\tIPENDP > \", self.myip, \"\\tCLIENT > \", self.client, \"\\tSTREAM > \", self.socket_stream, self.rmsg\n\nclass MyComponent(component):\n    Reset = False\n    \n    def RunScript(self, IP, port, run_server, server_mode, Reset, TimeOut):\n        \"\"\"Provides a scripting component.\n            Inputs:\n                x: The x script variable\n                y: The y script variable\n            Output:\n                a: The a output variable\"\"\"\n        \n        __author__ = \"Arman Khalilbeigi\"\n        __version__ = \"2022.06.15\"\n        \n        if TimeOut == None:\n            TimeOut = 1000000\n        if Reset == None:\n            Reset = False\n        if IP == None:\n            IP = '127.0.0.1'\n        \n#        try:\n#            self.tcp_server = Test(IP, port, TimeOut, ghenv.Component, server_mode)\n#        except:\n#            self.Message = 'UnkownError: Cannot Create Tcp Server!'\n        if (not run_server) or (not self.tcp_server):\n            self.tcp_server = Test(IP, port, TimeOut, self, server_mode)\n            self.Message = \"Stopped\"\n            self.tcp_server.log()\n            return\n        \n        if not (self.tcp_server.client and self.tcp_server.socket_stream):\n            self.tcp_server.connect()\n            self.Message = \"Waiting\" if server_mode else \"Connecting\"\n        else:\n            self.tcp_server.receiver_thread_start()\n            self.Message = \"Receiving\"\n            self.tcp_server.rmsg =  \"Connection Exists\".center(100, '-')\n\n        ConData = self.tcp_server\n        Log = self.tcp_server.log()\n        \n        if Reset and run_server == False :\n            try:\n                self.tcp_server.clean_up()\n                return\n            except:\n                pass\n        return (Log, ConData )\n\n",
  "language": "python",
  "imports": [
    "Rhino",
    "ghpythonlib",
    "rhinoscriptsyntax"
  ],
  "has_docstring": false
}