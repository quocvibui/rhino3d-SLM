{
  "source_url": "https://github.com/gramaziokohler/aixd_ara/blob/46c58cfb099ed5c59bb6cc7a85bda33a11293159/src/aixd_ara/components/ara_Server/code.py",
  "repo": "gramaziokohler/aixd_ara",
  "repo_stars": 9,
  "repo_description": "ARA: Grasshopper plugin for AIXD toolkit",
  "license": "MIT",
  "filepath": "src/aixd_ara/components/ara_Server/code.py",
  "instruction": null,
  "code": "from __future__ import absolute_import\nfrom __future__ import division\nfrom __future__ import print_function\n\nimport urllib2\n\nimport compas\nimport compas._os\nfrom ghpythonlib.componentbase import executingcomponent as component\nfrom scriptcontext import sticky as st\n\nfrom aixd_ara.constants import DEFAULT_PORT\n\ntry:\n    from subprocess import PIPE\n    from subprocess import Popen\nexcept ImportError:\n    from System.Diagnostics import Process\n\nimport os\n\nimport aixd_ara as ag\n\n\nclass ApiRunner(object):\n    def __init__(\n        self,\n        package=None,\n        python=None,\n        url=\"http://127.0.0.1\",\n        port=DEFAULT_PORT,\n        service=None,\n        max_conn_attempts=100,\n        autoreload=True,\n        show_window=False,\n        path=None,\n        working_directory=None,\n    ):\n        self.python = compas._os.select_python(python)\n        self.service = \"aixd_ara.api\"\n        self.working_directory = working_directory\n        self.show_window = show_window\n        self.port = port\n\n        self.start_process()\n\n    def start_process(self):\n        env = compas._os.prepare_environment()\n\n        try:\n            Popen\n        except NameError:\n            self._process = Process()\n            for name in env:\n                if self._process.StartInfo.EnvironmentVariables.ContainsKey(name):\n                    self._process.StartInfo.EnvironmentVariables[name] = env[name]\n                else:\n                    self._process.StartInfo.EnvironmentVariables.Add(name, env[name])\n            self._process.StartInfo.UseShellExecute = True\n            self._process.StartInfo.RedirectStandardOutput = not self.show_window\n            self._process.StartInfo.RedirectStandardError = not self.show_window\n            self._process.StartInfo.FileName = self.python\n            self._process.StartInfo.Arguments = \"-m {0} {1}\".format(self.service, self.port)\n            self._process.Start()\n        else:\n            args = [self.python, \"-m\", self.service, str(self.port)]\n            kwargs = dict(env=env)\n\n            if self.show_window:\n                if compas.is_mono():\n                    python_command = \" \".join(args)\n                    apple_script = \"\"\"\n                    tell application \"Terminal\"\n                        do script \"{}\"\n                        activate\n                    end tell\n                    \"\"\".format(\n                        python_command\n                    )\n                    args = [\"osascript\", \"-e\", apple_script]\n            else:\n                kwargs[\"stdout\"] = PIPE\n                kwargs[\"stderr\"] = PIPE\n\n            if self.working_directory:\n                kwargs[\"cwd\"] = self.working_directory\n            self._process = Popen(args, **kwargs)\n\n    def stop_process(self):\n        \"\"\"Attempts to terminate the python process hosting the proxy server.\n\n        The process reference might not be present, e.g. in the case\n        of reusing an existing connection. In that case, this is a no-op.\n        \"\"\"\n        print(\"Stopping the server process.\")\n\n        if not self._process:\n            return\n\n        try:\n            self._process.terminate()\n        except Exception:\n            pass\n        try:\n            self._process.kill()\n        except Exception:\n            pass\n\n\napi_path = os.path.dirname(ag.__file__)\n\nprint(api_path)\n\n\ndef create_api_runner_id(component):\n    name = \"api-runner\"\n    return \"{}_{}\".format(name, component.InstanceGuid)\n\n\nclass ApiRunnerComponent(component):\n\n    def RunScript(self, start, stop, show_window=True):\n        key = create_api_runner_id(self)\n        port = DEFAULT_PORT\n\n        if show_window:\n            python = \"python\"\n        else:\n            python = \"pythonw\"\n\n        if start:\n            self.stop(key)\n            runner = ApiRunner(python=python, port=port, show_window=show_window, working_directory=api_path)\n            st[key] = runner\n\n        if stop:\n            self.stop(key)\n\n    def stop(self, key):\n        # Attempt gracefully stopping the server\n        try:\n            urllib2.urlopen(\"http://127.0.0.1:8765/shutdown\", timeout=1)\n        except Exception:\n            pass\n\n        # stop previous API runner if any\n        previous_api_runner = st.get(key)\n        if previous_api_runner:\n            try:\n                previous_api_runner.stop_process()\n            except Exception as e:\n                print(\"Unable to stop previous process\")\n                print(e)\n            st.pop(key)\n        else:\n            print(\"No previous process runner found\")\n",
  "language": "python",
  "imports": [
    "ghpythonlib",
    "scriptcontext"
  ],
  "has_docstring": false
}