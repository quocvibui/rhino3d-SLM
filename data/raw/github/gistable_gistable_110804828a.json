{
  "source_url": "https://github.com/gistable/gistable/blob/665d39a2bd82543d5196555f0801ef8fd4a3ee48/all-gists/b4afaf9648ec986928a9/snippet.py",
  "repo": "gistable/gistable",
  "repo_stars": 75,
  "repo_description": "GitHub gists and the dockerfiles needed to run them.",
  "license": "MIT",
  "filepath": "all-gists/b4afaf9648ec986928a9/snippet.py",
  "instruction": "Snippet",
  "code": "#!/usr/bin/env python3\n# -*- coding: utf-8 -*-\n\nimport uno\nfrom com.sun.star.beans import PropertyValue\nfrom pythonscript import ScriptContext\nimport os\nimport sys\nimport time\n\nclass UnoConnector():\n    \"\"\"\n    Libre Office Runtime Connector\n    It is assumed libreoffice is run like this from a shell:\n        libreoffice \"--accept=socket,host=localhost,port=2002;urp;\" ./test1.ods &\n        or\n        libreoffice \"--accept=pipe,name=some_name;urp;StarOffice.Servicemanager\" ./test1.ods &\n    \"\"\"\n\n    def __init__(self, docName = \"_blank\", pipeName = None, host = None, port = None, loIsRunning = False, headless = \"\"):\n        if pipeName == None and port == None:\n            raise Exception(\"Must specify either port or pipe\")\n        if pipeName != None and port != None:\n            raise Exception(\"Must specify either port or pipe, not both\")\n        self.headless = headless\n        self.docName = docName\n        self.port = port\n        self.pipeName = pipeName\n        if self.port != None:\n            if host == None:\n                self.host = \"localhost\"\n            else:\n                self.host = host\n            self.loLaunch = \"\"\" libreoffice --accept=\"socket,host=%s,port=%s;urp;\" --norestore --nologo --nodefault %s %s &\"\"\" % (self.host, self.port, self.headless, [self.docName, \"\"][self.docName == '_blank'])\n            self.resolveStr = \"uno:socket,host=%s,port=%s;urp;StarOffice.ComponentContext\" % (self.host, self.port)\n        else:\n            self.host = None\n            self.loLaunch = \"\"\" libreoffice --accept=\"pipe,name=%s;urp;StarOffice.Servicemanager\" --norestore --nologo --nodefault %s %s &\"\"\" % (self.pipeName, self.headless, [self.docName, \"\"][self.docName == '_blank'])\n            self.resolveStr = \"uno:pipe,name=%s;urp;StarOffice.ComponentContext\" % (self.pipeName)\n        if not loIsRunning:\n            if self.launch_lo() == 0:\n                self.connect_to_office()\n            else:\n                print(\"Error launching LibreOffice\")\n        else:\n            self.connect_to_office()\n\n    def launch_lo(self):\n        result = os.system(self.loLaunch)\n        time.sleep(1)\n        return result\n\n    def connect_to_office(self):\n        self.localContext = uno.getComponentContext()\n        self.resolver = self.localContext.ServiceManager.createInstanceWithContext('com.sun.star.bridge.UnoUrlResolver', self.localContext)\n        #self.client = self.resolver.resolve(\"uno:pipe,name=some_name;urp;StarOffice.ComponentContext\")\n        self.client = None\n        for n in range(1, 61):\n            try:\n                print(\"Connectiong client, attemp No %d\" % (n,))\n                self.client = self.resolver.resolve(self.resolveStr)\n                break\n            except:\n                time.sleep(1)\n        if self.client:    \n            self.scriptContext = ScriptContext(self.client, None, None)\n            self.desktop = self.scriptContext.getDesktop()\n            if self.docName == '_blank':\n                self.newDoc()\n            return self.doc\n        else:\n            self.scriptContext = None\n            self.desktop = None\n            self.doc = None\n            return None\n    \n    def newDoc(self, doctype = \"calc\"):\n        self.desktop.loadComponentFromURL(\"private:factory/s%s\" % (doctype,), \"_blank\", 0, ())\n        self.doc = None\n        for n in range(1, 61):\n            print(\"Trying to load default document, attemp No %d\" % (n,))\n            self.doc = self.scriptContext.getDocument()\n            if self.doc != None:\n                break\n            else:\n                time.sleep(1)\n    \n    def saveAs(self, newName, excelFormat = False):\n        if not self.doc:\n            return None\n        else:\n            self.docName = newName\n            pv = ()\n            if excelFormat:\n                pv = (PropertyValue(\"FilterName\", 0, \"MS Excel 97\", 0),)\n            self.doc.storeAsURL(\"file://%s%s%s\" % (os.getcwd(), os.path.sep, self.docName), pv)\n            return self.doc\n    \n    def save(self):\n        if not self.doc:\n            return None\n        else:\n            if self.docName == \"_blank\":\n                print(\"File must have a name in order to be saved. Use 'saveAs'first\")\n                return None\n            else:\n                self.doc.store()\n                return self.doc\n\n    def exportPDF(self, newName):\n        if not self.doc:\n            return None\n        else:\n            pv = (PropertyValue(\"FilterName\", 0, \"writer_pdf_Export\", 0),)\n            self.doc.storeToURL(\"file://%s%s%s.pdf\" % (os.getcwd(), os.path.sep, newName.replace('.pdf', '')), pv)\n        return self.doc\n    \n\n\n                                              \n\n",
  "language": "python",
  "imports": [],
  "has_docstring": false
}