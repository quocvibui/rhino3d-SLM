{
  "source_url": "https://github.com/fuchsst/doc2podcast/blob/dcc1e99a210ae24c6fe04b704db2c14aa271c820/src/generators/script_generator.py",
  "repo": "fuchsst/doc2podcast",
  "repo_stars": 1,
  "repo_description": null,
  "license": "unknown",
  "filepath": "src/generators/script_generator.py",
  "instruction": "Script generation module using CrewAI agents",
  "code": "\"\"\"Script generation module using CrewAI agents\"\"\"\nfrom typing import Dict, Any, Optional, List\nfrom dataclasses import dataclass\n\nfrom ..config import PromptManager, Settings\nfrom ..models.podcast_script import (\n    PodcastScript,\n    PodcastMetadata,\n    Speaker,\n    ScriptSegment,\n    VoiceParameters,\n    Reference\n)\nfrom ..utils.callback_handler import PipelineCallback, StepType, ProgressUpdate\nfrom ..utils.cache_manager import cache_manager\nfrom .base import ScriptContext, ScriptGenerator, ResultsFormatter\nfrom .content_strategy_tool import ContentStrategyTool\nfrom .script_writing_tool import ScriptWritingTool\nfrom .quality_control_tool import QualityControlTool\n\n\n@dataclass\nclass ScriptGenerationConfig:\n    \"\"\"Configuration for script generation\"\"\"\n    podcast_preset: str\n    target_audience: str\n    expertise_level: str\n    guidance_prompt: Optional[str] = None\n\nclass PodcastScriptGenerator(ScriptGenerator, ResultsFormatter):\n    \"\"\"Generates podcast scripts using CrewAI agents\"\"\"\n    \n    def __init__(self, settings: Settings, callback: Optional[PipelineCallback] = None):\n        super().__init__(settings, callback)\n        self.prompt_manager = PromptManager(settings)\n        \n        # Initialize LLM\n        self.llm = settings.get_llm()\n        \n        # Initialize tools with callback\n        self.content_tool = ContentStrategyTool(\n            name=\"Content Strategy Tool\",\n            description=\"Creates podcast content strategy with episode structure, key points, transitions, and audience adaptations\",\n            llm=self.llm,\n            callback=callback\n        )\n        self.script_tool = ScriptWritingTool(\n            name=\"Script Writing Tool\",\n            description=\"Creates podcast script from content strategy with proper structure and flow\",\n            llm=self.llm,\n            callback=callback\n        )\n        self.quality_tool = QualityControlTool(\n            name=\"Quality Control Tool\",\n            description=\"Reviews and improves script for content accuracy, flow, and audience fit\",\n            llm=self.llm,\n            callback=callback\n        )\n        \n    def generate(self, content: Dict[str, Any], *args, **kwargs) -> Dict[str, Any]:\n        \"\"\"Implement abstract generate method from Generator base class\"\"\"\n        config = kwargs.get('config', ScriptGenerationConfig(\n            podcast_preset=kwargs.get('podcast_preset', 'default'),\n            target_audience=kwargs.get('target_audience', 'general'),\n            expertise_level=kwargs.get('expertise_level', 'beginner'),\n            guidance_prompt=kwargs.get('guidance_prompt')\n        ))\n        return self.generate_script(content, config)\n        \n    def generate_content_strategy(\n        self,\n        content: Dict[str, Any],\n        config: Optional[ScriptGenerationConfig] = None\n    ) -> Dict[str, Any]:\n        \"\"\"Generate content strategy\"\"\"\n        try:\n            # Check cache first\n            cache_key = cache_manager.get_content_hash(str(content))\n            cached_result = cache_manager.load_json_cache(cache_key, \"content_strategy\")\n            if cached_result:\n                return cached_result\n                \n            # Get format configuration\n            format_config = self.prompt_manager.get_interview_prompt(config.podcast_preset)\n            \n            # Get audience and expertise configurations\n            audiences = self.prompt_manager.get_target_audiences(config.podcast_preset)\n            audience = next(a for a in audiences if a.name == config.target_audience)\n            \n            expertise_levels = self.prompt_manager.get_expertise_levels(config.podcast_preset)\n            expertise = next(l for l in expertise_levels if l.name == config.expertise_level)\n            \n            # Create script context\n            context = ScriptContext(\n                content=content,\n                format=format_config.model_dump(),\n                audience=audience.model_dump(),\n                expertise=expertise.model_dump(),\n                guidance=config.guidance_prompt\n            )\n            \n            # Generate content strategy\n            result = self.content_tool.analyze(context)\n            \n            # Cache result\n            cache_manager.cache_json(cache_key, \"content_strategy\", result)\n            \n            return result\n                \n        except Exception as e:\n            raise RuntimeError(f\"Failed to generate content strategy: {str(e)}\")\n            \n    def write_script(\n        self,\n        content: Dict[str, Any],\n        strategy: Dict[str, Any],\n        config: Optional[ScriptGenerationConfig] = None\n    ) -> Dict[str, Any]:\n        \"\"\"Write podcast script\"\"\"\n        try:\n            # Check cache first\n            cache_key = cache_manager.get_content_hash(str(content) + str(strategy))\n            cached_result = cache_manager.load_json_cache(cache_key, \"script_writing\")\n            if cached_result:\n                return cached_result\n                \n            # Get format configuration\n            format_config = self.prompt_manager.get_interview_prompt(config.podcast_preset)\n            \n            # Get audience and expertise configurations\n            audiences = self.prompt_manager.get_target_audiences(config.podcast_preset)\n            audience = next(a for a in audiences if a.name == config.target_audience)\n            \n            expertise_levels = self.prompt_manager.get_expertise_levels(config.podcast_preset)\n            expertise = next(l for l in expertise_levels if l.name == config.expertise_level)\n            \n            # Create script context with strategy as content\n            context = ScriptContext(\n                content=strategy,\n                format=format_config.model_dump(),\n                audience=audience.model_dump(),\n                expertise=expertise.model_dump(),\n                guidance=config.guidance_prompt\n            )\n            \n            # Write script\n            result = self.script_tool.analyze(context)\n            \n            # Cache result\n            cache_manager.cache_json(cache_key, \"script_writing\", result)\n            \n            return result\n                \n        except Exception as e:\n            raise RuntimeError(f\"Failed to write script: {str(e)}\")\n            \n    def review_script_quality(\n        self,\n        script: Dict[str, Any],\n        config: Optional[ScriptGenerationConfig] = None\n    ) -> Dict[str, Any]:\n        \"\"\"Review script quality\"\"\"\n        try:\n            # Check cache first\n            cache_key = cache_manager.get_content_hash(str(script))\n            cached_result = cache_manager.load_json_cache(cache_key, \"quality_control\")\n            if cached_result:\n                return cached_result\n                \n            # Get format configuration\n            format_config = self.prompt_manager.get_interview_prompt(config.podcast_preset)\n            \n            # Get audience and expertise configurations\n            audiences = self.prompt_manager.get_target_audiences(config.podcast_preset)\n            audience = next(a for a in audiences if a.name == config.target_audience)\n            \n            expertise_levels = self.prompt_manager.get_expertise_levels(config.podcast_preset)\n            expertise = next(l for l in expertise_levels if l.name == config.expertise_level)\n            \n            # Create script context\n            context = ScriptContext(\n                content=script,\n                format=format_config.model_dump(),\n                audience=audience.model_dump(),\n                expertise=expertise.model_dump(),\n                guidance=config.guidance_prompt\n            )\n            \n            # Review script\n            result = self.quality_tool.analyze(context)\n            \n            # Cache result\n            cache_manager.cache_json(cache_key, \"quality_control\", result)\n            \n            return result\n                \n        except Exception as e:\n            raise RuntimeError(f\"Failed to review script quality: {str(e)}\")\n                        \n    def generate_script(\n        self,\n        content: Dict[str, Any],\n        config: ScriptGenerationConfig\n    ) -> PodcastScript:\n        \"\"\"Generate complete podcast script\"\"\"\n        try:\n            if self.callback:\n                self.callback.on_step_start(StepType.SCRIPT_GENERATION, \"Starting script generation\")\n            \n            # Check cache first\n            cache_key = cache_manager.get_content_hash(str(content))\n            cached_result = cache_manager.load_json_cache(cache_key, \"complete_script\")\n            if cached_result:\n                return PodcastScript(**cached_result)\n            \n            # Step 1: Generate content strategy\n            strategy = self.generate_content_strategy(content, config)\n            \n            # Step 2: Write script\n            script = self.write_script(content, strategy, config)\n            \n            # Step 3: Review script quality\n            reviewed = self.review_script_quality(script, config)\n            \n            # Format results\n            results = [strategy, script, reviewed]\n            \n            # Convert to PodcastScript object with neutral placeholder speakers\n            script = PodcastScript(\n                metadata=PodcastMetadata(\n                    title=script.get(\"metadata\", {}).get(\"title\", \"Untitled Podcast\"),\n                    description=script.get(\"metadata\", {}).get(\"description\"),\n                    source_document=content.get(\"source\", {}).get(\"path\"),\n                    tags=script.get(\"metadata\", {}).get(\"tags\", []),\n                    duration=None  # Will be set during audio generation\n                ),\n                segments=[\n                    ScriptSegment(\n                        speaker=Speaker(\n                            name=segment[\"speaker\"],\n                            voice_model=None,  # Will be set during voice configuration\n                            voice_preset=None,  # Will be set during voice configuration\n                            style_tags=[],  # Will be set during voice configuration\n                            voice_parameters=VoiceParameters(\n                                pace=1.0,\n                                pitch=1.0,\n                                energy=0.5,\n                                emotion=\"neutral\",\n                                variation=0.5\n                            ),\n                            reference=None\n                        ),\n                        text=segment[\"text\"],\n                        duration=None,  # Will be set during audio generation\n                        audio_path=None  # Will be set during audio generation\n                    )\n                    for segment in script[\"segments\"]\n                ],\n                settings={\n                    \"format\": config.podcast_preset,\n                    \"target_audience\": config.target_audience,\n                    \"expertise_level\": config.expertise_level,\n                    \"quality_metrics\": reviewed.get(\"quality_metrics\", {}),\n                    \"improvements\": reviewed.get(\"improvements\", []),\n                    \"recommendations\": reviewed.get(\"recommendations\", {})\n                }\n            )\n            \n            # Cache the complete script\n            cache_manager.cache_json(cache_key, \"complete_script\", script.model_dump())\n            \n            if self.callback:\n                self.callback.on_step_complete(StepType.SCRIPT_GENERATION, \"Script generation completed successfully\")\n            \n            return script\n            \n        except Exception as e:\n            error = f\"Script generation failed: {str(e)}\"\n            if self.callback:\n                self.callback.on_error(StepType.SCRIPT_GENERATION, error)\n            raise RuntimeError(error)\n",
  "language": "python",
  "imports": [],
  "has_docstring": true
}