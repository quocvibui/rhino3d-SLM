{
  "source_url": "https://github.com/localcode/localcode/blob/3089aee227d257adc856021a4e1eb678d9527f50/make2d.py",
  "repo": "localcode/localcode",
  "repo_stars": 4,
  "repo_description": "Code repository for the local code project",
  "license": "unknown",
  "filepath": "make2d.py",
  "instruction": "Make2d",
  "code": "import os\nimport shelve\nimport Rhino\nimport cPickle as pickle\nfrom rhinopythonscripts import LayerTools, FileTools\nfrom rhinopythonscripts.GeomTools import bakeMany\nimport System\nfrom scriptcontext import doc\nfrom System.Drawing import Rectangle\nimport rhinoscriptsyntax as rs\n\ndef rcmd(commandstring, echo=True, mask=True):\n    if mask:\n        premask = '-_%s '\n        try:\n            cmd = premask % commandstring\n        except:\n            print commandstring, 'failed to mask'\n    else:\n        cmd = commandstring\n    result = Rhino.RhinoApp.RunScript(cmd, echo)\n    if not result:\n        print 'The following command failed:'\n        print '   ',cmd\n    return result\n\ndef rcmds(commands, echo=True, mask=True):\n    for cmd in commands:\n        rcmd( cmd, echo, mask )\n\ndef formatCmd( tup ):\n    if tup[1]:\n        return tup[0] % tup[1]\n    else:\n        return tup[0]\n\ndef storeNearRect(filePath):\n    near = list(doc.Views.ActiveView.ActiveViewport.GetNearRect())\n    far = list(doc.Views.ActiveView.ActiveViewport.GetFarRect())\n    print 'view stored in %s' % filePath\n    f = open( filePath, 'wb' )\n    near.extend(far)\n    pickle.dump( near, f )\n    f.close()\n\ndef storeViewPoints(sids):\n    outMask = '/amigos/db/%sviewPoints'\n    for sid in sids:\n        setView( sid )\n        fPath = outMask % sid\n        storeNearRect( fPath )\n\ndef chopCurvesToFrustum(curves):\n    view = doc.Views.ActiveView.ActiveViewport\n    nearPts = view.GetNearRect()\n    farPts = view.GetFarRect()\n    near = view.GetFrustumNearPlane()\n    far = view.GetFrustumFarPlane()\n    left = view.GetFrustumLeftPlane()\n    right = view.GetFrustumRightPlane()\n    top = view.GetFrustumTopPlane()\n    bottom = view.GetFrustumBottomPlane()\n    frustPts = nearPts.extend(farPts)\n    frustBox = Rhino.Geometry.BoundingBox( frustPts )\n    frustum = Rhino.Geometry.Brep.CreatefromBox( frustBox )\n\n\ndef bakeRaw( data, attributes = None, transVect=None):\n    if type(data) not in (list, tuple):\n        data = [data]\n    elif type(data[0]) in (list, tuple, List):\n        data = data[0]\n    if attributes:\n        att = attributes\n    else:\n        att = Rhino.DocObjects.ObjectAttributes()\n    for thing in data:\n        bakeMany(thing, att, transVect)\n    doc.Views.ActiveView.Redraw()\n\ndef setView( sid ):\n    # still don't know how to set up the size of the viewport.\n    # this needs to be done manually\n    f = open('/amigos/db/%sview' % sid, 'rb')\n    view = pickle.load(f)\n    f.close()\n    if len(view) == 3:\n        geom = view[0]\n        vect = Rhino.Geometry.Vector3d(view[1])\n        targ = view[2]\n    else:\n        return 'bad view data'\n\n\n    vp = doc.Views.ActiveView.ActiveViewport\n    vp.SetCameraDirection( vect, True)\n    vp.SetCameraTarget(targ, True)\n    bb = geom.GetBoundingBox(True)\n    vp.ZoomBoundingBox( bb)\n    doc.Views.ActiveView.Redraw()\n    return view\n\ndef bakePickle( path, layer=None, attributes=None, transVector=None):\n    if os.path.exists(path):\n        try:\n            f = open( path, 'rb' )\n            data = pickle.load(f)\n            f.close()\n            bakeRaw(data, attributes, transVector)\n            print 'baked %s to layer \"%s\"' % (path, layer)\n        except:\n            print 'trouble unpickling', path\n    else:\n        print '%s does not exist' % path\n\ndef getModelLayers(filePath, layers ):\n    data = {}\n    print 'getting %s' % filePath\n    model = Rhino.FileIO.File3dm.Read( filePath )\n    for layer in layers:\n        geoms = []\n        objs = model.Objects.FindByLayer( layer )\n        for obj in objs:\n            geom = obj.Geometry\n            geom.EnsurePrivateCopy()\n            geoms.append(geom)\n        data[layer] = geoms\n    model.Dispose()\n    return data\n\ndef crossMatch(iter1, iter2):\n    pairs = []\n    for n in iter1:\n        for m in iter2:\n            pair = (n, m)\n            pairs.append(pair)\n    return pairs\n\n\ndef frustumX():\n    view = doc.Views.ActiveView.ActiveViewport\n    near = view.GetNearRect()\n    far = view.GetFarRect()\n    pairs = crossMatch( near, far )\n    crvs = []\n    for pair in pairs:\n        crvs.append(Rhino.Geometry.Curve.CreateControlPointCurve(pair, 1))\n    return crvs\n\ndef make2D(sid):\n    # create frustum X\n    frustumLines = frustumX()\n    att = LayerTools.layerAttributes(\"viewportFramework\", System.Drawing.Color.Cyan )\n    bakeMany( frustumLines, att)\n    cmds = [\n        'SelAll',\n        'Make2D Enter',\n        'Invert Delete SetView World Top',\n        'SelNone',\n        'SelLayer Make2D::visible::lines::viewportframework',\n        'SelLayer Make2D::hidden::lines::viewportframework',\n        'ZS',\n        'Delete',\n        ]\n    rcmds( cmds )\n\ndef exportPerspective( path ):\n    # export the current view as an illustrator file\n    cmds = [\n            'SellAll',\n            'Export \"%s\"' % path,\n            'Enter',\n            ]\n    rcmds( cmds )\n\n\nif __name__=='__main__':\n    '''This Make2D script needs to do the following things:\n        export linework for the topolines\n        export linework for the site outline\n        export linework for the other parcels\n        export linework of the nearby busstops (and create circles for them)\n        export linework for the terrain analysis curves and the drain arrows.\n    '''\n\n    scenes = [\n            ('topo',), # maybe\n            ('site','siteoutline'), # no\n            ('parcels',), # maybe\n            ('busstops',), # no\n            ('terraindrain','terrainmeshlines','drainarrows',), # maybe\n            ('plantwindows',), # no\n            ]\n\n    from site_ids import ids\n\n    aiMask = 'C:\\\\amigos\\\\make2ds\\\\%s-%s.ai'\n\n    for sid in ids[:1]:\n        rcmd('SetView World Perspective')\n        # set view\n        setView(sid)\n\n        for scene in scenes[:1]:\n\n            outPath = aiMask % ( sid, scene )\n\n            # delete everything\n            FileTools.deleteAll()\n\n            # get data\n            if scene[0] == 'topo':\n                layers = [\n                        'bigcontours',\n                        'smallcontours',\n                        ]\n                importPath = '/amigos/dump/%s-terrain.3dm' % sid\n                data = getModelLayers( importPath, layers )\n                print ', '.join(['%s:%s' % (k, len(data[k])) for k in data])\n            else:\n                data = {}\n                if len(scene) > 1:\n                    layers = scene[1:]\n                else:\n                    layers = scene\n                for layer in layers:\n                    fmask = '/amigos/db/%s%s' % (sid, layer)\n                    f = open(fmask, 'rb')\n                    data[layer] = pickle.load(f)\n                    f.close()\n            # bake data\n            for key in data:\n                layerAtt = LayerTools.layerAttributes( key )\n                bakeMany( data[key], layerAtt )\n            # do make2d or export AI file of current view\n            exportPerspective( outPath )\n\n            #make2D(sid)\n            #cmds = [\n                    #'SelAll',\n                    #'Export \"%s\" Enter' % outPath,\n                    #]\n\n\n\n",
  "language": "python",
  "imports": [
    "Rhino",
    "Rhino.Geometry",
    "rhinoscriptsyntax",
    "scriptcontext"
  ],
  "has_docstring": false
}