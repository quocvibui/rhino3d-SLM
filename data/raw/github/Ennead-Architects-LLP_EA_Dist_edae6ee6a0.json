{
  "source_url": "https://github.com/Ennead-Architects-LLP/EA_Dist/blob/635520d89b8308b78eabf5b60bb80121d0fa3838/Apps/_rhino/Block.tab/random_blocks_on_srfs.button/random_blocks_on_srfs_left.py",
  "repo": "Ennead-Architects-LLP/EA_Dist",
  "repo_stars": 0,
  "repo_description": null,
  "license": "unknown",
  "filepath": "Apps/_rhino/Block.tab/random_blocks_on_srfs.button/random_blocks_on_srfs_left.py",
  "instruction": "Random blocks on srfs left",
  "code": "__title__ = \"RandomBlocksOnSrfs\"\r\n__doc__ = \"\"\"Advanced block distribution utility for surfaces.\r\n\r\nFeatures:\r\n- Distributes blocks randomly across target surfaces\r\n- Configurable edge distance and spacing controls\r\n- Optional edge-guided or curve-guided placement\r\n- Real-time preview of block placement\r\n- Supports multiple distribution patterns:\r\n  - Random interior placement\r\n  - Edge-aligned placement\r\n  - Even edge distribution\r\n\r\nUsage:\r\n1. Select target surfaces and sample blocks\r\n2. Configure placement parameters\r\n3. Choose distribution pattern\r\n4. Preview and adjust as needed\"\"\"\r\n__is_popular__ = True\r\n\r\n\r\nimport Rhino # pyright: ignore\r\nimport rhinoscriptsyntax as rs\r\nimport scriptcontext as sc\r\nimport random\r\nimport time\r\nimport Eto # pyright: ignore\r\n\r\n\r\nfrom EnneadTab import DATA_FILE, NOTIFICATION, SOUND, TIME, LOG, ERROR_HANDLE, ENVIRONMENT\r\nfrom EnneadTab.RHINO import RHINO_UI, RHINO_FORMS\r\n\r\nFORM_KEY = 'SCATTER_BLOCK_ON_SRF_modeless_form'\r\n\r\n\r\n\r\n\r\n\r\n# make modal dialog\r\nclass ScatterBlockDialog(Eto.Forms.Form):\r\n    \"\"\"Modeless dialog for scattering block instances on selected surfaces.\"\"\"\r\n\r\n    # Initializer\r\n    def __init__(self):\r\n        \"\"\"Initialize dialog UI components and default state.\"\"\"\r\n        # Eto initials\r\n        self.Title = \"Scatter Blocks on Srf\"\r\n        self.Resizable = True\r\n        self.Padding = Eto.Drawing.Padding(5)\r\n        self.Spacing = Eto.Drawing.Size(5, 5)\r\n        \r\n        #self.Bounds = Eto.Drawing.Rectangle()\r\n        self.Width = 600\r\n\r\n        self.selected_srf = None\r\n        self.selected_srfs = None\r\n        self.user_blocks = None\r\n        self.guide_crv = None\r\n        self.internal_rotate_angle = 0\r\n        self.Closed += self.OnFormClosed\r\n\r\n\r\n\r\n\r\n        # initialize layout\r\n        main_layout = Eto.Forms.DynamicLayout()\r\n        main_layout.Padding = Eto.Drawing.Padding(5)\r\n        main_layout.Spacing = Eto.Drawing.Size(5, 5)\r\n\r\n\r\n\r\n        # add listBox\r\n        main_layout.BeginVertical()\r\n        main_layout.AddRow(self.CreatePicker())\r\n        main_layout.AddRow(self.Create_block_info_inputs())\r\n        main_layout.EndVertical()\r\n\r\n\r\n\r\n\r\n\r\n        layout = Eto.Forms.DynamicLayout()\r\n        layout.Padding = Eto.Drawing.Padding(5)\r\n        layout.Spacing = Eto.Drawing.Size(5, 5)\r\n\r\n        # add message\r\n        layout.AddSeparateRow(None, self.CreateLogoImage())\r\n        layout.BeginVertical()\r\n        layout.AddRow(self.CreateMessageBar())\r\n        layout.AddRow(self.CreateExpander())\r\n        layout.EndVertical()\r\n\r\n\r\n        layout.BeginVertical()\r\n        layout.AddRow(main_layout)\r\n        layout.EndVertical()\r\n\r\n        # add buttons\r\n        last_layout = Eto.Forms.DynamicLayout()\r\n        last_layout.Padding = Eto.Drawing.Padding(5)\r\n        last_layout.Spacing = Eto.Drawing.Size(5, 5)\r\n        layout.BeginVertical()\r\n        last_layout.AddRow(*self.CreateButtons())\r\n        layout.AddRow(last_layout)\r\n        layout.EndVertical()\r\n\r\n        # set content\r\n        self.Content = layout\r\n        self.InitiateFiller()\r\n        \r\n        RHINO_UI.apply_dark_style(self)\r\n\r\n\r\n\r\n\r\n    def CreateLogoImage(self):\r\n        \"\"\"Create and return the logo image view widget.\"\"\"\r\n        self.logo = Eto.Forms.ImageView()\r\n\r\n        return self.logo\r\n\r\n    # create message bar function\r\n    def CreateMessageBar(self):\r\n        \"\"\"Create and return the message label shown at the top of the dialog.\"\"\"\r\n        self.msg = Eto.Forms.Label()\r\n        self.msg.Text = \"Pick surface(s) and sample blocks, then scatter blocks over surface with placement rules.\"\r\n        return self.msg\r\n        #self.msg.HorizontalAlignment = Eto.Forms.HorizontalAlignment.Left\r\n\r\n\r\n    def CreateExpander(self):\r\n        \"\"\"Create a collapsible help section placeholder.\"\"\"\r\n        self.expander = Eto.Forms.Expander ()\r\n        self.expander.Header = \"Quick Help\"\r\n        self.expander.Expanded = False\r\n        msg = Eto.Forms.Label()\r\n        msg.Text = \"helper document to be filled in.....\"\r\n        self.expander.Content = msg\r\n        return self.expander\r\n\r\n\r\n\r\n    def CreatePicker(self):\r\n        \"\"\"Create controls for selecting base surfaces to scatter on.\"\"\"\r\n        layout = Eto.Forms.DynamicLayout()\r\n        layout.Padding = Eto.Drawing.Padding(5)\r\n        layout.Spacing = Eto.Drawing.Size(5, 5)\r\n        msg = Eto.Forms.Label()\r\n        msg.Text = \"Step 1:\"\r\n        layout.AddRow(msg)\r\n        \r\n        stack_layout = Eto.Forms.DynamicLayout()\r\n        stack_layout.Padding = Eto.Drawing.Padding(5)\r\n        stack_layout.Spacing = Eto.Drawing.Size(5, 5)\r\n        A = Eto.Forms.Label(Text = 'Pick surface(s).')\r\n        stack_layout.AddRow(A)\r\n\r\n        pick_bn = Eto.Forms.Button(Text = 'Pick Base Surface(s).')\r\n        pick_bn.Click += self.btn_Pick_Srf_Clicked\r\n\r\n        self.srf_label = Eto.Forms.Label(Text = '')\r\n        stack_layout.AddRow(pick_bn,  None)\r\n        stack_layout.AddRow(self.srf_label)\r\n        layout.AddRow(stack_layout)\r\n        layout.AddRow(Rhino.UI.Controls.Divider())\r\n\r\n        return layout\r\n\r\n    def Create_block_info_inputs(self):\r\n        \"\"\"Create controls for scatter mode and block selection/spacing inputs.\"\"\"\r\n        layout = Eto.Forms.DynamicLayout()\r\n        layout.Padding = Eto.Drawing.Padding(5)\r\n        layout.Spacing = Eto.Drawing.Size(5, 5)\r\n\r\n        stack_layout = Eto.Forms.DynamicLayout()\r\n        stack_layout.Padding = Eto.Drawing.Padding(5)\r\n        stack_layout.Spacing = Eto.Drawing.Size(5, 5)\r\n\r\n\r\n        msg = Eto.Forms.Label()\r\n        msg.Text = \"Step 2:\"\r\n        layout.AddRow(msg)\r\n\r\n        A = Eto.Forms.Label(Text = 'Pick where blocks are placed.')\r\n        stack_layout.AddRow(A)\r\n        self.mode_list = Eto.Forms.RadioButtonList()\r\n        self.mode_list.Orientation = Eto.Forms.Orientation.Vertical\r\n        self.mode_list.DataStore  = [\"Along Border Mode\", \"Avoid Border Mode\", \"Ignore Border Mode\"]\r\n        self.mode_list.SelectedValue = self.mode_list.DataStore[-1]\r\n        self.mode_list.SelectedValueChanged += self.UI_changed\r\n        stack_layout.AddRow(self.mode_list)\r\n        layout.AddRow(stack_layout)\r\n\r\n\r\n        layout.AddRow(Rhino.UI.Controls.Divider())\r\n        msg = Eto.Forms.Label()\r\n        msg.Text = \"Step 3:\"\r\n        layout.AddRow(msg)\r\n\r\n        stack_layout = Eto.Forms.DynamicLayout()\r\n        stack_layout.Padding = Eto.Drawing.Padding(5)\r\n        stack_layout.Spacing = Eto.Drawing.Size(5, 5)\r\n        A = Eto.Forms.Label(Text = 'Define which blocks you want to use.')\r\n        stack_layout.AddRow(A)\r\n        pick_bn = Eto.Forms.Button(Text = 'Pick Blocks')\r\n        pick_bn.Click += self.btn_pick_block_clicked\r\n        clear_pick_bn = Eto.Forms.Button(Text = 'Clear Blocks')\r\n        clear_pick_bn.Click += self.btn_clear_blocks_clicked\r\n        stack_layout.AddSeparateRow(pick_bn, None, clear_pick_bn)\r\n        self.user_block_label = Eto.Forms.Label(Text = '\\n\\n\\n')\r\n        stack_layout.AddRow(self.user_block_label)\r\n        layout.AddRow(stack_layout)\r\n\r\n\r\n        layout.AddRow(Rhino.UI.Controls.Divider())\r\n\r\n        msg = Eto.Forms.Label()\r\n        msg.Text = \"Step 4:\"\r\n        layout.AddRow(msg)\r\n        stack_layout = Eto.Forms.DynamicLayout()\r\n        stack_layout.Padding = Eto.Drawing.Padding(5)\r\n        stack_layout.Spacing = Eto.Drawing.Size(5, 5)\r\n        A = Eto.Forms.Label(Text = 'Block spacing info in model unit (per input surface):')\r\n\r\n        stack_layout.AddRow( A)\r\n\r\n        inner_stack_layout = Eto.Forms.DynamicLayout()\r\n        inner_stack_layout.Padding = Eto.Drawing.Padding(5)\r\n        inner_stack_layout.Spacing = Eto.Drawing.Size(5, 5)\r\n        self.label_C = Eto.Forms.Label(Text = 'Desired Number Per Unit Area')\r\n        self.tbox_density_per_area = Eto.Forms.TextBox()\r\n        inner_stack_layout.AddRow(self.label_C, self.tbox_density_per_area)\r\n\r\n        self.label_A = Eto.Forms.Label(Text = 'Distance To Border')\r\n        self.tbox_dist_to_border = Eto.Forms.TextBox()\r\n        inner_stack_layout.AddRow(self.label_A,  self.tbox_dist_to_border)\r\n\r\n        self.label_B = Eto.Forms.Label(Text = 'Minimal Distance Among Blocks\\n(use -1 to ignore social distance)')\r\n        self.tbox_minimal_internal_dist = Eto.Forms.TextBox()\r\n        inner_stack_layout.AddRow(self.label_B, self.tbox_minimal_internal_dist)\r\n\r\n        self.label_S = Eto.Forms.Label(Text = 'Global Scale Factor (additional multiplier)')\r\n        self.tbox_global_scale = Eto.Forms.TextBox()\r\n        inner_stack_layout.AddRow(self.label_S, self.tbox_global_scale)\r\n\r\n        self.debug_label = Eto.Forms.Label(Text = 'Info:')\r\n        inner_stack_layout.AddRow(None, self.debug_label)\r\n\r\n        stack_layout.AddRow(inner_stack_layout)\r\n\r\n        layout.AddRow(stack_layout)\r\n\r\n\r\n        layout.AddRow(Rhino.UI.Controls.Divider())\r\n        msg = Eto.Forms.Label()\r\n        msg.Text = \"Step 5:\"\r\n        layout.AddRow(msg)\r\n        stack_layout = Eto.Forms.DynamicLayout()\r\n        stack_layout.Padding = Eto.Drawing.Padding(5)\r\n        stack_layout.Spacing = Eto.Drawing.Size(5, 5)\r\n        A = Eto.Forms.Label(Text = 'Scater Mode:')\r\n        stack_layout.AddRow( A)\r\n        self.scatter_mode_list = Eto.Forms.RadioButtonList()\r\n        self.scatter_mode_list.Orientation = Eto.Forms.Orientation.Vertical\r\n        self.scatter_mode_list.DataStore  = [\"Random\", \"Follow Guide Crv\", \"Follow Surface Edge\"]\r\n        self.scatter_mode_list.SelectedValue = self.scatter_mode_list.DataStore[0]\r\n        self.scatter_mode_list.SelectedValueChanged += self.UI_changed\r\n        stack_layout.AddRow(self.scatter_mode_list)\r\n\r\n\r\n        self.pick_guide_crv_bn = Eto.Forms.Button(Text = 'Pick Guide Crv.')\r\n        self.pick_guide_crv_bn.Click += self.btn_pick_guide_crv_clicked\r\n\r\n        self.rotate_bn = Eto.Forms.Button(Text = 'Spin Block 90 degree.')\r\n        self.rotate_bn.Click += self.btn_rotate_clicked\r\n\r\n        self.guide_crv_label = Eto.Forms.Label(Text = '')\r\n        stack_layout.AddSeparateRow(self.pick_guide_crv_bn, self.guide_crv_label, None, self.rotate_bn)\r\n        layout.AddRow(stack_layout)\r\n        \r\n        self.pick_guide_crv_bn.Enabled = self.scatter_mode_list.SelectedValue == self.scatter_mode_list.DataStore[1]\r\n        self.rotate_bn.Enabled = self.scatter_mode_list.SelectedValue != self.scatter_mode_list.DataStore[0]\r\n\r\n\r\n        return layout\r\n\r\n\r\n    def CreateButtons(self):\r\n        \"\"\"Create and return the dialog action buttons.\"\"\"\r\n        user_buttons = []\r\n\r\n\r\n\r\n        user_buttons.append(None)\r\n\r\n        self.btn_Run = Eto.Forms.Button()\r\n        self.btn_Run.Height = 30\r\n        self.btn_Run.Text = \"(Re)Generate\"\r\n\r\n        self.btn_Run.ImagePosition = Eto.Forms.ButtonImagePosition.Right\r\n        self.btn_Run.Click += self.btn_preview_Clicked\r\n        user_buttons.append(self.btn_Run)\r\n\r\n\r\n\r\n        self.btn_Run = Eto.Forms.Button()\r\n        self.btn_Run.Text = \"Add Previewed Blocks To File.\"\r\n        self.btn_Run.Height = 30\r\n        self.btn_Run.Click += self.btn_process_Clicked\r\n        user_buttons.append(self.btn_Run)\r\n\r\n        #self.dist_to_border = 400\r\n\r\n        return user_buttons\r\n\r\n\r\n    def btn_rotate_clicked(self, sender, e):\r\n        \"\"\"Rotate previewed blocks by 90 degrees around Z for each click.\"\"\"\r\n        if not hasattr(self, \"block_collection\") or not self.block_collection: \r\n            NOTIFICATION.messenger(main_text = \"No block defined.\")\r\n            return\r\n\r\n        rs.EnableRedraw(False)\r\n\r\n        z_vec = rs.VectorCreate([0,0,1], [0,0,0])\r\n\r\n\r\n        SOUND.play_sound(\"sound_effect_mario_fireball.wav\")\r\n        for collection in self.total_collection:\r\n            if collection is None: continue\r\n            # print (collection)\r\n            for block in collection:\r\n\r\n                pt = rs.BlockInstanceInsertPoint(block)\r\n\r\n                ang = 90\r\n                rs.RotateObject(block, pt,ang,z_vec)\r\n        rs.EnableRedraw(True)\r\n    \r\n        self.internal_rotate_angle += 90\r\n        \r\n    \r\n\r\n\r\n    # event handler handling clicking on the 'run' button\r\n    def UI_changed(self, sender, e):\r\n        \"\"\"Handle UI option changes and refresh the preview layout.\"\"\"\r\n        self.pick_guide_crv_bn.Enabled = self.scatter_mode_list.SelectedValue == self.scatter_mode_list.DataStore[1]\r\n        self.rotate_bn.Enabled = self.scatter_mode_list.SelectedValue != self.scatter_mode_list.DataStore[0]\r\n        \r\n        \r\n        if self.scatter_mode_list.SelectedValue == self.scatter_mode_list.DataStore[1]:\r\n            pass\r\n\r\n        self.generate_blocks_layout(is_preview = True)\r\n\r\n\r\n    # event handler handling clicking on the 'run' button\r\n    def btn_preview_Clicked(self, sender, e):\r\n        \"\"\"Generate a preview of scattered blocks without committing to the model.\"\"\"\r\n        self.generate_blocks_layout(is_preview = True)\r\n\r\n    def btn_process_Clicked(self, sender, e):\r\n        \"\"\"Bake the previewed blocks into the model and clear preview state.\"\"\"\r\n        self.generate_blocks_layout(is_preview = False)\r\n        self.clear_out()\r\n        NOTIFICATION.messenger(main_text = \"Blocks added\")\r\n        SOUND.play_sound(\"sound_effect_popup_msg1.wav\")\r\n        #self.Close()\r\n\r\n    # event handler handling clicking on the 'cancel' button\r\n    def btn_Cancel_Clicked(self, sender, e):\r\n        \"\"\"Close the dialog without making further changes.\"\"\"\r\n        self.Close()\r\n\r\n\r\n    def btn_Pick_Srf_Clicked(self, sender, e):\r\n        \"\"\"Prompt user to select base surfaces for scattering and update preview.\"\"\"\r\n        select_objs = rs.GetObjects(message = \"Pick Base Surfaces.\", filter = rs.filter.surface, select = True)\r\n        \r\n        if select_objs:\r\n            note = \"Base surfaces captured!\"\r\n            self.srf_label.Text = note\r\n            NOTIFICATION.messenger(main_text = note)\r\n        \r\n            self.selected_srfs = select_objs\r\n        else:\r\n            note = \"Base surface not defined!\"\r\n            NOTIFICATION.messenger(main_text = note)\r\n            SOUND.play_sound(\"sound_effect_error.wav\")\r\n            \r\n            self.srf_label.Text = note\r\n\r\n        self.generate_blocks_layout(is_preview = True)\r\n\r\n\r\n    def btn_pick_guide_crv_clicked(self, sender, e):\r\n        \"\"\"Prompt user to select a guide curve used for oriented placement.\"\"\"\r\n        select_obj = rs.GetObject(message = \"Pick guide curve.\", filter = rs.filter.curve, select = True)\r\n        if select_obj:\r\n            note = \"  Guide curve captured!\"\r\n            self.guide_crv_label.Text = note\r\n            NOTIFICATION.messenger(main_text = note)\r\n        \r\n            self.guide_crv = select_obj\r\n        else:\r\n            self.guide_crv_label.Text = \"  Guide curve not defined!\"\r\n            SOUND.play_sound(\"sound_effect_error.wav\")\r\n\r\n        self.generate_blocks_layout(is_preview = True)\r\n\r\n\r\n    def btn_pick_block_clicked(self, sender, e):\r\n        \"\"\"Collect user-selected block instances and optional ratios for sampling.\"\"\"\r\n        select_objs = rs.GetObjects(message = \"Pick a block you want to use in this sample layout.\", filter = 4096, select = True)\r\n        if select_objs:\r\n            block_names = list(set([rs.BlockInstanceName(x) for x in select_objs]))\r\n            if len(block_names) > 1:\r\n                \r\n                block_names.sort()\r\n                ratios = rs.PropertyListBox(block_names, [1] * len(block_names), message = \"Ratio of each block type\")\r\n                ratios = [int(x) for x in ratios]\r\n            else:\r\n                ratios = [1]\r\n            self.user_blocks = {name: ratio for name, ratio in zip(block_names, ratios)}\r\n\r\n            names = \"\"\r\n            for name, count in self.user_blocks.items():\r\n                names += \"<{}>={}  +  \".format(name, count)\r\n            names = names.rstrip(\"  +  \")\r\n            self.user_block_label.Text = \"Blocks captured in following ratio!\\n{}\".format(names)\r\n            \r\n        else:\r\n            self.user_block_label.Text = \"User Block not defined! Please pick at least one block to scatter.\"\r\n            self.user_block = None\r\n\r\n        self.generate_blocks_layout(is_preview = True)\r\n\r\n\r\n\r\n    def btn_clear_blocks_clicked(self, sender, e):\r\n        \"\"\"Clear any previously selected blocks and refresh preview.\"\"\"\r\n        self.user_block_label.Text = \"User Block not defined! Please pick at least one block to scatter.\"\r\n        self.user_blocks = None\r\n\r\n        self.generate_blocks_layout(is_preview = True)\r\n\r\n\r\n\r\n    @property\r\n    def is_avoid_border(self):\r\n        \"\"\"Return True when the 'avoid border' placement mode is active.\"\"\"\r\n        return self.mode_list.SelectedValue == self.mode_list.DataStore[1]\r\n\r\n    @property\r\n    def is_along_border(self):\r\n        \"\"\"Return True when the 'along border' placement mode is active.\"\"\"\r\n        return self.mode_list.SelectedValue == self.mode_list.DataStore[0]\r\n\r\n    @property\r\n    def is_ignore_border(self):\r\n        \"\"\"Return True when the 'ignore border' placement mode is active.\"\"\"\r\n        return self.mode_list.SelectedValue == self.mode_list.DataStore[-1]\r\n\r\n    def delete_preview_blocks(self):\r\n        \"\"\"Delete any preview block instances from the document.\"\"\"\r\n        obj_name = \"{}_BLOCK_SCATTER_PREVIEW\".format(ENVIRONMENT.PLUGIN_ABBR)\r\n        old_blocks = rs.ObjectsByName(obj_name)\r\n        rs.DeleteObjects(old_blocks)\r\n        \r\n        \r\n    @ERROR_HANDLE.try_catch_error()\r\n    def generate_blocks_layout(self, is_preview):\r\n        \"\"\"Generate scattered blocks on selected surfaces according to UI options.\r\n\r\n        Parameters\r\n        ----------\r\n        is_preview : bool\r\n            When True, create temporary preview objects; otherwise, bake blocks.\r\n        \"\"\"\r\n        try:\r\n\r\n            self.dist_to_border = float(self.tbox_dist_to_border.Text)\r\n            self.minimal_internal_dist = float(self.tbox_minimal_internal_dist.Text)\r\n            self.density_per_area = float(self.tbox_density_per_area.Text)\r\n            self.global_scale = float(self.tbox_global_scale.Text)\r\n        except Exception as e:\r\n            print (str(e))\r\n            NOTIFICATION.messenger(main_text = \"data not valid\")\r\n            SOUND.play_sound(\"sound_effect_error.wav\")\r\n            self.delete_preview_blocks()\r\n            return\r\n\r\n\r\n        if self.density_per_area <= 0:\r\n            NOTIFICATION.messenger(main_text =  \"Density must be greater than 0\")\r\n            SOUND.play_sound(\"sound_effect_error.wav\")\r\n            \r\n            self.delete_preview_blocks()\r\n            return\r\n\r\n\r\n        if not self.selected_srfs:\r\n            NOTIFICATION.messenger(main_text = \"Base srfs not valid\")\r\n            SOUND.play_sound(\"sound_effect_error.wav\")\r\n            \r\n            self.delete_preview_blocks()\r\n            return\r\n        \r\n        # Filter out any surfaces that were deleted or became invalid\r\n        valid_srfs = [s for s in self.selected_srfs if rs.IsObject(s) and rs.IsSurface(s)]\r\n        if len(valid_srfs) == 0:\r\n            NOTIFICATION.messenger(main_text = \"All selected surfaces are invalid or deleted\")\r\n            SOUND.play_sound(\"sound_effect_error.wav\")\r\n            self.delete_preview_blocks()\r\n            return\r\n        if len(valid_srfs) != len(self.selected_srfs):\r\n            self.srf_label.Text = \"Some selected surfaces were removed; proceeding with remaining.\"\r\n\r\n        # Pre-check for extremely high block counts per surface based on density\r\n        try:\r\n            THRESHOLD = 1000\r\n            def surface_area_safe(srf):\r\n                result = rs.SurfaceArea(srf)\r\n                try:\r\n                    return float(result[0]) if hasattr(result, '__getitem__') else float(result)\r\n                except Exception:\r\n                    try:\r\n                        return float(result)\r\n                    except Exception:\r\n                        return 0.0\r\n\r\n            def max_count_for_density(density):\r\n                max_count_local = 0\r\n                for srf in valid_srfs:\r\n                    area_val = surface_area_safe(srf)\r\n                    count_val = max(1, int(round(area_val * density)))\r\n                    if count_val > max_count_local:\r\n                        max_count_local = count_val\r\n                return max_count_local\r\n\r\n            max_count = max_count_for_density(self.density_per_area)\r\n            if max_count > THRESHOLD:\r\n                while True:\r\n                    user_choice = rs.MessageBox(\"At least one of the surfaces will have {} blocks using density {}. Do you want to continue?\".format(max_count, self.density_per_area), 4, \"High Block Count\")\r\n                    # 6 = Yes, 7 = No\r\n                    if user_choice == 6:\r\n                        break\r\n                    # Auto-reduce density to 1/10 until under threshold\r\n                    self.density_per_area = self.density_per_area / 10.0\r\n                    self.tbox_density_per_area.Text = str(self.density_per_area)\r\n                    max_count = max_count_for_density(self.density_per_area)\r\n                    if max_count <= THRESHOLD:\r\n                        break\r\n        except Exception:\r\n            pass\r\n\r\n\r\n        if self.scatter_mode_list.SelectedValue == self.scatter_mode_list.DataStore[1]:\r\n            if not self.guide_crv or not rs.IsObject(self.guide_crv):\r\n                NOTIFICATION.messenger(main_text = \"Guide curve not valid\")\r\n                SOUND.play_sound(\"sound_effect_error.wav\")\r\n      \r\n                self.delete_preview_blocks()\r\n                return\r\n\r\n\r\n        # if preview_mode, need to remove preview crvs no matter what\r\n        if is_preview:\r\n            self.obj_name = \"{}_BLOCK_SCATTER_PREVIEW\".format(ENVIRONMENT.PLUGIN_ABBR)\r\n            old_blocks = rs.ObjectsByName(self.obj_name)\r\n            rs.DeleteObjects(old_blocks)\r\n\r\n        else: \r\n            # is not preview, then can exist\r\n            self.obj_name = \"{}_SCATTER_BLOCK\".format(ENVIRONMENT.PLUGIN_ABBR)\r\n            for collection in self.total_collection:\r\n                map(lambda x: rs.ObjectName(x, self.obj_name), collection)\r\n            return\r\n\r\n        if not self.user_blocks:\r\n            \r\n            NOTIFICATION.messenger(main_text = \"User block not valid\")\r\n            SOUND.play_sound(\"sound_effect_error.wav\")\r\n            \r\n            return\r\n        rs.UnselectAllObjects()\r\n        rs.EnableRedraw(False)\r\n        \r\n\r\n        self.total_collection = []\r\n        for srf in valid_srfs:\r\n            self.selected_srf = srf\r\n            self.generate_blocks_layout_action(is_preview)\r\n            self.total_collection.append(self.block_collection) \r\n            rs.Redraw()\r\n        rs.EnableRedraw(True)\r\n        \r\n\r\n\r\n    def generate_blocks_layout_action(self, is_preview):\r\n        \"\"\"Perform scatter generation for a single surface and build block set.\"\"\"\r\n        if not (rs.IsObject(self.selected_srf) and rs.IsSurface(self.selected_srf)):\r\n            return\r\n        # generate base pts\r\n        domainU = rs.SurfaceDomain(self.selected_srf, 0)\r\n        domainV = rs.SurfaceDomain(self.selected_srf, 1)\r\n        self.borders = rs.DuplicateSurfaceBorder(self.selected_srf) or []\r\n        # print domainU\r\n        # print domainV\r\n        domainU_diff = domainU[1] - domainU[0]\r\n        domainV_diff = domainV[1] - domainV[0]\r\n\r\n\r\n        \"\"\"\r\n        with some near threhold setting, it might be immposobile to find max count pts. So a timer is needed to stop loop since last pts add to list.\r\n        \"\"\"\r\n        self.pt_collection = []\r\n        success_time_mark = time.time()\r\n        count = 0\r\n        # compute per-surface target count based on density and area\r\n        area_result = rs.SurfaceArea(self.selected_srf)\r\n        try:\r\n            surface_area = area_result[0] if hasattr(area_result, '__getitem__') else float(area_result)\r\n        except Exception:\r\n            surface_area = float(area_result) if area_result is not None else 0.0\r\n        target_count = max(1, int(round(surface_area * self.density_per_area)))\r\n\r\n        while count < target_count:\r\n            time_span = time.time() - success_time_mark\r\n            # if count%20 == 0:\r\n            #     sc.doc.Views.Redraw()\r\n            #     Rhino.RhinoApp.Wait()\r\n\r\n\r\n            if time_span > 1:\r\n\r\n\r\n                RHINO_FORMS.notification(main_text = \"Cannot add more blocks with current setting\",\r\n                                                        sub_text = \"Maybe the min spacing is set too high for the given base srf size, or the target pts count is too much.\\n\\nFinal {} pts added\".format(len(self.pt_collection)), \r\n                                                        self_destruct = 5,\r\n                                                        button_name = \"Sure...\",\r\n                                                        width = 400,\r\n                                                        height = 300)\r\n                break\r\n            U = random.random() * domainU_diff + domainU[0]\r\n            V = random.random() * domainV_diff + domainV[0]\r\n            pt = rs.EvaluateSurface(self.selected_srf, U, V)\r\n\r\n            if not rs.IsPointOnSurface(self.selected_srf, pt):\r\n                continue\r\n\r\n\r\n            if self.is_avoid_border and self.is_pt_close_to_border(pt):\r\n                continue\r\n            if self.is_along_border and not self.is_pt_close_to_border(pt):\r\n                continue\r\n\r\n            if self.is_pt_close_to_existing_pts(pt):\r\n                continue\r\n\r\n            #print pt\r\n            self.pt_collection.append( pt )\r\n            \"\"\"\r\n            add rhino progress bar here,\r\n            add time stamp reset for the last susceeful appending of pt. If too long since last addition, there might be problem in the thresshold setting.\r\n            \"\"\"\r\n            success_time_mark = time.time()\r\n            count += 1\r\n\r\n        if is_preview:\r\n            SOUND.play_sound(\"sound_effect_popup_msg2.wav\")\r\n        else:\r\n            SOUND.play_sound(\"sound_effect_popup_msg1.wav\")\r\n        if self.borders:\r\n            rs.DeleteObjects(self.borders)\r\n\r\n\r\n\r\n        sample_list = []\r\n        for name, count in self.user_blocks.items():\r\n            sample_list.extend([name] * count)\r\n\r\n        self.block_collection = []\r\n        for pt in self.pt_collection:\r\n            picked_block_name = random.choice(sample_list)\r\n            random_z_scale = random.uniform(0.9,1.1)\r\n            scale = (self.global_scale, self.global_scale, random_z_scale * self.global_scale)\r\n            if self.scatter_mode_list.SelectedValue == self.scatter_mode_list.DataStore[0] :\r\n                rotation = random.random() * 360\r\n            elif self.scatter_mode_list.SelectedValue == self.scatter_mode_list.DataStore[1] :\r\n                rotation = self.get_rotation_from_guide_crv(pt)\r\n                #print rotation\r\n            else:\r\n                borders = rs.DuplicateSurfaceBorder(self.selected_srf) or []\r\n                if not borders:\r\n                    continue\r\n                self.srf_edge_crv  = borders[0]\r\n                rotation = self.get_rotation_from_guide_crv(pt, use_edge = True)\r\n                self.srf_edge_crv  = None\r\n                rs.DeleteObjects(borders)\r\n                \r\n            rotation_normal = (0,0,1)\r\n            block = rs.InsertBlock(picked_block_name, pt, scale, rotation, rotation_normal)\r\n            self.block_collection.append(block)\r\n\r\n        rs.AddObjectsToGroup(self.block_collection, rs.AddGroup())\r\n        map(lambda x: rs.ObjectName(x, self.obj_name), self.block_collection)\r\n        \r\n\r\n\r\n       \r\n\r\n        total_panel = len(self.total_collection)\r\n        self.debug_label.Text = \"Blocks Count = {}\".format(total_panel)\r\n\r\n\r\n\r\n    def get_rotation_from_guide_crv(self, pt, use_edge = False):\r\n        \"\"\"Compute block rotation angle based on guide curve tangent at closest point.\r\n\r\n        Parameters\r\n        ----------\r\n        pt : Rhino.Geometry.Point3d\r\n            Insertion point on the surface.\r\n        use_edge : bool, optional\r\n            If True, use the duplicated surface edge as guide; else use user guide.\r\n\r\n        Returns\r\n        -------\r\n        float\r\n            Rotation angle in degrees.\r\n        \"\"\"\r\n        if use_edge:\r\n            rule_crv = self.srf_edge_crv\r\n        else:\r\n            rule_crv = self.guide_crv\r\n            \r\n        para = rs.CurveClosestPoint(rule_crv, pt)\r\n        tangent = rs.CurveTangent(rule_crv, para)\r\n      \r\n        return -rs.VectorAngle(Rhino.Geometry.Vector3d (1,0,0), tangent) + self.internal_rotate_angle\r\n\r\n\r\n\r\n    def is_pt_close_to_existing_pts(self, pt):\r\n        \"\"\"Return True if point is closer than minimal spacing to existing points.\"\"\"\r\n        if self.minimal_internal_dist < 0:\r\n            return False\r\n        if len(self.pt_collection) == 0:\r\n            return False\r\n        \r\n        for other_pt in self.pt_collection:\r\n            dist = pt.DistanceTo(other_pt)\r\n            if dist < self.minimal_internal_dist:\r\n                return True\r\n        else:\r\n            return False\r\n\r\n\r\n        closest_pt = rs.PointClosestObject(pt, self.pt_collection)[1]\r\n        dist = rs.Distance(pt, closest_pt)\r\n        return dist < self.minimal_internal_dist\r\n\r\n    def is_pt_close_to_border(self, pt):\r\n        \"\"\"Return True if point is closer than threshold to any surface border.\"\"\"\r\n        for border in (self.borders or []):\r\n            para = rs.CurveClosestPoint(border, pt)\r\n            closest_pt = rs.EvaluateCurve(border, para)\r\n            dist = rs.Distance(pt, closest_pt)\r\n\r\n            if dist < self.dist_to_border: return True\r\n        \r\n        \r\n        return False\r\n\r\n\r\n\r\n    def OnFormClosed(self, sender, e):\r\n        \"\"\"Handle form closed event and ensure resources are released.\"\"\"\r\n        self.Close()\r\n\r\n\r\n\r\n    def InitiateFiller(self):\r\n        \"\"\"Load persisted text-box values from sticky storage into the UI.\"\"\"\r\n        self.filler_list = [\"tbox_dist_to_border\",\"tbox_minimal_internal_dist\", \"tbox_density_per_area\", \"tbox_global_scale\"]\r\n        for x in self.filler_list:\r\n            sticky_key = FORM_KEY + x\r\n            # default stickies per field\r\n            if x == \"tbox_global_scale\":\r\n                default = 1\r\n            elif x == \"tbox_density_per_area\":\r\n                # density per area unit default\r\n                default = 0.01\r\n            else:\r\n                default = 0\r\n            value = DATA_FILE.get_sticky(sticky_key, default_value_if_no_sticky = default)\r\n\r\n            #setattr(self, x , str(value))\r\n            tbox = getattr(self, x)\r\n            tbox.Text  = str(value)\r\n\r\n\r\n    def Close(self):\r\n        \"\"\"Persist UI state to sticky storage and clean up preview objects.\"\"\"\r\n        # Remove the events added in the initializer\r\n        #self.RemoveEvents()\r\n        # Dispose of the form and remove it from the sticky dictionary\r\n        if sc.sticky.has_key(FORM_KEY):\r\n            form = sc.sticky[FORM_KEY]\r\n            if form:\r\n                form.Dispose()\r\n                form = None\r\n            sc.sticky.Remove(FORM_KEY)\r\n\r\n        for x in self.filler_list:\r\n            if not hasattr(self, x):\r\n                continue\r\n            tbox = getattr(self, x)\r\n            sticky_key = FORM_KEY + x\r\n            #print x\r\n            DATA_FILE.set_sticky(sticky_key, tbox.Text)\r\n\r\n        self.clear_out()\r\n\r\n    def clear_out(self):\r\n        \"\"\"Clear preview objects and reset selection state and labels.\"\"\"\r\n        obj_name = \"{}_BLOCK_SCATTER_PREVIEW\".format(ENVIRONMENT.PLUGIN_ABBR)\r\n        old_crvs = rs.ObjectsByName(obj_name)\r\n        rs.DeleteObjects(old_crvs)\r\n\r\n\r\n        self.selected_srf = None\r\n        self.selected_srfs = None\r\n        self.srf_label.Text = \"Base srfs empty.\"\r\n\r\n\r\n\r\n\r\ndef random_blocks_on_srfs():\r\n    \"\"\"Open the scatter blocks dialog as a modeless UI in Rhino.\"\"\"\r\n    rs.EnableRedraw(False)\r\n    if sc.sticky.has_key(FORM_KEY):\r\n        return\r\n    dlg = ScatterBlockDialog()\r\n    dlg.Owner = Rhino.UI.RhinoEtoApp.MainWindow\r\n    dlg.Show()\r\n    sc.sticky[FORM_KEY] = dlg\r\n\r\n@LOG.log(__file__, __title__)\r\n@ERROR_HANDLE.try_catch_error()\r\ndef make_unique_block_name(block_name):\r\n    \"\"\"Return a unique block name by appending suffixes if collision occurs.\"\"\"\r\n    while True:\r\n        if block_name not in rs.BlockNames():\r\n            break\r\n\r\n        block_name += \"_new\"\r\n\r\n    return block_name\r\n\r\n\r\nif __name__ == \"__main__\":\r\n    random_blocks_on_srfs()",
  "language": "python",
  "imports": [
    "Rhino",
    "Rhino.Geometry",
    "rhinoscriptsyntax",
    "scriptcontext"
  ],
  "has_docstring": false
}