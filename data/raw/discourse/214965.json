{
  "source_url": "https://discourse.mcneel.com/t/changequeue-how-to-get-the-groundplane-material/214965",
  "topic_id": 214965,
  "title": "ChangeQueue::ApplyGroundPlaneChanges:how to get the groundplane material?",
  "question": "Hi,\n\n\nI’m implementing a custom renderer / change queue and I’m trying to retrieve the actual material assigned by the user in the Ground Plane panel.\n\n\nAt the moment, I can access the ground plane and query its material ID, but I always end up with a default gray material instead of the user-selected one (for example a gold metal).\n\n\nHere is what I currently do:\n\n\nvoid ChangeQueue::ApplyGroundPlaneChanges(const GroundPlane& rhinoGroundPlane) const\n{\n  int materialIndex = -1;\n  ON__UINT32 materialId = rhinoGroundPlane.MaterialId();\n\n  if (materialId != 0)\n  {\n    if (const CRhRdkMaterial* rdkMaterial = MaterialFromId(materialId))\n    {\n#ifdef _DEBUG\n      const ON_Material& simMat = rdkMaterial->SimulatedMaterial();\n      char msg[512];\n      sprintf_s(msg,\n        \"[GroundPlane] Material found via MaterialFromId(%u):\\n\"\n        \"  Diffuse RGB: (%d, %d, %d) -> (%.2f, %.2f, %.2f)\\n\",\n        materialId,\n        simMat.Diffuse().Red(),\n        simMat.Diffuse().Green(),\n        simMat.Diffuse().Blue(),\n        simMat.Diffuse().FractionRed(),\n        simMat.Diffuse().FractionGreen(),\n        simMat.Diffuse().FractionBlue());\n      OutputDebugStringA(msg);\n#endif\n    }\n  }\n}\n\n\n\n\nThe debug output always looks like this:\n\n\n[GroundPlane] Material found via MaterialFromId(2279065610):\nDiffuse RGB: (126, 126, 126) -> (0.49, 0.49, 0.49)\n\n\n\n\nThis appears to be the default gray, regardless of what material is actually selected in the Ground Plane UI.\n\n\nFrom my understanding, the ground plane uses an RDK material instance, not a document material, and I suspect I’m resolving the material incorrectly.\n\n\nWhat is the correct way to retrieve the actual RDK material assigned to the ground plane by the user?\n\nShould this be resolved via \nMaterialInstanceId()\n and RDK APIs instead of a material ID?",
  "code_blocks": [
    {
      "code": "int materialIndex = -1;\n\tON__UINT32 materialId = rhinoGroundPlane.MaterialId();\n\n\tif (materialId != 0)\n\t{\n\t\tif (const CRhRdkMaterial* rdkMaterial = MaterialFromId(materialId))\n\t\t{\n\n#ifdef _DEBUG\nconst ON_Material& simMat = rdkMaterial->SimulatedMaterial();\nchar msg[512];\nsprintf_s(msg,\n“[GroundPlane] Material found via MaterialFromId(%u):\\n”\n\"  Diffuse RGB: (%d, %d, %d) → (%.2f, %.2f, %.2f)\\n\",\nmaterialId,\nsimMat.Diffuse().Red(),\nsimMat.Diffuse().Green(),\nsimMat.Diffuse().Blue(),\nsimMat.Diffuse().FractionRed(),\nsimMat.Diffuse().FractionGreen(),\nsimMat.Diffuse().FractionBlue());\nOutputDebugStringA(msg);\n#endif\n\n#define DBG_PRINTA(fmt, …)                \n{                                           \nchar _buf[1024];                          \nsprintf_s(_buf, sizeof(_buf), fmt, VA_ARGS); \nOutputDebugStringA(_buf);                 \n}\n\n\t\t\tconst CRhinoMaterialTable& mt = that->_rhinoDoc.m_material_table;\n\t\t\tconst int material_count = mt.MaterialCount();\n\t\t\tconst int current_index = mt.CurrentMaterialIndex();\n\t\t\tconst ON_UUID current_id = mt.CurrentMaterialId();\n\n\t\t\twchar_t current_id_w[64]; // Increased buffer size for safety\n\t\t\tON_UuidToString(current_id, current_id_w);\n\t\t\tchar current_id_a[64];\n\t\t\tint result = WideCharToMultiByte(\n\t\t\t\tCP_ACP, 0,\n\t\t\t\tcurrent_id_w, -1,\n\t\t\t\tcurrent_id_a, sizeof(current_id_a),\n\t\t\t\tnullptr, nullptr\n\t\t\t);\n\n\t\t\tif (result == 0)\n\t\t\t{\n\t\t\t\tstrcpy_s(current_id_a, sizeof(current_id_a), \"<conversion failed>\");\n\t\t\t}\n\n\t\t\tDBG_PRINTA(\n\t\t\t\t\"\\n===== MATERIAL TABLE =====\\n\"\n\t\t\t\t\"MaterialCount        : %d\\n\"\n\t\t\t\t\"CurrentMaterialIndex : %d\\n\"\n\t\t\t\t\"CurrentMaterialId    : %s\\n\"\n\t\t\t\t\"==========================\\n\\n\",\n\t\t\t\tmaterial_count,\n\t\t\t\tcurrent_index,\n\t\t\t\tcurrent_id_a\n\t\t\t);\n\n\t\t\tfor (int i = 0; i < material_count; ++i)\n\t\t\t{\n\t\t\t\tconst CRhinoMaterial& mat = mt[i];\n\t\t\t\tconst bool is_deleted = mat.IsDeleted();\n\t\t\t\tconst bool is_reference = mat.IsReferenceComponent();\n\t\t\t\tconst ON_Material& on_mat = mat;\n\t\t\t\tON_Color diffuse = on_mat.Diffuse();\n\t\t\t\tON_Color specular = on_mat.Specular();\n\n\t\t\t\twchar_t id_w[64]; // Increased buffer\n\t\t\t\tON_UuidToString(mat.Id(), id_w);\n\t\t\t\tchar id_a[64];\n\t\t\t\tresult = WideCharToMultiByte(\n\t\t\t\t\tCP_ACP, 0,\n\t\t\t\t\tid_w, -1,\n\t\t\t\t\tid_a, sizeof(id_a),\n\t\t\t\t\tnullptr, nullptr\n\t\t\t\t);\n\n\t\t\t\tif (result == 0)\n\t\t\t\t{\n\t\t\t\t\tstrcpy_s(id_a, sizeof(id_a), \"<conversion failed>\");\n\t\t\t\t}\n\n\t\t\t\tconst bool is_current =\n\t\t\t\t\t(i == current_index) || (mat.Id() == current_id);\n\n\t\t\t\tDBG_PRINTA(\n\t\t\t\t\t\"[Material %d]%s%s\\n\"\n\t\t\t\t\t\"  Name        : %ls\\n\"\n\t\t\t\t\t\"  Id          : %s\\n\"\n\t\t\t\t\t\"  Diffuse RGB : (%3d, %3d, %3d)\\n\"\n\t\t\t\t\t\"  Specular RGB: (%3d, %3d, %3d)\\n\"\n\t\t\t\t\t\"  Transparency: %.3f\\n\"\n\t\t\t\t\t\"  Shine       : %.3f\\n\"\n\t\t\t\t\t\"  Reference   : %s\\n\"\n\t\t\t\t\t\"  Deleted     : %s\\n\"\n\t\t\t\t\t\"  Is Current  : %s\\n\\n\",\n\t\t\t\t\ti,\n\t\t\t\t\tis_deleted ? \" (DELETED)\" : \"\",\n\t\t\t\t\tis_reference ? \" (REFERENCE)\" : \"\",\n\t\t\t\t\tstatic_cast<const wchar_t*>(mat.Name()), // Fixed: explicit cast\n\t\t\t\t\tid_a,\n\t\t\t\t\tdiffuse.Red(), diffuse.Green(), diffuse.Blue(),\n\t\t\t\t\tspecular.Red(), specular.Green(), specular.Blue(),\n\t\t\t\t\ton_mat.Transparency(),\n\t\t\t\t\ton_mat.Shine(),\n\t\t\t\t\tis_reference ? \"true\" : \"false\",\n\t\t\t\t\tis_deleted ? \"true\" : \"false\",\n\t\t\t\t\tis_current ? \"YES\" : \"no\"\n\t\t\t\t);\n\t\t\t}\n\n\t\t}\n\t}",
      "language": "unknown",
      "author": "fatecasino1",
      "post_number": 5,
      "is_solution": false
    }
  ],
  "tags": [
    "materials"
  ],
  "has_accepted_answer": false,
  "category_id": 3,
  "posts_count": 8,
  "views": 80
}