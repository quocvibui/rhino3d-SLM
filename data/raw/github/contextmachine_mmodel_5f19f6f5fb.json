{
  "source_url": "https://github.com/contextmachine/mmodel/blob/0545e5c2a11c641fc54e91f603e709d3dea549f3/connectors/conversions/rhino.py",
  "repo": "contextmachine/mmodel",
  "repo_stars": 0,
  "repo_description": "Deployment branch",
  "license": "Apache-2.0",
  "filepath": "connectors/conversions/rhino.py",
  "instruction": "Copyright (c) 2022. Computational Geometry, Digital Engineering and Optimizing your construction processe\"",
  "code": "#  Copyright (c) 2022. Computational Geometry, Digital Engineering and Optimizing your construction processe\"\nimport json\nimport os\nimport warnings\n\nimport numpy as np\nimport rhino3dm\n\nfrom mm.baseitems import Item\n\n\nclass RhinoBind(Item):\n    source_cls = None\n\n    def __init__(self, *args, **kwargs):\n        super().__init__()\n        self.source = self.source_cls(*args, **kwargs)\n\n\nclass RhDesc:\n    def __set_name__(self, own, name):\n        self.name = name\n\n    def __get__(self, inst, ow=None):\n        return getattr(inst.source, self.name)\n\n    def __set__(self, inst, v):\n        setattr(inst.source, self.name, v)\n\n\nclass RhinoPoint(RhinoBind):\n    source_cls = rhino3dm.Point3d\n    X = RhDesc()\n    Y = RhDesc()\n    Z = RhDesc()\n    DistanceTo = RhDesc()\n\n    @property\n    def xyz(self):\n        return self.X, self.Y, self.Z\n\n    def __str__(self):\n        return f\"RhinoPoint({self.__array__()})\"\n\n    def __repr__(self):\n        return f\"RhinoPoint({self.__array__()})\"\n\n    def __list__(self):\n        return list(self.xyz)\n\n    def __array__(self):\n        return np.array(self.xyz)\n\n    def __sub__(self, other):\n        return self.__class__(self.X - other.X, self.Y - other.Y, self.Z - other.Z)\n\n    def __add__(self, other):\n        return self.__class__(self.X + other.X, self.Y + other.Y, self.Z + other.Z)\n\n\nclass RhinoAxis(RhinoBind):\n    \"\"\"\n    >>> ax = RhinoAxis(RhinoPoint(1, 2, 3), RhinoPoint(12, 2, 3))\n    >>> ax.end\n    RhinoPoint([12.  2.  3.])\n    >>> ax.end.DistanceTo(ax.start.source)\n    11.0\n\n    \"\"\"\n    source_cls = rhino3dm.Line\n    From = RhDesc()\n    To = RhDesc()\n\n    def __init__(self, start, end, **kwargs):\n        super().__init__(start.source, end.source, **kwargs)\n\n    @property\n    def start(self):\n        return RhinoPoint(self.From.X, self.From.Y, self.From.Z)\n\n    @property\n    def end(self):\n        return RhinoPoint(self.To.X, self.To.Y, self.To.Z)\n\n\nclass RhinoCircle(RhinoBind):\n    source_cls = rhino3dm.Circle\n    radius = 1.0\n    Center = RhDesc()\n    Plane = RhDesc()\n\n\nclass RhinoRuledSurf(RhinoBind):\n    source_cls = rhino3dm.NurbsSurface.CreateRuledSurface\n    curve_a = None\n    curve_b = None\n\n    def __init__(self, curve_a, curve_b, **kwargs):\n        super().__init__(curve_a.source.ToNurbsCurve(), curve_b.source.ToNurbsCurve(), **kwargs)\n\n\nclass RhinoBiCone:\n    source_cls = rhino3dm.NurbsSurface.CreateRuledSurface\n    radius_start = 1.0\n    radius_end = 0.5\n    point_start = RhinoPoint(22, 22, -11)\n    point_end = RhinoPoint(1, 0, 1)\n\n    def __init__(self, *args, **kwargs):\n        super().__init__()\n        self.__dict__ |= kwargs\n\n    @property\n    def plane1(self):\n        return rhino3dm.Plane(self.point_start.source,\n                              rhino3dm.Vector3d(*(self.point_end - self.point_start).__array__()))\n\n    @property\n    def plane2(self):\n        return rhino3dm.Plane(self.point_end.source,\n                              rhino3dm.Vector3d(*(self.point_end - self.point_start).__array__()))\n\n    @property\n    def c1(self):\n        T = cg.Transformation.from_frame(\n            cg.Frame.from_plane(\n                cg.Plane(list([self.plane1.Origin.X, self.plane1.Origin.Y, self.plane1.Origin.Z]),\n                         list([self.plane1.ZAxis.X, self.plane1.ZAxis.Y, self.plane1.ZAxis.Z]))))\n        t = rhino3dm.Transform(1.0)\n        c = rhino3dm.Circle(self.radius_start)\n        i, j = np.asarray(T.matrix).shape\n        for ii in range(i):\n            for jj in range(j):\n                setattr(t, f\"M{ii}{jj}\", float(np.asarray(T.matrix)[ii, jj]))\n        # print(t)\n        n = c.ToNurbsCurve()\n        n.Transform(t)\n\n        return n\n\n    @property\n    def c2(self):\n        T = cg.Transformation.from_frame(\n            cg.Frame.from_plane(\n                cg.Plane(list([self.plane2.Origin.X, self.plane2.Origin.Y, self.plane2.Origin.Z]),\n                         list([self.plane2.ZAxis.X, self.plane1.ZAxis.Y, self.plane1.ZAxis.Z]))))\n        t = rhino3dm.Transform(1.0)\n        c = rhino3dm.Circle(self.radius_end)\n\n        i, j = np.asarray(T.matrix).shape\n        for ii in range(i):\n            for jj in range(j):\n                setattr(t, f\"M{ii}{jj}\", float(np.asarray(T.matrix)[ii, jj]))\n        # print(t)\n        n = c.ToNurbsCurve()\n        n.Transform(t)\n        return n\n\n    @property\n    def source(self):\n        return self.source_cls(self.c1, self.c2)\n\n\nimport compas.geometry as cg\n\n\ndef rhino_crv_from_compas(nurbs_curves: list) -> list[\n    rhino3dm.NurbsCurve]:\n    \"\"\"\n    Convert list of compas-like Nurbs curves to Rhino Nurbs Curves\n    :param nurbs_curves:\n    :type\n    :return:\n    :rtype:\n\n    \"\"\"\n\n    return list(map(lambda x: rhino3dm.NurbsCurve.Create(\n        x.is_periodic,\n        x.degree,\n        list(map(lambda y: rhino3dm.Point3d(*y), x.points))), nurbs_curves))\n\n\ndef list_curves_to_polycurves(curves):\n    poly = rhino3dm.PolyCurve()\n    for curve in curves:\n        poly.AppendSegment(curve)\n    return poly\n\n\ndef polyline_from_pts(pts):\n    polyline = rhino3dm.Polyline(0)\n    for pt in pts:\n        polyline.Add(*pt)\n    if polyline.IsValid:\n        return polyline\n    else:\n        warnings.warn(\"InValid Rhino Object\")\n        return polyline\n\n\ndef model_from_json_file(path, modelpath=None):\n    model = rhino3dm.File3dm()\n    pth, _ = path.split(\".\")\n    with open(f\"{path}\", \"r\") as f:\n        for l in json.load(f):\n            l[\"archive3dm\"] = 70\n            model.Objects.Add(rhino3dm.GeometryBase.Decode(l))\n    if modelpath:\n        model.Write(f\"{modelpath}.3dm\", 7)\n    else:\n        model.Write(f\"{pth}.3dm\", 7)\n\n\ndef model_from_dir_obj(directory):\n    model = rhino3dm.File3dm()\n    for path in os.scandir(directory):\n        pth, _ = path.name.split(\".\")\n        with open(f\"{path}\", \"r\") as f:\n            for l in json.load(f):\n                l[\"archive3dm\"] = 70\n                model.Objects.Add(rhino3dm.GeometryBase.Decode(l))\n\n    return model\n\n\ndef model_from_multijson_file(directory, modelpath):\n    model = model_from_dir_obj(directory)\n    model.Write(f\"{modelpath}.3dm\", 7)\n",
  "language": "python",
  "imports": [
    "rhino3dm"
  ],
  "has_docstring": true
}