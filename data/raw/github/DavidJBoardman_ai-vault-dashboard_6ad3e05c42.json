{
  "source_url": "https://github.com/DavidJBoardman/ai-vault-dashboard/blob/511f0a1b5752c2e3a60ecae772526edef92b677a/backend/services/rhino_exporter.py",
  "repo": "DavidJBoardman/ai-vault-dashboard",
  "repo_stars": 0,
  "repo_description": "Project for dashboard for AI vault analysis. Working with TtP team.",
  "license": "unknown",
  "filepath": "backend/services/rhino_exporter.py",
  "instruction": "Service for exporting and importing Rhino 3DM files.\nHandles conversion of intrados lines to/from .3dm format.",
  "code": "\"\"\"\nService for exporting and importing Rhino 3DM files.\nHandles conversion of intrados lines to/from .3dm format.\n\"\"\"\n\nimport json\nfrom pathlib import Path\nfrom typing import List, Dict, Any, Optional, Tuple\nimport numpy as np\n\ntry:\n    import rhino3dm\n    RHINO3DM_AVAILABLE = True\nexcept ImportError:\n    RHINO3DM_AVAILABLE = False\n    print(\"Warning: rhino3dm not installed. 3DM export/import will not be available.\")\n\n\ndef export_intrados_to_3dm(\n    intrados_lines: List[Dict[str, Any]],\n    output_path: str,\n    layer_name: str = \"Intrados Lines\"\n) -> Dict[str, Any]:\n    \"\"\"\n    Export intrados lines to a Rhino 3DM file.\n    \n    Args:\n        intrados_lines: List of intrados line data, each with 'points' array\n        output_path: Path to save the .3dm file\n        layer_name: Name for the layer containing the curves\n        \n    Returns:\n        Dict with success status and info\n    \"\"\"\n    if not RHINO3DM_AVAILABLE:\n        return {\n            \"success\": False,\n            \"error\": \"rhino3dm library not installed. Run: pip install rhino3dm\"\n        }\n    \n    try:\n        # Create a new 3dm file\n        model = rhino3dm.File3dm()\n        \n        # Set units to meters (same as E57 point cloud)\n        model.Settings.ModelUnitSystem = rhino3dm.UnitSystem.Meters\n        \n        # Add a layer for intrados lines\n        layer = rhino3dm.Layer()\n        layer.Name = layer_name\n        layer.Color = (255, 100, 50, 255)  # Orange-ish color\n        layer_index = model.Layers.Add(layer)\n        \n        curves_added = 0\n        \n        for idx, line_data in enumerate(intrados_lines):\n            # Support both \"points3d\" (from intrados_lines.json) and \"points\" formats\n            points = line_data.get(\"points3d\") or line_data.get(\"points\", [])\n            if len(points) < 2:\n                continue\n            \n            # Build list of Point3d objects\n            point3d_list = []\n            for pt in points:\n                # Handle both [x, y, z] array format and {x, y, z} dict format\n                if isinstance(pt, dict):\n                    x, y, z = pt.get(\"x\", 0), pt.get(\"y\", 0), pt.get(\"z\", 0)\n                else:\n                    x, y, z = pt[0], pt[1], pt[2] if len(pt) > 2 else 0\n                point3d_list.append(rhino3dm.Point3d(x, y, z))\n            \n            # Create a polyline curve directly from points\n            curve = rhino3dm.PolylineCurve(point3d_list)\n            \n            # Set object attributes\n            attributes = rhino3dm.ObjectAttributes()\n            attributes.LayerIndex = layer_index\n            # Support both \"label\" and \"maskLabel\" keys\n            attributes.Name = line_data.get(\"label\") or line_data.get(\"maskLabel\", f\"intrados_{idx}\")\n            \n            # Add to model\n            model.Objects.AddCurve(curve, attributes)\n            curves_added += 1\n        \n        # Write to file\n        model.Write(output_path, version=7)  # Version 7 for wide compatibility\n        \n        return {\n            \"success\": True,\n            \"path\": output_path,\n            \"curvesExported\": curves_added,\n            \"message\": f\"Exported {curves_added} intrados curves to {output_path}\"\n        }\n        \n    except Exception as e:\n        return {\n            \"success\": False,\n            \"error\": str(e)\n        }\n\n\ndef import_3dm_curves(\n    file_path: str,\n    layer_filter: Optional[str] = None\n) -> Dict[str, Any]:\n    \"\"\"\n    Import curves from a Rhino 3DM file.\n    \n    Args:\n        file_path: Path to the .3dm file\n        layer_filter: Optional layer name to filter curves (case-insensitive)\n        \n    Returns:\n        Dict with success status and imported curve data\n    \"\"\"\n    if not RHINO3DM_AVAILABLE:\n        return {\n            \"success\": False,\n            \"error\": \"rhino3dm library not installed. Run: pip install rhino3dm\"\n        }\n    \n    try:\n        # Read the 3dm file\n        model = rhino3dm.File3dm.Read(file_path)\n        \n        if model is None:\n            return {\n                \"success\": False,\n                \"error\": f\"Could not read 3DM file: {file_path}\"\n            }\n        \n        # Build layer lookup\n        layer_names = {}\n        for i, layer in enumerate(model.Layers):\n            layer_names[i] = layer.Name\n        \n        curves = []\n        \n        for obj in model.Objects:\n            geometry = obj.Geometry\n            \n            # Check if it's a curve\n            if not isinstance(geometry, (rhino3dm.Curve, rhino3dm.PolylineCurve, rhino3dm.NurbsCurve)):\n                continue\n            \n            # Get layer name\n            layer_idx = obj.Attributes.LayerIndex\n            obj_layer = layer_names.get(layer_idx, \"Default\")\n            \n            # Apply layer filter if specified\n            if layer_filter and layer_filter.lower() not in obj_layer.lower():\n                continue\n            \n            # Extract points from curve\n            points = []\n            \n            # Try to get as polyline first\n            is_polyline, polyline = geometry.TryGetPolyline()\n            \n            if is_polyline and polyline:\n                for i in range(polyline.Count):\n                    pt = polyline[i]\n                    points.append([pt.X, pt.Y, pt.Z])\n            else:\n                # Sample the curve at regular intervals\n                domain = geometry.Domain\n                num_samples = max(50, int(geometry.GetLength() / 0.1))\n                for i in range(num_samples + 1):\n                    t = domain.T0 + (domain.T1 - domain.T0) * (i / num_samples)\n                    pt = geometry.PointAt(t)\n                    points.append([pt.X, pt.Y, pt.Z])\n            \n            if len(points) >= 2:\n                curves.append({\n                    \"id\": f\"imported_{len(curves)}\",\n                    \"name\": obj.Attributes.Name or f\"curve_{len(curves)}\",\n                    \"layer\": obj_layer,\n                    \"points\": points,\n                    \"pointCount\": len(points),\n                    \"source\": \"imported\"\n                })\n        \n        return {\n            \"success\": True,\n            \"curves\": curves,\n            \"curveCount\": len(curves),\n            \"layers\": list(set(layer_names.values())),\n            \"message\": f\"Imported {len(curves)} curves from {file_path}\"\n        }\n        \n    except Exception as e:\n        return {\n            \"success\": False,\n            \"error\": str(e)\n        }\n\n\ndef get_3dm_info(file_path: str) -> Dict[str, Any]:\n    \"\"\"\n    Get information about a 3DM file without fully importing all geometry.\n    \n    Args:\n        file_path: Path to the .3dm file\n        \n    Returns:\n        Dict with file info\n    \"\"\"\n    if not RHINO3DM_AVAILABLE:\n        return {\n            \"success\": False,\n            \"error\": \"rhino3dm library not installed\"\n        }\n    \n    try:\n        model = rhino3dm.File3dm.Read(file_path)\n        \n        if model is None:\n            return {\n                \"success\": False,\n                \"error\": f\"Could not read 3DM file: {file_path}\"\n            }\n        \n        # Count object types\n        curve_count = 0\n        point_count = 0\n        mesh_count = 0\n        other_count = 0\n        \n        for obj in model.Objects:\n            geom = obj.Geometry\n            if isinstance(geom, (rhino3dm.Curve, rhino3dm.PolylineCurve, rhino3dm.NurbsCurve)):\n                curve_count += 1\n            elif isinstance(geom, rhino3dm.Point):\n                point_count += 1\n            elif isinstance(geom, rhino3dm.Mesh):\n                mesh_count += 1\n            else:\n                other_count += 1\n        \n        # Get layers\n        layers = [layer.Name for layer in model.Layers]\n        \n        return {\n            \"success\": True,\n            \"layers\": layers,\n            \"objectCounts\": {\n                \"curves\": curve_count,\n                \"points\": point_count,\n                \"meshes\": mesh_count,\n                \"other\": other_count,\n                \"total\": len(model.Objects)\n            },\n            \"settings\": {\n                \"units\": str(model.Settings.ModelUnitSystem),\n            }\n        }\n        \n    except Exception as e:\n        return {\n            \"success\": False,\n            \"error\": str(e)\n        }\n",
  "language": "python",
  "imports": [
    "rhino3dm"
  ],
  "has_docstring": true
}