{
  "source_url": "https://github.com/jrhe121314/rhino-compute-demo/blob/0ec00779fbd01a92428cd35b4eb7c0c515bcbd13/compute.rhino3d/src/ghhops-server-py/ghhops_server/params.py",
  "repo": "jrhe121314/rhino-compute-demo",
  "repo_stars": 0,
  "repo_description": null,
  "license": "unknown",
  "filepath": "compute.rhino3d/src/ghhops-server-py/ghhops_server/params.py",
  "instruction": "Hops Component Parameter wrappers",
  "code": "\"\"\"Hops Component Parameter wrappers\"\"\"\r\nimport json\r\nfrom enum import Enum\r\nimport inspect\r\nfrom ghhops_server.base import _HopsEncoder\r\nfrom ghhops_server.logger import hlogger\r\n\r\n\r\n__all__ = (\r\n    \"HopsParamAccess\",\r\n    # \"HopsArc\",\r\n    \"HopsBoolean\",\r\n    # \"HopsBox\",\r\n    \"HopsBrep\",\r\n    # \"HopsCircle\",\r\n    # \"HopsColour\",\r\n    # \"HopsComplex\"\r\n    # \"HopsCulture\",\r\n    \"HopsCurve\",\r\n    # \"HopsField\",\r\n    # \"HopsFilePath\",\r\n    # \"HopsGeometry\",\r\n    \"HopsInteger\",\r\n    # \"HopsInterval\",\r\n    # \"HopsInterval2D\"\r\n    \"HopsLine\",\r\n    # \"HopsMatrix\",\r\n    \"HopsMesh\",\r\n    # \"HopsMeshFace\",\r\n    \"HopsNumber\",\r\n    # \"HopsPlane\",\r\n    \"HopsPoint\",\r\n    # \"HopsRectangle\",\r\n    \"HopsString\",\r\n    # \"HopsStructurePath\",\r\n    \"HopsSubD\",\r\n    \"HopsSurface\",\r\n    # \"HopsTime\",\r\n    # \"HopsTransform\",\r\n    \"HopsVector\",\r\n)\r\n\r\n\r\nRHINO = None\r\nRHINO_FROMJSON = None\r\nRHINO_TOJSON = None\r\nRHINO_GEOM = None\r\n\r\n\r\ndef _init_rhinoinside():\r\n    global RHINO\r\n    global RHINO_FROMJSON\r\n    global RHINO_TOJSON\r\n    global RHINO_GEOM\r\n\r\n    # initialize with Rhino.Inside Cpython ==========\r\n    import clr\r\n\r\n    clr.AddReference(\"System.Collections\")\r\n    clr.AddReference(\"Newtonsoft.Json.Rhino\")\r\n    import Newtonsoft.Json as NJ\r\n    from System.Collections.Generic import Dictionary\r\n\r\n    def from_json(json_obj):\r\n        \"\"\"Convert to RhinoCommon from json\"\"\"\r\n        data_dict = Dictionary[str, str]()\r\n        for k, v in json_obj.items():\r\n            data_dict[k] = str(v)\r\n        return RHINO.Runtime.CommonObject.FromJSON(data_dict)\r\n\r\n    def to_json(value):\r\n        \"\"\"Convert RhinoCommon object to json\"\"\"\r\n        return NJ.JsonConvert.SerializeObject(value)\r\n\r\n    RHINO_FROMJSON = from_json\r\n    RHINO_TOJSON = to_json\r\n\r\n    import Rhino\r\n\r\n    RHINO = Rhino\r\n    RHINO_GEOM = Rhino.Geometry\r\n\r\n\r\ndef _init_rhino3dm():\r\n    global RHINO\r\n    global RHINO_FROMJSON\r\n    global RHINO_TOJSON\r\n    global RHINO_GEOM\r\n\r\n    import rhino3dm\r\n\r\n    def from_json(json_obj):\r\n        \"\"\"Convert to rhino3dm from json\"\"\"\r\n        return rhino3dm.CommonObject.Decode(json_obj)\r\n\r\n    def to_json(value):\r\n        \"\"\"Convert rhino3dm object to json\"\"\"\r\n        return json.dumps(value, cls=_HopsEncoder)\r\n\r\n    RHINO_FROMJSON = from_json\r\n    RHINO_TOJSON = to_json\r\n\r\n    RHINO_GEOM = rhino3dm\r\n\r\n\r\nclass HopsParamAccess(Enum):\r\n    \"\"\"GH Item Access\"\"\"\r\n\r\n    ITEM = 0\r\n    LIST = 1\r\n    TREE = 2\r\n\r\n\r\n# TODO:\r\n# - params can have icons too\r\n# cast methods\r\nclass _GHParam:\r\n    coercers = []\r\n    param_type = None\r\n    result_type = None\r\n\r\n    def __init__(\r\n        self,\r\n        name,\r\n        nickname=None,\r\n        desc=None,\r\n        access: HopsParamAccess = HopsParamAccess.ITEM,\r\n        optional=False,\r\n        default=None,\r\n    ):\r\n        self.name = name\r\n        self.nickname = nickname\r\n        self.description = desc\r\n        self.access: HopsParamAccess = access or HopsParamAccess.ITEM\r\n        self.optional = optional\r\n        self.default = default or inspect.Parameter.empty\r\n\r\n    def _coerce_value(self, param_type, param_data):\r\n        # get data as dict\r\n        data = json.loads(param_data)\r\n        # parse data\r\n        if isinstance(self.coercers, dict):\r\n            coercer = self.coercers.get(param_type, None)\r\n            if coercer:\r\n                return coercer(data)\r\n        elif param_type.startswith(\"Rhino.Geometry.\"):\r\n            return RHINO_FROMJSON(data)\r\n        return param_data\r\n\r\n    def encode(self):\r\n        \"\"\"Parameter serializer\"\"\"\r\n        param_def = {\r\n            \"Name\": self.name,\r\n            \"Nickname\": self.nickname,\r\n            \"Description\": self.description,\r\n            \"ParamType\": self.param_type,\r\n            \"ResultType\": self.result_type,\r\n            \"AtLeast\": 1,\r\n        }\r\n        if HopsParamAccess.ITEM == self.access:\r\n            param_def[\"AtMost\"] = 1\r\n        if HopsParamAccess.LIST == self.access:\r\n            param_def[\"AtMost\"] = 2147483647  # Max 32 bit integer value\r\n        if HopsParamAccess.TREE == self.access:\r\n            param_def[\"AtLeast\"] = -1\r\n            param_def[\"AtMost\"] = -1\r\n        if self.default != inspect.Parameter.empty:\r\n            param_def[\"Default\"] = self.default\r\n        return param_def\r\n\r\n    def from_input(self, input_data):\r\n        \"\"\"Extract parameter data from serialized input\"\"\"\r\n        if self.access == HopsParamAccess.TREE:\r\n            paths = input_data[\"InnerTree\"]\r\n            tree = {}\r\n            for k, v in paths.items():\r\n                data = []\r\n                for param_value_item in v:\r\n                    param_type = param_value_item[\"type\"]\r\n                    param_value = param_value_item[\"data\"]\r\n                    data.append(self._coerce_value(param_type, param_value))\r\n                tree[k] = data\r\n            return tree\r\n\r\n        data = []\r\n        for param_value_item in input_data[\"InnerTree\"][\"0\"]:\r\n            param_type = param_value_item[\"type\"]\r\n            param_value = param_value_item[\"data\"]\r\n            data.append(self._coerce_value(param_type, param_value))\r\n        if self.access == HopsParamAccess.ITEM:\r\n            return data[0]\r\n        return data\r\n\r\n    def from_result(self, value):\r\n        \"\"\"Serialize parameter with given value for output\"\"\"\r\n        if not isinstance(value, tuple) and not isinstance(value, list):\r\n            value = (value,)\r\n\r\n        output_list = [\r\n            {\r\n                \"type\": self.result_type,\r\n                \"data\": RHINO_TOJSON(v)\r\n            } for v in value\r\n        ]\r\n\r\n        output = {\r\n            \"ParamName\": self.name,\r\n            \"InnerTree\": {\r\n                \"0\": output_list\r\n            },\r\n        }\r\n        return output\r\n\r\n\r\nclass HopsBoolean(_GHParam):\r\n    \"\"\"Wrapper for GH_Boolean\"\"\"\r\n\r\n    param_type = \"Boolean\"\r\n    result_type = \"System.Boolean\"\r\n\r\n    coercers = {\"System.Boolean\": lambda b: bool(b)}\r\n\r\n\r\nclass HopsBrep(_GHParam):\r\n    \"\"\"Wrapper for GH Brep\"\"\"\r\n\r\n    param_type = \"Brep\"\r\n    result_type = \"Rhino.Geometry.Brep\"\r\n\r\n\r\nclass HopsCurve(_GHParam):\r\n    \"\"\"Wrapper for GH Curve\"\"\"\r\n\r\n    param_type = \"Curve\"\r\n    result_type = \"Rhino.Geometry.Curve\"\r\n\r\n\r\nclass HopsInteger(_GHParam):\r\n    \"\"\"Wrapper for GH_Integer\"\"\"\r\n\r\n    param_type = \"Integer\"\r\n    result_type = \"System.Int32\"\r\n\r\n    coercers = {\"System.Int32\": lambda i: int(i)}\r\n\r\n\r\nclass HopsLine(_GHParam):\r\n    \"\"\"Wrapper for GH_Line\"\"\"\r\n\r\n    param_type = \"Line\"\r\n    result_type = \"Rhino.Geometry.Line\"\r\n\r\n    coercers = {\r\n        \"Rhino.Geometry.Line\": lambda l: RHINO_GEOM.Line(\r\n            HopsLine._make_point(l[\"From\"]), HopsLine._make_point(l[\"To\"])\r\n        )\r\n    }\r\n\r\n    @staticmethod\r\n    def _make_point(a):\r\n        return RHINO_GEOM.Point3d(a[\"X\"], a[\"Y\"], a[\"Z\"])\r\n\r\n\r\nclass HopsMesh(_GHParam):\r\n    \"\"\"Wrapper for GH Mesh\"\"\"\r\n\r\n    param_type = \"Mesh\"\r\n    result_type = \"Rhino.Geometry.Mesh\"\r\n\r\n\r\nclass HopsNumber(_GHParam):\r\n    \"\"\"Wrapper for GH Number\"\"\"\r\n\r\n    param_type = \"Number\"\r\n    result_type = \"System.Double\"\r\n\r\n    coercers = {\r\n        \"System.Double\": lambda d: float(d),\r\n    }\r\n\r\n\r\nclass HopsPoint(_GHParam):\r\n    \"\"\"Wrapper for GH Point\"\"\"\r\n\r\n    param_type = \"Point\"\r\n    result_type = \"Rhino.Geometry.Point3d\"\r\n\r\n    coercers = {\r\n        \"Rhino.Geometry.Point2d\": lambda d: RHINO_GEOM.Point2d(d[\"X\"], d[\"Y\"]),\r\n        \"Rhino.Geometry.Point3d\": lambda d: RHINO_GEOM.Point3d(\r\n            d[\"X\"], d[\"Y\"], d[\"Z\"]\r\n        ),\r\n        \"Rhino.Geometry.Vector3d\": lambda d: RHINO_GEOM.Vector3d(\r\n            d[\"X\"], d[\"Y\"], d[\"Z\"]\r\n        ),\r\n    }\r\n\r\n\r\nclass HopsString(_GHParam):\r\n    \"\"\"Wrapper for GH_String\"\"\"\r\n\r\n    param_type = \"Text\"\r\n    result_type = \"System.String\"\r\n\r\n    coercers = {\"System.String\": lambda s: s}\r\n\r\n\r\nclass HopsSubD(_GHParam):\r\n    \"\"\"Wrapper for GH SubD\"\"\"\r\n\r\n    param_type = \"SubD\"\r\n    result_type = \"Rhino.Geometry.SubD\"\r\n\r\n\r\nclass HopsSurface(_GHParam):\r\n    \"\"\"Wrapper for GH Surface\"\"\"\r\n\r\n    param_type = \"Surface\"\r\n    result_type = \"Rhino.Geometry.Brep\"\r\n\r\n\r\nclass HopsVector(_GHParam):\r\n    \"\"\"Wrapper for GH Vector\"\"\"\r\n\r\n    param_type = \"Vector\"\r\n    result_type = \"Rhino.Geometry.Vector3d\"\r\n\r\n    coercers = {\r\n        \"Rhino.Geometry.Point2d\": lambda d: RHINO_GEOM.Point2d(d[\"X\"], d[\"Y\"]),\r\n        \"Rhino.Geometry.Point3d\": lambda d: RHINO_GEOM.Point3d(\r\n            d[\"X\"], d[\"Y\"], d[\"Z\"]\r\n        ),\r\n        \"Rhino.Geometry.Vector3d\": lambda d: RHINO_GEOM.Vector3d(\r\n            d[\"X\"], d[\"Y\"], d[\"Z\"]\r\n        ),\r\n    }\r\n",
  "language": "python",
  "imports": [
    "Rhino",
    "Rhino.Geometry",
    "RhinoCommon",
    "rhino3dm"
  ],
  "has_docstring": true
}