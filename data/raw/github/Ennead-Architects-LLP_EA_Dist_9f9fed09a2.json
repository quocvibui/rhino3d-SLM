{
  "source_url": "https://github.com/Ennead-Architects-LLP/EA_Dist/blob/635520d89b8308b78eabf5b60bb80121d0fa3838/Apps/_rhino/Lab.tab/text2script.button/text2script_left.py",
  "repo": "Ennead-Architects-LLP/EA_Dist",
  "repo_stars": 0,
  "repo_description": null,
  "license": "unknown",
  "filepath": "Apps/_rhino/Lab.tab/text2script.button/text2script_left.py",
  "instruction": "Text2script left",
  "code": "#! python3\r\n\r\n# r: openai\r\nimport rhinoscriptsyntax as rs\r\nimport sys\r\nfrom typing import Optional\r\nfrom pathlib import Path\r\nfrom datetime import datetime\r\nimport time\r\nimport traceback\r\nimport os\r\nimport subprocess\r\n# IronPython 2.7 compatibility - use imp instead of importlib.util\r\ntry:\r\n    import importlib.util\r\n    HAS_IMPORTLIB = True\r\nexcept ImportError:\r\n    import imp\r\n    HAS_IMPORTLIB = False\r\n\r\nfrom openai import OpenAI\r\n\r\ndef add_path():\r\n    \"\"\"Add Rhino's Python search paths to sys.path.\"\"\"\r\n    for path in rs.SearchPathList():\r\n        sys.path.append(path)\r\n\r\nadd_path()\r\nfrom EnneadTab import FOLDER, SECRET, NOTIFICATION, DATA_FILE, SOUND, ERROR_HANDLE\r\n\r\n__title__ = \"Text2Script\"\r\n__doc__ = \"\"\"Utility script to convert text to script using AI.\r\n\r\nNote: This is Rhino 8 only.\r\n\r\nFeatures:\r\n- Converts natural language to executable Python script\r\n- Integrated with Rhino's rhinoscriptsyntax\r\n- Maximum 5 refinement attempts for optimal results\r\n- Always uses main() as the entry function\r\n- Modern error handling and user feedback\r\n\"\"\"\r\n\r\nclass TextToScriptConverter:\r\n    \"\"\"Converts natural language requests into executable Rhino Python scripts using OpenAI.\"\"\"\r\n    \r\n    def __init__(self):\r\n        \"\"\"Initialize the converter with API key and configuration.\"\"\"\r\n        self.max_attempts = 5\r\n        self.api_key = SECRET.get_openai_api_key(\"EnneadTabAPI\")\r\n        self.client = OpenAI(api_key=self.api_key)\r\n        self.temp_filepath = FOLDER.get_local_dump_folder_file(\"text2script_TEMP.py\")\r\n        self.preset = self._get_system_preset()\r\n        \r\n    def _get_system_preset(self) -> str:\r\n        \"\"\"Get the system preset for OpenAI API.\"\"\"\r\n        return \"\"\"\r\n        You are a specialized Python code generator for Rhino 8, focused on creating executable scripts.\r\n        \r\n        IMPORTANT REQUIREMENTS:\r\n        1. Return ONLY pure Python code - no markdown, no code blocks, no explanations\r\n        2. Code must be complete, self-contained, and immediately executable\r\n        3. Include proper error handling and input validation\r\n        4. Use descriptive variable names and add clear comments\r\n        5. Follow PEP 8 style guidelines\r\n        6. Include docstring for main functions\r\n        7. ALWAYS include a main() function that serves as the entry point\r\n        8. At the end of your code, include: if __name__ == \"__main__\": main()\r\n        \r\n        TECHNICAL SPECIFICATIONS:\r\n        - Target Environment: Rhino 8 Python\r\n        - Primary API: Rhino Common (https://developer.rhino3d.com/api/rhinocommon/)\r\n        - Reference Examples: https://github.com/mcneel/rhino-developer-samples/tree/master/rhinopython\r\n        \r\n        COMMON IMPORTS TO CONSIDER:\r\n        - import rhinoscriptsyntax as rs\r\n        - import Rhino\r\n        - import System.Drawing\r\n        \r\n        BEST PRACTICES:\r\n        - Include input validation\r\n        - Add error messages for user feedback\r\n        - Implement proper cleanup of resources\r\n        - Structure code in logical functions\r\n        - When asked about using color, use color tuple (r,g,b), and rhinoscriptsyntax will have something to make good color\r\n        - ALWAYS use a main() function as the entry point\r\n        \r\n        Remember: Output must be pure Python code only, ready for direct execution.\r\n        \"\"\"\r\n    \r\n    def check_api_quota(self) -> bool:\r\n        \"\"\"Check if OpenAI API key is valid.\r\n        \r\n        Returns:\r\n            bool: True if API key is valid, False otherwise\r\n        \"\"\"\r\n        try:\r\n            self.client.models.list()\r\n            print(\"Your API key is valid and ready to use.\")\r\n            return True\r\n        except Exception as e:\r\n            error_str = str(e)\r\n            if \"401\" in error_str or \"authentication\" in error_str.lower():\r\n                message = \"Your API key appears to be invalid or expired.\"\r\n            else:\r\n                message = f\"Error checking API key: {error_str}\"\r\n            \r\n            rs.MessageBox(message, title=\"OpenAI API Status\")\r\n            return False\r\n\r\n    def get_user_request(self) -> Optional[str]:\r\n        \"\"\"Get user input for script generation.\r\n        \r\n        Returns:\r\n            Optional[str]: User's request or None if cancelled\r\n        \"\"\"\r\n        prev_session = DATA_FILE.get_sticky(\"text2script_session\", \"Write your dream here.\")\r\n        request = rs.StringBox(\"Enter the function request:\", title=\"Text2Script\", default_value=prev_session)\r\n        \r\n        if not request or request.strip() == \"\":\r\n            rs.MessageBox(\"No input provided. Operation cancelled.\")\r\n            return None\r\n            \r\n        DATA_FILE.set_sticky(\"text2script_session\", request.strip())\r\n        return request.strip()\r\n\r\n    def generate_code(self, request: str) -> str:\r\n        \"\"\"Generate Python code from user request.\r\n        \r\n        Args:\r\n            request (str): User's natural language request\r\n            \r\n        Returns:\r\n            str: Generated Python code\r\n            \r\n        Raises:\r\n            ValueError: If AI returns empty response or quota exceeded\r\n            Exception: For other generation errors\r\n        \"\"\"\r\n        try:\r\n            response = self.client.chat.completions.create(\r\n                model=\"gpt-4-turbo-preview\",\r\n                messages=[\r\n                    {\"role\": \"system\", \"content\": self.preset},\r\n                    {\"role\": \"user\", \"content\": request}\r\n                ],\r\n                temperature=0.2\r\n            )\r\n            generated_code = response.choices[0].message.content\r\n\r\n            # Clean up code formatting\r\n            generated_code = self._clean_code_formatting(generated_code)\r\n            \r\n            if not generated_code or generated_code.strip() == \"\":\r\n                raise ValueError(\"AI returned empty response\")\r\n                \r\n            # Ensure proper code structure\r\n            generated_code = self._ensure_code_structure(generated_code)\r\n            \r\n            return generated_code.strip()\r\n            \r\n        except Exception as e:\r\n            error_str = str(e)\r\n            if \"429\" in error_str or \"quota\" in error_str.lower() or \"insufficient_quota\" in error_str:\r\n                raise ValueError(\"OpenAI quota exceeded - Please check your account\")\r\n            else:\r\n                rs.MessageBox(f\"Failed to generate code: {error_str}\")\r\n                raise\r\n\r\n    def _clean_code_formatting(self, code: str) -> str:\r\n        \"\"\"Clean up code formatting by removing markdown wrappers.\"\"\"\r\n        if \"```python\" in code:\r\n            code = code.replace(\"```python\", \"\")\r\n        if \"```\" in code:\r\n            code = code.replace(\"```\", \"\")\r\n        return code\r\n\r\n    def _ensure_code_structure(self, code: str) -> str:\r\n        \"\"\"Ensure code has proper structure with main() function and entry point.\"\"\"\r\n        if \"def main(\" not in code:\r\n            code = self._add_main_function(code)\r\n            \r\n        if \"if __name__ == \\\"__main__\\\"\" not in code and \"if __name__ == '__main__'\" not in code:\r\n            code += \"\\n\\nif __name__ == \\\"__main__\\\":\\n    main()\\n\"\r\n            \r\n        return code\r\n\r\n    def _add_main_function(self, code: str) -> str:\r\n        \"\"\"Add main function to code if missing.\"\"\"\r\n        main_function = \"\\n\\ndef main():\\n    # Main function added by Text2Script\\n    # Your code entry point\\n    \"\r\n        \r\n        # Find top-level code to move into main\r\n        import re\r\n        function_pattern = r\"def\\s+\\w+\\s*\\(\"\r\n        lines = code.split(\"\\n\")\r\n        execution_lines = []\r\n        \r\n        for i, line in enumerate(lines):\r\n            if re.match(function_pattern, line.strip()):\r\n                # Skip until end of function\r\n                indentation = len(line) - len(line.lstrip())\r\n                j = i + 1\r\n                while j < len(lines) and (not lines[j].strip() or len(lines[j]) - len(lines[j].lstrip()) > indentation):\r\n                    j += 1\r\n                i = j - 1\r\n            elif line.strip() and not line.strip().startswith(\"#\") and not line.strip().startswith(\"import\") and not line.strip().startswith(\"from\"):\r\n                execution_lines.append(line)\r\n        \r\n        if execution_lines:\r\n            main_function += \"\\n    # Incorporating top-level code into main function\\n    \" + \"\\n    \".join(execution_lines)\r\n            # Remove the top-level code from the original code\r\n            for line in execution_lines:\r\n                code = code.replace(line, \"\")\r\n            code = code.strip()\r\n        \r\n        return code + main_function\r\n\r\n    def save_script(self, script_content: str, request: str, is_temporary: bool = True) -> Optional[Path]:\r\n        \"\"\"Save script to file and open it in editor.\r\n        \r\n        Args:\r\n            script_content (str): Generated script content\r\n            request (str): Original user request\r\n            is_temporary (bool): If True, saves as temp file and opens in VSCode.\r\n                               If False, saves as timestamped file and opens in default editor.\r\n            \r\n        Returns:\r\n            Optional[Path]: Path to saved file if successful, None if failed\r\n        \"\"\"\r\n        try:\r\n            if is_temporary:\r\n                filepath = Path(self.temp_filepath)\r\n                header = \"Generated from Text2Script (TEMPORARY VERSION)\"\r\n            else:\r\n                timestamp = datetime.now().strftime(\"%Y%m%d_%H%M%S\")\r\n                filename = f\"text2script_{timestamp}.py\"\r\n                filepath = Path(FOLDER.get_local_dump_folder_file(filename))\r\n                header = \"Generated from Text2Script\"\r\n\r\n            request_string = \"\\n\".join(f\"# {line}\" for line in request.split(\"\\n\"))\r\n            \r\n            content = f\"\"\"# {header}\r\n# Original request: \r\n{request_string}\r\n# Generated on: {datetime.now()}\r\n\r\n{script_content}\"\"\"\r\n            \r\n            filepath.write_text(content, encoding='utf-8')\r\n            \r\n            try:\r\n                # Try to open in VSCode first\r\n                vscode_paths = [\r\n                    Path.home() / \"AppData\" / \"Local\" / \"Programs\" / \"Microsoft VS Code\" / \"Code.exe\",\r\n                    Path(\"C:/Program Files/Microsoft VS Code/Code.exe\"),\r\n                    Path(\"C:/Program Files (x86)/Microsoft VS Code/Code.exe\")\r\n                ]\r\n                \r\n                vscode_path = next((path for path in vscode_paths if path.exists()), None)\r\n                \r\n                if vscode_path:\r\n                    subprocess.Popen([str(vscode_path), str(filepath)])\r\n                else:\r\n                    os.startfile(str(filepath))\r\n            except Exception:\r\n                os.startfile(str(filepath))\r\n   \r\n            return filepath\r\n        except Exception as e:\r\n            rs.MessageBox(f\"Failed to save script: {str(e)}\")\r\n            return None\r\n\r\n    def create_refinement_request(self, original_request: str, error: Exception) -> str:\r\n        \"\"\"Create a refined request based on previous error.\r\n        \r\n        Args:\r\n            original_request (str): Original user request\r\n            error (Exception): Error from previous attempt\r\n            \r\n        Returns:\r\n            str: Refined request for next attempt\r\n        \"\"\"\r\n        if not error:\r\n            return original_request\r\n            \r\n        return f\"\"\"\r\n        The previous code generated resulted in the following error:\r\n        {str(error)}\r\n        \r\n        Please fix the code and provide a corrected version.\r\n        IMPORTANT: Make sure to include a main() function as the entry point for the script.\r\n        Original request: {original_request}\r\n        \"\"\"\r\n\r\n    def run(self) -> None:\r\n        \"\"\"Main execution method for the converter.\"\"\"\r\n        try:\r\n            if not self.check_api_quota():\r\n                return\r\n\r\n            func_request = self.get_user_request()\r\n            if not func_request:\r\n                return\r\n\r\n            current_attempt = 0\r\n            last_error = None\r\n            \r\n            while current_attempt < self.max_attempts:\r\n                try:\r\n                    generated_code = self.generate_code(func_request)\r\n                    # Save and open temporary version\r\n                    self.save_script(generated_code, func_request, is_temporary=True)\r\n                    \r\n                    # Execute the script\r\n                    if HAS_IMPORTLIB:\r\n                        spec = importlib.util.spec_from_file_location(\"text2script\", str(self.temp_filepath))\r\n                        module = importlib.util.module_from_spec(spec)\r\n                        spec.loader.exec_module(module)\r\n                    else:\r\n                        # IronPython 2.7 compatibility for imp\r\n                        module_name = \"text2script\"\r\n                        module_path = str(self.temp_filepath)\r\n                        module_file, module_path, module_desc = imp.find_module(module_name, [os.path.dirname(module_path)])\r\n                        module = imp.load_module(module_name, module_file, module_path, module_desc)\r\n\r\n                    if hasattr(module, 'main'):\r\n                        module.main()\r\n                    else:\r\n                        raise AttributeError(\"The generated script does not contain a main() function. Please try again.\")\r\n                    \r\n                    saved_path = self.save_script(generated_code, func_request, is_temporary=False)\r\n                    if saved_path:\r\n                        rs.MessageBox(f\"Script executed successfully and saved to:\\n{saved_path}\")\r\n                    break\r\n                    \r\n                except ValueError as e:\r\n                    if \"OpenAI quota exceeded\" in str(e):\r\n                        return\r\n                \r\n                except Exception as e:\r\n                    current_attempt += 1\r\n                    last_error = traceback.format_exc()\r\n                    \r\n                    if current_attempt >= self.max_attempts:\r\n                        NOTIFICATION.messenger(f\"Maximum refinement attempts reached.\\nLast error: {last_error}\")\r\n                        return\r\n                        \r\n                    func_request = self.create_refinement_request(func_request, e)\r\n                    NOTIFICATION.messenger(f\"Attempt: {current_attempt} of {self.max_attempts}\\nLast error: {last_error}\")\r\n                    SOUND.play_error_sound()\r\n                    time.sleep(0.1)\r\n                \r\n        except Exception as e:\r\n            rs.MessageBox(f\"Critical error occurred: {str(e)}\")\r\n            raise\r\n\r\ndef text2script() -> None:\r\n    \"\"\"Main entry point for Text2Script functionality.\"\"\"\r\n    if rs.ExeVersion() < 8:\r\n        NOTIFICATION.messenger(\"Please upgrade to Rhino 8 to use Text2Script.\")\r\n        return\r\n        \r\n    converter = TextToScriptConverter()\r\n    converter.run()\r\n    SOUND.play_finished_sound()\r\n\r\n\r\n@ERROR_HANDLE.try_catch_error()\r\ndef text2script_left() -> None:\r\n    \"\"\"Standalone function to check OpenAI API key validity.\"\"\"\r\n    converter = TextToScriptConverter()\r\n    if converter.check_api_quota():\r\n        converter.run()\r\n\r\nif __name__ == \"__main__\":\r\n    text2script_left()\r\n",
  "language": "python",
  "imports": [
    "rhinoscriptsyntax"
  ],
  "has_docstring": false
}