{
  "source_url": "https://github.com/lokiCC/Working/blob/29238c1efd381720b0264682220bec1356845033/moin-1.9.7/MoinMoin/action/SubscribeUser.py",
  "repo": "lokiCC/Working",
  "repo_stars": 0,
  "repo_description": "Web Apps",
  "license": "NOASSERTION",
  "filepath": "moin-1.9.7/MoinMoin/action/SubscribeUser.py",
  "instruction": "MoinMoin - Subscribeuser - Action\n   Subscribe (or unsubscribe) a user to a page.",
  "code": "\"\"\"\n   MoinMoin - Subscribeuser - Action\n   Subscribe (or unsubscribe) a user to a page.\n\n   @copyright: 2003 Daniela Nicklas <nicklas@informatik.uni-stuttgart.de>,\n               2005 MoinMoin:AlexanderSchremmer,\n               2009 MoinMoin:ThomasWaldmann\n   @license: GNU GPL, see COPYING for details.\n\"\"\"\n\nimport sys, os, re\n\nfrom MoinMoin.Page import Page\nfrom MoinMoin import user\nfrom MoinMoin import wikiutil\n\n\ndef show_form(pagename, request):\n    _ = request.getText\n    request.theme.send_title(_(\"Subscribe users to the page %s\") % pagename, pagename=pagename)\n\n    request.write(\"\"\"\n<form action=\"%s\" method=\"POST\" enctype=\"multipart/form-data\">\n<input type=\"hidden\" name=\"action\" value=\"SubscribeUser\">\n%s <input type=\"text\" name=\"users\" size=\"50\">\n<input type=\"submit\" value=\"Subscribe\">\n</form>\n\"\"\" % (request.href(pagename),\n      _(\"Enter user names (comma separated):\")))\n    request.theme.send_footer(pagename)\n    request.theme.send_closing_html()\n\n\ndef parse_re(usernames):\n    username_regexes = []\n    for name in usernames:\n        if name.startswith(\"re:\"):\n            name = name[3:]\n        else:\n            name = re.escape(name)\n        username_regexes.append(name)\n    return username_regexes\n\n\ndef parse_userlist(usernames):\n    subscribe = []\n    unsubscribe = []\n    for name in usernames:\n        if name.startswith(\"-\"):\n            unsubscribe.append(name[1:])\n        elif name.startswith(\"+\"):\n            subscribe.append(name[1:])\n        else:\n            subscribe.append(name)\n    return parse_re(subscribe), parse_re(unsubscribe)\n\n\ndef show_result(pagename, request):\n    _ = request.getText\n\n    request.theme.send_title(_(\"Subscribed for %s:\") % pagename, pagename=pagename)\n\n    from MoinMoin.formatter.text_html import Formatter\n    formatter = Formatter(request)\n\n    usernames = request.form['users'].split(\",\")\n    subscribe, unsubscribe = parse_userlist(usernames)\n\n    result = subscribe_users(request, subscribe, unsubscribe, pagename, formatter)\n    request.write(result)\n\n    request.theme.send_footer(pagename)\n    request.theme.send_closing_html()\n\n\ndef subscribe_users(request, subscribe, unsubscribe, pagename, formatter):\n    _ = request.getText\n\n    if not Page(request, pagename).exists():\n        return u\"Page does not exist.\"\n\n    result = []\n    did_match = {}\n\n    # get user object - only with IDs!\n    for userid in user.getUserList(request):\n        userobj = user.User(request, userid)\n        name = userobj.name\n\n        matched = subscribed = False\n\n        for name_re in unsubscribe:\n            if re.match(name_re, name, re.U):\n                matched = did_match[name_re] = True\n                if (not userobj.isSubscribedTo([pagename]) or\n                    userobj.unsubscribe(pagename)):\n                    subscribed = False\n                break\n\n        for name_re in subscribe:\n            if re.match(name_re, name, re.U):\n                matched = did_match[name_re] = True\n                if (userobj.isSubscribedTo([pagename]) or\n                    (userobj.email or userobj.jid) and userobj.subscribe(pagename)):\n                    subscribed = True\n                break\n\n        if matched:\n            result.extend([formatter.smiley(subscribed and '{*}' or '{o}'),\n                           formatter.text(\" \"),\n                           formatter.url(1, Page(request, name).url(request)),\n                           formatter.text(name),\n                           formatter.url(0),\n                           formatter.linebreak(preformatted=0),\n                          ])\n\n    result.extend([''.join([formatter.smiley('{X}'),\n                            formatter.text(\" \" + _(\"Not a user:\") + \" \" + name_re),\n                            formatter.linebreak(preformatted=0)])\n                   for name_re in subscribe + unsubscribe if name_re not in did_match])\n\n    return ''.join(result)\n\n\ndef execute(pagename, request):\n    _ = request.getText\n    if not request.user.may.admin(pagename):\n        thispage = Page(request, pagename)\n        request.theme.add_msg(_(\"You are not allowed to perform this action.\"), \"error\")\n        return thispage.send_page()\n    elif 'users' not in request.form:\n        show_form(pagename, request)\n    else:\n        show_result(pagename, request)\n\n\nif __name__ == '__main__':\n    args = sys.argv\n    if len(args) < 2:\n        print >>sys.stderr, \"\"\"Subscribe users\n\n%(myname)s pagename [+|-][re:]username[,username[,username[,...]]] [URL]\n\n+username: subscribes user <username> to page <pagename>.\n-username: unsubscribes user <username> from page <pagename>.\n+re:username_re: subscribes users who match <username_re> regex.\n-re:username_re: unsubscribes users who match <username_re> regex.\n\nURL is just needed for a farmconfig scenario.\n\nExample:\n%(myname)s FrontPage TestUser,MatthewSimpson\n\n\"\"\" % {\"myname\": os.path.basename(args[0])}\n        raise SystemExit\n\n    pagename = args[1]\n    usernames = args[2].split(\",\")\n\n    if len(args) > 3:\n        request_url = args[3]\n    else:\n        request_url = None\n\n    # Setup MoinMoin environment\n    from MoinMoin.web.contexts import ScriptContext\n    request = ScriptContext(url=request_url)\n\n    from MoinMoin.formatter.text_plain import Formatter\n    formatter = Formatter(request)\n\n    subscribe, unsubscribe = parse_userlist(usernames)\n\n    print subscribe_users(request, subscribe, unsubscribe, pagename, formatter)\n\n",
  "language": "python",
  "imports": [],
  "has_docstring": true
}