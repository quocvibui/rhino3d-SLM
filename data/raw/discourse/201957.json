{
  "source_url": "https://discourse.mcneel.com/t/cgal-on-rhino8-scripteditor/201957",
  "topic_id": 201957,
  "title": "CGAL on Rhino8 ScriptEditor",
  "question": "Hi,\n\n\nI recently made \ncompas_cgal\n available for the Rhino 8 Script Editor.\n\nIt should generally work on most Mac, Windows, and Linux systems (outside Rhino).\n\n\nHere are some examples: \nExamples — COMPAS CGAL\n\n\nA GitHub Action builds this package for Python from 3.9 to 3.13 and uploads it to PyPI.\n\nTherefore, the simple \n#r:\n tag should be the only command needed to install it.\n\n\nI would be grateful if anyone could test whether it works. Here is a sample script for the ScriptEditor:\n\n\n\n#! python3\n# r: compas, compas_cgal\n\nfrom compas.geometry import Box\nfrom compas.geometry import Polyhedron\nfrom compas.geometry import Sphere\nfrom compas.datastructures import Mesh\nfrom compas_cgal.booleans import (\nboolean_difference_mesh_mesh,\nboolean_intersection_mesh_mesh,\nboolean_union_mesh_mesh,\nsplit_mesh_mesh,\n)\n\nfrom compas_cgal.meshing import mesh_remesh\nfrom compas.scene import Scene\nbox = Box(2)\n\nA = box.to_vertices_and_faces(triangulated=True)\n\nsphere = Sphere(1, point=[1, 1, 1])\n\nB = sphere.to_vertices_and_faces(u=64, v=64, triangulated=True)\n\nB = mesh_remesh(B, 0.3, 50)\nV, F = boolean_difference_mesh_mesh(A, B)\n\nshape = Polyhedron(V.tolist(), F.tolist())\nshape = shape.to_mesh()\n\nscene = Scene()\nscene.clear_context()\nscene.add(shape)\nscene.draw()\n\n\n\nIt remeshes a sphere and performs mesh boolean-difference:\n\n\nimage\n1920×1139 162 KB\n\n\nP.S. if anyone wants to contribute to compas_cgal package or just curious how the binding C++ to Python works, I am happy to share the little details behind this process \n\n\n@eirannejad\n ScriptEditor is really great and helps to bring a lot of things, we could not do before, thanks!",
  "code_blocks": [
    {
      "code": "import rhinoscriptsyntax as rs\n\nimport scriptcontext as sc\n\nfrom compas.datastructures import Mesh\n\nfrom compas_cgal.booleans import boolean_difference_mesh_mesh\n\nfrom compas_rhino.conversions import mesh_to_compas, mesh_to_rhino\n\nimport Rhino.Geometry as rg\n\n\n\n\n\ndef clean_rhino_mesh(mesh):\n\n    \"\"\"\n\n    Cleans and optimizes Rhino mesh before boolean operations.\n\n    Equivalent to C# CleanRhinoMesh method.\n\n    \n\n    Args:\n\n        mesh: Rhino.Geometry.Mesh object\n\n    \"\"\"\n\n    # Weld vertices with tolerance\n\n    mesh.Weld(3.14)\n\n    \n\n    # Combine identical vertices\n\n    mesh.Vertices.CombineIdentical(True, True)\n\n    \n\n    # Remove unused vertices\n\n    mesh.Vertices.CullUnused()\n\n    \n\n    # Unify normal directions\n\n    mesh.UnifyNormals()\n\n    \n\n    # Compute face normals\n\n    mesh.FaceNormals.ComputeFaceNormals()\n\n    \n\n    # Compute vertex normals\n\n    mesh.Normals.ComputeNormals()\n\n    \n\n    # Compact mesh data structure\n\n    mesh.Compact()\n\n    \n\n    print(f\"Mesh cleaned: {mesh.Vertices.Count} vertices, {mesh.Faces.Count} faces\")\n\n\n\n\n\ndef boolean_difference_rhino_meshes():\n\n    \"\"\"\n\n    Performs sequential boolean difference operations between one base mesh and multiple cutters.\n\n    First, select the base mesh, then select multiple cutter meshes.\n\n    \"\"\"\n\n    # Крок 1: Вибір основного меша (1 деталь)\n\n    mesh_guid_main = rs.GetObject(\n\n        \"Select the main Mesh (1 object)\",\n\n        filter=rs.filter.mesh,\n\n        preselect=True\n\n    )\n\n    \n\n    if not mesh_guid_main:\n\n        print(\"Main mesh not selected\")\n\n        return\n\n    \n\n    # Крок 2: Вибір кількох мешів-різців (cutters)\n\n    mesh_guids_cutters = rs.GetObjects(\n\n        \"Select Cutter meshes (multiple objects allowed)\",\n\n        filter=rs.filter.mesh,\n\n        preselect=False\n\n    )\n\n    \n\n    if not mesh_guids_cutters:\n\n        print(\"No cutters selected\")\n\n        return\n\n    \n\n    print(f\"Selected: 1 main mesh and {len(mesh_guids_cutters)} cutter(s)\")\n\n    \n\n    # Крок 3: Підготовка основного меша\n\n    print(\"\\n=== Processing main mesh ===\")\n\n    rhino_mesh_main = rs.coercemesh(mesh_guid_main)\n\n    \n\n    print(\"Cleaning main mesh...\")\n\n    clean_rhino_mesh(rhino_mesh_main)\n\n    \n\n    # Робоча копія основного меша\n\n    current_result_mesh = rhino_mesh_main.Duplicate()\n\n    \n\n    # Крок 4: Послідовне виконання boolean difference з кожним cutter'ом\n\n    try:\n\n        for i, cutter_guid in enumerate(mesh_guids_cutters, 1):\n\n            print(f\"\\n=== Processing cutter {i}/{len(mesh_guids_cutters)} ===\")\n\n            \n\n            # Отримання cutter меша\n\n            rhino_mesh_cutter = rs.coercemesh(cutter_guid)\n\n            \n\n            print(f\"Cleaning cutter {i}...\")\n\n            clean_rhino_mesh(rhino_mesh_cutter)\n\n            \n\n            # Конвертація в COMPAS mesh\n\n            compas_mesh_main = mesh_to_compas(current_result_mesh)\n\n            compas_mesh_cutter = mesh_to_compas(rhino_mesh_cutter)\n\n            \n\n            # Підготовка даних для CGAL boolean операції\n\n            mesh_main_data = compas_mesh_main.to_vertices_and_faces(triangulated=True)\n\n            mesh_cutter_data = compas_mesh_cutter.to_vertices_and_faces(triangulated=True)\n\n            \n\n            # Виконання boolean difference\n\n            print(f\"Performing boolean difference {i}...\")\n\n            vertices, faces = boolean_difference_mesh_mesh(mesh_main_data, mesh_cutter_data)\n\n            \n\n            # Створення результуючого COMPAS mesh\n\n            result_compas_mesh = Mesh.from_vertices_and_faces(vertices, faces)\n\n            \n\n            # Конвертація назад в Rhino mesh\n\n            current_result_mesh = mesh_to_rhino(result_compas_mesh)\n\n            \n\n            # Очищення проміжного результату\n\n            print(f\"Cleaning intermediate result {i}...\")\n\n            clean_rhino_mesh(current_result_mesh)\n\n            \n\n            print(f\"Completed {i}/{len(mesh_guids_cutters)}: {len(vertices)} vertices, {len(faces)} faces\")\n\n        \n\n        # Крок 5: Фінальне очищення результату\n\n        print(\"\\n=== Final cleaning ===\")\n\n        clean_rhino_mesh(current_result_mesh)\n\n        \n\n        # Крок 6: Додавання результату в документ Rhino\n\n        result_guid = sc.doc.Objects.AddMesh(current_result_mesh)\n\n        \n\n        # Крок 7: Видалення оригінальних мешів (опціонально)\n\n        delete_original = rs.MessageBox(\n\n            \"Remove original meshes?\",\n\n            buttons=4 | 32\n\n        )\n\n        if delete_original == 6:  # Yes\n\n            rs.DeleteObject(mesh_guid_main)\n\n            for cutter_guid in mesh_guids_cutters:\n\n                rs.DeleteObject(cutter_guid)\n\n        \n\n        # Оновлення відображення\n\n        sc.doc.Views.Redraw()\n\n        rs.SelectObject(result_guid)\n\n        \n\n        print(\"\\n=== SUCCESS ===\")\n\n        print(f\"Boolean difference successfully completed!\")\n\n        print(f\"Processed 1 main mesh with {len(mesh_guids_cutters)} cutter(s)\")\n\n        print(f\"Final result: {current_result_mesh.Vertices.Count} vertices, {current_result_mesh.Faces.Count} faces\")\n\n        \n\n        return result_guid\n\n        \n\n    except Exception as e:\n\n        print(f\"\\n=== ERROR ===\")\n\n        print(f\"Error when performing boolean difference: {e}\")\n\n        import traceback\n\n        traceback.print_exc()\n\n        return None\n\n\n\n\n\n# Запуск функції\n\nif __name__ == \"__main__\":\n\n    boolean_difference_rhino_meshes()",
      "language": "python",
      "author": "taraskydon",
      "post_number": 14,
      "is_solution": false
    }
  ],
  "tags": [
    "boolean",
    "csharp",
    "file-io",
    "geometry",
    "mesh",
    "python",
    "rhinocommon",
    "rhinoscriptsyntax",
    "selection",
    "transformation",
    "ui"
  ],
  "has_accepted_answer": false,
  "category_id": 11,
  "posts_count": 15,
  "views": 326
}