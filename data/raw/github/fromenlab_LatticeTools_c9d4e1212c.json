{
  "source_url": "https://github.com/fromenlab/LatticeTools/blob/4ed52adaf55fdab72c4b6c9566f011a3bdc9f8d3/mesh/mesh_volume.py",
  "repo": "fromenlab/LatticeTools",
  "repo_stars": 1,
  "repo_description": "Components for generating lattice structures in Rhino®/Grasshopper®",
  "license": "NOASSERTION",
  "filepath": "mesh/mesh_volume.py",
  "instruction": "Mesh volume",
  "code": "from ghpythonlib.componentbase import dotnetcompiledcomponent as component\nimport Grasshopper, GhPython\nimport System\nimport Rhino\nimport rhinoscriptsyntax as rs\nimport ghpythonlib.components as ghcomp\n\nout_mesh = None\n\ndef to_json(key, value):\n    return '\"{}\" : \"{}\"'.format(key, value)\n\ndef to_json_value_object_pair(key, value):\n    return '\"{}\" : {{{}}}'.format(key, value)\n\ndef get_mesh_report(report_instance, additional_params = None):\n    naked_count = 0\n    naked_edges = out_mesh.GetNakedEdges()\n    if naked_edges is not None:\n        naked_count = len(naked_edges)\n        \n    properties = []\n    report = to_json(\"report_version\", report_instance)\n    valid = to_json(\"valid_mesh\", out_mesh.IsValid)\n    naked = to_json(\"naked_edges\", naked_count)\n    closed = to_json(\"closed_mesh\", out_mesh.IsClosed)\n    manifold = to_json(\"manifold_mesh\", out_mesh.IsManifold(True))\n    disjoint = to_json(\"disjoint_count\", out_mesh.DisjointMeshCount)\n    vertices = to_json(\"vertex_count\", out_mesh.Vertices.Count)\n    memory = to_json(\"memory_estimate_mb\", out_mesh.MemoryEstimate()*1e-6)\n    log = to_json(\"log_invalid\", out_mesh.IsValidWithLog()[1])\n    \n    properties.extend([report, valid, naked, closed, manifold, disjoint, vertices, memory, log])\n    if additional_params:\n        properties.extend(additional_params)\n\n    properties_json = '{{{}}}'.format(to_json_value_object_pair(report_instance, ','.join(properties)))\n\n    return properties_json\n\ndef get_cut_planes(surfaces, translation_factor = 0):\n        planes = set()\n        for surface in surfaces:\n            print(type(surface))\n            reference_point = surface.GetBoundingBox(False).Center\n            normal_vector = surface.NormalAt(surface.ClosestMeshPoint(reference_point, 0.0))\n            surface.Translate(translation_factor*normal_vector)\n            planes.add(surface)\n                    \n        return planes\n\nclass MeshLattice(component):\n    def __new__(cls):\n        instance = Grasshopper.Kernel.GH_Component.__new__(cls,\n            \"Mesh - Meshing (Volume)\", \"MeshLattice\", \"\"\"Dendro Volume To Mesh with repairs and reports\"\"\",  \"LatticeTools\", \"Mesh\")\n        return instance\n    \n    def get_ComponentGuid(self):\n        return System.Guid(\"2104ce18-d6cf-46b4-b026-69b5468e672a\")\n    \n    def SetUpParam(self, p, name, nickname, description):\n        p.Name = name\n        p.NickName = nickname\n        p.Description = description\n        p.Optional = True\n    \n    def RegisterInputParams(self, pManager):\n        p = Grasshopper.Kernel.Parameters.Param_Boolean()\n        self.SetUpParam(p, \"run\", \"run\", \"Run the script?\")\n        p.Access = Grasshopper.Kernel.GH_ParamAccess.item\n        self.Params.Input.Add(p)\n        \n        p = Grasshopper.Kernel.Parameters.Param_GenericObject()\n        self.SetUpParam(p, \"dendroVolume\", \"dendroVolume\", \"The volume for meshing\")\n        p.Access = Grasshopper.Kernel.GH_ParamAccess.item\n        self.Params.Input.Add(p)\n        \n        p = Grasshopper.Kernel.Parameters.Param_GenericObject()\n        self.SetUpParam(p, \"radius\", \"radius\", \"Radius of the lattice curves\")\n        p.Access = Grasshopper.Kernel.GH_ParamAccess.list\n        self.Params.Input.Add(p)\n        \n        p = Grasshopper.Kernel.Parameters.Param_GenericObject()\n        self.SetUpParam(p, \"dendroSettings\", \"dendroSettings\", \"Settings provided by the Dendro component\")\n        p.Access = Grasshopper.Kernel.GH_ParamAccess.item\n        self.Params.Input.Add(p)\n        \n        p = Grasshopper.Kernel.Parameters.Param_Mesh()\n        self.SetUpParam(p, \"surfaces\", \"surfaces\", \"Script input surfaces.\")\n        p.Access = Grasshopper.Kernel.GH_ParamAccess.list\n        self.Params.Input.Add(p)\n        \n        p = Grasshopper.Kernel.Parameters.Param_Boolean()\n        self.SetUpParam(p, \"bake\", \"bake\", \"Bake the part into Rhino?\")\n        p.Access = Grasshopper.Kernel.GH_ParamAccess.item\n        self.Params.Input.Add(p)\n        \n        p = Grasshopper.Kernel.Parameters.Param_Boolean()\n        self.SetUpParam(p, \"save\", \"save\", \"Save the part?\")\n        p.Access = Grasshopper.Kernel.GH_ParamAccess.item\n        self.Params.Input.Add(p)\n        \n        p = Grasshopper.Kernel.Parameters.Param_String()\n        self.SetUpParam(p, \"file_name\", \"file_name\", \"Where to save the part\")\n        p.Access = Grasshopper.Kernel.GH_ParamAccess.item\n        self.Params.Input.Add(p)\n        \n        p = Grasshopper.Kernel.Parameters.Param_Boolean()\n        self.SetUpParam(p, \"delete\", \"delete\", \"Delete the part after saving?\")\n        p.Access = Grasshopper.Kernel.GH_ParamAccess.item\n        self.Params.Input.Add(p)\n        \n    \n    def RegisterOutputParams(self, pManager):\n        p = Grasshopper.Kernel.Parameters.Param_GenericObject()\n        self.SetUpParam(p, \"out_mesh\", \"out_mesh\", \"Dendro-generated mesh of lattice\")\n        self.Params.Output.Add(p)\n        \n        p = Grasshopper.Kernel.Parameters.Param_GenericObject()\n        self.SetUpParam(p, \"original_report\", \"original_report\", \"Mesh report for original lattice\")\n        self.Params.Output.Add(p)\n        \n        p = Grasshopper.Kernel.Parameters.Param_GenericObject()\n        self.SetUpParam(p, \"mod_report\", \"mod_report\", \"Mesh report for modified lattice, with minimal alterations\")\n        self.Params.Output.Add(p)\n        \n        p = Grasshopper.Kernel.Parameters.Param_GenericObject()\n        self.SetUpParam(p, \"cut_report\", \"cut_report\", \"Mesh report for trimmed lattice\")\n        self.Params.Output.Add(p)\n        \n        p = Grasshopper.Kernel.Parameters.Param_GenericObject()\n        self.SetUpParam(p, \"volume\", \"volume\", \"Volume of the final lattice in document units\")\n        self.Params.Output.Add(p)\n        \n        p = Grasshopper.Kernel.Parameters.Param_GenericObject()\n        self.SetUpParam(p, \"area\", \"area\", \"Surface area of the final lattice in document units\")\n        self.Params.Output.Add(p)\n        \n    \n    def SolveInstance(self, DA):\n        p0 = self.marshal.GetInput(DA, 0)\n        p1 = self.marshal.GetInput(DA, 1)\n        p2 = self.marshal.GetInput(DA, 2)\n        p3 = self.marshal.GetInput(DA, 3)\n        p4 = self.marshal.GetInput(DA, 4)\n        p5 = self.marshal.GetInput(DA, 5)\n        p6 = self.marshal.GetInput(DA, 6)\n        p7 = self.marshal.GetInput(DA, 7)\n        p8 = self.marshal.GetInput(DA, 8)\n        result = self.RunScript(p0, p1, p2, p3, p4, p5, p6, p7, p8)\n\n        if result is not None:\n            if not hasattr(result, '__getitem__'):\n                self.marshal.SetOutput(result, DA, 0, True)\n            else:\n                self.marshal.SetOutput(result[0], DA, 0, True)\n                self.marshal.SetOutput(result[1], DA, 1, True)\n                self.marshal.SetOutput(result[2], DA, 2, True)\n                self.marshal.SetOutput(result[3], DA, 3, True)\n                self.marshal.SetOutput(result[4], DA, 4, True)\n                self.marshal.SetOutput(result[5], DA, 5, True)\n        \n    def get_Internal_Icon_24x24(self):\n        o = \"iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAYAAADgdz34AAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAAHYcAAB2HAY/l8WUAAAJoSURBVEhLY4ACVm1D4/lZpTVv2dg4Q6FixAIOIFYHYkkwDwcIXbJp7/9VOw7975uz7B+QHwPEakDMBJKE0gpA7AHEhcpq6ls8vH3uJ6RkfK9taP43d/GKv/JKan9EJKW/CIiInGBiYqoAqmMFYjhoWLp53//u2Sv+n716+/+hk+f+Tpsz/3dqZvZvO0fndxLSsn8UVDR+axmY/jE0t/2/fN3m/w9fvEXBIHEY1jW2ADkyA2I0BDTMX7fzf8fMZRgaV6zfgqIZhAlZAMIgMyFGQwBOC0CGoWse3BbsOXzi/72nr+AakS2wdfb8Hx6b/L+tZ9L/vJKq/1EJaf89/UP/W9q7/r965+H/XQeO/Z+/dPX/lq4JuC0AGWRi5fDfxSvgf1hM0v+a5g6wpSADYJbmFFXALYVhmBwMg8yEGA0BKBYgY5Bh6JqHhwVGFnb/nTz8/gdFxP1Pzsr/v3XPwf8Xrt+BqwGZCTEaAuAWTJg+539mfik4Mt18gsCReebyjf+bd+7/P3PB0v8N7T3giLz18BmKpTAH2Th5/I+IS8FtAbImEB56+QBdI9UtOH/9LorGVRu3Y2gGxsW/nfsP/Z02e8GforLKv5Ex8Z9ExaV+ggpEfROrvzpG5qDCLhtiNATALajpnPrP2MLqfnxSyq9J02b9Lqms+SUjr/RXRErmq5C4xC0eXv4VQPUFQAwqulWAGFYsMwKxEhCHA3EqEIPqCTiAW1DZPe0vkK8NxKA6QBmItYCYD4gpAtgsoCoYtYAgqJ29ahvEgraJoCSmARGmHjDKLG/+2zZ9yX8Xn8APQD6sNUEhYGAAAPJCbOYDm9fdAAAAAElFTkSuQmCC\"\n        return System.Drawing.Bitmap(System.IO.MemoryStream(System.Convert.FromBase64String(o)))\n\n    def RunScript(self, run, dendroVolume, radius, dendroSettings, cut_surfaces, bake, save, file_name, delete):\n        global out_mesh\n        original_report = None\n        cut_report = None\n        volume = None\n        area = None\n        \n        \n        if run:\n            #   Generate lattice volume and mesh\n            out_mesh = ghcomp.DendroGH.VolumetoMesh(volume = dendroVolume, volume_settings = dendroSettings)\n\n            original_bounds = out_mesh.GetBoundingBox(True)\n            original_report = get_mesh_report(report_instance = \"original_report\")\n\n            #   Make checks and first repairs\n            degenerate_faces = to_json(\"degenerate_faces\", out_mesh.Faces.RemoveZeroAreaFaces(0))\n            quads_to_tris = to_json(\"quads_to_tris\", out_mesh.Faces.ConvertQuadsToTriangles())\n            out_mesh.UnifyNormals()\n            mesh_flipped = False\n            if(out_mesh.Volume() < 0):\n                out_mesh.Flip(True, True, True)\n                mesh_flipped = True\n            mesh_flipped = to_json(\"mesh_flipped\", mesh_flipped)\n            mod_report = get_mesh_report(report_instance = \"modified_report\", additional_params=[degenerate_faces, quads_to_tris, mesh_flipped])\n\n            #    Split mesh\n            if cut_surfaces:\n                revised_cut = False\n                planes = get_cut_planes(cut_surfaces)\n                cut_mesh = Rhino.Geometry.Mesh.CreateBooleanDifference({out_mesh}, planes)[0]\n                cut_bounds = cut_mesh.GetBoundingBox(True)\n\n                if (cut_bounds.Volume/original_bounds.Volume < 0.01):\n                    revised_cut = True\n                    planes = get_cut_planes(cut_surfaces, translation_factor = 0.01)\n                    out_mesh = Rhino.Geometry.Mesh.CreateBooleanDifference({out_mesh}, planes)[0]\n                else:\n                    out_mesh = cut_mesh\n\n                revised_cut = to_json(\"revised_cut\", revised_cut)\n                face_count_cut = to_json(\"face_count_cut\", out_mesh.Faces.Count)\n                fill_success = to_json(\"fill_success\", out_mesh.FillHoles())\n                face_count_filled = to_json(\"face_count_filled\", out_mesh.Faces.Count)\n                cut_report = get_mesh_report(report_instance = \"cut_report\", additional_params=[revised_cut, face_count_cut, fill_success, face_count_filled])\n\n            #   Calculate mesh properties\n            volume = out_mesh.Volume()\n            areaMassProperties = Rhino.Geometry.AreaMassProperties.Compute(out_mesh)\n            area = areaMassProperties.Area\n\n            #   Export\n            if bake or save:\n                id = Rhino.RhinoDoc.ActiveDoc.Objects.Add(out_mesh)\n                id = str(id)\n\n                if save and file_name:\n                    rs.Command(\"SelID \" + id)\n                    rs.Command(\"-Export \" + file_name + \" Enter\")\n                \n                    if delete:\n                        rs.Command(\"SelID \" + id)\n                        rs.Command(\"Delete\")\n                \n            rs.Command(\"ClearUndo\")\n            return out_mesh, original_report, mod_report, cut_report, volume, area",
  "language": "python",
  "imports": [
    "Rhino",
    "Rhino.Geometry",
    "ghpythonlib",
    "rhinoscriptsyntax"
  ],
  "has_docstring": false
}