{
  "source_url": "https://github.com/PH-Tools/honeybee_grasshopper_ph_plus/blob/b89f9887488d9c10eb732ffafe910cec70be0752/honeybee_ph_plus_rhino/gh_compo_io/hb_tools/win_create_types.py",
  "repo": "PH-Tools/honeybee_grasshopper_ph_plus",
  "repo_stars": 2,
  "repo_description": "Additional Honeybe-PH Grasshopper Components",
  "license": "GPL-3.0",
  "filepath": "honeybee_ph_plus_rhino/gh_compo_io/hb_tools/win_create_types.py",
  "instruction": "GHCompo Interface: HBPH+ - Create Window Types.",
  "code": "# -*- coding: utf-8 -*-\n# -*- Python Version: 2.7 -*-\n\n\"\"\"GHCompo Interface: HBPH+ - Create Window Types.\"\"\"\n\nfrom collections import OrderedDict, defaultdict\nfrom copy import copy\n\ntry:\n    from itertools import izip  # type: ignore\nexcept ImportError:\n    izip = zip  # Python 3\n\ntry:\n    from typing import Any\nexcept ImportError:\n    pass  # IronPython 2.7\n\ntry:\n    from Rhino.Geometry import Brep, LineCurve, Plane, Point3d, Vector3d  # type: ignore\nexcept ImportError:\n    pass  # Outside Rhino\n\ntry:\n    from honeybee_ph_rhino.gh_compo_io import ghio_validators\nexcept ImportError as e:\n    raise ImportError(\"\\nFailed to import honeybee_ph_rhino:\\n\\t{}\".format(e))\n\ntry:\n    from ph_gh_component_io import gh_io\nexcept ImportError as e:\n    raise ImportError(\"\\nFailed to import ph_gh_component_io:\\n\\t{}\".format(e))\n\ntry:\n    from ph_units.converter import convert\nexcept ImportError as e:\n    raise ImportError(\"\\nFailed to import ph_units:\\n\\t{}\".format(e))\n\n\nclass BuildOriginPlaneError(Exception):\n    \"\"\"Custom Error for the Window Builder.\"\"\"\n\n    def __init__(self, _start_pt, _end_pt):\n        # type: (Point3d, Point3d) -> None\n        self.message = (\n            \"Error: Something went wrong building the Origin-Planes for \"\n            \"the window with base-curve with Start-Point: {} and End-Point: {}. Note this window builder ONLY works for vertical \"\n            \"planar windows. Skylights or windows on sloped surfaces are not supported.\".format(_start_pt, _end_pt)\n        )\n        super().__init__(self.message)\n\n\nclass WindowElement(object):\n    \"\"\"A Dataclass for a single Window 'Element' (sash) which can be added to a WindowType.\"\"\"\n\n    width_m = ghio_validators.UnitM(\"width_m\")\n    height_m = ghio_validators.UnitM(\"height_m\")\n\n    def __init__(self, _width_m, _height_m, _col, _row):\n        # type: (float, float, int, int) -> None\n        self.width_m = float(_width_m)\n        self.height_m = float(_height_m)\n        self.col = int(_col)\n        self.row = int(_row)\n\n    def get_display_name(self):\n        # type: () -> str\n        return \"{}{}\".format(self.col, self.row)\n\n    def __str__(self):\n        # type: () -> str\n        return \"{}( width_m={}, height_m={}, col={}, row={} )\".format(\n            self.__class__.__name__, self.width_m, self.height_m, self.col, self.row\n        )\n\n    def __repr__(self):\n        # type: () -> str\n        return str(self)\n\n    def ToString(self):\n        # type: () -> str\n        return str(self)\n\n\nclass WindowUnitType(object):\n    \"\"\"A Class to organize a single Window 'Type' with all its WindowElements.\"\"\"\n\n    def __init__(self, _IGH, _type_name, _spacer_m=0.0):\n        # type: (gh_io.IGH, str, float) -> None\n        self.IGH = _IGH\n        self.type_name = _type_name\n        self.spacer_m = _spacer_m\n        self.elements = []  # type: list[WindowElement]\n\n    @staticmethod\n    def elements_by_column(_elements):\n        # type: (list[WindowElement]) -> list[list[WindowElement]]\n        \"\"\"Return a list with lists of WindowElements sorted by their column\"\"\"\n        # -- Sort the WindowElements by their column name\n        d = defaultdict(list)\n        for element in _elements:\n            d[element.col].append(element)\n\n        # -- Convert the dict to a list of lists\n        output = []\n        for k in sorted(d.keys()):\n            output.append(d[k])\n        return output\n\n    @staticmethod\n    def elements_by_row(_elements):\n        # type: (list[WindowElement]) -> list[WindowElement]\n        \"\"\"Return a lists of WindowElements sorted by their row.\"\"\"\n        return sorted(_elements, key=lambda e: e.row)\n\n    @property\n    def x_vector(self):\n        # type: () -> Vector3d\n        if not self.base_curve:\n            raise ValueError(\"Error: window {} is missing a base_curve?\".format(self.type_name))\n        start_pt, end_pt = self.IGH.ghc.EndPoints(self.base_curve)\n        return self.IGH.ghc.Vector2Pt(start_pt, end_pt, True).vector\n\n    @property\n    def y_vector(self):\n        # type: () -> Vector3d\n        return self.IGH.ghc.UnitZ(1)\n\n    def build_origin_plane(self, _base_curve):\n        # type: (LineCurve) -> Plane\n        start_pt, end_pt = self.IGH.ghc.EndPoints(_base_curve)\n        pl = self.IGH.ghc.ConstructPlane(start_pt, self.x_vector, self.y_vector)\n        if not pl:\n            raise BuildOriginPlaneError(\n                start_pt,\n                end_pt,\n            )\n\n        return pl\n\n    def build_origin_point(self, _base_curve):\n        # type: (LineCurve) -> Point3d\n        \"\"\"Get the origin point of the base curve.\"\"\"\n        return self.build_origin_plane(_base_curve).Origin\n\n    def build_srfc_base_crv(self, _width_m, _origin_plane, _doc_units):\n        # type: (float, Plane, str) -> LineCurve\n        \"\"\"Build the surface base curve for the window (in Rhino doc units).\"\"\"\n\n        pt_1 = _origin_plane.Origin\n        move_width_m = _width_m - self.spacer_m\n        move_width_in_doc_units = convert(move_width_m, \"M\", _doc_units)\n        move_vector = self.IGH.ghc.Amplitude(self.x_vector, move_width_in_doc_units)\n        pt_2 = self.IGH.ghc.Move(pt_1, move_vector).geometry\n        return self.IGH.ghc.Line(pt_1, pt_2)\n\n    def get_cumulative_row_heights_m(self):\n        # type: () -> list[float]\n        \"\"\"Returns a list of the cumulative row-heights starting from 0. ie: [0.0, 3.4, 5.6]\"\"\"\n\n        row_heights_dict = defaultdict(list)\n        for element in self.elements:\n            row_heights_dict[int(element.row)].append(float(element.height_m))\n\n        row_heights_ = [0.0]  # starting position\n        for k in sorted(row_heights_dict.keys()):\n            row_heights_.append(row_heights_[k] + min(row_heights_dict[k]))\n        # print(\"Cumulative Row Heights: {}\".format(row_heights_))\n        return row_heights_\n\n    def get_cumulative_col_widths_m(self):\n        # type: () -> list[float]\n        \"\"\"Returns a list of the cumulative column-widths starting from 0. ie: [0.0, 3.4, 5.6]\"\"\"\n\n        col_widths_dict = defaultdict(list)\n        for element in self.elements:\n            col_widths_dict[int(element.col)].append(float(element.width_m))\n\n        col_widths_ = [0.0]  # starting position\n        for k in sorted(col_widths_dict.keys()):\n            col_widths_.append(col_widths_[k] + min(col_widths_dict[k]))\n        # print(\"Cumulative Column Widths: {}\".format(col_widths_))\n        return col_widths_\n\n    def build(self, _base_curve):\n        # type: (LineCurve) -> tuple[list[Brep], OrderedDict[int, dict[str, Any]]]\n        \"\"\"Create the window's Rhino geometry based on the Elements.\"\"\"\n\n        # 1) -- Get the Base-Plane and create a starting origin plane from it\n        self.base_curve = _base_curve\n        origin_plane = self.build_origin_plane(_base_curve)\n\n        # 2) -- Walk through each column, and each row in each column\n        cum_row_heights_m_ = self.get_cumulative_row_heights_m()\n        cum_col_widths_m_ = self.get_cumulative_col_widths_m()\n\n        # 3) -- Create the surfaces and ID data\n        surfaces_ = []\n        id_data_ = OrderedDict()\n        rh_doc_units = self.IGH.get_rhino_unit_system_name()\n        for i, col_element_lists in enumerate(self.elements_by_column(self.elements)):\n            column_elements_origin_plane = copy(origin_plane)  # type: Plane\n\n            # 1) -- Move the origin plane 'over' to the next column\n            col_width_in_doc_units = convert(cum_col_widths_m_[i], \"M\", rh_doc_units)\n            column_elements_origin_plane = self.IGH.ghc.Move(\n                column_elements_origin_plane,\n                self.IGH.ghc.Amplitude(self.x_vector, col_width_in_doc_units),\n            ).geometry\n\n            for row_element in self.elements_by_row(col_element_lists):\n                row_elements_origin_plane = copy(column_elements_origin_plane)  # type: Plane\n\n                # 2) -- Move the origin plane 'up' to the starting row position\n                row_height_in_doc_units = convert(cum_row_heights_m_[row_element.row], \"M\", rh_doc_units)\n                row_elements_origin_plane = self.IGH.ghc.Move(\n                    row_elements_origin_plane,\n                    self.IGH.ghc.Amplitude(self.y_vector, row_height_in_doc_units),\n                ).geometry\n\n                # 3) Build the Window Element Surface\n                base_curve = self.build_srfc_base_crv(row_element.width_m, row_elements_origin_plane, rh_doc_units)\n                row_element_height_in_doc_units = convert(row_element.height_m, \"M\", rh_doc_units)\n                surfaces_.append(\n                    self.IGH.ghc.Extrude(\n                        base_curve,\n                        self.IGH.ghc.Amplitude(self.y_vector, row_element_height_in_doc_units),\n                    )\n                )\n\n                # 4)-- Keep track of the id-data for the surface\n                el_name = row_element.get_display_name()\n                el_id_data = {}\n                el_id_data[\"type_name\"] = self.type_name\n                el_id_data[\"row\"] = row_element.row\n                el_id_data[\"col\"] = row_element.col\n                id_data_[el_name] = el_id_data\n\n        return surfaces_, id_data_\n\n    def __str__(self):\n        # type: () -> str\n        return \"{}(type_name={}, elements={})\".format(self.__class__.__name__, self.type_name, self.elements)\n\n    def __repr__(self):\n        # type: () -> str\n        return str(self)\n\n    def ToString(self):\n        return str(self)\n\n\nclass GHCompo_CreateWindowUnitTypes(object):\n    def __init__(self, _IGH, _type_names, _widths, _heights, _pos_cols, _pos_rows):\n        # type: (gh_io.IGH, list[str], list[float], list[float], list[int], list[int]) -> None\n        self.IGH = _IGH\n        self.type_names = _type_names\n        self.widths = [convert(w, self.IGH.get_rhino_unit_system_name(), \"M\") or 1.0 for w in _widths]\n        self.heights = [convert(h, self.IGH.get_rhino_unit_system_name(), \"M\") or 1.0 for h in _heights]\n        self.pos_cols = _pos_cols\n        self.pos_rows = _pos_rows\n\n    def run(self):\n        # type: () -> list[WindowUnitType]\n\n        # ------------------------------------------------------------------------------\n        # -- Sort all the input data and group by 'Type Name'\n\n        # -- Build up all the types\n        window_types = {}\n        for type_name in self.type_names:\n            window_types[type_name] = WindowUnitType(self.IGH, type_name)\n\n        # -- Add the window elements (sashes) to the types\n        input_lists = izip(self.type_names, self.widths, self.heights, self.pos_cols, self.pos_rows)\n        for input_data in input_lists:\n            type_name, width, height, pos_col, pos_row = input_data\n            window_types[type_name].elements.append(WindowElement(width, height, pos_col, pos_row))\n\n        return [window_types[k] for k in sorted(window_types.keys())]\n",
  "language": "python",
  "imports": [
    "Rhino",
    "Rhino.Geometry"
  ],
  "has_docstring": true
}