{
  "source_url": "https://github.com/Ennead-Architects-LLP/EA_Dist/blob/635520d89b8308b78eabf5b60bb80121d0fa3838/Apps/_rhino/Knowledge.tab/search_command.button/search_command_left.py",
  "repo": "Ennead-Architects-LLP/EA_Dist",
  "repo_stars": 0,
  "repo_description": null,
  "license": "unknown",
  "filepath": "Apps/_rhino/Knowledge.tab/search_command.button/search_command_left.py",
  "instruction": "Search command left",
  "code": "__title__ = [\"SearchCommand\",\r\n             \"LearnEnneadTabForRhino\",\r\n             \"CommandList\"]\r\n__doc__ = \"\"\"Search and learn EnneadTab commands.\r\n\r\nKey Features:\r\n- Interactive command search\r\n- Function documentation\r\n- Command aliases\r\n- Tool location finder\r\n- Visual command preview\"\"\"\r\n__is_popular__ = True\r\n\r\nimport Rhino # pyright: ignore\r\nimport rhinoscriptsyntax as rs # pyright: ignore\r\n\r\nimport Eto # pyright: ignore\r\n\r\nimport io\r\nimport os\r\nimport fnmatch\r\n\r\nimport itertools\r\nflatten = itertools.chain.from_iterable\r\ngraft = itertools.combinations\r\n\r\nimport os\r\nimport json\r\nfrom EnneadTab import LOG, ERROR_HANDLE, NOTIFICATION, ENVIRONMENT\r\nfrom EnneadTab.RHINO import RHINO_ALIAS, RHINO_UI\r\n\r\nimport logging\r\n\r\n# Configure logging\r\nlogging.basicConfig(level=logging.INFO, \r\n                   format='%(asctime)s - %(levelname)s - %(message)s')\r\nlogger = logging.getLogger(__name__)\r\n\r\n\r\n# make modal dialog\r\nclass EnneadSearchDialog(Eto.Forms.Dialog[bool]):\r\n    # Initializer\r\n    \r\n    @ERROR_HANDLE.try_catch_error()\r\n    def __init__(self):\r\n        self.Title = \"Command Searcher\"\r\n        self.Resizable = True\r\n        self.Padding = Eto.Drawing.Padding(5)\r\n        self.Spacing = Eto.Drawing.Size(5, 5)\r\n        self.Icon = None\r\n        #self.Bounds = Eto.Drawing.Rectangle()\r\n        self.height = 600\r\n        self.width = 400\r\n        self.icon_image_paths = []\r\n       \r\n\r\n        # fields\r\n        self.ScriptList = self.InitializeScriptList()\r\n        self.SearchedScriptList = self.ScriptList[::]\r\n\r\n\r\n        # initialize layout\r\n        left_layout = Eto.Forms.DynamicLayout()\r\n        left_layout.Padding = Eto.Drawing.Padding(5)\r\n        left_layout.Spacing = Eto.Drawing.Size(5, 5)\r\n        right_layout = Eto.Forms.DynamicLayout()\r\n        right_layout.Padding = Eto.Drawing.Padding(5)\r\n        right_layout.Spacing = Eto.Drawing.Size(5, 5)\r\n        \r\n\r\n        right_layout.AddSeparateRow(None, self.CreateLogoImage())\r\n\r\n        # add repair toolbar button\r\n        self.btn_repair = Eto.Forms.Button()\r\n        self.btn_repair.Text = \"Repair Toolbar\"\r\n        self.btn_repair.Click += self.btn_repair_Clicked\r\n        right_layout.AddSeparateRow(None, self.btn_repair)\r\n\r\n        # add message\r\n        left_layout.BeginVertical()\r\n        left_layout.AddRow(self.CreateMessageBar())\r\n        left_layout.EndVertical()\r\n\r\n        # add search\r\n        left_layout.BeginVertical()\r\n        left_layout.AddRow(*self.CreateSearchBar())\r\n\r\n        \r\n        self.checkbox_search_in_tooltip = Eto.Forms.CheckBox()\r\n        self.checkbox_search_in_tooltip.Text = \"Search include Tooltip?\"\r\n        self.checkbox_search_in_tooltip.CheckedChanged += self.checkbox_search_in_tooltip_CheckedChanged\r\n        left_layout.AddSeparateRow(None, self.checkbox_search_in_tooltip)\r\n        \r\n        left_layout.EndVertical()\r\n\r\n        # add listBox\r\n        left_layout.BeginVertical()\r\n        left_layout.AddRow(self.CreateScriptListBox())\r\n        left_layout.EndVertical()\r\n\r\n        # add buttons\r\n        left_layout.BeginVertical()\r\n        left_layout.AddRow(self.CreateButtons())\r\n        left_layout.EndVertical()\r\n        \r\n        \r\n        right_layout.BeginVertical()\r\n        right_layout.AddRow(self.CreateInfoLabels_Button())\r\n        right_layout.AddRow(self.CreateIconTray_Button())\r\n        right_layout.AddRow(self.CreateInfoLabels_Tab())\r\n        right_layout.AddRow(self.CreateIconTray_Tab())\r\n        right_layout.EndVertical()\r\n\r\n        # set content\r\n        main_layout = Eto.Forms.DynamicLayout()\r\n        main_layout.AddRow(left_layout, right_layout)\r\n        \r\n        self.Content = main_layout\r\n\r\n        RHINO_UI.apply_dark_style(self)\r\n\r\n\r\n    # collect data for list\r\n    def InitializeScriptList(self):\r\n        with io.open(ENVIRONMENT.KNOWLEDGE_RHINO_FILE, \"r\", encoding = \"utf-8\") as f:\r\n            knowledge_pool = json.load(f)\r\n\r\n        self.knowledge = {}\r\n        \r\n        for value in knowledge_pool.values():\r\n            command_names = value[\"alias\"]\r\n            if not isinstance(command_names, list):\r\n                command_names = [command_names]\r\n            for command_name in command_names:\r\n                self.knowledge[command_name] = value\r\n\r\n        return sorted([[x] for x in self.knowledge.keys()])\r\n\r\n\r\n\r\n\r\n    def CreateLogoImage(self):\r\n        self.logo = Eto.Forms.ImageView()\r\n        return self.logo\r\n\r\n\r\n    def CreateIconTray_Button(self):\r\n        icon_tray_button_layout = Eto.Forms.DynamicLayout() \r\n        \r\n        self.icon_tray_button_image_viewer = Eto.Forms.ImageView()\r\n        icon_tray_button_layout.AddRow(self.icon_tray_button_image_viewer)      \r\n        return icon_tray_button_layout\r\n\r\n    def CreateIconTray_Tab(self):\r\n        icon_tray_tab_layout = Eto.Forms.DynamicLayout() \r\n\r\n        self.icon_tray_tab_image_viewer = Eto.Forms.ImageView()\r\n        icon_tray_tab_layout.AddRow(self.icon_tray_tab_image_viewer)    \r\n\r\n        label = Eto.Forms.Label()\r\n        label.Text = \"\"\r\n        icon_tray_tab_layout.AddSeparateRow(label)  \r\n        return icon_tray_tab_layout\r\n \r\n    def update_icon_tray_button(self):\r\n        \r\n\r\n\r\n        def update_image_action(search_key, image_viewer):\r\n            \r\n            icon_path = self.knowledge[self.selected_button_name].get(search_key, None)\r\n            if icon_path is None:\r\n                icon_path = os.path.join(os.path.dirname(__file__), \"missing_icon.png\")\r\n           \r\n            # rank icon by file size, more complex one is the better quality, usually\r\n            icon_image_path = os.path.join(ENVIRONMENT.RHINO_FOLDER, icon_path)\r\n\r\n\r\n            if os.path.exists(icon_image_path):\r\n                image = Eto.Drawing.Bitmap(icon_image_path)\r\n                image_viewer.Image = image.WithSize(50,50)\r\n  \r\n        \r\n        update_image_action(\"icon\", self.icon_tray_button_image_viewer)\r\n        update_image_action(\"tab_icon\", self.icon_tray_tab_image_viewer)\r\n\r\n    def update_info_text(self):\r\n\r\n \r\n        # print self.knowledge\r\n        data = self.knowledge[self.selected_button_name]\r\n        if \"_right.py\" in data[\"script\"]:\r\n            access = \"Right Click\"\r\n        else:\r\n            access = \"Left Click\"\r\n\r\n        tab_name = data.get(\"tab\", None)\r\n        if tab_name is None:\r\n            tab_name = \"Unknown\"\r\n        tab_name = tab_name.replace(\".tab\", \" Tab\").replace(\".menu\", \" Menu\")\r\n\r\n        commands = data.get(\"alias\", None)\r\n        if not isinstance(commands, list):\r\n            commands = [commands]\r\n        final_commands = []\r\n        for command in commands:\r\n            if command is None:\r\n                continue\r\n            if command.upper() == command:\r\n                final_commands.append(command)\r\n            else:\r\n                final_commands.append(\"EA_{}\".format(command))\r\n        commands = \" / \".join(final_commands)\r\n        # print data\r\n        self.bt_info_A.Text = \"Button Name: {}\\nCommand: {}\\nTooltip: {}\\nAccess: {}\\nButton Icon:\".format(self.selected_button_name,\r\n                                                                                            commands,\r\n                                                                                            data.get(\"doc\"),\r\n                                                                                            access)\r\n        self.bt_info_B.Text = \"Find this button in: {}\\nTab Icon:\".format(tab_name)\r\n    \r\n        \r\n        click_icon = \"{}\\\\{}.png\".format(os.path.join(os.path.dirname(__file__)), access)\r\n        image = Eto.Drawing.Bitmap(click_icon)\r\n        self.access_icon.Image = image.WithSize(30,30)\r\n    \r\n    \r\n    def update_info_panel(self):\r\n        try:\r\n            #logger.info(\"Updating info panel\")\r\n            if len(list(self.lb.SelectedItems)) == 0:\r\n                return\r\n            self.selected_button_name = list(self.lb.SelectedItems)[0][0]\r\n        except Exception as e:\r\n            logger.error(\"Error updating info panel: {}\".format(str(e)))\r\n            return\r\n        self.update_icon_tray_button()\r\n        self.update_info_text()\r\n    \r\n    # create message bar function\r\n    def CreateMessageBar(self):\r\n        self.msg = Eto.Forms.Label()\r\n        self.msg.Text = \"Find the what EnneadTab for Rhino can do and where are they?\"\r\n        return self.msg\r\n        #self.msg.HorizontalAlignment = Eto.Forms.HorizontalAlignment.Left\r\n\r\n    def CreateInfoLabels_Button(self):\r\n        layout = Eto.Forms.DynamicLayout()\r\n        layout.Padding = Eto.Drawing.Padding(5)\r\n        layout.Spacing = Eto.Drawing.Size(5, 5)\r\n        layout.Width = 400\r\n        label = Eto.Forms.Label()\r\n        label.Text = \"Button Info:\"\r\n        layout.AddSeparateRow(label)\r\n        self.bt_info_A = Eto.Forms.Label()\r\n        layout.AddSeparateRow( self.bt_info_A)\r\n        self.access_icon = Eto.Forms.ImageView()\r\n        layout.AddRow(self.access_icon)\r\n\r\n        return layout\r\n        \r\n    def CreateInfoLabels_Tab(self):\r\n        layout = Eto.Forms.DynamicLayout()\r\n        layout.Padding = Eto.Drawing.Padding(5)\r\n        layout.Spacing = Eto.Drawing.Size(5, 5)\r\n        layout.Width = 400\r\n        # label = Eto.Forms.Label()\r\n        # label.Text = \"Tab Info:\"\r\n        # layout.AddSeparateRow(label)\r\n        self.bt_info_B = Eto.Forms.Label()\r\n        layout.AddSeparateRow( self.bt_info_B)\r\n\r\n\r\n        \r\n        return layout\r\n    \r\n\r\n    # create search bar function\r\n    def CreateSearchBar(self):\r\n        \"\"\"\r\n        Creates two controls for the search bar\r\n        self.lbl_Search as a simple label\r\n        self.tB_Search as a textBox to input search strings to\r\n        \"\"\"\r\n        self.lbl_Search = Eto.Forms.Label()\r\n        self.lbl_Search.Text = \"Type Here to Search: \"\r\n        self.lbl_Search.VerticalAlignment = Eto.Forms.VerticalAlignment.Center\r\n\r\n        self.tB_Search = Eto.Forms.TextBox()\r\n        self.tB_Search.TextChanged += self.tB_Search_TextChanged\r\n\r\n\r\n\r\n\r\n\r\n        return [self.lbl_Search, self.tB_Search]\r\n\r\n\r\n\r\n    def CreateScriptListBox(self):\r\n        # Create a multi selection box with grid view - this is similar to Rhino MultipleListBox\r\n        self.lb = Eto.Forms.GridView()\r\n        self.lb.ShowHeader = True\r\n        self.lb.AllowMultipleSelection = False\r\n        self.lb.Height = self.height\r\n        self.lb.AllowColumnReordering = True\r\n\r\n        self.lb.DataStore = sorted(self.ScriptList)\r\n\r\n        self.lb.SelectedRowsChanged += self.RowsChanged\r\n\r\n\r\n        # Create Gridview Column\r\n        column1 = Eto.Forms.GridColumn()\r\n        column1.Editable = False\r\n        column1.Width = self.width\r\n        column1.DataCell = Eto.Forms.TextBoxCell(0)\r\n        self.lb.Columns.Add(column1)\r\n\r\n        self.lb.DataStore = self.SearchedScriptList\r\n\r\n        return self.lb\r\n\r\n\r\n\r\n    def CreateButtons(self):\r\n        \"\"\"\r\n        Creates buttons for either print the selection result\r\n        or exiting the dialog\r\n        \"\"\"\r\n        layout = Eto.Forms.DynamicLayout()\r\n        layout.Spacing = Eto.Drawing.Size(5, 5)\r\n        layout.Padding = Eto.Drawing.Padding(5)\r\n        \r\n        \r\n\r\n        \r\n        \r\n        user_buttons = []\r\n        self.btn_Run = Eto.Forms.Button()\r\n        self.btn_Run.Text = \"Pretty Print Dictionary!\"\r\n        self.btn_Run.Click += self.btn_Run_Clicked\r\n        user_buttons.append(self.btn_Run)\r\n\r\n        self.btn_command = Eto.Forms.Button()\r\n        self.btn_command.Text = \"Run as Command\"\r\n        self.btn_command.Click += self.btn_command_Clicked\r\n        user_buttons.append(self.btn_command)\r\n\r\n\r\n        self.btn_Cancel = Eto.Forms.Button()\r\n        self.btn_Cancel.Text = \"Cancel\"\r\n        self.btn_Cancel.Click += self.btn_Cancel_Clicked\r\n\r\n        user_buttons.extend([ None, self.btn_Cancel])\r\n        \r\n        layout.AddSeparateRow(*user_buttons)\r\n        return layout\r\n    \r\n    \r\n    @property\r\n    def is_search_in_tooltip(self):\r\n        return self.checkbox_search_in_tooltip.Checked\r\n\r\n    # create a search function\r\n    def Search(self, text):\r\n        if text == \"\":\r\n            logger.debug(\"Empty search - showing full script list\")\r\n            self.lb.DataStore = self.ScriptList\r\n        else:\r\n            if not self.is_search_in_tooltip:\r\n                temp = [ [str(x[0])] for x in self.ScriptList]\r\n                self.SearchedScriptList = list(graft(fnmatch.filter(flatten(temp), \"*\" + text + \"*\"), 1))\r\n            else:\r\n                complete_data = [[\"{}^^^{}\".format(x[0], self.knowledge[x[0]][\"doc\"])] for x in self.ScriptList]\r\n                searched_compiler = list(graft(fnmatch.filter(flatten(complete_data), \"*\" + text + \"*\"), 1))\r\n                self.SearchedScriptList = [[x[0].split(\"^^^\")[0]] for x in searched_compiler]\r\n                self.SearchedScriptList.sort(key=lambda x: text.lower() in x[0].lower(), reverse=True)\r\n\r\n            self.lb.DataStore = self.SearchedScriptList\r\n            \r\n        self.update_info_panel()\r\n\r\n\r\n    # Gridview SelectedRows Changed Event\r\n    def RowsChanged (self,sender,e):\r\n        #logger.info(\"Selection changed in grid view\")\r\n        self.update_info_panel()\r\n        return self.lb.SelectedRows\r\n\r\n\r\n\r\n    # function to run when call at button click\r\n    def pretty_print_knowledge_data(self):\r\n        # return selected items\r\n        import pprint\r\n\r\n        text = pprint.pformat(self.knowledge, indent = 4)\r\n        rs.TextOut(text)\r\n\r\n\r\n\r\n    # event handler handling text input in ther search bar\r\n    def tB_Search_TextChanged(self, sender, e):\r\n        self.Search(self.tB_Search.Text)\r\n\r\n    def checkbox_search_in_tooltip_CheckedChanged(self, sender, e):\r\n        self.Search(self.tB_Search.Text)\r\n\r\n    def btn_command_Clicked(self, sender, e):\r\n        self.Close(True)\r\n        data = self.knowledge[self.selected_button_name]\r\n        commands = data.get(\"alias\", None)\r\n        if not isinstance(commands, list):\r\n            commands = [commands]\r\n        final_commands = []\r\n        for command in commands:\r\n            if command is None:\r\n                continue\r\n            if command.upper() == command:\r\n                final_commands.append(command)\r\n            else:\r\n                final_commands.append(\"EA_{}\".format(command))\r\n      \r\n        rs.Command(final_commands[0], False)\r\n        \r\n    # event handler handling clicking on the 'run' button\r\n    def btn_Run_Clicked(self, sender, e):\r\n        #logger.info(\"Run button clicked\")\r\n        # close window after double click action. Otherwise, run with error\r\n\r\n        #print sender\r\n        #print e\r\n        #print self.lb.SelectedItems\r\n        #print dir(self.lb)\r\n        #print len(list(self.lb.SelectedItems))\r\n        #print len(list(self.lb.SelectedRows))\r\n        # if len(list(self.lb.SelectedItems)) == 0:\r\n        #     NOTIFICATION.toast(main_text = \"Need to select at least something\")\r\n        #     return\r\n        # self.Close(True)\r\n        self.pretty_print_knowledge_data()\r\n\r\n\r\n    # event handler handling clicking on the 'run' button\r\n    def btn_select_all_Clicked(self, sender, e):\r\n        # close window after double click action. Otherwise, run with error\r\n        self.lb.SelectAll()\r\n        NOTIFICATION.toast(main_text = \"{} items slected\".format(len(self.SearchedScriptList)))\r\n\r\n\r\n    # event handler handling clicking on the 'cancel' button\r\n    def btn_Cancel_Clicked(self, sender, e):\r\n        #logger.info(\"Cancel button clicked\")\r\n        self.Close(False)\r\n\r\n    def btn_repair_Clicked(self, sender, e):\r\n        \"\"\"Repair the EnneadTab toolbar by resetting its state.\"\"\"\r\n        options = [\"Yes, I have done that. Let's go!\", \"No, cancel repair.\"]\r\n        res = rs.ListBox(options, \r\n                         title = \"Getting ready....\", \r\n                         message = \"I want you to have ONLY ONE empty Rhino file open, can you do that?\")\r\n        if res == options[1]:\r\n            return\r\n\r\n        for folder in os.listdir(ENVIRONMENT.RHINO_FOLDER):\r\n            if \".menu\" in folder:\r\n                menu_folder = os.path.join(ENVIRONMENT.RHINO_FOLDER, folder)\r\n                get_latest_path = os.path.join(menu_folder, \"get_latest.button\")\r\n                import sys\r\n                sys.path.append(get_latest_path)\r\n                import get_latest_left as GL #type: ignore\r\n                GL.get_latest()\r\n                break\r\n        else:\r\n            return\r\n\r\n        self.Close(False)\r\n        rs.MessageBox(\"Please restart Rhino to bake the changes.\")\r\n        \r\n\r\n\r\n@LOG.log(__file__, __title__)\r\n@ERROR_HANDLE.try_catch_error()\r\ndef search_command():\r\n    #logger.info(\"Starting search command\")\r\n    RHINO_ALIAS.register_alias_set()\r\n    \r\n    dlg = EnneadSearchDialog()\r\n    rc = Rhino.UI.EtoExtensions.ShowSemiModal(dlg, Rhino.RhinoDoc.ActiveDoc, Rhino.UI.RhinoEtoApp.MainWindow)\r\n\r\n\r\n\r\n\r\nif __name__ == \"__main__\":\r\n    search_command()",
  "language": "python",
  "imports": [
    "Rhino",
    "rhinoscriptsyntax"
  ],
  "has_docstring": false
}