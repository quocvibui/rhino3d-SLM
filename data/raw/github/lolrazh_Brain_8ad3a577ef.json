{
  "source_url": "https://github.com/lolrazh/Brain/blob/e196b550bb0fa6cd615d9b9f3aa6e2824078073c/src/brain.py",
  "repo": "lolrazh/Brain",
  "repo_stars": 4,
  "repo_description": "Brain is a GPT-powered Grasshopper component, that lets you control your scripts through natural language.",
  "license": "LGPL-3.0",
  "filepath": "src/brain.py",
  "instruction": null,
  "code": "from ghpythonlib.componentbase import dotnetcompiledcomponent as component\r\nimport Grasshopper, GhPython\r\nimport System\r\nimport Rhino\r\nimport rhinoscriptsyntax as rs\r\nimport clr\r\nimport json\r\nimport traceback\r\nimport System\r\nfrom System import Array\r\nfrom System.Text import Encoding\r\nfrom System.Net import WebRequest, WebHeaderCollection, WebProxy, WebException\r\n\r\n\r\n# FUNCTION TO SEND API CALL\r\ndef send_request(user_prompt, Description, API_Key):\r\n    plugin_context = \"You are GrasshopperAI, an AI tool working within Grasshopper to manipulate Grasshopper scripts through natural language. You will be given a description of the entire script and data about the sliders in the format <SLIDER_NAME> - <SLIDER_VALUE>. After understanding the prompt, you have to understand what slider to change and what the new slider value would be. To do that, all you have to do is call a function that I have already programmed which is change_slider_value(str(<SLIDER_NAME>), <NEW_SLIDER_VALUE>). Remember to respond only with the function and enclose the name in an str() function.\" # system prompt for gpt\r\n    url = \"https://api.openai.com/v1/chat/completions\"  # reference api url\r\n    data = { # prepare data for request\r\n        \"model\": \"gpt-3.5-turbo-16k\", # gpt model, gpt-3.5 is much cheaper to run than gpt4\r\n        \"messages\": [\r\n            {\r\n                \"role\": \"system\",\r\n                \"content\": str(plugin_context) + \"\\n\" + \"\\n\" + str(Description)  # system prompt is set up here\r\n            },\r\n            {\r\n                \"role\": \"user\",\r\n                \"content\": user_prompt  # user prompt goes here\r\n            }\r\n        ],\r\n        \"temperature\": 0.5,\r\n        \"max_tokens\": 4096,\r\n        \"top_p\": 1,\r\n        \"frequency_penalty\": 0,\r\n        \"presence_penalty\": 0\r\n    }\r\n    data_string = json.dumps(data)\r\n    data_bytes = Encoding.UTF8.GetBytes(data_string)\r\n    request = WebRequest.Create(url) # create a web request\r\n    request.Method = \"POST\"\r\n    request.ContentType = \"application/json\"\r\n    request.Headers.Add(\"Authorization\", \"Bearer \" + str(API_Key)) # authentication\r\n    request_stream = request.GetRequestStream() # write request to data stream\r\n    request_stream.Write(Array[System.Byte](data_bytes), 0, len(data_bytes))\r\n    request_stream.Close()\r\n    try:\r\n        response = request.GetResponse()\r\n        response_stream = response.GetResponseStream()\r\n        response_reader = System.IO.StreamReader(response_stream)\r\n        response_text = response_reader.ReadToEnd()\r\n\r\n        response_json = json.loads(response_text) # get response from openai\r\n        return response_json\r\n\r\n    except WebException as e: # error handling\r\n        display_error(str(e))\r\n        return None\r\n\r\n\r\n# DEFINE USER PROMPT HERE\r\ndef construct_prompt(param_data):\r\n    sliders = str(param_data)[1:-1] # get slider data\r\n    user_prompt = rs.StringBox(message=\"Enter prompt\", title=\"Brain\")\r\n    if user_prompt is None:  # check if user cancelled the input\r\n        return None\r\n    prompt = str(sliders) + \"\\n\" + \"\\n\" + str(user_prompt) # construct prompt\r\n    return prompt\r\n\r\n\r\nclass Brain(component): # set up component class\r\n    def __new__(cls):\r\n        instance = Grasshopper.Kernel.GH_Component.__new__(cls,\r\n            \"Brain\", \"Brain\", \"\"\"Uses GPT to manipulate Grasshopper scripts through natural language.\"\"\", \"Params\", \"Util\") # component info\r\n        return instance\r\n    \r\n    def get_ComponentGuid(self):\r\n        return System.Guid(\"bc7f32af-9b9c-4cf6-938a-21b24702c0da\")\r\n    \r\n    def SetUpParam(self, p, name, nickname, description): # set up component parameters\r\n        p.Name = name\r\n        p.NickName = nickname\r\n        p.Description = description\r\n        p.Optional = True\r\n    \r\n    def RegisterInputParams(self, pManager):\r\n        p = Grasshopper.Kernel.Parameters.Param_Number()\r\n        self.SetUpParam(p, \"Parameters\", \"P\", \"Parameters to control\")\r\n        p.Access = Grasshopper.Kernel.GH_ParamAccess.list\r\n        self.Params.Input.Add(p)\r\n        \r\n        p = Grasshopper.Kernel.Parameters.Param_String()\r\n        self.SetUpParam(p, \"API_Key\", \"K\", \"OpenAI API Key\")\r\n        p.Access = Grasshopper.Kernel.GH_ParamAccess.item\r\n        self.Params.Input.Add(p)\r\n        \r\n        p = Grasshopper.Kernel.Parameters.Param_String()\r\n        self.SetUpParam(p, \"Description\", \"D\", \"A brief description of the GH definition\")\r\n        p.Access = Grasshopper.Kernel.GH_ParamAccess.item\r\n        self.Params.Input.Add(p)\r\n        \r\n        p = Grasshopper.Kernel.Parameters.Param_Boolean()\r\n        self.SetUpParam(p, \"Trigger\", \"R\", \"Runs the component\")\r\n        p.Access = Grasshopper.Kernel.GH_ParamAccess.item\r\n        self.Params.Input.Add(p)\r\n        \r\n    def RegisterOutputParams(self, pManager):\r\n        pass    \r\n\r\n    def SolveInstance(self, DA):\r\n        p0 = self.marshal.GetInput(DA, 0)\r\n        p1 = self.marshal.GetInput(DA, 1)\r\n        p2 = self.marshal.GetInput(DA, 2)\r\n        p3 = self.marshal.GetInput(DA, 3)\r\n        result = self.RunScript(p0, p1, p2, p3)\r\n\r\n    def get_Internal_Icon_24x24(self): # component icon\r\n        o = \"iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAYAAADgdz34AAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAAFiUAABYlAUlSJPAAAAI6SURBVEhLvdVJyE5RHMfxa54zZYqQspAsJDZkLgtZGBYoUli9xcKwYMdKWFmYsjBmWGBhxUqRjQgrJXNKUobM0/d77jk99z3v875vj0d+9em553Tv+d9znnPvLRpMn/j7TzIBY9AVk3AFvyt+4TrGoaGsxWM4gO7jG37iAtZhYzy20FtMQ6fpi4vwouc4hZOx/QJTkWcxPsEbGmhHR0mD7URvO8guOIsZoVWme9QPw7ABXteCdjMbnrQ3tMpMgX2HQ6sopuMdLPgFLpm+w/NeYyHqxkE8aVRoFUUX3MQHjLCDOLiDPcFRrMECWNhZW9QxDsEZtspdeHHKSnjyptAql+8HVoVW/YzEPnjdETuquQOna9yWz2Dbfe9SfcV7WHg1lkbL4u9wGGd+BhaZZUfKHtjpfjdX4Yx8Fs7BYs6guuZV15AyFC7XwdCKGQ//vMuhVT48nuRWddAtGILJmIM3yIusQIpb91Z5WMtxeOL80Kr98bdDq3XcmhauFngInyXjLG+Uh7UMhmv9CP4PnvwRB5BnIqqDJ9vQAxY4hjbZDk9cH1rlVvQ14fJU41K6pHmBl3DtPV6ENvHOH8Dpb8VyWOAS5sIH8iy8w0E4gbyITqPdzIQDeIfuHPmnfYZLaHszjFs2H/wVOn0vdUOvqGc0AKMxFsa+e8gLuEz90XTSSy73FOll+dfxYfJO6xU4j6azH/UG1zw0Fb9e6c2Z8/vRdNI+r3LndPjBaSR+xZZgB3bDb3TaWf87RfEHQBfFoHsNd3QAAAAASUVORK5CYII=\"\r\n        return System.Drawing.Bitmap(System.IO.MemoryStream(System.Convert.FromBase64String(o)))\r\n\r\n    def RunScript(self, Parameters, API_Key, Description, Trigger):\r\n        # FUNCTION FOR ERROR HANDLING\r\n        def display_error(message): # display error box\r\n            rs.MessageBox(message, 16, \"Error\")\r\n        # FUNCTION TO CHANGE SLIDER VALUE\r\n        def change_slider_value(nickname, value):\r\n            ghdoc = self.OnPingDocument()\r\n            if not ghdoc:\r\n                display_error(\"Error accessing Grasshopper document.\")\r\n                return\r\n            for obj in ghdoc.Objects:\r\n                if isinstance(obj, Grasshopper.Kernel.Special.GH_NumberSlider) and obj.NickName == nickname:\r\n                    if obj.Slider.Minimum <= value <= obj.Slider.Maximum: # check slider domains\r\n                        obj.SetSliderValue(value)\r\n                        obj.ExpireSolution(True)\r\n                    else:\r\n                        display_error(\"{} is out of range for '{}'.\".format(value, nickname)) # error handling\r\n\r\n        # START RUNSCRIPT\r\n        ghdoc = self.OnPingDocument()\r\n        if not ghdoc:\r\n            display_error(\"Error accessing Grasshopper document.\") # error handling\r\n        else:\r\n            input_params = self.Params.Input[0].Sources if self.Params.Input else [] # get component inputs\r\n            param_data = [(param.NickName, param.CurrentValue) for param in input_params if isinstance(param, Grasshopper.Kernel.Special.GH_NumberSlider)] # get slider data\r\n        if param_data:\r\n            if Trigger:\r\n                prompt = construct_prompt(param_data) # construct user prompt\r\n                if prompt is not None: # avoid running when user hits cancel\r\n                    response = send_request(prompt, Description, API_Key) # send api call\r\n                    if response:  # check if response is not None\r\n                        function = response['choices'][0]['message']['content'] # pick out the answer from the response json\r\n                        try:\r\n                            eval(str(function)) # call function\r\n                        except Exception as e:  # catch exceptions raised during the evaluation\r\n                            display_error(\"Error evaluating function: {}\".format(str(e)))\r\n                    else:\r\n                        display_error(\"Failed to get a valid response from the OpenAI API.\")\r\n                else:\r\n                    pass\r\n\r\n\r\nimport GhPython\r\nimport System\r\n\r\nclass AssemblyInfo(GhPython.Assemblies.PythonAssemblyInfo):\r\n    def get_AssemblyName(self):\r\n        return \"Brain\"\r\n    \r\n    def get_AssemblyDescription(self):\r\n        return \"\"\"\"\"\"\r\n\r\n    def get_AssemblyVersion(self):\r\n        return \"0.1\"\r\n\r\n    def get_AuthorName(self):\r\n        return \"Sandheep Rajkumar\" # haha me hahaha\r\n    \r\n    def get_Id(self):\r\n        return System.Guid(\"88adbca2-bd32-4edc-9be2-9ebf3faaf3fb\")\r\n",
  "language": "python",
  "imports": [
    "Rhino",
    "ghpythonlib",
    "rhinoscriptsyntax"
  ],
  "has_docstring": false
}