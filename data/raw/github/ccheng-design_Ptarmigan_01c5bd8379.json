{
  "source_url": "https://github.com/ccheng-design/Ptarmigan/blob/210535af589ef10aef38c78100aea1fcf96e9d6c/01_RHINO/_SOURCE%20CODE/BOM.py",
  "repo": "ccheng-design/Ptarmigan",
  "repo_stars": 3,
  "repo_description": "Rhino, Grasshopper, Houdini Scripts",
  "license": "MIT",
  "filepath": "01_RHINO/_SOURCE CODE/BOM.py",
  "instruction": null,
  "code": "import rhinoscriptsyntax as rs\nimport Rhino\nimport scriptcontext as sc\nimport sys\n\n# BOM\n# Creates bill of materials based on the blocks being in the BOM layer (user defined)\n\nitems = (\"Use_BOM_Layer\", \"No\", \"Yes\")\nresults = rs.GetBoolean(\"Use BOM Layer\", items, (True))\n\nif results is None:\n    print(\"None Selected\")\n    sys.exit()\n\n# Definition on block list counting\ndef block_list_count():\n    # Create list and dictionary to hold keys and values\n    block_list = []\n    block_desc = []\n    counts = {}\n    font=\"Roboto\"\n\n    # for each object in the layer, check if it is a block\n    for obj in layer:\n        if rs.IsBlockInstance(obj):\n            block_name = rs.BlockInstanceName(obj)\n            block_description = rs.BlockDescription(block_name) or \"XXXX\"\n            block_list.append(block_name)\n            block_desc.append(block_description)\n\n    # Sort both block names and block descriptions together to maintain alignment\n    block_list_desc = sorted(zip(block_list, block_desc))\n\n    # Unzip back into two lists (sorted and aligned)\n    block_list, block_desc = zip(*block_list_desc)\n\n    # Count the occurrences of each block\n    for block_name in block_list:\n        counts[block_name] = counts.get(block_name, 0) + 1\n\n    # Filter the descriptions by making sure there are no duplicates\n    unique_block_desc = []\n    for name, description in zip(block_list, block_desc):\n        if (name, description) not in unique_block_desc:\n            unique_block_desc.append((name, description))\n\n    # Separate the names and descriptions after filtering\n    filtered_block_list, filtered_block_desc = zip(*unique_block_desc)\n\n    # Now display the filtered names, descriptions, and counts\n    key_list = list(counts.keys())\n    values_list = list(counts.values())\n    uniq_desc = list(filtered_block_desc)\n\n    # Get maximum lengths for string display\n    key_list_length = [len(string) for string in key_list]\n    block_desc_length = [len(string) for string in uniq_desc]\n\n    max_length_desc = max(block_desc_length)\n    max_length_names = max(key_list_length)\n\n    pt = rs.GetPoint(\"Pick Point\")\n    text_height = rs.GetReal(\"Text_Height\", 0.1)\n    if text_height is None:\n        return\n\n    # Spacings\n    spacingy = text_height *2\n    spacingx_name = max_length_names * text_height * 1.7\n    spacingx_desc = (max_length_names * text_height) + (max_length_desc * text_height * 1.4)+0.8\n    spacingx_amt = spacingx_desc *1.2\n\n    vector_y = Rhino.Geometry.Vector3d(0, -spacingy, 0)\n    vector_x_names = Rhino.Geometry.Vector3d(spacingx_name, 0, 0)\n    vector_x_desc = Rhino.Geometry.Vector3d(spacingx_desc, 0, 0)\n    vector_x_amt = Rhino.Geometry.Vector3d(spacingx_amt, 0, 0)\n    pg_num_vector = Rhino.Geometry.Vector3d(spacingx_name + (text_height * 3), 0, 0)\n\n    # Define the x direction\n    x_dir = pt + vector_x_names\n    x_dir_desc = pt + vector_x_desc\n    blk_amt = pt + vector_x_amt\n\n    vector_x_names.Unitize()  # Unitize the vector\n    length = spacingx_name\n    scaled_vector = vector_x_names * length * 0.8\n\n    left = []\n    left_middle = []\n    right_middle = []\n    right = []\n\n    \n\n    #Title block\n    \n    global_text_offset=Rhino.Geometry.Vector3d(text_height*1.02,0,0)\n\n    #store headers in a list\n    headers=[\"ITEMS\",\"PART NO\",\"PART_DESC\",\"QTY\"]\n\n    #ITEM\n    item_offset=-0.05\n    item_pt=pt+Rhino.Geometry.Vector3d(item_offset,0,0)-(vector_y/2)\n    #rs.AddPoint(item_pt)\n\n    rs.AddText(\"ITEM\",item_pt,text_height,font,justification=131076)\n\n\n    #PART NO\n    \n    title_block_pts=(pt-(vector_y/2))+Rhino.Geometry.Vector3d(text_height*1.02,0,0)\n    #rs.AddPoint(title_block_pts)\n\n    item_name=rs.AddText(\"PART NO\",title_block_pts,text_height,font,justification=131073)\n\n    #PART DESCR\n    part_desc_pt=(x_dir_desc-(vector_y/2))-global_text_offset\n    #rs.AddPoint(part_desc_pt)\n\n    part_descr_name=rs.AddText(\"PART DESCR\",part_desc_pt,text_height,font,justification=131076)\n\n    #QTY\n    quantity_pt=blk_amt-(vector_y/2)-global_text_offset\n    #rs.AddPoint(quantity_pt)\n\n    quantity_name=rs.AddText(\"QTY\",quantity_pt,text_height,font,justification=131076)\n\n\n    #Lines for title blocks\n    #Top lines\n    item_ln_offset=(-4*text_height)*((item_offset*-1)+1)\n\n    pt_1=pt-vector_y\n    #rs.AddPoint(pt_1)\n    pt_2=blk_amt-vector_y\n    #rs.AddPoint(pt_2)\n\n    #Header\n    header_pt=blk_amt-vector_y\n    \n\n    print(pt_2-(pt_1+Rhino.Geometry.Vector3d(item_ln_offset,0,0)))\n\n    header_pt=rs.AddPoint((pt_1+Rhino.Geometry.Vector3d(item_ln_offset,0,0))+((pt_2-(pt_1+Rhino.Geometry.Vector3d(item_ln_offset,-0.5,0)))/2))\n\n    header_text=rs.StringBox(message=\"Bill of Materials Header Name\", default_value=None, title=\"BOM Header\")\n\n    rs.AddText(header_text.upper(),header_pt,0.1,justification=2)\n\n    #rs.AddPoint(pt_1+Rhino.Geometry.Vector3d(item_ln_offset,0,0))\n    \n    #top horizontial line\n    rs.AddLine(pt_1+Rhino.Geometry.Vector3d(item_ln_offset,0,0),pt_2)\n\n    #vertial lines\n    \n    rs.AddLine(pt_1,pt+(vector_y/2))\n\n    rs.AddLine(x_dir_desc+(vector_y/2),x_dir_desc-(vector_y))\n\n    rs.AddLine(blk_amt+(vector_y/2),blk_amt-vector_y)\n    \n    #rs.AddLine()\n\n    \n    \n\n    items_number=[]\n    Left_horiz_ln=[]\n\n    item_num_csv=[]\n    block_names=[]\n    block_description=[]\n    block_amounts=[]\n\n    # Add text for block names\n    for items in key_list:\n        pt += vector_y\n        \n        new_pt=pt+Rhino.Geometry.Vector3d(item_ln_offset,0,0)+(vector_y/2)\n        Left_horiz_ln.append((pt+Rhino.Geometry.Vector3d(item_ln_offset,0,0)+(vector_y/2)))\n\n        \n\n        items_number.append(pt)\n\n        \n\n\n        \n\n        # Horizontial Line Bottom\n        offset_y = Rhino.Geometry.Vector3d(0, (spacingy / 2), 0)\n        \n        bottom_crv=rs.AddLine(new_pt,pt+vector_x_amt-offset_y)\n\n        # Horizontial Line Top\n        transform=Rhino.Geometry.Transform.Translation(offset_y*2)\n        \n        top_crv=rs.coercecurve(bottom_crv)\n        top_crv.Transform(transform)\n\n        sc.doc.Objects.AddCurve(top_crv)\n        # Left Line\n        l = rs.AddLine((pt + offset_y), (pt - offset_y))\n        left.append(l)\n\n        # Left Middle Line\n        \n        lm = rs.AddLine((pt + scaled_vector + offset_y), (pt + scaled_vector - offset_y))\n        \n        left_middle.append(lm)\n\n        # Add text\n        offset_pt=pt+Rhino.Geometry.Vector3d(text_height*1.02,0,0)\n        rs.AddText(items.upper(), offset_pt, text_height,font, justification=131073)\n        block_names.append(items.upper())\n\n\n    rs.AddPolyline(Left_horiz_ln)\n    rs.AddLine(pt_1+Rhino.Geometry.Vector3d(item_ln_offset,0,0),Left_horiz_ln[0])\n\n    total=len(items_number)\n    total_numbers=[]\n    total_pts=[]\n\n    #Numbers for items numbers\n    for i in range(1,total+1):\n        total_numbers.append(i)\n\n    \n    #print(total_numbers)\n    \n    #Item numbers\n    for item in items_number:\n        offset_x=Rhino.Geometry.Vector3d(item_offset,0,0)\n        \n        pt=item+offset_x\n        #rs.AddPoint(pt)\n        total_pts.append(pt)\n    \n    for point,num in zip(total_pts,total_numbers):\n        rs.AddText(num,point,text_height,font,justification=131076)\n        item_num_csv.append(num)\n\n     \n\n    # Add text for block descriptions\n    for i in uniq_desc:\n        x_dir_desc += vector_y\n        #rs.AddPoint(x_dir_desc)\n        \n\n        # Right Middle Line\n        rm = rs.AddLine((x_dir_desc + offset_y), (x_dir_desc - offset_y))\n        right_middle.append(rm)\n\n        offset_desc=x_dir_desc-global_text_offset\n        rs.AddText(i.upper(), offset_desc, text_height,font, justification=131076)\n        block_description.append(i.upper())\n\n    # Add text for block counts\n    for items in values_list:\n        blk_amt += vector_y\n\n        # Right Line\n        r = rs.AddLine((blk_amt - (vector_y / 2)), (blk_amt + (vector_y / 2)))\n        right.append(r)\n\n        #rs.AddPoint(blk_amt)\n\n        offset_count=blk_amt-global_text_offset\n        rs.AddText(items, offset_count, text_height, font, justification=131076)\n        block_amounts.append(items)\n\n    # Join left middle side of curves and simplify\n    if len(left_middle) != 1:\n        a = rs.JoinCurves(left_middle, True)\n        rs.SimplifyCurve(a)\n        c=rs.coercecurve(a)\n        start_pt=c.PointAtStart\n        x=Rhino.Geometry.Line(start_pt,vector_y,spacingy*-1.5)\n        \n\n        sc.doc.Objects.AddCurve(Rhino.Geometry.LineCurve(x))\n        \n\n    # Join left side of curves and simplify\n    if len(left) != 1:\n        a = rs.JoinCurves(left, True)\n        rs.SimplifyCurve(a)\n        \n\n    # Join right middle side of curves and simplify\n    if len(right_middle) != 1:\n        a = rs.JoinCurves(right_middle, True)\n        rs.SimplifyCurve(a)\n        \n\n    \n\n    # Join right side of curves and simplify\n    if len(right) != 1:\n        a = rs.JoinCurves(right, True)\n        rs.SimplifyCurve(a)\n        \n    #print(item_num_csv, block_names,block_description,block_amounts)\n\n    export_options = (\"Export_as_CSV\",\"No\",\"Yes\")\n    export_csv = rs.GetBoolean(\"Export as CSV?\", export_options, False)\n\n    if export_csv == [True]:\n\n\n        #Excel exporting\n        combined_lists=[item_num_csv, block_names,block_description,block_amounts]\n\n        export = [list(row) for row in zip(*combined_lists)]\n        #print(export)\n\n        #Empty string\n        csv_data=\"\"\n\n        #for each string in export, add a comma and convert to string\n        for string in export:\n            \n                \n                \n            row=\",\".join(map(str,string))\n            \n\n            #add to empty string\n            csv_data+=row+\"\\n\"\n        \n        #print(csv_data)\n\n        filepath=rs.SaveFileName(\"Save CSV\",\"CSV Files (*.csv)|*.csv||\")\n        \n        if filepath is None:\n            return\n        else:\n            with open(filepath,'w') as file:\n                file.write(csv_data)\n            print(\"File has been saved to\",filepath)\n    else:\n        return\n        \n    \n\n\nif results == [True]:\n    # Check if BOM layer exists in document\n    if not rs.IsLayer(\"BOM\"):\n        print(\"Make BOM Layer\")\n    else:\n    \n        if rs.IsLayerEmpty(\"BOM\")==True:\n            print(\"Layer is empty\")\n            sys.exit()\n        else:\n            # Read from the Layer BOM\n            layername = rs.LayerName(\"BOM\")\n\n            # Get objects by layer name\n            layer = rs.ObjectsByLayer(layername, True)\n\n            # Run the function\n            block_list_count()\n    \n\n\nelse:\n    # Get all blocks from Rhino Environment\n    layer = rs.ObjectsByType(4096)\n    block_list_count()\n",
  "language": "python",
  "imports": [
    "Rhino",
    "Rhino.Geometry",
    "rhinoscriptsyntax",
    "scriptcontext"
  ],
  "has_docstring": false
}