{
  "source_url": "https://github.com/ibois-epfl/augmented-carpentry/blob/414eeb93984fad40a4e57daa60e1bb268cbd406c/eval/gh_script/hole_evaluator.py",
  "repo": "ibois-epfl/augmented-carpentry",
  "repo_stars": 15,
  "repo_description": "Main repository hosting the main AR software developed for Augmented Carpentry rersearch at Ibois, Epfl.",
  "license": "GPL-3.0",
  "filepath": "eval/gh_script/hole_evaluator.py",
  "instruction": "Hole evaluator",
  "code": "#! python3\n\nimport math\nfrom datetime import datetime\nimport csv\nimport os\nimport typing\n\nimport Rhino\nimport Rhino.Geometry as rg\n\nimport ghpythonlib.treehelpers as th\n\n\ndef truncate_float(value, decimal_places):\n    factor = 10 ** decimal_places\n    return math.trunc(value * factor) / factor\n\ndef get_farthest_faces(faces):\n    max_distance = 0\n    farthest_pair = (None, None)\n    \n    # Calculate the center of each face\n    centers = [face.GetBoundingBox(True).Center for face in faces]\n    \n    # Compute the distance between each pair of centers\n    for i in range(len(centers)):\n        for j in range(i + 1, len(centers)):\n            distance = centers[i].DistanceTo(centers[j])\n            if distance > max_distance:\n                max_distance = distance\n                farthest_pair = (faces[i], faces[j])\n    \n    return farthest_pair\n\ndef get_hole_axis(hole) -> typing.Tuple[rg.Vector3d, rg.Point3d, rg.Point3d]:\n    faces = hole.Faces\n    face1, face2 = get_farthest_faces(faces)\n    axis_from = rg.Point3d(face1.GetBoundingBox(True).Center)\n    axis_to = rg.Point3d(face2.GetBoundingBox(True).Center)\n    if axis_from.Z < axis_to.Z:\n        axis_from, axis_to = axis_to, axis_from\n    axis = axis_to - axis_from\n\n    return axis, axis_from, axis_to\n\ndef main(\n    i_out_path,\n    i_csv_export,\n    i_plate_pln,\n    i_gt_holes,\n    i_cp_holes\n) -> typing.Tuple[\n        typing.List[typing.Tuple[rg.Point3d]],\n        typing.List[typing.Tuple[rg.Vector3d]]\n    ]:\n    ## 1) get the axes of the two sets:\n    ##    - get the two smallest brepfaces , get their centers, create the vectors\n    ## 2) get info of vectors:\n    ##    - name/id of the hole\n    ##    - drilling angle (gt)\n    ## 3) compute the evaluation metrics:\n    ##    - 3.a) difference angle\n    ##    - 3.b) starting point difference (distance*)\n    ##        - the starting point is the center of the ellypse intersection with the place with the plate\n    ##    - 3.c) ending point difference (distance between end of vectors)\n    ## 4) export everything in a csv file\n    \n    o_debug = []\n    o_axes: typing.List[typing.Tuple[rg.Vector3d]] = []\n    o_anchors: typing.List[typing.Tuple[rg.Point3d]] = []\n\n    ## 1) get the axes of the two sets\n    gt_holes = i_gt_holes\n    cp_holes = i_cp_holes\n    gt_axes = []\n    gt_anchors = []\n    gt_endpoints = []\n    cp_axes = []\n    cp_anchors = []\n    cp_endpoints = []\n    for gt_h in gt_holes:\n        gt_axis, gt_anchor, gt_endpoint = get_hole_axis(gt_h)\n        gt_axes.append(gt_axis)\n        gt_anchors.append(gt_anchor)\n        gt_endpoints.append(gt_endpoint)\n    for cp_h in cp_holes:\n        cp_axis, cp_anchor, cp_endpoint = get_hole_axis(cp_h)\n        cp_axes.append(cp_axis)\n        cp_anchors.append(cp_anchor)\n        cp_endpoints.append(cp_endpoint)\n\n    ## 2) get info of vectors\n    # name hole\n    id_holes: typing.List[str] = []\n    alphabet = \"abcdefghilmnopqrst\"\n    for i in range(18):\n        for j in range(6):\n            id_holes.append(alphabet[i] + str(j + 1))\n\n    # drilling angle\n    refrence_vector = rg.Vector3d(0, 0, -1)\n    gt_angles = []\n    cp_angles = []\n\n    for gt_axis in gt_axes:\n        angle = rg.Vector3d.VectorAngle(gt_axis, refrence_vector)\n        degree = truncate_float((angle * 180 / 3.141592653589793), 1)\n        gt_angles.append(degree)\n\n    for cp_axis in cp_axes:\n        angle = rg.Vector3d.VectorAngle(cp_axis, refrence_vector)\n        degree = truncate_float((angle * 180 / 3.141592653589793), 1)\n        cp_angles.append(degree)\n\n    ## 3) compute the evaluation metrics\n    # difference angles\n    err_diff_angles = []\n    for i in range(len(gt_axes)):\n        angle = rg.Vector3d.VectorAngle(gt_axes[i], cp_axes[i])\n        degree = truncate_float((angle * 180 / 3.141592653589793), 1)\n        err_diff_angles.append(degree)\n\n    # starting point difference\n    err_dist_start = []\n    for i in range(len(gt_axes)):\n        gt_ln = rg.Line(gt_anchors[i], gt_endpoints[i])\n        gt_line_param, _ = rg.Intersect.Intersection.LinePlane(gt_ln, i_plate_pln)\n        gt_pt_start = gt_ln.PointAt(gt_line_param)\n        cp_ln = rg.Line(cp_anchors[i], cp_endpoints[i])\n        gt_line_param, _ = rg.Intersect.Intersection.LinePlane(cp_ln, i_plate_pln)\n        cp_pt_start = cp_ln.PointAt(gt_line_param)\n        err_dist_start.append(gt_pt_start.DistanceTo(cp_pt_start))\n\n    # ending point difference (distance between end of vectors)\n    err_dist_end = []\n    err_dist_end = [gt_endpoints[i].DistanceTo(cp_endpoints[i]) for i in range(len(gt_endpoints))]\n\n    ## 4) export everything in a csv file\n    if i_csv_export:\n        if not os.path.exists(i_out_path):\n            os.makedirs(i_out_path)\n\n        timestamp = datetime.now().strftime(\"%Y%m%d_%H%M%S\")\n        file_name = timestamp + \"_hole_evaluation.csv\"\n        csv_file = os.path.join(i_out_path, file_name)\n\n        with open(csv_file, mode='w', newline='') as file:\n            writer = csv.writer(file)\n            writer.writerow([\"Hole ID\", \"Drilling Angle (GT)\", \"Drilling Angle (CP)\", \"Difference Angle (deg)\", \"Starting Point Difference (m)\", \"Ending Point Difference (m)\"])\n            for i in range(len(id_holes)):\n                writer.writerow([id_holes[i], gt_angles[i], cp_angles[i], err_diff_angles[i], err_dist_start[i], err_dist_end[i]])\n\n    o_debug = err_diff_angles\n\n    return [gt_axes, cp_axes], [gt_anchors, cp_anchors], o_debug\n\nif __name__ == \"__main__\":\n    o_axes, o_anchors, o_debug = main(\n        i_out_path,\n        i_csv_export,\n        i_plate_pln,\n        i_gt_holes,\n        i_cp_holes\n    )",
  "language": "python",
  "imports": [
    "Rhino",
    "Rhino.Geometry",
    "ghpythonlib"
  ],
  "has_docstring": false
}