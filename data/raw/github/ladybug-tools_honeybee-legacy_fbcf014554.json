{
  "source_url": "https://github.com/ladybug-tools/honeybee-legacy/blob/bd62af4862fe022801fb87dbc8794fdf1dff73a9/src/Honeybee_Glare%20Analysis.py",
  "repo": "ladybug-tools/honeybee-legacy",
  "repo_stars": 129,
  "repo_description": ":bee: Honeybee is a free and open source plugin to connect Grasshopper3D to EnergyPlus, Radiance, Daysim and OpenStudio for building energy and daylighting simulation",
  "license": "NOASSERTION",
  "filepath": "src/Honeybee_Glare Analysis.py",
  "instruction": "Glare Analysis",
  "code": "#\n# Honeybee: A Plugin for Environmental Analysis (GPL) started by Mostapha Sadeghipour Roudsari\n# \n# This file is part of Honeybee.\n# \n# Copyright (c) 2013-2020, Mostapha Sadeghipour Roudsari <mostapha@ladybug.tools> \n# Honeybee is free software; you can redistribute it and/or modify \n# it under the terms of the GNU General Public License as published \n# by the Free Software Foundation; either version 3 of the License, \n# or (at your option) any later version. \n# \n# Honeybee is distributed in the hope that it will be useful,\n# but WITHOUT ANY WARRANTY; without even the implied warranty of \n# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the \n# GNU General Public License for more details.\n# \n# You should have received a copy of the GNU General Public License\n# along with Honeybee; If not, see <http://www.gnu.org/licenses/>.\n# \n# @license GPL-3.0+ <http://spdx.org/licenses/GPL-3.0+>\n\n\n\"\"\"\nGlare Analysis\n\nThis component is using evalglare for glare calculations. Evalgalare is developed by J. Wienold at Fraunhofer ISE.\nhttp://www.ise.fraunhofer.de/en/\n\nCheck this link for more information about glare analysis. Thanks to Christoph Reinhart, Shelby Doyle, J Alstan Jakubiec and Rashida Mogri.\nhttp://web.mit.edu/tito_/www/Projects/Glare/GlareRecommendationsForPractice.html\n\n-\nProvided by Honeybee 0.0.66\n    \n    Args:\n        _HDRImagePath: Path to an HDR image file\n        taskPositionUV_: Task position in x and y coordinates\n        taskPositionAngle_: Task position opening angle in degrees\n        _runIt: Set to True to run the analysis\n    Returns:\n        readMe: ...\n        glareCheckImage: Path to HDR image of the glare study\n        DGP: Daylight glare probability. \n        DGI: Daylight glare index\n        glareComfortRange: Comfort Ranges. Imperceptible Glare [0.35 > DGP], Perceptible Glare [0.4 > DGP >= 0.35], Disturbing Glare [0.45 > DGP >= 0.4], Intolerable Glare [DGP >= 0.45] \n        imageWithTaskArea: Path to HDR image with task area marked with blue circle\n\n\"\"\"\n\nghenv.Component.Name = \"Honeybee_Glare Analysis\"\nghenv.Component.NickName = 'glareAnalysis'\nghenv.Component.Message = 'VER 0.0.66\\nJUL_07_2020'\nghenv.Component.IconDisplayMode = ghenv.Component.IconDisplayMode.application\nghenv.Component.Category = \"HB-Legacy\"\nghenv.Component.SubCategory = \"04 | Daylight | Daylight\"\n#compatibleHBVersion = VER 0.0.56\\nFEB_01_2015\n#compatibleLBVersion = VER 0.0.59\\nFEB_01_2015\ntry: ghenv.Component.AdditionalHelpFromDocStrings = \"1\"\nexcept: pass\n\n\nimport scriptcontext as sc\nimport Grasshopper.Kernel as gh\nimport os\nimport subprocess\nimport math\n\ndef runCmdAndGetTheResults(command, shellKey = True):\n    p = subprocess.Popen([\"cmd\", command], shell=shellKey, stdout=subprocess.PIPE, stderr=subprocess.PIPE)\n    out, err = p.communicate()\n    # p.kill()\n    return out, err\n\ndef readGlareResults(glareRes):\n    resultDict = {}\n    try:\n        result, possibleNotice = glareRes.split(\"Notice:\")\n    except:\n        result = glareRes\n        possibleNotice = None\n        \n    keys, values = result.strip().split(\":\")\n    \n    keys = keys.split(\",\")\n    values = values[1:].split(\" \")\n    \n    # remove empty strings\n    for keyCount, key in enumerate(keys):\n        resultDict[key.strip()] = values[keyCount].strip()\n    \n    return resultDict, possibleNotice\n    \n\ndef DGPComfortRange(DGP):\n    \"\"\"\n    This a helper function that takes in DGP values and return comfort ranges.\n    :param : DGP : DGP value as a String\n    :return : comfort range as a String\n    \"\"\"\n    DGP = float(DGP)\n    if (DGP) < 0.35:\n        return \"Imperceptible Glare\"\n    elif DGP >= 0.35 and DGP < 0.40:\n        return \"Perceptible Glare\"\n    elif DGP >= 0.40 and DGP < 0.45:\n        return \"Disturbing Glare\"\n    elif DGP >= 0.45:\n        return \"Intolerable Glare\"\n        \n        \ndef main(HDRImagePath, taskPosition, taskPositionAngle):\n    # import the classes\n    if sc.sticky.has_key('honeybee_release'):\n\n        try:\n            if not sc.sticky['honeybee_release'].isCompatible(ghenv.Component): return -1\n            if sc.sticky['honeybee_release'].isInputMissing(ghenv.Component): return -1\n        except:\n            warning = \"You need a newer version of Honeybee to use this compoent.\" + \\\n            \" Use updateHoneybee component to update userObjects.\\n\" + \\\n            \"If you have already updated userObjects drag Honeybee_Honeybee component \" + \\\n            \"into canvas and try again.\"\n            w = gh.GH_RuntimeMessageLevel.Warning\n            ghenv.Component.AddRuntimeMessage(w, warning)\n            return -1\n            \n        hb_folders = sc.sticky[\"honeybee_folders\"]\n        hb_RADPath = hb_folders[\"RADPath\"]\n        hb_RADLibPath = hb_folders[\"RADLibPath\"]\n        hb_DSPath = hb_folders[\"DSPath\"]\n        hb_DSCore = hb_folders[\"DSCorePath\"]\n        hb_DSLibPath = hb_folders[\"DSLibPath\"]\n        hb_EPPath = hb_folders[\"EPPath\"]\n        \n    else:\n        print \"You should first let Honeybee to fly...\"\n        w = gh.GH_RuntimeMessageLevel.Warning\n        ghenv.Component.AddRuntimeMessage(w, \"You should first let Honeybee to fly...\")\n        return -1\n    \n    # make sure the image is the result of an luminance analysis and not illuminance\n    # I check for -i flag for rpict - This will work for all the Honeybee generatred renders\n    # may or may not work for other cases I may want to change this to be a popup window\n    # so the user can select between the options\n    \n    isLuminance = True\n    with open(HDRImagePath, \"r\") as hdrFile:\n        for lineCount, line in enumerate(hdrFile):\n            if lineCount<10:\n                if line.strip().lower().startswith(\"rpict\"):\n                    if line.find(\"-i\") > -1:\n                        isLuminance = False\n                        break\n            else:\n                break\n    \n    if not isLuminance:\n        warningMsg = \"This image is the result of an illuminance analysis and not a luminance analysis which is needed for glare analysis!\"\n        w = gh.GH_RuntimeMessageLevel.Warning\n        ghenv.Component.AddRuntimeMessage(w, warningMsg)\n        return -1\n    \n    # http://www.ise.fraunhofer.de/en/downloads-englisch/software/evalglare_windows.zip/at_download/file\n    notes = \"\"\n    \n    # try to find evalglare and check the version\n    \n    out, err = runCmdAndGetTheResults(\"/c \" + hb_RADPath + \"\\evalglare -v\")\n    msg = \"Failed to find evalglare.exe.\\n\" + \\\n              \"Make sure you have evalglare 1.x.x installed at \" + hb_RADPath +\\\n              \"You can download evalglare from: \\n\" + \\\n              \"http://www.ise.fraunhofer.de/en/downloads-englisch/software/evalglare_windows.zip/at_download/file\"\n    \n    try:\n        if out.split(\" \")[0].strip() == \"evalglare\" and float(out.split(\" \")[1].strip())> 1.0:\n            msg = \"\\nThis component is using \" + out.split(\"\\n\")[0] + \" for glare analysis.\\n\"\n            print msg\n            notes += msg + \"\\n\"\n            \n        else:\n            print msg\n            ghenv.Component.AddRuntimeMessage(gh.GH_RuntimeMessageLevel.Error, msg)\n            return -1\n    except:\n        print msg\n        ghenv.Component.AddRuntimeMessage(gh.GH_RuntimeMessageLevel.Error, msg)\n        return -1\n        \n    #task position in x and y coordinates\n    taskP = False\n    if taskPosition != None and taskPositionAngle != None:\n        taskPX= taskPosition.X\n        taskPY = taskPosition.Y\n        taskPA = math.radians(taskPositionAngle)\n        taskP = True\n        \n    if taskP and (taskPX > 1 or taskPY > 1):\n        msg = \"U and V valeus for taskPositionUV should be between 0 and 1.\" + \\\n                \"%.3f\"%taskPX + \" and \" + \"%.3f\"%taskPY + \" are not acceptable input.\" + \\\n                \"glare study will be run for the image and not the task plane\"\n        taskP = False\n    elif taskP == True:\n        msg = \"Task position is provided.\\n\"\n    elif taskP == False:\n        msg = \"No task position is provided. The result will be calculated for the whole scene.\\n\"\n        \n    print msg\n    notes += msg + \"\\n\"\n    \n    # check size and proportion of the image\n    command = '/c ' + hb_RADPath + '\\getinfo -d ' + HDRImagePath\n    out, err = runCmdAndGetTheResults(command)\n\n    try:\n        # image size\n        x = float(out.split(\" \")[-1].strip())\n        y = float(out.split(\" \")[-3].strip())\n    except:\n        msg = \"Failed to find size of the picture. It will be set to 800.\\n\"\n        print msg\n        ghenv.Component.AddRuntimeMessage(gh.GH_RuntimeMessageLevel.Warning, msg)\n        notes += msg + \"\\n\"\n        x = y = 800\n        \n    if x!=y:\n        msg = \"You need a fisheye HDR image for an accurate study.\\nThis image seems not to  be a fisheye image which may produce inaccurate results.\\n\"\n        print msg\n        ghenv.Component.AddRuntimeMessage(gh.GH_RuntimeMessageLevel.Warning, msg)\n        notes += msg + \"\\n\"\n        \n    # resize the image if needed\n    if x > 800 or y > 800:\n        msg = \"Due to performance reasons of the evalglare code, the image should be smaller than 800x800 pixels. \" + \\\n              \"Honeybee is resizing the image...\\n\"\n        print msg\n\n        ghenv.Component.AddRuntimeMessage(gh.GH_RuntimeMessageLevel.Warning, msg)\n        \n        notes += msg + \"\\n\"\n        \n        proportion = max(x,y)/800\n        resizedImage = \".\".join(HDRImagePath.split(\".\")[:-1]) + \"_resized.\" + HDRImagePath.split(\".\")[-1]\n        \n        pflitLine = \"/c \" + hb_RADPath + \"\\pfilt -x /\" + str(proportion) + \" -y /\" + str(proportion) + \\\n                  \" \" + HDRImagePath +\" > \" + resizedImage\n\n        out, err = runCmdAndGetTheResults(pflitLine)\n        \n        x = x/proportion\n        y = y/proportion\n        HDRImagePath = resizedImage\n    \n    glareCheckImage = \".\".join(HDRImagePath.split(\".\")[:-1]) + \"_chkFile.\" + HDRImagePath.split(\".\")[-1]\n    glareNoTextImage = \".\".join(HDRImagePath.split(\".\")[:-1]) + \"_noText.\" + HDRImagePath.split(\".\")[-1]\n    # run the analysis\n    evalGlareLine = \"/c \" + hb_RADPath + \"\\evalglare -c \" +  glareNoTextImage + \" \" + HDRImagePath\n    \n    glareRes, err = runCmdAndGetTheResults(evalGlareLine)\n    \n    if \"error: no valid view specified\" in err.strip():\n        \n        # since I use pcomp to merge images HDR image doesn't have HDR view information\n        # adding default Honeybee view information for fish-eye camera\n        evalGlareLine = \"/c \" + hb_RADPath + \"\\evalglare -vth -vv 180 -vh 180 -c \" +  glareNoTextImage + \" \" + HDRImagePath\n        glareRes, err = runCmdAndGetTheResults(evalGlareLine)\n        \n    notes += \"Results for the image:\\n\" + glareRes + \"\\n\"\n    \n    # read the results\n    totalGlareResultDict, possibleNotice = readGlareResults(glareRes)\n    \n    # add the results to the picture\n    DGP = totalGlareResultDict['dgp']\n    DGI = totalGlareResultDict['dgi']\n    \n    textHeight = x / 28\n    if textHeight < 8: textHeight = 8\n    addNumbersLine = \"/c \" + hb_RADPath + r\"\\psign -h \" + str(textHeight) + \" -cb 0 0 0 -cf 1 1 1 DGP=\" + str(DGP) +\" This view has \"+ str(DGPComfortRange(DGP))+ \" | \" + \\\n                     hb_RADPath + r\"\\pcompos \" + glareNoTextImage + \" 0 0 - \" + str(textHeight/2) + \" \" + str(y) + \" > \" + glareCheckImage\n    \n    runCmdAndGetTheResults(addNumbersLine)\n    \n    if possibleNotice!=None: notes += \"Notice: \" + possibleNotice + \"\\n\"\n    \n    # if task position run one image to\n    if taskP:\n        \n        glareTaskPCheckImage = \".\".join(HDRImagePath.split(\".\")[:-1]) + \"_TPChkFile.\" + HDRImagePath.split(\".\")[-1]\n        glareTaskPNoText = \".\".join(HDRImagePath.split(\".\")[:-1]) + \"_TPnoText.\" + HDRImagePath.split(\".\")[-1]\n        \n        xPixle = int(taskPX * x)\n        yPixle = int(taskPY * y) # 0,0 coordinate for evalglare located at top left\n        taskPA = math.radians(taskPositionAngle)\n        \n        TArguments = \" \".join([str(xPixle), str(yPixle), \"%.3f\"%taskPA])\n        \n        evalGlareTaskPLine = \"/c \" + hb_RADPath + \"\\evalglare -c \" +  glareTaskPNoText + \" -T \" + \\\n        TArguments + \" \" + HDRImagePath\n        \n        glareTaskRes, err = runCmdAndGetTheResults(evalGlareTaskPLine)\n        notes += \"Results for the task position:\\n\" + glareTaskRes + \"\\n\"\n        \n        if err.strip() == \"error: no valid view specified\":\n            # since I use pcomp to merge images HDR image doesn't have HDR view information\n            # adding default Honeybee view information for fish-eye camera\n            evalGlareTaskPLine = \"/c \" + hb_RADPath + \"\\evalglare -vth -vv 180 -vh 180 -c \" +  glareTaskPNoText + \" -T \" + \\\n            TArguments + \" \" + HDRImagePath\n            glareTaskRes, err = runCmdAndGetTheResults(evalGlareTaskPLine)        \n        \n        taskPGlareResultDict, possibleNotice = readGlareResults(glareTaskRes)\n        \n        # add the results to the picture\n        DGP = taskPGlareResultDict['dgp']\n        DGI = taskPGlareResultDict['dgi']\n        \n        addNumbersTLine = \"/c \" + hb_RADPath + r\"\\psign -h \" + str(textHeight) + \" -cb 0 0 0 -cf 1 1 1 DGP=\" + str(DGP) + \" This view has \" + str(DGPComfortRange(DGP))+ \" | \"+ \\\n                     hb_RADPath + r\"\\pcompos \" + glareTaskPNoText + \" 0 0 - \" + str(textHeight/2) + \" \" + str(y) + \" > \" + glareTaskPCheckImage\n    \n        runCmdAndGetTheResults(addNumbersTLine)\n        \n        if possibleNotice!=None: notes += \"Notice: \" + possibleNotice + \"\\n\"\n        \n        return notes, glareCheckImage, totalGlareResultDict, glareTaskPCheckImage, taskPGlareResultDict\n        \n    else:\n        return notes, glareCheckImage, totalGlareResultDict, None, None\n        \nif _HDRImagePath and _runIt:\n\n    result = main(_HDRImagePath, taskPositionUV_, taskPositionAngle_)\n    \n    if result!= -1:\n        readMe, glareCheckImage, totalGlareResultDict, imageWithTaskArea, taskPGlareResultDict = result\n        \n        if taskPGlareResultDict!=None:\n            DGP = taskPGlareResultDict['dgp']\n            glareComfortRange = DGPComfortRange(DGP)\n            DGI = taskPGlareResultDict['dgi']\n        else:\n            DGP = totalGlareResultDict['dgp']\n            glareComfortRange = DGPComfortRange(DGP)\n            DGI = totalGlareResultDict['dgi']\nelse:\n    readMe = \"Provide a valid HDR Image and set _runIt to True.\"\n    ghenv.Component.AddRuntimeMessage(gh.GH_RuntimeMessageLevel.Warning,readMe)\n    \n\n",
  "language": "python",
  "imports": [
    "scriptcontext"
  ],
  "has_docstring": true
}