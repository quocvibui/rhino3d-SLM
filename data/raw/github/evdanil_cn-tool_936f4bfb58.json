{
  "source_url": "https://github.com/evdanil/cn-tool/blob/d83b0c68efb5aaf10f09f1b77ddd5c992157f4af/utils/gpg.py",
  "repo": "evdanil/cn-tool",
  "repo_stars": 1,
  "repo_description": "Utility allowing to receive information from Infoblox API",
  "license": "unknown",
  "filepath": "utils/gpg.py",
  "instruction": null,
  "code": "import logging\nimport subprocess\nfrom typing import Optional, Tuple\nfrom pathlib import Path\nfrom core.base import ScriptContext\nfrom utils.file_io import check_file_accessibility, check_file_timeliness\n\n\ndef decrypt_gpg_file(logger: logging.Logger, file_path: Path) -> Optional[str]:\n    \"\"\"Attempt to decrypt the GPG file and handle possible subprocess exceptions.\"\"\"\n    try:\n        result = subprocess.run(\n            [\"gpg\", \"--batch\", \"-d\", file_path],\n            capture_output=True, text=True, check=True, timeout=90\n        )\n        return result.stdout\n    except (subprocess.CalledProcessError, subprocess.TimeoutExpired, FileNotFoundError) as e:\n        logger.error(f\"Unable to decrypt {file_path} - {e}\")\n        return None\n\n\ndef parse_gpg_credentials(gpg_output: str) -> Optional[Tuple[str, str]]:\n    \"\"\"Parse decrypted GPG output to extract user and password.\"\"\"\n    user = password = None\n    for line in gpg_output.splitlines():\n        if line.startswith(\"User =\"):\n            user = line.split(\"=\", 1)[1].strip()\n        elif line.startswith(\"Password =\"):\n            password = line.split(\"=\", 1)[1].strip()\n    return (user, password) if user and password else None\n\n\ndef get_gpg_credentials(ctx: ScriptContext) -> Optional[Tuple[str, str]]:\n    \"\"\"Main function to get decrypted GPG credentials.\"\"\"\n    file_path: Path = ctx.cfg[\"gpg_credentials\"]\n    if not check_file_accessibility(ctx.logger, file_path) or not check_file_timeliness(ctx.logger, file_path):\n        return None\n\n    decrypted_output = decrypt_gpg_file(ctx.logger, file_path)\n    return parse_gpg_credentials(decrypted_output) if decrypted_output else None\n",
  "language": "python",
  "imports": [],
  "has_docstring": false
}