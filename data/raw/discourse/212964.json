{
  "source_url": "https://discourse.mcneel.com/t/rhino-testing-within-active-gl-context/212964",
  "topic_id": 212964,
  "title": "Rhino.Testing within active GL context",
  "question": "Hey Developers,\n\n\nhas anyone had any success with Rhino.Testing in headed mode? I need to run my tests within an active GL context but canâ€™t get it to activate even for the simplest task.\n\n\n@CallumSykes\n, \n@sonderskovmathias\n  can you help here?\n\n\n[Warning] Frame 0: ViewCapture returned null.\n[Warning] Frame 1: ViewCapture returned null.\n[Sim Thread 27] Sim Running...\n[Warning] Frame 2: ViewCapture returned null.\n[Warning] Frame 3: ViewCapture returned null.\n[Warning] Frame 4: ViewCapture returned null.\n[Sim Thread 27] Sim Finished.\nSim and UI interaction completed.\n\n\n\n<?xml version=\"1.0\" encoding=\"utf-8\"?>\n<Settings>\n\t<RhinoSystemDirectory>C:\\Program Files\\Rhino 8\\System</RhinoSystemDirectory>\n\n\t<LoadEto>true</LoadEto>\n\t<LoadRDK>true</LoadRDK>\n\n\t<CreateRhinoView>true</CreateRhinoView>\n</Settings>\n\n\n\n [TestFixture]\n public class PoCTests\n {\n     private void RunOnMainThread(System.Action action)\n     {\n         if (RhinoApp.InvokeRequired)\n         {\n             RhinoApp.InvokeOnUiThread(action);\n         }\n         else\n         {\n             action();\n         }\n     }\n\n     [Test]\n     public void SanityCheck_RhinoIsLoaded()\n     {\n         Assert.IsNotNull(RhinoDoc.ActiveDoc, \"Rhino ActiveDoc should be available.\");\n         TestContext.WriteLine($\"Running inside Rhino Version: {RhinoApp.Version}\");\n     }\n\n     [Test]\n     public void Test_SimAndUI_ThreadingCollision()\n     {\n\n         // Start a fake simulation on a background thread\n         var simTask = Task.Run(() =>\n         {\n             Thread.Sleep(100); // Simulate boot up\n             TestContext.WriteLine($\"[Sim Thread {Thread.CurrentThread.ManagedThreadId}] Sim Running...\");\n\n             // Simulate Native Work\n             for (int i = 0; i < 5; i++)\n             {\n                 Thread.Sleep(50);\n             }\n\n             TestContext.WriteLine($\"[Sim Thread {Thread.CurrentThread.ManagedThreadId}] Sim Finished.\");\n         });\n\n         // While Sim is running, force UI/OpenGL access on M...",
  "code_blocks": [
    {
      "code": "[TestFixture]\n public class PoCTests\n {\n     private void RunOnMainThread(System.Action action)\n     {\n         if (RhinoApp.InvokeRequired)\n         {\n             RhinoApp.InvokeOnUiThread(action);\n         }\n         else\n         {\n             action();\n         }\n     }\n\n     [Test]\n     public void SanityCheck_RhinoIsLoaded()\n     {\n         Assert.IsNotNull(RhinoDoc.ActiveDoc, \"Rhino ActiveDoc should be available.\");\n         TestContext.WriteLine($\"Running inside Rhino Version: {RhinoApp.Version}\");\n     }\n\n     [Test]\n     public void Test_SimAndUI_ThreadingCollision()\n     {\n\n         // Start a fake simulation on a background thread\n         var simTask = Task.Run(() =>\n         {\n             Thread.Sleep(100); // Simulate boot up\n             TestContext.WriteLine($\"[Sim Thread {Thread.CurrentThread.ManagedThreadId}] Sim Running...\");\n\n             // Simulate Native Work\n             for (int i = 0; i < 5; i++)\n             {\n                 Thread.Sleep(50);\n             }\n\n             TestContext.WriteLine($\"[Sim Thread {Thread.CurrentThread.ManagedThreadId}] Sim Finished.\");\n         });\n\n         // While Sim is running, force UI/OpenGL access on Main Thread\n         for (int i = 0; i < 5; i++)\n         {\n             RunOnMainThread(() =>\n             {\n                 var view = RhinoDoc.ActiveDoc.Views.ActiveView;\n                 if (view == null || !view.Floating)\n                 {\n                     view = RhinoDoc.ActiveDoc.Views.Add(\n                         \"TestView\",\n                         Rhino.Display.DefinedViewportProjection.Top,\n                         new System.Drawing.Rectangle(0, 0, 800, 600),\n                         true\n                     );\n\n                     view.Size = new System.Drawing.Size(800, 600);\n                     RhinoDoc.ActiveDoc.Views.ActiveView = view;\n                 }\n\n                 view.Redraw();\n\n                 var capture = new Rhino.Display.ViewCapture\n                 {\n                     Width = 800,\n                     Height = 600,\n                     DrawAxes = true,\n                     DrawGrid = true,\n                     TransparentBackground = false\n                 };\n\n                 using (var bitmap = capture.CaptureToBitmap(view))\n                 {\n                     if (bitmap != null)\n                     {\n                         string path = Path.Combine(TestContext.CurrentContext.WorkDirectory, $\"frame_{i}.png\");\n                         bitmap.Save(path, System.Drawing.Imaging.ImageFormat.Png);\n                         TestContext.WriteLine($\"Saved frame to: {path}\");\n                     }\n                     else\n                     {\n                         TestContext.WriteLine($\"[Warning] Frame {i}: ViewCapture returned null.\");\n                     }\n                 }\n             });\n\n             Thread.Sleep(60); // Wait between UI updates\n         }\n\n         // Wait for Sim to finish\n         simTask.Wait();\n\n         Assert.Pass(\"Sim and UI interaction completed.\");\n     }\n }",
      "language": "csharp",
      "author": "mrhe",
      "post_number": 1,
      "is_solution": false
    }
  ],
  "tags": [
    "file-io",
    "geometry"
  ],
  "has_accepted_answer": false,
  "category_id": 3,
  "posts_count": 4,
  "views": 77
}