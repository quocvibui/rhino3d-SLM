{
  "source_url": "https://github.com/CADacombs/rhinopython/blob/541b4ade49f1dda6a3861d12b9e2613405182082/spb_Explode.py",
  "repo": "CADacombs/rhinopython",
  "repo_stars": 37,
  "repo_description": "Python scripts for Rhinoceros (Rhino, Rhino3D).",
  "license": "LGPL-3.0",
  "filepath": "spb_Explode.py",
  "instruction": "This script is to be used as an alternative to _Explode and _ExplodeBlocks.\r\n\r\nBreps\r\n_Explode doesn't retain face colors.\r\nThis script retains both face and object colors.\r\n\r\nCurves...",
  "code": "\"\"\"\r\nThis script is to be used as an alternative to _Explode and _ExplodeBlocks.\r\n\r\nBreps\r\n_Explode doesn't retain face colors.\r\nThis script retains both face and object colors.\r\n\r\nCurves (wires)\r\n_Explode splits NURBS curves at knots with Gsmooth_continuous (\"Aesthetic discontinuity\")\r\nhttps://developer.rhino3d.com/api/rhinocommon/rhino.geometry.continuity\r\nThis script explodes NURBS curves at knots that are G2 discontinuous\r\nper Rhino's _GCon and non-overload Curve.GetNextDiscontinuity.\r\nG2 discontinuous is where at least one of the following two items is true:\r\n    1. abs(k0-k1) / max(k0,k1) > 0.05, where k0 and k1 are magnitudes of the curvature\r\n    vectors below and above the knot.\r\n    2. The difference in curvature vectors is > 2.0 degrees.\r\n\r\nThis script explode polycurves to their actual segments.\r\n\r\nBlocks\r\nSame function as _Explode, except:\r\n    Also report the resultant object types. (_Explode only reports the number of objects.)\r\n    Display Color, Linetype, Print Color, Print Width, or Section Style of block objects that are\r\n    set to ByParent are set to the instances setting after this script execution.\r\n\"\"\"\r\n\r\n#! python 2  Must be on a line number less than 32.\r\nfrom __future__ import absolute_import, division, print_function, unicode_literals\r\n\r\n\"\"\"\r\n230906-07: Created.\r\n231009: Bug fix in working with PolylineCurves.\r\n231024: Improved printed feedback.\r\n231113: Now, polyline curve segments in polycurves are exploded immediately.\r\n250113: Curves are now exploded similar to that by _Explode, except\r\n        NurbsCurves are exploded to G2 (per Rhino (see above)) instead of Gsmooth_continuous.\r\n250811: Updated notes above concerning block objects that are ByParent before this script execution.\r\n\"\"\"\r\n\r\nimport Rhino\r\nimport Rhino.DocObjects as rd\r\nimport Rhino.Geometry as rg\r\nimport Rhino.Input as ri\r\nimport scriptcontext as sc\r\n\r\nimport spb_Brep_explode\r\nimport spb_ObjectDescriptions\r\n\r\n\r\ndef get_G2_discontinuities(nc):\r\n    \"\"\"\r\n    Parameters:\r\n    Returns: list of float: Parameters of discontinuities\r\n    \"\"\"\r\n\r\n    t0 = nc.Domain.Min\r\n    t1 = nc.Domain.Max\r\n\r\n    if nc.IsClosed:\r\n        continuityType = rg.Continuity.G2_locus_continuous\r\n    else:\r\n        continuityType = rg.Continuity.G2_continuous\r\n\r\n    ts = []\r\n\r\n    while True:\r\n        sc.escape_test()\r\n        bSuccess, t = nc.GetNextDiscontinuity(continuityType, t0, t1)\r\n        if not bSuccess:\r\n            return ts\r\n\r\n        ts.append(t)\r\n        t0 = t\r\n\r\n\r\ndef explode_curve(rgC_In):\r\n    \"\"\"\r\n    Parameters:\r\n    Returns:\r\n    \"\"\"\r\n\r\n    sc.escape_test()\r\n\r\n    if isinstance(rgC_In, (rg.ArcCurve, rg.LineCurve)):\r\n        return\r\n\r\n    if isinstance(rgC_In, rg.PolylineCurve):\r\n        return rgC_In.DuplicateSegments()\r\n\r\n    if isinstance(rgC_In, rg.PolyCurve):\r\n        #pc_In = rgC_In.Duplicate()\r\n        #bNestingWasRemoved = pc_In.RemoveNesting()\r\n        segs = rgC_In.DuplicateSegments()\r\n        segs_Out = []\r\n        for seg in segs:\r\n            rv = explode_curve(seg)\r\n            if rv is None:\r\n                segs_Out.append(seg)\r\n            else:\r\n                segs_Out.extend(rv)\r\n        return segs_Out\r\n\r\n    if not isinstance(rgC_In, rg.NurbsCurve):\r\n        raise Exception(\"Why is {} here?\".format(rgC_In.GetType().Name))\r\n\r\n    # Process NurbsCurve.\r\n\r\n    ts_discont = get_G2_discontinuities(rgC_In)\r\n    if not ts_discont:\r\n        return\r\n    if len(ts_discont) == 1 and rgC_In.IsClosed:\r\n        return\r\n\r\n    return rgC_In.Split(ts_discont)\r\n\r\n\r\ndef doesInstDefContainInvalidGeometry(rdInstDef):\r\n    for rdO in rdInstDef.GetObjects():\r\n        if not rdO.Geometry.IsValid:\r\n            return True\r\n    return False\r\n\r\n\r\ndef main():\r\n\r\n    rdObjs_Pre = list(sc.doc.Objects.GetSelectedObjects(includeLights=False, includeGrips=False))\r\n\r\n    rdObjs_Post = []\r\n\r\n    if not rdObjs_Pre:\r\n        res, objrefs = ri.RhinoGet.GetMultipleObjects(\r\n            \"Select objects to explode\",\r\n            acceptNothing=False,\r\n            filter=rd.ObjectType.Curve | rd.ObjectType.Brep | rd.ObjectType.InstanceReference)\r\n        if res != Rhino.Commands.Result.Success: return\r\n\r\n        for objref in objrefs:\r\n            rdObjs_Post.append(objref.Object())\r\n\r\n\r\n    iCt_Exploded = 0\r\n    iCt_ExplodeResults = 0\r\n\r\n    gOuts = []\r\n    sLogs = []\r\n\r\n    for rdObj in rdObjs_Pre + rdObjs_Post:\r\n\r\n        if rdObj.ObjectType == rd.ObjectType.Brep:\r\n            if not rdObj.Geometry.IsValid:\r\n                sLogs.append(\"Brep with invalid geometry skipped.  Repair and try again.\")\r\n                continue\r\n            gBs_Res, sLogs = spb_Brep_explode.explodeBrepObject(rdObj, bEcho=False, bDebug=False)\r\n            if gBs_Res:\r\n                gOuts.extend(gBs_Res)\r\n                iCt_ExplodeResults += len(gBs_Res)\r\n                iCt_Exploded += 1\r\n\r\n        elif rdObj.ObjectType == rd.ObjectType.Curve:\r\n            crvs_ret = explode_curve(rdObj.CurveGeometry)\r\n            if not crvs_ret: continue\r\n            \r\n            bFail_to_add_object = False\r\n\r\n            for crv in crvs_ret:\r\n                gOut = sc.doc.Objects.AddCurve(crv, rdObj.Attributes)\r\n                if gOut == gOut.Empty:\r\n                    bFail_to_add_object = True\r\n                else:\r\n                    gOuts.append(gOut)\r\n                    iCt_ExplodeResults += 1\r\n\r\n            if not bFail_to_add_object:\r\n                sc.doc.Objects.Delete(rdObj)\r\n\r\n            iCt_Exploded += 1\r\n\r\n        elif rdObj.ObjectType == rd.ObjectType.InstanceReference:\r\n            rdInstRef = rdObj\r\n            rdInstDef = rdInstRef.InstanceDefinition\r\n            #print(rdInstDef.ObjectCount)\r\n            if doesInstDefContainInvalidGeometry(rdInstDef):\r\n                print(\"Block instance with invalid geometry skipped.  Repair first or use _Explode.\")\r\n                continue\r\n            gObjs_from_Inst = sc.doc.Objects.AddExplodedInstancePieces(\r\n                rdInstRef,\r\n                explodeNestedInstances=False,\r\n                deleteInstance=True)\r\n            if gObjs_from_Inst is None:\r\n                if iCt_Exploded:\r\n                    print(\"Error exploding one block instance, but {} other objects were exploded into {} objects.\".format(\r\n                        iCt_Exploded, len(gOuts)))\r\n                raise Exception(\r\n                    \"Block instance could not explode.\" \\\r\n                    \"  It possibly has invalid b-reps.\" \\\r\n                    \"  _Undo to retrieve possbly lost data and use _Explode instead.\")\r\n            for g in gObjs_from_Inst:\r\n                if g == g.Empty:\r\n                    raise Exception(\"Object in instance could not be added to document.  Undo and investigate.\")\r\n            gOuts.extend(gObjs_from_Inst)\r\n            iCt_Exploded += 1\r\n\r\n    if sLogs:\r\n        for sLog in sorted(set(sLogs)):\r\n            print(\"{} of {}\".format(sLogs.count(sLog), sLog)) \r\n\r\n    if not iCt_Exploded:\r\n        print(\"Nothing was exploded.\")\r\n        return\r\n\r\n    print(\"{} objects were exploded into {} objects.\".format(\r\n        iCt_Exploded, len(gOuts)))\r\n\r\n    sc.doc.Objects.UnselectAll()\r\n\r\n    sc.doc.Objects.Select(objectIds=gOuts)\r\n\r\n    spb_ObjectDescriptions.main()\r\n\r\n    sc.doc.Views.Redraw()\r\n\r\n\r\nif __name__ == '__main__': main()",
  "language": "python",
  "imports": [
    "Rhino",
    "Rhino.Geometry",
    "scriptcontext"
  ],
  "has_docstring": true
}