{
  "source_url": "https://github.com/Glottotopia/aagd/blob/a7df9a5a047aa6d41b9fb64f93ba6fd2ff42a6db/moin/local/moin/MoinMoin/action/SubscribeUser.py",
  "repo": "Glottotopia/aagd",
  "repo_stars": 1,
  "repo_description": "Database of syntactic structures of Athabascan languages",
  "license": "MIT",
  "filepath": "moin/local/moin/MoinMoin/action/SubscribeUser.py",
  "instruction": "MoinMoin - Subscribeuser - Action\r\n   Subscribe (or unsubscribe) a user to a page.\r\n\r\n   @copyright: 2003 Daniela Nicklas <nicklas@informatik.uni-stuttgart.de>,\r\n               2005...",
  "code": "\"\"\"\r\n   MoinMoin - Subscribeuser - Action\r\n   Subscribe (or unsubscribe) a user to a page.\r\n\r\n   @copyright: 2003 Daniela Nicklas <nicklas@informatik.uni-stuttgart.de>,\r\n               2005 MoinMoin:AlexanderSchremmer,\r\n               2009 MoinMoin:ThomasWaldmann\r\n   @license: GNU GPL, see COPYING for details.\r\n\"\"\"\r\n\r\nimport sys, os, re\r\n\r\nfrom MoinMoin.Page import Page\r\nfrom MoinMoin import user\r\nfrom MoinMoin import wikiutil\r\n\r\n\r\ndef show_form(pagename, request):\r\n    _ = request.getText\r\n    request.theme.send_title(_(\"Subscribe users to the page %s\") % pagename, pagename=pagename)\r\n\r\n    request.write(\"\"\"\r\n<form action=\"%s\" method=\"POST\" enctype=\"multipart/form-data\">\r\n<input type=\"hidden\" name=\"action\" value=\"SubscribeUser\">\r\n%s <input type=\"text\" name=\"users\" size=\"50\">\r\n<input type=\"submit\" value=\"Subscribe\">\r\n</form>\r\n\"\"\" % (request.href(pagename),\r\n      _(\"Enter user names (comma separated):\")))\r\n    request.theme.send_footer(pagename)\r\n    request.theme.send_closing_html()\r\n\r\n\r\ndef parse_re(usernames):\r\n    username_regexes = []\r\n    for name in usernames:\r\n        if name.startswith(\"re:\"):\r\n            name = name[3:]\r\n        else:\r\n            name = re.escape(name)\r\n        username_regexes.append(name)\r\n    return username_regexes\r\n\r\n\r\ndef parse_userlist(usernames):\r\n    subscribe = []\r\n    unsubscribe = []\r\n    for name in usernames:\r\n        if name.startswith(\"-\"):\r\n            unsubscribe.append(name[1:])\r\n        elif name.startswith(\"+\"):\r\n            subscribe.append(name[1:])\r\n        else:\r\n            subscribe.append(name)\r\n    return parse_re(subscribe), parse_re(unsubscribe)\r\n\r\n\r\ndef show_result(pagename, request):\r\n    _ = request.getText\r\n\r\n    request.theme.send_title(_(\"Subscribed for %s:\") % pagename, pagename=pagename)\r\n\r\n    from MoinMoin.formatter.text_html import Formatter\r\n    formatter = Formatter(request)\r\n\r\n    usernames = request.form['users'].split(\",\")\r\n    subscribe, unsubscribe = parse_userlist(usernames)\r\n\r\n    result = subscribe_users(request, subscribe, unsubscribe, pagename, formatter)\r\n    request.write(result)\r\n\r\n    request.theme.send_footer(pagename)\r\n    request.theme.send_closing_html()\r\n\r\n\r\ndef subscribe_users(request, subscribe, unsubscribe, pagename, formatter):\r\n    _ = request.getText\r\n\r\n    if not Page(request, pagename).exists():\r\n        return u\"Page does not exist.\"\r\n\r\n    result = []\r\n    did_match = {}\r\n\r\n    # get user object - only with IDs!\r\n    for userid in user.getUserList(request):\r\n        userobj = user.User(request, userid)\r\n        name = userobj.name\r\n\r\n        matched = subscribed = False\r\n\r\n        for name_re in unsubscribe:\r\n            if re.match(name_re, name, re.U):\r\n                matched = did_match[name_re] = True\r\n                if (not userobj.isSubscribedTo([pagename]) or\r\n                    userobj.unsubscribe(pagename)):\r\n                    subscribed = False\r\n                break\r\n\r\n        for name_re in subscribe:\r\n            if re.match(name_re, name, re.U):\r\n                matched = did_match[name_re] = True\r\n                if (userobj.isSubscribedTo([pagename]) or\r\n                    (userobj.email or userobj.jid) and userobj.subscribe(pagename)):\r\n                    subscribed = True\r\n                break\r\n\r\n        if matched:\r\n            result.extend([formatter.smiley(subscribed and '{*}' or '{o}'),\r\n                           formatter.text(\" \"),\r\n                           formatter.url(1, Page(request, name).url(request)),\r\n                           formatter.text(name),\r\n                           formatter.url(0),\r\n                           formatter.linebreak(preformatted=0),\r\n                          ])\r\n\r\n    result.extend([''.join([formatter.smiley('{X}'),\r\n                            formatter.text(\" \" + _(\"Not a user:\") + \" \" + name_re),\r\n                            formatter.linebreak(preformatted=0)])\r\n                   for name_re in subscribe + unsubscribe if name_re not in did_match])\r\n\r\n    return ''.join(result)\r\n\r\n\r\ndef execute(pagename, request):\r\n    _ = request.getText\r\n    if not request.user.may.admin(pagename):\r\n        thispage = Page(request, pagename)\r\n        request.theme.add_msg(_(\"You are not allowed to perform this action.\"), \"error\")\r\n        return thispage.send_page()\r\n    elif 'users' not in request.form:\r\n        show_form(pagename, request)\r\n    else:\r\n        show_result(pagename, request)\r\n\r\n\r\nif __name__ == '__main__':\r\n    args = sys.argv\r\n    if len(args) < 2:\r\n        print >>sys.stderr, \"\"\"Subscribe users\r\n\r\n%(myname)s pagename [+|-][re:]username[,username[,username[,...]]] [URL]\r\n\r\n+username: subscribes user <username> to page <pagename>.\r\n-username: unsubscribes user <username> from page <pagename>.\r\n+re:username_re: subscribes users who match <username_re> regex.\r\n-re:username_re: unsubscribes users who match <username_re> regex.\r\n\r\nURL is just needed for a farmconfig scenario.\r\n\r\nExample:\r\n%(myname)s FrontPage TestUser,MatthewSimpson\r\n\r\n\"\"\" % {\"myname\": os.path.basename(args[0])}\r\n        raise SystemExit\r\n\r\n    pagename = args[1]\r\n    usernames = args[2].split(\",\")\r\n\r\n    if len(args) > 3:\r\n        request_url = args[3]\r\n    else:\r\n        request_url = None\r\n\r\n    # Setup MoinMoin environment\r\n    from MoinMoin.web.contexts import ScriptContext\r\n    request = ScriptContext(url=request_url)\r\n\r\n    from MoinMoin.formatter.text_plain import Formatter\r\n    formatter = Formatter(request)\r\n\r\n    subscribe, unsubscribe = parse_userlist(usernames)\r\n\r\n    print subscribe_users(request, subscribe, unsubscribe, pagename, formatter)\r\n\r\n",
  "language": "python",
  "imports": [],
  "has_docstring": true
}