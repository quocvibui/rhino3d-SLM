{
  "source_url": "https://github.com/PH-Tools/honeybee_grasshopper_ph/blob/c433bc8e66f3a51fd05ee4c485f4c54c03d2a569/honeybee_ph_rhino/gh_compo_io/space_create_spc.py",
  "repo": "PH-Tools/honeybee_grasshopper_ph",
  "repo_stars": 6,
  "repo_description": "Honeybe-PH plugin for Rhino / Grasshopper ",
  "license": "GPL-3.0",
  "filepath": "honeybee_ph_rhino/gh_compo_io/space_create_spc.py",
  "instruction": "GHCompo Interface: HBPH - Create Spaces.",
  "code": "# -*- coding: utf-8 -*-\n# -*- Python Version: 2.7 -*-\n\n\"\"\"GHCompo Interface: HBPH - Create Spaces.\"\"\"\n\ntry:\n    from typing import Any, List, Optional, Tuple, TypeVar, Union\n\n    T = TypeVar(\"T\")\nexcept ImportError:\n    pass  # IronPython 2.7\n\ntry:\n    from Grasshopper import DataTree  # type: ignore\n    from Grasshopper.Kernel.Data import GH_Path  # type: ignore\nexcept ImportError:\n    pass  # outside Grasshopper\n\ntry:\n    from System import Double, Object, String  # type: ignore\nexcept:\n    pass  # outside .NET\n\ntry:\n    from ladybug_geometry.geometry3d import face\nexcept ImportError as e:\n    raise ImportError(\"\\nFailed to import ladybug_geometry:\\n\\t{}\".format(e))\n\ntry:\n    from ladybug_rhino.config import units_abbreviation\n    from ladybug_rhino.fromgeometry import from_face3d\nexcept ImportError as e:\n    raise ImportError(\"\\nFailed to import ladybug_rhino:\\n\\t{}\".format(e))\n\ntry:\n    from honeybee_ph import space\nexcept ImportError as e:\n    raise ImportError(\"\\nFailed to import honeybee_ph:\\n\\t{}\".format(e))\n\ntry:\n    from honeybee_ph_rhino import gh_io\n    from honeybee_ph_rhino.make_spaces import make_floor, make_volume\nexcept ImportError as e:\n    raise ImportError(\"\\nFailed to import honeybee_ph_rhino:\\n\\t{}\".format(e))\n\ntry:\n    from ph_units import converter, parser\nexcept ImportError as e:\n    raise ImportError(\"\\nFailed to import ph_units:\\n\\t{}\".format(e))\n\ntry:\n    from honeybee_ph_rhino.gh_compo_io.space_create_vent_rates import SpacePhVentFlowRates\nexcept ImportError as e:\n    raise ImportError(\"\\nFailed to import honeybee_ph_rhino:\\n\\t{}\".format(e))\n\n\nclass GHCompo_CreatePHSpaces(object):\n    DEFAULT_SPACE_HEIGHT = 2.5  # m\n\n    def __init__(\n        self,\n        _IGH,\n        _flr_seg_geom,\n        _weighting_factors,\n        _volume_geometry,\n        _volume_heights,\n        _space_names,\n        _space_numbers,\n        _space_ph_vent_rates,\n        _flr_seg_net_areas,\n        *args,\n        **kwargs\n    ):\n        # type: (gh_io.IGH, DataTree, DataTree, DataTree, DataTree, DataTree, DataTree, DataTree, DataTree[float], *Any, **Any) -> None\n        self.IGH = _IGH\n        self.flr_geom = _flr_seg_geom\n        self.weighting_factors = _weighting_factors\n        self.vol_geom = _volume_geometry\n        self.vol_heights = _volume_heights\n        self.names = _space_names\n        self.numbers = _space_numbers\n        self.vent_rates = _space_ph_vent_rates\n        self.net_areas = _flr_seg_net_areas\n\n    @property\n    def rh_doc_unit_type_abbreviation(self):\n        # type: () -> str\n        \"\"\"Return the Rhino file's unit-type as a string abbreviation. ie: \"Meter\" -> \"M\", etc..\"\"\"\n\n        return units_abbreviation().upper()\n\n    @property\n    def rh_doc_local_length_unit(self):\n        # type: () -> str\n        \"\"\"Return the Rhino document unit-type for area as a string abbreviation. ie: \"Meter\" -> \"M\", etc..\"\"\"\n\n        return \"{}\".format(self.rh_doc_unit_type_abbreviation)\n\n    @property\n    def rh_doc_local_area_unit(self):\n        # type: () -> str\n        \"\"\"Return the Rhino document unit-type for area as a string abbreviation. ie: \"Meter\" -> \"M2\", etc..\"\"\"\n\n        return \"{}2\".format(self.rh_doc_unit_type_abbreviation)\n\n    def get_default_height_in_local_units(self):\n        # type: () -> Union[float, int]\n        \"\"\"Return the default SpaceVolume height in the Rhino document unit-type.\"\"\"\n\n        default_height_value = self.DEFAULT_SPACE_HEIGHT\n        default_height_unit = \"M\"\n        value = converter.convert(default_height_value, default_height_unit, self.rh_doc_unit_type_abbreviation)\n        if not value:\n            msg = \"Error: Failed to convert:\" \"'{}{}' to local unit-type: '{}'\".format(\n                default_height_value,\n                default_height_unit,\n                self.rh_doc_unit_type_abbreviation,\n            )\n            raise Exception(msg)\n        return value\n\n    def tree_to_local_area_units(self, _input_tree):\n        # type: (DataTree[float | str | None]) -> DataTree[float | None]\n        \"\"\"Convert the input DataTree to the Rhino document unit-type.\"\"\"\n\n        new_tree = DataTree[Object]()\n        for i in range(_input_tree.BranchCount):\n            for _input in _input_tree.Branch(i):\n                if _input is None:\n                    converted_input = None\n                else:\n                    converted_input = converter.convert(\n                        *parser.parse_input(_input), _target_unit=self.rh_doc_local_area_unit\n                    )\n                new_tree.Add(converted_input, GH_Path(i))\n        return new_tree\n\n    def tree_to_local_length_units(self, _input_tree):\n        # type: (DataTree[float | str | None]) -> DataTree[float | None]\n        \"\"\"Convert the input DataTree to the Rhino document unit-type.\"\"\"\n\n        new_tree = DataTree[Object]()\n        for i in range(_input_tree.BranchCount):\n            for _input in _input_tree.Branch(i):\n                if _input is None:\n                    converted_input = None\n                else:\n                    converted_input = converter.convert(\n                        *parser.parse_input(_input), _target_unit=self.rh_doc_local_length_unit\n                    )\n                new_tree.Add(converted_input, GH_Path(i))\n        return new_tree\n\n    def _clean_input_tree(self, _input_tree, branch_count, default, _type):\n        # type: (DataTree, int, Any, T) -> DataTree[T]\n        \"\"\"Align the input DataTrees so they are all the same length. Apply defaults.\n\n        Arguments:\n        ----------\n            * _input_tree: The input DataTree to clean.\n            * branch_count: The number of branches to align the input tree to.\n            * default: The default value to apply to any missing or None items.\n            * _type: The Type of the input tree Data items.\n\n        Returns:\n        --------\n            DataTree[T]: A new DataTree with the same structure as the input tree, but with\n                all branches the same length.\n        \"\"\"\n        new_tree = DataTree[_type]()  # type: DataTree[T]\n        for i in range(branch_count):\n            try:\n                new_tree.AddRange(_input_tree.Branch(i), GH_Path(i))\n            except ValueError:\n                new_tree.Add(default, GH_Path(i))\n        return new_tree\n\n    def _clean_volume_heights_tree(self, _input_tree, _branch_count, _default_height, _type):\n        # type: (DataTree, int, Any, T) -> DataTree[T]\n        \"\"\"Return a cleaned DataTree of the volume height inputs. Allows for conversion of user input.\n\n        ie: if the user inputs \"15 m\" will convert to the Rhino document unit-type.\n        \"\"\"\n\n        new_tree = DataTree[_type]()  # type: DataTree[T]\n        for i in range(_branch_count):\n            try:\n                if not _input_tree.Branch(i):\n                    new_tree.Add(_default_height, GH_Path(i))\n\n                for input_item in _input_tree.Branch(i):\n                    val, unit = parser.parse_input(input_item)\n                    converted_value = converter.convert(val, unit, self.rh_doc_unit_type_abbreviation)\n                    new_tree.Add(converted_value, GH_Path(i))\n            except ValueError:\n                new_tree.Add(_default_height, GH_Path(i))\n        return new_tree\n\n    def _create_space_floors(self, _flr_srfc_list, _weighting_factor_branch, _net_areas_branch):\n        # type: (List, DataTree[Double], DataTree[Double | None]) -> Tuple[List[space.SpaceFloor], List[Optional[face.Face3D]]]\n        \"\"\"Return a list of space.SpaceFloor objects based on Rhino Geometry and TFA weighting factors.\"\"\"\n\n        space_floors, e = make_floor.space_floor_from_rh_geom(\n            self.IGH, list(_flr_srfc_list), list(_weighting_factor_branch), list(_net_areas_branch)\n        )\n\n        error_faces = [from_face3d(s) for s in e]  # type: List[Optional[face.Face3D]]\n        if error_faces:\n            msg = (\n                \"Error: There was a problem joining together one or more group of floor surfaces?\\n\"\n                'Check the \"error_\" output for a preview of the surfaces causing the problem\\n'\n                \"Check the names and numbers of the surfaces, and make sure they can be properly merged?\"\n            )\n            self.IGH.error(msg)\n\n        return space_floors, error_faces\n\n    def _create_space_volumes(self, _space_floors, _vol_heights):\n        # type: (List[space.SpaceFloor], List[float]) -> List[space.SpaceVolume]\n        \"\"\"Return a new space.SpaceVolume based on a floor and a height.\"\"\"\n\n        volumes = make_volume.volumes_from_floors(self.IGH, _space_floors, list(_vol_heights))\n        return volumes\n\n    def _add_flow_rates_to_space(self, _vent_rates, _new_space):\n        # type: (List[SpacePhVentFlowRates], space.Space) -> space.Space\n        \"\"\"Add any user-determined vent flow rates, if any.\"\"\"\n\n        try:\n            flow_rate_obj = sum(_vent_rates)\n            _new_space.properties.ph._v_sup = flow_rate_obj.v_sup  # type: ignore\n            _new_space.properties.ph._v_eta = flow_rate_obj.v_eta  # type: ignore\n            _new_space.properties.ph._v_tran = flow_rate_obj.v_tran  # type: ignore\n        except TypeError:\n            pass\n        return _new_space\n\n    def _space_volumes_as_rh_geom(self, _space_volumes):\n        # type: (List[space.SpaceVolume]) -> List\n        \"\"\"Return a list of space.SpaceVolumes as Rhino Geometry (Brep).\"\"\"\n\n        volume_rh_breps_ = []\n        for vol in _space_volumes:\n            volume_rh_breps_.append(\n                self.IGH.ghpythonlib_components.BrepJoin(self.IGH.convert_to_rhino_geom(vol.geometry)).breps\n            )\n        return volume_rh_breps_\n\n    def _create_ph_spaces(\n        self,\n        _space_names,\n        _space_numbers,\n        _weighting_factors,\n        _volume_heights,\n        _vent_rates,\n        _net_areas,\n    ):\n        # type: (DataTree[str], DataTree[str], DataTree[Double], DataTree[Double], DataTree, DataTree) -> Tuple[List[Optional[face.Face3D]], List, List, List[space.Space]]\n        \"\"\"Create all the PH space.Spaces based on the user input.\"\"\"\n\n        spaces_ = []\n        errors_ = []\n        floor_breps_ = DataTree[Object]()\n        volume_breps_ = DataTree[Object]()\n\n        # -- Build one Space for each branch on the _flr_seg_geom input tree\n        for i, floor_surface_list in enumerate(self.flr_geom.Branches):\n            new_space = space.Space()\n            new_space.name = _space_names.Branch(i)[0]\n            new_space.number = _space_numbers.Branch(i)[0]\n            space_floors, errors_ = self._create_space_floors(\n                floor_surface_list, _weighting_factors.Branch(i), _net_areas.Branch(i)\n            )\n            space_volumes = self._create_space_volumes(space_floors, _volume_heights.Branch(i))\n            new_space.add_new_volumes(space_volumes)\n            new_space = self._add_flow_rates_to_space(_vent_rates.Branch(i), new_space)\n            spaces_.append(new_space)\n\n            # -- Output Preview: Floor Surfaces\n            flr_rh_geom = [from_face3d(flr.geometry) for flr in space_floors]\n            floor_breps_.AddRange(flr_rh_geom, GH_Path(i))\n\n            # -- Output Preview: Volume Breps\n            volume_breps_.AddRange(self._space_volumes_as_rh_geom(space_volumes), GH_Path(i))\n\n        spaces_ = sorted(spaces_, key=lambda sp: sp.full_name)\n\n        return errors_, floor_breps_, volume_breps_, spaces_\n\n    def run(self):\n        # type: () -> Tuple[List[Optional[face.Face3D]], List, List, List[space.Space]]\n        \"\"\"Run the space maker.\"\"\"\n\n        # -------------------------------------------------------------------------------\n        # -- Organize the input trees, lists, lengths, defaults\n        default_height = self.get_default_height_in_local_units()\n        input_len = len(self.flr_geom.Branches)\n\n        space_names = self._clean_input_tree(self.names, input_len, \"_Unnamed_\", String)\n        space_numbers = self._clean_input_tree(self.numbers, input_len, \"000\", String)\n        weighting_factors = self._clean_input_tree(self.weighting_factors, input_len, 1.0, Object)\n        volume_heights = self.tree_to_local_length_units(\n            self._clean_volume_heights_tree(self.vol_heights, input_len, default_height, Object)\n        )\n        vent_rates = self._clean_input_tree(self.vent_rates, input_len, None, Object)\n        net_areas = self.tree_to_local_area_units(self._clean_input_tree(self.net_areas, input_len, None, Object))\n\n        return self._create_ph_spaces(\n            space_names, space_numbers, weighting_factors, volume_heights, vent_rates, net_areas\n        )\n",
  "language": "python",
  "imports": [
    "ghpythonlib"
  ],
  "has_docstring": true
}