{
  "source_url": "https://github.com/PH-Tools/honeybee_grasshopper_ph_plus/blob/b89f9887488d9c10eb732ffafe910cec70be0752/honeybee_ph_plus_rhino/gh_compo_io/reporting/build_thermal_bridges.py",
  "repo": "PH-Tools/honeybee_grasshopper_ph_plus",
  "repo_stars": 2,
  "repo_description": "Additional Honeybe-PH Grasshopper Components",
  "license": "GPL-3.0",
  "filepath": "honeybee_ph_plus_rhino/gh_compo_io/reporting/build_thermal_bridges.py",
  "instruction": "Functions for getting / sorting all the Honeybee-Model Thermal Bridges .",
  "code": "# -*- coding: utf-8 -*-\n# -*- Python Version: 2.7 -*-\n\n\"\"\"Functions for getting / sorting all the Honeybee-Model Thermal Bridges .\"\"\"\n\nfrom collections import defaultdict\n\ntry:\n    from typing import Dict, List, Set, Tuple\nexcept ImportError:\n    pass  # Python 2.7\n\ntry:\n    from System import Object  # type: ignore\n    from System.Drawing import Color  # type: ignore\nexcept ImportError:\n    pass  # Outside .NET\n\ntry:\n    from Rhino.DocObjects import ObjectAttributes\n    from Rhino.Geometry import Curve\nexcept ImportError:\n    pass  # Outside Rhino\n\ntry:\n    from ladybug_rhino.fromgeometry import (\n        from_face3d,\n        from_linesegment3d,\n        from_polyline3d,\n    )\nexcept ImportError as e:\n    raise ImportError(\"\\nFailed to import ladybug_rhino:\\n\\t{}\".format(e))\n\ntry:\n    from honeybee import model\nexcept ImportError as e:\n    raise ImportError(\"\\nFailed to import honeybee:\\n\\t{}\".format(e))\n\ntry:\n    from honeybee_energy_ph.construction import thermal_bridge\nexcept ImportError as e:\n    raise ImportError(\"\\nFailed to import honeybee_energy_ph:\\n\\t{}\".format(e))\n\ntry:\n    from ph_gh_component_io import gh_io\nexcept ImportError:\n    raise ImportError(\"Failed to import honeybee_ph_rhino\")\n\n\nclass GHCompo_CreateThermalBridges(object):\n    def __init__(\n        self,\n        _IGH,\n        _hb_model,\n        _highlight_outline_color,\n        _highlight_outline_weight,\n        _default_surface_color,\n        _default_outline_color,\n        _default_outline_weight,\n    ):\n        # type: (gh_io.IGH, model.Model, Color, float, Color, Color, float) -> None\n        \"\"\"\n        Arguments:\n        ----------\n            * _IGH (gh_io.IGH): The Grasshopper Interface\n            * _hb_model (model.Model): The Honeybee Model to use as the source.\n            * _highlight_outline_color (System.Drawing.Color): The color to use for the TB Curve outlines\n            * _highlight_outline_weight (float): The plot-weight to use for the TB Curve outlines.\n            * _default_surface_color (System.Drawing.Color):\n            * _default_outline_color (System.Drawing.Color):\n            * _default_outline_weight (float):\n        \"\"\"\n\n        self.IGH = _IGH\n        self.hb_model = _hb_model\n        self.highlight_outline_color = _highlight_outline_color\n        self.highlight_outline_weight = _highlight_outline_weight\n        self.default_surface_color = _default_surface_color\n        self.default_outline_color = _default_outline_color\n        self.default_outline_weight = _default_outline_weight\n\n    def create_rh_attr_object(self, _IGH, _color, _weight):\n        # type: (gh_io.IGH, Color, float) -> ObjectAttributes\n        \"\"\"Return a new Rhino.DocObjects.ObjectAttributes object with specified settings.\"\"\"\n\n        new_attr_obj = _IGH.Rhino.DocObjects.ObjectAttributes()\n\n        new_attr_obj.ObjectColor = _color\n        new_attr_obj.PlotColor = _color\n        new_attr_obj.ColorSource = _IGH.Rhino.DocObjects.ObjectColorSource.ColorFromObject\n        new_attr_obj.PlotColorSource = (\n            _IGH.Rhino.DocObjects.ObjectPlotColorSource.PlotColorFromObject\n        )\n\n        new_attr_obj.PlotWeight = _weight\n        new_attr_obj.PlotWeightSource = (\n            _IGH.Rhino.DocObjects.ObjectPlotWeightSource.PlotWeightFromObject\n        )\n\n        # new_attr_obj.DisplayOrder = 0  # 1 = Front, -1 = Back\n\n        return new_attr_obj\n\n    def get_all_tb_groups_from_model(self, _hb_model):\n        # type: (model.Model) -> Dict[str, List[thermal_bridge.PhThermalBridge]]\n        \"\"\"Return a Dict of all the unique TB objects found in the Model, grouped by display_name.\"\"\"\n\n        # -- First, get every unique TB object in the model\n        all_tbs = {}\n        for hb_room in _hb_model.rooms:\n            for (\n                tb_key,\n                tb,\n            ) in hb_room.properties.ph.ph_bldg_segment.thermal_bridges.items():\n                all_tbs[tb_key] = tb\n\n        # Now group the TBs by name\n        tb_groups = defaultdict(list)\n        for tb in all_tbs.values():\n            tb_groups[tb.display_name].append(tb)\n\n        return tb_groups\n\n    def get_all_tb_names(self, _hb_model):\n        # type: (model.Model) -> List[str]\n        \"\"\"Return a list of all the unique TB object display_names found in the model.\"\"\"\n\n        tb_names = set()\n        for hb_room in _hb_model.rooms:\n            for tb in hb_room.properties.ph.ph_bldg_segment.thermal_bridges.values():\n                tb_names.add(tb.display_name)\n\n        return sorted(list(tb_names))\n\n    def get_tb_geometry(self, _hbph_tb):\n        # type: (thermal_bridge.PhThermalBridge) -> Curve\n        \"\"\"Get the TB Geometry as a Rhino.Geometry.Curve (LineCurve or PolylineCurve)\n\n        Arguments:\n        ----------\n            * _hbph_tb (thermal_bridge.PhThermalBridge):\n\n        Returns:\n        --------\n            * (Rhino.Geometry.Curve)\n        \"\"\"\n        try:\n            return from_polyline3d(_hbph_tb.geometry)\n        except:\n            return from_linesegment3d(_hbph_tb.geometry)\n\n    def run(self):\n        # type: () -> Tuple\n        \"\"\"Return a Tuple of the geometry and attribute DataTrees with the TB data.\n\n        Returns:\n        --------\n            * Tuple[Grasshopper.DataTree, Grasshopper.DataTree]\n        \"\"\"\n\n        # -- Build the output Trees\n        tb_geom_tree_ = self.IGH.Grasshopper.DataTree[Object]()\n        tb_attr_tree_ = self.IGH.Grasshopper.DataTree[ObjectAttributes]()\n        tb_names_tree_ = self.IGH.Grasshopper.DataTree[str]()\n        tb_lengths_tree_ = self.IGH.Grasshopper.DataTree[float]()\n        pth = self.IGH.Grasshopper.Kernel.Data.GH_Path\n\n        if not self.hb_model:\n            return tb_names_tree_, tb_geom_tree_, tb_attr_tree_, tb_lengths_tree_\n\n        # -- Build the RH AttributeObjects\n        rh_attr_surface_default = self.create_rh_attr_object(\n            self.IGH, self.default_surface_color, 0\n        )\n        rh_attr_curve_highlight = self.create_rh_attr_object(\n            self.IGH, self.highlight_outline_color, self.highlight_outline_weight\n        )\n        rh_attr_curve_default = self.create_rh_attr_object(\n            self.IGH, self.default_outline_color, self.default_outline_weight\n        )\n\n        # -- Build the background building Mesh geometry which gets added to each output branch\n        bldg_surface_geom = []\n        bldg_surface_attrs = []\n\n        for hb_room in self.hb_model.rooms:\n            for hb_face in hb_room.faces:\n                # -- Surface\n                mesh = self.IGH.ghpythonlib_components.MeshColours(\n                    from_face3d(hb_face.geometry), rh_attr_surface_default.ObjectColor\n                )\n                bldg_surface_geom.append(mesh)\n                bldg_surface_attrs.append(rh_attr_surface_default)\n\n                # -- Boundary Edges\n                msh_edges = self.IGH.ghpythonlib_components.MeshEdges(mesh).naked_edges\n                msh_boundary = self.IGH.ghpythonlib_components.JoinCurves(\n                    msh_edges, preserve=False\n                )\n                if isinstance(msh_boundary, list):\n                    bldg_surface_geom.extend(msh_boundary)\n                    bldg_surface_attrs.extend(\n                        [rh_attr_curve_default for _ in range(len((msh_boundary)))]\n                    )\n                else:\n                    bldg_surface_geom.append(msh_boundary)\n                    bldg_surface_attrs.append(rh_attr_curve_default)\n\n        # -- Get all the TB objects from the model\n        tb_groups = self.get_all_tb_groups_from_model(self.hb_model)\n\n        # -- Build the thermal bridge curve geometry (with background meshes)\n        for i, tb_name in enumerate(self.get_all_tb_names(self.hb_model)):\n            # -- TB Geom and Rhino ObjectAttributes\n            for tb in tb_groups[tb_name]:\n                # -- Add the background model geom to each branch\n                tb_geom_tree_.AddRange(bldg_surface_geom, pth(i))\n                tb_attr_tree_.AddRange(bldg_surface_attrs, pth(i))\n\n                # -- Add the new TB highlight Geometry\n                tb_geom_tree_.Add(self.get_tb_geometry(tb), pth(i))\n                tb_attr_tree_.Add(rh_attr_curve_highlight, pth(i))\n\n            # -- TB Data\n            tb_names_tree_.Add(tb_name, pth(i))\n            tb_lengths_tree_.Add(sum(tb.length for tb in tb_groups[tb_name]), pth(i))\n\n        return tb_names_tree_, tb_geom_tree_, tb_attr_tree_, tb_lengths_tree_\n",
  "language": "python",
  "imports": [
    "Rhino",
    "Rhino.Geometry",
    "ghpythonlib"
  ],
  "has_docstring": true
}