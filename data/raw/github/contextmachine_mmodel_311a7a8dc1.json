{
  "source_url": "https://github.com/contextmachine/mmodel/blob/0545e5c2a11c641fc54e91f603e709d3dea549f3/lahta/extrusions.py",
  "repo": "contextmachine/mmodel",
  "repo_stars": 0,
  "repo_description": "Deployment branch",
  "license": "Apache-2.0",
  "filepath": "lahta/extrusions.py",
  "instruction": "Copyright (c) 2022. Computational Geometry, Digital Engineering and Optimizing your construction processe\"",
  "code": "#  Copyright (c) 2022. Computational Geometry, Digital Engineering and Optimizing your construction processe\"\nimport json\nimport math\n\nimport compas.geometry as cg\nimport compas_occ.geometry as cc\nimport numpy as np\nimport rhino3dm\nfrom more_itertools import pairwise\nimport itertools\nfrom lahta.items import ParentFrame3D, StraightElement, TransformableItem, Bend, BendSegment, BendSegmentFres\nfrom lahta.setup_view import view\n\nfrom lahta.items import Bend, ParentFrame3D, StraightElement, TransformableItem\nfrom mm.conversions.rhino import list_curves_to_polycurves, rhino_crv_from_compas\n\n\nclass Extrusion(TransformableItem):\n    def __call__(self, *args, **kwargs):\n        super().__call__(*args, **kwargs)\n        self.inner_extr = []\n        self.outer_extr = []\n        self.unroll = []\n\n    def occ_extrusion(self, elems, transf=None, line=None):\n        if transf is not None:\n            inner_extr = cc.OCCNurbsSurface.from_extrusion(elems.inner, self.vector)\n            inner_extr = inner_extr.transformed(transf)\n            #print(transf)\n            outer_extr = cc.OCCNurbsSurface.from_extrusion(elems.outer, self.vector)\n            outer_extr = outer_extr.transformed(transf)\n            setattr(elems, 'extrusion_inner', inner_extr)\n            setattr(elems, 'extrusion_outer', outer_extr)\n            self.inner_extr.append(inner_extr)\n            self.outer_extr.append(outer_extr)\n\n        elif line is not None:\n            unroll = cc.OCCNurbsSurface.from_extrusion(line, self.vector).boundary()\n\n            crv = unroll[0].to_polyline(n=2)\n            join = cc.OCCNurbsCurve.from_line(cg.Line(crv.points[0], crv.points[1]))\n            for i in unroll[1:]:\n                crv = i.to_polyline(n=2)\n                l = cc.OCCNurbsCurve.from_line(cg.Line(crv.points[0], crv.points[1]))\n                join = join.joined(l)\n\n            setattr(elems, 'unroll', join)\n            self.unroll.append(join)\n\n        return elems\n\n\n\n\n\nclass BendPanelExtrusion(Extrusion):\n\n    @ParentFrame3D\n    def extrusion_parent(self):\n        return self.extrusion_line, self.normal\n\n    @property\n    def transl_frame(self):\n        vec = cg.Vector.from_start_end(self.profile.inner[0].start, self.profile.outer[0].start)\n        v = vec.unitized().inverted() * vec.length\n        tr = cg.Translation.from_vector(v)\n        self._transl_frame = self.extrusion_parent.transformed(tr)\n        return self._transl_frame\n\n    @property\n    def vector(self):\n        vector = cg.Vector.from_start_end(self.extrusion_line.start, self.extrusion_line.end)\n        self._vector = vector.unitized() * self.lengths[0]\n        return self._vector\n\n    def __init__(self, *args, **kwargs):\n        super().__init__(*args, **kwargs)\n\n    def __call__(self, *args, **kwargs):\n        self._i = 0\n        self.bend_extr = []\n\n        self.profile, self.extrusion_line, self.normal, self.lengths = args\n        self.profile(parent_obj=self.extrusion_parent)\n\n        super().__call__(profile=self.profile, vector=self.vector, *args, **kwargs)\n        self.point = self.extrusion_parent.point\n\n        while self._i < self.__len__():\n            bend = next(self)\n            self.bend_extr.append(bend)\n\n        self.reload()\n\n    def __len__(self):\n        return len(self.profile.obj_transform)\n\n    def __next__(self):\n        extrusion = self.profile.obj_transform[self._i]\n        transl = cg.Translation.from_vector(self.vector.unitized() * (self.lengths[1]))\n\n        extrude_profile = self.occ_extrusion(extrusion, transf=transl)\n\n        self._i += 1\n        return extrude_profile\n\n    def reload(self):\n        self._i = 0\n\n\nclass StrongBendExtrusion(BendPanelExtrusion):\n    def __call__(self, profile: Bend, line: cg.Line, normal: cg.Vector, *args, **kwargs):\n        super(StrongBendExtrusion, self).__call__(profile, line, normal, *args, **kwargs)\n\n    @property\n    def extrude_transform_rh(self):\n        return rhino3dm.Transform.Translation(*np.array(self.vector))\n\n    @property\n    def inner_rh(self) -> rhino3dm.PolyCurve:\n        return list_curves_to_polycurves(rhino_crv_from_compas(self.profile.inner))\n\n    @property\n    def outer_rh(self) -> rhino3dm.PolyCurve:\n        return list_curves_to_polycurves(rhino_crv_from_compas(self.profile.outer))\n\n    @property\n    def extruded_inner_rh(self) -> rhino3dm.PolyCurve:\n        i = self.inner_rh.Duplicate()\n        i.Transform(self.extrude_transform_rh)\n        return i\n\n    @property\n    def extruded_outer_rh(self) -> rhino3dm.PolyCurve:\n        o = self.outer_rh.Duplicate()\n        o.Transform(self.extrude_transform_rh)\n        return o\n\n    @property\n    def extruded_cap_start_rh(self) -> rhino3dm.Line:\n        return rhino3dm.NurbsCurve.CreateFromLine(\n            rhino3dm.Line(self.extruded_inner_rh.PointAtStart, self.extruded_outer_rh.PointAtStart))\n\n    @property\n    def extruded_cap_end_rh(self) -> rhino3dm.Line:\n        return rhino3dm.NurbsCurve.CreateFromLine(\n            rhino3dm.Line(self.extruded_inner_rh.PointAtEnd, self.extruded_outer_rh.PointAtEnd))\n\n    @property\n    def cap_start_rh(self) -> rhino3dm.Line:\n        return rhino3dm.NurbsCurve.CreateFromLine(rhino3dm.Line(self.inner_rh.PointAtStart, self.outer_rh.PointAtStart))\n\n    @property\n    def cap_end_rh(self) -> rhino3dm.Line:\n        return rhino3dm.NurbsCurve.CreateFromLine(rhino3dm.Line(self.inner_rh.PointAtEnd, self.outer_rh.PointAtEnd))\n\n    @property\n    def extrusion_inner_rh(self):\n        return rhino3dm.NurbsSurface.CreateRuledSurface(self.inner_rh, self.extruded_inner_rh)\n\n    @property\n    def extrusion_outer_rh(self):\n        return rhino3dm.NurbsSurface.CreateRuledSurface(self.outer_rh, self.extruded_outer_rh)\n\n    @property\n    def extrusion_cap_start_rh(self):\n        return rhino3dm.NurbsSurface.CreateRuledSurface(self.cap_start_rh, self.extruded_cap_start_rh)\n\n    @property\n    def extrusion_cap_end_rh(self):\n        return rhino3dm.NurbsSurface.CreateRuledSurface(self.cap_end_rh, self.extruded_cap_end_rh)\n\n    @property\n    def extrusion_rh(self):\n        # polycurve_a = list_curves_to_polycurves([self.outer_rh, self.cap_start_rh, self.inner_rh, self.cap_end_rh])\n        # polycurve_b = polycurve_a.Duplicate()\n        # polycurve_b.Transform(self.extrude_transform_rh)\n        # rhino3dm.NurbsSurface.CreateRuledSurface(polycurve_a, polycurve_b)\n\n        return [self.extrusion_cap_start_rh, self.extrusion_outer_rh, self.extrusion_cap_end_rh,\n                self.extrusion_inner_rh]\n\n\nclass BendPanelUnroll(BendPanelExtrusion):\n\n    def translation_vector(self, dist):\n        vec = self.extrusion_parent.xaxis * dist\n        transl = cg.Translation.from_vector(vec)\n        return self.point.transformed(transl)\n\n    def __init__(self, *args, **kwargs):\n        super().__init__(*args, **kwargs)\n\n    def __call__(self, *args, **kwargs):\n        super().__call__(*args, **kwargs)\n\n    def __len__(self):\n        return len(self.profile.obj_transform)\n\n    def __next__(self):\n\n        extrusion = self.profile.obj_transform[self._i]\n\n        if isinstance(extrusion, StraightElement):\n            n_o = self.profile.obj_transform[self._i - 1].straight_len / 2\n            try:\n                n_t = self.profile.obj_transform[self._i + 1].straight_len / 2\n                transl_point = self.translation_vector(extrusion.length_out + n_o + n_t)\n            except IndexError:\n                transl_point = self.translation_vector(extrusion.length_out + n_o)\n\n            line = cc.OCCNurbsCurve.from_line(cg.Line(self.point, transl_point))\n            transl = cg.Translation.from_vector(self.vector.unitized() * self.lengths[2])\n\n            extrude_profile = self.occ_extrusion(extrusion, line=line.transformed(transl))\n\n            self.point = transl_point\n            self._i += 1\n\n            return extrude_profile\n\n        else:\n            self._i += 1\n\n    def reload(self):\n        self._i = 0\n        self.point = self.extrusion_parent.point\n\n    @property\n    def rhino_extrusion(self):\n        l = []\n        for i in self.unroll:\n            crv = rhino_crv_from_compas([i])\n            crv = list_curves_to_polycurves(crv)\n            l.append(crv)\n        self._rhino_extrusion = l\n        return self._rhino_extrusion\n\n\nclass Panel(TransformableItem):\n\n    @property\n    def tri_offset(self):\n        self._tri_offset = self.bend_types[0].tri_offset\n        return self._tri_offset\n\n    @property\n    def unroll_offset(self):\n        self._unroll_offset = self.bend_types[0].unroll_offset\n        return self._unroll_offset\n\n    @property\n    def coor_offset_extrusion(self):\n        offset = cg.offset_polygon(self.coor_axis, self.tri_offset)\n        self._coor_offset_extrusion = cg.Polygon(offset)\n        return self._coor_offset_extrusion\n\n    @property\n    def coor_offset_unroll(self):\n        dist = self.bend_types[0].unroll_offset\n        offset = cg.offset_polygon(self.coor_axis, self.tri_offset - dist)\n        self._coor_offset_unroll = cg.Polygon(offset)\n        return self._coor_offset_unroll\n\n    @property\n    def angles(self):\n        l_one = np.asarray(self.coor_offset_extrusion.lines)\n        l_two = np.roll(l_one, 1, axis=0)\n        angles = []\n        for o, t in zip(l_one, l_two):\n            vec_o = cg.Vector.from_start_end(o[1], o[0])\n            vec_t = cg.Vector.from_start_end(t[0], t[1])\n            angles.append(vec_o.angle(vec_t) / 2)\n        angles.append(angles[0])\n        self._angles = list(pairwise(angles))\n        return self._angles\n\n    @property\n    def lengths(self):\n        self._lengths = []\n\n        param = 0.01\n        poly = cg.Polygon(self.coor_axis).lines\n        for i, v in enumerate(poly):\n            dist = (param / 2) / math.sin(self.angles[i][0])\n            neigh_one = 1 / math.tan(self.angles[i][0])\n            neigh_two = 1 / math.tan(self.angles[i][1])\n            bend_l = v.length - neigh_one - neigh_two\n\n            ofs_l = neigh_one * (1 - self.tri_offset)\n\n            unrl_l = neigh_one * (1 - (self.tri_offset - self.unroll_offset))\n\n            self._lengths.append([bend_l, ofs_l, unrl_l])\n\n        return self._lengths\n\n    @property\n    def normal(self):\n        self._normal = list(itertools.repeat(self.coor_offset_extrusion.normal, len(self.bend_types)))\n        return self._normal\n\n    def __call__(self, coor_axis, bend_types, *args, **kwargs):\n        super().__call__(coor_axis=coor_axis, bend_types=bend_types, *args, **kwargs)\n\n        self.bend_types = bend_types\n        self.bends_extrusion = list(\n            map(BendPanelExtrusion, self.bend_types, self.coor_offset_extrusion.lines, self.normal, self.lengths))\n        self.bends_unroll = list(map(BendPanelUnroll, self.bend_types, self.coor_offset_unroll.lines, self.normal, self.lengths))\n\n\n    def to_rhino(self):\n        model = rhino3dm.File3dm()\n\n        for unr in self.bends_unroll:\n            #for i in ext.rhino_extrusion:\n                #model.Objects.Add(i)\n\n            for i in unr.rhino_extrusion:\n                model.Objects.Add(i)\n\n        poly = [cc.OCCNurbsCurve.from_line(i) for i in cg.Polygon(self.coor_axis).lines]\n        crv_poly = rhino_crv_from_compas(poly)\n        crv_poly = list_curves_to_polycurves(crv_poly)\n        model.Objects.Add(crv_poly)\n\n        poly_of = [cc.OCCNurbsCurve.from_line(i) for i in self.coor_offset_extrusion.lines]\n        crv_poly_of = rhino_crv_from_compas(poly_of)\n        crv_poly_of = list_curves_to_polycurves(crv_poly_of)\n        model.Objects.Add(crv_poly_of)\n\n        model.Write(f\"/Users/sofyadobycina/Desktop/{hex(id(self))}.3dm\")\n\n\nclass TypingPanel(Panel):\n    unroll_type = BendPanelUnroll\n    extrusion_type = BendPanelExtrusion\n\n    def __call__(self, coor_axis, bend_types, *args, **kwargs):\n        # Мне пришлось полностью переопределить __call__ для этой реализации,\n        # только потому что классы было не достать.\n        # Вся идея в том, чтобы объявить классы Unroll и Extrusion в качестве переменных.\n        super(TransformableItem, self).__call__(coor_axis=coor_axis, bend_types=bend_types, *args, **kwargs)\n\n        self.bend_types = bend_types\n        self.bends_extrusion = list(\n            map(self.extrusion_type, self.bend_types, self.coor_offset_extrusion.lines, self.normal, self.lengths))\n        # self.bends_unroll = list(map(self.unroll_type, self.bend_types, self.coor_offset_unroll.lines, self.normal, self.lengths))\n        self.bends_unroll = list(map(self.unroll_type, self.bend_types, self.coor_offset_unroll.lines, self.normal, self.lengths))\n\n\nclass RhinoFriendlyPanel(TypingPanel):\n\n    \"\"\"\n    >>> from lahta.items import *\n    >>> panel = RhinoFriendlyPanel(coor_axis=[[258.627489, 545.484455, 490.055883],\n    ...                         [36.862172, -12.028006, 490.055883],\n    ...                         [705.257292, 44.962907, 490.055883]],\n    ...              bend_types=[\n    ...                  Bend([BendSegmentFres(36, 0.8, 90, in_rad=0.3),\n    ...                       BendSegment(18, 1.0, 90),\n    ...                       BendSegment(7, 1.0, 90)]),\n    ...                  Bend([BendSegmentFres(36, 0.8, 90, in_rad=0.3)]),\n    ...                  Bend([BendSegmentFres(36, 0.8, 90, in_rad=0.3)])\n    ...              ]\n    ...              )\n    >>> ext1=panel.bends_extrusion[0]\n    >>> model=rhino3dm.File3dm()\n    >>> [model.Objects.Add(ext) for ext in ext1.extrusion_rh]\n    [UUID('08874b17-c8d0-4236-8c55-de433175eecc'),\n     UUID('37e220fe-8f20-4b50-8d5d-15af571240f3'),\n     UUID('29c41150-f50d-44e8-875e-68551084ce3d'),\n     UUID('04bfec2a-60af-4a32-ba82-5c0014f116b2')]\n    >>> [model.Objects.Add(ext) for ext in panel.bends_extrusion[1].extrusion_rh]\n    [UUID('ea7c4044-6e79-4f25-b3d8-1875091fac16'),\n     UUID('ada9f62c-6fcc-440e-9b31-bde88e6e4958'),\n     UUID('affa554a-90fe-4594-bde5-71374ced1fc9'),\n     UUID('0318af09-8a5f-4f5e-b5a6-c966c575fa2c')]\n    >>> [model.Objects.Add(ext) for ext in panel.bends_extrusion[2].extrusion_rh]\n    [UUID('b4df8ce7-2321-4780-96d3-437ce2231e3b'),\n     UUID('780a9855-0a8a-472e-85ff-636a544147ba'),\n     UUID('7addc705-4b07-4951-bc26-fa6fe63a73e9'),\n     UUID('1faf1e87-d446-4b03-9389-68373e540095')]\n    >>> model.Write(\"example.3dm\")\n    True\n    \"\"\"\n    extrusion_type = StrongBendExtrusion\n",
  "language": "python",
  "imports": [
    "rhino3dm"
  ],
  "has_docstring": true
}