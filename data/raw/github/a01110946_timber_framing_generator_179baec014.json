{
  "source_url": "https://github.com/a01110946/timber_framing_generator/blob/0b689e23c0ee24a9cfbdf280b219f659a54afd43/scripts/gh_mep_connector_extractor.py",
  "repo": "a01110946/timber_framing_generator",
  "repo_stars": 3,
  "repo_description": "A Python tool bridging Revit and Rhino through Rhino.Inside.Revit to automate timber frame design. Processes Revit walls to generate complete framing solutions including studs, plates, headers, and cripples. Features intelligent wall decomposition, opening analysis, and automated documentation generation.",
  "license": "unknown",
  "filepath": "scripts/gh_mep_connector_extractor.py",
  "instruction": "MEP Connector Extractor for Grasshopper.",
  "code": "# File: scripts/gh_mep_connector_extractor.py\n\"\"\"MEP Connector Extractor for Grasshopper.\n\nExtracts plumbing connectors from Revit fixtures for pipe routing.\nThis is the first step in the MEP integration pipeline.\n\nKey Features:\n1. Connector Extraction\n   - Extracts position, direction, and system type from Revit MEP connectors\n   - Handles MEPModel/ConnectorManager None checks gracefully\n\n2. System Type Filtering\n   - Optional filter for Sanitary, DomesticColdWater, DomesticHotWater, Vent\n\n3. Routing Direction\n   - Returns physical routing direction (DOWN for drains, UP for vents)\n   - NOT the connector's local axis (which varies by family authoring)\n\nEnvironment:\n    Rhino 8\n    Grasshopper\n    Python component (CPython 3)\n    Rhino.Inside.Revit\n\nDependencies:\n    - Rhino.Geometry: Core geometry creation\n    - Grasshopper: Component framework\n    - RevitAPI: MEP connector access\n    - timber_framing_generator.mep.plumbing: Connector extraction logic\n\nInput Requirements:\n    plumbing_fixtures (fixtures) - list:\n        Revit FamilyInstance elements (sinks, toilets, etc.)\n        Required: Yes\n        Access: List\n\n    system_types (sys_types) - list:\n        Filter for system types [\"Sanitary\", \"DomesticColdWater\", etc.]\n        Required: No (defaults to all types)\n        Access: List\n\n    exclude_connected (excl_conn) - bool:\n        Skip connectors already connected to pipes\n        Required: No (defaults to False)\n        Access: Item\n\n    run (run) - bool:\n        Execute toggle\n        Required: Yes\n        Access: Item\n\nOutputs:\n    connectors_json (json) - str:\n        JSON with connector data for downstream components\n\n    connector_points (pts) - list of Point3d:\n        Connector positions for visualization\n\n    connector_vectors (vecs) - list of Vector3d:\n        Routing directions for visualization\n\n    debug_info (info) - str:\n        Processing summary and diagnostics\n\nAuthor: Claude AI Assistant\nVersion: 1.1.0\n\"\"\"\n\n# =============================================================================\n# Imports\n# =============================================================================\n\n# Standard library\nimport sys\nimport json\nimport traceback\n\n# Force reload of project modules (development only)\nFORCE_RELOAD = True\nif FORCE_RELOAD:\n    modules_to_reload = [k for k in sys.modules.keys()\n                         if 'timber_framing_generator' in k]\n    for mod_name in modules_to_reload:\n        del sys.modules[mod_name]\n\n# .NET / CLR\nimport clr\nclr.AddReference(\"Grasshopper\")\nclr.AddReference(\"RhinoCommon\")\n\n# Rhino / Grasshopper\nimport Rhino\nimport Rhino.Geometry as rg\nimport Grasshopper\nfrom Grasshopper import DataTree\nfrom Grasshopper.Kernel.Data import GH_Path\n\n# =============================================================================\n# Constants\n# =============================================================================\n\nCOMPONENT_NAME = \"MEP Connector Extractor\"\nCOMPONENT_NICKNAME = \"MEPConn\"\nCOMPONENT_MESSAGE = \"v1.1\"\n\n# Project path\nPROJECT_PATH = r\"C:\\Users\\Fernando Maytorena\\OneDrive\\Documentos\\GitHub\\timber_framing_generator\"\nif PROJECT_PATH not in sys.path:\n    sys.path.insert(0, PROJECT_PATH)\n\n# =============================================================================\n# Project Imports\n# =============================================================================\n\ntry:\n    from src.timber_framing_generator.mep.plumbing import extract_plumbing_connectors\n    from src.timber_framing_generator.core import MEPConnector\n    from src.timber_framing_generator.utils.geometry_factory import get_factory\n    PROJECT_AVAILABLE = True\n    PROJECT_ERROR = None\nexcept ImportError as e:\n    PROJECT_AVAILABLE = False\n    PROJECT_ERROR = str(e)\n\n# =============================================================================\n# Logging Utilities\n# =============================================================================\n\ndef log_message(message, level=\"info\"):\n    \"\"\"Log to console and optionally add GH runtime message.\"\"\"\n    print(f\"[{level.upper()}] {message}\")\n    if level == \"warning\":\n        ghenv.Component.AddRuntimeMessage(\n            Grasshopper.Kernel.GH_RuntimeMessageLevel.Warning, message)\n    elif level == \"error\":\n        ghenv.Component.AddRuntimeMessage(\n            Grasshopper.Kernel.GH_RuntimeMessageLevel.Error, message)\n\n\ndef log_info(message):\n    print(f\"[INFO] {message}\")\n\n\ndef log_warning(message):\n    log_message(message, \"warning\")\n\n\ndef log_error(message):\n    log_message(message, \"error\")\n\n# =============================================================================\n# Component Setup\n# =============================================================================\n\ndef setup_component():\n    \"\"\"Initialize and configure the Grasshopper component.\"\"\"\n    ghenv.Component.Name = COMPONENT_NAME\n    ghenv.Component.NickName = COMPONENT_NICKNAME\n    ghenv.Component.Message = COMPONENT_MESSAGE\n\n# =============================================================================\n# Helper Functions\n# =============================================================================\n\ndef validate_inputs():\n    \"\"\"Validate component inputs.\"\"\"\n    if not PROJECT_AVAILABLE:\n        return False, f\"Project import error: {PROJECT_ERROR}\"\n\n    if not run:\n        return False, \"Toggle 'run' to True to execute\"\n\n    if not plumbing_fixtures:\n        return False, \"No plumbing fixtures provided\"\n\n    return True, None\n\n\ndef build_filter_config():\n    \"\"\"Build filter configuration from inputs.\"\"\"\n    config = {}\n\n    if system_types:\n        filter_list = list(system_types) if hasattr(system_types, '__iter__') else [system_types]\n        config[\"system_types\"] = filter_list\n\n    if exclude_connected:\n        config[\"exclude_connected\"] = True\n\n    return config\n\n\ndef create_visualization_geometry(connectors, factory):\n    \"\"\"Create visualization points and vectors using RhinoCommonFactory.\n\n    Args:\n        connectors: List of MEPConnector objects\n        factory: RhinoCommonFactory instance\n\n    Returns:\n        tuple: (points, vectors) lists\n    \"\"\"\n    points = []\n    vectors = []\n\n    for conn in connectors:\n        # Create point using factory (ensures RhinoCommon assembly)\n        pt = factory.create_point3d(\n            conn.origin[0],\n            conn.origin[1],\n            conn.origin[2]\n        )\n        points.append(pt)\n\n        # Create vector using factory\n        vec = factory.create_vector3d(\n            conn.direction[0],\n            conn.direction[1],\n            conn.direction[2]\n        )\n        vectors.append(vec)\n\n    return points, vectors\n\n# =============================================================================\n# Main Function\n# =============================================================================\n\ndef main():\n    \"\"\"Main entry point for the component.\"\"\"\n    # Setup component\n    setup_component()\n\n    # Initialize outputs\n    connectors_json = \"{}\"\n    connector_points = []\n    connector_vectors = []\n    debug_lines = []\n\n    debug_lines.append(\"=\" * 50)\n    debug_lines.append(\"MEP CONNECTOR EXTRACTOR\")\n    debug_lines.append(\"=\" * 50)\n\n    try:\n        # Validate inputs\n        is_valid, error_msg = validate_inputs()\n        if not is_valid:\n            debug_lines.append(error_msg)\n            return connectors_json, connector_points, connector_vectors, \"\\n\".join(debug_lines)\n\n        debug_lines.append(f\"Input fixtures: {len(plumbing_fixtures)}\")\n\n        # Build filter config\n        filter_config = build_filter_config()\n        if filter_config.get(\"system_types\"):\n            debug_lines.append(f\"Filtering by: {filter_config['system_types']}\")\n\n        # Extract connectors\n        debug_lines.append(\"\")\n        debug_lines.append(\"Extracting connectors...\")\n        connectors = extract_plumbing_connectors(plumbing_fixtures, filter_config)\n        debug_lines.append(f\"Extracted {len(connectors)} connectors\")\n\n        if not connectors:\n            debug_lines.append(\"No plumbing connectors found\")\n            debug_lines.append(\"Ensure fixtures have MEP connectors in their families\")\n            return connectors_json, connector_points, connector_vectors, \"\\n\".join(debug_lines)\n\n        # Analyze by system type\n        system_type_counts = {}\n        for conn in connectors:\n            st = conn.system_type\n            system_type_counts[st] = system_type_counts.get(st, 0) + 1\n\n        debug_lines.append(\"\")\n        debug_lines.append(\"Connectors by system type:\")\n        for st, count in sorted(system_type_counts.items()):\n            debug_lines.append(f\"  {st}: {count}\")\n\n        # Build JSON output\n        output_data = {\n            \"connectors\": [conn.to_dict() for conn in connectors],\n            \"count\": len(connectors),\n            \"system_types\": list(system_type_counts.keys()),\n            \"source\": \"gh_mep_connector_extractor\",\n        }\n        connectors_json = json.dumps(output_data, indent=2)\n\n        # Create visualization geometry using RhinoCommonFactory\n        factory = get_factory()\n        connector_points, connector_vectors = create_visualization_geometry(connectors, factory)\n\n        debug_lines.append(\"\")\n        debug_lines.append(f\"Created {len(connector_points)} visualization points\")\n        debug_lines.append(f\"JSON output size: {len(connectors_json)} chars\")\n\n        # Summary\n        debug_lines.append(\"\")\n        debug_lines.append(\"=\" * 50)\n        debug_lines.append(\"EXTRACTION COMPLETE\")\n        debug_lines.append(f\"Total connectors: {len(connectors)}\")\n        debug_lines.append(\"=\" * 50)\n\n    except Exception as e:\n        log_error(f\"Unexpected error: {str(e)}\")\n        debug_lines.append(f\"ERROR: {str(e)}\")\n        debug_lines.append(traceback.format_exc())\n\n    return connectors_json, connector_points, connector_vectors, \"\\n\".join(debug_lines)\n\n# =============================================================================\n# Execution\n# =============================================================================\n\n# Define default input values if not provided by Grasshopper\nif 'run' not in dir():\n    run = False\n\nif 'plumbing_fixtures' not in dir():\n    plumbing_fixtures = []\n\nif 'system_types' not in dir():\n    system_types = None\n\nif 'exclude_connected' not in dir():\n    exclude_connected = False\n\n# Execute main and assign to output variables\nconnectors_json, connector_points, connector_vectors, debug_info = main()\n",
  "language": "python",
  "imports": [
    "Rhino",
    "Rhino.Geometry",
    "RhinoCommon"
  ],
  "has_docstring": true
}