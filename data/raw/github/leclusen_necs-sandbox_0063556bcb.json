{
  "source_url": "https://github.com/leclusen/necs-sandbox/blob/8d8006ae3c845c9f3e38154803caac6b03d298a9/structure-batiment/structure_aligner/transform/voile_simplifier.py",
  "repo": "leclusen/necs-sandbox",
  "repo_stars": 0,
  "repo_description": null,
  "license": "unknown",
  "filepath": "structure-batiment/structure_aligner/transform/voile_simplifier.py",
  "instruction": "Voile (wall) simplification: replace multi-face Breps with single-face per-floor segments.",
  "code": "\"\"\"Voile (wall) simplification: replace multi-face Breps with single-face per-floor segments.\n\nPhase 5.2 - For each removed multi-face voile, extract its planar extent\nand create single-face segments split at floor Z-level boundaries.\n\"\"\"\n\nfrom __future__ import annotations\n\nimport logging\nfrom dataclasses import dataclass\n\nimport rhino3dm\n\nlogger = logging.getLogger(__name__)\n\n\n@dataclass\nclass VoileExtent:\n    \"\"\"Geometric extent of a removed voile.\"\"\"\n    name: str\n    # The wall's axis: \"X\" (varies in X, constant Y) or \"Y\" (varies in Y, constant X)\n    orientation: str\n    # Along-wall extent\n    coord_min: float   # min X (or min Y)\n    coord_max: float   # max X (or max Y)\n    # Cross-wall position (the constant coordinate)\n    cross_coord: float\n    # Vertical extent\n    z_min: float\n    z_max: float\n    # Thickness (for the narrow dimension)\n    thickness: float\n    # Layer index from the original object\n    layer_index: int\n\n\ndef extract_voile_extents(\n    model: rhino3dm.File3dm,\n    voile_names: list[str],\n) -> list[VoileExtent]:\n    \"\"\"Extract geometric extents from voile objects before removal.\n\n    Call this BEFORE removing voiles to capture their geometry.\n    \"\"\"\n    extents: list[VoileExtent] = []\n    for obj in model.Objects:\n        name = obj.Attributes.Name\n        if name not in voile_names:\n            continue\n        geom = obj.Geometry\n        if not isinstance(geom, rhino3dm.Brep) or len(geom.Vertices) == 0:\n            continue\n\n        xs = [geom.Vertices[i].Location.X for i in range(len(geom.Vertices))]\n        ys = [geom.Vertices[i].Location.Y for i in range(len(geom.Vertices))]\n        zs = [geom.Vertices[i].Location.Z for i in range(len(geom.Vertices))]\n\n        x_range = max(xs) - min(xs)\n        y_range = max(ys) - min(ys)\n\n        # Known limitation: diagonal walls (>5° from axis) are approximated\n        # as axis-aligned. This is acceptable for the structural model where\n        # walls are predominantly axis-aligned.\n        if x_range > y_range:\n            orientation = \"X\"\n            coord_min, coord_max = min(xs), max(xs)\n            cross_coord = (min(ys) + max(ys)) / 2\n            thickness = y_range\n        else:\n            orientation = \"Y\"\n            coord_min, coord_max = min(ys), max(ys)\n            cross_coord = (min(xs) + max(xs)) / 2\n            thickness = x_range\n\n        extents.append(VoileExtent(\n            name=name,\n            orientation=orientation,\n            coord_min=coord_min,\n            coord_max=coord_max,\n            cross_coord=cross_coord,\n            z_min=min(zs),\n            z_max=max(zs),\n            thickness=max(thickness, 0.15),  # minimum 15cm\n            layer_index=obj.Attributes.LayerIndex,\n        ))\n    return extents\n\n\ndef simplify_voiles(\n    model: rhino3dm.File3dm,\n    voile_extents: list[VoileExtent],\n    floor_z_levels: tuple[float, ...],\n    layer_index: int = 0,\n) -> int:\n    \"\"\"Create simplified single-face voile segments per floor.\n\n    For each removed voile, splits its Z extent into floor-to-floor\n    segments and creates a single-face planar Brep for each.\n\n    Args:\n        model: The rhino3dm model to add objects to.\n        voile_extents: Geometric extents from removed voiles.\n        floor_z_levels: Known floor Z-levels for splitting.\n        layer_index: Default layer index for new objects.\n\n    Returns:\n        Number of simplified voile segments added.\n    \"\"\"\n    if not voile_extents:\n        return 0\n\n    sorted_z = sorted(floor_z_levels)\n    added = 0\n\n    for extent in voile_extents:\n        # Find floor boundaries within this voile's Z range\n        z_boundaries = _get_floor_boundaries(\n            extent.z_min, extent.z_max, sorted_z\n        )\n\n        if len(z_boundaries) < 2:\n            # Single segment spanning the full height\n            z_boundaries = [extent.z_min, extent.z_max]\n\n        for i in range(len(z_boundaries) - 1):\n            z_bot = z_boundaries[i]\n            z_top = z_boundaries[i + 1]\n\n            if z_top - z_bot < 0.1:  # skip very thin segments\n                continue\n\n            brep = _create_wall_brep(extent, z_bot, z_top)\n            if brep is None:\n                continue\n\n            suffix = f\"_{i}\" if len(z_boundaries) > 2 else \"\"\n            attr = rhino3dm.ObjectAttributes()\n            attr.Name = f\"{extent.name}{suffix}\"\n            attr.LayerIndex = extent.layer_index if extent.layer_index > 0 else layer_index\n            model.Objects.AddBrep(brep, attr)\n            added += 1\n\n    logger.info(\"Voile simplification: %d segments added\", added)\n    return added\n\n\ndef _get_floor_boundaries(\n    z_min: float, z_max: float, sorted_z: list[float], tol: float = 0.1,\n) -> list[float]:\n    \"\"\"Get floor Z-levels that fall within the voile's Z range.\"\"\"\n    boundaries = [z_min]\n    for z in sorted_z:\n        if z_min + tol < z < z_max - tol:\n            boundaries.append(z)\n    boundaries.append(z_max)\n    return sorted(set(boundaries))\n\n\ndef _create_wall_brep(\n    extent: VoileExtent,\n    z_bot: float,\n    z_top: float,\n) -> rhino3dm.Brep | None:\n    \"\"\"Create a single-face vertical planar Brep for a wall segment.\n\n    Note: PlaneSurface parametric intervals map directly to world coordinates\n    only when the plane is axis-aligned. This is valid here because walls are\n    classified as X-oriented or Y-oriented (diagonal walls are approximated).\n    \"\"\"\n    half_t = extent.thickness / 2\n\n    if extent.orientation == \"X\":\n        # Wall extends in X, thin in Y, vertical in Z\n        # Plane normal = Y → parametric U maps to world X, V maps to world Z\n        plane = rhino3dm.Plane(\n            rhino3dm.Point3d(0, extent.cross_coord, 0),\n            rhino3dm.Vector3d(0, 1, 0),\n        )\n        srf = rhino3dm.PlaneSurface(\n            plane,\n            rhino3dm.Interval(extent.coord_min, extent.coord_max),  # X extent\n            rhino3dm.Interval(z_bot, z_top),                         # Z extent\n        )\n    else:\n        # Wall extends in Y, thin in X, vertical in Z\n        # Plane normal = X → parametric U maps to world Y, V maps to world Z\n        plane = rhino3dm.Plane(\n            rhino3dm.Point3d(extent.cross_coord, 0, 0),\n            rhino3dm.Vector3d(1, 0, 0),\n        )\n        srf = rhino3dm.PlaneSurface(\n            plane,\n            rhino3dm.Interval(extent.coord_min, extent.coord_max),  # Y extent\n            rhino3dm.Interval(z_bot, z_top),                         # Z extent\n        )\n\n    return rhino3dm.Brep.CreateFromSurface(srf)\n",
  "language": "python",
  "imports": [
    "rhino3dm"
  ],
  "has_docstring": true
}