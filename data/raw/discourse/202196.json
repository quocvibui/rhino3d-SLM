{
  "source_url": "https://discourse.mcneel.com/t/scripting-cage-edit-function/202196",
  "topic_id": 202196,
  "title": "Scripting Cage_Edit function",
  "question": "Hello everyone,\n\n\nI’m currently working on a problem related to automated surface deformation in Rhino.\n\n\nInitially, I developed a Grasshopper model to achieve this, but I wasn’t completely satisfied with the result since it was essentially based on the surface control points that I wanted to modify.\n\n\nTo improve this deformation model, I’d like to use Rhino’s _CageEdit function in a Python script running in Rhino. The problem I’m currently having is that once the geometry has been deformed by the _CageEdit function, I can’t get it back into the Rhino file, to export it for example. I seem to have to commit it after deforming it. The deformed geometry is visible as a gauge in Rhino’s graphical interface (see Photo), but it disappears as soon as I press ESC or anything else.\n\n\nSo I’d like to know how to “commit” or “Bake” the surface I’ve just modified?\n\n\nYou’ll see my current script down below.\n\n\nThanks in advance for your feedback,\n\n\nBest regards,\n\n\nEtienne\n\n\nCapture d’écran 2025-03-28 103822\n1026×636 187 KB\n\n\n# -*- coding: utf-8 -*-\nimport rhinoscriptsyntax as rs\nimport Rhino\nfrom Rhino import Geometry as rg\nimport scriptcontext as sc\nimport math as m\n\n# There is only one geometry in my .3dm file\nobjects = rs.AllObjects()\nif not objects:\n    print(\"No object found\")\nsurface_guid= objects[0] # Pick the one and only geometry\n\n# Select the surface\nrs.SelectObject(bateau_guid)\n# CageEdit set up\ncmd = '_CageEdit \\n _B \\n G \\n _Enter \\n _G \\n'\nrs.Command(cmd, echo=True)\ncage_ids=rs.LastCreatedObjects()\ncage_id=cage_ids[0]\n\nrh_obj = rs.coercerhinoobject(cage_id)\nif not rh_obj:\n    print(\"Impossible to convert the cage in rhicommon object\")\n    exit()\n# Step 5 : Enable grips\nrh_obj.GripsOn = True\n\n# Select grips\ngrips = rh_obj.GetGrips()\n# Move grips (example : vec(200,100,0))\nfor grip in grips:\n    grip.Move(Rhino.Geometry.Vector3d(200, 100, 0))",
  "code_blocks": [
    {
      "code": "# Select grips\ngrips = rh_obj.GetGrips()\n# Move grips (example : vec(200,100,0))\nfor grip in grips:\n    grip.Move(Rhino.Geometry.Vector3d(200, 100, 0))\n# ***********\nsc.doc.Objects.GripUpdate(rh_obj,True) # add this to update the object\n# ***********",
      "language": "python",
      "author": "Tom_P",
      "post_number": 2,
      "is_solution": true
    },
    {
      "code": "import rhinoinside\nrhinoinside.load()\nimport Rhino\nfrom Rhino.Geometry import *\nimport System\nimport numpy as np\nimport os\n\nclass CageMorph:\n    def __init__(self, source_pts, target_pts, nx, ny, nz):\n        self.source_pts = np.array(source_pts).reshape((nx, ny, nz))\n        self.target_pts = np.array(target_pts).reshape((nx, ny, nz))\n        self.nx, self.ny, self.nz = nx, ny, nz\n\n    def morph_point(self, pt):\n        u = self._get_normalized_position(pt)\n        if u is None:\n            return pt  # Hors cage\n\n        i = int(u[0] * (self.nx - 1))\n        j = int(u[1] * (self.ny - 1))\n        k = int(u[2] * (self.nz - 1))\n\n        i = min(i, self.nx - 2)\n        j = min(j, self.ny - 2)\n        k = min(k, self.nz - 2)\n\n        dx = u[0] * (self.nx - 1) - i\n        dy = u[1] * (self.ny - 1) - j\n        dz = u[2] * (self.nz - 1) - k\n\n        def get(p, q, r): return self.target_pts[i+p, j+q, k+r]\n        def lerp(a, b, t): return a + t * (b - a)\n\n        c000 = get(0, 0, 0)\n        c100 = get(1, 0, 0)\n        c010 = get(0, 1, 0)\n        c110 = get(1, 1, 0)\n        c001 = get(0, 0, 1)\n        c101 = get(1, 0, 1)\n        c011 = get(0, 1, 1)\n        c111 = get(1, 1, 1)\n\n        x00 = lerp(c000, c100, dx)\n        x10 = lerp(c010, c110, dx)\n        x01 = lerp(c001, c101, dx)\n        x11 = lerp(c011, c111, dx)\n\n        y0 = lerp(x00, x10, dy)\n        y1 = lerp(x01, x11, dy)\n\n        final = lerp(y0, y1, dz)\n        return final\n\n    def morph(self, geom):\n        \"\"\"Apply morph on any geometry\"\"\"\n        class SimpleMorph(Rhino.Geometry.SpaceMorph):\n            def __init__(self, morph_fn):\n                super(SimpleMorph, self).__init__()\n                self._morph_fn = morph_fn\n\n            def MorphPoint(self, pt):\n                return self._morph_fn(pt)\n\n        smorph = SimpleMorph(self.morph_point)\n        geom_copy = geom.Duplicate()\n        smorph.Morph(geom_copy)\n        return geom_copy\n\n    def _get_normalized_position(self, pt):\n        bb_min = self.source_pts[0, 0, 0]\n        bb_max = self.source_pts[-1, -1, -1]\n\n        if not BoundingBox(bb_min, bb_max).Contains(pt):\n            return None\n\n        u = (pt.X - bb_min.X) / (bb_max.X - bb_min.X)\n        v = (pt.Y - bb_min.Y) / (bb_max.Y - bb_min.Y)\n        w = (pt.Z - bb_min.Z) / (bb_max.Z - bb_min.Z)\n\n        return (u, v, w)\n\ndef open_single_brep(filepath):\n    model = Rhino.FileIO.File3dm.Read(filepath)\n    for obj in model.Objects:\n        geo = obj.Geometry\n        if isinstance(geo, Brep):\n            return geo\n    raise ValueError(\"No polysurface found.\")\n\ndef generate_regular_grid(bbox, nx, ny, nz):\n    \"\"\"Create an evenly distributed grid in the bounding box\"\"\"\n    pts = []\n    for i in range(nx):\n        x = bbox.Min.X + i * (bbox.Max.X - bbox.Min.X) / (nx - 1)\n        for j in range(ny):\n            y = bbox.Min.Y + j * (bbox.Max.Y - bbox.Min.Y) / (ny - 1)\n            for k in range(nz):\n                z = bbox.Min.Z + k * (bbox.Max.Z - bbox.Min.Z) / (nz - 1)\n                pts.append(Point3d(x, y, z))\n    return pts\n\ndef morph_geometry_brep(brep, cage_morph):\n    brep_copy = brep.Duplicate()\n    all_meshes = []\n    for i in range(brep_copy.Faces.Count):\n        face = brep_copy.Faces[i]\n        mesh = Rhino.Geometry.Mesh.CreateFromBrep(face.DuplicateFace(False))[0]\n        for j in range(mesh.Vertices.Count):\n            pt = mesh.Vertices[j]\n            pt3d = Point3d(pt.X, pt.Y, pt.Z)\n            new_pt = cage_morph.morph_point(pt3d)\n            mesh.Vertices.SetVertex(j, new_pt)\n        mesh.Normals.ComputeNormals()\n        mesh.Compact()\n        all_meshes.append(mesh)\n    return all_meshes\n\ndef simple_deform(pt):\n    \"\"\"Deformation function : translation through z\"\"\"\n    dz = 100\n    return Point3d(pt.X, pt.Y, pt.Z + dz)\n\ndef apply_cage_morph(brep, nx, ny, nz):\n    bbox = brep.GetBoundingBox(True)\n    source_grid = generate_regular_grid(bbox, nx, ny, nz)\n    target_grid = [simple_deform(pt) for pt in source_grid]\n\n    morph = CageMorph(source_grid, target_grid, nx, ny, nz)\n    brep_def = morph_geometry_brep(brep, morph)\n    return brep_def\n\ndef save_breps(brep_original, brep_modifie, filepath_out):\n    model = Rhino.FileIO.File3dm()\n    model.Objects.AddBrep(brep_original)\n    for mesh in mesh_list:\n        model.Objects.AddMesh(mesh)\n    model.Write(filepath_out, 6)\n    print(f\"✅ Model saved : {filepath_out}\")\n\n\n\n# === Exemple d'utilisation ===\nif __name__ == \"__main__\":\n    try:\n        input_file = r\"To be modified\"\n        output_file = r\"To be modified\"\n\n        brep = open_single_brep(input_file)\n        mesh_list = apply_cage_morph(brep, nx=4, ny=4, nz=4)\n        save_breps(brep, mesh_list, output_file)\n\n    except Exception as e:\n        print(\"❌ Error :\", e)",
      "language": "python",
      "author": "Bellec",
      "post_number": 6,
      "is_solution": false
    },
    {
      "code": "# -*- coding: utf-8 -*-\nimport rhinoscriptsyntax as rs\nimport Rhino\nfrom Rhino import Geometry as rg\nimport scriptcontext as sc\nimport math as m\n\n# There is only one geometry in my .3dm file\nobjects = rs.AllObjects()\nif not objects:\n    print(\"No object found\")\nsurface_guid= objects[0] # Pick the one and only geometry\n\n# Select the surface\nrs.SelectObject(bateau_guid)\n# CageEdit set up\ncmd = '_CageEdit \\n _B \\n G \\n _Enter \\n _G \\n'\nrs.Command(cmd, echo=True)\ncage_ids=rs.LastCreatedObjects()\ncage_id=cage_ids[0]\n\nrh_obj = rs.coercerhinoobject(cage_id)\nif not rh_obj:\n    print(\"Impossible to convert the cage in rhicommon object\")\n    exit()\n# Step 5 : Enable grips\nrh_obj.GripsOn = True\n\n# Select grips\ngrips = rh_obj.GetGrips()\n# Move grips (example : vec(200,100,0))\nfor grip in grips:\n    grip.Move(Rhino.Geometry.Vector3d(200, 100, 0))",
      "language": "python",
      "author": "Bellec",
      "post_number": 1,
      "is_solution": false
    }
  ],
  "tags": [
    "file-io",
    "geometry",
    "grasshopper",
    "mesh",
    "python",
    "rhinocommon",
    "rhinoscriptsyntax",
    "transformation"
  ],
  "has_accepted_answer": true,
  "category_id": 11,
  "posts_count": 6,
  "views": 210
}