{
  "source_url": "https://github.com/CADacombs/rhinopython/blob/541b4ade49f1dda6a3861d12b9e2613405182082/spb_Brep_mergeAllEdges.py",
  "repo": "CADacombs/rhinopython",
  "repo_stars": 37,
  "repo_description": "Python scripts for Rhinoceros (Rhino, Rhino3D).",
  "license": "LGPL-3.0",
  "filepath": "spb_Brep_mergeAllEdges.py",
  "instruction": "Spb brep merge all edges",
  "code": "\"\"\"\r\n\"\"\"\r\n\r\n#! python 2  Must be on a line less than 32.\r\nfrom __future__ import absolute_import, division, print_function, unicode_literals\r\n\r\n\"\"\"\r\n171209: Created.\r\n...\r\n200202: Import-related update.\r\n200507: Updated for V6+ using new BrepEdgeList.MergeAllEdges method.  Import-related update.\r\n210221: Corrected printed feedback.\r\n210426: Import-related update.\r\n210630: Modified an option default value.\r\n250222: Import-related update.\r\n250225: Modified an option default value.\r\n250227: Modified an argument to an external function.\r\n\"\"\"\r\n\r\nimport Rhino\r\nimport Rhino.DocObjects as rd\r\nimport Rhino.Geometry as rg\r\nimport Rhino.Input as ri\r\nimport rhinoscriptsyntax as rs\r\nimport scriptcontext as sc\r\n\r\nfrom System import Guid\r\nfrom System.Collections.Generic import List\r\n\r\nimport xBrep_compact\r\nimport spb_Brep_rebuildEdges\r\n\r\n\r\nsOpts = (\r\n    'fAngleTol',\r\n    'bRebuildEdges',\r\n    'bRebuildOnlyOutOfTol',\r\n    'fRebuildEdgesTol',\r\n    'bRepeat',\r\n    'bEcho',\r\n    'bDebug',\r\n    )\r\n\r\n\r\nclass Opts():\r\n    \r\n    keys = []\r\n    values = {}\r\n    names = {}\r\n    riOpts = {}\r\n    stickyKeys = {}\r\n\r\n\r\n    key = 'fAngleTol'; keys.append(key)\r\n    values[key] = min((0.1, sc.doc.ModelAngleToleranceDegrees))\r\n    riOpts[key] = ri.Custom.OptionDouble(values[key])\r\n    stickyKeys[key] = '{}({})'.format(key, __file__)\r\n    \r\n    key = 'bRebuildEdges'; keys.append(key)\r\n    values[key] = True\r\n    riOpts[key] = ri.Custom.OptionToggle(values[key], 'No', 'Yes')\r\n    stickyKeys[key] = '{}({})'.format(key, __file__)\r\n    \r\n    key = 'bRebuildOnlyOutOfTol'; keys.append(key)\r\n    values[key] = True\r\n    riOpts[key] = ri.Custom.OptionToggle(values[key], 'No', 'Yes')\r\n    stickyKeys[key] = '{}({})'.format(key, __file__)\r\n    \r\n    key = 'fRebuildEdgesTol'; keys.append(key)\r\n    values[key] = 0.5 * sc.doc.ModelAbsoluteTolerance\r\n    riOpts[key] = ri.Custom.OptionDouble(values[key])\r\n    stickyKeys[key] = '{}({})({})'.format(key, __file__, sc.doc.Name)\r\n    \r\n    key = 'bRepeat'; keys.append(key)\r\n    values[key] = True\r\n    names[key] = 'RepeatMerge'\r\n    riOpts[key] = ri.Custom.OptionToggle(values[key], 'No', 'Yes')\r\n    stickyKeys[key] = '{}({})'.format(key, __file__)\r\n    \r\n    key = 'bEcho'; keys.append(key)\r\n    values[key] = True\r\n    riOpts[key] = ri.Custom.OptionToggle(values[key], 'No', 'Yes')\r\n    stickyKeys[key] = '{}({})'.format(key, __file__)\r\n    \r\n    key = 'bDebug'; keys.append(key)\r\n    values[key] = False\r\n    riOpts[key] = ri.Custom.OptionToggle(values[key], 'No', 'Yes')\r\n    stickyKeys[key] = '{}({})'.format(key, __file__)\r\n\r\n\r\n    for key in keys:\r\n        if key not in names:\r\n            names[key] = key[1:]\r\n\r\n\r\n    # Load sticky.\r\n    for key in stickyKeys:\r\n        if sc.sticky.has_key(stickyKeys[key]):\r\n            if riOpts[key]:\r\n                values[key] = riOpts[key].CurrentValue = sc.sticky[stickyKeys[key]]\r\n            else:\r\n                # For OptionList.\r\n                values[key] = sc.sticky[stickyKeys[key]]\r\n    \r\n    @classmethod\r\n    def saveSticky(cls):\r\n        for key in cls.stickyKeys:\r\n            if cls.riOpts[key]:\r\n                sc.sticky[cls.stickyKeys[key]] = cls.riOpts[key].CurrentValue\r\n            else:\r\n                # For OptionList.\r\n                sc.sticky[cls.stickyKeys[key]] = cls.values[key]\r\n\r\n\r\ndef getInput():\r\n    \r\n    go = ri.Custom.GetObject()\r\n    go.SetCommandPrompt(\"Select breps\")\r\n    \r\n    go.GeometryFilter = rd.ObjectType.Brep\r\n    go.SubObjectSelect = False\r\n    \r\n    go.AlreadySelectedObjectSelect = True\r\n    go.DeselectAllBeforePostSelect = False # So objects won't be deselected on repeats of While loop.\r\n    go.EnableClearObjectsOnEntry(False) # Do not clear objects in go on repeats of While loop.\r\n    go.EnableUnselectObjectsOnExit(False) # Do not unselect object when an option selected, a number is entered, etc.\r\n    \r\n    go.AcceptNumber(True, True)\r\n    \r\n    bPreselectedObjsChecked = False\r\n    \r\n    while True:\r\n        go.AddOptionDouble(Opts.names['fAngleTol'], Opts.riOpts['fAngleTol'])\r\n        go.AddOptionToggle(Opts.names['bRebuildEdges'], Opts.riOpts['bRebuildEdges'])\r\n        if Opts.riOpts['bRebuildEdges'].CurrentValue:\r\n            go.AddOptionToggle(Opts.names['bRebuildOnlyOutOfTol'], Opts.riOpts['bRebuildOnlyOutOfTol'])\r\n            go.AddOptionDouble(Opts.names['fRebuildEdgesTol'], Opts.riOpts['fRebuildEdgesTol'])\r\n            go.AddOptionToggle(Opts.names['bRepeat'], Opts.riOpts['bRepeat'])\r\n        go.AddOptionToggle(Opts.names['bEcho'], Opts.riOpts['bEcho'])\r\n        go.AddOptionToggle(Opts.names['bDebug'], Opts.riOpts['bDebug'])\r\n        \r\n        res = go.GetMultiple(minimumNumber=1, maximumNumber=0)\r\n        \r\n        # Use bPreselectedObjsChecked so that only objects before the\r\n        # first call to go.GetMultiple is considered.\r\n        if not bPreselectedObjsChecked and go.ObjectsWerePreselected:\r\n            bPreselectedObjsChecked = True\r\n            go.EnablePreSelect(False, ignoreUnacceptablePreselectedObjects=True)\r\n            continue\r\n        \r\n        if res == ri.GetResult.Object:\r\n            break\r\n        elif res == ri.GetResult.Cancel:\r\n            return\r\n        elif res == ri.GetResult.Number:\r\n            Opts.riOpts['fAngleTol'].CurrentValue = abs(go.Number())\r\n        \r\n        for key in 'fRebuildEdgesTol', 'fAngleTol':\r\n            if Opts.riOpts[key].CurrentValue < 0.0:\r\n                Opts.riOpts[key].CurrentValue = Opts.riOpts[key].InitialValue\r\n        \r\n        for key in Opts.stickyKeys:\r\n            if Opts.riOpts[key]:\r\n                Opts.values[key] = Opts.riOpts[key].CurrentValue\r\n            else:\r\n                # For OptionList.\r\n                pass\r\n        \r\n        Opts.saveSticky()\r\n        \r\n        go.ClearCommandOptions()\r\n    \r\n    gBreps = [objref.ObjectId for objref in go.Objects()]\r\n    go.Dispose()\r\n    \r\n    return (\r\n            gBreps,\r\n            Opts.values['fAngleTol'],\r\n            Opts.values['bRebuildEdges'],\r\n            Opts.values['bRebuildOnlyOutOfTol'],\r\n            Opts.values['fRebuildEdgesTol'],\r\n            Opts.values['bRepeat'],\r\n            Opts.values['bEcho'],\r\n            Opts.values['bDebug'],\r\n    )\r\n\r\n\r\ndef edgeCount_All(gBreps):\r\n    if isinstance(gBreps, Guid):\r\n        gBreps = [gBreps]\r\n    count = 0\r\n    for gBrep in gBreps:\r\n        rgBrep = rs.coercebrep(gBrep)\r\n        count += rgBrep.Edges.Count\r\n        rgBrep.Dispose()\r\n    return count\r\n\r\n\r\ndef edgeCount_Naked(gBreps):\r\n    if isinstance(gBreps, Guid):\r\n        gBreps = [gBreps]\r\n    count = 0\r\n    for gBrep in gBreps:\r\n        rgBrep = rs.coercebrep(gBrep)\r\n        for rgEdge in rgBrep.Edges:\r\n            if rgEdge.Valence == rg.EdgeAdjacency.Naked:\r\n                count += 1\r\n        rgBrep.Dispose()\r\n    return count\r\n\r\n\r\ndef mergeEdges_V5(gBreps, fAngleTol=None):\r\n    \"\"\"\r\n    Returns: Boolean based on whether any edges were merged.\r\n    \"\"\"\r\n    if fAngleTol is None: fAngleTol = Opts.values['fAngleTol']\r\n    \r\n    cts_Edges0 = []\r\n    for gBrep in gBreps:\r\n        if sc.escape_test(throw_exception=False, reset=False):\r\n            print(\"Break in edges count.\")\r\n            break\r\n        cts_Edges0.append(edgeCount_All(gBrep))\r\n    \r\n    sc.doc.Objects.UnselectAll()\r\n    for gBrep in gBreps: sc.doc.Objects.Select(gBrep)\r\n    \r\n    Rhino.RhinoApp.SetCommandPrompt(\"Merging ...\")\r\n    \r\n    fAngleTol0 = sc.doc.ModelAngleToleranceDegrees\r\n    sc.doc.ModelAngleToleranceDegrees = fAngleTol\r\n    \r\n    rs.Command(\"_MergeAllEdges\", echo=False)\r\n    \r\n    sc.doc.ModelAngleToleranceDegrees = fAngleTol0\r\n    \r\n    sc.doc.Objects.UnselectAll()\r\n    \r\n    cts_Edges1 = []\r\n    for gBrep in gBreps:\r\n        if sc.escape_test(throw_exception=False, reset=False):\r\n            print(\"Break in edges count.\")\r\n            break\r\n        cts_Edges1.append(edgeCount_All(gBrep))\r\n    \r\n    gBreps_WithEdgesMerged = []\r\n    for gBrep, ct_Edges0, ct_Edges1 in zip(gBreps, cts_Edges0, cts_Edges1):\r\n        if ct_Edges1 < ct_Edges0:\r\n            gBreps_WithEdgesMerged.append(gBrep)\r\n    \r\n    return gBreps_WithEdgesMerged\r\n\r\n\r\ndef mergeEdges(gBreps, fAngleTol=None):\r\n    \"\"\"\r\n    Returns: Boolean based on whether any edges were merged.\r\n    \"\"\"\r\n    if fAngleTol is None: fAngleTol = Opts.values['fAngleTol']\r\n    \r\n    fAngleTol_Rad = Rhino.RhinoMath.ToRadians(fAngleTol)\r\n    \r\n    Rhino.RhinoApp.SetCommandPrompt(\"Merging ...\")\r\n    \r\n    gBreps_WithEdgesMerged = []\r\n    \r\n    for gBrep in gBreps:\r\n        if sc.escape_test(throw_exception=False, reset=False):\r\n            print(\"Break in edges count.\")\r\n            break\r\n        \r\n        rgB_In = rs.coercebrep(gBrep)\r\n        \r\n        rgB_Out = rgB_In.Duplicate()\r\n        \r\n        iCt_Edges_beforeMergeAll = rgB_In.Edges.Count\r\n        \r\n        rgB_Out.Edges.MergeAllEdges(angleTolerance=fAngleTol_Rad)\r\n        \r\n        iCt_Edges_afterMergeAll = rgB_Out.Edges.Count\r\n        \r\n        if iCt_Edges_beforeMergeAll == iCt_Edges_afterMergeAll:\r\n            rgB_Out.Dispose()\r\n            continue\r\n        \r\n        sc.doc.Objects.Replace(objectId=gBrep, brep=rgB_Out)\r\n        \r\n        gBreps_WithEdgesMerged.append(gBrep)\r\n    \r\n    return gBreps_WithEdgesMerged\r\n\r\n\r\ndef createEdgeCountReport(nEdges0, nNakedEdges0, nEdges1, nNakedEdges1, nBreps, sPrefix=''):\r\n    s  = \"{}Edge count reduced by {} ({}->{})\".format(\r\n            sPrefix, nEdges0 - nEdges1, nEdges0, nEdges1)\r\n    s += \"  ({}Naked edge count reduced by {} ({}->{}))\".format(\r\n            sPrefix, nNakedEdges0 - nNakedEdges1, nNakedEdges0, nNakedEdges1)\r\n    s += \" in {} brep(s).\".format(nBreps)\r\n    return s\r\n\r\n\r\ndef processBrepObjects(gBreps, fAngleTol=None, bRebuildEdges=None, bRebuildOnlyOutOfTol=None, fRebuildEdgesTol=None, bRepeat=None, bEcho=None, bDebug=None):\r\n    \"\"\"For faster processing, all brep objects will be modified by _MergeAllEdges at once.\r\n    They will also be sent in plural to spb_Brep_rebuildEdges.processBreps .\r\n    \"\"\"\r\n    \r\n    if fAngleTol is None: fAngleTol = Opts.values['fAngleTol']\r\n    if bRebuildEdges is None: bRebuildEdges = Opts.values['bRebuildEdges']\r\n    if bRebuildOnlyOutOfTol is None: bRebuildOnlyOutOfTol = Opts.values['bRebuildOnlyOutOfTol']\r\n    if fRebuildEdgesTol is None: fRebuildEdgesTol = Opts.values['fRebuildEdgesTol']\r\n    if bRepeat is None: bRepeat = Opts.values['bRepeat']\r\n    if bEcho is None: bEcho = Opts.values['bEcho']\r\n    if bDebug is None: bDebug = Opts.values['bDebug']\r\n    \r\n    iPrec = sc.doc.ModelDistanceDisplayPrecision\r\n    s = \"Merge angle tolerance: {0:.{1}f} degrees.\".format(\r\n            fAngleTol, (12, iPrec)[0.1**iPrec<fAngleTol])\r\n            # Output at 12 decimal places if tolerance is < precision display decimals.\r\n    if bRebuildEdges:\r\n        s += \"  Rebuild edges: {0:.{1}f}.\".format(\r\n                fRebuildEdgesTol, (12, iPrec)[0.1**iPrec<fRebuildEdgesTol])\r\n                # Output at 12 decimal places if tolerance is < precision display decimals.\r\n        s += \"  RebuildOnlyOutOfTol: {}\".format(bRebuildOnlyOutOfTol)\r\n    else:\r\n        s += \"  Edges will not be rebuilt.\"\r\n    print(s)\r\n    \r\n    Rhino.RhinoApp.SetCommandPrompt(prompt=\"Recording starting edge counts ...\")\r\n    nEdges0 = edgeCount_All(gBreps)\r\n    nNakedEdges0 = edgeCount_Naked(gBreps)\r\n    \r\n    iStep = 1\r\n    \r\n    if bRebuildEdges and bRepeat:\r\n        print(\"STEP {}: 1st merging of edges\".format(iStep))\r\n    #else:\r\n    #    s = \"Merging edges\"\r\n    \r\n    gBreps_WithEdgesMerged = mergeEdges(gBreps, fAngleTol)\r\n\r\n    if not gBreps_WithEdgesMerged:\r\n        print(\"None of the {} edges / {} naked edges were merged.\".format(\r\n                nEdges0, nNakedEdges0))\r\n        nEdges1 = nEdges0\r\n        nNakedEdges1 = nNakedEdges0\r\n    else:\r\n        Rhino.RhinoApp.SetCommandPrompt(prompt=\"Recording edge counts ...\")\r\n        nEdges1 = edgeCount_All(gBreps)\r\n        nNakedEdges1 = edgeCount_Naked(gBreps)\r\n        \r\n        print(createEdgeCountReport(nEdges0, nNakedEdges0, nEdges1, nNakedEdges1, len(gBreps)))\r\n    \r\n    if not bRebuildEdges:\r\n        return\r\n    \r\n    iStep = 2\r\n    \r\n    if bRepeat:\r\n        print(\"STEP {}: 1st rebuilding of edges\".format(iStep))\r\n    else:\r\n        print(\"Rebuilding edges\")\r\n    Rhino.RhinoApp.SetCommandPrompt(prompt=s+' ...')\r\n    \r\n    sc.doc.Objects.UnselectAll()\r\n    gBreps_EdgesRebuilt = spb_Brep_rebuildEdges.processBrepObjects(\r\n            gBreps,\r\n            fRebuildNakedTol=fRebuildEdgesTol,\r\n            fSearchTol=fRebuildEdgesTol,\r\n            bRebuildOnlyOutOfTol=bRebuildOnlyOutOfTol,\r\n            bRebuildSharedEdges=True,\r\n            bRebuildVertices=True,\r\n            bReplace=True,\r\n            bDot=False,\r\n            iDotHeight=None,\r\n            bEcho=True,\r\n            bDebug=bDebug\r\n    )\r\n\r\n    if gBreps_EdgesRebuilt:\r\n        print(\"  {} of {} breps have had their edges rebuilt.\".format(\r\n            len(gBreps_EdgesRebuilt), len(gBreps)))\r\n    else:\r\n        print(\"  No edges were rebuilt, so breps will not be further processed.\")\r\n        bRepeat = False\r\n    \r\n    if not bRepeat:\r\n        return\r\n    \r\n    iStep = 3\r\n    \r\n    s = \"STEP {}: 2nd merging of edges\".format(iStep)\r\n    Rhino.RhinoApp.SetCommandPrompt(prompt=s+' ...')\r\n    \r\n    gBreps_WithEdgesMerged = mergeEdges(gBreps, fAngleTol)\r\n    print(s)\r\n    if not gBreps_WithEdgesMerged:\r\n        print(\"None of the {} edges / {} naked edges were merged.\".format(\r\n                nEdges1, nNakedEdges1))\r\n        nEdges2 = nEdges1\r\n        nNakedEdges2 = nNakedEdges1\r\n        print(\"Rebuilding edges not repeated because no edges were merged after the previous rebuild.\")\r\n    else:\r\n        iStep = 4\r\n        \r\n        Rhino.RhinoApp.SetCommandPrompt(prompt=\"Recording ending edge counts ...\")\r\n        nEdges2 = edgeCount_All(gBreps)\r\n        nNakedEdges2 = edgeCount_Naked(gBreps)\r\n        \r\n        print(\r\n            createEdgeCountReport(\r\n                nEdges1, nNakedEdges1, nEdges2, nNakedEdges2, len(gBreps))\r\n            )\r\n        \r\n        # 2nd Rebuild edges.\r\n        s = \"STEP {}: 2nd rebuilding of edges\".format(iStep)\r\n        Rhino.RhinoApp.SetCommandPrompt(prompt=s+' ...')\r\n        \r\n        sc.doc.Objects.UnselectAll()\r\n        gBreps_EdgesRebuilt = spb_Brep_rebuildEdges.processBrepObjects(\r\n                gBreps,\r\n                fRebuildNakedTol=fRebuildEdgesTol,\r\n                fSearchTol=fRebuildEdgesTol,\r\n                bRebuildOnlyOutOfTol=bRebuildOnlyOutOfTol,\r\n                bRebuildSharedEdges=True,\r\n                bRebuildVertices=True,\r\n                bReplace=True,\r\n                bDot=False,\r\n                iDotHeight=None,\r\n                bEcho=True,\r\n                bDebug=bDebug\r\n        )\r\n        print(s)\r\n        if gBreps_EdgesRebuilt:\r\n            print(\"{} of {} breps have had their edges rebuilt.\".format(\r\n                len(gBreps_EdgesRebuilt), len(gBreps)))\r\n        else:\r\n            print(\"No edges were rebuilt.\")\r\n    \r\n    xBrep_compact.processBrepObjects(gBreps, bEcho=False, bDebug=bDebug)\r\n    \r\n    print(\r\n        createEdgeCountReport(\r\n            nEdges0, nNakedEdges0, nEdges2, nNakedEdges2, len(gBreps), sPrefix=\"Total \")\r\n        )\r\n\r\n\r\ndef main():\r\n    \"\"\"\r\n    \"\"\"\r\n    \r\n    gBreps_Preselected = rs.SelectedObjects()\r\n    \r\n    rc = getInput()\r\n    if rc is None: return\r\n    (\r\n        gBreps0,\r\n        fAngleTol,\r\n        bRebuildEdges,\r\n        bRebuildOnlyOutOfTol,\r\n        fRebuildEdgesTol,\r\n        bRepeat,\r\n        bEcho,\r\n        bDebug,\r\n    ) = rc\r\n    \r\n    Rhino.RhinoApp.SetCommandPrompt(prompt=\"Working ...\")\r\n\r\n\r\n    if not bDebug:\r\n        sc.doc.Views.RedrawEnabled = False\r\n\r\n\r\n    processBrepObjects(\r\n            gBreps0,\r\n            fAngleTol=fAngleTol,\r\n            bRebuildEdges=bRebuildEdges,\r\n            bRebuildOnlyOutOfTol=bRebuildOnlyOutOfTol,\r\n            fRebuildEdgesTol=fRebuildEdgesTol,\r\n            bRepeat=bRepeat,\r\n            bEcho=bEcho,\r\n            bDebug=bDebug,\r\n    )\r\n    \r\n    if gBreps_Preselected: rs.SelectObjects(gBreps_Preselected)\r\n    \r\n    sc.doc.Views.RedrawEnabled = True\r\n\r\n\r\nif __name__ == '__main__': main()",
  "language": "python",
  "imports": [
    "Rhino",
    "Rhino.Geometry",
    "rhinoscriptsyntax",
    "scriptcontext"
  ],
  "has_docstring": false
}