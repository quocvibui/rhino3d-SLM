{
  "source_url": "https://github.com/gramaziokohler/integral_timber_joints/blob/d543a28ccfaeb8a56ff692a29d5510c3e649477f/src/integral_timber_joints/rhino/sequence.py",
  "repo": "gramaziokohler/integral_timber_joints",
  "repo_stars": 11,
  "repo_description": "Robotic Assembled Timber Structures with Integral Timber Joints",
  "license": "MIT",
  "filepath": "src/integral_timber_joints/rhino/sequence.py",
  "instruction": "Sequence",
  "code": "import Rhino  # type: ignore\nimport rhinoscriptsyntax as rs\nfrom compas_rhino.utilities.objects import get_object_name\n\nfrom integral_timber_joints.assembly import Assembly\nfrom integral_timber_joints.process import RobotClampAssemblyProcess\nfrom integral_timber_joints.rhino.load import get_process, get_process_artist, process_is_none\nfrom integral_timber_joints.rhino.utility import get_existing_beams_filter, recompute_dependent_solutions\nfrom integral_timber_joints.geometry import JointNonPlanarLap\n\n\ndef show_sequence_color(process, beam_id):\n    # type: (RobotClampAssemblyProcess, str) -> None\n    rs.EnableRedraw(False)\n    artist = get_process_artist()\n    assembly = process.assembly  # type: Assembly\n    selected_seq_num = assembly.get_beam_sequence(beam_id)\n    for seq, beam_id in enumerate(assembly.sequence):\n        # Change color based on problems\n        problem = assembly.beam_problems(beam_id)\n        if seq == selected_seq_num and not problem:\n            artist.change_interactive_beam_colour(beam_id, 'active')\n        if seq == selected_seq_num and problem:\n            artist.change_interactive_beam_colour(beam_id, 'error')\n        if seq < selected_seq_num and not problem:\n            artist.change_interactive_beam_colour(beam_id, 'built')\n        if seq < selected_seq_num and problem:\n            artist.change_interactive_beam_colour(beam_id, 'built_warning')\n        if seq > selected_seq_num and not problem:\n            artist.change_interactive_beam_colour(beam_id, 'unbuilt')\n        if seq > selected_seq_num and problem:\n            artist.change_interactive_beam_colour(beam_id, 'unbuilt_warning')\n        # Hide unbuilt beams if settings show_unbuilt == False\n        if seq > selected_seq_num and (getattr(artist, \"show_unbuilt\", True) == False):\n            artist.hide_interactive_beam(beam_id)\n        else:\n            artist.show_interactive_beam(beam_id)\n        # print out for debug\n        if problem:\n            print(beam_id, problem)\n    rs.EnableRedraw(True)\n\n\ndef show_normal_color_and_unhide(process):\n    artist = get_process_artist()\n    assembly = process.assembly  # type: Assembly\n    rs.EnableRedraw(False)\n    for beam_id in assembly.sequence:\n        artist.change_interactive_beam_colour(beam_id, 'normal')\n        artist.show_interactive_beam(beam_id)\n    rs.EnableRedraw(True)\n\n\ndef show_menu(process):\n    # type: (RobotClampAssemblyProcess) -> None\n    assembly = process.assembly  # type: Assembly\n    artist = get_process_artist()\n\n    artist.selected_beam_id = None\n\n    go = Rhino.Input.Custom.GetObject()\n    go.SetCommandPrompt(\"Select beam\")\n    go.EnablePreSelect(True, True)\n\n    def select_next():\n        \"\"\" Function invoked by user to change active element to the next one.\n        \"\"\"\n        selected_seq_num = assembly.get_beam_sequence(artist.selected_beam_id)\n        selected_seq_num = min(selected_seq_num + 1,  len(assembly.sequence) - 1)\n        artist.selected_beam_id = assembly.sequence[selected_seq_num]\n        show_sequence_color(process, artist.selected_beam_id)\n        go.SetDefaultString(\"Enter again = Next\")\n\n    def select_previous():\n        \"\"\" Function invoked by user to change active element to the previous one.\n        \"\"\"\n        selected_seq_num = assembly.get_beam_sequence(artist.selected_beam_id)\n        selected_seq_num = max(selected_seq_num - 1,  0)\n        artist.selected_beam_id = assembly.sequence[selected_seq_num]\n        show_sequence_color(process, artist.selected_beam_id)\n        go.SetDefaultString(\"Enter again = Previous\")\n\n    def move_earlier():\n        \"\"\" Function invoked by user to move the active element's sequence one step earrlier.\n        \"\"\"\n        if assembly.get_beam_sequence(artist.selected_beam_id) == 0:\n            return\n        member_seq_affected_by_swap = assembly.shift_beam_sequence(artist.selected_beam_id, -1)\n        [process.dependency.invalidate_all(beam_id) for beam_id in member_seq_affected_by_swap]\n        [artist.redraw_interactive_beam(beam_id, force_update=True, redraw=False) for beam_id in member_seq_affected_by_swap]\n        show_sequence_color(process, artist.selected_beam_id)\n        rs.EnableRedraw(True)\n        go.SetDefaultString(\"Enter again = MoveEarlier\")\n\n    def move_later():\n        \"\"\" Function invoked by user to move the active element's sequence one step later.\n        \"\"\"\n        if assembly.get_beam_sequence(artist.selected_beam_id) == len(assembly.sequence) - 1:\n            return\n        member_seq_affected_by_swap = assembly.shift_beam_sequence(artist.selected_beam_id, +1)\n        [process.dependency.invalidate_all(beam_id) for beam_id in member_seq_affected_by_swap]\n        [artist.redraw_interactive_beam(beam_id, force_update=True, redraw=False) for beam_id in member_seq_affected_by_swap]\n        show_sequence_color(process, artist.selected_beam_id)\n        rs.EnableRedraw(True)\n        go.SetDefaultString(\"Enter again = MoveLater\")\n\n    def change_next_element():\n        \"\"\" Function invoked by user to select an element and move that sequence\n        to after the the active element's.\n        \"\"\"\n        original_seq = assembly.get_beam_sequence(artist.selected_beam_id)\n        # Ask user for another beam\n        go2 = Rhino.Input.Custom.GetObject()\n        go2.SetCommandPrompt(\"Select beam to be the next element in sequence\")\n        go2.EnablePreSelect(False, False)\n        go2.SetCustomGeometryFilter(get_existing_beams_filter(process, exclude_beam_ids=[artist.selected_beam_id]))\n        result = go2.Get()\n        if result == Rhino.Input.GetResult.Object:\n            guid = go2.Object(0).ObjectId\n            beam_id = get_object_name(guid)\n            picked_seq = assembly.get_beam_sequence(beam_id)\n            shift = original_seq - picked_seq\n            if shift < 0:\n                shift = shift + 1\n            member_seq_affected_by_swap = assembly.shift_beam_sequence(beam_id, shift)\n            artist.selected_beam_id = beam_id\n            [process.dependency.invalidate_all(beam_id) for beam_id in member_seq_affected_by_swap]\n            [artist.redraw_interactive_beam(beam_id, force_update=True, redraw=False) for beam_id in member_seq_affected_by_swap]\n            show_sequence_color(process, artist.selected_beam_id)\n            rs.EnableRedraw(True)\n        go.SetDefaultString(\"Enter again = ChangeElementAfterThis\")\n\n    def change_assembly_method():\n        from integral_timber_joints.rhino.assembly import ui_change_assembly_method\n        ui_change_assembly_method(process, [artist.selected_beam_id])\n        show_sequence_color(process, artist.selected_beam_id)\n        rs.EnableRedraw(True)\n        go.SetDefaultString(\"Enter again = ChangeAssemblyMethod\")\n\n    def ui_flip_beams():\n        # type: () -> None\n        '''Ask User to select a beam for flipping the joints' direction\n        Only joints to earlier beams are flipped.\n\n        Beams with non planar joints cannot be flipped.\n\n        THis functions repeats until users press Enter without selecting beam.\n        '''\n        beam_id = artist.selected_beam_id\n\n        # * Check if any of its joints to previous beams are non planar.\n        for joint_id in process.assembly.get_joints_of_beam_connected_to_already_built(beam_id):\n            if isinstance(process.assembly.joint(joint_id), JointNonPlanarLap):\n                print(\"Sorry. Cannot flip beams with non planar joints. Offending joint: %s-%s\" % joint_id)\n                continue\n\n        # * Loop though alread_built_neighbors and swap joint\n        earlier_neighbors = assembly.get_already_built_neighbors(beam_id)\n        for neighbour_id in earlier_neighbors:\n            joint_id = (beam_id, neighbour_id)\n            assembly.flip_lap_joint(joint_id)\n\n        # * Update drownstream computation\n        assembly.set_beam_attribute(beam_id, 'assembly_wcf_final', None)\n        recompute_dependent_solutions(process, beam_id)\n\n        # * Update visualization of flipped beam and neighbors\n        for _beam_id in earlier_neighbors + [beam_id]:\n            artist.redraw_interactive_beam(_beam_id, force_update=True, redraw=False)\n        show_sequence_color(process, beam_id)\n        rs.EnableRedraw(True)\n        print('Beam flipped: %s (Neighbours: %s)' % (beam_id, earlier_neighbors))\n        go.SetDefaultString(\"Enter again = Flip Again\")\n\n    def display_show_unbuilt():\n        \"\"\" Function invoked by user to set displaysettings\n        \"\"\"\n        artist.show_unbuilt = True\n        show_sequence_color(process, artist.selected_beam_id)\n\n    def display_hide_unbuilt():\n        \"\"\" Function invoked by user to set displaysettings\n        \"\"\"\n        artist.show_unbuilt = False\n        show_sequence_color(process, artist.selected_beam_id)\n\n    run_cmd = None  # Variable to remember the last command to allow easy rerun.\n    while(True):\n        go.SetCustomGeometryFilter(get_existing_beams_filter(process))\n        result = go.Get()\n        # print (result)\n\n        # Performs function on the previously selected beam\n        if result == Rhino.Input.GetResult.Option:\n            if go.Option().EnglishName == \"Finish\":\n                show_normal_color_and_unhide(process)\n                return Rhino.Commands.Result.Cancel\n\n            if go.Option().EnglishName == \"Next\":\n                run_cmd = select_next\n\n            if go.Option().EnglishName == \"Previous\":\n                run_cmd = select_previous\n\n            if go.Option().EnglishName == \"MoveEarlier\":\n                run_cmd = move_earlier\n\n            if go.Option().EnglishName == \"MoveLater\":\n                run_cmd = move_later\n\n            if go.Option().EnglishName == \"FlipAssemblyDirection\":\n                run_cmd = ui_flip_beams\n\n            if go.Option().EnglishName == \"PickElementToGoAfterThis\":\n                run_cmd = change_next_element\n\n            if go.Option().EnglishName == \"ChangeAssemblyMethod\":\n                run_cmd = change_assembly_method\n\n            if go.Option().EnglishName == \"DisplayShowUnbuilt\":\n                run_cmd = display_show_unbuilt\n\n            if go.Option().EnglishName == \"DisplayHideUnbuilt\":\n                run_cmd = display_hide_unbuilt\n\n            run_cmd()\n\n        elif result == Rhino.Input.GetResult.Cancel:\n            # Cancels the color preview and exit function\n            show_normal_color_and_unhide(process)\n            return Rhino.Commands.Result.Cancel\n\n        elif result != Rhino.Input.GetResult.Object:\n            # Repeat last command\n            run_cmd()\n\n        else:\n            # User clicked on a beam.\n            # Show color preview of the sequence at that point\n            guid = go.Object(0).ObjectId\n            beam_id = get_object_name(guid)\n            show_sequence_color(process, beam_id)\n\n            # Unselect obejcts, otherwwise the function will loop infiniitely\n            rs.UnselectAllObjects()\n\n            # In the first run where user selected an active beam, the optinos are added\n            if artist.selected_beam_id is None:\n                go.AddOption(\"Next\")\n                go.AddOption(\"Previous\")\n                go.AddOption(\"MoveEarlier\")\n                go.AddOption(\"MoveLater\")\n                go.AddOption(\"FlipAssemblyDirection\")\n                go.AddOption(\"PickElementToGoAfterThis\")\n                go.AddOption(\"ChangeAssemblyMethod\")\n                go.AddOption(\"DisplayShowUnbuilt\")\n                go.AddOption(\"DisplayHideUnbuilt\")\n                go.AddOption(\"Finish\")\n            artist.selected_beam_id = beam_id\n\n        print(\"Currently showing Beam %i of %i (%s)\" % (assembly.get_beam_sequence(artist.selected_beam_id) + 1, len(assembly.sequence), artist.selected_beam_id))\n\n######################\n# Rhino Entry Point\n######################\n# Below is the functions that get evoked when user press UI Button\n# Put this in the Rhino button ! _-RunPythonScript 'integral_timber_joints.rhino.sequence.py'\n\n\nif __name__ == '__main__':\n    process = get_process()\n    if process_is_none(process):\n        print(\"Load json first\")\n    else:\n        show_menu(process)\n",
  "language": "python",
  "imports": [
    "Rhino",
    "rhinoscriptsyntax"
  ],
  "has_docstring": false
}