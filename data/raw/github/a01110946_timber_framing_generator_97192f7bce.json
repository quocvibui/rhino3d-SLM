{
  "source_url": "https://github.com/a01110946/timber_framing_generator/blob/0b689e23c0ee24a9cfbdf280b219f659a54afd43/src/timber_framing_generator/utils/safe_rhino.py",
  "repo": "a01110946/timber_framing_generator",
  "repo_stars": 3,
  "repo_description": "A Python tool bridging Revit and Rhino through Rhino.Inside.Revit to automate timber frame design. Processes Revit walls to generate complete framing solutions including studs, plates, headers, and cripples. Features intelligent wall decomposition, opening analysis, and automated documentation generation.",
  "license": "unknown",
  "filepath": "src/timber_framing_generator/utils/safe_rhino.py",
  "instruction": "File: src/timber_framing_generator/utils/safe_rhino.py",
  "code": "# File: src/timber_framing_generator/utils/safe_rhino.py\n\nimport Rhino.Geometry as rg\nfrom src.timber_framing_generator.utils.geometry_helpers import (\n    curve_length, curve_closest_point, create_extrusion, create_simple_extrusion\n)\n\ndef safe_get_length(curve):\n    \"\"\"Safely get the length of any curve type.\"\"\"\n    try:\n        return curve.GetLength()\n    except AttributeError:\n        return curve_length(curve)\n\ndef safe_closest_point(curve, point):\n    \"\"\"Safely get the closest point on any curve type.\"\"\"\n    try:\n        return curve.ClosestPoint(point)\n    except AttributeError:\n        return curve_closest_point(curve, point)\n\ndef safe_create_extrusion(profile, vector):\n    \"\"\"Safely create extrusion geometry.\"\"\"\n    try:\n        # Try standard method\n        if hasattr(rg.Extrusion, 'CreateExtrusion'):\n            extrusion = rg.Extrusion.CreateExtrusion(profile, vector)\n            if extrusion and extrusion.IsValid:\n                return extrusion.ToBrep()\n    except:\n        pass\n        \n    # Fallback to simplified geometry\n    return create_simple_extrusion(profile, vector)\n\ndef safe_get_bounding_box(geometry_object, accurate=True):\n    \"\"\"\n    Safely get the bounding box of any geometry object.\n    \n    Args:\n        geometry_object: Any Rhino geometry object\n        accurate: Whether to compute an accurate bounding box\n        \n    Returns:\n        rg.BoundingBox: The bounding box of the object, or an empty box if one cannot be computed\n    \"\"\"\n    try:\n        # Try direct method first\n        if hasattr(geometry_object, 'GetBoundingBox'):\n            return geometry_object.GetBoundingBox(accurate)\n            \n        # For objects with control points (like curves)\n        if hasattr(geometry_object, 'Points'):\n            bbox = rg.BoundingBox.Empty\n            for point in geometry_object.Points:\n                if hasattr(point, 'Location'):\n                    bbox.Union(point.Location)\n                elif hasattr(point, 'X') and hasattr(point, 'Y') and hasattr(point, 'Z'):\n                    bbox.Union(rg.Point3d(point.X, point.Y, point.Z))\n            return bbox\n            \n        # For line curves\n        if hasattr(geometry_object, 'PointAtStart') and hasattr(geometry_object, 'PointAtEnd'):\n            bbox = rg.BoundingBox.Empty\n            bbox.Union(geometry_object.PointAtStart)\n            bbox.Union(geometry_object.PointAtEnd)\n            return bbox\n            \n        # For other geometry, try to get extreme points\n        if hasattr(geometry_object, 'GetBoundingBox'):\n            return geometry_object.GetBoundingBox(accurate)\n            \n    except Exception as e:\n        from ..utils.logging_config import get_logger\n        logger = get_logger(__name__)\n        logger.warning(f\"Error getting bounding box: {str(e)}\")\n        \n    # Return empty box if all methods fail\n    return rg.BoundingBox.Empty\n\ndef safe_add_brep(brep_object):\n    \"\"\"\n    Safely convert an object to Brep if needed.\n    \n    This function handles various object types and tries multiple approaches\n    to return a valid Brep, including direct casting and conversion methods.\n    \"\"\"\n    if brep_object is None:\n        return None\n    \n    from ..utils.logging_config import get_logger\n    logger = get_logger(__name__)\n    \n    try:\n        # Case 1: Already a Brep - just return it\n        if isinstance(brep_object, rg.Brep):\n            return brep_object\n            \n        # Case 2: It's an Extrusion - convert to Brep\n        if isinstance(brep_object, rg.Extrusion):\n            return brep_object.ToBrep()\n            \n        # Case 3: It's a Curve - try to create a surface\n        if isinstance(brep_object, rg.Curve):\n            try:\n                # Try to create a surface if it's a closed curve\n                if brep_object.IsClosed:\n                    surface = rg.Brep.CreatePlanarBreps(brep_object)\n                    if surface and len(surface) > 0:\n                        return surface[0]\n            except Exception as e:\n                logger.warning(f\"Failed to create surface from curve: {str(e)}\")\n        \n        # Case 4: It has a ToBrep method - use it\n        if hasattr(brep_object, 'ToBrep') and callable(getattr(brep_object, 'ToBrep')):\n            try:\n                return brep_object.ToBrep()\n            except Exception as e:\n                logger.warning(f\"ToBrep method failed: {str(e)}\")\n        \n        # Case 5: Has an ExternalBoundary property (like Surface)\n        if hasattr(brep_object, 'ToBrep') == False and hasattr(brep_object, 'IsSurface') and brep_object.IsSurface:\n            try:\n                return rg.Brep.CreateFromSurface(brep_object)\n            except Exception as e:\n                logger.warning(f\"Failed to create Brep from surface: {str(e)}\")\n        \n        # Case 6: Unknown type - log and return None\n        logger.warning(f\"Cannot convert {type(brep_object)} to Brep - no conversion method available\")\n        return brep_object  # Return the original object as a fallback\n        \n    except Exception as e:\n        logger.warning(f\"Error in safe_add_brep: {str(e)}\")\n        return brep_object  # Return the original object as a last resort\n\ndef is_valid_geometry(geom_obj):\n    \"\"\"Check if a geometry object is valid.\"\"\"\n    if geom_obj is None:\n        return False\n\n    try:\n        if hasattr(geom_obj, 'IsValid'):\n            return geom_obj.IsValid\n        return True  # If no IsValid property, assume it's valid\n    except:\n        return False\n\n\ndef safe_to_brep_if_needed(geometry_object):\n    \"\"\"\n    Convert geometry to Brep only if needed.\n\n    If the object is already a Brep, returns it directly without calling ToBrep().\n    If it has a ToBrep() method (like Extrusion), calls it.\n    Otherwise returns None.\n\n    This function prevents the common error of calling .ToBrep() on an object\n    that is already a Brep (which raises \"Brep object has no attribute ToBrep\").\n\n    Args:\n        geometry_object: Rhino geometry object (Brep, Extrusion, Box, etc.)\n\n    Returns:\n        rg.Brep: Valid Brep object, or None if conversion failed\n\n    Example:\n        result = safe_create_extrusion(profile, direction)  # May return Brep or Extrusion\n        brep = safe_to_brep_if_needed(result)  # Safely converts to Brep\n    \"\"\"\n    if geometry_object is None:\n        return None\n\n    from ..utils.logging_config import get_logger\n    logger = get_logger(__name__)\n\n    try:\n        # Case 1: Already a Brep - return as-is (most common case)\n        if isinstance(geometry_object, rg.Brep):\n            if geometry_object.IsValid:\n                return geometry_object\n            else:\n                logger.warning(\"Brep object is invalid\")\n                return None\n\n        # Case 2: Has ToBrep method (Extrusion, Box, etc.) - use it\n        if hasattr(geometry_object, 'ToBrep') and callable(getattr(geometry_object, 'ToBrep')):\n            try:\n                brep = geometry_object.ToBrep()\n                if brep is not None and brep.IsValid:\n                    return brep\n                else:\n                    logger.warning(f\"ToBrep() returned invalid result for {type(geometry_object)}\")\n            except Exception as e:\n                logger.warning(f\"ToBrep() failed for {type(geometry_object)}: {str(e)}\")\n\n        # Case 3: Unknown type - cannot convert\n        logger.warning(f\"Cannot convert {type(geometry_object)} to Brep\")\n        return None\n\n    except Exception as e:\n        logger.error(f\"Error in safe_to_brep_if_needed: {str(e)}\")\n        return None\n\ndef safe_to_brep(brep_object):\n    \"\"\"\n    Safely convert an object to a Brep, handling various types and failure cases.\n    \n    Args:\n        brep_object: Object to convert to a Brep\n        \n    Returns:\n        A Rhino.Geometry.Brep object, or None if conversion failed\n    \"\"\"\n    # Avoid None inputs\n    if brep_object is None:\n        return None\n        \n    from ..utils.logging_config import get_logger\n    logger = get_logger(__name__)\n    \n    try:\n        # Case 1: Already a Brep - just return it\n        if isinstance(brep_object, rg.Brep):\n            return brep_object\n            \n        # Case 2: It's an Extrusion - convert to Brep\n        if isinstance(brep_object, rg.Extrusion):\n            try:\n                return brep_object.ToBrep()\n            except Exception as e:\n                logger.warning(f\"Extrusion.ToBrep() failed: {str(e)}\")\n                # Try alternative conversion\n                \n        # Case 3: It's a Curve - try to create a surface\n        if isinstance(brep_object, rg.Curve):\n            try:\n                # Try to create a surface if it's a closed curve\n                if brep_object.IsClosed:\n                    surface = rg.Brep.CreatePlanarBreps(brep_object)\n                    if surface and len(surface) > 0:\n                        return surface[0]\n            except Exception as e:\n                logger.warning(f\"Failed to create surface from curve: {str(e)}\")\n        \n        # Case 4: It has a ToBrep method - use it\n        if hasattr(brep_object, 'ToBrep') and callable(getattr(brep_object, 'ToBrep')):\n            try:\n                return brep_object.ToBrep()\n            except Exception as e:\n                logger.warning(f\"ToBrep method failed: {str(e)}\")\n        \n        # Case 5: Has Surface properties\n        if hasattr(brep_object, 'IsSurface') and brep_object.IsSurface:\n            try:\n                return rg.Brep.CreateFromSurface(brep_object)\n            except Exception as e:\n                logger.warning(f\"Failed to create Brep from surface: {str(e)}\")\n        \n        # Case 6: It's a Box - properly handle conversion\n        if isinstance(brep_object, rg.Box):\n            try:\n                # Create Brep directly from the box corners\n                box = brep_object\n                corners = box.GetCorners()\n                if corners and len(corners) == 8:\n                    # Create Brep from box faces\n                    brep = rg.Brep()\n                    # Bottom face (0,1,2,3)\n                    bottom_surface = rg.PlaneSurface.CreateFromCorners(\n                        corners[0], corners[1], corners[2], corners[3]\n                    )\n                    if bottom_surface:\n                        brep.Faces.AddFace(bottom_surface)\n                    \n                    # Top face (4,5,6,7)\n                    top_surface = rg.PlaneSurface.CreateFromCorners(\n                        corners[4], corners[5], corners[6], corners[7]\n                    )\n                    if top_surface:\n                        brep.Faces.AddFace(top_surface)\n                    \n                    # Try to create a valid Brep\n                    if brep.IsValid:\n                        return brep\n                    \n                    # Fallback: try to create a box from BoundingBox\n                    bbox = brep_object.BoundingBox\n                    if bbox.IsValid:\n                        return rg.Brep.CreateFromBox(bbox)\n            except Exception as box_err:\n                logger.warning(f\"Failed to create Brep from Box: {str(box_err)}\")\n        \n        # Case 7: Unknown type - log and return the original object as fallback\n        logger.warning(f\"Cannot convert {type(brep_object)} to Brep - no conversion method available\")\n        return brep_object  # Return the original object as a fallback\n        \n    except Exception as e:\n        logger.error(f\"Unexpected error in safe_to_brep: {str(e)}\")\n        import traceback\n        logger.debug(traceback.format_exc())\n        return None",
  "language": "python",
  "imports": [
    "Rhino",
    "Rhino.Geometry"
  ],
  "has_docstring": true
}