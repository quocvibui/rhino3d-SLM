{
  "source_url": "https://github.com/BlockResearchGroup/compas-IGS/blob/be44e0ba12ce1156015b02b0ab9dd61c8006fc85/src/compas_igs/scene/formobject.py",
  "repo": "BlockResearchGroup/compas-IGS",
  "repo_stars": 1,
  "repo_description": "Rhino plugin for Interactive Graphic Statics using an algebraic graph-based approach to graphic statics",
  "license": "MIT",
  "filepath": "src/compas_igs/scene/formobject.py",
  "instruction": "Formobject",
  "code": "import rhinoscriptsyntax as rs  # type: ignore  # noqa: F401\nimport scriptcontext as sc  # type: ignore  # noqa: F401\n\nimport compas_rhino.conversions\nimport compas_rhino.objects\nfrom compas.colors import Color\nfrom compas.geometry import Cylinder\nfrom compas.scene.descriptors.color import ColorAttribute\nfrom compas.scene.descriptors.colordict import ColorDictAttribute\nfrom compas_ags.diagrams import FormDiagram\nfrom compas_igs.forms import EdgeForcesForm\nfrom compas_igs.session import IGSSession\nfrom compas_rui.scene import RUIMeshObject\n\n\nclass RhinoFormObject(RUIMeshObject):\n    session = IGSSession()\n\n    vertexcolor = ColorDictAttribute(default=Color.black())\n    vertexcolor_fixed = ColorAttribute(Color.red())\n    vertexcolor_lineconstraint = ColorAttribute(Color.white())\n\n    edgecolor = ColorDictAttribute(default=Color.black())\n    edgecolor_independent = ColorAttribute(Color.cyan())\n    edgecolor_external = ColorAttribute(Color.green())\n    edgecolor_reaction = ColorAttribute(Color.green())\n    edgecolor_load = ColorAttribute(Color.green())\n    edgecolor_targetforce = ColorAttribute(Color.white())\n    edgecolor_targetvector = ColorAttribute(Color.white())\n\n    facecolor = ColorDictAttribute(default=Color.grey().lightened(50))\n\n    vertexlabelcolor = ColorAttribute(Color.white())\n    edgelabelcolor = ColorAttribute(Color.black())\n\n    compressioncolor = ColorAttribute(Color.blue())\n    tensioncolor = ColorAttribute(Color.red())\n\n    def __init__(\n        self,\n        disjoint=True,\n        **kwargs,\n    ):\n        super().__init__(disjoint=disjoint, **kwargs)\n\n        self.show_faces = False\n        self.show_edges = True\n        self.show_vertices = True\n\n        self._guids_internal_force_pipes = []\n\n    @property\n    def diagram(self) -> FormDiagram:\n        return self.mesh\n\n    @diagram.setter\n    def diagram(self, diagram: FormDiagram) -> None:\n        self.mesh = diagram\n\n    # =============================================================================\n    # Draw\n    # =============================================================================\n\n    def draw(self):\n        super().draw()\n\n        if self.session.get(\"equilibrium\", False):\n            if self.session.settings.form.show_internal_force_pipes:\n                self.draw_internal_force_pipes()\n\n        if self.session.settings.form.show_external_force_labels:\n            self.draw_external_force_labels()\n        elif self.session.settings.form.show_independent_edge_labels:\n            self.draw_independent_edge_labels()\n\n        return self.guids\n\n    def draw_vertices(self):\n        for vertex in self.diagram.vertices():\n            if self.diagram.vertex_attribute(vertex, \"is_fixed\"):\n                self.vertexcolor[vertex] = self.vertexcolor_fixed\n            elif self.diagram.vertex_attribute(vertex, \"line_constraint\"):\n                self.vertexcolor[vertex] = self.vertexcolor_lineconstraint\n\n        return super().draw_vertices()\n\n    def draw_edges(self):\n        for edge in self.diagram.edges():\n            if self.diagram.edge_attribute(edge, \"is_ind\"):\n                self.edgecolor[edge] = self.edgecolor_independent\n            elif self.diagram.edge_attribute(edge, \"is_external\"):\n                self.edgecolor[edge] = self.edgecolor_external\n            elif self.diagram.edge_attribute(edge, \"is_reaction\"):\n                self.edgecolor[edge] = self.edgecolor_reaction\n            elif self.diagram.edge_attribute(edge, \"is_load\"):\n                self.edgecolor[edge] = self.edgecolor_load\n            else:\n                if self.session.get(\"equilibrium\", False):\n                    force = self.diagram.edge_attribute(edge, \"f\")\n\n                    if force > 0:\n                        self.edgecolor[edge] = self.tensioncolor\n                    elif force < 0:\n                        self.edgecolor[edge] = self.compressioncolor\n                    else:\n                        self.edgecolor[edge] = self.edgecolor.default\n                else:\n                    self.edgecolor[edge] = self.edgecolor.default\n\n        return super().draw_edges()\n\n    def draw_internal_force_pipes(self):\n        guids = []\n\n        scale = self.session.settings.form.scale_internal_force_pipes\n        tol = self.session.settings.form.tol_internal_force_pipes\n\n        color_compression = Color.blue()\n        color_tension = Color.red()\n\n        for edge in self.diagram.edges_where(is_external=False):\n            force = self.diagram.edge_force(edge)\n\n            if force != 0:\n                color = color_compression if force < 0 else color_tension\n                line = self.diagram.edge_line(edge)\n                radius = abs(force) * scale\n\n                if radius > tol:\n                    pipe = Cylinder.from_line_and_radius(line, radius)\n                    name = \"{}.edge.{}.force\".format(self.diagram.name, edge)\n                    attr = self.compile_attributes(name=name, color=color)\n                    guid = sc.doc.Objects.AddBrep(compas_rhino.conversions.cylinder_to_rhino_brep(pipe), attr)\n                    guids.append(guid)\n\n        if guids and self.group:\n            self.add_to_group(self.group, guids)\n\n        self._guids_internal_force_pipes = guids\n        self._guids += guids\n        return guids\n\n    def draw_independent_edge_labels(self):\n        text = {}\n        for edge in self.diagram.edges_where({\"is_ind\": True}):\n            force = self.diagram.edge_attribute(edge, \"f\")\n            text[edge] = f\"{force:.1f}\"\n\n        return self.draw_edgelabels(text=text)\n\n    def draw_external_force_labels(self):\n        text = {}\n        for edge in self.diagram.edges_where({\"is_external\": True}):\n            force = self.diagram.edge_attribute(edge, \"f\")\n            text[edge] = f\"{force:.1f}\"\n\n        return self.draw_edgelabels(text=text)\n\n    # =============================================================================\n    # Clear\n    # =============================================================================\n\n    def clear(self):\n        super().clear()\n        self.clear_internal_force_pipes()\n\n    def clear_internal_force_pipes(self):\n        compas_rhino.objects.delete_objects(self._guids_internal_force_pipes, purge=True)\n        self._guids_internal_force_pipes = []\n\n    # =============================================================================\n    # Redraw\n    # =============================================================================\n\n    def redraw(self):\n        rs.EnableRedraw(False)\n        self.clear()\n        self.draw()\n        rs.EnableRedraw(True)\n        rs.Redraw()\n\n    def redraw_vertices(self):\n        rs.EnableRedraw(False)\n        self.clear_vertices()\n        self.draw_vertices()\n        rs.EnableRedraw(True)\n        rs.Redraw()\n\n    def redraw_edges(self):\n        rs.EnableRedraw(False)\n        self.clear_edges()\n        self.draw_edges()\n        rs.EnableRedraw(True)\n        rs.Redraw()\n\n    def redraw_internal_force_pipes(self):\n        rs.EnableRedraw(False)\n        self.clear_internal_force_pipes()\n        self.draw_internal_force_pipes()\n        rs.EnableRedraw(True)\n        rs.Redraw()\n\n    # =============================================================================\n    # Select\n    # =============================================================================\n\n    def select_fixed_vertices(self):\n        selected = self.select_vertices_manual(message=\"Select ALL fixed vertices (others will be unfixed).\")\n        if selected:\n            self.diagram.vertices_attribute(name=\"is_fixed\", value=False)\n            self.diagram.vertices_attribute(name=\"is_fixed\", value=True, keys=selected)\n\n        return selected\n\n    def select_independent_edges(self):\n        selected = self.select_edges_manual(message=\"Select ALL independent edges.\")\n        if selected:\n            self.diagram.edges_attribute(name=\"is_ind\", value=False)\n            self.diagram.edges_attribute(name=\"is_ind\", value=True, keys=selected)\n\n        return selected\n\n    # =============================================================================\n    # Other\n    # =============================================================================\n\n    def assign_forces(self):\n        edges = list(self.diagram.edges_where(is_ind=True))\n        if not edges:\n            return rs.MessageBox(message=\"Please identify the independent edges first.\")\n\n        if hasattr(self, \"_guids_edgelabels\"):\n            compas_rhino.objects.delete_objects(self._guids_edgelabels, purge=True)\n            self._guids_edgelabels = []\n            rs.Redraw()\n\n        self.draw_edgelabels(text={edge: index for index, edge in enumerate(edges)}, color=self.edgecolor)\n        rs.Redraw()\n\n        rows = [[index, edge, self.diagram.edge_attribute(edge, name=\"f\")] for index, edge in enumerate(edges)]\n\n        form = EdgeForcesForm(rows, title=\"Assign Forces\")\n        if form.show():\n            for row in form.rows:\n                index, edge, force = row\n                length = self.diagram.edge_length(edge)\n                fd = force / length\n                self.diagram.edge_attribute(edge, name=\"f\", value=force)\n                self.diagram.edge_attribute(edge, name=\"q\", value=fd)\n",
  "language": "python",
  "imports": [
    "rhinoscriptsyntax",
    "scriptcontext"
  ],
  "has_docstring": false
}