{
  "source_url": "https://github.com/CADacombs/rhinopython/blob/541b4ade49f1dda6a3861d12b9e2613405182082/spb_Brep_edgeTolerances.py",
  "repo": "CADacombs/rhinopython",
  "repo_stars": 37,
  "repo_description": "Python scripts for Rhinoceros (Rhino, Rhino3D).",
  "license": "LGPL-3.0",
  "filepath": "spb_Brep_edgeTolerances.py",
  "instruction": "Spb brep edge tolerances",
  "code": "\"\"\"\r\n\"\"\"\r\n\r\n#! python 2  Must be on a line number less than 32.\r\nfrom __future__ import absolute_import, division, print_function, unicode_literals\r\n\r\n\"\"\"\r\n200131: Created.\r\n200507: Bug fix.\r\n221104: Added options for marking tolerances using dots.\r\n241105: Modified printed output to include range and count of edges above mdoel tolerance.\r\n241105: Modified printed output of when float vs. scientific notation is used.\r\n250301: Modified formatDistance.\r\n250602: Dots are now red.\r\n\"\"\"\r\n\r\nimport Rhino\r\nimport Rhino.DocObjects as rd\r\nimport Rhino.Input as ri\r\nimport scriptcontext as sc\r\n\r\nfrom System.Drawing import Color\r\n\r\n\r\nclass Opts:\r\n\r\n    keys = []\r\n    values = {}\r\n    names = {}\r\n    riOpts = {}\r\n    listValues = {}\r\n    stickyKeys = {}\r\n\r\n\r\n    key = 'fMaxTol'; keys.append(key)\r\n    values[key] = sc.doc.ModelAbsoluteTolerance\r\n    riOpts[key] = ri.Custom.OptionDouble(values[key], setLowerLimit=True, limit=1e-6)\r\n    stickyKeys[key] = '{}({})({})'.format(key, __file__, sc.doc.Name)\r\n\r\n    key = 'bAddDot'; keys.append(key)\r\n    values[key] = False\r\n    riOpts[key] = ri.Custom.OptionToggle(values[key], 'No', 'Yes')\r\n    stickyKeys[key] = '{}({})'.format(key, __file__)\r\n\r\n    key = 'bDotOnlyAboveTol'; keys.append(key)\r\n    values[key] = True\r\n    riOpts[key] = ri.Custom.OptionToggle(values[key], 'No', 'Yes')\r\n    stickyKeys[key] = '{}({})'.format(key, __file__)\r\n\r\n    key = 'iDotHt'; keys.append(key)\r\n    values[key] = 11\r\n    riOpts[key] = ri.Custom.OptionInteger(values[key], setLowerLimit=True, limit=3)\r\n    stickyKeys[key] = '{}({})'.format(key, __file__)\r\n\r\n    key = 'bEcho'; keys.append(key)\r\n    values[key] = True\r\n    riOpts[key] = ri.Custom.OptionToggle(values[key], 'No', 'Yes')\r\n    stickyKeys[key] = '{}({})'.format(key, __file__)\r\n\r\n    key = 'bDebug'; keys.append(key)\r\n    values[key] = False\r\n    riOpts[key] = ri.Custom.OptionToggle(values[key], 'No', 'Yes')\r\n    stickyKeys[key] = '{}({})'.format(key, __file__)\r\n\r\n\r\n    for key in keys:\r\n        if key not in names:\r\n            names[key] = key[1:]\r\n\r\n\r\n    # Load sticky.\r\n    for key in stickyKeys:\r\n        if stickyKeys[key] in sc.sticky:\r\n            if key in riOpts:\r\n                riOpts[key].CurrentValue = values[key] = sc.sticky[stickyKeys[key]]\r\n            else:\r\n                values[key] = sc.sticky[stickyKeys[key]]\r\n\r\n\r\n    @classmethod\r\n    def addOption(cls, go, key):\r\n\r\n        idxOpt = None\r\n\r\n        if key in cls.riOpts:\r\n            if key[0] == 'b':\r\n                idxOpt = go.AddOptionToggle(\r\n                        cls.names[key], cls.riOpts[key])[0]\r\n            elif key[0] == 'f':\r\n                idxOpt = go.AddOptionDouble(\r\n                    cls.names[key], cls.riOpts[key])[0]\r\n            elif key[0] == 'i':\r\n                idxOpt = go.AddOptionInteger(\r\n                    englishName=cls.names[key], intValue=cls.riOpts[key])[0]\r\n        elif key in cls.listValues:\r\n            idxOpt = go.AddOptionList(\r\n                englishOptionName=cls.names[key],\r\n                listValues=cls.listValues[key],\r\n                listCurrentIndex=cls.values[key])\r\n        else:\r\n            print(\"{} is not a valid key in Opts.\".format(key))\r\n\r\n        return idxOpt\r\n\r\n\r\n    @classmethod\r\n    def setValue(cls, key, idxList=None):\r\n\r\n        if key == 'fMaxTol':\r\n            if cls.riOpts[key].CurrentValue <= 0.0:\r\n                cls.riOpts[key].CurrentValue = cls.values[key] = cls.riOpts[key].InitialValue\r\n                sc.sticky[cls.stickyKeys[key]] = cls.values[key]\r\n                return\r\n\r\n        if key in cls.riOpts:\r\n            cls.values[key] = cls.riOpts[key].CurrentValue\r\n        elif key in cls.listValues:\r\n            cls.values[key] = idxList\r\n        else:\r\n            return\r\n\r\n        sc.sticky[cls.stickyKeys[key]] = cls.values[key]\r\n\r\n\r\ndef getAllNormalBreps():\r\n    oes = rd.ObjectEnumeratorSettings()\r\n    oes.NormalObjects = True\r\n    oes.LockedObjects = False # Default is True.\r\n    oes.IncludeLights = False\r\n    oes.IncludeGrips = False\r\n    oes.ObjectTypeFilter = rd.ObjectType.Brep\r\n    return list(sc.doc.Objects.GetObjectList(oes))\r\n\r\n\r\ndef getInput():\r\n    \"\"\"\r\n    \"\"\"\r\n\r\n    go = ri.Custom.GetObject()\r\n\r\n    go.SetCommandPrompt(\"Select brep\")\r\n    go.SetCommandPromptDefault(\"All normal when none are selected\")\r\n\r\n    go.GeometryFilter = rd.ObjectType.Brep\r\n    #go.SubObjectSelect = False\r\n\r\n    go.AcceptNothing(True)\r\n\r\n    go.AcceptNumber(True, acceptZero=True)\r\n\r\n    idxs_Opt = {}\r\n\r\n    while True:\r\n        go.ClearCommandOptions()\r\n\r\n        idxs_Opt.clear()\r\n\r\n        def addOption(key): idxs_Opt[key] = Opts.addOption(go, key)\r\n\r\n        addOption('fMaxTol')\r\n        addOption('bAddDot')\r\n        if Opts.values['bAddDot']:\r\n            addOption('bDotOnlyAboveTol')\r\n            addOption('iDotHt')\r\n        addOption('bEcho')\r\n        addOption('bDebug')\r\n\r\n        res = go.GetMultiple(minimumNumber=1, maximumNumber=0)\r\n\r\n        if res == ri.GetResult.Cancel:\r\n            go.Dispose()\r\n            return\r\n\r\n        if res == ri.GetResult.Nothing:\r\n            go.Dispose()\r\n            return getAllNormalBreps()\r\n\r\n        if res == ri.GetResult.Object:\r\n            objrefs = go.Objects()\r\n            go.Dispose()\r\n\r\n            return objrefs\r\n\r\n        if res == ri.GetResult.Number:\r\n            key = 'fMaxTol'\r\n            Opts.riOpts[key].CurrentValue = go.Number()\r\n            Opts.setValue(key)\r\n            continue\r\n\r\n        # An option was selected.\r\n        for key in idxs_Opt:\r\n            if go.Option().Index == idxs_Opt[key]:\r\n                Opts.setValue(key, go.Option().CurrentListOptionIndex)\r\n                break\r\n\r\n\r\ndef formatDistance(fDistance, iPrecision=None):\r\n    if iPrecision is None:\r\n        iPrecision = sc.doc.ModelDistanceDisplayPrecision\r\n    if fDistance is None:\r\n        return \"(No value provided)\"\r\n    if fDistance == 0.0:\r\n        return \"0\"\r\n    if fDistance < 0.001:\r\n        return \"{:.3e}\".format(fDistance)\r\n    return \"{:.{}g}\".format(fDistance, iPrecision)\r\n\r\n\r\ndef main():\r\n\r\n    rhBs_In = getInput()\r\n    if rhBs_In is None: return\r\n\r\n    bAddDot = Opts.values['bAddDot']\r\n    bDotOnlyAboveTol = Opts.values['bDotOnlyAboveTol']\r\n    fMaxTol = Opts.values['fMaxTol']\r\n    iDotHt = Opts.values['iDotHt']\r\n    bEcho = Opts.values['bEcho']\r\n    bDebug = Opts.values['bDebug']\r\n\r\n\r\n    fMaxEdgeTol_All = 0.0\r\n    iCt_Edges_All = 0\r\n    iCt_Edges_Found_All = 0\r\n    \r\n    bReportEveryBrep = False\r\n    if 1 <= len(rhBs_In) <= 10:\r\n        bReportEveryBrep = True\r\n    elif 10 < len(rhBs_In):\r\n        s  = \"More than 10 breps are selected,\"\r\n        s += \" so only maximum of all edge tolerances,\"\r\n        s += \" is reported.\"\r\n        print(s)\r\n    else:\r\n        return\r\n\r\n    if isinstance(rhBs_In[0], rd.ObjRef):\r\n        rgBs = [_.Brep() for _ in rhBs_In]\r\n    elif isinstance(rhBs_In[0], rd.BrepObject):\r\n        rgBs = [_.BrepGeometry for _ in rhBs_In]\r\n\r\n    gDots = []\r\n\r\n    if bAddDot:\r\n        attr_Out = rd.ObjectAttributes()\r\n        attr_Out.LayerIndex = sc.doc.Layers.CurrentLayerIndex\r\n        attr_Out.ColorSource = rd.ObjectColorSource.ColorFromObject\r\n        attr_Out.ObjectColor = Color.FromArgb(255,0,0)\r\n\r\n    fMaxEdgeTols = []\r\n    fOutOfTols_All = []\r\n\r\n    for rgB in rgBs:\r\n\r\n        fEdgeTols = []\r\n        #fMaxEdgeTol = 0.0\r\n        fOutOfTols_1B = []\r\n\r\n        for rgE in rgB.Edges:\r\n            edgeTol = rgE.Tolerance\r\n            fEdgeTols.append(edgeTol)\r\n            if edgeTol > fMaxTol:\r\n                fOutOfTols_1B.append(edgeTol)\r\n\r\n            #            if edgeTol > fMaxEdgeTol:\r\n            #                fMaxEdgeTol = edgeTol\r\n\r\n            if not bAddDot: continue\r\n\r\n            if bDotOnlyAboveTol and edgeTol <= fMaxTol: continue\r\n\r\n            text = formatDistance(edgeTol)\r\n            location = rgE.PointAt(rgE.Domain.Mid)\r\n            rgDot = Rhino.Geometry.TextDot(text, location)\r\n            rgDot.FontHeight = 11\r\n            gDot = sc.doc.Objects.AddTextDot(rgDot, attributes=attr_Out)\r\n            if gDot != gDot.Empty:\r\n                gDots.append(gDot)\r\n\r\n        fMaxEdgeTol = max(fEdgeTols)\r\n        fMinEdgeTol = min(fEdgeTols)\r\n        #        fMaxEdgeTols.append(fMaxEdgeTol)\r\n        fOutOfTols_All.extend(fOutOfTols_1B)\r\n\r\n        #        if fMaxEdgeTol > fMaxEdgeTol_All:\r\n        #            fMaxEdgeTol_All = fMaxEdgeTol\r\n        \r\n        if bReportEveryBrep:\r\n            if not fOutOfTols_1B:\r\n                print(\"No edge tolerances above {} in brep with {} edges.\".format(\r\n                    fMaxTol,\r\n                    rgB.Edges.Count,\r\n                    ))\r\n                #            print(\r\n                #                \"[{},{}] = edge tolerances found in brep with {} edges.\".format(\r\n                #                formatDistance(fMinEdgeTol),\r\n                #                formatDistance(fMaxEdgeTol),\r\n                #                rgB.Edges.Count,\r\n                #                ),\r\n            else:\r\n                if len(fOutOfTols_1B) == 1:\r\n                    print(\r\n                        \"{} = only edge tolerance above {} in brep with {} edges.\".format(\r\n                        formatDistance(fOutOfTols_1B[0]),\r\n                        fMaxTol,\r\n                        rgB.Edges.Count,\r\n                        )\r\n                        )\r\n                else:\r\n                    print(\r\n                        \"[{},{}] = range of {} edge tolerances above {} in brep with {} edges.\".format(\r\n                        formatDistance(min(fOutOfTols_1B)),\r\n                        formatDistance(max(fOutOfTols_1B)),\r\n                        len(fOutOfTols_1B),\r\n                        fMaxTol,\r\n                        rgB.Edges.Count,\r\n                        )\r\n                        )\r\n            #            print(\"{} maximum edge tolerance found in brep with {} edges.\".format(\r\n            #                formatDistance(fMaxEdgeTol),\r\n            #                rgB.Edges.Count,\r\n            #                ))\r\n\r\n        iCt_Edges_All += rgB.Edges.Count\r\n\r\n    #    fMaxEdgeTol_All = max(fMaxEdgeTols)\r\n\r\n\r\n    #    # Find number of edges close to maximum.\r\n    #    for rgB in rgBs:\r\n    #        for rgE in rgB.Edges:\r\n    #            if (\r\n    #                abs(fMaxEdgeTol_All - rgE.Tolerance) <\r\n    #                (0.5 * 10.0**-sc.doc.ModelDistanceDisplayPrecision)\r\n    #            ):\r\n    #                iCt_Edges_Found_All += 1\r\n    #\r\n    #\r\n    #    if len(rgBs) > 1:\r\n    #        print(\"{} maximum edge tolerance found in {} of {} edges in {} breps.\".format(\r\n    #            formatDistance(fMaxEdgeTol_All),\r\n    #            iCt_Edges_Found_All,\r\n    #            iCt_Edges_All,\r\n    #            len(objref_Bs)))\r\n\r\n    if not bReportEveryBrep and not fOutOfTols_All:\r\n        print('-'*80)\r\n        print(\"No edge tolerances above {}.\".format(\r\n            fMaxTol))\r\n        return\r\n\r\n    if len(rgBs) > 1:\r\n        if not fOutOfTols_All:\r\n            print('-'*80)\r\n            print(\"No edge tolerances above {}.\".format(\r\n                fMaxTol))\r\n            return\r\n\r\n        print('Total','-'*40)\r\n        print(\r\n            \"[{},{}] = range of {} edge tolerances above {} in {} breps.\".format(\r\n            formatDistance(min(fOutOfTols_All)),\r\n            formatDistance(max(fOutOfTols_All)),\r\n            len(fOutOfTols_All),\r\n            fMaxTol,\r\n            len(rgBs),\r\n            )\r\n            )\r\n\r\n    if gDots:\r\n        print(\"{} dots added.\".format(len(gDots)))\r\n        sc.doc.Views.Redraw()\r\n    elif bAddDot:\r\n        print(\"No dots added.\")\r\n\r\n\r\nif __name__ == '__main__': main()",
  "language": "python",
  "imports": [
    "Rhino",
    "Rhino.Geometry",
    "scriptcontext"
  ],
  "has_docstring": false
}