{
  "source_url": "https://github.com/BRG-teaching/Calgary2025/blob/05cb4f76aa7ff43a113f0f6ff494970d5c7756c4/archive/boolean.py",
  "repo": "BRG-teaching/Calgary2025",
  "repo_stars": 0,
  "repo_description": null,
  "license": "unknown",
  "filepath": "archive/boolean.py",
  "instruction": "venv: brg-csd r: compas_rv, compas_model",
  "code": "#! python3\n# venv: brg-csd\n# r: compas_rv, compas_model\n\nfrom compas.datastructures import Mesh\nfrom compas.geometry import Plane\nfrom compas.geometry import Line\nfrom compas.geometry import Sphere\nfrom compas.geometry import Box\nfrom compas.geometry import Frame\nfrom compas.geometry import Brep\nfrom compas.geometry import Transformation\n\nfrom compas.datastructures import Mesh\nfrom compas.scene import Scene\nfrom compas import json_load\nfrom compas import json_dump\nimport pathlib\n\nfrom compas_rhino.conversions import plane_to_rhino\nfrom compas_rhino.conversions import brep_to_compas\nimport rhinoscriptsyntax as rs\nimport Rhino.Geometry as rg\nimport scriptcontext as sc\n\nscene = Scene()\n# scene.clear_context()\n\n# Load dual\nfilepath = pathlib.Path(__file__).parent.parent / \"data\" / \"shell_final_dual.json\"\ndual = json_load(filepath)\n\n# Deserialize Mesh\nfilepath = pathlib.Path(__file__).parent.parent / \"data\" / \"shell_final_blocks.json\"\nblocks = json_load(filepath)\n\n\nmesh = dual\nblock_meshes = []\nfkey_index = {}\n\nblock_breps = [Brep.from_mesh(block) for block in blocks]\n\nfkey_index = {}\nfor i_face, face in enumerate(dual.faces()):\n    fkey_index[face] = i_face\n\nfor edge in mesh.edges():\n    face1, face2 = mesh.edge_faces(edge)\n    if face1 is not None and face2 is not None:\n        line = mesh.edge_line(edge)\n        z_axis = line.direction\n        x_axis = mesh.vertex_normal(edge[0]) + mesh.vertex_normal(edge[1])\n        y_axis = x_axis.cross(z_axis)\n        \n        # Create frames at 0.3 and 0.7 along the edge\n        p1 = line.point_at(0.3)\n        p2 = line.point_at(0.7)\n        frame1 = Frame(p1, x_axis, y_axis)\n        frame2 = Frame(p2, x_axis, y_axis)\n\n        sphere1a = Sphere(3, frame1)\n        sphere1b = Sphere(3, frame2)\n\n        sphere2a = Sphere(2.5, frame1) \n        sphere2b = Sphere(2.5, frame2)\n        # xsize = 2\n        # ysize = 2\n        # zsize = line.length * 0.75\n        # tolerance = 0.2\n        # box0 = Box(xsize + tolerance, ysize + tolerance, zsize + tolerance, frame)\n        # box1 = Box(xsize, ysize, zsize, frame)\n\n        # block_breps[fkey_index[face1]] = block_breps[fkey_index[face1]] - box0.to_brep()\n        # block_breps[fkey_index[face2]] = block_breps[fkey_index[face2]] + box1.to_brep()\n\n        # make two spheres along the edge\n        block_breps[fkey_index[face1]] = block_breps[fkey_index[face1]] - sphere1a.to_brep()\n        block_breps[fkey_index[face1]] = block_breps[fkey_index[face1]] - sphere1b.to_brep()\n        block_breps[fkey_index[face2]] = block_breps[fkey_index[face2]] + sphere2a.to_brep()\n        block_breps[fkey_index[face2]] = block_breps[fkey_index[face2]] + sphere2b.to_brep()\n\n        \n\n# scene.add(dual)\n\n\ndef create_3d_text(text, plane, group_name, height=8.0, extrusion_distance=0.5):\n    \"\"\"Create 3D text geometry in Rhino and add it to a group.\n    \n    Args:\n        text (str): The text to create\n        plane: Rhino plane for text placement\n        group_name (str): Name of the group to add text objects to\n        height (float): Text height\n        extrusion_distance (float): Depth of the 3D text\n    \n    Returns:\n        list: List of COMPAS Brep objects representing the 3D text\n    \"\"\"\n    # Create 2D text\n    text_obj = rs.AddText(text, plane, height, justification=2)\n    \n    # Explode text into curves\n    text_curves = rs.ExplodeText(text_obj, True)\n    \n    # Create surfaces from the curves\n    text_surfaces = rs.AddPlanarSrf(text_curves)\n    \n    # Convert surfaces to Rhino geometry\n    rhino_surfaces = [rs.coercesurface(srf) for srf in text_surfaces]\n    \n    # Create extruded 3D text\n    text_3d = []\n    text_breps = []  # Store the Brep objects for boolean operation\n    \n    for srf in rhino_surfaces:\n        brep = rg.Brep.CreateFromOffsetFace(srf, extrusion_distance, 0.01, True, True)\n        text_3d.append(sc.doc.Objects.AddBrep(brep))\n        text_breps.append(brep_to_compas(brep))\n    \n    # Clean up temporary objects\n    rs.DeleteObjects(text_curves + text_surfaces + [text_obj])\n    \n    # Group the 3D text objects\n    rs.AddObjectsToGroup(text_3d, group_name)\n    \n    return text_breps\n\n\n# Create a grid layout for the blocks\ngrid_size = 120  # spacing between blocks\nblocks_per_row = int(len(block_breps)**0.5) + 1  # approximate square grid\n\nprint(len(blocks), blocks_per_row)\n\nfor i, block in enumerate(blocks):\n\n    top_face_frame = block.face_frame(1)\n    top_face_frame.flip()\n\n    # Calculate grid position\n    row = i // blocks_per_row\n    col = i % blocks_per_row\n    \n    # Create target frame with Z pointing up (top face will be down)\n    target_point = [col * grid_size, row * grid_size, 0]\n    target_frame = Frame.worldXY()\n    target_frame.point = target_point\n    \n    transformation = Transformation.from_frame_to_frame(top_face_frame, target_frame) \n\n    # Transform blocks to target position\n    block_breps[i].transform(transformation)\n    block.transform(transformation)\n\n\n# Add labels, has to be done manually for now.\n\ngroup_name = \"Labels\"\nrs.AddGroup(group_name)\n\nfor i, block in enumerate(blocks):\n    block: Mesh\n    plane = block.face_plane(0)\n    plane = plane_to_rhino(plane)\n    text_breps = create_3d_text(str(i), plane, group_name)\n\n\nfor block in block_breps:\n    scene.add(block)\n\nscene.draw()",
  "language": "python",
  "imports": [
    "Rhino",
    "Rhino.Geometry",
    "rhinoscriptsyntax",
    "scriptcontext"
  ],
  "has_docstring": true
}