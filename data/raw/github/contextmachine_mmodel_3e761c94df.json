{
  "source_url": "https://github.com/contextmachine/mmodel/blob/0545e5c2a11c641fc54e91f603e709d3dea549f3/panels_gh/py3klays/cadexdxf.py",
  "repo": "contextmachine/mmodel",
  "repo_stars": 0,
  "repo_description": "Deployment branch",
  "license": "Apache-2.0",
  "filepath": "panels_gh/py3klays/cadexdxf.py",
  "instruction": "Cadexdxf",
  "code": "import gzip\nimport json\nimport os\nimport sys\nimport time\n\nsys.path.extend([\"/Users/andrewastakhov/PycharmProjects\", \"/Users/andrewastakhov/PycharmProjects/mmodel/panels_gh\"])\n\nimport rhino3dm\nimport compute_rhino3d.Util\nfrom rhino3dm import _rhino3dm as rh\nfrom py3klays import cadex_license as license\nimport cadexchanger.CadExCore as cadex\nimport cadexchanger.CadExRhino as rhino\nimport cadexchanger.CadExDXF as dxf\n\n\ndef todxf(theSource: str, theDest: str):\n    aKey = license.Value()\n\n    if not cadex.LicenseManager.Activate(aKey):\n        print(\"Failed to activate CAD Exchanger license.\")\n        return 1\n\n    aModel = cadex.ModelData_Model()\n\n    print(\"Conversion started...\")\n\n    aReader = rhino.Rhino_Reader()\n    # Opening and converting the file\n    if not aReader.ReadFile(cadex.Base_UTF16String(theSource)):\n        print(\"Failed to open and convert the file \" + theSource)\n        return 1\n    if not aReader.Transfer(aModel):\n        print(\"Failed to transfer the model into inner format\")\n        return 1\n    aWriter = dxf.DXF_Writer()\n    aWriterParams: dxf.DXF_WriterParameters = aWriter.Parameters()\n\n    # Set some writer parameteres\n    aWriterParams.SetLengthUnit(cadex.Base_LU_Millimeters)\n    aWriterParams.SetDXFVersion(aWriterParams.AutoCAD_2007).SetLengthUnit(cadex.Base_LU_Millimeters)\n    aWriterParams.SetWritePolyRepresentation(True)\n    # Converting model data to a new format\n    if not aWriter.Transfer(aModel):\n        print(\"Failed to transfer model data to specified format\")\n        return 1\n\n    # Writing model data to file\n    if not aWriter.WriteFile(cadex.Base_UTF16String(theDest)):\n        print(\"Failed to write the file\")\n        return 1\n\n    print(\"Completed\")\n\n    return 0\n\n\nclass RH:\n    def __init__(self, tag, time, layers, **kwargs):\n        self.time = time\n        super().__init__()\n        # self.frame = frame\n        self.tag = tag\n        self.__dict__ |= kwargs\n        self.model = rhino3dm.File3dm()\n        self.layers = []\n        for l in layers:\n            self.layers.append(Lay(model=self.model, **l))\n\n    def write(self):\n        os.mkdir(f\"{os.getenv('PANELS_GH_DUMPS')}/build{s}/{self.tag}\")\n        os.mkdir(f\"{os.getenv('PANELS_GH_DUMPS')}/build{s}-dxf/{self.tag}\")\n        fp = f\"{os.getenv('PANELS_GH_DUMPS')}/build{s}/{self.tag}/{self.tag}\"\n        fp2 = f\"{os.getenv('PANELS_GH_DUMPS')}/build{s}-dxf/{self.tag}/{self.tag}\"\n        self.model.Write(fp + \".3dm\", 7)\n        todxf(fp + \".3dm\", fp2 + \".dxf\")\n\n        # self.model.Write(f\"dumps/{self.tag}/{self.tag}\"+\".dxf\")\n        # client.s3.put_object(Bucket=client.bucket,Key=f\"{client.bucket}/{client.prefix}/build{self.time}/{self.tag}/{self.time}\", Body=self.model.Encode())\n        return f\"{os.getenv('PANELS_GH_DUMPS')}/build{s}/{self.tag}/{self.tag}.3dm\"\n\n\nclass Lay:\n\n    def __init__(self, model=None, **kwargs):\n        super().__init__()\n        self.model = model\n        self._lay = rhino3dm.Layer()\n        self._lay.Name = kwargs[\"name\"]\n\n        self._lay.Color = tuple(kwargs[\"color\"] + [255])\n        self._lay.Visible = (kwargs[\"visible\"])\n\n        lay_index = self.model.Layers.Add(self._lay)\n        m = rh.Transform.Mirror(rhino3dm.Plane.WorldYZ())\n        if kwargs[\"objects\"] is not None:\n            for o in kwargs[\"objects\"]:\n                # obj = list(self.model.Objects)[-1]\n\n                attrs = rhino3dm.ObjectAttributes()\n                attrs.PlotColorSource = rhino3dm.ObjectPlotColorSource.PlotColorFromLayer\n                attrs.ColorSource = rhino3dm.ObjectColorSource.ColorFromLayer\n                attrs.LayerIndex = lay_index\n                o[\"archive3dm\"] = 70\n                obj = rhino3dm.CommonObject.Decode(o)\n                obj.Transform(m)\n                print(obj)\n                self.model.Objects.Add(obj, attrs)\n\n\nif __name__ == \"__main__\":\n\n    s = round(time.time())\n    os.mkdir(f\"{os.getenv('PANELS_GH_DUMPS')}/build{s}\")\n    os.mkdir(f\"{os.getenv('PANELS_GH_DUMPS')}/build{s}-dxf\")\n    # client = sessions.S3Client(bucket=os.getenv('BUCKET'), prefix=\"workspace/cxm/arc/\")\n    with gzip.open(f\"{os.getenv('PANELS_GH_DUMPS')}/input.gz\", \"rb\", compresslevel=9) as gz:\n        bts = gz.read()\n        # client.s3.put_object(Bucket=client.bucket, Key=f\"{client.bucket }/{client.prefix}/build{s}\", Body=bts)\n        for obj in json.loads(bts):\n            print(obj)\n            a = RH(**obj, time=1)\n\n            os.environ['RHINO_TARGET'] = a.write()\n",
  "language": "python",
  "imports": [
    "rhino3dm"
  ],
  "has_docstring": false
}