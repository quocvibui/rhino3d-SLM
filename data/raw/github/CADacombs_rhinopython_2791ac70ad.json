{
  "source_url": "https://github.com/CADacombs/rhinopython/blob/541b4ade49f1dda6a3861d12b9e2613405182082/spb_Brep_setAllFaceColors.py",
  "repo": "CADacombs/rhinopython",
  "repo_stars": 37,
  "repo_description": "Python scripts for Rhinoceros (Rhino, Rhino3D).",
  "license": "LGPL-3.0",
  "filepath": "spb_Brep_setAllFaceColors.py",
  "instruction": "Spb brep set all face colors",
  "code": "\"\"\"\r\n\"\"\"\r\n\r\nfrom __future__ import absolute_import, division, print_function, unicode_literals\r\n\r\n\"\"\"\r\n230329-30: Created.\r\n\"\"\"\r\n\r\nimport Rhino\r\nimport Rhino.DocObjects as rd\r\nimport Rhino.Input as ri\r\nimport scriptcontext as sc\r\n\r\nfrom System.Drawing import Color\r\n\r\n\r\nclass Opts:\r\n\r\n    keys = []\r\n    values = {}\r\n    names = {}\r\n    riOpts = {}\r\n    listValues = {}\r\n    stickyKeys = {}\r\n\r\n    key = 'bRemoveColor'; keys.append(key)\r\n    values[key] = False\r\n    riOpts[key] = ri.Custom.OptionToggle(values[key], 'No', 'Yes')\r\n    stickyKeys[key] = '{}({})'.format(key, __file__)\r\n\r\n    key = 'iR'; keys.append(key)\r\n    values[key] = 255\r\n    riOpts[key] = ri.Custom.OptionInteger(values[key], 0, 255)\r\n    stickyKeys[key] = '{}({})'.format(key, __file__)\r\n\r\n    key = 'iG'; keys.append(key)\r\n    values[key] = 0\r\n    riOpts[key] = ri.Custom.OptionInteger(values[key], 0, 255)\r\n    stickyKeys[key] = '{}({})'.format(key, __file__)\r\n\r\n    key = 'iB'; keys.append(key)\r\n    values[key] = 0\r\n    riOpts[key] = ri.Custom.OptionInteger(values[key], 0, 255)\r\n    stickyKeys[key] = '{}({})'.format(key, __file__)\r\n\r\n    key = 'bUseBrepColor'; keys.append(key)\r\n    values[key] = False\r\n    riOpts[key] = ri.Custom.OptionToggle(values[key], 'No', 'Yes')\r\n    stickyKeys[key] = '{}({})'.format(key, __file__)\r\n\r\n    key = 'bEcho'; keys.append(key)\r\n    values[key] = True\r\n    riOpts[key] = ri.Custom.OptionToggle(values[key], 'No', 'Yes')\r\n    stickyKeys[key] = '{}({})'.format(key, __file__)\r\n\r\n    key = 'bDebug'; keys.append(key)\r\n    values[key] = False\r\n    riOpts[key] = ri.Custom.OptionToggle(values[key], 'No', 'Yes')\r\n    stickyKeys[key] = '{}({})'.format(key, __file__)\r\n\r\n    for key in keys:\r\n        if key not in names:\r\n            names[key] = key[1:]\r\n\r\n\r\n    # Load sticky.\r\n    for key in stickyKeys:\r\n        if stickyKeys[key] in sc.sticky:\r\n            if key in riOpts:\r\n                riOpts[key].CurrentValue = values[key] = sc.sticky[stickyKeys[key]]\r\n            else:\r\n                values[key] = sc.sticky[stickyKeys[key]]\r\n\r\n\r\n    @classmethod\r\n    def addOption(cls, go, key):\r\n\r\n        idxOpt = None\r\n\r\n        if key in cls.riOpts:\r\n            if key[0] == 'b':\r\n                idxOpt = go.AddOptionToggle(\r\n                        cls.names[key], cls.riOpts[key])[0]\r\n            elif key[0] == 'f':\r\n                idxOpt = go.AddOptionDouble(\r\n                    cls.names[key], cls.riOpts[key])[0]\r\n            elif key[0] == 'i':\r\n                idxOpt = go.AddOptionInteger(\r\n                    englishName=cls.names[key], intValue=cls.riOpts[key])[0]\r\n        else:\r\n            idxOpt = go.AddOptionList(\r\n                englishOptionName=cls.names[key],\r\n                listValues=cls.listValues[key],\r\n                listCurrentIndex=cls.values[key])\r\n\r\n        return idxOpt\r\n\r\n\r\n    @classmethod\r\n    def setValue(cls, key, idxList=None):\r\n\r\n        #if key == 'fRadius':\r\n        #    if cls.riOpts[key].CurrentValue < 2.0*sc.doc.ModelAbsoluteTolerance:\r\n        #        cls.riOpts[key].CurrentValue = 0.0\r\n\r\n        if key in cls.riOpts:\r\n            cls.values[key] = cls.riOpts[key].CurrentValue\r\n        elif key in cls.listValues:\r\n            cls.values[key] = idxList\r\n        else:\r\n            return\r\n        sc.sticky[cls.stickyKeys[key]] = cls.values[key]\r\n\r\n\r\ndef getInput():\r\n    \"\"\"\r\n    \"\"\"\r\n\r\n    goB = ri.Custom.GetObject()\r\n\r\n    goB.SetCommandPrompt(\"Select breps to set all their faces\")\r\n\r\n    goB.GeometryFilter = rd.ObjectType.Brep\r\n\r\n    goB.AlreadySelectedObjectSelect = True\r\n    goB.DeselectAllBeforePostSelect = False # So objects won't be deselected on repeats of While loop.\r\n    goB.EnableClearObjectsOnEntry(False) # Keep objects in goB on repeats of While loop.\r\n    goB.EnableUnselectObjectsOnExit(False) # False to keep objects selected when picking an option.\r\n\r\n    bPreselectedObjsChecked = False\r\n\r\n    sQuickPicks = []\r\n    rgbs_QP = {}\r\n    idxs_Opts_QP = {}\r\n\r\n    key = 'Red'\r\n    sQuickPicks.append(key)\r\n    rgbs_QP[key] = 255,0,0\r\n    key = 'Green'\r\n    sQuickPicks.append(key)\r\n    rgbs_QP[key] = 0,255,0\r\n    key = 'Blue'\r\n    sQuickPicks.append(key)\r\n    rgbs_QP[key] = 0,0,255\r\n\r\n    idxs_Opts = {}\r\n\r\n    def addOption(key): idxs_Opts[key] = Opts.addOption(goB, key)\r\n\r\n    while True:\r\n        goB.ClearCommandOptions()\r\n\r\n        idxs_Opts.clear()\r\n\r\n        addOption('bRemoveColor')\r\n        if not Opts.values['bRemoveColor']:\r\n            addOption('bUseBrepColor')\r\n            if not Opts.values['bUseBrepColor']:\r\n                addOption('iR')\r\n                addOption('iG')\r\n                addOption('iB')\r\n                for sOpt in sQuickPicks:\r\n                    idxs_Opts_QP[sOpt] = idxs_Opts[sOpt] = goB.AddOption(sOpt)\r\n                idxs_Opts['Dialog'] = goB.AddOption('Dialog')\r\n                idxs_Opts['MatchFace'] = goB.AddOption('MatchFace')\r\n        addOption('bEcho')\r\n        addOption('bDebug')\r\n\r\n        res = goB.GetMultiple(minimumNumber=1, maximumNumber=0)\r\n\r\n        if res == ri.GetResult.Cancel:\r\n            goB.Dispose()\r\n            return\r\n\r\n        # Use bPreselectedObjsChecked so that only objects before the\r\n        # first call to goB.GetMultiple is considered.\r\n        if not bPreselectedObjsChecked and goB.ObjectsWerePreselected:\r\n            bPreselectedObjsChecked = True\r\n            goB.EnablePreSelect(False, ignoreUnacceptablePreselectedObjects=True)\r\n            continue\r\n\r\n        if res == ri.GetResult.Object:\r\n            objrefs = goB.Objects()\r\n            goB.Dispose()\r\n            return objrefs\r\n\r\n        # An option was selected.\r\n        if goB.Option().Index in idxs_Opts_QP.values():\r\n            key_QP = list(idxs_Opts_QP)[list(idxs_Opts_QP.values()).index(goB.Option().Index)]\r\n            key = 'iR'; Opts.riOpts[key].CurrentValue = rgbs_QP[key_QP][0]; Opts.setValue(key)\r\n            key = 'iG'; Opts.riOpts[key].CurrentValue = rgbs_QP[key_QP][1]; Opts.setValue(key)\r\n            key = 'iB'; Opts.riOpts[key].CurrentValue = rgbs_QP[key_QP][2]; Opts.setValue(key)\r\n            continue\r\n\r\n        if 'Dialog' in idxs_Opts and goB.Option().Index == idxs_Opts['Dialog']:\r\n            color = Color.FromArgb(\r\n                red=Opts.values['iR'],\r\n                green=Opts.values['iG'],\r\n                blue=Opts.values['iB'])\r\n            bSuccess, color = Rhino.UI.Dialogs.ShowColorDialog(color)\r\n            if bSuccess:\r\n                key = 'iR'; Opts.riOpts[key].CurrentValue = color.R; Opts.setValue(key)\r\n                key = 'iG'; Opts.riOpts[key].CurrentValue = color.G; Opts.setValue(key)\r\n                key = 'iB'; Opts.riOpts[key].CurrentValue = color.B; Opts.setValue(key)\r\n            continue\r\n\r\n        if 'MatchFace' in idxs_Opts and goB.Option().Index == idxs_Opts['MatchFace']:\r\n            goF = ri.Custom.GetObject()\r\n            goF.SetCommandPrompt(\"Pick face to obtain its color\")\r\n            goF.GeometryFilter = rd.ObjectType.Surface\r\n            goF.DeselectAllBeforePostSelect = False # False to keep goB selections.\r\n            goF.EnableHighlight(False)\r\n            goB.EnablePreSelect(False, ignoreUnacceptablePreselectedObjects=True) # False to not change brep of selected face to match.\r\n            res = goF.Get()\r\n\r\n            if res == ri.GetResult.Cancel:\r\n                goF.Dispose()\r\n                goB.Dispose()\r\n                return\r\n\r\n            if res == ri.GetResult.Object:\r\n                objref = goF.Object(0)\r\n                goF.Dispose()\r\n\r\n                color = objref.Face().PerFaceColor\r\n                key = 'iR'; Opts.riOpts[key].CurrentValue = color.R; Opts.setValue(key)\r\n                key = 'iG'; Opts.riOpts[key].CurrentValue = color.G; Opts.setValue(key)\r\n                key = 'iB'; Opts.riOpts[key].CurrentValue = color.B; Opts.setValue(key)\r\n\r\n            continue\r\n\r\n\r\n        for key in idxs_Opts:\r\n            if goB.Option().Index == idxs_Opts[key]:\r\n                Opts.setValue(key, goB.Option().CurrentListOptionIndex)\r\n                break\r\n\r\n\r\ndef _sortInput(objrefs):\r\n    gBs = []\r\n    rdIdefs = []\r\n\r\n    for objref in objrefs:\r\n        rdObj = objref.Object()\r\n        if rdObj.ObjectType == rd.ObjectType.InstanceReference:\r\n            rdIdef = rdObj.InstanceDefinition\r\n            rdB = objref.InstanceDefinitionPart()\r\n        else:\r\n            rdB = rdObj\r\n            rdIdef = None\r\n        gB = rdB.Id\r\n        if gB not in gBs:\r\n            gBs.append(gB)\r\n            rdIdefs.append(rdIdef)\r\n\r\n    return gBs, rdIdefs\r\n\r\n\r\ndef _replaceInDef(rdIdef, gB, rgB):\r\n\r\n    geoms = []\r\n    attrs = []\r\n\r\n    for rdObj in rdIdef.GetObjects():\r\n        if rdObj.Id == gB:\r\n            geoms.append(rgB)\r\n        else:\r\n            geoms.append(rdObj.Geometry)\r\n        attrs.append(rdObj.Attributes)\r\n\r\n    if not sc.doc.InstanceDefinitions.ModifyGeometry(rdIdef.Index, geoms, attrs):\r\n        print(\"Could not modify block instance.\")\r\n\r\n\r\ndef main():\r\n\r\n    objrefs = getInput()\r\n    if objrefs is None: return\r\n\r\n    gBs, rdIdefs = _sortInput(objrefs)\r\n\r\n    if Opts.values['bRemoveColor']:\r\n        color = Color.Empty\r\n    else:\r\n        color = Color.FromArgb(\r\n            red=Opts.values['iR'],\r\n            green=Opts.values['iG'],\r\n            blue=Opts.values['iB'])\r\n\r\n    bUseBrepColor = Opts.values['bUseBrepColor'] and not Opts.values['bRemoveColor']\r\n\r\n    iCt_Bs_WithMods = 0\r\n    iCt_Mods_AllBs = 0\r\n\r\n    for gB, rdIdef in zip(gBs, rdIdefs):\r\n        rdB = sc.doc.Objects.FindId(gB)\r\n        rgB = rdB.BrepGeometry\r\n        iCt_Mods_ThisB = 0\r\n        if bUseBrepColor:\r\n            if rdB.Attributes.ColorSource == rd.ObjectColorSource.ColorFromLayer:\r\n                layer = sc.doc.Layers.FindIndex(rdB.Attributes.LayerIndex)\r\n                color = layer.Color\r\n            elif rdB.Attributes.ColorSource == rd.ObjectColorSource.ColorFromObject:\r\n                color = rdB.Attributes.ObjectColor\r\n            else:\r\n                print(\"ColorSource {} not supported (yet?).\".format(\r\n                    rdB.Attributes.ColorSource),\r\n                      \"Face colors were not changed.\")\r\n                continue\r\n        for idxF in xrange(rgB.Faces.Count):\r\n            if rgB.Faces[idxF].PerFaceColor != color:\r\n                rgB.Faces[idxF].PerFaceColor = color\r\n                if rgB.Faces[idxF].PerFaceColor == color:\r\n                    iCt_Mods_ThisB += 1\r\n        if rdIdef is None:\r\n            if sc.doc.Objects.Replace(objectId=gB, brep=rgB):\r\n                iCt_Bs_WithMods += 1\r\n                iCt_Mods_AllBs += iCt_Mods_ThisB\r\n        else:\r\n            _replaceInDef(rdIdef, gB, rgB)\r\n\r\n    if iCt_Mods_AllBs == 0:\r\n        print(\"Not including instances, no face colors were modified.\")\r\n    else:\r\n        print(\"Not including instances, {} face colors were modified in {} breps.\".format(\r\n            iCt_Mods_AllBs, iCt_Bs_WithMods))\r\n\r\n    sc.doc.Views.Redraw()\r\n\r\n\r\nif __name__ == '__main__': main()",
  "language": "python",
  "imports": [
    "Rhino",
    "scriptcontext"
  ],
  "has_docstring": false
}