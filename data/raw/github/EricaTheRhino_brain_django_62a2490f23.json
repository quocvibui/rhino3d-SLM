{
  "source_url": "https://github.com/EricaTheRhino/brain_django/blob/5b2e20fd66ec6b61ac16792c82ddfca9af814d9b/processor/views.py",
  "repo": "EricaTheRhino/brain_django",
  "repo_stars": 0,
  "repo_description": "Brain's django bits",
  "license": "unknown",
  "filepath": "processor/views.py",
  "instruction": null,
  "code": "import redis\nimport time\nfrom django.utils import simplejson\nfrom django.http import HttpResponse\nfrom processor.models import RhinoScript, ComponentForm, Component\nfrom django.core.files import File\nfrom django.conf import settings\nfrom django.views.decorators.csrf import csrf_exempt\nimport logging\nimport hashlib\nimport glob\nlogger = logging.getLogger(__name__)\nfrom processor.scripting import *\nfrom processor.sound import *\nimport random\nimport time\nfrom pyga.requests import Tracker, Session, Visitor, Event\nimport celery\nimport mosquitto\n\nglobal mqtt\n\ndef process_event():\n\t# First work through the behaviours\n\tfiles = glob.glob(settings.ROOT_PATH+'/behaviours/*.py')\n\tfiles.sort()\n\tfor filename in files:\n\t\texecfile(filename)\n\ndef handle_event(event, params):\n\tif event.startswith('interaction.'):\n\t\tcelery.execute.send_task(\"tasks.ga\", [event])\n\tat_time = time.time()\n\tif event == 'environment.bluetooth.found' or event == 'environment.bluetooth.lost':\n\t\tif 'address' in params:\n\t\t\tparams['address'] = hashlib.sha1(params['address']+','+'rh1n0t3xt').hexdigest()\n\t\n\tmemory_obj = {'event':event, 'params':params, 'created':at_time}\n\tmemory_json = simplejson.dumps(memory_obj)\n\n\t# First update the various stats in redis.\n\tr = redis.StrictRedis(host='localhost', port=6379, db=0)\n\tp = r.pipeline()\n\tp.multi()\n\t\n\t# pushes a memory object to the memory list, then trims it down to 10 items.\n\tp.lpush('short_term', memory_json)\n\tp.ltrim('short_term', 0, 99)\n\n\t# Incrs the count of this item in long-term memory.\n\tp.hincrby('long_term', event, 1)\n\t# Store when the event last happened\n\tp.execute()\n\t\n\t#mqtt_connect()\n\tprocess_event()\n\t#mqtt_disconnect()\n\t\n@csrf_exempt\ndef add_event(request):\n\tif request.method == 'GET':\n\t\treturn HttpResponse(\"Please post to me!\")\n\telif request.method == 'POST':\n\t\tdata = simplejson.loads(request.body)\n\t\tif not 'event' in data or not 'params' in data:\n\t\t\treturn HttpResponse(\"Invalid parameters (need event and params)\")\n\t\thandle_event(data['event'], data['params'])\n\t\treturn HttpResponse(simplejson.dumps({'result':'success'}), mimetype='application/json')\n\n@csrf_exempt\ndef get_state(request):\n\tr = redis.StrictRedis(host='localhost', port=6379, db=0)\n\tmemory = r.lrange('short_term', 0, -1)\n\tshort_term = []\n\tfor memory_json in memory:\n\t\tmemory_obj = simplejson.loads(memory_json)\n\t\tshort_term.append(memory_obj)\n\n\tlogs = r.lrange('log', 0, -1)\n\tmessages = []\n\tfor log in logs:\n\t\tmessages.append(log)\n\n\tmood_keys = r.lrange('moods', 0, -1)\n\tmoods = []\n\tfor mood_key in mood_keys:\n\t\tmoods.append(mood_key)\n\n\tlong_term = {}\n\tlast_trigger = {}\n\tfor key in r.hkeys('long_term'):\n\t\tlong_term[key] = r.hget('long_term', key)\n\n\tfor key in r.hkeys('last_trigger'):\n\t\tlast_trigger[key] = r.hget('last_trigger', key)\n\n\t# Get stats\n\tstats = {}\n\tfor key in r.hkeys('stats'):\n\t\tstats[key] = r.hget('stats', key)\n\treturn HttpResponse(simplejson.dumps({'result':'success', 'messages':messages, 'short_term':short_term, 'long_term':long_term, 'moods':moods,  'last_trigger':last_trigger, 'stats':stats}), mimetype='application/json')\n\n@csrf_exempt\ndef register_component(request):\n\tdata = simplejson.loads(request.body)\n\tif not 'url' in data:\n\t\treturn HttpResponse(simplejson.dumps({'result':'failure', 'reason':'missing_url'}), mimetype='application/json')\n\n\tif not 'name' in data:\n\t\treturn HttpResponse(simplejson.dumps({'result':'failure', 'reason':'missing_name'}), mimetype='application/json')\n\n\n\t# TODO: Check that it validates before deleting old components\n\tComponent.objects.filter(name=data['name']).delete()\n\tform = ComponentForm({'url':data['url'], 'name':data['name']})\n\tif form.is_valid():\n\t\tnew_component = form.save()\n\t\treturn HttpResponse(simplejson.dumps({'result':'success'}))\n\telse:\n\t\treturn HttpResponse(simplejson.dumps({'result':'failure', 'reason':'invalid_data'}), mimetype='application/json')\n",
  "language": "python",
  "imports": [],
  "has_docstring": false
}