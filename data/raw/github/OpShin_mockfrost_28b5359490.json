{
  "source_url": "https://github.com/OpShin/mockfrost/blob/bb67fab42236b925a25f1a24f4ebbbdcbde39aa8/plutus_bench/tx_tools.py",
  "repo": "OpShin/mockfrost",
  "repo_stars": 22,
  "repo_description": "A unified framework for Cardano Smart Contract testing and benchmarking m",
  "license": "unknown",
  "filepath": "plutus_bench/tx_tools.py",
  "instruction": "Tx tools",
  "code": "from functools import lru_cache\nfrom typing import Optional, Union, List\nfrom dataclasses import dataclass\n\nimport cbor2\nimport pycardano\nimport uplc\nimport uplc.cost_model\nimport uplc.ast\nfrom pycardano import (\n    ScriptHash,\n    RedeemerTag,\n    plutus_script_hash,\n    datum_hash,\n    PlutusV1Script,\n    PlutusV2Script,\n    PlutusV3Script,\n    UTxO,\n)\n\nfrom pycardano import Datum as Anything, PlutusData\n\n# from .ledger.api_v2 import *\nfrom .ledger.api_v1 import ScriptContext as ScriptContextV1\nfrom .ledger.api_v2 import ScriptContext as ScriptContextV2\nfrom .ledger.api_v3 import ScriptContext as ScriptContextV3\nfrom .to_script_context_v2 import (\n    to_spending_script_context as to_spending_script_context_v2,\n    to_minting_script_context as to_minting_script_context_v2,\n    to_certificate_script_context as to_certificate_script_context_v2,\n    to_withdrawal_script_context as to_withdrawal_script_context_v2,\n)\nfrom .to_script_context_v1 import (\n    to_spending_script_context as to_spending_script_context_v1,\n    to_minting_script_context as to_minting_script_context_v1,\n    to_certificate_script_context as to_certificate_script_context_v1,\n    to_withdrawal_script_context as to_withdrawal_script_context_v1,\n)\nfrom .to_script_context_v3 import to_script_context as to_script_context_v3\n\nfrom .tool import ScriptType\n\n\n@dataclass\nclass ScriptInvocation:\n    script: pycardano.ScriptType\n    datum: Optional[pycardano.Datum]\n    redeemer: Union[pycardano.Redeemer, pycardano.RedeemerMap]\n    script_context: Union[ScriptContextV1, ScriptContextV2, ScriptContextV3]\n\n\ndef generate_script_contexts(tx_builder: pycardano.TransactionBuilder):\n    \"\"\"Generates for each evaluated script, with which parameters it should be called\"\"\"\n    # TODO this only handles PlutusV2, no other script contexts are currently supported\n\n    tx = tx_builder._build_full_fake_tx()\n    # we assume that reference inputs are UTxO objects!\n    input_to_resolved_output = {}\n    for utxo in tx_builder.inputs + list(tx_builder.reference_inputs):\n        assert isinstance(utxo, pycardano.UTxO)\n        input_to_resolved_output[utxo.input] = utxo.output\n    # input_to_resolved_output = {\n    #     utxo.input: utxo.output\n    #     for utxo in tx_builder.inputs + tx_builder.reference_inputs\n    # }\n    resolved_inputs = [\n        UTxO(i, input_to_resolved_output[i]) for i in tx.transaction_body.inputs\n    ]\n    resolved_reference_inputs = [\n        UTxO(i, input_to_resolved_output[i])\n        for i in tx.transaction_body.reference_inputs\n    ]\n    return generate_script_contexts_resolved(\n        tx, resolved_inputs, resolved_reference_inputs\n    )\n\n\ndef as_redeemer(\n    r: Union[pycardano.Redeemer, pycardano.RedeemerKey], redeemers: pycardano.Redeemers\n):\n    if isinstance(r, pycardano.RedeemerKey):\n        v = redeemers[r]\n        new_r = pycardano.Redeemer(data=v.data, ex_units=v.ex_units)\n        new_r.tag = r.tag\n        new_r.index = r.index\n        return new_r\n    else:\n        return r\n\n\ndef generate_script_contexts_resolved(\n    tx: pycardano.Transaction,\n    resolved_inputs: List[UTxO],\n    resolved_reference_inputs: List[UTxO],\n    posix_from_slot,\n):\n    tx_info_args = (\n        tx,\n        [i.output for i in resolved_inputs],\n        [i.output for i in resolved_reference_inputs],\n        posix_from_slot,\n    )\n    datum = None\n    script_contexts = []\n    for i, spending_input in enumerate(resolved_inputs):\n        if not isinstance(spending_input.output.address.payment_part, ScriptHash):\n            continue\n        try:\n            # Redeemers is Union[RedeemerMap, List[Redeemer]]\n            spending_redeemer = as_redeemer(\n                next(\n                    r\n                    for r in tx.transaction_witness_set.redeemer\n                    if r.index == i and r.tag == RedeemerTag.SPEND\n                ),\n                tx.transaction_witness_set.redeemer,\n            )\n        except (StopIteration, TypeError):\n            raise ValueError(\n                f\"Missing redeemer for script input {i} (index or tag set incorrectly or missing redeemer)\"\n            )\n        script_type = None\n        try:\n            spending_script = next(\n                s\n                for s in tx.transaction_witness_set.plutus_v3_script\n                if plutus_script_hash(PlutusV3Script(s))\n                == spending_input.output.address.payment_part\n            )\n            script_type = ScriptType.PlutusV3\n        except (StopIteration, TypeError):\n            try:\n                spending_script = next(\n                    s\n                    for s in tx.transaction_witness_set.plutus_v2_script\n                    if plutus_script_hash(PlutusV2Script(s))\n                    == spending_input.output.address.payment_part\n                )\n                script_type = ScriptType.PlutusV2\n            except (StopIteration, TypeError):\n                try:\n                    spending_script = next(\n                        s\n                        for s in tx.transaction_witness_set.plutus_v1_script\n                        if plutus_script_hash(PlutusV1Script(s))\n                        == spending_input.output.address.payment_part\n                    )\n                    script_type = ScriptType.PlutusV1\n                except Exception as e:\n                    raise NotImplementedError(\n                        f\"Can not validate spending of non plutus v1, v2 or v3 scripts (or plutus v1, v2 or v3 script is not in context)\"\n                    )\n\n        if spending_input.output.datum is not None:\n            assert (\n                script_type != ScriptType.PlutusV1\n            ), \"Only datum hash is supported for plutus v1 scripts\"\n            datum = spending_input.output.datum\n            if not isinstance(datum, PlutusData):\n                datum = pycardano.RawPlutusData(datum)\n        elif spending_input.output.datum_hash is not None:\n            datum_h = spending_input.output.datum_hash\n            try:\n                datum = next(\n                    d\n                    for d in tx.transaction_witness_set.plutus_data or []\n                    if datum_hash(d) == datum_h\n                )\n                if not isinstance(datum, PlutusData):\n                    datum = pycardano.RawPlutusData(datum)\n            except StopIteration:\n                raise ValueError(\n                    f\"No datum with hash '{datum_h.payload.hex()}' provided for transaction\"\n                )\n        else:\n            raise ValueError(\n                \"Spending input is missing an attached datum and can not be spent\"\n            )\n\n        if script_type is ScriptType.PlutusV1:\n            script_context = to_spending_script_context_v1(\n                tx_info_args, spending_input.input\n            )\n        elif script_type is ScriptType.PlutusV2:\n            script_context = to_spending_script_context_v2(\n                tx_info_args, spending_input.input\n            )\n        elif script_type is ScriptType.PlutusV3:\n            script_context = to_script_context_v3(tx_info_args, spending_redeemer)\n        else:\n            raise NotImplementedError()\n\n        script_contexts.append(\n            ScriptInvocation(\n                spending_script,\n                datum,\n                spending_redeemer,\n                script_context,\n                # ScriptContext(tx_info, Spending(to_tx_out_ref(spending_input.input))),\n            )\n        )\n    for i, minting_script_hash in enumerate(tx.transaction_body.mint or []):\n        try:\n            minting_redeemer = as_redeemer(\n                next(\n                    r\n                    for r in tx.transaction_witness_set.redeemer\n                    if r.index == i and r.tag == RedeemerTag.MINT\n                ),\n                tx.transaction_witness_set.redeemer,\n            )\n        except StopIteration:\n            raise ValueError(\n                f\"Missing redeemer for mint {i} (index or tag set incorrectly or missing redeemer)\"\n            )\n        minting_script, script_type = next(\n            (\n                (s, ScriptType.PlutusV1)\n                for s in tx.transaction_witness_set.plutus_v1_script or []\n                if plutus_script_hash(PlutusV1Script(s)) == minting_script_hash\n            ),\n            (None, None),\n        )\n        if not minting_script:\n            minting_script, script_type = next(\n                (\n                    (s, ScriptType.PlutusV2)\n                    for s in tx.transaction_witness_set.plutus_v2_script or []\n                    if plutus_script_hash(PlutusV2Script(s)) == minting_script_hash\n                ),\n                (minting_script, script_type),\n            )\n        if not minting_script:\n            minting_script, script_type = next(\n                (\n                    (s, ScriptType.PlutusV3)\n                    for s in tx.transaction_witness_set.plutus_v3_script or []\n                    if plutus_script_hash(PlutusV3Script(s)) == minting_script_hash\n                ),\n                (minting_script, script_type),\n            )\n\n        assert (\n            minting_script and script_type\n        ), f\"Can not validate spending of non plutus v1, v2 or v3 scripts (or plutus v1, v2 or v3 script is not in context)\"\n\n        if script_type == ScriptType.PlutusV1:\n            script_context = to_minting_script_context_v1(tx_info_args, minting_script)\n        elif script_type == ScriptType.PlutusV2:\n            script_context = to_minting_script_context_v2(tx_info_args, minting_script)\n        elif script_type == ScriptType.PlutusV3:\n            script_context = to_script_context_v3(tx_info_args, minting_redeemer)\n        else:\n            raise NotImplementedError()\n\n        script_contexts.append(\n            ScriptInvocation(minting_script, datum, minting_redeemer, script_context)\n        )\n    for i, certificate in enumerate(tx.transaction_body.certificates or []):\n        try:\n            certificate_redeemer = as_redeemer(\n                next(\n                    r\n                    for r in tx.transaction_witness_set.redeemer or []\n                    if r.index == i and r.tag == RedeemerTag.CERTIFICATE\n                ),\n                tx.transaction_witness_set.redeemer,\n            )\n        except StopIteration:\n            if isinstance(certificate, pycardano.StakeRegistration):\n                #  TODO: Check can this always be skipped?\n                continue\n            raise ValueError(\n                f\"Missing redeemer for certificate {i} (index or tag set incorrectly or missing redeemer)\"\n            )\n\n        certificate_script, script_type = next(\n            (\n                (s, ScriptType.PlutusV1)\n                for s in tx.transaction_witness_set.plutus_v1_script or []\n                if plutus_script_hash(PlutusV1Script(s))\n                == certificate.stake_credential.credential\n            ),\n            (None, None),\n        )\n        if not certificate_script:\n            certificate_script, script_type = next(\n                (\n                    (s, ScriptType.PlutusV2)\n                    for s in tx.transaction_witness_set.plutus_v2_script or []\n                    if plutus_script_hash(PlutusV2Script(s))\n                    == certificate.stake_credential.credential\n                ),\n                (certificate_script, script_type),\n            )\n        if not certificate_script:\n            certificate_script, script_type = next(\n                (\n                    (s, ScriptType.PlutusV3)\n                    for s in tx.transaction_witness_set.plutus_v3_script or []\n                    if plutus_script_hash(PlutusV3Script(s))\n                    == certificate.stake_credential.credential\n                ),\n                (certificate_script, script_type),\n            )\n        assert (\n            certificate_script and script_type\n        ), f\"Can not validate certification of non plutus v1, v2 or v3 scripts (or plutus v1, v2 or v3 script is not in context)\"\n\n        if script_type == ScriptType.PlutusV1:\n            script_context = to_certificate_script_context_v1(tx_info_args, certificate)\n        elif script_type == ScriptType.PlutusV2:\n            script_context = to_certificate_script_context_v2(tx_info_args, certificate)\n        elif script_type == ScriptType.PlutusV3:\n            script_context = to_script_context_v3(tx_info_args, certificate_redeemer)\n        else:\n            raise NotImplementedError()\n\n        script_contexts.append(\n            ScriptInvocation(\n                certificate_script, datum, certificate_redeemer, script_context\n            )\n        )\n    for i, address in enumerate(sorted(tx.transaction_body.withdraws or {})):\n        try:\n            withdrawal_redeemer = as_redeemer(\n                next(\n                    r\n                    for r in tx.transaction_witness_set.redeemer\n                    if r.index == i and r.tag == RedeemerTag.WITHDRAWAL\n                ),\n                tx.transaction_witness_set.redeemer,\n            )\n        except StopIteration:\n            raise ValueError(\n                f\"Missing redeemer for withdrawal {i} (index or tag set incorrectly or missing redeemer)\"\n            )\n        script_hash = pycardano.Address.from_primitive(address).staking_part\n        withdrawal_script, script_type = next(\n            (\n                (s, ScriptType.PlutusV1)\n                for s in tx.transaction_witness_set.plutus_v1_script or []\n                if plutus_script_hash(PlutusV1Script(s)) == script_hash\n            ),\n            (None, None),\n        )\n        if withdrawal_script is None:\n            withdrawal_script, script_type = next(\n                (\n                    (s, ScriptType.PlutusV2)\n                    for s in tx.transaction_witness_set.plutus_v2_script or []\n                    if plutus_script_hash(PlutusV2Script(s)) == script_hash\n                ),\n                (withdrawal_script, script_type),\n            )\n        if withdrawal_script is None:\n            withdrawal_script, script_type = next(\n                (\n                    (s, ScriptType.PlutusV3)\n                    for s in tx.transaction_witness_set.plutus_v3_script or []\n                    if plutus_script_hash(PlutusV3Script(s)) == script_hash\n                ),\n                (withdrawal_script, script_type),\n            )\n        assert (\n            withdrawal_script and script_type\n        ), f\"Can not validate withdrawal of non plutus v1, v2 or v3 scripts (or plutus v1, v2 or v3 script is not in context)\"\n\n        if script_type == ScriptType.PlutusV1:\n            script_context = to_withdrawal_script_context_v1(tx_info_args, script_hash)\n        elif script_type == ScriptType.PlutusV2:\n            script_context = to_withdrawal_script_context_v2(tx_info_args, script_hash)\n        elif script_type == ScriptType.PlutusV3:\n            script_context = to_script_context_v3(tx_info_args, withdrawal_redeemer)\n        else:\n            raise NotImplementedError(\"Only Plutus V1 and V2 scripts are supported.\")\n\n        script_contexts.append(\n            ScriptInvocation(\n                withdrawal_script, datum, withdrawal_redeemer, script_context\n            )\n        )\n\n    return script_contexts\n\n\n@lru_cache(maxsize=1000)\ndef uplc_unflat(script: bytes):\n    return uplc.unflatten(script)\n\n\ndef uplc_plutus_data(a: pycardano.Datum) -> PlutusData:\n    return uplc.ast.data_from_cbor(cbor2.dumps(a, default=pycardano.default_encoder))\n\n\ndef evaluate_script(script_invocation: ScriptInvocation):\n    uplc_program = uplc_unflat(script_invocation.script)\n    args = [script_invocation.script_context]\n    if isinstance(script_invocation.script, (PlutusV1Script, PlutusV2Script)):\n        args.insert(0, script_invocation.redeemer.data)\n        if script_invocation.datum is not None:\n            args.insert(0, script_invocation.datum)\n    args = [uplc_plutus_data(a) for a in args]\n    allowed_cpu_steps = script_invocation.redeemer.ex_units.steps\n    allowed_mem_steps = script_invocation.redeemer.ex_units.mem\n    res = uplc.eval(\n        uplc.tools.apply(uplc_program, *args),\n        budget=uplc.cost_model.Budget(allowed_cpu_steps, allowed_mem_steps),\n    )\n    result = res.result\n    if (\n        isinstance(script_invocation.script, PlutusV3Script)\n        and result is uplc.ast.BuiltinUnit()\n    ):\n        result = AssertionError(\n            \"Result of executing PlutusV3 script is not Unit(). Therefore the script is considered failed\"\n        )\n    logs = res.logs\n    return (\n        (result),\n        (\n            res.cost.cpu,\n            res.cost.memory,\n        ),\n        logs,\n    )\n",
  "language": "python",
  "imports": [],
  "has_docstring": false
}