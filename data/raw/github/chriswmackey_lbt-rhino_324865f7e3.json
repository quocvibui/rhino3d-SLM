{
  "source_url": "https://github.com/chriswmackey/lbt-rhino/blob/d650b6631f4a5708f4472427d076c2343c569ac2/commands/LBT_Sunpath.py",
  "repo": "chriswmackey/lbt-rhino",
  "repo_stars": 0,
  "repo_description": "A set of Rhino scripts that run Ladybug Tools as commands.",
  "license": "AGPL-3.0",
  "filepath": "commands/LBT_Sunpath.py",
  "instruction": "Lbt sunpath",
  "code": "#! python 2\nimport os\nimport math\n\ntry:\n    from ladybug_geometry.geometry2d import Point2D\n    from ladybug_geometry.geometry3d import Point3D, Vector3D\nexcept ImportError as e:\n    raise ImportError('\\nFailed to import ladybug_geometry:\\n\\t{}'.format(e))\n\ntry:\n    from ladybug.futil import unzip_file\n    from ladybug.config import folders\n    from ladybug.dt import DateTime\n    from ladybug.epw import EPW\n    from ladybug.sunpath import Sunpath\nexcept ImportError as e:\n    raise ImportError('\\nFailed to import ladybug:\\n\\t{}'.format(e))\n\ntry:\n    from ladybug_rhino.download import download_file\n    from ladybug_rhino.config import conversion_to_meters\n    from ladybug_rhino.preview import VisualizationSetConduit\n    from ladybug_rhino.togeometry import to_point3d\n    from ladybug_rhino.fromgeometry import from_point3d\n    from ladybug_rhino.bakeobjects import bake_visualization_set\nexcept ImportError as e:\n    raise ImportError('\\nFailed to import ladybug_rhino:\\n\\t{}'.format(e))\n\nimport Rhino\nimport scriptcontext as sc\n\n\ndef run_sunpath_command():\n    # get the EPW from command line\n    gepw = Rhino.Input.Custom.GetString()\n    gepw.SetCommandPrompt('Select an EPW file path or URL')\n    epw_path = None\n    if 'lbt_epw' in sc.sticky:\n        epw_path = sc.sticky['lbt_epw']\n        gepw.SetDefaultString(epw_path)\n\n    # add all of the options to the command\n    north_ = sc.sticky['lbt_north'] if 'lbt_north' in sc.sticky else 0\n    north_option = Rhino.Input.Custom.OptionDouble(north_, 0, 360)\n    gepw.AddOptionDouble('North', north_option)\n\n    scale_ = sc.sticky['lbt_sunpath_scale'] if 'lbt_sunpath_scale' in sc.sticky else 1\n    scale_option = Rhino.Input.Custom.OptionDouble(scale_, True, 0)\n    gepw.AddOptionDouble('Scale', scale_option)\n\n    projection_i_ = sc.sticky['lbt_sunpath_projection'] \\\n        if 'lbt_sunpath_projection' in sc.sticky else 0\n    projections = ('3D', 'StereoGraphic', 'Orthographic')\n    proj_list = gepw.AddOptionList('Projection', projections, projection_i_)\n\n    solar_time_ = sc.sticky['lbt_sunpath_solar_time'] \\\n        if 'lbt_sunpath_solar_time' in sc.sticky else False\n    solar_time_option = Rhino.Input.Custom.OptionToggle(solar_time_, 'No', 'Yes')\n    gepw.AddOptionToggle('SolarTime', solar_time_option)\n\n    epw_data_i_ = sc.sticky['lbt_sunpath_data'] \\\n        if 'lbt_sunpath_data' in sc.sticky else 0\n    epw_data_sets = (\n        'None', 'dry_bulb_temperature', 'dew_point_temperature', 'relative_humidity',\n        'wind_speed', 'wind_direction', 'direct_normal_radiation',\n        'diffuse_horizontal_radiation', 'global_horizontal_radiation'\n    )\n    epw_data_list = gepw.AddOptionList('Data', epw_data_sets, epw_data_i_)\n\n    # get the weather file and all options\n    while True:\n        # This will prompt the user to input an EPW and visualization options\n        get_epw = gepw.Get()\n        if get_epw == Rhino.Input.GetResult.String:\n            epw_path = gepw.StringResult()\n            north_ = north_option.CurrentValue\n            scale_ = scale_option.CurrentValue\n            solar_time_ = solar_time_option.CurrentValue\n        elif get_epw == Rhino.Input.GetResult.Option:\n            if gepw.OptionIndex() == proj_list:\n                projection_i_ = gepw.Option().CurrentListOptionIndex\n            if gepw.OptionIndex() == epw_data_list:\n                epw_data_i_ = gepw.Option().CurrentListOptionIndex\n            continue\n        break\n\n    # save all of the options to sticky\n    sc.sticky['lbt_north'] = north_\n    sc.sticky['lbt_sunpath_scale'] = scale_\n    sc.sticky['lbt_sunpath_projection'] = projection_i_\n    sc.sticky['lbt_sunpath_solar_time'] = solar_time_\n    sc.sticky['lbt_sunpath_data'] = epw_data_i_\n\n    # process the EPW file path or URL\n    if not epw_path:\n        print('No EPW file selected.')\n        return\n    _def_folder = folders.default_epw_folder\n    if epw_path.startswith('http'):  # download the EPW file\n        _weather_URL = epw_path\n        if _weather_URL.lower().endswith('.zip'):  # onebuilding URL type\n            _folder_name = _weather_URL.split('/')[-1][:-4]\n        else:  # dept of energy URL type\n            _folder_name = _weather_URL.split('/')[-2]\n        epw_path = os.path.join(_def_folder, _folder_name, _folder_name + '.epw')\n        if not os.path.isfile(epw_path):\n            zip_file_path = os.path.join(_def_folder, _folder_name, _folder_name + '.zip')\n            download_file(_weather_URL, zip_file_path, True)\n            unzip_file(zip_file_path)\n        sc.sticky['lbt_epw'] = os.path.basename(epw_path)\n    elif not os.path.isfile(epw_path):\n        possible_file = os.path.basename(epw_path)[:-4] \\\n            if epw_path.lower().endswith('.epw') else epw_path\n        epw_path = os.path.join(_def_folder, possible_file, possible_file + '.epw')\n        if not os.path.isfile(epw_path):\n            print('Selected EPW file at does not exist at: {}'.format(epw_path))\n            return\n        sc.sticky['lbt_epw'] = possible_file + '.epw'\n    else:\n        sc.sticky['lbt_epw'] = epw_path\n\n    # process all of the global inputs for the sunpath\n    center_pt3d = sc.sticky['lbt_origin'] if 'lbt_origin' in sc.sticky else Point3D()\n    radius = (100 * scale_) / conversion_to_meters()\n    daily_ = False\n    projection_ = projections[projection_i_] if projection_i_ != 0 else None\n\n    # get the location from the EPW\n    epw_obj = EPW(epw_path)\n    _location = epw_obj.location\n\n    # process the EPW data to be plotted on the chart if it was requested\n    hoys_, data_ = [], []\n    if epw_data_i_ != 0:\n        data_.append(getattr(epw_obj, epw_data_sets[epw_data_i_]))\n        for month in range(1, 13):\n            for day in range(1, 29, 7):\n                for hour in range(24):\n                    hoys_.append(DateTime(month, day, hour).hoy)\n\n    # make the sunpath visualization set\n    sp = Sunpath.from_location(_location, north_)\n    vis_set_args = [hoys_, data_, None, radius, center_pt3d, solar_time_, daily_, projection_]\n    vis_set = sp.to_vis_set(*vis_set_args)\n\n    # preview the visualization set and ask if the origin should be changed\n    conduit = VisualizationSetConduit(vis_set, render_3d_legend=True, render_2d_legend=False)\n    conduit.Enabled = True\n    sc.doc.Views.Redraw()\n    gp = Rhino.Input.Custom.GetPoint()\n    gp.SetCommandPrompt('Select a Point for the origin or press ENTER to keep the current one.')\n    gp.SetDefaultPoint(from_point3d(center_pt3d))\n    gp.Get()\n    if gp.CommandResult() == Rhino.Commands.Result.Success:\n        point = gp.Point()\n        origin = to_point3d(point)\n        vis_set_args[4] = origin\n        sc.sticky['lbt_origin'] = origin\n        vis_set = sp.to_vis_set(*vis_set_args)\n        conduit.Enabled = False\n        conduit = VisualizationSetConduit(vis_set, render_3d_legend=True, render_2d_legend=False)\n        conduit.Enabled = True\n        sc.doc.Views.Redraw()\n\n    # finally, let people decide what they want to do with the result\n    gres = Rhino.Input.Custom.GetString()\n    gres.SetCommandPrompt('Would you like to add the Sunpath Geometry to the Document? Hit ENTER when done.')\n    gres.SetDefaultString('Add?')\n    bake_result = False\n    result_option = Rhino.Input.Custom.OptionToggle(False, 'No', 'Yes')\n    gres.AddOptionToggle('AddToDoc', result_option)\n    while True:\n        # This will prompt the user to input an EPW and visualization options\n        get_res = gres.Get()\n        if get_res == Rhino.Input.GetResult.String:\n            bake_result = result_option.CurrentValue\n        else:\n            continue\n        break\n    conduit.Enabled = False\n    sc.doc.Views.Redraw()\n\n    # add the visualization set to the document\n    if bake_result:\n        bake_visualization_set(vis_set, bake_3d_legend=True)\n\n\nrun_sunpath_command()\n",
  "language": "python",
  "imports": [
    "Rhino",
    "scriptcontext"
  ],
  "has_docstring": false
}